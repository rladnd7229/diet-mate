<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Diet Mate - ÏôÑÏ†ÑÌåê</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }
        
        /* ÎûúÎî© ÌéòÏù¥ÏßÄ */
        .landing {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 20px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .landing-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .landing-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .landing-subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            margin-bottom: 50px;
        }
        
        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: white;
            color: #667eea;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .btn-primary:active {
            transform: scale(0.95);
        }
        
        /* Ïù∏Ï¶ù ÌéòÏù¥ÏßÄ */
        .auth-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            background: white;
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .auth-logo-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 25px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .auth-title {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 40px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #666;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .error-message {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* ÎåÄÏãúÎ≥¥Îìú */
        .dashboard {
            min-height: 100vh;
            padding-bottom: 80px;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        
        .header-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .card:active {
            transform: scale(0.98);
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Ï≤¥Ï§ë Í∑∏ÎûòÌîÑ */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 10px;
        }
        
        .weight-input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .weight-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
        }
        
        .btn-add-weight {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Î¨º ÎßàÏãúÍ∏∞ */
        .water-tracker {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .water-cup {
            aspect-ratio: 1;
            background: #e3f2fd;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .water-cup.filled {
            background: #2196f3;
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        /* ÎØ∏ÏÖò */
        .missions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .mission-card {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mission-card.completed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .mission-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .mission-label {
            font-weight: bold;
        }
        
        /* ÏùºÍ∏∞ */
        .diary-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1rem;
            resize: vertical;
            font-family: inherit;
        }
        
        .diary-textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-save-diary {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Ïï®Î≤î */
        .album-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .album-tab {
            flex: 1;
            padding: 12px;
            background: #f5f5f5;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .album-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .photo-item {
            aspect-ratio: 1;
            background: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .add-photo {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #999;
            border: 2px dashed #ddd;
            background: #fafafa;
        }
        
        /* Ï∫òÎ¶∞Îçî */
        .calendar {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
        }
        
        .calendar-month {
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day-label {
            text-align: center;
            font-weight: bold;
            color: #666;
            padding: 10px 0;
            font-size: 0.9rem;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .calendar-day.today {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        .calendar-day.checked::after {
            content: '‚úì';
            position: absolute;
            bottom: 3px;
            font-size: 1.2rem;
            color: #4caf50;
        }
        
        .calendar-day.checked.today::after {
            color: white;
        }

        .calendar-day-number {
            font-size: 1rem;
            font-weight: 500;
        }

        .calendar-goal-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 8px;
            margin-top: 3px;
            font-weight: 600;
        }

        .calendar-goal-badge.perfect {
            background: #4caf50;
            color: white;
        }

        .calendar-goal-badge.good {
            background: #ffc107;
            color: #333;
        }

        .calendar-goal-badge.some {
            background: #ff9800;
            color: white;
        }

        .calendar-day.has-perfect-goals {
            border: 2px solid #4caf50;
        }

        .calendar-day.has-good-goals {
            border: 2px solid #ffc107;
        }

        .calendar-day.has-some-goals {
            border: 2px solid #ff9800;
        }

        .calendar-day.future {
            opacity: 0.4;
            cursor: default;
        }

        /* ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid #e0e0e0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
            padding: 5px;
        }
        
        .nav-item.active {
            color: #667eea;
        }
        
        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .nav-label {
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        /* ÌÉ≠ Ïª®ÌÖêÏ∏† */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Ïª§ÎÆ§ÎãàÌã∞ */
        .chat-container {
            height: calc(100vh - 250px);
            overflow-y: auto;
            padding: 20px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            max-width: 80%;
            animation: slideIn 0.3s;
        }
        
        .chat-message.mine {
            margin-left: auto;
        }
        
        .message-author {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .message-bubble {
            padding: 12px 15px;
            border-radius: 15px;
            background: #f5f5f5;
        }
        
        .chat-message.mine .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .chat-input-container {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }
        
        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
        }
        
        .send-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* ÏÑ§Ï†ï */
        .profile-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }
        
        .profile-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .profile-info p {
            color: #666;
        }
        
        .settings-item {
            padding: 20px;
            background: white;
            border-radius: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .logout-btn {
            background: #ff5252;
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
        }
        
        /* BMI Ïπ¥Îìú */
        .bmi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px;
            margin-top: 15px;
        }
        
        .bmi-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .bmi-item {
            text-align: center;
        }
        
        .bmi-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .bmi-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* ÌÉÄÏûÑÎû©Ïä§ */
        .timelapse-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .timelapse-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .timelapse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 20px;
        }

        .timelapse-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }

        .timelapse-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .timelapse-image {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(255, 255, 255, 0.2);
        }

        .timelapse-controls {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 20px;
        }

        .timelapse-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            margin-bottom: 15px;
        }

        .timelapse-slider::-webkit-slider-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        .timelapse-info {
            text-align: center;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .photo-item-with-date {
            position: relative;
        }

        .photo-date-label {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 8px;
            font-size: 0.7rem;
            text-align: center;
        }

        /* Î¶¨Ìè¨Ìä∏ */
        .report-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            padding-bottom: 80px;
        }

        .report-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .report-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .report-header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .report-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .report-card h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #667eea;
        }

        .report-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .report-stat {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 15px;
        }

        .report-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .report-stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .report-comparison {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .report-comparison-item {
            flex: 1;
            text-align: center;
        }

        .report-comparison-img {
            width: 100%;
            aspect-ratio: 3/4;
            background: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .report-comparison-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .report-badge {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            font-weight: bold;
            margin: 5px;
        }

        .report-close-btn {
            width: 100%;
            padding: 15px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        /* Goals Tab Styles */
        .goals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .goals-date {
            font-size: 1.1rem;
            font-weight: bold;
            color: #667eea;
        }

        .btn-add-goal {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .goal-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .goal-category-chip {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .goal-category-chip.active {
            background: white;
            border-color: #667eea;
            color: #667eea;
        }

        .goal-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .goal-card:active {
            transform: scale(0.98);
        }

        .goal-card.completed {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }

        .goal-card.skipped {
            background: #e0e0e0;
            opacity: 0.6;
        }

        .goal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .goal-title-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .goal-icon {
            font-size: 1.8rem;
        }

        .goal-title {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .goal-time-badge {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .goal-card.completed .goal-time-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .goal-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
        }

        .goal-card.completed .goal-stats {
            color: rgba(255, 255, 255, 0.9);
        }

        .goal-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-goal-action {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-complete {
            background: #4caf50;
            color: white;
        }

        .btn-skip {
            background: #f5f5f5;
            color: #666;
        }

        .btn-edit {
            background: #667eea;
            color: white;
        }

        .goal-list-empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .goal-list-empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        /* Goal Modal */
        .goal-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .goal-modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .goal-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .goal-modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .btn-close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
        }

        .time-picker-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
        }

        .icon-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .icon-option {
            font-size: 2rem;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .icon-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }

        /* Ïú†Ìã∏Î¶¨Ìã∞ */
        .hidden {
            display: none !important;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .text-center {
            text-align: center;
        }
        
        /* Î°úÎî© */
        .loading {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .gender-buttons {
            display: flex;
            gap: 10px;
        }
        
        .gender-btn {
            flex: 1;
            padding: 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 15px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .gender-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">
            <div>
                <div class="spinner" style="margin: 0 auto 20px;"></div>
                <p style="font-size: 1.5rem; font-weight: bold;">Diet Mate Î°úÎî©Ï§ë...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase Ï¥àÍ∏∞Ìôî
        const firebaseConfig = {
            apiKey: "AIzaSyDrw00jym_dKATz26qUzsALSqfYeAAkM-I",
            authDomain: "mate-9f45e.firebaseapp.com",
            projectId: "mate-9f45e",
            storageBucket: "mate-9f45e.firebasestorage.app",
            messagingSenderId: "1077932492908",
            appId: "1:1077932492908:web:722c068177e2e715183049"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const appId = 'diet-mate-v2';
        
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentUser = null;
        let currentProfile = null;
        let currentView = 'landing';
        let currentTab = 'home';
        let currentAlbumTab = 'body';
        let isSignUp = false;
        let todayLog = { checks: {}, water: 0, diary: '', weight: null };
        let weightChart = null;
        let currentMonth = new Date();
        let albumPhotos = [];
        let timelapseIndex = 0;
        let showingReport = false;

        // ÏÉàÎ°úÏö¥ Î™©Ìëú ÏãúÏä§ÌÖú Î≥ÄÏàò
        let userGoals = [];
        let todayCompletions = {};
        let goalsCache = null;
        let goalsCacheTime = 0;

        // ==================== Phase 5: AI Integration ====================
        // Gemini API ÌÇ§ Î∞∞Ïó¥ (ÏÇ¨Ïö©ÏûêÍ∞Ä ÎÇòÏ§ëÏóê Ï±ÑÏö∏ ÏòàÏ†ï)
        const API_KEYS = [
            'YOUR_GEMINI_API_KEY_1',
            'YOUR_GEMINI_API_KEY_2',
            'YOUR_GEMINI_API_KEY_3'
        ];
        let currentAPIKeyIndex = 0;
        let aiCoachingCache = null;
        let aiCoachingCacheTime = 0;

        // Gemini API Ìò∏Ï∂ú Ìï®Ïàò (429 ÏóêÎü¨ Ïãú ÏûêÎèô ÌÇ§ Î°úÌÖåÏù¥ÏÖò)
        const callGeminiAPI = async (prompt, imageBase64 = null, retryCount = 0) => {
            if (retryCount >= API_KEYS.length) {
                throw new Error('Î™®Îì† API ÌÇ§Í∞Ä ÏÇ¨Ïö© Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            }

            const apiKey = API_KEYS[currentAPIKeyIndex];

            // API ÌÇ§ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!apiKey || apiKey.startsWith('YOUR_')) {
                throw new Error('Ïú†Ìö®Ìïú Gemini API ÌÇ§Î•º ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

            const body = {
                contents: [{
                    parts: []
                }]
            };

            // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ Ï∂îÍ∞Ä
            if (imageBase64) {
                body.contents[0].parts.push({
                    inline_data: {
                        mime_type: "image/jpeg",
                        data: imageBase64
                    }
                });
            }

            // ÌÖçÏä§Ìä∏ ÌîÑÎ°¨ÌîÑÌä∏ Ï∂îÍ∞Ä
            body.contents[0].parts.push({
                text: prompt
            });

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (response.status === 429) {
                    // API ÌÇ§ Î°úÌÖåÏù¥ÏÖò
                    console.log(`API ÌÇ§ ${currentAPIKeyIndex + 1} ÏÇ¨Ïö© ÌïúÎèÑ Ï¥àÍ≥º. Îã§Ïùå ÌÇ§Î°ú Ï†ÑÌôòÌï©ÎãàÎã§.`);
                    currentAPIKeyIndex = (currentAPIKeyIndex + 1) % API_KEYS.length;
                    return await callGeminiAPI(prompt, imageBase64, retryCount + 1);
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API Ìò∏Ï∂ú Ïã§Ìå®');
                }

                const data = await response.json();

                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('AI ÏùëÎãµ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
                }

                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                if (error.message.includes('429') || error.message.includes('quota')) {
                    currentAPIKeyIndex = (currentAPIKeyIndex + 1) % API_KEYS.length;
                    return await callGeminiAPI(prompt, imageBase64, retryCount + 1);
                }
                throw error;
            }
        };

        // Ïù¥ÎØ∏ÏßÄÎ•º Base64Î°ú Î≥ÄÌôòÌïòÎäî Ìó¨Ìçº Ìï®Ïàò
        const imageToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // data:image/jpeg;base64, Î∂ÄÎ∂Ñ Ï†úÍ±∞
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };
        // ==================== End of Phase 5 Core Functions ====================

        // Ïú†Ìã∏Î¶¨Ìã∞
        const getTodayString = () => {
            const d = new Date();
            return d.getFullYear() + '-' + 
                   String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(d.getDate()).padStart(2, '0');
        };
        
        const calculateBMI = (height, weight) => {
            const h = Number(height) / 100;
            const w = Number(weight);
            const bmi = (w / (h * h)).toFixed(1);
            let status = 'Ï†ïÏÉÅ';
            if (bmi < 18.5) status = 'Ï†ÄÏ≤¥Ï§ë';
            else if (bmi < 23) status = 'Ï†ïÏÉÅ';
            else if (bmi < 25) status = 'Í≥ºÏ≤¥Ï§ë';
            else status = 'ÎπÑÎßå';
            const standardWeight = (22 * h * h).toFixed(1);
            return { bmi, status, standardWeight };
        };

        // Î∞±ÏõåÎìú Ìò∏ÌôòÏÑ±: Í∏∞Ï°¥ ÎØ∏ÏÖò ÏãúÏä§ÌÖúÍ≥º ÏÉà Î™©Ìëú ÏãúÏä§ÌÖú Ìò∏Ìôò
        const hasMigratedToGoals = async () => {
            if (!currentUser) return false;
            if (currentProfile && currentProfile.migratedToGoals) return true;

            const snapshot = await db.collection('artifacts').doc(appId)
                .collection('users').doc(currentUser.uid)
                .collection('goals').limit(1).get();

            return !snapshot.empty;
        };

        const showMigrationPrompt = async () => {
            const migrated = await hasMigratedToGoals();
            if (migrated) return;

            setTimeout(() => {
                if (confirm('üéØ ÏÉàÎ°úÏö¥ ÎßûÏ∂§Ìòï Î™©Ìëú ÏãúÏä§ÌÖúÏúºÎ°ú ÏóÖÍ∑∏Î†àÏù¥ÎìúÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÍ∏∞Ï°¥ ÎØ∏ÏÖòÏù¥ ÏûêÎèôÏúºÎ°ú Î™©ÌëúÎ°ú Î≥ÄÌôòÎêòÎ©∞, Îçî ÎßéÏùÄ ÎßûÏ∂§ ÏÑ§Ï†ïÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§!')) {
                    migrateToGoals();
                }
            }, 2000);
        };

        const migrateToGoals = async () => {
            try {
                const legacyMissions = [
                    { id: 'morning', label: 'ÏïÑÏπ® Ïö¥Îèô', icon: 'üèÉ', type: 'exercise' },
                    { id: 'water', label: 'Î¨º 8Ïûî', icon: 'üíß', type: 'water' },
                    { id: 'meal', label: 'Í±¥Í∞ïÌïú ÏãùÏÇ¨', icon: 'ü•ó', type: 'diet' },
                    { id: 'diary', label: 'ÏùºÍ∏∞ Ïì∞Í∏∞', icon: 'üìù', type: 'custom' }
                ];

                for (const mission of legacyMissions) {
                    await db.collection('artifacts').doc(appId)
                        .collection('users').doc(currentUser.uid)
                        .collection('goals').add({
                            title: mission.label,
                            icon: mission.icon,
                            type: mission.type,
                            scheduledTimes: [],
                            active: true,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdAtClient: new Date().toISOString()
                        });
                }

                await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('profile').doc('main')
                    .update({ migratedToGoals: true });

                currentProfile.migratedToGoals = true;
                alert('‚úÖ ÏóÖÍ∑∏Î†àÏù¥Îìú ÏôÑÎ£å! Ïù¥Ï†ú ÎßûÏ∂§Ìòï Î™©ÌëúÎ•º ÏÑ§Ï†ïÌï† Ïàò ÏûàÏäµÎãàÎã§!');
                location.reload();
            } catch (error) {
                console.error('Migration failed:', error);
                alert('ÏóÖÍ∑∏Î†àÏù¥Îìú Ïã§Ìå®: ' + error.message);
            }
        };

        // Î†åÎçîÎßÅ
        const render = () => {
            const app = document.getElementById('app');
            
            if (currentView === 'landing') {
                app.innerHTML = `
                    <div class="landing">
                        <div class="landing-logo">üí™</div>
                        <h1 class="landing-title">DIET MATE</h1>
                        <p class="landing-subtitle">ÎÇòÎßåÏùò Ïä§ÎßàÌä∏Ìïú Îã§Ïù¥Ïñ¥Ìä∏ ÌååÌä∏ÎÑà</p>
                        <button class="btn btn-primary" onclick="showAuth()">ÏãúÏûëÌïòÍ∏∞ ‚Üí</button>
                    </div>
                `;
            } else if (currentView === 'auth') {
                app.innerHTML = `
                    <div class="auth-container">
                        <div class="auth-logo">
                            <div class="auth-logo-icon">üí™</div>
                            <h1 class="auth-title">DIET MATE</h1>
                        </div>
                        
                        <form onsubmit="handleAuth(event)">
                            <div id="error-msg" class="error-message"></div>
                            
                            <div class="form-group">
                                <label class="form-label">Ïù¥Î©îÏùº</label>
                                <input type="email" id="email" class="form-input" placeholder="name@example.com" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                                <input type="password" id="password" class="form-input" placeholder="6Ïûê Ïù¥ÏÉÅ" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                ${isSignUp ? 'ÌöåÏõêÍ∞ÄÏûÖ' : 'Î°úÍ∑∏Ïù∏'}
                            </button>
                        </form>
                        
                        <div class="text-center mt-20">
                            <span>${isSignUp ? 'Ïù¥ÎØ∏ Í≥ÑÏ†ïÏù¥ ÏûàÏúºÏã†Í∞ÄÏöî?' : 'ÏïÑÏßÅ Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî?'}</span>
                            <button onclick="toggleAuthMode()" style="color: #667eea; font-weight: bold; border: none; background: none; cursor: pointer; margin-left: 10px;">
                                ${isSignUp ? 'Î°úÍ∑∏Ïù∏ÌïòÍ∏∞' : 'ÌöåÏõêÍ∞ÄÏûÖÌïòÍ∏∞'}
                            </button>
                        </div>
                    </div>
                `;
            } else if (currentView === 'onboarding') {
                showOnboarding();
            } else if (currentView === 'dashboard') {
                showDashboard();
            }
        };
        
        // Ïù∏Ï¶ù
        window.showAuth = () => {
            currentView = 'auth';
            render();
        };
        
        window.toggleAuthMode = () => {
            isSignUp = !isSignUp;
            render();
        };
        
        window.handleAuth = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('error-msg');
            
            try {
                if (isSignUp) {
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                errorMsg.textContent = 'Î°úÍ∑∏Ïù∏ Ïã§Ìå®: ' + error.message;
                errorMsg.classList.add('show');
            }
        };
        
        // Ïò®Î≥¥Îî©
        const showOnboarding = () => {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="auth-container">
                    <h2 class="auth-title">ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï</h2>
                    
                    <div class="form-group">
                        <label class="form-label">ÎãâÎÑ§ÏûÑ</label>
                        <input type="text" id="nickname" class="form-input" placeholder="Ïòà: Îã§Ïù¥Ïñ¥ÌÑ∞" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏÑ±Î≥Ñ</label>
                        <div class="gender-buttons">
                            <button type="button" onclick="selectGender('male')" id="gender-male" class="gender-btn">üë®</button>
                            <button type="button" onclick="selectGender('female')" id="gender-female" class="gender-btn">üë©</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÌÇ§ (cm)</label>
                        <input type="number" id="height" class="form-input" value="170" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÌòÑÏû¨ Ï≤¥Ï§ë (kg)</label>
                        <input type="number" step="0.1" id="start-weight" class="form-input" value="60" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Î™©Ìëú Ï≤¥Ï§ë (kg)</label>
                        <input type="number" step="0.1" id="target-weight" class="form-input" value="55" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Î™©Ìëú ÎÇ†Ïßú</label>
                        <input type="date" id="target-date" class="form-input" required>
                    </div>
                    
                    <button onclick="completeOnboarding()" class="btn btn-primary" style="width: 100%;">ÏãúÏûëÌïòÍ∏∞</button>
                </div>
            `;
        };
        
        let selectedGender = 'male';
        
        window.selectGender = (gender) => {
            selectedGender = gender;
            document.getElementById('gender-male').classList.toggle('active', gender === 'male');
            document.getElementById('gender-female').classList.toggle('active', gender === 'female');
        };
        
        window.completeOnboarding = async () => {
            const profile = {
                name: document.getElementById('nickname').value,
                gender: selectedGender,
                height: document.getElementById('height').value,
                startWeight: document.getElementById('start-weight').value,
                currentWeight: document.getElementById('start-weight').value,
                targetWeight: document.getElementById('target-weight').value,
                targetDate: document.getElementById('target-date').value,
                joinedAt: new Date().toISOString()
            };
            
            await db.collection('artifacts').doc(appId).collection('users')
                .doc(currentUser.uid).collection('profile').doc('main').set(profile);
            
            currentProfile = profile;
            currentView = 'dashboard';
            render();
        };
        
        // ÎåÄÏãúÎ≥¥Îìú
        const showDashboard = () => {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="dashboard">
                    <!-- Ìôà ÌÉ≠ -->
                    <div id="tab-home" class="tab-content active">
                        <div class="header">
                            <h2 class="header-title">${currentProfile.name}Îãò,<br>ÏïàÎÖïÌïòÏÑ∏Ïöî! üëã</h2>
                            <p class="header-subtitle">Ïò§ÎäòÎèÑ Î™©ÌëúÎ•º Ìñ•Ìï¥ Îã¨Î†§Î¥êÏöî</p>
                        </div>
                        
                        <div class="content">
                            <!-- AI ÏΩîÏπò Ïπ¥Îìú -->
                            <div class="card" id="ai-coach-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: none;">
                                <h3 class="card-title" style="color: white;">ü§ñ Ïò§ÎäòÏùò AI ÏΩîÏπò</h3>
                                <div id="ai-coach-content" style="line-height: 1.6; font-size: 0.95rem;">
                                    <div style="text-align: center; padding: 20px 0;">
                                        <div class="spinner" style="margin: 0 auto;"></div>
                                        <p style="margin-top: 10px; opacity: 0.9;">AIÍ∞Ä Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...</p>
                                    </div>
                                </div>
                                <button onclick="refreshAICoaching()" class="btn" style="width: 100%; margin-top: 10px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px;">
                                    üîÑ Îã§Ïãú Î∂ÑÏÑùÎ∞õÍ∏∞
                                </button>
                            </div>

                            <!-- Ï≤¥Ï§ë Í∑∏ÎûòÌîÑ -->
                            <div class="card">
                                <h3 class="card-title">üìä Ï≤¥Ï§ë Î≥ÄÌôî</h3>
                                <div class="chart-container">
                                    <canvas id="weight-chart"></canvas>
                                </div>
                                <div class="weight-input-group">
                                    <input type="number" step="0.1" id="weight-input" class="weight-input" placeholder="Ïò§Îäò Ï≤¥Ï§ë (kg)">
                                    <button onclick="addWeight()" class="btn-add-weight">Í∏∞Î°ù</button>
                                </div>
                            </div>
                            
                            <!-- BMI -->
                            <div class="bmi-card" id="bmi-card"></div>

                            <!-- Ïò§ÎäòÏùò Î™©Ìëú ÏöîÏïΩ -->
                            <div class="card" id="goals-summary-card" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 class="card-title">üéØ Ïò§ÎäòÏùò Î™©Ìëú</h3>
                                    <button onclick="switchTab('goals')" class="btn" style="padding: 5px 15px; font-size: 12px;">
                                        Ï†ÑÏ≤¥Î≥¥Í∏∞ ‚Üí
                                    </button>
                                </div>
                                <div id="goals-summary-content">
                                    <!-- Î™©Ìëú ÏöîÏïΩÏù¥ Ïó¨Í∏∞Ïóê Î†åÎçîÎßÅÎê® -->
                                </div>
                            </div>

                            <!-- Î¨º ÎßàÏãúÍ∏∞ -->
                            <div class="card">
                                <h3 class="card-title">üíß Î¨º ÎßàÏãúÍ∏∞ (<span id="water-count">0</span>/8)</h3>
                                <div class="water-tracker" id="water-tracker"></div>
                            </div>
                            
                            <!-- ÎØ∏ÏÖò -->
                            <div class="card">
                                <h3 class="card-title">‚úÖ Ïò§ÎäòÏùò ÎØ∏ÏÖò</h3>
                                <div class="missions-grid" id="missions-grid"></div>
                            </div>
                            
                            <!-- ÏùºÍ∏∞ -->
                            <div class="card">
                                <h3 class="card-title">üìù Ïò§ÎäòÏùò ÏùºÍ∏∞</h3>
                                <textarea id="diary-text" class="diary-textarea" placeholder="Ïò§Îäò ÌïòÎ£®Îäî Ïñ¥Îï†ÎÇòÏöî?"></textarea>
                                <button onclick="saveDiary()" class="btn-save-diary">Ï†ÄÏû•ÌïòÍ∏∞</button>
                            </div>
                        </div>
                    </div>

                    <!-- Î™©Ìëú ÌÉ≠ -->
                    <div id="tab-goals" class="tab-content">
                        <div class="header">
                            <h2 class="header-title">üéØ Ïò§ÎäòÏùò Î™©Ìëú</h2>
                        </div>

                        <div class="content">
                            <!-- Î™©Ìëú Ìó§Îçî -->
                            <div class="goals-header">
                                <div class="date-display" id="goals-date-display"></div>
                                <button class="add-goal-btn" onclick="showGoalModal()">
                                    ‚ûï Î™©Ìëú Ï∂îÍ∞Ä
                                </button>
                            </div>

                            <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ -->
                            <div class="goal-categories">
                                <div class="goal-category-chip active" data-category="all" onclick="filterGoalsByCategory('all')">
                                    Ï†ÑÏ≤¥
                                </div>
                                <div class="goal-category-chip" data-category="exercise" onclick="filterGoalsByCategory('exercise')">
                                    üèÉ Ïö¥Îèô
                                </div>
                                <div class="goal-category-chip" data-category="diet" onclick="filterGoalsByCategory('diet')">
                                    ü•ó ÏãùÎã®
                                </div>
                                <div class="goal-category-chip" data-category="water" onclick="filterGoalsByCategory('water')">
                                    üíß Î¨º
                                </div>
                                <div class="goal-category-chip" data-category="custom" onclick="filterGoalsByCategory('custom')">
                                    ‚ú® Í∏∞ÌÉÄ
                                </div>
                            </div>

                            <!-- Î™©Ìëú Î¶¨Ïä§Ìä∏ -->
                            <div id="goals-list" class="goals-list">
                                <!-- Î™©Ìëú Ïπ¥ÎìúÎì§Ïù¥ Ïó¨Í∏∞Ïóê Î†åÎçîÎßÅÎê® -->
                            </div>

                            <!-- Î™©Ìëú ÏóÜÏùÑ Îïå -->
                            <div id="goals-empty" class="goal-list-empty hidden">
                                <div class="empty-icon">üéØ</div>
                                <h3>ÏïÑÏßÅ Î™©ÌëúÍ∞Ä ÏóÜÏñ¥Ïöî</h3>
                                <p>Ï≤´ Î≤àÏß∏ Î™©ÌëúÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p>
                                <button class="btn btn-primary" onclick="showGoalModal()">Î™©Ìëú Ï∂îÍ∞ÄÌïòÍ∏∞</button>
                            </div>
                        </div>
                    </div>

                    <!-- Ïï®Î≤î ÌÉ≠ -->
                    <div id="tab-album" class="tab-content">
                        <div class="header">
                            <h2 class="header-title">üì∏ Ïï®Î≤î</h2>
                        </div>

                        <div class="content">
                            <button class="timelapse-btn" onclick="showTimelapse()">üé¨ Î≥ÄÌôî ÌÉÄÏûÑÎû©Ïä§ Î≥¥Í∏∞</button>

                            <div class="album-tabs">
                                <button class="album-tab active" onclick="switchAlbumTab('body')">ÎààÎ∞îÎîî</button>
                                <button class="album-tab" onclick="switchAlbumTab('food')">ÏãùÎã®</button>
                                <button class="album-tab" onclick="switchAlbumTab('exercise')">Ïö¥Îèô</button>
                            </div>
                            <div class="photo-grid" id="photo-grid">
                                <div class="photo-item add-photo" onclick="addPhoto()">+</div>
                            </div>
                            <input type="file" id="photo-input" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                        </div>
                    </div>
                    
                    <!-- Ï∫òÎ¶∞Îçî ÌÉ≠ -->
                    <div id="tab-calendar" class="tab-content">
                        <div class="header">
                            <h2 class="header-title">üìÖ Í∏∞Î°ù Ï∫òÎ¶∞Îçî</h2>
                        </div>
                        
                        <div class="content">
                            <div class="calendar" id="calendar-container"></div>
                        </div>
                    </div>
                    
                    <!-- Ïª§ÎÆ§ÎãàÌã∞ ÌÉ≠ -->
                    <div id="tab-community" class="tab-content">
                        <div class="header">
                            <h2 class="header-title">üí¨ ÏàòÎã§Î∞©</h2>
                        </div>
                        
                        <div class="chat-container" id="chat-messages"></div>
                        
                        <div class="chat-input-container">
                            <div class="chat-input-wrapper">
                                <input type="text" id="chat-input" class="chat-input" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•...">
                                <button onclick="sendMessage()" class="send-btn">Ï†ÑÏÜ°</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÏÑ§Ï†ï ÌÉ≠ -->
                    <div id="tab-settings" class="tab-content">
                        <div class="header">
                            <h2 class="header-title">‚öôÔ∏è ÏÑ§Ï†ï</h2>
                        </div>
                        
                        <div class="content">
                            <div class="profile-card">
                                <div class="profile-header">
                                    <div class="profile-avatar">${currentProfile.gender === 'male' ? 'üë®' : 'üë©'}</div>
                                    <div class="profile-info">
                                        <h3>${currentProfile.name}Îãò</h3>
                                        <p>${currentProfile.height}cm ‚Ä¢ ${currentProfile.currentWeight}kg</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3 class="card-title">üéØ ÎÇ¥ Î™©Ìëú</h3>
                                <div style="padding: 15px 0; border-bottom: 1px solid #f5f5f5;">
                                    <div style="display: flex; justify-between;">
                                        <span>Î™©Ìëú Ï≤¥Ï§ë</span>
                                        <span style="font-weight: bold;">${currentProfile.targetWeight}kg</span>
                                    </div>
                                </div>
                                <div style="padding: 15px 0;">
                                    <div style="display: flex; justify-between;">
                                        <span>Î™©Ìëú ÎÇ†Ïßú</span>
                                        <span style="font-weight: bold;">${currentProfile.targetDate}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <h3 class="card-title">üíæ Î∞±ÏóÖ Î∞è Î≥µÏõê</h3>
                                <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                                    Îç∞Ïù¥ÌÑ∞Î•º ÏïàÏ†ÑÌïòÍ≤å Î∞±ÏóÖÌïòÍ≥† Î≥µÏõêÌï† Ïàò ÏûàÏäµÎãàÎã§.
                                </p>
                                <button onclick="exportData()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                                    üì¶ Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (JSON)
                                </button>
                                <button onclick="importData()" class="btn" style="width: 100%; background: #f5f5f5;">
                                    üì• Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                                </button>
                            </div>

                            <button onclick="handleLogout()" class="logout-btn">Î°úÍ∑∏ÏïÑÏõÉ</button>
                        </div>
                    </div>
                    
                    <!-- ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
                    <div class="bottom-nav">
                        <div class="nav-item active" onclick="switchTab('home')">
                            <div class="nav-icon">üè†</div>
                            <div class="nav-label">Ìôà</div>
                        </div>
                        <div class="nav-item" onclick="switchTab('goals')">
                            <div class="nav-icon">üéØ</div>
                            <div class="nav-label">Î™©Ìëú</div>
                        </div>
                        <div class="nav-item" onclick="switchTab('album')">
                            <div class="nav-icon">üì∏</div>
                            <div class="nav-label">Ïï®Î≤î</div>
                        </div>
                        <div class="nav-item" onclick="switchTab('calendar')">
                            <div class="nav-icon">üìÖ</div>
                            <div class="nav-label">Ï∫òÎ¶∞Îçî</div>
                        </div>
                        <div class="nav-item" onclick="switchTab('community')">
                            <div class="nav-icon">üí¨</div>
                            <div class="nav-label">ÏÜåÌÜµ</div>
                        </div>
                        <div class="nav-item" onclick="switchTab('settings')">
                            <div class="nav-icon">‚öôÔ∏è</div>
                            <div class="nav-label">ÏÑ§Ï†ï</div>
                        </div>
                    </div>
                </div>
            `;
            
            initWaterTracker();
            initMissions();
            loadTodayLog();
            loadWeightChart();
            updateBMI();
            checkThreeMonthReport();
            renderGoalsSummary(); // Î™©Ìëú ÏöîÏïΩ Î†åÎçîÎßÅ
            showMigrationPrompt(); // Í∏∞Ï°¥ ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏóÖÍ∑∏Î†àÏù¥Îìú Ï†úÏïà
            loadAICoaching(); // AI ÏΩîÏπ≠ Î°úÎìú
        };
        
        // ÌÉ≠ Ï†ÑÌôò
        window.switchTab = (tab) => {
            currentTab = tab;

            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (tab === 'goals') renderGoalsTab();
            if (tab === 'community') loadCommunityMessages();
            if (tab === 'calendar') renderCalendar();
            if (tab === 'album') loadAlbumPhotos();
        };
        
        // BMI ÏóÖÎç∞Ïù¥Ìä∏
        const updateBMI = () => {
            const bmi = calculateBMI(currentProfile.height, currentProfile.currentWeight);
            const card = document.getElementById('bmi-card');
            if (!card) return;
            
            card.innerHTML = `
                <h3 style="font-size: 1.2rem; margin-bottom: 10px;">üí™ Í±¥Í∞ï ÏßÄÌëú</h3>
                <div class="bmi-grid">
                    <div class="bmi-item">
                        <div class="bmi-label">BMI</div>
                        <div class="bmi-value">${bmi.bmi}</div>
                        <div class="bmi-label">${bmi.status}</div>
                    </div>
                    <div class="bmi-item">
                        <div class="bmi-label">ÌëúÏ§Ä Ï≤¥Ï§ë</div>
                        <div class="bmi-value">${bmi.standardWeight}</div>
                        <div class="bmi-label">kg</div>
                    </div>
                </div>
            `;
        };
        
        // Ï≤¥Ï§ë Í∏∞Î°ù
        window.addWeight = async () => {
            const input = document.getElementById('weight-input');
            const weight = parseFloat(input.value);
            
            if (!weight || weight < 30 || weight > 200) {
                alert('Ïò¨Î∞îÎ•∏ Ï≤¥Ï§ëÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const today = getTodayString();
            todayLog.weight = weight;
            
            await db.collection('artifacts').doc(appId).collection('users')
                .doc(currentUser.uid).collection('logs').doc(today).set({
                    ...todayLog,
                    date: today
                }, { merge: true });
            
            currentProfile.currentWeight = weight;
            await db.collection('artifacts').doc(appId).collection('users')
                .doc(currentUser.uid).collection('profile').doc('main').update({
                    currentWeight: weight
                });
            
            input.value = '';
            loadWeightChart();
            updateBMI();
            alert('Ï≤¥Ï§ëÏù¥ Í∏∞Î°ùÎêòÏóàÏäµÎãàÎã§! üìä');
        };
        
        // Ï≤¥Ï§ë Í∑∏ÎûòÌîÑ
        const loadWeightChart = async () => {
            const logsRef = db.collection('artifacts').doc(appId).collection('users')
                .doc(currentUser.uid).collection('logs');
            
            const snapshot = await logsRef.orderBy('date', 'desc').limit(30).get();
            
            const data = snapshot.docs
                .map(doc => doc.data())
                .filter(log => log.weight)
                .reverse();
            
            const ctx = document.getElementById('weight-chart');
            if (!ctx) return;
            
            if (weightChart) weightChart.destroy();
            
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date.split('-').slice(1).join('/')),
                    datasets: [{
                        label: 'Ï≤¥Ï§ë (kg)',
                        data: data.map(d => d.weight),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            borderRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        };
        
        // Î¨º ÎßàÏãúÍ∏∞
        const initWaterTracker = () => {
            const container = document.getElementById('water-tracker');
            container.innerHTML = '';
            
            for (let i = 0; i < 8; i++) {
                const cup = document.createElement('div');
                cup.className = 'water-cup';
                cup.textContent = 'üíß';
                cup.onclick = () => toggleWater(i);
                container.appendChild(cup);
            }
        };
        
        window.toggleWater = async (index) => {
            const cups = document.querySelectorAll('.water-cup');
            cups[index].classList.toggle('filled');
            
            const filled = document.querySelectorAll('.water-cup.filled').length;
            document.getElementById('water-count').textContent = filled;
            
            todayLog.water = filled * 250;
            await saveTodayLog();
        };
        
        // ÎØ∏ÏÖò
        const initMissions = () => {
            const missions = [
                { id: 'morning', label: 'ÏïÑÏπ® Ïö¥Îèô', icon: 'üèÉ' },
                { id: 'water', label: 'Î¨º 8Ïûî', icon: 'üíß' },
                { id: 'meal', label: 'Í±¥Í∞ïÌïú ÏãùÏÇ¨', icon: 'ü•ó' },
                { id: 'diary', label: 'ÏùºÍ∏∞ Ïì∞Í∏∞', icon: 'üìù' }
            ];
            
            const grid = document.getElementById('missions-grid');
            grid.innerHTML = missions.map(m => `
                <div class="mission-card" id="mission-${m.id}" onclick="toggleMission('${m.id}')">
                    <div class="mission-icon">${m.icon}</div>
                    <div class="mission-label">${m.label}</div>
                </div>
            `).join('');
        };
        
        window.toggleMission = async (id) => {
            const card = document.getElementById('mission-' + id);
            card.classList.toggle('completed');
            
            if (!todayLog.checks) todayLog.checks = {};
            todayLog.checks[id] = card.classList.contains('completed');
            
            await saveTodayLog();
        };
        
        // ÏùºÍ∏∞
        window.saveDiary = async () => {
            const text = document.getElementById('diary-text').value;
            todayLog.diary = text;
            await saveTodayLog();
            alert('ÏùºÍ∏∞Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§! üìù');
        };
        
        // Ïò§Îäò Î°úÍ∑∏ Ï†ÄÏû•
        const saveTodayLog = async () => {
            const today = getTodayString();
            await db.collection('artifacts').doc(appId).collection('users')
                .doc(currentUser.uid).collection('logs').doc(today).set({
                    ...todayLog,
                    date: today
                }, { merge: true });
        };
        
        // Ïò§Îäò Î°úÍ∑∏ Î°úÎìú
        const loadTodayLog = async () => {
            const today = getTodayString();
            const doc = await db.collection('artifacts').doc(appId).collection('users')
                .doc(currentUser.uid).collection('logs').doc(today).get();
            
            if (doc.exists) {
                todayLog = doc.data();
                
                // Î¨º Î≥µÏõê
                const filled = (todayLog.water || 0) / 250;
                const cups = document.querySelectorAll('.water-cup');
                for (let i = 0; i < filled; i++) {
                    cups[i].classList.add('filled');
                }
                document.getElementById('water-count').textContent = filled;
                
                // ÎØ∏ÏÖò Î≥µÏõê
                if (todayLog.checks) {
                    Object.keys(todayLog.checks).forEach(id => {
                        if (todayLog.checks[id]) {
                            const card = document.getElementById('mission-' + id);
                            if (card) card.classList.add('completed');
                        }
                    });
                }
                
                // ÏùºÍ∏∞ Î≥µÏõê
                if (todayLog.diary) {
                    const diaryText = document.getElementById('diary-text');
                    if (diaryText) diaryText.value = todayLog.diary;
                }
            }
        };

        // ==================== Phase 5: AI ÏΩîÏπ≠ Î°úÏßÅ ====================
        // AI ÏΩîÏπ≠ Î°úÎìú Ìï®Ïàò
        const loadAICoaching = async () => {
            const aiCoachCard = document.getElementById('ai-coach-card');
            const aiCoachContent = document.getElementById('ai-coach-content');

            if (!aiCoachCard || !aiCoachContent) return;

            // API ÌÇ§ ÌôïÏù∏
            const hasValidKey = API_KEYS.some(key => key && !key.startsWith('YOUR_'));
            if (!hasValidKey) {
                aiCoachCard.style.display = 'none';
                return;
            }

            // Ï∫êÏãú ÌôïÏù∏ (30Î∂Ñ)
            const now = Date.now();
            const CACHE_TTL = 30 * 60 * 1000;
            if (aiCoachingCache && (now - aiCoachingCacheTime) < CACHE_TTL) {
                aiCoachCard.style.display = 'block';
                aiCoachContent.innerHTML = aiCoachingCache;
                return;
            }

            // Ïπ¥Îìú ÌëúÏãú Î∞è Î°úÎî© ÏÉÅÌÉú
            aiCoachCard.style.display = 'block';
            aiCoachContent.innerHTML = `
                <div style="text-align: center; padding: 20px 0;">
                    <div class="spinner" style="margin: 0 auto;"></div>
                    <p style="margin-top: 10px; opacity: 0.9;">AIÍ∞Ä Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...</p>
                </div>
            `;

            try {
                // Ïò§ÎäòÏùò Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const today = getTodayString();
                const todayDoc = await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('logs').doc(today).get();

                const todayData = todayDoc.exists ? todayDoc.data() : {};

                // Î™©Ìëú ÏôÑÎ£å Îç∞Ïù¥ÌÑ∞
                const goals = await loadGoals();
                const completionsSnapshot = await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('goal_completions')
                    .where('date', '==', today)
                    .get();

                const completedGoals = completionsSnapshot.docs.filter(
                    doc => doc.data().status === 'completed'
                ).length;

                // ÏµúÍ∑º 7Ïùº Ï≤¥Ï§ë Îç∞Ïù¥ÌÑ∞
                const logsSnapshot = await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .orderBy('date', 'desc')
                    .limit(7)
                    .get();

                const recentWeights = logsSnapshot.docs
                    .map(d => d.data())
                    .filter(l => l.weight)
                    .map(l => l.weight);

                const weightTrend = recentWeights.length >= 2
                    ? (recentWeights[0] - recentWeights[recentWeights.length - 1]).toFixed(1)
                    : 0;

                // ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ±
                const prompt = `ÎãπÏã†ÏùÄ ÏπúÍ∑ºÌïòÍ≥† Í≤©Î†§Î•º Ïûò Ìï¥Ï£ºÎäî Îã§Ïù¥Ïñ¥Ìä∏ ÏΩîÏπòÏûÖÎãàÎã§.
ÏÇ¨Ïö©ÏûêÏùò Ïò§Îäò ÌïòÎ£® Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÏÑùÌïòÏó¨ ÏßßÏùÄ Í≤©Î†§ÏôÄ Ï°∞Ïñ∏ÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî.

**ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥:**
- Î™©Ìëú Ï≤¥Ï§ë: ${currentProfile.targetWeight}kg
- ÌòÑÏû¨ Ï≤¥Ï§ë: ${currentProfile.currentWeight}kg
- Î™©Ìëú ÎÇ†Ïßú: ${currentProfile.targetDate}

**Ïò§ÎäòÏùò Í∏∞Î°ù:**
- ÏôÑÎ£åÌïú Î™©Ìëú: ${completedGoals}/${goals.length}Í∞ú
- Î¨º ÏÑ≠Ï∑®: ${Math.floor((todayData.water || 0) / 250)}Ïûî
- Ï≤¥Ï§ë Í∏∞Î°ù: ${todayData.weight ? todayData.weight + 'kg' : 'ÏóÜÏùå'}
- ÏµúÍ∑º 7Ïùº Ï≤¥Ï§ë Î≥ÄÌôî: ${weightTrend > 0 ? '-' : '+'}${Math.abs(weightTrend)}kg

**ÏöîÍµ¨ÏÇ¨Ìï≠:**
1. 3Ï§Ñ Ïù¥ÎÇ¥Î°ú Í∞ÑÍ≤∞ÌïòÍ≤å ÏûëÏÑ±
2. Ïù¥Î™®ÏßÄÎ•º Ï†ÅÏ†àÌûà ÏÇ¨Ïö©
3. Í∏çÏ†ïÏ†ÅÏù¥Í≥† Í≤©Î†§ÌïòÎäî ÌÜ§ Ïú†ÏßÄ
4. Íµ¨Ï≤¥Ï†ÅÏù∏ Ï°∞Ïñ∏ Ìè¨Ìï®

ÏùëÎãµ ÌòïÏãù:
[ÏßßÏùÄ Ïπ≠Ï∞¨ Ìïú Ï§Ñ]
[ÌòÑÏû¨ ÏÉÅÌÉú Î∂ÑÏÑù Ìïú Ï§Ñ]
[Íµ¨Ï≤¥Ï†ÅÏù∏ Ï°∞Ïñ∏ Ìïú Ï§Ñ]`;

                const aiResponse = await callGeminiAPI(prompt);

                // ÏùëÎãµ Ï†ïÎ¶¨ Î∞è Ï∫êÏã±
                const cleanResponse = aiResponse.trim();
                aiCoachingCache = cleanResponse;
                aiCoachingCacheTime = now;

                // UI ÏóÖÎç∞Ïù¥Ìä∏
                aiCoachContent.innerHTML = cleanResponse.replace(/\n/g, '<br>');

            } catch (error) {
                console.error('AI ÏΩîÏπ≠ Î°úÎìú Ïã§Ìå®:', error);

                if (error.message.includes('API ÌÇ§')) {
                    aiCoachCard.style.display = 'none';
                } else {
                    aiCoachContent.innerHTML = `
                        <div style="text-align: center; padding: 10px;">
                            ‚ö†Ô∏è AI ÏΩîÏπ≠ÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.<br>
                            <span style="font-size: 0.85rem; opacity: 0.8;">${error.message}</span>
                        </div>
                    `;
                }
            }
        };

        // AI ÏΩîÏπ≠ ÏÉàÎ°úÍ≥†Ïπ®
        window.refreshAICoaching = async () => {
            aiCoachingCache = null;
            aiCoachingCacheTime = 0;
            await loadAICoaching();
        };
        // ==================== End of Phase 5: AI ÏΩîÏπ≠ Î°úÏßÅ ====================

        // Î™©Ìëú Í¥ÄÎ¶¨ Ìï®Ïàò (CRUD)
        const createGoal = async (goalData) => {
            try {
                const newGoal = {
                    title: goalData.title,
                    icon: goalData.icon || 'üéØ',
                    type: goalData.type,
                    scheduledTimes: goalData.scheduledTimes || [],
                    estimatedDuration: goalData.estimatedDuration || '',
                    estimatedCalories: goalData.estimatedCalories || 0,
                    targetValue: goalData.targetValue || 0,
                    unit: goalData.unit || '',
                    active: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAtClient: new Date().toISOString()
                };

                const docRef = await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('goals').add(newGoal);

                goalsCache = null; // Ï∫êÏãú Î¨¥Ìö®Ìôî
                return docRef.id;
            } catch (error) {
                console.error('Create goal failed:', error);
                throw error;
            }
        };

        const loadGoals = async (useCache = true) => {
            const now = Date.now();
            const CACHE_TTL = 5 * 60 * 1000; // 5Î∂Ñ

            if (useCache && goalsCache && (now - goalsCacheTime) < CACHE_TTL) {
                return goalsCache;
            }

            try {
                const snapshot = await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('goals')
                    .where('active', '==', true)
                    .get();

                userGoals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                userGoals.sort((a, b) => {
                    const dateA = a.createdAtClient || '';
                    const dateB = b.createdAtClient || '';
                    return dateA.localeCompare(dateB);
                });

                goalsCache = userGoals;
                goalsCacheTime = now;
                return userGoals;
            } catch (error) {
                console.error('Load goals failed:', error);
                return [];
            }
        };

        const loadTodayCompletions = async () => {
            const today = getTodayString();
            try {
                const snapshot = await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('goal_completions')
                    .where('date', '==', today)
                    .get();

                todayCompletions = {};
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    todayCompletions[data.goalId] = data;
                });

                return todayCompletions;
            } catch (error) {
                console.error('Load completions failed:', error);
                return {};
            }
        };

        const updateGoalStatus = async (goalId, status, notes = '') => {
            const today = getTodayString();
            const docId = `${today}_${goalId}`;

            try {
                await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('goal_completions')
                    .doc(docId)
                    .set({
                        date: today,
                        goalId: goalId,
                        status: status,
                        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        notes: notes
                    }, { merge: true });

                todayCompletions[goalId] = { status, notes };
                return true;
            } catch (error) {
                console.error('Update goal status failed:', error);
                throw error;
            }
        };

        const deleteGoal = async (goalId) => {
            try {
                await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('goals')
                    .doc(goalId)
                    .update({ active: false });

                goalsCache = null; // Ï∫êÏãú Î¨¥Ìö®Ìôî
                return true;
            } catch (error) {
                console.error('Delete goal failed:', error);
                throw error;
            }
        };

        const editGoal = async (goalId, updates) => {
            try {
                await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('goals')
                    .doc(goalId)
                    .update(updates);

                goalsCache = null; // Ï∫êÏãú Î¨¥Ìö®Ìôî
                return true;
            } catch (error) {
                console.error('Edit goal failed:', error);
                throw error;
            }
        };

        // Î™©Ìëú Î†åÎçîÎßÅ
        const renderGoalsTab = async () => {
            try {
                const today = getTodayString();

                // ÎÇ†Ïßú ÌëúÏãú
                const dateDisplay = document.getElementById('goals-date-display');
                const dateObj = new Date();
                dateDisplay.textContent = `${dateObj.getMonth() + 1}Ïõî ${dateObj.getDate()}Ïùº`;

                // Î™©Ìëú Î°úÎìú
                const goals = await loadGoals();
                userGoals = goals;

                // Ïò§ÎäòÏùò ÏôÑÎ£å ÏÉÅÌÉú Î°úÎìú
                const completionSnapshot = await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('goal_completions')
                    .where('date', '==', today)
                    .get();

                todayCompletions = {};
                completionSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    todayCompletions[data.goalId] = data;
                });

                // Î™©Ìëú Î†åÎçîÎßÅ
                renderGoalsList();
            } catch (error) {
                console.error('Failed to render goals:', error);
            }
        };

        const renderGoalsList = (filterCategory = 'all') => {
            const goalsList = document.getElementById('goals-list');
            const goalsEmpty = document.getElementById('goals-empty');

            let filteredGoals = userGoals;
            if (filterCategory !== 'all') {
                filteredGoals = userGoals.filter(g => g.type === filterCategory);
            }

            if (filteredGoals.length === 0) {
                goalsList.innerHTML = '';
                goalsEmpty.classList.remove('hidden');
                return;
            }

            goalsEmpty.classList.add('hidden');

            // ÏãúÍ∞ÑÏàú Ï†ïÎ†¨ (Ï¢ÖÏùº -> ÏãúÍ∞Ñ ÏßÄÏ†ï Ïàú)
            const sortedGoals = [...filteredGoals].sort((a, b) => {
                if (a.scheduledTimes.includes('Ï¢ÖÏùº') && !b.scheduledTimes.includes('Ï¢ÖÏùº')) return -1;
                if (!a.scheduledTimes.includes('Ï¢ÖÏùº') && b.scheduledTimes.includes('Ï¢ÖÏùº')) return 1;
                if (a.scheduledTimes[0] && b.scheduledTimes[0]) {
                    return a.scheduledTimes[0].localeCompare(b.scheduledTimes[0]);
                }
                return 0;
            });

            goalsList.innerHTML = sortedGoals.map(goal => {
                const completion = todayCompletions[goal.id];
                const isCompleted = completion && completion.status === 'completed';
                const isSkipped = completion && completion.status === 'skipped';

                let statusClass = '';
                let statusBadge = '';
                if (isCompleted) {
                    statusClass = 'completed';
                    statusBadge = '<span class="goal-status-badge completed">ÏôÑÎ£å</span>';
                } else if (isSkipped) {
                    statusClass = 'skipped';
                    statusBadge = '<span class="goal-status-badge skipped">Í±¥ÎÑàÎúÄ</span>';
                }

                const timeDisplay = goal.scheduledTimes.length > 0
                    ? `<div class="goal-time-badge">${goal.scheduledTimes.join(', ')}</div>`
                    : '';

                const statsDisplay = [];
                if (goal.estimatedDuration) {
                    statsDisplay.push(`‚è±Ô∏è ${goal.estimatedDuration}`);
                }
                if (goal.estimatedCalories) {
                    statsDisplay.push(`üî• ${goal.estimatedCalories}kcal`);
                }
                const stats = statsDisplay.length > 0
                    ? `<div class="goal-stats">${statsDisplay.join(' ‚Ä¢ ')}</div>`
                    : '';

                return `
                    <div class="goal-card ${statusClass}" data-goal-id="${goal.id}">
                        <div class="goal-header">
                            <div class="goal-info">
                                <div class="goal-title">
                                    <span class="goal-icon">${goal.icon}</span>
                                    <span>${goal.title}</span>
                                </div>
                                ${timeDisplay}
                            </div>
                            <div class="goal-actions">
                                ${statusBadge}
                                ${!isCompleted && !isSkipped ? `
                                    <button class="goal-action-btn complete" onclick="toggleGoalComplete('${goal.id}', 'completed')" title="ÏôÑÎ£å">
                                        ‚úì
                                    </button>
                                ` : ''}
                                ${isCompleted || isSkipped ? `
                                    <button class="goal-action-btn undo" onclick="toggleGoalComplete('${goal.id}', 'undo')" title="Ï∑®ÏÜå">
                                        ‚Ü∂
                                    </button>
                                ` : ''}
                                <button class="goal-action-btn edit" onclick="showGoalModal('${goal.id}')" title="ÏàòÏ†ï">
                                    ‚úé
                                </button>
                                <button class="goal-action-btn delete" onclick="confirmDeleteGoal('${goal.id}')" title="ÏÇ≠Ï†ú">
                                    üóë
                                </button>
                            </div>
                        </div>
                        ${stats}
                    </div>
                `;
            }).join('');
        };

        window.filterGoalsByCategory = (category) => {
            // Ïπ¥ÌÖåÍ≥†Î¶¨ Ïπ© ÌôúÏÑ±Ìôî
            document.querySelectorAll('.goal-category-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.category === category);
            });

            // Î™©Ìëú ÌïÑÌÑ∞ÎßÅ
            renderGoalsList(category);
        };

        window.toggleGoalComplete = async (goalId, action) => {
            try {
                if (action === 'undo') {
                    // ÏôÑÎ£å Ï∑®ÏÜå
                    const today = getTodayString();
                    const docId = `${today}_${goalId}`;
                    await db.collection('artifacts').doc(appId)
                        .collection('users').doc(currentUser.uid)
                        .collection('goal_completions')
                        .doc(docId)
                        .delete();

                    delete todayCompletions[goalId];
                } else {
                    // ÏôÑÎ£å ÎòêÎäî Í±¥ÎÑàÎúÄ
                    await updateGoalStatus(goalId, action);
                    todayCompletions[goalId] = {
                        goalId: goalId,
                        status: action,
                        date: getTodayString()
                    };
                }

                renderGoalsList();
                renderGoalsSummary(); // Ìôà ÌÉ≠ ÏöîÏïΩÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            } catch (error) {
                console.error('Toggle complete failed:', error);
                alert('ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®: ' + error.message);
            }
        };

        window.confirmDeleteGoal = async (goalId) => {
            if (!confirm('Ïù¥ Î™©ÌëúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            try {
                await deleteGoal(goalId);
                userGoals = userGoals.filter(g => g.id !== goalId);
                renderGoalsList();
                alert('Î™©ÌëúÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            } catch (error) {
                alert('ÏÇ≠Ï†ú Ïã§Ìå®: ' + error.message);
            }
        };

        // Î™©Ìëú ÏÉùÏÑ±/ÏàòÏ†ï Î™®Îã¨
        let currentEditingGoalId = null;

        window.showGoalModal = (goalId = null) => {
            currentEditingGoalId = goalId;
            const goal = goalId ? userGoals.find(g => g.id === goalId) : null;

            // ÏàòÏ†ï Ïãú Í∏∞Ï°¥ ÏãúÍ∞Ñ Î°úÎìú
            if (goal && goal.scheduledTimes) {
                tempScheduledTimes = goal.scheduledTimes.filter(t => t !== 'Ï¢ÖÏùº');
            } else {
                tempScheduledTimes = [];
            }

            const modalHTML = `
                <div class="goal-modal" id="goal-modal">
                    <div class="goal-modal-content">
                        <div class="goal-modal-header">
                            <h2>${goalId ? 'Î™©Ìëú ÏàòÏ†ï' : 'ÏÉà Î™©Ìëú Ï∂îÍ∞Ä'}</h2>
                            <button class="goal-modal-close" onclick="closeGoalModal()">‚úï</button>
                        </div>

                        <div class="goal-modal-body">
                            <div class="form-group">
                                <label class="form-label">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                                <select id="goal-type" class="form-input" onchange="updateGoalTypeFields()">
                                    <option value="exercise" ${goal?.type === 'exercise' ? 'selected' : ''}>üèÉ Ïö¥Îèô</option>
                                    <option value="diet" ${goal?.type === 'diet' ? 'selected' : ''}>ü•ó ÏãùÎã®</option>
                                    <option value="water" ${goal?.type === 'water' ? 'selected' : ''}>üíß Î¨º</option>
                                    <option value="custom" ${goal?.type === 'custom' ? 'selected' : ''}>‚ú® Í∏∞ÌÉÄ</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ÏïÑÏù¥ÏΩò</label>
                                <div class="icon-picker">
                                    <input type="text" id="goal-icon" class="form-input" value="${goal?.icon || 'üéØ'}" maxlength="2" style="text-align: center; font-size: 24px;">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Î™©Ìëú Ïù¥Î¶Ñ</label>
                                <input type="text" id="goal-title" class="form-input" placeholder="Ïòà: ÏïÑÏπ® Ï°∞ÍπÖ" value="${goal?.title || ''}" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">ÏãúÍ∞Ñ ÏÑ§Ï†ï</label>
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <input type="time" id="goal-time" class="form-input" style="flex: 1;">
                                    <button type="button" onclick="addGoalTime()" class="btn" style="padding: 10px 20px;">Ï∂îÍ∞Ä</button>
                                </div>
                                <div id="goal-times-list" class="goal-times-list">
                                    ${goal?.scheduledTimes?.map(time => `
                                        <span class="time-tag">
                                            ${time}
                                            <button onclick="removeGoalTime('${time}')">‚úï</button>
                                        </span>
                                    `).join('') || ''}
                                </div>
                                <label style="display: flex; align-items: center; margin-top: 10px; cursor: pointer;">
                                    <input type="checkbox" id="goal-allday" ${goal?.scheduledTimes?.includes('Ï¢ÖÏùº') ? 'checked' : ''} style="margin-right: 8px;">
                                    <span>Ï¢ÖÏùº</span>
                                </label>
                            </div>

                            <div id="exercise-fields" class="form-group ${goal?.type === 'exercise' || !goal ? '' : 'hidden'}">
                                <label class="form-label">ÏòàÏÉÅ ÏÜåÏöî ÏãúÍ∞Ñ (ÏÑ†ÌÉù)</label>
                                <input type="text" id="goal-duration" class="form-input" placeholder="Ïòà: 30Î∂Ñ" value="${goal?.estimatedDuration || ''}">

                                <label class="form-label" style="margin-top: 15px;">ÏòàÏÉÅ ÏπºÎ°úÎ¶¨ (ÏÑ†ÌÉù)</label>
                                <input type="number" id="goal-calories" class="form-input" placeholder="Ïòà: 200" value="${goal?.estimatedCalories || ''}">
                            </div>

                            <!-- Phase 5: Ïä§ÎßàÌä∏ ÏãùÎã® Î∂ÑÏÑù -->
                            <div id="diet-fields" class="form-group ${goal?.type === 'diet' ? '' : 'hidden'}">
                                <label class="form-label">üì∑ AI ÏùåÏãù Î∂ÑÏÑù</label>
                                <button type="button" onclick="openFoodAnalysis()" class="btn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 15px;">
                                    üì∑ ÏÇ¨ÏßÑÏúºÎ°ú ÏùåÏãù Î∂ÑÏÑùÌïòÍ∏∞
                                </button>

                                <label class="form-label">ÎòêÎäî ÏßÅÏ†ë ÏûÖÎ†•</label>
                                <input type="text" id="diet-food-name" class="form-input" placeholder="ÏùåÏãù Ïù¥Î¶Ñ" value="${goal?.foodName || ''}" style="margin-bottom: 10px;">
                                <input type="number" id="diet-calories" class="form-input" placeholder="ÏπºÎ°úÎ¶¨ (kcal)" value="${goal?.calories || ''}" style="margin-bottom: 10px;">

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                    <input type="number" id="diet-carbs" class="form-input" placeholder="ÌÉÑÏàòÌôîÎ¨º (g)" value="${goal?.carbs || ''}" style="text-align: center;">
                                    <input type="number" id="diet-protein" class="form-input" placeholder="Îã®Î∞±Ïßà (g)" value="${goal?.protein || ''}" style="text-align: center;">
                                    <input type="number" id="diet-fat" class="form-input" placeholder="ÏßÄÎ∞© (g)" value="${goal?.fat || ''}" style="text-align: center;">
                                </div>

                                <div style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 10px; font-size: 0.85rem; color: #666;">
                                    üí° ÏÇ¨ÏßÑÏúºÎ°ú Î∂ÑÏÑùÌïòÎ©¥ AIÍ∞Ä ÏûêÎèôÏúºÎ°ú ÏòÅÏñëÏÑ±Î∂ÑÏùÑ Ï±ÑÏõåÏ§çÎãàÎã§
                                </div>
                            </div>
                        </div>

                        <div class="goal-modal-footer">
                            <button onclick="closeGoalModal()" class="btn" style="background: #e0e0e0;">Ï∑®ÏÜå</button>
                            <button onclick="saveGoalFromModal()" class="btn btn-primary">Ï†ÄÏû•</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        };

        window.closeGoalModal = () => {
            const modal = document.getElementById('goal-modal');
            if (modal) modal.remove();
            currentEditingGoalId = null;
        };

        window.updateGoalTypeFields = () => {
            const type = document.getElementById('goal-type').value;
            const exerciseFields = document.getElementById('exercise-fields');
            const dietFields = document.getElementById('diet-fields');

            exerciseFields.classList.toggle('hidden', type !== 'exercise');
            dietFields.classList.toggle('hidden', type !== 'diet');
        };

        let tempScheduledTimes = [];

        window.addGoalTime = () => {
            const timeInput = document.getElementById('goal-time');
            const time = timeInput.value;

            if (!time) {
                alert('ÏãúÍ∞ÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            if (tempScheduledTimes.includes(time)) {
                alert('Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎêú ÏãúÍ∞ÑÏûÖÎãàÎã§.');
                return;
            }

            tempScheduledTimes.push(time);
            updateTimesDisplay();
            timeInput.value = '';
        };

        window.removeGoalTime = (time) => {
            tempScheduledTimes = tempScheduledTimes.filter(t => t !== time);
            updateTimesDisplay();
        };

        const updateTimesDisplay = () => {
            const timesList = document.getElementById('goal-times-list');
            timesList.innerHTML = tempScheduledTimes.map(time => `
                <span class="time-tag">
                    ${time}
                    <button onclick="removeGoalTime('${time}')">‚úï</button>
                </span>
            `).join('');
        };

        // ==================== Phase 5: Ïä§ÎßàÌä∏ ÏãùÎã® Î∂ÑÏÑù Î°úÏßÅ ====================
        // ÏÇ¨ÏßÑÏúºÎ°ú ÏùåÏãù Î∂ÑÏÑù Î™®Îã¨ Ïó¥Í∏∞
        window.openFoodAnalysis = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Î°úÎî© Î™®Îã¨ ÌëúÏãú
                const loadingModal = document.createElement('div');
                loadingModal.id = 'food-analysis-loading';
                loadingModal.className = 'goal-modal';
                loadingModal.innerHTML = `
                    <div class="goal-modal-content" style="max-width: 400px;">
                        <div style="text-align: center; padding: 40px 20px;">
                            <div class="spinner" style="margin: 0 auto 20px;"></div>
                            <h3 style="margin-bottom: 10px;">ü§ñ AIÍ∞Ä ÏùåÏãùÏùÑ Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§</h3>
                            <p style="color: #666;">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingModal);

                try {
                    // Ïù¥ÎØ∏ÏßÄÎ•º Base64Î°ú Î≥ÄÌôò
                    const base64 = await imageToBase64(file);

                    // Gemini APIÎ°ú ÏùåÏãù Î∂ÑÏÑù
                    const prompt = `ÎãπÏã†ÏùÄ ÏùåÏãù ÏòÅÏñë Î∂ÑÏÑù Ï†ÑÎ¨∏Í∞ÄÏûÖÎãàÎã§.
Ïù¥ ÏÇ¨ÏßÑÏóê ÏûàÎäî ÏùåÏãùÏùÑ Î∂ÑÏÑùÌïòÏó¨ Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏùÄ 3Í∞ÄÏßÄ ÌõÑÎ≥¥Î•º Ï†úÏãúÌï¥Ï£ºÏÑ∏Ïöî.

Í∞Å ÌõÑÎ≥¥ÎßàÎã§ Îã§Ïùå Ï†ïÎ≥¥Î•º Ï†úÍ≥µÌï¥Ï£ºÏÑ∏Ïöî:
1. ÏùåÏãù Ïù¥Î¶Ñ (ÌïúÍµ≠Ïñ¥, Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú)
2. ÏòàÏÉÅ ÏπºÎ°úÎ¶¨ (kcal)
3. ÌÉÑÏàòÌôîÎ¨º (g)
4. Îã®Î∞±Ïßà (g)
5. ÏßÄÎ∞© (g)

**ÏùëÎãµ ÌòïÏãù (JSON):**
\`\`\`json
[
  {
    "name": "ÏùåÏãùÎ™Ö",
    "calories": Ïà´Ïûê,
    "carbs": Ïà´Ïûê,
    "protein": Ïà´Ïûê,
    "fat": Ïà´Ïûê,
    "confidence": "ÎÜíÏùå/Ï§ëÍ∞Ñ/ÎÇÆÏùå"
  }
]
\`\`\`

Ï†ïÌôïÌïú JSON ÌòïÏãùÏúºÎ°úÎßå ÏùëÎãµÌï¥Ï£ºÏÑ∏Ïöî. Îã§Î•∏ ÏÑ§Î™ÖÏùÄ Î∂àÌïÑÏöîÌï©ÎãàÎã§.`;

                    const aiResponse = await callGeminiAPI(prompt, base64);

                    // JSON ÌååÏã±
                    const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                    if (!jsonMatch) {
                        throw new Error('AI ÏùëÎãµÏùÑ ÌååÏã±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
                    }

                    const suggestions = JSON.parse(jsonMatch[0]);

                    // Î°úÎî© Î™®Îã¨ Ï†úÍ±∞
                    loadingModal.remove();

                    // ÏÑ†ÌÉù Î™®Îã¨ ÌëúÏãú
                    showFoodSuggestions(suggestions);

                } catch (error) {
                    console.error('ÏùåÏãù Î∂ÑÏÑù Ïã§Ìå®:', error);
                    loadingModal.remove();

                    if (error.message.includes('API ÌÇ§')) {
                        alert('‚ö†Ô∏è ' + error.message);
                    } else {
                        alert('ÏùåÏãù Î∂ÑÏÑùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\nÏßÅÏ†ë ÏûÖÎ†•ÏùÑ Ïù¥Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.\n\nÏò§Î•ò: ' + error.message);
                    }
                }
            };

            input.click();
        };

        // ÏùåÏãù Ï†úÏïà ÏÑ†ÌÉù Î™®Îã¨ ÌëúÏãú
        const showFoodSuggestions = (suggestions) => {
            const modal = document.createElement('div');
            modal.id = 'food-suggestions-modal';
            modal.className = 'goal-modal';
            modal.innerHTML = `
                <div class="goal-modal-content" style="max-width: 500px;">
                    <div class="goal-modal-header">
                        <h2>üçΩÔ∏è AI ÏùåÏãù Î∂ÑÏÑù Í≤∞Í≥º</h2>
                        <button class="goal-modal-close" onclick="closeFoodSuggestions()">‚úï</button>
                    </div>

                    <div class="goal-modal-body">
                        <p style="color: #666; margin-bottom: 20px;">
                            Í∞ÄÏû• Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏùÄ ÏùåÏãùÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
                        </p>

                        ${suggestions.map((food, index) => `
                            <div class="food-suggestion-card" onclick="selectFoodSuggestion(${index})" style="cursor: pointer; padding: 15px; background: #f9f9f9; border-radius: 15px; margin-bottom: 10px; border: 2px solid #e0e0e0; transition: all 0.3s;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="font-size: 1.1rem; margin: 0;">${food.name}</h3>
                                    <span style="background: ${food.confidence === 'ÎÜíÏùå' ? '#4caf50' : food.confidence === 'Ï§ëÍ∞Ñ' ? '#ffc107' : '#ff9800'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                                        ${food.confidence}
                                    </span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 0.9rem;">
                                    <div style="text-align: center;">
                                        <div style="color: #666;">ÏπºÎ°úÎ¶¨</div>
                                        <div style="font-weight: bold; color: #667eea;">${food.calories}kcal</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="color: #666;">ÌÉÑ</div>
                                        <div style="font-weight: bold;">${food.carbs}g</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="color: #666;">Îã®</div>
                                        <div style="font-weight: bold;">${food.protein}g</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="color: #666;">ÏßÄ</div>
                                        <div style="font-weight: bold;">${food.fat}g</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}

                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 10px; border: 1px solid #ffc107;">
                            <strong>üí° Î™®Îëê ÌãÄÎ†∏ÎÇòÏöî?</strong>
                            <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #666;">
                                Î™®Îã¨ÏùÑ Îã´Í≥† "ÏßÅÏ†ë ÏûÖÎ†•" ÏÑπÏÖòÏùÑ Ïù¥Ïö©ÌïòÍ±∞ÎÇò <a href="#" onclick="event.preventDefault(); closeFoodSuggestions(); openDirectSearch();" style="color: #667eea; text-decoration: underline;">ÏßÅÏ†ë Í≤ÄÏÉâ</a>ÌïòÏÑ∏Ïöî.
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // ÏùåÏãù Ï†úÏïà Ïπ¥ÎìúÏóê Ìò∏Î≤Ñ Ìö®Í≥º
            const cards = modal.querySelectorAll('.food-suggestion-card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.borderColor = '#667eea';
                    card.style.background = '#f0f3ff';
                    card.style.transform = 'scale(1.02)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.borderColor = '#e0e0e0';
                    card.style.background = '#f9f9f9';
                    card.style.transform = 'scale(1)';
                });
            });

            // Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû• (selectFoodSuggestionÏóêÏÑú ÏÇ¨Ïö©)
            window.currentFoodSuggestions = suggestions;
        };

        // ÏùåÏãù Ï†úÏïà ÏÑ†ÌÉù
        window.selectFoodSuggestion = (index) => {
            const food = window.currentFoodSuggestions[index];

            // ÏûÖÎ†•Ï∞ΩÏóê Í∞í Ï±ÑÏö∞Í∏∞
            document.getElementById('diet-food-name').value = food.name;
            document.getElementById('diet-calories').value = food.calories;
            document.getElementById('diet-carbs').value = food.carbs;
            document.getElementById('diet-protein').value = food.protein;
            document.getElementById('diet-fat').value = food.fat;

            // Î™©Ìëú Ïù¥Î¶ÑÎèÑ ÏûêÎèôÏúºÎ°ú Ï±ÑÏö∞Í∏∞ (ÎπÑÏñ¥ÏûàÏùÑ Í≤ΩÏö∞)
            const titleInput = document.getElementById('goal-title');
            if (!titleInput.value.trim()) {
                titleInput.value = food.name;
            }

            // Î™®Îã¨ Îã´Í∏∞
            closeFoodSuggestions();

            alert(`‚úÖ "${food.name}" Ï†ïÎ≥¥Í∞Ä ÏûÖÎ†•ÎêòÏóàÏäµÎãàÎã§!\nÌïÑÏöîÌïòÎ©¥ ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.`);
        };

        // ÏùåÏãù Ï†úÏïà Î™®Îã¨ Îã´Í∏∞
        window.closeFoodSuggestions = () => {
            const modal = document.getElementById('food-suggestions-modal');
            if (modal) modal.remove();
            window.currentFoodSuggestions = null;
        };

        // ÏßÅÏ†ë Í≤ÄÏÉâ (Fallback)
        window.openDirectSearch = () => {
            const searchTerm = prompt('üîç ÏùåÏãù Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:\n(Ïòà: ÏπòÌÇ®, ÌîºÏûê, ÏÉêÎü¨Îìú Îì±)');
            if (!searchTerm) return;

            // Î°úÎî© ÌëúÏãú
            const loadingModal = document.createElement('div');
            loadingModal.id = 'food-search-loading';
            loadingModal.className = 'goal-modal';
            loadingModal.innerHTML = `
                <div class="goal-modal-content" style="max-width: 400px;">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <h3 style="margin-bottom: 10px;">üîç "${searchTerm}" Í≤ÄÏÉâ Ï§ë...</h3>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingModal);

            // Gemini APIÎ°ú Í≤ÄÏÉâ
            const prompt = `"${searchTerm}"Ïùò ÏùºÎ∞òÏ†ÅÏù∏ 1Ïù∏Î∂Ñ ÏòÅÏñë Ï†ïÎ≥¥Î•º ÏïåÎ†§Ï£ºÏÑ∏Ïöî.

Îã§Ïùå Ï†ïÎ≥¥Î•º Ï†úÍ≥µÌï¥Ï£ºÏÑ∏Ïöî:
1. Ï†ïÌôïÌïú ÏùåÏãùÎ™Ö (ÌïúÍµ≠Ïñ¥)
2. 1Ïù∏Î∂Ñ ÏπºÎ°úÎ¶¨ (kcal)
3. ÌÉÑÏàòÌôîÎ¨º (g)
4. Îã®Î∞±Ïßà (g)
5. ÏßÄÎ∞© (g)

**ÏùëÎãµ ÌòïÏãù (JSON):**
\`\`\`json
{
  "name": "ÏùåÏãùÎ™Ö (1Ïù∏Î∂Ñ)",
  "calories": Ïà´Ïûê,
  "carbs": Ïà´Ïûê,
  "protein": Ïà´Ïûê,
  "fat": Ïà´Ïûê
}
\`\`\`

Ï†ïÌôïÌïú JSON ÌòïÏãùÏúºÎ°úÎßå ÏùëÎãµÌï¥Ï£ºÏÑ∏Ïöî.`;

            callGeminiAPI(prompt)
                .then(response => {
                    const jsonMatch = response.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('ÏùëÎãµÏùÑ ÌååÏã±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
                    }

                    const food = JSON.parse(jsonMatch[0]);

                    // ÏûÖÎ†•Ï∞ΩÏóê Í∞í Ï±ÑÏö∞Í∏∞
                    document.getElementById('diet-food-name').value = food.name;
                    document.getElementById('diet-calories').value = food.calories;
                    document.getElementById('diet-carbs').value = food.carbs;
                    document.getElementById('diet-protein').value = food.protein;
                    document.getElementById('diet-fat').value = food.fat;

                    // Î™©Ìëú Ïù¥Î¶ÑÎèÑ ÏûêÎèôÏúºÎ°ú Ï±ÑÏö∞Í∏∞
                    const titleInput = document.getElementById('goal-title');
                    if (!titleInput.value.trim()) {
                        titleInput.value = food.name;
                    }

                    loadingModal.remove();
                    alert(`‚úÖ "${food.name}" Ï†ïÎ≥¥Í∞Ä ÏûÖÎ†•ÎêòÏóàÏäµÎãàÎã§!`);
                })
                .catch(error => {
                    console.error('Í≤ÄÏÉâ Ïã§Ìå®:', error);
                    loadingModal.remove();
                    alert('Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.\nÏßÅÏ†ë ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.\n\nÏò§Î•ò: ' + error.message);
                });
        };
        // ==================== End of Phase 5: Ïä§ÎßàÌä∏ ÏãùÎã® Î∂ÑÏÑù Î°úÏßÅ ====================

        window.saveGoalFromModal = async () => {
            try {
                const title = document.getElementById('goal-title').value.trim();
                if (!title) {
                    alert('Î™©Ìëú Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                const type = document.getElementById('goal-type').value;
                const icon = document.getElementById('goal-icon').value || 'üéØ';
                const allday = document.getElementById('goal-allday').checked;

                const scheduledTimes = allday ? ['Ï¢ÖÏùº'] : tempScheduledTimes;

                const goalData = {
                    title,
                    type,
                    icon,
                    scheduledTimes,
                    estimatedDuration: type === 'exercise' ? document.getElementById('goal-duration').value : '',
                    estimatedCalories: type === 'exercise' ? parseInt(document.getElementById('goal-calories').value) || 0 : 0,
                    // Phase 5: ÏãùÎã® Ï†ïÎ≥¥ Ï∂îÍ∞Ä
                    foodName: type === 'diet' ? document.getElementById('diet-food-name').value : '',
                    calories: type === 'diet' ? parseInt(document.getElementById('diet-calories').value) || 0 : 0,
                    carbs: type === 'diet' ? parseInt(document.getElementById('diet-carbs').value) || 0 : 0,
                    protein: type === 'diet' ? parseInt(document.getElementById('diet-protein').value) || 0 : 0,
                    fat: type === 'diet' ? parseInt(document.getElementById('diet-fat').value) || 0 : 0
                };

                if (currentEditingGoalId) {
                    // ÏàòÏ†ï
                    await editGoal(currentEditingGoalId, goalData);
                    const goalIndex = userGoals.findIndex(g => g.id === currentEditingGoalId);
                    if (goalIndex !== -1) {
                        userGoals[goalIndex] = { ...userGoals[goalIndex], ...goalData };
                    }
                } else {
                    // ÏÉàÎ°ú Ï∂îÍ∞Ä
                    const newGoalId = await createGoal(goalData);
                    userGoals.push({ id: newGoalId, ...goalData, active: true });
                }

                closeGoalModal();
                renderGoalsList();
                renderGoalsSummary(); // Ìôà ÌÉ≠ ÏöîÏïΩÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                tempScheduledTimes = [];

                alert(currentEditingGoalId ? 'Î™©ÌëúÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!' : 'ÏÉà Î™©ÌëúÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!');
            } catch (error) {
                console.error('Save goal failed:', error);
                alert('Ï†ÄÏû• Ïã§Ìå®: ' + error.message);
            }
        };

        // Ìôà ÌÉ≠ Î™©Ìëú ÏöîÏïΩ Î†åÎçîÎßÅ
        const renderGoalsSummary = async () => {
            try {
                const summaryCard = document.getElementById('goals-summary-card');
                const summaryContent = document.getElementById('goals-summary-content');

                // ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÌôïÏù∏
                const migrated = await hasMigratedToGoals();
                if (!migrated) {
                    summaryCard.style.display = 'none';
                    return;
                }

                // Î™©Ìëú Î°úÎìú
                const goals = await loadGoals();
                if (goals.length === 0) {
                    summaryCard.style.display = 'none';
                    return;
                }

                summaryCard.style.display = 'block';

                // Ïò§ÎäòÏùò ÏôÑÎ£å ÏÉÅÌÉú Î°úÎìú
                const today = getTodayString();
                const completionSnapshot = await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('goal_completions')
                    .where('date', '==', today)
                    .get();

                const completions = {};
                completionSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    completions[data.goalId] = data;
                });

                // ÏôÑÎ£å ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
                const completedCount = goals.filter(g =>
                    completions[g.id] && completions[g.id].status === 'completed'
                ).length;
                const totalCount = goals.length;
                const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

                // Îã§Ïùå Î™©Ìëú Ï∞æÍ∏∞ (ÎØ∏ÏôÑÎ£å Ï§ë Í∞ÄÏû• Îπ†Î•∏ ÏãúÍ∞Ñ)
                const now = new Date();
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

                const upcomingGoals = goals
                    .filter(g => !completions[g.id] || completions[g.id].status !== 'completed')
                    .filter(g => g.scheduledTimes && g.scheduledTimes.length > 0)
                    .sort((a, b) => {
                        if (a.scheduledTimes.includes('Ï¢ÖÏùº') && !b.scheduledTimes.includes('Ï¢ÖÏùº')) return -1;
                        if (!a.scheduledTimes.includes('Ï¢ÖÏùº') && b.scheduledTimes.includes('Ï¢ÖÏùº')) return 1;
                        if (a.scheduledTimes[0] && b.scheduledTimes[0]) {
                            return a.scheduledTimes[0].localeCompare(b.scheduledTimes[0]);
                        }
                        return 0;
                    })
                    .slice(0, 3);

                // HTML Î†åÎçîÎßÅ
                summaryContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666; font-size: 14px;">ÏßÑÌñâÎ•†</span>
                            <span style="font-weight: bold; color: #667eea;">${completedCount}/${totalCount} ÏôÑÎ£å</span>
                        </div>
                        <div style="background: #f0f0f0; height: 10px; border-radius: 10px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
                        </div>
                    </div>

                    ${upcomingGoals.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <h4 style="font-size: 14px; color: #666; margin-bottom: 10px;">Îã§Ïùå Î™©Ìëú</h4>
                            ${upcomingGoals.map(goal => `
                                <div style="display: flex; align-items: center; padding: 10px; background: #f9f9f9; border-radius: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 20px; margin-right: 10px;">${goal.icon}</span>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500;">${goal.title}</div>
                                        ${goal.scheduledTimes[0] ? `
                                            <div style="font-size: 12px; color: #999;">
                                                ${goal.scheduledTimes[0]}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <button onclick="quickCompleteGoal('${goal.id}')"
                                            class="btn"
                                            style="padding: 5px 12px; font-size: 12px; background: #667eea; color: white;">
                                        ÏôÑÎ£å
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 20px 0; color: #999;">
                            ${completedCount === totalCount ? 'üéâ Î™®Îì† Î™©ÌëúÎ•º Îã¨ÏÑ±ÌñàÏñ¥Ïöî!' : 'Î™©ÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§.'}
                        </div>
                    `}
                `;
            } catch (error) {
                console.error('Failed to render goals summary:', error);
            }
        };

        // Îπ†Î•∏ ÏôÑÎ£å Î≤ÑÌäº
        window.quickCompleteGoal = async (goalId) => {
            try {
                await updateGoalStatus(goalId, 'completed');
                renderGoalsSummary(); // ÏöîÏïΩ Îã§Ïãú Î†åÎçîÎßÅ

                // Ï∂ïÌïò Î©îÏãúÏßÄ
                const goal = userGoals.find(g => g.id === goalId);
                if (goal) {
                    alert(`‚úÖ "${goal.title}" Î™©ÌëúÎ•º ÏôÑÎ£åÌñàÏäµÎãàÎã§!`);
                }
            } catch (error) {
                console.error('Quick complete failed:', error);
                alert('ÏôÑÎ£å Ï≤òÎ¶¨ Ïã§Ìå®: ' + error.message);
            }
        };

        // Ïï®Î≤î
        window.switchAlbumTab = (type) => {
            currentAlbumTab = type;
            document.querySelectorAll('.album-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            loadAlbumPhotos();
        };

        window.addPhoto = () => {
            document.getElementById('photo-input').click();
        };

        window.handlePhotoUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const timestamp = Date.now();
                const fileName = `${currentUser.uid}/${currentAlbumTab}/${timestamp}.jpg`;
                const storageRef = storage.ref().child(`artifacts/${appId}/photos/${fileName}`);

                await storageRef.put(file);
                const url = await storageRef.getDownloadURL();

                await db.collection('artifacts').doc(appId).collection('users')
                    .doc(currentUser.uid).collection('photos').add({
                        url,
                        type: currentAlbumTab,
                        date: getTodayString(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                alert('ÏÇ¨ÏßÑÏù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§! üì∏');
                loadAlbumPhotos();
            } catch (error) {
                alert('ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú Ïã§Ìå®: ' + error.message);
            }

            event.target.value = '';
        };

        const loadAlbumPhotos = async () => {
            const snapshot = await db.collection('artifacts').doc(appId).collection('users')
                .doc(currentUser.uid).collection('photos')
                .where('type', '==', currentAlbumTab)
                .orderBy('timestamp', 'desc')
                .get();

            albumPhotos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const grid = document.getElementById('photo-grid');
            if (!grid) return;

            grid.innerHTML = '<div class="photo-item add-photo" onclick="addPhoto()">+</div>';

            albumPhotos.forEach(photo => {
                const item = document.createElement('div');
                item.className = 'photo-item photo-item-with-date';
                item.innerHTML = `
                    <img src="${photo.url}" alt="ÏÇ¨ÏßÑ">
                    <div class="photo-date-label">${photo.date}</div>
                `;
                item.onclick = () => viewPhoto(photo);
                grid.appendChild(item);
            });
        };

        window.viewPhoto = (photo) => {
            const index = albumPhotos.findIndex(p => p.id === photo.id);
            if (index >= 0) {
                timelapseIndex = albumPhotos.length - 1 - index;
                showTimelapse();
            }
        };

        // ÌÉÄÏûÑÎû©Ïä§
        window.showTimelapse = () => {
            if (albumPhotos.length === 0) {
                alert('ÏïÑÏßÅ ÏÇ¨ÏßÑÏù¥ ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏÇ¨ÏßÑÏùÑ ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî! üì∏');
                return;
            }

            const reversedPhotos = [...albumPhotos].reverse();

            const modal = document.createElement('div');
            modal.className = 'timelapse-modal';
            modal.innerHTML = `
                <div class="timelapse-header">
                    <div class="timelapse-title">üé¨ Î≥ÄÌôî ÌÉÄÏûÑÎû©Ïä§</div>
                    <button class="close-btn" onclick="closeTimelapse()">&times;</button>
                </div>
                <div class="timelapse-main">
                    <img id="timelapse-img" class="timelapse-image" src="${reversedPhotos[timelapseIndex].url}" alt="ÌÉÄÏûÑÎû©Ïä§">
                </div>
                <div class="timelapse-controls">
                    <input type="range" class="timelapse-slider" id="timelapse-slider"
                           min="0" max="${reversedPhotos.length - 1}" value="${timelapseIndex}"
                           oninput="updateTimelapse(this.value)">
                    <div class="timelapse-info" id="timelapse-info">
                        ${reversedPhotos[timelapseIndex].date} (${timelapseIndex + 1}/${reversedPhotos.length})
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        };

        window.updateTimelapse = (index) => {
            const reversedPhotos = [...albumPhotos].reverse();
            timelapseIndex = parseInt(index);

            const img = document.getElementById('timelapse-img');
            const info = document.getElementById('timelapse-info');

            if (img && info && reversedPhotos[timelapseIndex]) {
                img.src = reversedPhotos[timelapseIndex].url;
                info.textContent = `${reversedPhotos[timelapseIndex].date} (${timelapseIndex + 1}/${reversedPhotos.length})`;
            }
        };

        window.closeTimelapse = () => {
            const modal = document.querySelector('.timelapse-modal');
            if (modal) modal.remove();
        };
        
        // Ï∫òÎ¶∞Îçî
        const renderCalendar = async () => {
            const container = document.getElementById('calendar-container');
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const today = getTodayString();

            // ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÌôïÏù∏
            const migrated = await hasMigratedToGoals();

            // Ïù¥Î≤à Îã¨ Î™©Ìëú ÏôÑÎ£å Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Îêú Í≤ΩÏö∞Îßå)
            let monthCompletions = {};
            if (migrated) {
                try {
                    const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                    const endDate = `${year}-${String(month + 1).padStart(2, '0')}-${lastDate}`;

                    const snapshot = await db.collection('artifacts').doc(appId)
                        .collection('users').doc(currentUser.uid)
                        .collection('goal_completions')
                        .where('date', '>=', startDate)
                        .where('date', '<=', endDate)
                        .get();

                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (!monthCompletions[data.date]) {
                            monthCompletions[data.date] = { completed: 0, total: 0 };
                        }
                        if (data.status === 'completed') {
                            monthCompletions[data.date].completed++;
                        }
                        monthCompletions[data.date].total++;
                    });

                    // Í∞Å ÎÇ†ÏßúÏùò Ï¥ù Î™©Ìëú Ïàò Í≥ÑÏÇ∞
                    const goals = await loadGoals();
                    const totalGoalsCount = goals.length;

                    // Í∞Å ÎÇ†ÏßúÏóê Ï¥ù Î™©Ìëú Ïàò ÏÑ§Ï†ï
                    Object.keys(monthCompletions).forEach(date => {
                        monthCompletions[date].totalGoals = totalGoalsCount;
                    });
                } catch (error) {
                    console.error('Failed to load calendar completions:', error);
                }
            }

            let html = `
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeMonth(-1)">‚óÄ</button>
                    <div class="calendar-month">${year}ÎÖÑ ${month + 1}Ïõî</div>
                    <button class="calendar-nav" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
                <div class="calendar-grid">
            `;

            ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'].forEach(day => {
                html += `<div class="calendar-day-label">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                html += `<div></div>`;
            }

            for (let date = 1; date <= lastDate; date++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const isToday = dateStr === today;
                const isFuture = new Date(dateStr) > new Date(today);

                const completionData = monthCompletions[dateStr];
                let completionIndicator = '';
                let completionClass = '';

                if (migrated && completionData && completionData.totalGoals > 0) {
                    const percent = Math.round((completionData.completed / completionData.totalGoals) * 100);

                    if (percent === 100) {
                        completionClass = 'has-perfect-goals';
                        completionIndicator = `<div class="calendar-goal-badge perfect">‚úì</div>`;
                    } else if (percent >= 50) {
                        completionClass = 'has-good-goals';
                        completionIndicator = `<div class="calendar-goal-badge good">${completionData.completed}/${completionData.totalGoals}</div>`;
                    } else if (percent > 0) {
                        completionClass = 'has-some-goals';
                        completionIndicator = `<div class="calendar-goal-badge some">${completionData.completed}/${completionData.totalGoals}</div>`;
                    }
                }

                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${completionClass} ${isFuture ? 'future' : ''}"
                         onclick="showCalendarDayDetail('${dateStr}')">
                        <div class="calendar-day-number">${date}</div>
                        ${completionIndicator}
                    </div>
                `;
            }

            html += `</div>`;
            container.innerHTML = html;
        };
        
        window.changeMonth = (delta) => {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        };

        window.showCalendarDayDetail = async (dateStr) => {
            const today = getTodayString();
            const isFuture = new Date(dateStr) > new Date(today);

            if (isFuture) {
                return; // ÎØ∏Îûò ÎÇ†ÏßúÎäî ÌÅ¥Î¶≠ Î∂àÍ∞Ä
            }

            try {
                // Ìï¥Îãπ ÎÇ†ÏßúÏùò Î™©Ìëú ÏôÑÎ£å Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const snapshot = await db.collection('artifacts').doc(appId)
                    .collection('users').doc(currentUser.uid)
                    .collection('goal_completions')
                    .where('date', '==', dateStr)
                    .get();

                const completions = {};
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    completions[data.goalId] = data;
                });

                // Î™®Îì† Î™©Ìëú Î°úÎìú
                const goals = await loadGoals();

                // Î™®Îã¨ ÏÉùÏÑ±
                const dateObj = new Date(dateStr);
                const modalHTML = `
                    <div class="goal-modal" id="calendar-detail-modal">
                        <div class="goal-modal-content">
                            <div class="goal-modal-header">
                                <h2>${dateObj.getMonth() + 1}Ïõî ${dateObj.getDate()}Ïùº Î™©Ìëú</h2>
                                <button class="goal-modal-close" onclick="closeCalendarDetail()">‚úï</button>
                            </div>

                            <div class="goal-modal-body">
                                ${goals.length === 0 ? `
                                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                                        Î™©ÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§.
                                    </div>
                                ` : `
                                    ${goals.map(goal => {
                                        const completion = completions[goal.id];
                                        const isCompleted = completion && completion.status === 'completed';
                                        const isSkipped = completion && completion.status === 'skipped';

                                        return `
                                            <div style="display: flex; align-items: center; padding: 15px; background: ${isCompleted ? '#e8f5e9' : isSkipped ? '#f5f5f5' : '#fff'}; border-radius: 10px; margin-bottom: 10px; border: 1px solid ${isCompleted ? '#4caf50' : '#e0e0e0'};">
                                                <span style="font-size: 24px; margin-right: 12px;">${goal.icon}</span>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 500;">${goal.title}</div>
                                                    ${goal.scheduledTimes && goal.scheduledTimes.length > 0 ? `
                                                        <div style="font-size: 12px; color: #999;">
                                                            ${goal.scheduledTimes.join(', ')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                <div style="font-weight: bold; color: ${isCompleted ? '#4caf50' : isSkipped ? '#999' : '#e0e0e0'};">
                                                    ${isCompleted ? '‚úì ÏôÑÎ£å' : isSkipped ? 'Í±¥ÎÑàÎúÄ' : 'ÎØ∏ÏôÑÎ£å'}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                `}

                                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span style="color: #666;">ÏôÑÎ£åÌïú Î™©Ìëú</span>
                                        <span style="font-weight: bold; color: #667eea;">
                                            ${goals.filter(g => completions[g.id] && completions[g.id].status === 'completed').length}Í∞ú
                                        </span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Ï†ÑÏ≤¥ Î™©Ìëú</span>
                                        <span style="font-weight: bold;">${goals.length}Í∞ú</span>
                                    </div>
                                </div>
                            </div>

                            <div class="goal-modal-footer">
                                <button onclick="closeCalendarDetail()" class="btn btn-primary" style="width: 100%;">
                                    Îã´Í∏∞
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            } catch (error) {
                console.error('Failed to show calendar detail:', error);
                alert('ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        };

        window.closeCalendarDetail = () => {
            const modal = document.getElementById('calendar-detail-modal');
            if (modal) modal.remove();
        };
        
        // Ïª§ÎÆ§ÎãàÌã∞
        const loadCommunityMessages = () => {
            db.collection('artifacts').doc(appId).collection('public').doc('data')
                .collection('community_posts').orderBy('createdAt', 'desc').limit(50)
                .onSnapshot(snapshot => {
                    const container = document.getElementById('chat-messages');
                    const messages = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).reverse();
                    
                    container.innerHTML = messages.map(msg => {
                        const isMe = msg.uid === currentUser.uid;
                        return `
                            <div class="chat-message ${isMe ? 'mine' : ''}">
                                ${!isMe ? `<div class="message-author">${msg.author || 'ÏùµÎ™Ö'}</div>` : ''}
                                <div class="message-bubble">${msg.text}</div>
                            </div>
                        `;
                    }).join('');
                    
                    container.scrollTop = container.scrollHeight;
                });
        };
        
        window.sendMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            await db.collection('artifacts').doc(appId).collection('public').doc('data')
                .collection('community_posts').add({
                    text,
                    author: currentProfile.name,
                    uid: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            
            input.value = '';
        };
        
        // 3Í∞úÏõî Î¶¨Ìè¨Ìä∏
        const checkThreeMonthReport = async () => {
            if (!currentProfile.joinedAt) return;

            const joinDate = new Date(currentProfile.joinedAt);
            const now = new Date();
            const monthsDiff = (now.getFullYear() - joinDate.getFullYear()) * 12 + (now.getMonth() - joinDate.getMonth());

            const reportDoc = await db.collection('artifacts').doc(appId).collection('users')
                .doc(currentUser.uid).collection('reports').doc('3month').get();

            if (monthsDiff >= 3 && !reportDoc.exists && !showingReport) {
                setTimeout(() => {
                    generateThreeMonthReport();
                }, 2000);
            }
        };

        const generateThreeMonthReport = async () => {
            showingReport = true;

            const logsSnapshot = await db.collection('artifacts').doc(appId).collection('users')
                .doc(currentUser.uid).collection('logs').get();

            const logs = logsSnapshot.docs.map(d => d.data());

            const totalDays = logs.length;
            const completedMissions = logs.filter(l => l.checks && Object.values(l.checks).some(v => v)).length;
            const totalWater = logs.reduce((sum, l) => sum + (l.water || 0), 0);
            const avgWater = totalDays > 0 ? (totalWater / totalDays / 250).toFixed(1) : 0;
            const diaryDays = logs.filter(l => l.diary && l.diary.trim()).length;

            const weightLogs = logs.filter(l => l.weight).sort((a, b) => a.date.localeCompare(b.date));
            const startWeight = weightLogs[0]?.weight || currentProfile.startWeight;
            const currentWeight = weightLogs[weightLogs.length - 1]?.weight || currentProfile.currentWeight;
            const weightChange = (startWeight - currentWeight).toFixed(1);

            const photosSnapshot = await db.collection('artifacts').doc(appId).collection('users')
                .doc(currentUser.uid).collection('photos')
                .where('type', '==', 'body')
                .orderBy('timestamp', 'asc')
                .get();

            const photos = photosSnapshot.docs.map(d => d.data());
            const firstPhoto = photos[0];
            const lastPhoto = photos[photos.length - 1];

            // Î™©Ìëú ÌÜµÍ≥Ñ (ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÌôïÏù∏)
            let goalStats = null;
            const migrated = await hasMigratedToGoals();
            if (migrated) {
                try {
                    // Î™®Îì† Î™©Ìëú ÏôÑÎ£å Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                    const completionsSnapshot = await db.collection('artifacts').doc(appId)
                        .collection('users').doc(currentUser.uid)
                        .collection('goal_completions')
                        .get();

                    const completions = completionsSnapshot.docs.map(d => d.data());

                    // ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
                    const totalGoalCompletions = completions.filter(c => c.status === 'completed').length;
                    const uniqueDaysWithGoals = new Set(completions.map(c => c.date)).size;

                    // ÏôÑÎ≤ΩÌïú ÎÇ† Í≥ÑÏÇ∞ (Î™®Îì† Î™©ÌëúÎ•º ÏôÑÎ£åÌïú ÎÇ†)
                    const goals = await loadGoals();
                    const goalCount = goals.length;

                    const completionsByDate = {};
                    completions.forEach(c => {
                        if (!completionsByDate[c.date]) {
                            completionsByDate[c.date] = { completed: 0, total: 0 };
                        }
                        if (c.status === 'completed') {
                            completionsByDate[c.date].completed++;
                        }
                        completionsByDate[c.date].total++;
                    });

                    const perfectDays = Object.values(completionsByDate).filter(d =>
                        d.completed === goalCount && goalCount > 0
                    ).length;

                    // ÏµúÏû• Ïó∞ÏÜç Îã¨ÏÑ± ÏùºÏàò
                    const sortedDates = Object.keys(completionsByDate).sort();
                    let maxStreak = 0;
                    let currentStreak = 0;

                    sortedDates.forEach((date, index) => {
                        const data = completionsByDate[date];
                        if (data.completed === goalCount && goalCount > 0) {
                            currentStreak++;
                            maxStreak = Math.max(maxStreak, currentStreak);
                        } else {
                            currentStreak = 0;
                        }
                    });

                    goalStats = {
                        totalGoalCompletions,
                        uniqueDaysWithGoals,
                        perfectDays,
                        maxStreak
                    };
                } catch (error) {
                    console.error('Failed to calculate goal stats:', error);
                }
            }

            const achievements = [];
            if (weightChange > 0) achievements.push(`${weightChange}kg Í∞êÎüâ ÏÑ±Í≥µ`);
            if (completedMissions > 50) achievements.push('50Ïùº Ïù¥ÏÉÅ ÎØ∏ÏÖò ÏôÑÎ£å');
            if (diaryDays > 50) achievements.push('50Ïùº Ïù¥ÏÉÅ ÏùºÍ∏∞ ÏûëÏÑ±');
            if (avgWater >= 6) achievements.push('Î¨º ÏÑ≠Ï∑® Î™©Ìëú Îã¨ÏÑ±');

            // Î™©Ìëú Í¥ÄÎ†® ÏóÖÏ†Å Ï∂îÍ∞Ä
            if (goalStats) {
                if (goalStats.totalGoalCompletions >= 100) achievements.push('Î™©Ìëú 100Ìöå Îã¨ÏÑ±');
                if (goalStats.perfectDays >= 30) achievements.push('ÏôÑÎ≤ΩÌïú ÌïòÎ£® 30Ïùº Îã¨ÏÑ±');
                if (goalStats.maxStreak >= 7) achievements.push(`${goalStats.maxStreak}Ïùº Ïó∞ÏÜç Î™©Ìëú Îã¨ÏÑ±`);
            }

            await db.collection('artifacts').doc(appId).collection('users')
                .doc(currentUser.uid).collection('reports').doc('3month').set({
                    generatedAt: new Date().toISOString(),
                    stats: {
                        totalDays,
                        completedMissions,
                        diaryDays,
                        avgWater,
                        startWeight,
                        currentWeight,
                        weightChange,
                        ...(goalStats || {})
                    },
                    achievements
                });

            showReport({
                totalDays,
                completedMissions,
                diaryDays,
                avgWater,
                startWeight,
                currentWeight,
                weightChange,
                firstPhoto,
                lastPhoto,
                achievements,
                goalStats
            });
        };

        const showReport = (data) => {
            const app = document.getElementById('app');
            const reportHTML = `
                <div class="report-container">
                    <div class="report-header">
                        <h1>üéâ Ï∂ïÌïòÌï©ÎãàÎã§!</h1>
                        <p>3Í∞úÏõîÍ∞ÑÏùò Ïó¨Ï†ïÏùÑ ÎèåÏïÑÎ¥êÏöî</p>
                    </div>

                    <div class="report-card">
                        <h3>üìä ÎÇòÏùò Í∏∞Î°ù</h3>
                        <div class="report-stats">
                            <div class="report-stat">
                                <div class="report-stat-value">${data.totalDays}</div>
                                <div class="report-stat-label">ÌôúÎèô ÏùºÏàò</div>
                            </div>
                            <div class="report-stat">
                                <div class="report-stat-value">${data.completedMissions}</div>
                                <div class="report-stat-label">ÎØ∏ÏÖò ÏôÑÎ£å</div>
                            </div>
                            <div class="report-stat">
                                <div class="report-stat-value">${data.diaryDays}</div>
                                <div class="report-stat-label">ÏùºÍ∏∞ ÏûëÏÑ±</div>
                            </div>
                            <div class="report-stat">
                                <div class="report-stat-value">${data.avgWater}</div>
                                <div class="report-stat-label">ÌèâÍ∑† Î¨º (Ïûî)</div>
                            </div>
                        </div>
                    </div>

                    <div class="report-card">
                        <h3>‚öñÔ∏è Ï≤¥Ï§ë Î≥ÄÌôî</h3>
                        <div class="report-stats">
                            <div class="report-stat">
                                <div class="report-stat-value">${data.startWeight}kg</div>
                                <div class="report-stat-label">ÏãúÏûë Ï≤¥Ï§ë</div>
                            </div>
                            <div class="report-stat">
                                <div class="report-stat-value">${data.currentWeight}kg</div>
                                <div class="report-stat-label">ÌòÑÏû¨ Ï≤¥Ï§ë</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px; font-size: 1.5rem; font-weight: bold; color: #667eea;">
                            ${data.weightChange > 0 ? '-' : '+'}${Math.abs(data.weightChange)}kg ${data.weightChange > 0 ? 'Í∞êÎüâ! üéâ' : 'Ï¶ùÍ∞Ä'}
                        </div>
                    </div>

                    ${data.goalStats ? `
                    <div class="report-card">
                        <h3>üéØ Î™©Ìëú Îã¨ÏÑ± ÌòÑÌô©</h3>
                        <div class="report-stats">
                            <div class="report-stat">
                                <div class="report-stat-value">${data.goalStats.totalGoalCompletions}</div>
                                <div class="report-stat-label">Ï¥ù Î™©Ìëú Îã¨ÏÑ±</div>
                            </div>
                            <div class="report-stat">
                                <div class="report-stat-value">${data.goalStats.perfectDays}</div>
                                <div class="report-stat-label">ÏôÑÎ≤ΩÌïú ÌïòÎ£®</div>
                            </div>
                            <div class="report-stat">
                                <div class="report-stat-value">${data.goalStats.uniqueDaysWithGoals}</div>
                                <div class="report-stat-label">Î™©Ìëú Ïã§ÌñâÏùº</div>
                            </div>
                            <div class="report-stat">
                                <div class="report-stat-value">${data.goalStats.maxStreak}</div>
                                <div class="report-stat-label">ÏµúÏû• Ïó∞ÏÜç (Ïùº)</div>
                            </div>
                        </div>
                        ${data.goalStats.maxStreak >= 7 ? `
                            <div style="text-align: center; margin-top: 15px; font-size: 1.2rem; font-weight: bold; color: #4caf50;">
                                üî• ${data.goalStats.maxStreak}Ïùº Ïó∞ÏÜç Îã¨ÏÑ± Í∏∞Î°ù!
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    ${data.firstPhoto && data.lastPhoto ? `
                    <div class="report-card">
                        <h3>üì∏ ÎààÎ∞îÎîî ÎπÑÍµê</h3>
                        <div class="report-comparison">
                            <div class="report-comparison-item">
                                <div class="report-comparison-img">
                                    <img src="${data.firstPhoto.url}" alt="Before">
                                </div>
                                <div style="font-weight: bold;">Before</div>
                                <div style="font-size: 0.9rem; color: #666;">${data.firstPhoto.date}</div>
                            </div>
                            <div class="report-comparison-item">
                                <div class="report-comparison-img">
                                    <img src="${data.lastPhoto.url}" alt="After">
                                </div>
                                <div style="font-weight: bold;">After</div>
                                <div style="font-size: 0.9rem; color: #666;">${data.lastPhoto.date}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <div class="report-card">
                        <h3>üèÜ Îã¨ÏÑ±Ìïú ÏóÖÏ†Å</h3>
                        <div style="text-align: center;">
                            ${data.achievements.length > 0
                                ? data.achievements.map(a => `<div class="report-badge">${a}</div>`).join('')
                                : '<p style="color: #666;">Íæ∏Ï§ÄÌûà Í∏∞Î°ùÏùÑ ÎÇ®Í∏∞Î©¥ ÏóÖÏ†ÅÏùÑ Îã¨ÏÑ±Ìï† Ïàò ÏûàÏñ¥Ïöî!</p>'}
                        </div>
                    </div>

                    <div class="report-card" style="text-align: center;">
                        <h3 style="margin-bottom: 10px;">üí™ Í≥ÑÏÜçÌï¥ÏÑú ÌôîÏù¥ÌåÖ!</h3>
                        <p style="color: #666; line-height: 1.6;">
                            ÏßÄÎÇú 3Í∞úÏõîÍ∞Ñ Ï†ïÎßê ÏàòÍ≥† ÎßéÏúºÏÖ®Ïñ¥Ïöî!<br>
                            ÏïûÏúºÎ°úÎèÑ Íæ∏Ï§ÄÌûà Ìï®Íªò Ìï¥Ïöî! üíñ
                        </p>
                    </div>

                    <button class="report-close-btn" onclick="closeReport()">ÌôïÏù∏</button>
                </div>
            `;

            app.innerHTML = reportHTML;
        };

        window.closeReport = () => {
            showingReport = false;
            currentView = 'dashboard';
            render();
        };

        // Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ Î∞è Î≥µÏõê
        window.exportData = async () => {
            if (!confirm('Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º JSON ÌååÏùºÎ°ú ÎÇ¥Î≥¥ÎÇ¥ÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }

            try {
                // Î°úÎî© ÌëúÏãú
                const loadingMsg = document.createElement('div');
                loadingMsg.id = 'export-loading';
                loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 10000; text-align: center;';
                loadingMsg.innerHTML = '<div style="font-size: 24px; margin-bottom: 10px;">üì¶</div><div>Îç∞Ïù¥ÌÑ∞Î•º ÎÇ¥Î≥¥ÎÇ¥Îäî Ï§ë...</div>';
                document.body.appendChild(loadingMsg);

                // Î™®Îì† Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
                const [profileDoc, logsSnapshot, photosSnapshot, goalsSnapshot, completionsSnapshot, reportsSnapshot] = await Promise.all([
                    db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('profile').doc('main').get(),
                    db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('logs').get(),
                    db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('photos').get(),
                    db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('goals').get(),
                    db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('goal_completions').get(),
                    db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('reports').get()
                ]);

                const exportData = {
                    version: '2.0',
                    appId: 'diet-mate-v2',
                    exportDate: new Date().toISOString(),
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    profile: profileDoc.exists ? profileDoc.data() : null,
                    logs: logsSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
                    photos: photosSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
                    goals: goalsSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
                    goalCompletions: completionsSnapshot.docs.map(d => ({ id: d.id, ...d.data() })),
                    reports: reportsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                };

                // JSON ÌååÏùº ÏÉùÏÑ± Î∞è Îã§Ïö¥Î°úÎìú
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `diet-mate-backup-${getTodayString()}.json`;
                a.click();
                URL.revokeObjectURL(url);

                document.getElementById('export-loading').remove();
                alert('‚úÖ Î∞±ÏóÖ ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§!');
            } catch (error) {
                console.error('Export failed:', error);
                const loading = document.getElementById('export-loading');
                if (loading) loading.remove();
                alert('Î∞±ÏóÖ Ïã§Ìå®: ' + error.message);
            }
        };

        window.importData = async () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                    if (!data.version || !data.profile || data.appId !== 'diet-mate-v2') {
                        alert('Ïò¨Î∞îÎ•∏ Diet Mate Î∞±ÏóÖ ÌååÏùºÏù¥ ÏïÑÎãôÎãàÎã§.');
                        return;
                    }

                    if (!confirm('‚ö†Ô∏è Í≤ΩÍ≥†: ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Î•º Î™®Îëê ÏÇ≠Ï†úÌïòÍ≥† Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞Î°ú Î≥µÏõêÌï©ÎãàÎã§. Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        return;
                    }

                    // Î°úÎî© ÌëúÏãú
                    const loadingMsg = document.createElement('div');
                    loadingMsg.id = 'import-loading';
                    loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 10000; text-align: center;';
                    loadingMsg.innerHTML = '<div style="font-size: 24px; margin-bottom: 10px;">üì•</div><div>Îç∞Ïù¥ÌÑ∞Î•º Î≥µÏõêÌïòÎäî Ï§ë...</div>';
                    document.body.appendChild(loadingMsg);

                    // ÌîÑÎ°úÌïÑ Î≥µÏõê
                    if (data.profile) {
                        await db.collection('artifacts').doc(appId)
                            .collection('users').doc(currentUser.uid)
                            .collection('profile').doc('main')
                            .set(data.profile);
                    }

                    // Î°úÍ∑∏ Î≥µÏõê
                    if (data.logs && data.logs.length > 0) {
                        for (const log of data.logs) {
                            const { id, ...logData } = log;
                            await db.collection('artifacts').doc(appId)
                                .collection('users').doc(currentUser.uid)
                                .collection('logs').doc(id || log.date)
                                .set(logData);
                        }
                    }

                    // ÏÇ¨ÏßÑ Î≥µÏõê
                    if (data.photos && data.photos.length > 0) {
                        for (const photo of data.photos) {
                            const { id, ...photoData } = photo;
                            await db.collection('artifacts').doc(appId)
                                .collection('users').doc(currentUser.uid)
                                .collection('photos').doc(id)
                                .set(photoData);
                        }
                    }

                    // Î™©Ìëú Î≥µÏõê
                    if (data.goals && data.goals.length > 0) {
                        for (const goal of data.goals) {
                            const { id, ...goalData } = goal;
                            await db.collection('artifacts').doc(appId)
                                .collection('users').doc(currentUser.uid)
                                .collection('goals').doc(id)
                                .set(goalData);
                        }
                    }

                    // Î™©Ìëú ÏôÑÎ£å Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
                    if (data.goalCompletions && data.goalCompletions.length > 0) {
                        for (const completion of data.goalCompletions) {
                            const { id, ...completionData } = completion;
                            await db.collection('artifacts').doc(appId)
                                .collection('users').doc(currentUser.uid)
                                .collection('goal_completions').doc(id)
                                .set(completionData);
                        }
                    }

                    // Î¶¨Ìè¨Ìä∏ Î≥µÏõê
                    if (data.reports && data.reports.length > 0) {
                        for (const report of data.reports) {
                            const { id, ...reportData } = report;
                            await db.collection('artifacts').doc(appId)
                                .collection('users').doc(currentUser.uid)
                                .collection('reports').doc(id)
                                .set(reportData);
                        }
                    }

                    document.getElementById('import-loading').remove();
                    alert('‚úÖ Îç∞Ïù¥ÌÑ∞ Î≥µÏõê ÏôÑÎ£å! ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.');
                    location.reload();
                } catch (error) {
                    console.error('Import failed:', error);
                    const loading = document.getElementById('import-loading');
                    if (loading) loading.remove();
                    alert('Î≥µÏõê Ïã§Ìå®: ' + error.message);
                }
            };
            input.click();
        };

        // Î°úÍ∑∏ÏïÑÏõÉ
        window.handleLogout = async () => {
            if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                await auth.signOut();
            }
        };
        
        // Ïù∏Ï¶ù ÏÉÅÌÉú Î≥ÄÌôî Í∞êÏßÄ
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            
            if (user) {
                const profileDoc = await db.collection('artifacts').doc(appId).collection('users')
                    .doc(user.uid).collection('profile').doc('main').get();
                
                if (profileDoc.exists) {
                    currentProfile = profileDoc.data();
                    currentView = 'dashboard';
                } else {
                    currentView = 'onboarding';
                }
            } else {
                currentView = 'landing';
            }
            
            render();
        });
    </script>
</body>
</html>
