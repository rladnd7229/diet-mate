<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="AI 코치와 함께하는 스마트 다이어트 관리 앱">

    <title>Diet Mate v2.5 - 스마트 다이어트 매니저</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <style>
        /* ==================== 기본 스타일 ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* ==================== 랜딩 페이지 ==================== */
        .landing {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 20px;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .landing-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .landing-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .landing-subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            margin-bottom: 50px;
            text-align: center;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: white;
            color: #667eea;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        /* ==================== 인증 페이지 ==================== */
        .auth-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            background: white;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-logo-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 25px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .auth-title {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #666;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .error-message {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .link-text {
            text-align: center;
            margin-top: 20px;
            color: #667eea;
            cursor: pointer;
            font-weight: bold;
        }

        /* ==================== 대시보드 ==================== */
        .dashboard {
            min-height: 100vh;
            padding-bottom: 80px;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .header-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .card:active {
            transform: scale(0.98);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #333;
        }

        /* ==================== 하단 네비게이션 (8개 탭) ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            overflow-x: auto;
            padding: 12px 0;
            border-top: 1px solid #e0e0e0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            -webkit-overflow-scrolling: touch;
        }

        .bottom-nav::-webkit-scrollbar {
            height: 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
            padding: 5px 15px;
            min-width: 70px;
            flex-shrink: 0;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 0.7rem;
            font-weight: bold;
            white-space: nowrap;
        }

        /* ==================== 탭 컨텐츠 ==================== */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== 홈 탭: 건강 지표 ==================== */
        .health-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .metric-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .metric-unit {
            font-size: 0.9rem;
            color: #999;
        }

        .progress-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .progress-bar-container {
            background: rgba(255,255,255,0.3);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: white;
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* ==================== 홈 탭: AI 채팅 ==================== */
        .ai-chat-section {
            background: white;
            border-radius: 20px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .ai-chat-summary {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-summary:hover {
            background: #f8f9fa;
            border-radius: 20px;
        }

        .ai-chat-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .ai-chat-details.open {
            max-height: 500px;
        }

        .ai-chat-messages {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            border-top: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
        }

        .ai-message {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 12px;
            animation: slideIn 0.3s;
        }

        .ai-message.user {
            background: #667eea;
            color: white;
            margin-left: 20%;
        }

        .ai-message.assistant {
            background: #f5f5f5;
            color: #333;
            margin-right: 20%;
        }

        .ai-chat-input-area {
            padding: 15px;
            display: flex;
            gap: 10px;
        }

        .ai-chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
        }

        .ai-chat-send {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== 홈 탭: 스마트 물 마시기 ==================== */
        .water-settings {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .water-settings input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }

        .water-tracker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
        }

        .water-cup {
            aspect-ratio: 1;
            background: #e3f2fd;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .water-cup.filled {
            background: #2196f3;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        /* ==================== 홈 탭: 영양 대시보드 ==================== */
        .nutrition-summary {
            text-align: center;
            font-size: 1rem;
            color: #666;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .nutrition-summary span {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .nutrition-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .nutrition-card:hover {
            transform: translateY(-3px);
        }

        .nutrition-calories {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .nutrition-carbs {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .nutrition-protein {
            background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%);
        }

        .nutrition-fat {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        .nutrition-label {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .nutrition-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .nutrition-unit {
            font-size: 0.85rem;
            color: #666;
        }

        .nutrition-chart-container {
            max-width: 300px;
            margin: 0 auto;
            padding: 20px 0;
        }

        /* ==================== 플랜 탭 ==================== */
        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .plan-date {
            font-size: 1.1rem;
            font-weight: bold;
            color: #667eea;
        }

        .btn-add-plan {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        .plan-item {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .plan-time {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
            min-width: 70px;
        }

        .plan-content {
            flex: 1;
        }

        .plan-category {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
        }

        .plan-activity {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .plan-value {
            font-size: 0.9rem;
            color: #666;
        }

        .plan-delete {
            color: #f44336;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* ==================== 단식 탭 ==================== */
        .fasting-timer-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .fasting-svg-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 20px auto;
        }

        .fasting-circle-bg {
            fill: none;
            stroke: rgba(255,255,255,0.2);
            stroke-width: 15;
        }

        .fasting-circle-progress {
            fill: none;
            stroke: white;
            stroke-width: 15;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 1s linear;
        }

        .fasting-time-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .fasting-time-main {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .fasting-time-sub {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .fasting-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .fasting-btn {
            padding: 12px 30px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .fasting-btn:hover {
            background: white;
            color: #667eea;
        }

        .fasting-duration-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .fasting-duration-input input {
            width: 80px;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid white;
            background: rgba(255,255,255,0.9);
            text-align: center;
            font-weight: bold;
        }

        .fasting-info {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .fasting-info details {
            margin-bottom: 15px;
        }

        .fasting-info summary {
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .fasting-info details[open] summary {
            background: #667eea;
            color: white;
        }

        /* ==================== 앨범 탭 ==================== */
        .album-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .album-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .album-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .photo-item {
            aspect-ratio: 1;
            background: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-date-label {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 8px;
            font-size: 0.7rem;
            text-align: center;
        }

        .add-photo {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #999;
            border: 2px dashed #ddd;
            background: #fafafa;
        }

        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .photo-modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: white;
        }

        .photo-modal-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-modal-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 15px;
        }

        .photo-modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .photo-modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== 앨범 탭: 텍스트 카드 ==================== */
        .text-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 150px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .text-card:hover {
            transform: translateY(-3px);
        }

        .text-card-emoji {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .text-card-content {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            max-height: 60px;
            overflow: hidden;
            line-height: 1.4;
        }

        .text-card-nutrition {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #555;
            font-weight: 500;
        }

        .text-card.category-body {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .text-card.category-food {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .text-card.category-exercise {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        /* ==================== 앨범 탭: 배치 작업 (Phase 4) ==================== */
        .album-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .album-header .card-title {
            margin: 0;
        }

        .select-mode-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .select-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .select-mode-btn.active {
            background: #ff5252;
        }

        .select-action-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .select-action-bar.hidden {
            display: none;
        }

        .selected-count {
            font-weight: bold;
            font-size: 1rem;
        }

        .select-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.85rem;
            background: white;
            color: #667eea;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .cancel-btn {
            background: #ff5252;
            color: white;
        }

        /* 선택 모드: 체크박스 오버레이 */
        .select-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            cursor: pointer;
            transition: all 0.3s;
        }

        .select-checkbox.checked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .select-checkbox.checked::after {
            content: '✓';
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        /* 선택된 항목 강조 */
        .photo-item.selected {
            outline: 3px solid #667eea;
            outline-offset: -3px;
            opacity: 0.8;
        }

        /* ==================== 캘린더 탭 ==================== */
        .calendar {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
        }

        .calendar-month {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-label {
            text-align: center;
            font-weight: bold;
            color: #666;
            padding: 10px 0;
            font-size: 0.9rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 0.9rem;
        }

        .calendar-day.today {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .calendar-day.has-data {
            border: 2px solid #4caf50;
        }

        .calendar-day.future {
            opacity: 0.4;
            cursor: default;
        }

        .calendar-day::after {
            content: '';
            position: absolute;
            bottom: 3px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #4caf50;
            display: none;
        }

        .calendar-day.has-data::after {
            display: block;
        }

        .day-report-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .day-report-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .day-report-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #667eea;
        }

        .day-report-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .day-report-section:last-child {
            border-bottom: none;
        }

        .day-report-section h4 {
            margin-bottom: 10px;
            color: #333;
        }

        /* ==================== 소통 탭 ==================== */
        .chat-container {
            height: calc(100vh - 350px);
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            max-width: 80%;
            animation: slideIn 0.3s;
        }

        .chat-message.mine {
            margin-left: auto;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8rem;
            color: #666;
        }

        .message-author {
            font-weight: bold;
        }

        .message-time {
            color: #999;
        }

        .message-bubble {
            padding: 12px 15px;
            border-radius: 15px;
            background: #f5f5f5;
        }

        .chat-message.mine .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-input-container {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
        }

        .send-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== AI 토스트 팝업 ==================== */
        .ai-toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            max-width: 90%;
            width: 350px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideUp 0.4s ease-out;
        }

        .ai-toast.hidden {
            bottom: -200px;
            opacity: 0;
            pointer-events: none;
        }

        .ai-toast-content {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .ai-toast-icon {
            font-size: 2.5rem;
            animation: bounce 1s infinite;
        }

        .ai-toast-message {
            flex: 1;
            font-size: 1rem;
            line-height: 1.4;
            font-weight: 500;
        }

        .ai-toast-button {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-toast-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        @keyframes slideUp {
            from {
                bottom: -200px;
                opacity: 0;
            }
            to {
                bottom: 80px;
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        /* ==================== 스마트 병합 Bottom Sheet ==================== */
        .merge-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: flex-end;
            transition: opacity 0.3s;
        }

        .merge-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .merge-sheet {
            background: white;
            width: 100%;
            max-height: 70vh;
            border-radius: 25px 25px 0 0;
            padding: 30px 20px 20px;
            transform: translateY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.2);
        }

        .merge-overlay.hidden .merge-sheet {
            transform: translateY(100%);
        }

        .merge-header h3 {
            margin: 0 0 5px 0;
            font-size: 1.3rem;
            color: #333;
        }

        .merge-subtitle {
            margin: 0 0 20px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .merge-content {
            margin-bottom: 25px;
        }

        .merge-preview {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin-bottom: 20px;
            gap: 15px;
        }

        .merge-meal {
            flex: 1;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
        }

        .previous-meal {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .current-meal {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .meal-label {
            font-size: 0.75rem;
            color: #555;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .meal-name {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .meal-calories {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: bold;
        }

        .merge-plus {
            font-size: 1.5rem;
            color: #667eea;
            font-weight: bold;
        }

        .merge-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .total-calories {
            color: #667eea;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .merge-actions {
            display: flex;
            gap: 12px;
        }

        .merge-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .merge-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .merge-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .merge-cancel {
            background: #f0f0f0;
            color: #666;
        }

        .merge-cancel:hover {
            background: #e0e0e0;
        }

        /* ==================== Phase 4: 카테고리 변경 모달 ==================== */
        .category-change-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.3s;
        }

        .category-change-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .category-change-modal {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transform: scale(1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .category-change-overlay.hidden .category-change-modal {
            transform: scale(0.9);
        }

        .category-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: #333;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .modal-close-btn:hover {
            color: #333;
        }

        .category-modal-description {
            color: #666;
            font-size: 0.95rem;
            margin: 0 0 20px 0;
        }

        .category-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .category-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .category-option:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .category-option.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .category-option.active .category-emoji {
            filter: brightness(1.2);
        }

        .category-emoji {
            font-size: 1.8rem;
        }

        .category-name {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .category-option.active .category-name {
            color: white;
        }

        /* ==================== Phase 4: 수동 병합 모달 ==================== */
        .manual-merge-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: flex-end;
            transition: opacity 0.3s;
        }

        .manual-merge-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .manual-merge-sheet {
            background: white;
            width: 100%;
            max-height: 70vh;
            border-radius: 25px 25px 0 0;
            padding: 25px 20px 20px;
            transform: translateY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .manual-merge-overlay.hidden .manual-merge-sheet {
            transform: translateY(100%);
        }

        .manual-merge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .manual-merge-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: #333;
        }

        .manual-merge-description {
            color: #666;
            font-size: 0.9rem;
            margin: 0 0 15px 0;
        }

        .meal-list {
            overflow-y: auto;
            flex: 1;
            margin: 0 -20px;
            padding: 0 20px;
        }

        .meal-list-loading {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .meal-list-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .meal-list-item:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateX(3px);
        }

        .meal-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .meal-item-date {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .meal-item-time {
            font-size: 0.8rem;
            color: #999;
        }

        .meal-item-name {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .meal-item-calories {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: bold;
        }

        .meal-list-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        /* ==================== 알림 탭 ==================== */
        .notification-list {
            margin-top: 15px;
        }

        .notification-item {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .notification-details {
            font-size: 0.85rem;
            color: #666;
        }

        .notification-delete {
            color: #f44336;
            cursor: pointer;
            font-size: 1.3rem;
        }

        /* ==================== 누적 단식 통계 ==================== */
        .fasting-stats {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea20, #764ba220);
            border-radius: 15px;
        }

        .accumulated-time {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 15px 0;
        }

        .fasting-sessions {
            margin-top: 20px;
        }

        .fasting-session-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* ==================== 설정 탭 ==================== */
        .profile-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .profile-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .profile-info p {
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 15px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .settings-item {
            padding: 20px;
            background: white;
            border-radius: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .logout-btn {
            background: #ff5252;
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
        }

        /* ==================== PWA 설치 배너 ==================== */
        .pwa-install-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .pwa-install-text {
            flex: 1;
        }

        .pwa-install-text strong {
            display: block;
            margin-bottom: 5px;
        }

        .pwa-install-btn {
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== 모달 공통 스타일 ==================== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #667eea;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-btn-primary {
            background: #667eea;
            color: white;
        }

        .modal-btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        /* ==================== 차트 컨테이너 ==================== */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 10px;
        }

        /* ==================== 반응형 ==================== */
        @media (max-width: 360px) {
            .landing-title {
                font-size: 2.5rem;
            }

            .landing-subtitle {
                font-size: 1.1rem;
            }

            .health-metrics {
                grid-template-columns: repeat(2, 1fr);
            }

            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- 랜딩 페이지 -->
    <div id="landing" class="landing">
        <div class="landing-logo">💪</div>
        <h1 class="landing-title">Diet Mate</h1>
        <p class="landing-subtitle">AI와 함께하는<br>스마트 다이어트 여정</p>
        <button class="btn btn-primary" onclick="showAuth()">시작하기</button>
    </div>

    <!-- 인증 페이지 -->
    <div id="auth" class="auth-container hidden">
        <div class="auth-logo">
            <div class="auth-logo-icon">💪</div>
        </div>

        <h2 class="auth-title" id="authTitle">로그인</h2>

        <div class="error-message" id="authError"></div>
        <div class="success-message" id="authSuccess"></div>

        <form id="authForm">
            <div class="form-group">
                <label class="form-label">이메일</label>
                <input type="email" class="form-input" id="email" required>
            </div>

            <div class="form-group">
                <label class="form-label">비밀번호</label>
                <input type="password" class="form-input" id="password" required>
            </div>

            <div class="form-group" id="signupFields" style="display: none;">
                <label class="form-label">이름</label>
                <input type="text" class="form-input" id="displayName">

                <label class="form-label" style="margin-top: 15px;">목표 체중 (kg)</label>
                <input type="number" class="form-input" id="goalWeight" step="0.1">

                <label class="form-label" style="margin-top: 15px;">시작 체중 (kg)</label>
                <input type="number" class="form-input" id="startWeight" step="0.1">
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                <span id="authButtonText">로그인</span>
            </button>
        </form>

        <p class="link-text" onclick="toggleAuthMode()">
            <span id="authToggleText">계정이 없으신가요? 회원가입</span>
        </p>
    </div>

    <!-- 대시보드 -->
    <div id="dashboard" class="dashboard hidden">
        <div class="header">
            <h1 class="header-title">Diet Mate</h1>
            <p class="header-subtitle" id="headerSubtitle">안녕하세요!</p>
        </div>

        <div class="content">
            <!-- 홈 탭 -->
            <div id="tab-home" class="tab-content active">
                <div class="health-metrics">
                    <div class="metric-card">
                        <div class="metric-label">시작 체중</div>
                        <div class="metric-value" id="startWeightDisplay">0</div>
                        <div class="metric-unit">kg</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">현재 체중</div>
                        <div class="metric-value" id="currentWeightDisplay">0</div>
                        <div class="metric-unit">kg</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">목표 체중</div>
                        <div class="metric-value" id="goalWeightDisplay">0</div>
                        <div class="metric-unit">kg</div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-header">
                        <span>목표 달성률</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="progress-stats">
                        <span id="weightLost">감량: 0kg</span>
                        <span id="weightRemaining">남은 감량: 0kg</span>
                    </div>
                </div>

                <!-- 영양 대시보드 -->
                <div class="card">
                    <h3 class="card-title">🍽️ 오늘의 영양 섭취</h3>
                    <div class="nutrition-summary">
                        <span id="todayMealCount">0</span>회 식사
                    </div>
                    <div class="nutrition-grid">
                        <div class="nutrition-card nutrition-calories">
                            <div class="nutrition-label">칼로리</div>
                            <div class="nutrition-value" id="todayCalories">0</div>
                            <div class="nutrition-unit">kcal</div>
                        </div>
                        <div class="nutrition-card nutrition-carbs">
                            <div class="nutrition-label">탄수화물</div>
                            <div class="nutrition-value" id="todayCarbs">0</div>
                            <div class="nutrition-unit">g</div>
                        </div>
                        <div class="nutrition-card nutrition-protein">
                            <div class="nutrition-label">단백질</div>
                            <div class="nutrition-value" id="todayProtein">0</div>
                            <div class="nutrition-unit">g</div>
                        </div>
                        <div class="nutrition-card nutrition-fat">
                            <div class="nutrition-label">지방</div>
                            <div class="nutrition-value" id="todayFat">0</div>
                            <div class="nutrition-unit">g</div>
                        </div>
                    </div>
                    <div class="nutrition-chart-container">
                        <canvas id="nutritionChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">📊 체중 그래프</h3>
                    <div class="chart-container">
                        <canvas id="weightChart"></canvas>
                    </div>
                    <div class="weight-input-group" style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="number" id="weightInput" class="weight-input" placeholder="체중 (kg)" step="0.1">
                        <button class="btn-add-weight" onclick="addWeight()">추가</button>
                    </div>
                </div>

                <div class="ai-chat-section">
                    <div class="ai-chat-summary" onclick="toggleAIChat()">
                        <div>
                            <h3 class="card-title">🤖 AI 코치</h3>
                            <p style="font-size: 0.9rem; color: #666;">클릭하여 채팅하기</p>
                        </div>
                        <span style="font-size: 1.5rem;">▼</span>
                    </div>
                    <div class="ai-chat-details" id="aiChatDetails">
                        <div class="ai-chat-messages" id="aiChatMessages"></div>
                        <div class="ai-chat-input-area">
                            <input type="text" class="ai-chat-input" id="aiChatInput" placeholder="예: 어제랑 비교해줘">
                            <button class="ai-chat-send" onclick="sendAIMessage()">전송</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">💧 스마트 물 마시기</h3>
                    <div class="water-settings">
                        <input type="number" id="cupSize" placeholder="컵 용량 (ml)" value="250">
                        <input type="number" id="waterGoal" placeholder="목표 (L)" value="2" step="0.1">
                        <button class="btn-add-weight" onclick="updateWaterTracker()">설정</button>
                    </div>
                    <div class="water-tracker" id="waterTracker"></div>
                </div>
            </div>

            <!-- 플랜 탭 -->
            <div id="tab-plan" class="tab-content">
                <div class="plan-header">
                    <div class="plan-date" id="planDate">오늘의 플랜</div>
                    <button class="btn-add-plan" onclick="openAddPlanModal()">+ 추가</button>
                </div>
                <button class="btn-add-plan" style="width: 100%; margin-bottom: 15px;" onclick="suggestPlanWithAI()">
                    🤖 AI 플랜 추천받기
                </button>
                <div id="planList"></div>
            </div>

            <!-- 단식 탭 -->
            <div id="tab-fasting" class="tab-content">
                <div class="fasting-timer-card">
                    <h3 style="font-size: 1.5rem; margin-bottom: 20px;">⏱️ 간헐적 단식</h3>

                    <div class="fasting-svg-container">
                        <svg width="250" height="250">
                            <circle class="fasting-circle-bg" cx="125" cy="125" r="110" />
                            <circle class="fasting-circle-progress" id="fastingProgress" cx="125" cy="125" r="110"
                                    stroke-dasharray="691" stroke-dashoffset="691" />
                        </svg>
                        <div class="fasting-time-display">
                            <div class="fasting-time-main" id="fastingTimeMain">00:00:00</div>
                            <div class="fasting-time-sub" id="fastingTimeSub">대기 중</div>
                        </div>
                    </div>

                    <div class="fasting-duration-input" id="fastingDurationInput">
                        <input type="number" id="fastingHours" placeholder="시간" value="16">
                        <span style="align-self: center;">시간</span>
                    </div>

                    <div class="fasting-controls">
                        <button class="fasting-btn" id="fastingStartBtn" onclick="startFasting()">시작</button>
                        <button class="fasting-btn" id="fastingStopBtn" onclick="stopFasting()" style="display: none;">중단</button>
                    </div>
                </div>

                <div class="fasting-info">
                    <details>
                        <summary>단식의 효과</summary>
                        <p style="padding: 10px; line-height: 1.6;">
                            • 체중 감량 및 체지방 감소<br>
                            • 인슐린 민감도 개선<br>
                            • 세포 재생 촉진 (자가포식)<br>
                            • 집중력 향상
                        </p>
                    </details>
                    <details>
                        <summary>주의사항</summary>
                        <p style="padding: 10px; line-height: 1.6;">
                            • 충분한 수분 섭취 필수<br>
                            • 처음엔 짧은 시간부터 시작<br>
                            • 어지러움 느끼면 즉시 중단<br>
                            • 임산부/수유부/질환자는 의사 상담 필요
                        </p>
                    </details>
                </div>

                <!-- 누적 단식 통계 -->
                <div class="fasting-stats">
                    <h4 style="font-size: 1.2rem; margin-bottom: 15px;">📊 오늘의 누적 단식 시간</h4>
                    <div class="accumulated-time" id="accumulatedTime">0시간 0분</div>
                    <div class="fasting-sessions" id="fastingSessions">
                        <!-- 세션 목록 자동 표시 -->
                    </div>
                </div>
            </div>

            <!-- 앨범 탭 -->
            <div id="tab-album" class="tab-content">
                <div class="card">
                    <!-- 앨범 헤더 -->
                    <div class="album-header">
                        <h3 class="card-title">📸 나의 변화 앨범</h3>
                        <button class="select-mode-btn" id="selectModeBtn" onclick="toggleSelectMode()">선택</button>
                    </div>

                    <!-- 선택 모드 액션 바 -->
                    <div class="select-action-bar hidden" id="selectActionBar">
                        <div class="selected-count" id="selectedCount">0개 선택됨</div>
                        <div class="select-actions">
                            <button class="action-btn download-btn" onclick="downloadSelectedItems()">📥 다운로드</button>
                            <button class="action-btn share-btn" onclick="shareSelectedItems()">📤 공유</button>
                            <button class="action-btn cancel-btn" onclick="cancelSelectMode()">취소</button>
                        </div>
                    </div>

                    <div class="album-tabs">
                        <button class="album-tab active" onclick="changeAlbumTab('all')">전체</button>
                        <button class="album-tab" onclick="changeAlbumTab('body')">눈바디</button>
                        <button class="album-tab" onclick="changeAlbumTab('food')">식단</button>
                        <button class="album-tab" onclick="changeAlbumTab('exercise')">운동</button>
                    </div>
                    <div class="photo-grid" id="photoGrid">
                        <div class="photo-item add-photo" onclick="addPhoto()">+</div>
                    </div>
                </div>
            </div>

            <!-- 캘린더 탭 -->
            <div id="tab-calendar" class="tab-content">
                <div class="calendar">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">◀</button>
                        <div class="calendar-month" id="calendarMonth">2025년 1월</div>
                        <button class="calendar-nav" onclick="changeMonth(1)">▶</button>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-day-label">일</div>
                        <div class="calendar-day-label">월</div>
                        <div class="calendar-day-label">화</div>
                        <div class="calendar-day-label">수</div>
                        <div class="calendar-day-label">목</div>
                        <div class="calendar-day-label">금</div>
                        <div class="calendar-day-label">토</div>
                    </div>
                    <div class="calendar-grid" id="calendarDays"></div>
                </div>
            </div>

            <!-- 소통 탭 -->
            <div id="tab-community" class="tab-content">
                <div class="chat-container" id="chatContainer"></div>
            </div>
            <div class="chat-input-container hidden" id="chatInputContainer">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="communityInput" placeholder="메시지를 입력하세요...">
                    <button class="send-btn" onclick="sendCommunityMessage()">전송</button>
                </div>
            </div>

            <!-- 알림 탭 -->
            <div id="tab-notification" class="tab-content">
                <div class="card">
                    <h3 class="card-title">🔔 알림 관리</h3>
                    <button class="btn-add-plan" style="width: 100%; margin-bottom: 15px;" onclick="openAddNotificationModal()">
                        + 새 알림 추가
                    </button>
                    <div class="notification-list" id="notificationList"></div>
                </div>
            </div>

            <!-- 설정 탭 -->
            <div id="tab-settings" class="tab-content">
                <div class="pwa-install-banner hidden" id="pwaInstallBanner">
                    <div class="pwa-install-text">
                        <strong>앱으로 설치하기</strong>
                        <span style="font-size: 0.9rem;">홈 화면에 추가하고 더 편하게 사용하세요!</span>
                    </div>
                    <button class="pwa-install-btn" onclick="installPWA()">설치</button>
                </div>

                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">💪</div>
                        <div class="profile-info">
                            <h3 id="profileName">사용자</h3>
                            <p id="profileEmail">email@example.com</p>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalDays">0</div>
                            <div class="stat-label">함께한 날</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalExercise">0</div>
                            <div class="stat-label">운동 시간 (분)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalCalories">0</div>
                            <div class="stat-label">절약 칼로리</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="predictedDate">-</div>
                            <div class="stat-label">예상 달성일</div>
                        </div>
                    </div>
                </div>

                <div class="settings-item" onclick="exportData()">
                    <span>📤 데이터 내보내기</span>
                    <span>→</span>
                </div>

                <div class="settings-item" onclick="importData()">
                    <span>📥 데이터 가져오기</span>
                    <span>→</span>
                </div>

                <button class="logout-btn" onclick="logout()">로그아웃</button>
            </div>
        </div>

        <!-- 하단 네비게이션 -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home')">
                <div class="nav-icon">🏠</div>
                <div class="nav-label">홈</div>
            </div>
            <div class="nav-item" onclick="switchTab('plan')">
                <div class="nav-icon">📋</div>
                <div class="nav-label">플랜</div>
            </div>
            <div class="nav-item" onclick="switchTab('fasting')">
                <div class="nav-icon">⏱️</div>
                <div class="nav-label">단식</div>
            </div>
            <div class="nav-item" onclick="switchTab('album')">
                <div class="nav-icon">📸</div>
                <div class="nav-label">앨범</div>
            </div>
            <div class="nav-item" onclick="switchTab('calendar')">
                <div class="nav-icon">📅</div>
                <div class="nav-label">캘린더</div>
            </div>
            <div class="nav-item" onclick="switchTab('community')">
                <div class="nav-icon">💬</div>
                <div class="nav-label">소통</div>
            </div>
            <div class="nav-item" onclick="switchTab('notification')">
                <div class="nav-icon">🔔</div>
                <div class="nav-label">알림</div>
            </div>
            <div class="nav-item" onclick="switchTab('settings')">
                <div class="nav-icon">⚙️</div>
                <div class="nav-label">설정</div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Firebase 초기화 ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDrw00jym_dKATz26qUzsALSqfYeAAkM-I",
            authDomain: "mate-9f45e.firebaseapp.com",
            projectId: "mate-9f45e",
            storageBucket: "mate-9f45e.firebasestorage.app",
            messagingSenderId: "1077932492908",
            appId: "1:1077932492908:web:722c068177e2e715183049"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ==================== 전역 변수 ====================
        let currentUser = null;
        let currentProfile = null;
        let currentTab = 'home';
        let currentAlbumTab = 'all';
        let isSignUp = false;
        let weightChart = null;
        let currentMonth = new Date();
        let fastingInterval = null;
        let fastingState = null;
        let deferredPrompt = null;
        let notificationCheckInterval = null;
        let nutritionChart = null;
        let aiToastTimeout = null;
        let pendingMealData = null;
        let recentMealDocId = null;

        // Phase 4: 배치 작업을 위한 변수
        let isSelectMode = false;
        let selectedItems = new Set();
        let allPhotoItems = []; // 현재 표시된 모든 사진 항목 {docId, url}

        // Phase 4: 카테고리 변경을 위한 변수
        let changingPhotoId = null;
        let changingPhotoCurrentCategory = null;

        // Phase 4: 수동 병합을 위한 변수
        let mergingSourceId = null; // 현재 선택한 식사 (병합될 항목)

        // Gemini API 키 배열 (사용자가 실제 키로 교체해야 함)
        const API_KEYS = [
            'AIzaSyA9pV6incQB-IoNyfStdnmtF5-Lnc7nV2c',
            'YOUR_GEMINI_API_KEY_2',
            'YOUR_GEMINI_API_KEY_3'
        ];
        let currentAPIKeyIndex = 0;

        // LocalStorage 키
        const LS_KEYS = {
            AI_CHAT: 'diet_mate_ai_chat',
            NOTIFICATIONS: 'diet_mate_notifications',
            FASTING: 'diet_mate_fasting',
            PWA_INSTALLED: 'diet_mate_pwa_installed',
            WATER_SETTINGS: 'diet_mate_water_settings'
        };

        // ==================== Gemini API 호출 (로테이션 로직) ====================
        async function callGeminiAPI(prompt, retries = 3) {
            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    const apiKey = API_KEYS[currentAPIKeyIndex];
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{ text: prompt }]
                                }]
                            })
                        }
                    );

                    if (response.status === 429) {
                        // 429 에러 시 조용히 다음 키로 전환
                        currentAPIKeyIndex = (currentAPIKeyIndex + 1) % API_KEYS.length;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;

                } catch (error) {
                    console.error('Gemini API 호출 실패:', error);
                    if (attempt === retries - 1) {
                        return 'AI가 휴식 중이에요. 잠시 후 다시 시도해주세요! 😊';
                    }
                }
            }
        }

        // ==================== AI 영양 분석 함수 ====================

        // 파일을 Base64로 인코딩
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Gemini Vision API 호출
        async function callGeminiVisionAPI(prompt, base64Image, retries = 3) {
            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    const apiKey = API_KEYS[currentAPIKeyIndex];
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: prompt },
                                        {
                                            inline_data: {
                                                mime_type: "image/jpeg",
                                                data: base64Image
                                            }
                                        }
                                    ]
                                }]
                            })
                        }
                    );

                    if (response.status === 429) {
                        // 429 에러 시 조용히 다음 키로 전환
                        currentAPIKeyIndex = (currentAPIKeyIndex + 1) % API_KEYS.length;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;

                } catch (error) {
                    console.error('Gemini Vision API 호출 실패:', error);
                    if (attempt === retries - 1) {
                        throw error;
                    }
                }
            }
        }

        // AI 응답에서 JSON 파싱 (마크다운 코드 블록 제거)
        function parseNutritionResponse(responseText) {
            try {
                // 마크다운 코드 블록 제거
                let jsonText = responseText.trim();
                const codeBlockMatch = jsonText.match(/```json\s*([\s\S]*?)\s*```/);
                if (codeBlockMatch) {
                    jsonText = codeBlockMatch[1];
                }

                const data = JSON.parse(jsonText);

                return {
                    calories: parseFloat(data.calories) || 0,
                    carbs: parseFloat(data.carbs) || 0,
                    protein: parseFloat(data.protein) || 0,
                    fat: parseFloat(data.fat) || 0,
                    foodName: data.foodName || '알 수 없음',
                    advice: data.advice || '균형잡힌 식사를 하세요.'
                };
            } catch (error) {
                console.error('영양 정보 파싱 실패:', error);
                return {
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0,
                    foodName: '알 수 없음',
                    advice: '영양 분석에 실패했어요. 나중에 다시 시도해주세요.'
                };
            }
        }

        // 이미지에서 영양 분석
        async function analyzeNutritionFromImage(file, imageUrl) {
            try {
                // 사용자 정보 가져오기
                const weightsSnapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('weights')
                    .orderBy('date', 'desc')
                    .limit(1)
                    .get();

                const currentWeight = weightsSnapshot.empty
                    ? currentProfile.startWeight
                    : weightsSnapshot.docs[0].data().weight;

                // Base64 인코딩
                const base64Image = await fileToBase64(file);

                // AI 프롬프트 생성 (트레이너 페르소나)
                const weightDiff = currentWeight - currentProfile.goalWeight;
                const goalDescription = weightDiff > 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 감량` : (weightDiff < 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 증량` : '현재 체중 유지');

                const prompt = `당신은 ${currentProfile.name} 회원님을 담당하는 전문 퍼스널 트레이너이자 영양 전문가입니다. 이미지를 분석하여 영양 성분을 추정해주세요.

**회원 정보:**
- 회원명: ${currentProfile.name} 회원님
- 현재 체중: ${currentWeight}kg
- 목표 체중: ${currentProfile.goalWeight}kg
- 목표: ${goalDescription}

이미지에 있는 음식의 영양 성분을 정확히 분석하고, 회원님의 다이어트 목표를 고려하여 전문가답게 조언해주세요.

**조언 작성 지침:**
- 호칭: 반드시 "${currentProfile.name} 회원님"으로 시작
- 톤: "힘든 거 알지만, 이거 드시면 [결과]해요" 같은 공감+현실적 조언
- 길이: 40자 이내

**반드시 아래 JSON 형식으로만 응답해주세요:**

{
  "calories": 숫자만 (kcal),
  "carbs": 숫자만 (그램),
  "protein": 숫자만 (그램),
  "fat": 숫자만 (그램),
  "foodName": "음식명",
  "advice": "${currentProfile.name} 회원님으로 시작하는 한 줄 조언 (40자 이내)"
}`;

                // Gemini Vision API 호출
                const responseText = await callGeminiVisionAPI(prompt, base64Image);
                const nutrition = parseNutritionResponse(responseText);

                return {
                    calories: nutrition.calories,
                    carbs: nutrition.carbs,
                    protein: nutrition.protein,
                    fat: nutrition.fat,
                    foodName: nutrition.foodName,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: nutrition.advice
                };

            } catch (error) {
                console.error('이미지 영양 분석 실패:', error);
                return {
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0,
                    foodName: '알 수 없음',
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `${currentProfile.name} 회원님, AI 분석에 실패했습니다. 나중에 다시 시도해주세요.`
                };
            }
        }

        // 텍스트에서 영양 분석
        async function analyzeNutritionFromText(text) {
            try {
                // 사용자 정보 가져오기
                const weightsSnapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('weights')
                    .orderBy('date', 'desc')
                    .limit(1)
                    .get();

                const currentWeight = weightsSnapshot.empty
                    ? currentProfile.startWeight
                    : weightsSnapshot.docs[0].data().weight;

                // AI 프롬프트 생성 (트레이너 페르소나)
                const weightDiff = currentWeight - currentProfile.goalWeight;
                const goalDescription = weightDiff > 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 감량` : (weightDiff < 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 증량` : '현재 체중 유지');

                const prompt = `당신은 ${currentProfile.name} 회원님을 담당하는 전문 퍼스널 트레이너이자 영양 전문가입니다. 텍스트를 분석하여 영양 성분을 추정해주세요.

**회원 정보:**
- 회원명: ${currentProfile.name} 회원님
- 현재 체중: ${currentWeight}kg
- 목표 체중: ${currentProfile.goalWeight}kg
- 목표: ${goalDescription}

**회원님이 입력한 식사 내용:** "${text}"

이 식사의 영양 성분을 정확히 분석하고, 회원님의 다이어트 목표를 고려하여 전문가답게 조언해주세요.

**조언 작성 지침:**
- 호칭: 반드시 "${currentProfile.name} 회원님"으로 시작
- 톤: "힘든 거 알지만, 이거 드시면 [결과]해요" 같은 공감+현실적 조언
- 길이: 40자 이내

**반드시 아래 JSON 형식으로만 응답해주세요:**

{
  "calories": 숫자만 (kcal),
  "carbs": 숫자만 (그램),
  "protein": 숫자만 (그램),
  "fat": 숫자만 (그램),
  "foodName": "음식명",
  "advice": "${currentProfile.name} 회원님으로 시작하는 한 줄 조언 (40자 이내)"
}`;

                // Gemini Text API 호출
                const responseText = await callGeminiAPI(prompt);
                const nutrition = parseNutritionResponse(responseText);

                return {
                    calories: nutrition.calories,
                    carbs: nutrition.carbs,
                    protein: nutrition.protein,
                    fat: nutrition.fat,
                    foodName: nutrition.foodName,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: nutrition.advice
                };

            } catch (error) {
                console.error('텍스트 영양 분석 실패:', error);
                return {
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0,
                    foodName: '알 수 없음',
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `${currentProfile.name} 회원님, AI 분석에 실패했습니다. 나중에 다시 시도해주세요.`
                };
            }
        }

        // ==================== 영양 대시보드 함수 ====================

        // 영양 대시보드 로드
        async function loadNutritionDashboard() {
            try {
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);

                const foodPhotosSnapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('category', '==', 'food')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(todayStart))
                    .where('uploadedAt', '<', firebase.firestore.Timestamp.fromDate(todayEnd))
                    .get();

                let totalCalories = 0, totalCarbs = 0, totalProtein = 0, totalFat = 0, mealCount = 0;

                foodPhotosSnapshot.forEach(doc => {
                    const photo = doc.data();
                    if (photo.nutrition) {
                        totalCalories += photo.nutrition.calories || 0;
                        totalCarbs += photo.nutrition.carbs || 0;
                        totalProtein += photo.nutrition.protein || 0;
                        totalFat += photo.nutrition.fat || 0;
                        mealCount++;
                    }
                });

                // UI 업데이트
                document.getElementById('todayCalories').textContent = Math.round(totalCalories);
                document.getElementById('todayCarbs').textContent = Math.round(totalCarbs);
                document.getElementById('todayProtein').textContent = Math.round(totalProtein);
                document.getElementById('todayFat').textContent = Math.round(totalFat);
                document.getElementById('todayMealCount').textContent = mealCount;

                // 차트 렌더링
                renderNutritionChart(totalCarbs, totalProtein, totalFat);

            } catch (error) {
                console.error('영양 대시보드 로드 실패:', error);
            }
        }

        // 영양 차트 렌더링 (Chart.js)
        function renderNutritionChart(carbs, protein, fat) {
            const ctx = document.getElementById('nutritionChart');
            if (!ctx) return;

            // 기존 차트 제거
            if (nutritionChart) {
                nutritionChart.destroy();
            }

            // 데이터가 모두 0이면 차트를 그리지 않음
            if (carbs === 0 && protein === 0 && fat === 0) {
                nutritionChart = null;
                return;
            }

            nutritionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['탄수화물', '단백질', '지방'],
                    datasets: [{
                        data: [carbs, protein, fat],
                        backgroundColor: [
                            '#a1c4fd',
                            '#fccb90',
                            '#e0c3fc'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + Math.round(context.parsed) + 'g';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 영양 대시보드 새로고침
        async function refreshDashboardNutrition() {
            await loadNutritionDashboard();
        }

        // ==================== AI 토스트 팝업 함수 ====================

        // AI 토스트 표시
        function showAIToast(message, duration = 5000) {
            const toast = document.getElementById('aiToast');
            const messageEl = document.getElementById('aiToastMessage');

            // 기존 타임아웃 취소
            if (aiToastTimeout) {
                clearTimeout(aiToastTimeout);
            }

            // 메시지 설정 및 표시
            messageEl.textContent = message;
            toast.classList.remove('hidden');

            // 자동 숨김 (duration이 0이면 수동으로만 닫힘)
            if (duration > 0) {
                aiToastTimeout = setTimeout(() => {
                    toast.classList.add('hidden');
                }, duration);
            }
        }

        // AI 토스트에서 채팅 열기
        function openAIChatFromToast() {
            // 토스트 숨김
            document.getElementById('aiToast').classList.add('hidden');

            // AI 채팅 탭으로 이동
            switchTab('home');

            // AI 채팅 섹션 열기
            const aiChatDetails = document.getElementById('aiChatDetails');
            if (aiChatDetails && aiChatDetails.style.display !== 'block') {
                toggleAIChat();
            }

            // 입력창에 포커스
            setTimeout(() => {
                const chatInput = document.getElementById('aiChatInput');
                if (chatInput) {
                    chatInput.focus();
                }
            }, 300);
        }

        // AI 대화 맥락 프롬프트 생성
        async function buildAIContextPrompt(userMessage, chatHistory) {
            try {
                // 최근 5개 대화 가져오기
                const recentChats = chatHistory.slice(-10); // 최근 5쌍 (user+assistant)
                const recentChatText = recentChats
                    .map(chat => `${chat.role === 'user' ? '사용자' : 'AI'}: ${chat.content}`)
                    .join('\n');

                // 오늘의 영양 데이터 가져오기
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);

                const foodPhotosSnapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('category', '==', 'food')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(todayStart))
                    .where('uploadedAt', '<', firebase.firestore.Timestamp.fromDate(todayEnd))
                    .get();

                let totalCalories = 0;
                const meals = [];

                foodPhotosSnapshot.forEach(doc => {
                    const photo = doc.data();
                    if (photo.nutrition) {
                        totalCalories += photo.nutrition.calories || 0;
                        meals.push(`${photo.nutrition.foodName} (${Math.round(photo.nutrition.calories)}kcal)`);
                    }
                });

                // 현재 체중 가져오기
                const weightsSnapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('weights')
                    .orderBy('date', 'desc')
                    .limit(1)
                    .get();

                const currentWeight = weightsSnapshot.empty
                    ? currentProfile.startWeight
                    : weightsSnapshot.docs[0].data().weight;

                // 컨텍스트 포함 프롬프트 생성 (AI 트레이너 페르소나)
                const weightDiff = currentWeight - currentProfile.goalWeight;
                const goalDescription = weightDiff > 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 감량` : (weightDiff < 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 증량` : '현재 체중 유지');

                const contextPrompt = `당신은 전문 퍼스널 트레이너입니다. ${currentProfile.name} 회원님의 다이어트를 담당하고 있습니다.

**[트레이너 페르소나 지침]**
- 호칭: 반드시 "${currentProfile.name} 회원님"으로 호칭하세요
- 말투: 전문가답게 정중하지만, 필요시 단호하게 조언하세요
- 태도: "힘든 거 알아요"라는 공감과 "그래도 안 됩니다"라는 원칙을 병행하세요
- 응답: 3-4문장 이내로 간결하게, 존댓말을 사용하세요

**사용자 정보:**
- 회원명: ${currentProfile.name} 회원님
- 현재 체중: ${currentWeight}kg
- 목표 체중: ${currentProfile.goalWeight}kg
- 목표: ${goalDescription}

**오늘의 식사 기록:**
${meals.length > 0 ? meals.join('\n') : '아직 기록된 식사가 없습니다.'}
- 총 섭취 칼로리: ${Math.round(totalCalories)}kcal

**최근 대화 내역:**
${recentChatText || '이전 대화 없음'}

**현재 질문:**
${userMessage}

위 정보를 바탕으로 전문 트레이너처럼 조언해주세요. 반드시 "${currentProfile.name} 회원님"이라는 호칭을 사용하세요.`;

                return contextPrompt;

            } catch (error) {
                console.error('AI 컨텍스트 생성 실패:', error);
                // 에러 시 기본 프롬프트 (트레이너 페르소나 유지)
                return `당신은 전문 퍼스널 트레이너입니다. ${currentProfile.name} 회원님의 다이어트를 담당하고 있습니다. 반드시 "${currentProfile.name} 회원님"으로 호칭하고, 전문가답게 조언해주세요.\n\n현재 질문: ${userMessage}`;
            }
        }

        // 플랜과 실제 식사 비교
        async function comparePlanWithMeal(mealTime, nutritionData) {
            try {
                // 식사 시간 ±1시간 범위의 플랜 검색
                const oneHourBefore = new Date(mealTime.getTime() - 60 * 60 * 1000);
                const oneHourAfter = new Date(mealTime.getTime() + 60 * 60 * 1000);

                const plansSnapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('plans')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(oneHourBefore))
                    .where('date', '<=', firebase.firestore.Timestamp.fromDate(oneHourAfter))
                    .get();

                // 플랜이 없으면 비교하지 않음
                if (plansSnapshot.empty) {
                    return null;
                }

                // 가장 가까운 플랜 찾기
                let closestPlan = null;
                let closestDiff = Infinity;

                plansSnapshot.forEach(doc => {
                    const plan = doc.data();
                    const planTime = plan.date.toDate();
                    const diff = Math.abs(planTime.getTime() - mealTime.getTime());

                    if (diff < closestDiff) {
                        closestDiff = diff;
                        closestPlan = plan;
                    }
                });

                if (!closestPlan) return null;

                // AI에게 비교 요청 (트레이너 페르소나 - 팩트 체크)
                const prompt = `당신은 ${currentProfile.name} 회원님을 담당하는 전문 퍼스널 트레이너입니다. 계획과 실제 식사를 비교하여 팩트 체크해주세요.

**계획한 식사:** ${closestPlan.activity}
**실제 섭취한 음식:** ${nutritionData.foodName} (${Math.round(nutritionData.calories)}kcal)

**지침:**
- 호칭: 반드시 "${currentProfile.name} 회원님"으로 시작하세요
- 일치하면: "완벽합니다! 계획대로 실천하셨네요." 같은 칭찬 (30자 이내)
- 불일치하면: "회원님? 계획엔 [계획]인데 사진은 [실제]네요? 이러면 안 됩니다." 같은 팩트 폭격 (50자 이내)
- 톤: 전문가답게 매섭지만 정중하게

짧은 한 문장으로만 답변해주세요:`;

                const response = await callGeminiAPI(prompt);

                return response || '오늘도 식사 기록 완료! 👍';

            } catch (error) {
                console.error('플랜-식사 비교 실패:', error);
                return null;
            }
        }

        // ==================== 스마트 병합 함수 ====================

        // 최근 식사 확인 (3시간 이내)
        async function checkForRecentMeal(newMealTime) {
            try {
                const threeHoursAgo = new Date(newMealTime.getTime() - 3 * 60 * 60 * 1000);

                const recentMealsSnapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('category', '==', 'food')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(threeHoursAgo))
                    .orderBy('uploadedAt', 'desc')
                    .limit(1)
                    .get();

                if (recentMealsSnapshot.empty) {
                    return null;
                }

                return {
                    id: recentMealsSnapshot.docs[0].id,
                    data: recentMealsSnapshot.docs[0].data()
                };
            } catch (error) {
                console.error('최근 식사 확인 실패:', error);
                return null;
            }
        }

        // 병합 Bottom Sheet 표시
        function showMergeBottomSheet(newMealData, recentMeal) {
            // 전역 변수에 저장 (confirmMerge와 createNewMeal에서 사용)
            pendingMealData = newMealData;
            recentMealDocId = recentMeal.id;

            // UI 업데이트
            const previousNutrition = recentMeal.data.nutrition || {};
            const currentNutrition = newMealData.nutrition || {};

            document.getElementById('previousMealName').textContent = previousNutrition.foodName || '알 수 없음';
            document.getElementById('previousMealCal').textContent = `${Math.round(previousNutrition.calories || 0)}kcal`;

            document.getElementById('currentMealName').textContent = currentNutrition.foodName || '알 수 없음';
            document.getElementById('currentMealCal').textContent = `${Math.round(currentNutrition.calories || 0)}kcal`;

            const totalCalories = (previousNutrition.calories || 0) + (currentNutrition.calories || 0);
            document.getElementById('mergeTotal').textContent = `${Math.round(totalCalories)}kcal`;

            // Bottom Sheet 표시
            document.getElementById('mergeBottomSheet').classList.remove('hidden');
        }

        // 병합 확인
        async function confirmMerge() {
            try {
                if (!pendingMealData || !recentMealDocId) {
                    console.error('병합할 데이터가 없습니다.');
                    return;
                }

                // 기존 식사 데이터 가져오기
                const recentMealDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('photos').doc(recentMealDocId).get();

                const recentData = recentMealDoc.data();
                const mergedNutrition = {
                    calories: (recentData.nutrition?.calories || 0) + (pendingMealData.nutrition?.calories || 0),
                    carbs: (recentData.nutrition?.carbs || 0) + (pendingMealData.nutrition?.carbs || 0),
                    protein: (recentData.nutrition?.protein || 0) + (pendingMealData.nutrition?.protein || 0),
                    fat: (recentData.nutrition?.fat || 0) + (pendingMealData.nutrition?.fat || 0),
                    foodName: `${recentData.nutrition?.foodName || '식사'} + ${pendingMealData.nutrition?.foodName || '식사'}`,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `총 ${Math.round((recentData.nutrition?.calories || 0) + (pendingMealData.nutrition?.calories || 0))}kcal 섭취`
                };

                // 텍스트 병합
                const mergedText = [recentData.text, pendingMealData.text]
                    .filter(t => t)
                    .join(' + ') || null;

                // Firestore 업데이트
                await db.collection('users').doc(currentUser.uid)
                    .collection('photos').doc(recentMealDocId).update({
                        nutrition: mergedNutrition,
                        text: mergedText
                    });

                // Bottom Sheet 닫기
                document.getElementById('mergeBottomSheet').classList.add('hidden');

                // 전역 변수 초기화
                pendingMealData = null;
                recentMealDocId = null;

                // UI 새로고침
                await loadAlbumTab();
                await refreshDashboardNutrition();

                showAIToast(`${currentProfile.name} 회원님, 식사가 합쳐졌습니다! 😊`, 3000);

            } catch (error) {
                console.error('병합 실패:', error);
                showErrorToast('병합에 실패했습니다.');
            }
        }

        // 새 식사로 저장
        async function createNewMeal() {
            try {
                if (!pendingMealData) {
                    console.error('저장할 데이터가 없습니다.');
                    return;
                }

                // 새 문서로 저장
                await db.collection('users').doc(currentUser.uid)
                    .collection('photos').add(pendingMealData);

                // Bottom Sheet 닫기
                document.getElementById('mergeBottomSheet').classList.add('hidden');

                // 전역 변수 초기화
                pendingMealData = null;
                recentMealDocId = null;

                // UI 새로고침
                await loadAlbumTab();
                await refreshDashboardNutrition();

                showSuccessToast('새 식사로 저장되었습니다!');

            } catch (error) {
                console.error('저장 실패:', error);
                showErrorToast('저장에 실패했습니다.');
            }
        }

        // ==================== 텍스트 카드 입력 ====================

        // 텍스트 카드 추가
        async function addTextCard() {
            try {
                const category = prompt('카테고리를 선택하세요:\n1. 눈바디 (body)\n2. 식단 (food)\n3. 운동 (exercise)');
                let categoryValue = 'body';
                if (category === '2' || category.includes('식단')) categoryValue = 'food';
                else if (category === '3' || category.includes('운동')) categoryValue = 'exercise';

                const text = prompt('내용을 입력하세요:');
                if (!text || !text.trim()) {
                    return;
                }

                // 텍스트 카드 데이터 생성
                const cardData = {
                    url: null,
                    category: categoryValue,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    text: text.trim()
                };

                // 식단인 경우 AI 영양 분석
                let nutritionData = null;
                if (categoryValue === 'food') {
                    try {
                        nutritionData = await analyzeNutritionFromText(text);
                        if (nutritionData) {
                            cardData.nutrition = nutritionData;
                        }
                    } catch (error) {
                        console.error('텍스트 영양 분석 실패:', error);
                    }
                }

                // 식단인 경우 스마트 병합 체크
                if (categoryValue === 'food' && nutritionData) {
                    const recentMeal = await checkForRecentMeal(new Date());

                    if (recentMeal) {
                        // 최근 식사 발견 - 병합 Bottom Sheet 표시
                        showMergeBottomSheet(cardData, recentMeal);
                        return; // confirmMerge()나 createNewMeal()에서 처리
                    }
                }

                // 스마트 병합 대상이 아니거나 식단이 아닌 경우 바로 저장
                await db.collection('users').doc(currentUser.uid)
                    .collection('photos').add(cardData);

                // 앨범 새로고침
                await loadAlbumTab();

                // 식단인 경우 대시보드도 새로고침 및 AI 토스트 표시
                if (categoryValue === 'food' && nutritionData) {
                    await refreshDashboardNutrition();

                    // 플랜과 비교 (선택적)
                    let toastMessage = nutritionData.aiAdvice || '식사가 기록되었어요!';
                    try {
                        const comparisonResult = await comparePlanWithMeal(new Date(), nutritionData);
                        if (comparisonResult) {
                            toastMessage = comparisonResult;
                        }
                    } catch (error) {
                        console.error('플랜 비교 실패:', error);
                    }

                    showAIToast(toastMessage, 6000);
                } else {
                    showSuccessToast('텍스트 카드가 추가되었습니다!');
                }

            } catch (error) {
                console.error('텍스트 카드 추가 실패:', error);
                showErrorToast('텍스트 카드 추가에 실패했습니다.');
            }
        }

        // ==================== 인증 관련 함수 ====================
        function showAuth() {
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('auth').classList.remove('hidden');
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            document.getElementById('authTitle').textContent = isSignUp ? '회원가입' : '로그인';
            document.getElementById('authButtonText').textContent = isSignUp ? '가입하기' : '로그인';
            document.getElementById('authToggleText').textContent = isSignUp ? '이미 계정이 있으신가요? 로그인' : '계정이 없으신가요? 회원가입';
            document.getElementById('signupFields').style.display = isSignUp ? 'block' : 'none';
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                if (isSignUp) {
                    const displayName = document.getElementById('displayName').value;
                    const goalWeight = parseFloat(document.getElementById('goalWeight').value);
                    const startWeight = parseFloat(document.getElementById('startWeight').value);

                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName });

                    await db.collection('users').doc(userCredential.user.uid).set({
                        name: displayName,
                        email: email,
                        goalWeight: goalWeight,
                        startWeight: startWeight,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showSuccessMessage('회원가입 성공! 로그인 중...');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                showErrorMessage(getErrorMessage(error.code));
            }
        });

        function showErrorMessage(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        function showSuccessMessage(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.classList.add('show');
            setTimeout(() => successDiv.classList.remove('show'), 3000);
        }

        function getErrorMessage(code) {
            const messages = {
                'auth/email-already-in-use': '이미 사용 중인 이메일입니다.',
                'auth/invalid-email': '잘못된 이메일 형식입니다.',
                'auth/weak-password': '비밀번호는 6자 이상이어야 합니다.',
                'auth/user-not-found': '존재하지 않는 계정입니다.',
                'auth/wrong-password': '비밀번호가 올바르지 않습니다.'
            };
            return messages[code] || '오류가 발생했습니다. 다시 시도해주세요.';
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const profileDoc = await db.collection('users').doc(user.uid).get();
                currentProfile = profileDoc.data();

                document.getElementById('auth').classList.add('hidden');
                document.getElementById('landing').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');

                await initializeDashboard();
            }
        });

        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                auth.signOut();
                location.reload();
            }
        }

        // ==================== 대시보드 초기화 ====================
        async function initializeDashboard() {
            document.getElementById('headerSubtitle').textContent = `${currentProfile.name}님, 환영합니다!`;
            document.getElementById('profileName').textContent = currentProfile.name;
            document.getElementById('profileEmail').textContent = currentUser.email;

            await loadHomeTab();
            await loadPlanTab();
            await loadAlbumTab();
            await loadCalendar();
            await loadCommunityMessages();
            await loadNotifications();
            await loadSettings();

            initializeFasting();
            initializePWA();
            startNotificationCheck();

            // AI 채팅 기록 로드
            loadAIChatHistory();
        }

        // ==================== 탭 전환 ====================
        function switchTab(tabName) {
            // 모든 탭 비활성화
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));

            // 선택된 탭 활성화
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.currentTarget.classList.add('active');

            currentTab = tabName;

            // 소통 탭의 입력창 표시/숨김
            const chatInput = document.getElementById('chatInputContainer');
            if (tabName === 'community') {
                chatInput.classList.remove('hidden');
            } else {
                chatInput.classList.add('hidden');
            }

            // 탭별 새로고침
            if (tabName === 'calendar') {
                renderCalendar();
            } else if (tabName === 'plan') {
                loadPlanTab();
            } else if (tabName === 'album') {
                loadAlbumTab();
            }
        }

        // ==================== 홈 탭 ====================
        async function loadHomeTab() {
            // 건강 지표 표시
            const startWeight = currentProfile.startWeight || 0;
            const goalWeight = currentProfile.goalWeight || 0;

            document.getElementById('startWeightDisplay').textContent = startWeight.toFixed(1);
            document.getElementById('goalWeightDisplay').textContent = goalWeight.toFixed(1);

            // 체중 데이터 로드
            const weightData = await db.collection('users').doc(currentUser.uid)
                .collection('weights').orderBy('date', 'asc').get();

            const weights = weightData.docs.map(doc => ({
                date: doc.data().date.toDate(),
                weight: doc.data().weight
            }));

            const currentWeight = weights.length > 0 ? weights[weights.length - 1].weight : startWeight;
            document.getElementById('currentWeightDisplay').textContent = currentWeight.toFixed(1);

            // 진행률 계산
            const totalToLose = startWeight - goalWeight;
            const lostSoFar = startWeight - currentWeight;
            const remaining = currentWeight - goalWeight;
            const progress = totalToLose > 0 ? (lostSoFar / totalToLose * 100) : 0;

            document.getElementById('progressPercent').textContent = `${Math.max(0, Math.min(100, progress)).toFixed(1)}%`;
            document.getElementById('progressBar').style.width = `${Math.max(0, Math.min(100, progress))}%`;
            document.getElementById('weightLost').textContent = `감량: ${Math.max(0, lostSoFar).toFixed(1)}kg`;
            document.getElementById('weightRemaining').textContent = `남은 감량: ${Math.max(0, remaining).toFixed(1)}kg`;

            // 체중 그래프 그리기
            drawWeightChart(weights);

            // 영양 대시보드 로드
            await loadNutritionDashboard();

            // 물 마시기 트래커 초기화
            initializeWaterTracker();
        }

        function drawWeightChart(weights) {
            const ctx = document.getElementById('weightChart').getContext('2d');

            if (weightChart) {
                weightChart.destroy();
            }

            const labels = weights.map(w => {
                const date = w.date;
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });

            const data = weights.map(w => w.weight);

            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '체중 (kg)',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        async function addWeight() {
            const weight = parseFloat(document.getElementById('weightInput').value);

            if (!weight || weight <= 0) {
                alert('올바른 체중을 입력해주세요.');
                return;
            }

            await db.collection('users').doc(currentUser.uid)
                .collection('weights').add({
                    weight: weight,
                    date: firebase.firestore.Timestamp.now()
                });

            document.getElementById('weightInput').value = '';
            await loadHomeTab();
        }

        // AI 채팅
        function toggleAIChat() {
            const details = document.getElementById('aiChatDetails');
            details.classList.toggle('open');
        }

        function loadAIChatHistory() {
            const history = JSON.parse(localStorage.getItem(LS_KEYS.AI_CHAT) || '[]');
            const messagesDiv = document.getElementById('aiChatMessages');
            messagesDiv.innerHTML = '';

            history.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `ai-message ${msg.role}`;
                msgDiv.textContent = msg.content;
                messagesDiv.appendChild(msgDiv);
            });

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();

            if (!message) return;

            // 사용자 메시지 추가
            const history = JSON.parse(localStorage.getItem(LS_KEYS.AI_CHAT) || '[]');
            history.push({ role: 'user', content: message });

            // 최근 50개만 유지
            if (history.length > 50) {
                history.shift();
            }

            localStorage.setItem(LS_KEYS.AI_CHAT, JSON.stringify(history));
            loadAIChatHistory();
            input.value = '';

            // AI 응답 받기 (컨텍스트 포함)
            const prompt = await buildAIContextPrompt(message, history);
            const response = await callGeminiAPI(prompt);

            history.push({ role: 'assistant', content: response });
            localStorage.setItem(LS_KEYS.AI_CHAT, JSON.stringify(history));
            loadAIChatHistory();
        }

        // 스마트 물 마시기
        function initializeWaterTracker() {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"cupSize": 250, "goalLiters": 2, "filled": []}');

            document.getElementById('cupSize').value = settings.cupSize;
            document.getElementById('waterGoal').value = settings.goalLiters;

            updateWaterTracker();
        }

        function updateWaterTracker() {
            const cupSize = parseInt(document.getElementById('cupSize').value) || 250;
            const goalLiters = parseFloat(document.getElementById('waterGoal').value) || 2;
            const goalMl = goalLiters * 1000;
            const cupCount = Math.ceil(goalMl / cupSize);

            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"filled": []}');
            settings.cupSize = cupSize;
            settings.goalLiters = goalLiters;

            const tracker = document.getElementById('waterTracker');
            tracker.innerHTML = '';

            for (let i = 0; i < cupCount; i++) {
                const cup = document.createElement('div');
                cup.className = 'water-cup';
                if (settings.filled && settings.filled.includes(i)) {
                    cup.classList.add('filled');
                }
                cup.textContent = '💧';
                cup.onclick = () => toggleWaterCup(i);
                tracker.appendChild(cup);
            }

            localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));
        }

        function toggleWaterCup(index) {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS));
            if (!settings.filled) settings.filled = [];

            const idx = settings.filled.indexOf(index);
            if (idx > -1) {
                settings.filled.splice(idx, 1);
            } else {
                settings.filled.push(index);
            }

            localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));
            updateWaterTracker();
        }

        // ==================== 플랜 탭 ====================
        async function loadPlanTab() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('planDate').textContent = `${today.getMonth() + 1}월 ${today.getDate()}일 플랜`;

            const plans = await db.collection('users').doc(currentUser.uid)
                .collection('plans')
                .where('date', '==', todayStr)
                .orderBy('time', 'asc')
                .get();

            const planList = document.getElementById('planList');
            planList.innerHTML = '';

            if (plans.empty) {
                planList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">오늘의 플랜이 없습니다.</p>';
                return;
            }

            plans.forEach(doc => {
                const plan = doc.data();
                const planDiv = document.createElement('div');
                planDiv.className = 'plan-item';
                planDiv.innerHTML = `
                    <div class="plan-time">${plan.time}</div>
                    <div class="plan-content">
                        <div class="plan-category">${plan.category}</div>
                        <div class="plan-activity">${plan.activity}</div>
                        <div class="plan-value">${plan.value || ''}</div>
                    </div>
                    <div class="plan-delete" onclick="deletePlan('${doc.id}')">🗑️</div>
                `;
                planList.appendChild(planDiv);
            });
        }

        function openAddPlanModal() {
            const time = prompt('시간을 입력하세요 (예: 07:00)');
            if (!time) return;

            const category = prompt('카테고리를 입력하세요 (예: 운동, 식사, 물)');
            if (!category) return;

            const activity = prompt('활동명을 입력하세요');
            if (!activity) return;

            const value = prompt('예상 수치를 입력하세요 (선택사항, 예: 30분, 500kcal)') || '';

            addPlan(time, category, activity, value);
        }

        async function addPlan(time, category, activity, value) {
            const today = new Date().toISOString().split('T')[0];

            await db.collection('users').doc(currentUser.uid)
                .collection('plans').add({
                    date: today,
                    time: time,
                    category: category,
                    activity: activity,
                    value: value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

            await loadPlanTab();
        }

        async function deletePlan(planId) {
            if (!confirm('이 플랜을 삭제하시겠습니까?')) return;

            await db.collection('users').doc(currentUser.uid)
                .collection('plans').doc(planId).delete();

            await loadPlanTab();
        }

        async function suggestPlanWithAI() {
            // AI가 어제 데이터를 분석하여 플랜 추천
            const prompt = `사용자의 다이어트 앱을 위한 오늘의 플랜을 3-5가지 추천해주세요.
            형식: 시간|카테고리|활동명|예상수치
            예시:
            07:00|운동|아침 조깅|30분
            12:00|식사|점심 (저염식)|500kcal

            간단명료하게 각 줄마다 하나씩만 작성해주세요.`;

            const response = await callGeminiAPI(prompt);

            if (confirm(`AI 추천 플랜:\n\n${response}\n\n이 플랜들을 추가하시겠습니까?`)) {
                const lines = response.trim().split('\n');
                for (const line of lines) {
                    const parts = line.split('|');
                    if (parts.length >= 3) {
                        await addPlan(parts[0].trim(), parts[1].trim(), parts[2].trim(), parts[3]?.trim() || '');
                    }
                }
                await loadPlanTab();
            }
        }

        // ==================== 단식 탭 ====================
        async function initializeFasting() {
            const saved = localStorage.getItem(LS_KEYS.FASTING);
            if (saved) {
                fastingState = JSON.parse(saved);
                if (fastingState.active) {
                    startFastingTimer();
                }
            }

            // 누적 시간 로드
            await loadTodayFastingStats();
        }

        function startFasting() {
            const hours = parseInt(document.getElementById('fastingHours').value) || 16;

            if (hours > 24) {
                if (!confirm('24시간 이상의 단식은 건강에 위험할 수 있습니다. 계속하시겠습니까?')) {
                    return;
                }
            }

            const now = Date.now();
            fastingState = {
                active: true,
                startTime: now,
                duration: hours * 60 * 60 * 1000,
                endTime: now + (hours * 60 * 60 * 1000)
            };

            localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));
            startFastingTimer();

            document.getElementById('fastingStartBtn').style.display = 'none';
            document.getElementById('fastingStopBtn').style.display = 'inline-block';
            document.getElementById('fastingDurationInput').style.display = 'none';
        }

        async function stopFasting() {
            if (!confirm('단식을 중단하시겠습니까?')) return;

            // Firestore에 기록 저장
            if (fastingState && fastingState.active) {
                try {
                    const now = Date.now();
                    const duration = now - fastingState.startTime;
                    const today = new Date().toISOString().split('T')[0];

                    await db.collection('users').doc(currentUser.uid)
                        .collection('fastingRecords').add({
                            startTime: firebase.firestore.Timestamp.fromMillis(fastingState.startTime),
                            endTime: firebase.firestore.Timestamp.fromMillis(now),
                            duration: duration,
                            date: today,
                            completed: false
                        });

                    // 누적 시간 새로고침
                    await loadTodayFastingStats();
                } catch (error) {
                    console.error('단식 기록 저장 실패:', error);
                }
            }

            fastingState = null;
            localStorage.removeItem(LS_KEYS.FASTING);

            if (fastingInterval) {
                clearInterval(fastingInterval);
            }

            document.getElementById('fastingStartBtn').style.display = 'inline-block';
            document.getElementById('fastingStopBtn').style.display = 'none';
            document.getElementById('fastingDurationInput').style.display = 'flex';
            document.getElementById('fastingTimeMain').textContent = '00:00:00';
            document.getElementById('fastingTimeSub').textContent = '대기 중';
            document.getElementById('fastingProgress').style.strokeDashoffset = 691;
        }

        function startFastingTimer() {
            updateFastingDisplay();
            fastingInterval = setInterval(updateFastingDisplay, 1000);
        }

        async function updateFastingDisplay() {
            if (!fastingState || !fastingState.active) return;

            const now = Date.now();
            const elapsed = now - fastingState.startTime;
            const remaining = fastingState.endTime - now;

            if (remaining <= 0) {
                // 단식 완료 - Firestore에 기록 저장
                try {
                    await saveFastingRecord(true);  // completed: true
                } catch (error) {
                    console.error('단식 완료 기록 저장 실패:', error);
                }
                await stopFasting();
                alert('축하합니다! 단식 목표를 달성했습니다! 🎉');
                return;
            }

            const elapsedHours = Math.floor(elapsed / (1000 * 60 * 60));
            const elapsedMinutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const elapsedSeconds = Math.floor((elapsed % (1000 * 60)) / 1000);

            const remainingHours = Math.floor(remaining / (1000 * 60 * 60));
            const remainingMinutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const remainingSeconds = Math.floor((remaining % (1000 * 60)) / 1000);

            document.getElementById('fastingTimeMain').textContent =
                `${String(elapsedHours).padStart(2, '0')}:${String(elapsedMinutes).padStart(2, '0')}:${String(elapsedSeconds).padStart(2, '0')}`;

            document.getElementById('fastingTimeSub').textContent =
                `남은 시간: ${remainingHours}시간 ${remainingMinutes}분`;

            // 진행률 계산
            const progress = elapsed / fastingState.duration;
            const circumference = 691; // 2 * π * r (r=110)
            const offset = circumference - (progress * circumference);
            document.getElementById('fastingProgress').style.strokeDashoffset = offset;
        }

        // 단식 기록 저장
        async function saveFastingRecord(completed = false) {
            if (!fastingState || !fastingState.active) return;

            const now = Date.now();
            const duration = now - fastingState.startTime;
            const today = new Date().toISOString().split('T')[0];

            await db.collection('users').doc(currentUser.uid)
                .collection('fastingRecords').add({
                    startTime: firebase.firestore.Timestamp.fromMillis(fastingState.startTime),
                    endTime: firebase.firestore.Timestamp.fromMillis(now),
                    duration: duration,
                    date: today,
                    completed: completed
                });
        }

        // 오늘의 누적 시간 로드
        async function loadTodayFastingStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const records = await db.collection('users').doc(currentUser.uid)
                    .collection('fastingRecords')
                    .where('date', '==', today)
                    .get();

                let totalDuration = 0;
                const sessions = [];

                records.forEach(doc => {
                    const data = doc.data();
                    totalDuration += data.duration;
                    sessions.push({
                        startTime: data.startTime.toDate(),
                        endTime: data.endTime.toDate(),
                        duration: data.duration,
                        completed: data.completed
                    });
                });

                // 현재 진행 중인 단식도 포함
                if (fastingState && fastingState.active) {
                    const currentDuration = Date.now() - fastingState.startTime;
                    totalDuration += currentDuration;
                }

                const hours = Math.floor(totalDuration / (1000 * 60 * 60));
                const minutes = Math.floor((totalDuration % (1000 * 60 * 60)) / (1000 * 60));

                const accumulatedEl = document.getElementById('accumulatedTime');
                if (accumulatedEl) {
                    accumulatedEl.textContent = `${hours}시간 ${minutes}분`;
                }

                displayFastingSessions(sessions);
            } catch (error) {
                console.error('단식 통계 로드 실패:', error);
            }
        }

        // 세션 목록 표시
        function displayFastingSessions(sessions) {
            const container = document.getElementById('fastingSessions');
            if (!container) return;

            container.innerHTML = '';

            if (sessions.length === 0) {
                return;
            }

            sessions.forEach((session, index) => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'fasting-session-item';

                const duration = Math.floor(session.duration / (1000 * 60));
                const hours = Math.floor(duration / 60);
                const minutes = duration % 60;

                const statusIcon = session.completed ? '✅' : '⏸️';
                const startTime = session.startTime.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
                const endTime = session.endTime.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});

                sessionDiv.innerHTML = `
                    <span>${statusIcon} 세션 ${index + 1}</span>
                    <span>${startTime} - ${endTime}</span>
                    <span>${hours}시간 ${minutes}분</span>
                `;

                container.appendChild(sessionDiv);
            });
        }

        // ==================== 앨범 탭 ====================
        async function loadAlbumTab() {
            const photos = await db.collection('users').doc(currentUser.uid)
                .collection('photos')
                .orderBy('uploadedAt', 'desc')
                .get();

            const grid = document.getElementById('photoGrid');
            grid.innerHTML = '<div class="photo-item add-photo" onclick="addPhoto()">+</div>';

            // Phase 4: 배치 작업을 위해 현재 표시된 항목 저장
            allPhotoItems = [];

            photos.forEach(doc => {
                const photo = doc.data();
                if (currentAlbumTab === 'all' || photo.category === currentAlbumTab) {
                    const photoDiv = document.createElement('div');
                    const docId = doc.id;

                    // Phase 4: 항목 저장 (이미지만, 텍스트 카드는 다운로드/공유 대상 아님)
                    if (photo.url) {
                        allPhotoItems.push({ docId, url: photo.url, photo });
                    }

                    // 텍스트 카드인 경우 (url이 null이고 text가 있음)
                    if (!photo.url && photo.text) {
                        photoDiv.className = `photo-item text-card category-${photo.category}`;
                        photoDiv.dataset.docId = docId;

                        let nutritionHtml = '';
                        if (photo.nutrition && photo.category === 'food') {
                            nutritionHtml = `
                                <div class="text-card-nutrition">
                                    ${Math.round(photo.nutrition.calories)}kcal
                                </div>
                            `;
                        }

                        photoDiv.innerHTML = `
                            <div class="text-card-emoji">${getCategoryEmoji(photo.category)}</div>
                            <div class="text-card-content">${photo.text}</div>
                            ${nutritionHtml}
                        `;
                    }
                    // 일반 이미지 카드
                    else if (photo.url) {
                        photoDiv.className = 'photo-item';
                        photoDiv.dataset.docId = docId;

                        // Phase 4: 선택 모드일 때 체크박스 추가
                        let checkboxHtml = '';
                        if (isSelectMode) {
                            const isChecked = selectedItems.has(docId);
                            checkboxHtml = `<div class="select-checkbox ${isChecked ? 'checked' : ''}" onclick="event.stopPropagation(); toggleItemSelection('${docId}')"></div>`;
                            if (isChecked) {
                                photoDiv.classList.add('selected');
                            }
                        }

                        photoDiv.innerHTML = `
                            ${checkboxHtml}
                            <img src="${photo.url}" alt="사진">
                            <div class="photo-date-label">${new Date(photo.uploadedAt.toDate()).toLocaleDateString()}</div>
                        `;
                    }

                    // Phase 4: 선택 모드일 때는 선택 토글, 아니면 모달 열기
                    photoDiv.onclick = () => {
                        if (isSelectMode && photo.url) {
                            toggleItemSelection(docId);
                        } else {
                            openPhotoModal(photo.url || photo.text, docId);
                        }
                    };

                    grid.appendChild(photoDiv);
                }
            });
        }

        // 카테고리별 이모지 매핑
        function getCategoryEmoji(category) {
            const emojiMap = {
                'body': '💪',
                'food': '🍽️',
                'exercise': '🏃‍♂️'
            };
            return emojiMap[category] || '📝';
        }

        function changeAlbumTab(tab) {
            currentAlbumTab = tab;
            document.querySelectorAll('.album-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            loadAlbumTab();
        }

        // ==================== Phase 4: 배치 작업 함수들 ====================

        // 선택 모드 토글
        function toggleSelectMode() {
            isSelectMode = !isSelectMode;

            const selectModeBtn = document.getElementById('selectModeBtn');
            const selectActionBar = document.getElementById('selectActionBar');

            if (isSelectMode) {
                selectModeBtn.classList.add('active');
                selectModeBtn.textContent = '취소';
                selectActionBar.classList.remove('hidden');
            } else {
                selectModeBtn.classList.remove('active');
                selectModeBtn.textContent = '선택';
                selectActionBar.classList.add('hidden');
                selectedItems.clear();
            }

            // 앨범 재렌더링 (체크박스 표시/숨김)
            loadAlbumTab();
            updateSelectedCount();
        }

        // 개별 항목 선택/해제
        function toggleItemSelection(docId) {
            if (selectedItems.has(docId)) {
                selectedItems.delete(docId);
            } else {
                selectedItems.add(docId);
            }

            // UI 업데이트
            const photoDiv = document.querySelector(`.photo-item[data-doc-id="${docId}"]`);
            if (photoDiv) {
                const checkbox = photoDiv.querySelector('.select-checkbox');
                if (selectedItems.has(docId)) {
                    photoDiv.classList.add('selected');
                    if (checkbox) checkbox.classList.add('checked');
                } else {
                    photoDiv.classList.remove('selected');
                    if (checkbox) checkbox.classList.remove('checked');
                }
            }

            updateSelectedCount();
        }

        // 선택된 개수 업데이트
        function updateSelectedCount() {
            const count = selectedItems.size;
            document.getElementById('selectedCount').textContent = `${count}개 선택됨`;
        }

        // 선택된 항목 다운로드
        async function downloadSelectedItems() {
            if (selectedItems.size === 0) {
                alert('다운로드할 항목을 선택해주세요.');
                return;
            }

            try {
                // 선택된 항목들의 URL 가져오기
                const selectedUrls = allPhotoItems
                    .filter(item => selectedItems.has(item.docId))
                    .map(item => item.url);

                if (selectedUrls.length === 0) {
                    alert('다운로드할 이미지가 없습니다.');
                    return;
                }

                // 각 이미지 다운로드
                for (let i = 0; i < selectedUrls.length; i++) {
                    const url = selectedUrls[i];
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `diet-mate-photo-${i + 1}.jpg`;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // 브라우저가 다운로드를 처리할 시간 주기
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                alert(`${selectedUrls.length}개 이미지 다운로드를 시작했습니다.`);
                cancelSelectMode();
            } catch (error) {
                console.error('다운로드 오류:', error);
                alert('다운로드 중 오류가 발생했습니다.');
            }
        }

        // 선택된 항목 공유 (Web Share API)
        async function shareSelectedItems() {
            if (selectedItems.size === 0) {
                alert('공유할 항목을 선택해주세요.');
                return;
            }

            // Web Share API 지원 여부 확인
            if (!navigator.share) {
                alert('이 브라우저는 공유 기능을 지원하지 않습니다.');
                return;
            }

            try {
                // 선택된 항목들의 URL 가져오기
                const selectedUrls = allPhotoItems
                    .filter(item => selectedItems.has(item.docId))
                    .map(item => item.url);

                if (selectedUrls.length === 0) {
                    alert('공유할 이미지가 없습니다.');
                    return;
                }

                // URL들을 텍스트로 공유 (이미지 파일은 fetch 필요)
                const shareText = `Diet Mate 사진 ${selectedUrls.length}개\n\n${selectedUrls.join('\n')}`;

                await navigator.share({
                    title: 'Diet Mate 사진',
                    text: shareText
                });

                console.log('공유 성공');
                cancelSelectMode();
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('공유 오류:', error);
                    alert('공유 중 오류가 발생했습니다.');
                }
            }
        }

        // 선택 모드 취소
        function cancelSelectMode() {
            isSelectMode = false;
            selectedItems.clear();

            const selectModeBtn = document.getElementById('selectModeBtn');
            const selectActionBar = document.getElementById('selectActionBar');

            selectModeBtn.classList.remove('active');
            selectModeBtn.textContent = '선택';
            selectActionBar.classList.add('hidden');

            // 앨범 재렌더링
            loadAlbumTab();
            updateSelectedCount();
        }

        async function addPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // 파일 크기 검증 (10MB 제한)
                const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
                if (file.size > MAX_FILE_SIZE) {
                    showErrorToast('파일 크기는 10MB 이하여야 합니다.');
                    return;
                }

                const category = prompt('카테고리를 선택하세요:\n1. 눈바디 (body)\n2. 식단 (food)\n3. 운동 (exercise)');
                let categoryValue = 'body';
                if (category === '2' || category.includes('식단')) categoryValue = 'food';
                else if (category === '3' || category.includes('운동')) categoryValue = 'exercise';

                try {
                    const timestamp = Date.now();
                    const fileName = `${currentUser.uid}/${timestamp}_${file.name}`;
                    const storageRef = storage.ref().child(fileName);

                    // 파일 업로드
                    const snapshot = await storageRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();

                    // 식단인 경우 AI 영양 분석
                    let nutritionData = null;
                    if (categoryValue === 'food') {
                        try {
                            nutritionData = await analyzeNutritionFromImage(file, downloadURL);
                        } catch (error) {
                            console.error('영양 분석 실패:', error);
                            // 영양 분석 실패해도 사진은 저장
                        }
                    }

                    // Firestore에 메타데이터 저장
                    const photoData = {
                        url: downloadURL,
                        category: categoryValue,
                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        text: null
                    };

                    if (nutritionData) {
                        photoData.nutrition = nutritionData;
                    }

                    // 식단인 경우 스마트 병합 체크
                    if (categoryValue === 'food' && nutritionData) {
                        const recentMeal = await checkForRecentMeal(new Date());

                        if (recentMeal) {
                            // 최근 식사 발견 - 병합 Bottom Sheet 표시
                            showMergeBottomSheet(photoData, recentMeal);
                            return; // confirmMerge()나 createNewMeal()에서 처리
                        }
                    }

                    // 스마트 병합 대상이 아니거나 식단이 아닌 경우 바로 저장
                    await db.collection('users').doc(currentUser.uid)
                        .collection('photos').add(photoData);

                    // 앨범 새로고침
                    await loadAlbumTab();

                    // 식단인 경우 대시보드도 새로고침 및 AI 토스트 표시
                    if (categoryValue === 'food' && nutritionData) {
                        await refreshDashboardNutrition();

                        // 플랜과 비교 (선택적)
                        let toastMessage = nutritionData.aiAdvice || '식사가 기록되었어요!';
                        try {
                            const comparisonResult = await comparePlanWithMeal(new Date(), nutritionData);
                            if (comparisonResult) {
                                toastMessage = comparisonResult;
                            }
                        } catch (error) {
                            console.error('플랜 비교 실패:', error);
                        }

                        showAIToast(toastMessage, 6000);
                    } else {
                        showSuccessToast('사진이 추가되었습니다!');
                    }

                } catch (error) {
                    console.error('사진 업로드 실패:', error);

                    // Firebase Storage 에러 처리
                    if (error.code === 'storage/unauthorized') {
                        showErrorToast('업로드 권한이 없습니다.');
                    } else if (error.code === 'storage/canceled') {
                        showErrorToast('업로드가 취소되었습니다.');
                    } else {
                        showErrorToast('사진 업로드에 실패했습니다. 다시 시도해주세요.');
                    }
                }
            };
            input.click();
        }

        // 성공 토스트 메시지 (임시)
        function showSuccessToast(message) {
            console.log('✓ ' + message);
            // Phase 2에서 실제 토스트 UI 구현 예정
        }

        // 에러 토스트 메시지 (임시)
        function showErrorToast(message) {
            console.error('✗ ' + message);
            alert(message); // Phase 2에서 토스트 UI로 교체 예정
        }

        async function openPhotoModal(url, photoId) {
            // Phase 4: 현재 사진 데이터 가져오기 (카테고리 정보 필요)
            const photoDoc = await db.collection('users').doc(currentUser.uid)
                .collection('photos').doc(photoId).get();
            const photoData = photoDoc.data();
            const currentCategory = photoData ? photoData.category : null;

            // Phase 4: 식단 카테고리인 경우 "이전 식사와 합치기" 버튼 추가
            let mergeButtonHtml = '';
            if (currentCategory === 'food') {
                mergeButtonHtml = `<button class="photo-modal-btn" style="background: #9c27b0; color: white;" onclick="showManualMergeList('${photoId}')">이전 식사와 합치기</button>`;
            }

            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.innerHTML = `
                <div class="photo-modal-header">
                    <h3>사진 보기</h3>
                    <button style="background: none; border: none; color: white; font-size: 2rem; cursor: pointer;" onclick="this.closest('.photo-modal').remove()">×</button>
                </div>
                <div class="photo-modal-content">
                    <img src="${url}" class="photo-modal-image">
                </div>
                <div class="photo-modal-actions">
                    <button class="photo-modal-btn" style="background: #667eea; color: white;" onclick="downloadPhoto('${url}')">다운로드</button>
                    <button class="photo-modal-btn" style="background: #4caf50; color: white;" onclick="sharePhoto('${url}')">공유</button>
                    ${mergeButtonHtml}
                    <button class="photo-modal-btn" style="background: #ff9800; color: white;" onclick="showCategoryChangeModal('${photoId}', '${currentCategory}')">카테고리 변경</button>
                    <button class="photo-modal-btn" style="background: #f44336; color: white;" onclick="deletePhoto('${photoId}')">삭제</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function downloadPhoto(url) {
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diet_mate_photo.jpg';
            a.click();
        }

        async function sharePhoto(url) {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Diet Mate 사진',
                        text: '나의 다이어트 변화',
                        url: url
                    });
                } catch (error) {
                    console.error('공유 실패:', error);
                }
            } else {
                alert('이 브라우저는 공유 기능을 지원하지 않습니다.');
            }
        }

        async function deletePhoto(photoId) {
            if (!confirm('이 사진을 삭제하시겠습니까?')) return;

            await db.collection('users').doc(currentUser.uid)
                .collection('photos').doc(photoId).delete();

            document.querySelector('.photo-modal').remove();
            await loadAlbumTab();
        }

        // ==================== Phase 4: 카테고리 변경 함수들 ====================

        // 카테고리 변경 모달 표시
        function showCategoryChangeModal(photoId, currentCategory) {
            changingPhotoId = photoId;
            changingPhotoCurrentCategory = currentCategory;

            const overlay = document.getElementById('categoryChangeOverlay');
            const options = document.querySelectorAll('.category-option');

            // 현재 카테고리 강조
            options.forEach(option => {
                const category = option.dataset.category;
                if (category === currentCategory) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });

            // 모달 표시
            overlay.classList.remove('hidden');
        }

        // 카테고리 변경 확인
        async function changeCategoryConfirm(newCategory) {
            if (!changingPhotoId) {
                alert('오류: 변경할 항목을 찾을 수 없습니다.');
                closeCategoryModal();
                return;
            }

            // 같은 카테고리로 변경하려는 경우
            if (newCategory === changingPhotoCurrentCategory) {
                alert('이미 해당 카테고리입니다.');
                return;
            }

            try {
                // Firestore에서 현재 사진 데이터 가져오기
                const photoDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('photos').doc(changingPhotoId).get();
                const photoData = photoDoc.data();

                // 식단 → 다른 카테고리: 영양 데이터 손실 경고
                if (changingPhotoCurrentCategory === 'food' && photoData.nutrition) {
                    if (!confirm('식단 카테고리에서 이동하면 영양 정보가 대시보드에서 제외됩니다. 계속하시겠습니까?')) {
                        return;
                    }
                }

                // 다른 카테고리 → 식단: AI 재분석 필요 여부 확인
                if (newCategory === 'food' && changingPhotoCurrentCategory !== 'food') {
                    if (photoData.url && !photoData.nutrition) {
                        // 이미지가 있지만 영양 정보가 없는 경우 - AI 재분석 제안
                        const reanalyze = confirm('식단 카테고리로 이동합니다. AI 영양 분석을 실행하시겠습니까?');
                        if (reanalyze) {
                            // AI 영양 분석 실행 (기존 analyzeNutritionFromImage 사용)
                            alert('영양 분석은 앨범에서 사진을 다시 업로드해주세요.');
                        }
                    }
                }

                // 카테고리 변경 실행
                await db.collection('users').doc(currentUser.uid)
                    .collection('photos').doc(changingPhotoId).update({
                        category: newCategory
                    });

                alert('카테고리가 변경되었습니다.');

                // 모달들 닫기
                closeCategoryModal();
                const photoModal = document.querySelector('.photo-modal');
                if (photoModal) photoModal.remove();

                // 앨범 새로고침
                await loadAlbumTab();

                // 대시보드 새로고침 (영양 정보 변경 시)
                if (changingPhotoCurrentCategory === 'food' || newCategory === 'food') {
                    if (typeof loadNutritionDashboard === 'function') {
                        await loadNutritionDashboard();
                    }
                }
            } catch (error) {
                console.error('카테고리 변경 오류:', error);
                alert('카테고리 변경 중 오류가 발생했습니다.');
            }
        }

        // 카테고리 변경 모달 닫기
        function closeCategoryModal() {
            const overlay = document.getElementById('categoryChangeOverlay');
            overlay.classList.add('hidden');
            changingPhotoId = null;
            changingPhotoCurrentCategory = null;
        }

        // ==================== Phase 4: 수동 병합 함수들 ====================

        // 수동 병합 모달 표시 및 식사 목록 로드
        async function showManualMergeList(currentPhotoId) {
            mergingSourceId = currentPhotoId;

            const overlay = document.getElementById('manualMergeOverlay');
            overlay.classList.remove('hidden');

            // 식사 목록 로드
            await loadRecentMeals(30, currentPhotoId);
        }

        // 최근 식사 목록 로드 (최근 30일)
        async function loadRecentMeals(limit = 30, excludeId = null) {
            const mealListDiv = document.getElementById('mealList');
            mealListDiv.innerHTML = '<div class="meal-list-loading">불러오는 중...</div>';

            try {
                // 30일 전 날짜 계산
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                // Firestore에서 최근 30일 식단 조회
                const mealsSnapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('category', '==', 'food')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
                    .orderBy('uploadedAt', 'desc')
                    .limit(50) // 최대 50개까지 로드
                    .get();

                if (mealsSnapshot.empty) {
                    mealListDiv.innerHTML = '<div class="meal-list-empty">최근 30일 내 식사 기록이 없습니다.</div>';
                    return;
                }

                // 식사 목록 렌더링
                mealListDiv.innerHTML = '';
                let count = 0;

                mealsSnapshot.forEach(doc => {
                    // 현재 항목은 제외
                    if (doc.id === excludeId) return;

                    const meal = doc.data();
                    const mealId = doc.id;

                    // 영양 정보가 없으면 스킵
                    if (!meal.nutrition) return;

                    // 날짜 포맷팅
                    const uploadDate = meal.uploadedAt.toDate();
                    const dateStr = uploadDate.toLocaleDateString('ko-KR');
                    const timeStr = uploadDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                    const mealItem = document.createElement('div');
                    mealItem.className = 'meal-list-item';
                    mealItem.onclick = () => confirmManualMerge(mergingSourceId, mealId);

                    mealItem.innerHTML = `
                        <div class="meal-item-header">
                            <span class="meal-item-date">${dateStr}</span>
                            <span class="meal-item-time">${timeStr}</span>
                        </div>
                        <div class="meal-item-name">${meal.nutrition.foodName || '식사'}</div>
                        <div class="meal-item-calories">${Math.round(meal.nutrition.calories)}kcal</div>
                    `;

                    mealListDiv.appendChild(mealItem);
                    count++;

                    if (count >= limit) return;
                });

                // 항목이 하나도 렌더링되지 않은 경우
                if (count === 0) {
                    mealListDiv.innerHTML = '<div class="meal-list-empty">병합 가능한 식사가 없습니다.<br/>(영양 정보가 있는 식사만 병합 가능합니다)</div>';
                }
            } catch (error) {
                console.error('식사 목록 로드 오류:', error);
                mealListDiv.innerHTML = '<div class="meal-list-empty">식사 목록을 불러오는 중 오류가 발생했습니다.</div>';
            }
        }

        // 수동 병합 확인 및 실행
        async function confirmManualMerge(sourceId, targetId) {
            if (!sourceId || !targetId) {
                alert('오류: 병합할 항목을 찾을 수 없습니다.');
                return;
            }

            // 확인 메시지
            if (!confirm('선택한 식사와 병합하시겠습니까?\n\n현재 식사의 영양 정보가 선택한 식사에 합산되고, 현재 식사는 삭제됩니다.')) {
                return;
            }

            try {
                // 두 식사 데이터 가져오기
                const sourceDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('photos').doc(sourceId).get();
                const targetDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('photos').doc(targetId).get();

                const sourceData = sourceDoc.data();
                const targetData = targetDoc.data();

                // 영양 정보가 없으면 병합 불가
                if (!sourceData.nutrition || !targetData.nutrition) {
                    alert('영양 정보가 없는 항목은 병합할 수 없습니다.');
                    return;
                }

                // 영양 정보 합산
                const mergedNutrition = {
                    calories: (targetData.nutrition.calories || 0) + (sourceData.nutrition.calories || 0),
                    carbs: (targetData.nutrition.carbs || 0) + (sourceData.nutrition.carbs || 0),
                    protein: (targetData.nutrition.protein || 0) + (sourceData.nutrition.protein || 0),
                    fat: (targetData.nutrition.fat || 0) + (sourceData.nutrition.fat || 0),
                    foodName: `${targetData.nutrition.foodName} + ${sourceData.nutrition.foodName}`,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `병합된 식사 (${Math.round((targetData.nutrition.calories || 0) + (sourceData.nutrition.calories || 0))}kcal)`
                };

                // 텍스트도 연결
                let mergedText = targetData.text || '';
                if (sourceData.text) {
                    mergedText = mergedText ? `${mergedText} + ${sourceData.text}` : sourceData.text;
                }

                // target 업데이트
                await db.collection('users').doc(currentUser.uid)
                    .collection('photos').doc(targetId).update({
                        nutrition: mergedNutrition,
                        text: mergedText || null
                    });

                // source 삭제
                await db.collection('users').doc(currentUser.uid)
                    .collection('photos').doc(sourceId).delete();

                alert('식사가 성공적으로 병합되었습니다.');

                // 모달들 닫기
                closeManualMergeModal();
                const photoModal = document.querySelector('.photo-modal');
                if (photoModal) photoModal.remove();

                // 앨범 새로고침
                await loadAlbumTab();

                // 대시보드 새로고침
                if (typeof loadNutritionDashboard === 'function') {
                    await loadNutritionDashboard();
                }
            } catch (error) {
                console.error('병합 오류:', error);
                alert('식사 병합 중 오류가 발생했습니다.');
            }
        }

        // 수동 병합 모달 닫기
        function closeManualMergeModal() {
            const overlay = document.getElementById('manualMergeOverlay');
            overlay.classList.add('hidden');
            mergingSourceId = null;
        }

        // ==================== 캘린더 탭 ====================
        async function loadCalendar() {
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            document.getElementById('calendarMonth').textContent = `${year}년 ${month + 1}월`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            // 빈 칸
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                calendarDays.appendChild(emptyDay);
            }

            // 날짜들
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day;

                const currentDate = new Date(year, month, day);
                const dateStr = currentDate.toISOString().split('T')[0];

                if (currentDate.toDateString() === today.toDateString()) {
                    dayDiv.classList.add('today');
                }

                if (currentDate > today) {
                    dayDiv.classList.add('future');
                } else {
                    dayDiv.onclick = () => showDayReport(dateStr);
                    // 데이터가 있는지 확인 (간단 버전)
                    checkDayData(dateStr).then(hasData => {
                        if (hasData) dayDiv.classList.add('has-data');
                    });
                }

                calendarDays.appendChild(dayDiv);
            }
        }

        async function checkDayData(dateStr) {
            const weights = await db.collection('users').doc(currentUser.uid)
                .collection('weights')
                .where('date', '>=', firebase.firestore.Timestamp.fromDate(new Date(dateStr)))
                .where('date', '<', firebase.firestore.Timestamp.fromDate(new Date(new Date(dateStr).getTime() + 86400000)))
                .limit(1)
                .get();

            return !weights.empty;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        async function showDayReport(dateStr) {
            const date = new Date(dateStr);

            // 해당 날짜의 데이터 수집
            const weights = await db.collection('users').doc(currentUser.uid)
                .collection('weights')
                .where('date', '>=', firebase.firestore.Timestamp.fromDate(date))
                .where('date', '<', firebase.firestore.Timestamp.fromDate(new Date(date.getTime() + 86400000)))
                .get();

            const plans = await db.collection('users').doc(currentUser.uid)
                .collection('plans')
                .where('date', '==', dateStr)
                .get();

            const photos = await db.collection('users').doc(currentUser.uid)
                .collection('photos')
                .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(date))
                .where('uploadedAt', '<', firebase.firestore.Timestamp.fromDate(new Date(date.getTime() + 86400000)))
                .get();

            // 모달 생성
            const modal = document.createElement('div');
            modal.className = 'day-report-modal';

            let content = `
                <div class="day-report-content">
                    <div class="day-report-header">${date.getMonth() + 1}월 ${date.getDate()}일 리포트</div>
            `;

            // 체중
            if (!weights.empty) {
                const weight = weights.docs[0].data().weight;
                content += `
                    <div class="day-report-section">
                        <h4>⚖️ 체중</h4>
                        <p>${weight}kg</p>
                    </div>
                `;
            }

            // 플랜
            if (!plans.empty) {
                content += `<div class="day-report-section"><h4>📋 플랜</h4>`;
                plans.forEach(doc => {
                    const plan = doc.data();
                    content += `<p>${plan.time} - ${plan.activity}</p>`;
                });
                content += `</div>`;
            }

            // 사진
            if (!photos.empty) {
                content += `<div class="day-report-section"><h4>📸 사진</h4><div style="display: flex; gap: 10px; flex-wrap: wrap;">`;
                photos.forEach(doc => {
                    const photo = doc.data();
                    content += `<img src="${photo.url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px;">`;
                });
                content += `</div></div>`;
            }

            if (weights.empty && plans.empty && photos.empty) {
                content += `<p style="text-align: center; color: #999; padding: 40px;">이 날의 기록이 없습니다.</p>`;
            }

            content += `
                    <button class="modal-btn modal-btn-primary" onclick="this.closest('.day-report-modal').remove()">닫기</button>
                </div>
            `;

            modal.innerHTML = content;
            document.body.appendChild(modal);
        }

        // ==================== 소통 탭 ====================
        async function loadCommunityMessages() {
            db.collection('community')
                .orderBy('timestamp', 'asc')
                .limit(50)
                .onSnapshot(snapshot => {
                    const container = document.getElementById('chatContainer');
                    container.innerHTML = '';

                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const msgDiv = document.createElement('div');
                        msgDiv.className = 'chat-message';

                        if (msg.userId === currentUser.uid) {
                            msgDiv.classList.add('mine');
                        }

                        const timestamp = msg.timestamp ? msg.timestamp.toDate() : new Date();
                        const timeStr = `${timestamp.getFullYear()}-${String(timestamp.getMonth() + 1).padStart(2, '0')}-${String(timestamp.getDate()).padStart(2, '0')} ${String(timestamp.getHours()).padStart(2, '0')}:${String(timestamp.getMinutes()).padStart(2, '0')}`;

                        msgDiv.innerHTML = `
                            <div class="message-header">
                                <span class="message-author">${msg.userName}</span>
                                <span class="message-time">${timeStr}</span>
                            </div>
                            <div class="message-bubble">${msg.message}</div>
                        `;

                        container.appendChild(msgDiv);
                    });

                    container.scrollTop = container.scrollHeight;
                });
        }

        async function sendCommunityMessage() {
            const input = document.getElementById('communityInput');
            const message = input.value.trim();

            if (!message) return;

            await db.collection('community').add({
                userId: currentUser.uid,
                userName: currentProfile.name,
                message: message,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            input.value = '';
        }

        // ==================== 알림 탭 ====================
        function loadNotifications() {
            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            const list = document.getElementById('notificationList');
            list.innerHTML = '';

            if (notifications.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">설정된 알림이 없습니다.</p>';
                return;
            }

            notifications.forEach((notif, index) => {
                const notifDiv = document.createElement('div');
                notifDiv.className = 'notification-item';
                notifDiv.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-title">${notif.title}</div>
                        <div class="notification-details">${notif.time} - ${notif.repeat}</div>
                    </div>
                    <div class="notification-delete" onclick="deleteNotification(${index})">🗑️</div>
                `;
                list.appendChild(notifDiv);
            });
        }

        function openAddNotificationModal() {
            const title = prompt('알림 내용을 입력하세요 (예: 물 마시기)');
            if (!title) return;

            const time = prompt('알림 시간을 입력하세요 (예: 09:00)');
            if (!time) return;

            const repeat = prompt('반복 간격을 선택하세요\n1. 매일\n2. 매주\n3. 한 번만');
            let repeatValue = '매일';
            if (repeat === '2') repeatValue = '매주';
            else if (repeat === '3') repeatValue = '한 번만';

            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            notifications.push({
                title: title,
                time: time,
                repeat: repeatValue,
                lastTriggered: null
            });

            localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
            loadNotifications();
        }

        function deleteNotification(index) {
            if (!confirm('이 알림을 삭제하시겠습니까?')) return;

            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            notifications.splice(index, 1);
            localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
            loadNotifications();
        }

        function startNotificationCheck() {
            // 알림 권한 요청
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            // 1분마다 알림 체크
            notificationCheckInterval = setInterval(() => {
                checkAndTriggerNotifications();
            }, 60000);

            checkAndTriggerNotifications();
        }

        function checkAndTriggerNotifications() {
            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            notifications.forEach((notif, index) => {
                if (notif.time === currentTime) {
                    const lastTriggered = notif.lastTriggered ? new Date(notif.lastTriggered) : null;

                    let shouldTrigger = false;
                    if (!lastTriggered) {
                        shouldTrigger = true;
                    } else if (notif.repeat === '매일') {
                        const daysDiff = Math.floor((now - lastTriggered) / (1000 * 60 * 60 * 24));
                        if (daysDiff >= 1) shouldTrigger = true;
                    } else if (notif.repeat === '매주') {
                        const daysDiff = Math.floor((now - lastTriggered) / (1000 * 60 * 60 * 24));
                        if (daysDiff >= 7) shouldTrigger = true;
                    }

                    if (shouldTrigger) {
                        // 브라우저 알림
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification('Diet Mate', {
                                body: notif.title,
                                icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ctext x="50" y="70" font-size="60" text-anchor="middle"%3E💪%3C/text%3E%3C/svg%3E'
                            });
                        }

                        // 인앱 알림 (간단한 alert - 실제로는 커스텀 UI 사용 권장)
                        if (currentTab === 'notification') {
                            alert(`⏰ ${notif.title}`);
                        }

                        // 마지막 트리거 시간 업데이트
                        notifications[index].lastTriggered = now.toISOString();
                        localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
                    }
                }
            });
        }

        // ==================== 설정 탭 ====================
        async function loadSettings() {
            // 함께한 날 계산
            const createdAt = currentProfile.createdAt ? currentProfile.createdAt.toDate() : new Date();
            const daysSince = Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24));
            document.getElementById('totalDays').textContent = daysSince;

            // 총 운동 시간 (플랜에서 운동 카테고리 합산 - 간단 버전)
            document.getElementById('totalExercise').textContent = '0';

            // 절약 칼로리 (간단 계산)
            const startWeight = currentProfile.startWeight || 0;
            const weightData = await db.collection('users').doc(currentUser.uid)
                .collection('weights').orderBy('date', 'desc').limit(1).get();

            const currentWeight = weightData.empty ? startWeight : weightData.docs[0].data().weight;
            const weightLost = startWeight - currentWeight;
            const caloriesSaved = Math.floor(weightLost * 7700); // 1kg = 약 7700kcal
            document.getElementById('totalCalories').textContent = caloriesSaved > 0 ? caloriesSaved : 0;

            // AI 예측 달성일 (간단 버전)
            const goalWeight = currentProfile.goalWeight || 0;
            const remaining = currentWeight - goalWeight;

            if (remaining > 0 && weightLost > 0 && daysSince > 0) {
                const avgLossPerDay = weightLost / daysSince;
                const daysNeeded = Math.ceil(remaining / avgLossPerDay);
                const predictedDate = new Date();
                predictedDate.setDate(predictedDate.getDate() + daysNeeded);
                document.getElementById('predictedDate').textContent = `${predictedDate.getMonth() + 1}/${predictedDate.getDate()}`;
            } else {
                document.getElementById('predictedDate').textContent = '-';
            }
        }

        async function exportData() {
            try {
                const data = {
                    profile: currentProfile,
                    weights: [],
                    plans: [],
                    photos: []
                };

                const weights = await db.collection('users').doc(currentUser.uid).collection('weights').get();
                weights.forEach(doc => data.weights.push({ id: doc.id, ...doc.data() }));

                const plans = await db.collection('users').doc(currentUser.uid).collection('plans').get();
                plans.forEach(doc => data.plans.push({ id: doc.id, ...doc.data() }));

                const photos = await db.collection('users').doc(currentUser.uid).collection('photos').get();
                photos.forEach(doc => data.photos.push({ id: doc.id, ...doc.data() }));

                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `diet_mate_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();

                URL.revokeObjectURL(url);
                alert('데이터 내보내기 완료!');
            } catch (error) {
                console.error('내보내기 실패:', error);
                alert('데이터 내보내기에 실패했습니다.');
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    if (!confirm('기존 데이터를 덮어쓰시겠습니까? (취소하면 병합됩니다)')) {
                        // 병합 모드
                        alert('병합 기능은 현재 구현 중입니다. 데이터를 덮어씁니다.');
                    }

                    // 체중 데이터 복원
                    for (const weight of data.weights) {
                        const { id, ...weightData } = weight;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('weights').add(weightData);
                    }

                    // 플랜 데이터 복원
                    for (const plan of data.plans) {
                        const { id, ...planData } = plan;
                        await db.collection('users').doc(currentUser.uid)
                            .collection('plans').add(planData);
                    }

                    alert('데이터 가져오기 완료! 페이지를 새로고침합니다.');
                    location.reload();
                } catch (error) {
                    console.error('가져오기 실패:', error);
                    alert('데이터 가져오기에 실패했습니다.');
                }
            };
            input.click();
        }

        // ==================== PWA 기능 ====================
        function initializePWA() {
            // PWA 설치 프롬프트 감지
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;

                const installed = localStorage.getItem(LS_KEYS.PWA_INSTALLED);
                if (!installed) {
                    document.getElementById('pwaInstallBanner').classList.remove('hidden');
                }
            });

            // 설치 완료 감지
            window.addEventListener('appinstalled', () => {
                localStorage.setItem(LS_KEYS.PWA_INSTALLED, 'true');
                document.getElementById('pwaInstallBanner').classList.add('hidden');
                deferredPrompt = null;
            });
        }

        async function installPWA() {
            if (!deferredPrompt) {
                alert('이 브라우저는 PWA 설치를 지원하지 않습니다.');
                return;
            }

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                localStorage.setItem(LS_KEYS.PWA_INSTALLED, 'true');
                document.getElementById('pwaInstallBanner').classList.add('hidden');
            }

            deferredPrompt = null;
        }

        // ==================== 초기 실행 ====================
        // Firebase Auth State Listener가 자동으로 초기화 시작
    </script>

    <!-- AI 토스트 팝업 -->
    <div id="aiToast" class="ai-toast hidden">
        <div class="ai-toast-content">
            <div class="ai-toast-icon">🤖</div>
            <div class="ai-toast-message" id="aiToastMessage">AI 코치가 분석 중이에요...</div>
        </div>
        <button class="ai-toast-button" onclick="openAIChatFromToast()">
            코치에게 질문하기
        </button>
    </div>

    <!-- 스마트 병합 Bottom Sheet -->
    <div id="mergeBottomSheet" class="merge-overlay hidden">
        <div class="merge-sheet">
            <div class="merge-header">
                <h3>🤔 이전 식사와 합칠까요?</h3>
                <p class="merge-subtitle">3시간 이내에 비슷한 식사가 있어요</p>
            </div>
            <div class="merge-content">
                <div class="merge-preview">
                    <div class="merge-meal previous-meal">
                        <div class="meal-label">이전 식사</div>
                        <div class="meal-name" id="previousMealName">-</div>
                        <div class="meal-calories" id="previousMealCal">0kcal</div>
                    </div>
                    <div class="merge-plus">+</div>
                    <div class="merge-meal current-meal">
                        <div class="meal-label">방금 추가한 식사</div>
                        <div class="meal-name" id="currentMealName">-</div>
                        <div class="meal-calories" id="currentMealCal">0kcal</div>
                    </div>
                </div>
                <div class="merge-total">
                    <span>합계:</span>
                    <span id="mergeTotal" class="total-calories">0kcal</span>
                </div>
            </div>
            <div class="merge-actions">
                <button class="merge-btn merge-confirm" onclick="confirmMerge()">
                    합치기
                </button>
                <button class="merge-btn merge-cancel" onclick="createNewMeal()">
                    따로 저장
                </button>
            </div>
        </div>
    </div>

    <!-- Phase 4: 카테고리 변경 모달 -->
    <div class="category-change-overlay hidden" id="categoryChangeOverlay" onclick="closeCategoryModal()">
        <div class="category-change-modal" onclick="event.stopPropagation()">
            <div class="category-modal-header">
                <h3>카테고리 변경</h3>
                <button class="modal-close-btn" onclick="closeCategoryModal()">×</button>
            </div>
            <div class="category-modal-content">
                <p class="category-modal-description">이 항목을 어느 카테고리로 이동하시겠습니까?</p>
                <div class="category-options" id="categoryOptions">
                    <button class="category-option" data-category="body" onclick="changeCategoryConfirm('body')">
                        <span class="category-emoji">💪</span>
                        <span class="category-name">눈바디</span>
                    </button>
                    <button class="category-option" data-category="food" onclick="changeCategoryConfirm('food')">
                        <span class="category-emoji">🍽️</span>
                        <span class="category-name">식단</span>
                    </button>
                    <button class="category-option" data-category="exercise" onclick="changeCategoryConfirm('exercise')">
                        <span class="category-emoji">🏃‍♂️</span>
                        <span class="category-name">운동</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 4: 수동 병합 - 식사 선택 모달 -->
    <div class="manual-merge-overlay hidden" id="manualMergeOverlay" onclick="closeManualMergeModal()">
        <div class="manual-merge-sheet" onclick="event.stopPropagation()">
            <div class="manual-merge-header">
                <h3>이전 식사 선택</h3>
                <button class="modal-close-btn" onclick="closeManualMergeModal()">×</button>
            </div>
            <p class="manual-merge-description">병합할 이전 식사를 선택하세요 (최근 30일)</p>
            <div class="meal-list" id="mealList">
                <!-- 식사 목록이 여기에 동적으로 생성됨 -->
                <div class="meal-list-loading">불러오는 중...</div>
            </div>
        </div>
    </div>
</body>
</html>
