<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="AI ì½”ì¹˜ì™€ í•¨ê»˜í•˜ëŠ” ìŠ¤ë§ˆíŠ¸ ë‹¤ì´ì–´íŠ¸ ê´€ë¦¬ ì•±">
    
    <!-- ğŸ”¥ ìºì‹œ ë°©ì§€ (v3.4.3) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>Diet Mate v3.4.3 - ìŠ¤ë§ˆíŠ¸ ë‹¤ì´ì–´íŠ¸ ë§¤ë‹ˆì €</title>

    <!-- PWA Manifest (ë¡œì»¬ íŒŒì¼ì—ì„œëŠ” CORS ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ì¡°ê±´ë¶€ ë¡œë“œ) -->
    <script>
        // showAuth í•¨ìˆ˜ë¥¼ ì¦‰ì‹œ ì „ì—­ì— ì •ì˜ (HTML onclick ì´ë²¤íŠ¸ìš©)
        window.showAuth = function() {
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('auth').classList.remove('hidden');
        };
        
        // manifest.json ì¡°ê±´ë¶€ ë¡œë“œ
        if (window.location.protocol !== 'file:') {
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = 'manifest.json';
            document.head.appendChild(link);
        }
    </script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <style>
        /* ==================== CSS ë³€ìˆ˜ (ë””ìì¸ ì‹œìŠ¤í…œ) ==================== */
        :root {
            /* === ì£¼ìš” ìƒ‰ìƒ (ë¯¼íŠ¸/ì²­ë¡ í…Œë§ˆ) === */
            --primary: #00B89A;              /* ë©”ì¸ ë¯¼íŠ¸ */
            --primary-dark: #009688;         /* ì§„í•œ ì²­ë¡ */
            --primary-light: #00D4AA;        /* ë°ì€ ë¯¼íŠ¸ */
            --secondary: #26A69A;            /* ì„¸ì»¨ë”ë¦¬ ì²­ë¡ */
            --accent: #00E5CC;               /* ì•¡ì„¼íŠ¸ ë¯¼íŠ¸ */
            --accent-secondary: #4DD0E1;     /* ì•¡ì„¼íŠ¸ ì‹œì•ˆ */

            /* === ê·¸ë¼ë°ì´ì…˜ ì¡°í•©ìš© ë³´ì¡° ìƒ‰ìƒ === */
            --gradient-teal: #009688;        /* ì²­ë¡ */
            --gradient-cyan: #00BCD4;        /* ì‹œì•ˆ */
            --gradient-blue: #2196F3;        /* íŒŒë‘ */
            --gradient-purple: #9C27B0;      /* ë³´ë¼ */
            --gradient-pink: #E91E63;        /* í•‘í¬ */
            --gradient-lime: #7CB342;        /* ë¼ì„ */

            /* === ìƒíƒœ ìƒ‰ìƒ (ë¯¼íŠ¸ ê³„ì—´ ì¬ì¡°ì •) === */
            --success: #00C853;              /* ë°ì€ ê·¸ë¦° */
            --success-light: #69F0AE;        /* ì—°í•œ ê·¸ë¦° */
            --success-dark: #00A044;         /* ì§„í•œ ê·¸ë¦° */
            --warning: #FFA726;              /* ì˜¤ë Œì§€ */
            --warning-light: #FFB74D;        /* ë°ì€ ì˜¤ë Œì§€ */
            --error: #EF5350;                /* ë ˆë“œ */
            --error-light: #FF8A80;          /* ì—°í•œ ë ˆë“œ */
            --info: #00BCD4;                 /* ì‹œì•ˆ (ì²­ë¡ ê³„ì—´) */
            --info-light: #4DD0E1;           /* ë°ì€ ì‹œì•ˆ */

            /* === ì¤‘ë¦½ ìƒ‰ìƒ (ë™ì¼ ìœ ì§€) === */
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fafafa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border: #e0e0e0;
            --border-light: #f0f0f0;

            /* === ê·¸ë¦¼ì (ë¯¼íŠ¸/ì²­ë¡ ê³„ì—´ ì¶”ê°€) === */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 12px 40px rgba(0, 0, 0, 0.15);
            --shadow-primary: 0 4px 16px rgba(0, 184, 154, 0.35);      /* ë¯¼íŠ¸ ê¸€ë¡œìš° */
            --shadow-secondary: 0 4px 16px rgba(38, 166, 154, 0.35);   /* ì²­ë¡ ê¸€ë¡œìš° */
            --shadow-success: 0 4px 12px rgba(0, 200, 83, 0.3);        /* ê·¸ë¦° ê¸€ë¡œìš° */
            --shadow-glow: 0 0 20px rgba(0, 212, 170, 0.5);            /* ê°•í•œ ê¸€ë¡œìš° íš¨ê³¼ */

            /* === ë‘¥ê·¼ ëª¨ì„œë¦¬ (ê°ì§„ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½) === */
            --radius-xs: 4px;                /* ë§¤ìš° ì‘ìŒ */
            --radius-sm: 6px;                /* ì‘ìŒ */
            --radius-md: 8px;                /* ì¤‘ê°„ (ê¸°ë³¸) */
            --radius-lg: 8px;                /* í¼ (8px ê³ ì •) */
            --radius-xl: 8px;                /* ë§¤ìš° í¼ (8px ê³ ì •) */
            --radius-full: 9999px;           /* ì›í˜• (í”„ë¡œí•„ ë“±ì—ë§Œ ì‚¬ìš©) */

            /* === ì‚¬ì´ë“œë°” ê´€ë ¨ ë³€ìˆ˜ (ì‹ ê·œ) === */
            --sidebar-width: 260px;          /* ë°ìŠ¤í¬íƒ‘ ì‚¬ì´ë“œë°” ë„ˆë¹„ */
            --sidebar-collapsed-width: 70px; /* ì ‘íŒ ì‚¬ì´ë“œë°” ë„ˆë¹„ */
            --sidebar-bg: #ffffff;           /* ì‚¬ì´ë“œë°” ë°°ê²½ */
            --sidebar-border: #e0e0e0;       /* ì‚¬ì´ë“œë°” í…Œë‘ë¦¬ */

            /* === ê°„ê²© (ë™ì¼ ìœ ì§€) === */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* === ì „í™˜ íš¨ê³¼ (ë™ì¼ ìœ ì§€) === */
            --transition-fast: 0.15s ease;
            --transition-base: 0.25s ease;
            --transition-slow: 0.35s ease;

            /* === Z-index (ì‚¬ì´ë“œë°” ì¶”ê°€) === */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-sidebar: 1025;               /* ì‹ ê·œ: ì‚¬ì´ë“œë°” */
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
        }

        /* ==================== í…Œë§ˆ ì‹œìŠ¤í…œ ==================== */
        /* ë‹¤í¬ ëª¨ë“œ */
        [data-theme="dark"] {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #1a202c;
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --text-tertiary: #a0aec0;
            --border: #4a5568;
            --border-light: #2d3748;
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        /* ì†Œí”„íŠ¸ íŒŒìŠ¤í…” */
        [data-theme="pastel"] {
            --primary: #ff9a9e;
            --primary-dark: #fbc2eb;
            --primary-light: #ffeaa7;
            --bg-primary: #fef6f6;
            --bg-secondary: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
        }

        /* í•˜ì´ ì»¨íŠ¸ë¼ìŠ¤íŠ¸ */
        [data-theme="high-contrast"] {
            --primary: #0066cc;
            --primary-dark: #004499;
            --primary-light: #3399ff;
            --bg-primary: #ffffff;
            --bg-secondary: #f0f4f8;
            --text-primary: #000000;
            --text-secondary: #333333;
            --border: #0066cc;
        }

        /* ==================== í™”ë ¤í•œ ê·¸ë¼ë°ì´ì…˜ í”„ë¦¬ì…‹ ==================== */
        /* ë¯¼íŠ¸ â†’ ì‹œì•ˆ â†’ íŒŒë‘ (ë©”ì¸ ê·¸ë¼ë°ì´ì…˜) */
        .gradient-vibrant-1 {
            background: linear-gradient(135deg, #00D4AA 0%, #00BCD4 50%, #2196F3 100%);
        }

        /* ì²­ë¡ â†’ ë¯¼íŠ¸ â†’ ë¼ì„ (ìƒë™ê°) */
        .gradient-vibrant-2 {
            background: linear-gradient(135deg, #009688 0%, #00B89A 50%, #7CB342 100%);
        }

        /* ë¯¼íŠ¸ â†’ ì‹œì•ˆ â†’ ë³´ë¼ (ëŒ€ë‹´í•œ) */
        .gradient-vibrant-3 {
            background: linear-gradient(135deg, #00E5CC 0%, #00BCD4 50%, #9C27B0 100%);
        }

        /* ì²­ë¡ â†’ í•‘í¬ (ê³¼ê°í•œ ëŒ€ë¹„) */
        .gradient-vibrant-4 {
            background: linear-gradient(135deg, #26A69A 0%, #E91E63 100%);
        }

        /* ë¯¼íŠ¸ â†’ íŒŒë‘ (ë¶€ë“œëŸ¬ìš´ ìƒë™ê°) */
        .gradient-vibrant-5 {
            background: linear-gradient(135deg, #00B89A 0%, #2196F3 100%);
        }

        /* ë¯¼íŠ¸ â†’ ì²­ë¡ (í”„ë¼ì´ë¨¸ë¦¬ ê·¸ë¼ë°ì´ì…˜) */
        .gradient-primary {
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
        }

        /* ì„œë¸Œí‹€í•œ ê·¸ë¼ë°ì´ì…˜ (ì¹´ë“œ ë°°ê²½ìš©) */
        .gradient-subtle {
            background: linear-gradient(135deg, #f0fffc 0%, #e0f7f4 100%);
        }

        /* í…ìŠ¤íŠ¸ ê·¸ë¼ë°ì´ì…˜ */
        .text-gradient {
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ==================== ê¸°ë³¸ ìŠ¤íƒ€ì¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* ==================== ëœë”© í˜ì´ì§€ ==================== */
        .landing {
            min-height: 100vh;
            background: linear-gradient(135deg, #00D4AA 0%, #00BCD4 50%, #2196F3 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 20px;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .landing-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* ==================== ì¶”ê°€ ì• ë‹ˆë©”ì´ì…˜ ==================== */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* ì• ë‹ˆë©”ì´ì…˜ ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.4s ease-out;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out;
        }

        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }

        .animate-slide-down {
            animation: slideDown 0.3s ease-out;
        }

        .landing-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .landing-subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            margin-bottom: 50px;
            text-align: center;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: var(--radius-full);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--bg-secondary);
            color: var(--primary);
            box-shadow: var(--shadow-xl);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.25), var(--shadow-glow);
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            color: white;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-secondary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 184, 154, 0.4), var(--shadow-glow);
        }

        .btn-secondary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow-success);
        }

        .btn-success:hover {
            background: var(--success-light);
            transform: translateY(-2px);
        }

        .btn-success:active {
            transform: translateY(0) scale(0.98);
        }

        /* ==================== ì¸ì¦ í˜ì´ì§€ ==================== */
        .auth-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            background: white;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-logo-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            border-radius: 8px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .auth-title {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #666;
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            transition: all var(--transition-base);
            background: var(--bg-secondary);
        }

        .form-input:hover {
            border-color: var(--primary-light);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .error-message {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .link-text {
            text-align: center;
            margin-top: 20px;
            color: #667eea;
            cursor: pointer;
            font-weight: bold;
        }

        /* ==================== ëŒ€ì‹œë³´ë“œ ==================== */
        .dashboard {
            min-height: 100vh;
            padding-bottom: 80px;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #00D4AA 0%, #00BCD4 50%, #2196F3 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 5px 20px rgba(0, 184, 154, 0.3);
        }

        .header-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 20px;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            border: 1px solid transparent;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 212, 170, 0.25), var(--shadow-glow);
            border: 2px solid transparent;
            background-image:
                linear-gradient(white, white),
                linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            background-origin: border-box;
            background-clip: padding-box, border-box;
        }

        .card:active {
            transform: translateY(-2px) scale(0.99);
            box-shadow: var(--shadow-md);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--text-primary);
        }

        /* ==================== í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ (8ê°œ íƒ­) - ë°ìŠ¤í¬íƒ‘ì—ì„œ ìˆ¨ê¹€ ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: none; /* ì‚¬ì´ë“œë°”ë¡œ ëŒ€ì²´ */
            overflow-x: auto;
            padding: 12px 0;
            border-top: 1px solid #e0e0e0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            -webkit-overflow-scrolling: touch;
        }

        .bottom-nav::-webkit-scrollbar {
            height: 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
            padding: 5px 15px;
            min-width: 70px;
            flex-shrink: 0;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 0.7rem;
            font-weight: bold;
            white-space: nowrap;
        }

        /* ==================== ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ (ì‹ ê·œ) ==================== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #ffffff 0%, #f0fffc 100%);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            z-index: var(--z-sidebar);
            transition: transform var(--transition-base);
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 184, 154, 0.08);
        }

        /* ì‚¬ì´ë“œë°” í—¤ë” */
        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-light);
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            color: white;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .sidebar-logo-icon {
            font-size: 2rem;
            animation: pulse 2s infinite;
        }

        .sidebar-logo-text {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: -0.5px;
        }

        /* ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ */
        .sidebar-nav {
            flex: 1;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .nav-item-sidebar {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .nav-item-sidebar::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            transform: scaleY(0);
            transition: transform var(--transition-base);
        }

        .nav-item-sidebar:hover {
            background: linear-gradient(135deg, #f0fffc 0%, #e0f7f4 100%);
            color: var(--primary);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .nav-item-sidebar:hover::before {
            transform: scaleY(1);
        }

        .nav-item-sidebar.active {
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .nav-item-sidebar.active::before {
            transform: scaleY(1);
            background: white;
        }

        .nav-icon-sidebar {
            font-size: 1.5rem;
            min-width: 24px;
            transition: transform var(--transition-base);
        }

        .nav-item-sidebar:hover .nav-icon-sidebar {
            transform: scale(1.2) rotate(5deg);
        }

        .nav-item-sidebar.active .nav-icon-sidebar {
            transform: scale(1.15);
        }

        .nav-label-sidebar {
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
        }

        /* ì‚¬ì´ë“œë°” í‘¸í„° */
        .sidebar-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-light);
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, #f0fffc 0%, #e0f7f4 100%);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .sidebar-user:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .sidebar-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .sidebar-user-info {
            flex: 1;
        }

        .sidebar-user-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-user-status {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ (ì‚¬ì´ë“œë°”ë§Œí¼ ì™¼ìª½ ë§ˆì§„) */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: margin-left var(--transition-base);
        }

        /* ëª¨ë°”ì¼ í–„ë²„ê±° ë²„íŠ¼ */
        .mobile-menu-btn {
            display: none; /* ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ìˆ¨ê¹€ */
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: calc(var(--z-sidebar) + 1);
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: var(--radius-md);
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-primary);
            transition: all var(--transition-base);
            align-items: center;
            justify-content: center;
        }

        .mobile-menu-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-glow);
        }

        /* ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ (ëª¨ë°”ì¼) */
        .sidebar-overlay {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: calc(var(--z-sidebar) - 1);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* ==================== íƒ­ ì»¨í…ì¸  ==================== */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeInUp 0.4s ease-out;
        }

        /* ==================== í™ˆ íƒ­: ê±´ê°• ì§€í‘œ ==================== */
        .health-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .metric-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            border: 1px solid transparent;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }

        .metric-label {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }

        .metric-unit {
            font-size: 0.9rem;
            color: #999;
        }
        
        /* ì»´íŒ©íŠ¸ ë©”íŠ¸ë¦­ ìŠ¤íƒ€ì¼ */
        .health-metrics.compact {
            gap: 8px;
        }
        
        .metric-card.compact {
            padding: 12px 10px;
        }
        
        .metric-inline {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 2px;
        }
        
        .metric-value-sm {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
        }
        
        .metric-unit-sm {
            font-size: 0.65rem;
            color: #666;
        }
        
        .metric-date {
            font-size: 0.7rem;
            color: #999;
            margin-top: 2px;
        }

        .progress-section {
            background: linear-gradient(135deg, #009688 0%, #00B89A 50%, #7CB342 100%);
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            font-size: 0.85rem;
        }

        /* ì§„í–‰ë¥  ì„¹ì…˜ shimmer íš¨ê³¼ */
        .progress-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 3s infinite;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        /* í˜ì´ë“œì¸ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ìŠ¬ë¼ì´ë“œì¸ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ (ì¤‘ìš” ìš”ì†Œ ê°•ì¡°) */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .progress-bar-container {
            background: rgba(255,255,255,0.3);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: white;
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* ==================== í™ˆ íƒ­: AI ì±„íŒ… ==================== */
        .ai-chat-section {
            background: white;
            border-radius: 20px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .ai-chat-summary {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-summary:hover {
            background: #f8f9fa;
            border-radius: 20px;
        }

        .ai-chat-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .ai-chat-details.open {
            max-height: 500px;
        }

        .ai-chat-messages {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            border-top: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
        }

        .ai-message {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 12px;
            animation: slideIn 0.3s;
        }

        .ai-message.user {
            background: #667eea;
            color: white;
            margin-left: 20%;
        }

        .ai-message.assistant {
            background: #f5f5f5;
            color: #333;
            margin-right: 20%;
        }

        .ai-chat-input-area {
            padding: 15px;
            display: flex;
            gap: 10px;
        }

        .ai-chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
        }

        .ai-chat-send {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== í™ˆ íƒ­: ìŠ¤ë§ˆíŠ¸ ë¬¼ ë§ˆì‹œê¸° ==================== */
        .water-settings {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .water-settings input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }

        .unit-label {
            font-weight: bold;
            color: #667eea;
            font-size: 1rem;
        }

        /* [ìˆ˜ì •] ë¬¼ ë§ˆì‹œê¸° í™”ë©´ì´ í°ì—ì„œ ì˜ë¦¬ëŠ” ë¬¸ì œ í•´ê²° */
        .water-tracker {
            display: flex;
            flex-wrap: wrap;       /* ì¤„ë°”ê¿ˆ í—ˆìš© (ì´ê²Œ ì—†ì–´ì„œ ì˜ë¦° ê²ë‹ˆë‹¤) */
            gap: 10px;
            justify-content: center;
        }

        .water-cup {
            width: calc(25% - 10px);  /* í•œ ì¤„ì— 4ê°œ */
            aspect-ratio: 1;
            background: #e3f2fd;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 60px;  /* ìµœì†Œ ë„ˆë¹„ ë³´ì¥ */
        }

        .water-cup.filled {
            background: #2196f3;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        /* ==================== í™ˆ íƒ­: ì˜ì–‘ ëŒ€ì‹œë³´ë“œ ==================== */
        .nutrition-summary {
            text-align: center;
            font-size: 1rem;
            color: #666;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .nutrition-summary span {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .nutrition-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .nutrition-card:hover {
            transform: translateY(-3px);
        }

        .nutrition-calories {
            background: linear-gradient(135deg, #26A69A 0%, #E91E63 100%);
        }

        .nutrition-carbs {
            background: linear-gradient(135deg, #00B89A 0%, #2196F3 100%);
        }

        .nutrition-protein {
            background: linear-gradient(135deg, #00E5CC 0%, #00BCD4 50%, #9C27B0 100%);
        }

        .nutrition-fat {
            background: linear-gradient(135deg, #00D4AA 0%, #00BCD4 50%, #2196F3 100%);
        }

        .nutrition-label {
            font-size: 0.75rem;
            color: #555;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .nutrition-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }

        .nutrition-unit {
            font-size: 0.85rem;
            color: #666;
        }

        .nutrition-remaining {
            font-size: 0.75rem;
            color: #4caf50;
            margin-top: 4px;
            font-weight: 600;
        }

        .nutrition-remaining.over {
            color: #ff5252;
        }

        .nutrition-chart-container {
            max-width: 300px;
            margin: 0 auto;
            padding: 20px 0;
        }


        /* ì…ë ¥ ë°©ë²• ì„ íƒ ë²„íŠ¼ */
        .input-method-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .input-method-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .input-method-btn:active {
            transform: translateY(0);
        }

        /* ==================== ì‹ì‚¬ ì§ì ‘ ì…ë ¥ ë²„íŠ¼ ==================== */
        .meal-input-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0 20px 0;
        }

        .meal-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .meal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .meal-btn:active {
            transform: translateY(0);
        }

        .meal-emoji {
            font-size: 1.8rem;
        }

        .meal-label {
            font-weight: 600;
            color: #333;
        }

        .meal-btn-breakfast:hover {
            border-color: #ff9800;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        }

        .meal-btn-lunch:hover {
            border-color: #4caf50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }

        .meal-btn-dinner:hover {
            border-color: #9c27b0;
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        }

        .meal-btn-snack:hover {
            border-color: #f44336;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        /* ==================== ì‹ì‚¬ ì…ë ¥ ëª¨ë‹¬ ==================== */
        .meal-input-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal-backdrop);
            padding: 20px;
            transition: background var(--transition-base);
            backdrop-filter: blur(0px);
        }

        .meal-input-modal-overlay.show {
            display: flex;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            animation: overlayFadeIn 0.3s ease-out;
        }

        @keyframes overlayFadeIn {
            from {
                background: rgba(0, 0, 0, 0);
                backdrop-filter: blur(0px);
            }
            to {
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(4px);
            }
        }

        .meal-input-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .meal-input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .meal-input-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #333;
        }

        .meal-input-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group-meal {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label-meal {
            font-weight: 600;
            color: #555;
            font-size: 0.95rem;
        }

        .form-input-meal {
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all var(--transition-base);
            background: var(--bg-secondary);
        }

        .form-input-meal:hover {
            border-color: var(--primary-light);
        }

        .form-input-meal:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .ai-analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .ai-analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .ai-analyze-btn:active {
            transform: translateY(0);
        }

        .ai-analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .nutrition-result {
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f0 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .nutrition-result.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .nutrition-result-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .nutrition-result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .nutrition-result-item {
            background: white;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .nutrition-result-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .nutrition-result-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
        }

        .manual-input-toggle {
            text-align: center;
            margin-top: 15px;
            color: #667eea;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .manual-input-toggle:hover {
            text-decoration: underline;
        }

        .manual-input-fields {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .manual-input-fields.show {
            display: grid;
        }

        .save-meal-btn {
            background: var(--success);
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-base);
            margin-top: var(--spacing-lg);
            box-shadow: var(--shadow-success);
            position: relative;
            overflow: hidden;
        }

        .save-meal-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .save-meal-btn:active::before {
            width: 300px;
            height: 300px;
        }

        .save-meal-btn:hover {
            background: var(--success-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(76, 175, 80, 0.4);
        }

        .save-meal-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* ==================== í”Œëœ íƒ­ - ëª©í‘œ ì²´í¬ë¦¬ìŠ¤íŠ¸ ==================== */
        .goal-checklist {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }

        .goal-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .goal-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .goal-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #00D4AA;
        }

        .goal-icon {
            font-size: 1.5rem;
        }

        .goal-text {
            flex: 1;
            font-size: 1rem;
            color: #333;
        }

        .goal-status {
            font-size: 0.85rem;
            color: #666;
            background: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .goal-status.success {
            background: #d4edda;
            color: #155724;
        }

        .goal-status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .goal-status.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .edit-goal-btn {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s ease;
            padding: 4px;
        }

        .edit-goal-btn:hover {
            opacity: 1;
        }

        .goal-check {
            font-size: 1.5rem;
            color: #00D4AA;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .goal-item input[type="checkbox"]:checked ~ .goal-check {
            opacity: 1;
        }

        .goal-item input[type="checkbox"]:checked ~ .goal-text {
            text-decoration: line-through;
            color: #999;
        }

        /* ëª©í‘œ ë‹¬ì„±ë¥  */
        .goal-progress {
            margin: 25px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* ì»¤ìŠ¤í…€ ëª©í‘œ ì…ë ¥ */
        .custom-goal-input {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .custom-goal-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .custom-goal-input button {
            padding: 12px 20px;
            background: #00D4AA;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-goal-input button:hover {
            background: #00b894;
            transform: translateY(-2px);
        }

        /* ì»¤ìŠ¤í…€ ëª©í‘œ ë¦¬ìŠ¤íŠ¸ */
        .custom-goals {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .custom-goal-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #fff3cd;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
        }

        .custom-goal-item .delete-btn {
            margin-left: auto;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .custom-goal-item .delete-btn:hover {
            opacity: 1;
            color: #dc3545;
        }

        /* ì£¼ê°„ í†µê³„ */
        .weekly-stats {
            display: flex;
            justify-content: space-around;
            padding: 20px 0;
            gap: 8px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-day {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
            color: #666;
            margin: 0 auto;
            transition: all 0.3s ease;
        }

        .stat-circle.today {
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.4);
            transform: scale(1.1);
        }

        .stat-circle.future {
            background: #f8f9fa;
            color: #ccc;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .stat-circle {
                width: 40px;
                height: 40px;
                font-size: 0.75rem;
            }

            .stat-day {
                font-size: 0.8rem;
            }

            .weekly-stats {
                gap: 4px;
                padding: 15px 0;
            }
        }

        .plan-activity {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .plan-value {
            font-size: 0.9rem;
            color: #666;
        }

        .plan-delete {
            color: #f44336;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* ==================== ì‹œê°„í‘œ ==================== */
        .timetable-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .timetable-row {
            display: flex;
            gap: 12px;
            align-items: stretch;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            transition: all 0.2s;
        }

        .timetable-row:hover {
            background: #e9ecef;
        }

        .timetable-time {
            font-size: 1rem;
            font-weight: 600;
            color: #667eea;
            min-width: 60px;
            display: flex;
            align-items: center;
        }

        .timetable-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timetable-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.95rem;
            background: white;
            transition: all 0.2s;
            font-family: inherit;
        }

        .timetable-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .timetable-input::placeholder {
            color: #bbb;
        }

        .timetable-emoji-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .timetable-emoji-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .timetable-emoji-picker {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 12px;
            display: none;
            z-index: 1000;
            margin-top: 5px;
        }

        .timetable-emoji-picker.show {
            display: block;
        }

        .timetable-emoji-option {
            display: inline-block;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            font-size: 1.5rem;
        }

        /* í”Œëœ íƒ­ ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .timetable-container {
                gap: 8px;
                width: 100%;
                padding: 0;
            }

            .timetable-row {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px;
                margin: 0;
                width: 100%;
                box-sizing: border-box;
            }

            .timetable-time {
                font-size: 0.85rem;
                min-width: 50px;
                max-width: 50px;
                flex-shrink: 0;
                padding: 0;
            }

            .timetable-input-wrapper {
                flex: 1;
                min-width: 0;
                gap: 6px;
            }

            .timetable-input {
                flex: 1;
                min-width: 0;
                padding: 8px 10px;
                font-size: 0.85rem;
                width: 100%;
                box-sizing: border-box;
            }

            .timetable-emoji-btn {
                width: 36px;
                height: 36px;
                min-width: 36px;
                flex-shrink: 0;
                font-size: 1.1rem;
            }
        }

        .timetable-emoji-option:hover {
            background: #f0f4ff;
        }

        .timetable-clear-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .timetable-clear-btn:hover {
            background: #ffebee;
            color: #f44336;
        }

        /* ==================== ë‹¨ì‹ íƒ­ ==================== */
        .fasting-timer-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .fasting-svg-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 20px auto;
        }

        .fasting-circle-bg {
            fill: none;
            stroke: rgba(255,255,255,0.2);
            stroke-width: 15;
        }

        .fasting-circle-progress {
            fill: none;
            stroke: white;
            stroke-width: 15;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 1s linear;
        }

        .fasting-time-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .fasting-time-main {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .fasting-time-sub {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .fasting-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .fasting-btn {
            padding: 12px 30px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .fasting-btn:hover {
            background: white;
            color: #667eea;
        }

        /* ë°°ì§€ ê·¸ë¦¬ë“œ */
        .fasting-badges-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .badge-item {
            text-align: center;
            padding: 15px 10px;
            border-radius: 12px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .badge-item.unlocked {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            transform: scale(1.05);
        }

        .badge-emoji {
            font-size: 2rem;
            margin-bottom: 5px;
            filter: grayscale(100%);
        }

        .badge-item.unlocked .badge-emoji {
            filter: grayscale(0%);
            animation: bounce 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .badge-name {
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 5px;
        }

        /* ì›”ê°„ ë¦¬í¬íŠ¸ */
        .fasting-monthly-report {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .monthly-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .monthly-stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }

        .monthly-stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .monthly-stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* ë‹¨ì‹ ë‹¬ë ¥ */
        .fasting-calendar-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .fasting-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            background: #f8f9fa;
            font-size: 0.85rem;
            padding: 5px;
        }

        .calendar-day.fasted {
            background: linear-gradient(135deg, #a8e6cf 0%, #56ab2f 100%);
            color: white;
            font-weight: bold;
        }

        .calendar-day.today {
            border: 2px solid #667eea;
        }

        .calendar-day-number {
            font-weight: 600;
        }

        .calendar-day-hours {
            font-size: 0.7rem;
            margin-top: 2px;
        }

        /* ì²´ì¤‘ ì°¨íŠ¸ ì¹´ë“œ */
        .fasting-weight-chart-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* ë¬¼ ì„­ì·¨ ë¦¬ë§ˆì¸ë” */
        .fasting-water-reminder {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* ì£¼ê°„/ì›”ê°„ ë¦¬í¬íŠ¸ í…ìŠ¤íŠ¸ */
        .fasting-weekly-report, .fasting-monthly-report-text {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* ë‹¨ì‹ ìŠ¤íŠ¸ë¦­ & í†µê³„ ì¹´ë“œ */
        .fasting-streak-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .fasting-streak-card > div > div {
            color: white !important;
        }

        /* ì£¼ê°„ ë‹¨ì‹ í˜„í™© ì¹´ë“œ */
        .fasting-weekly-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .weekly-fasting-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .weekly-day-item {
            text-align: center;
            padding: 10px 5px;
            border-radius: 12px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .weekly-day-item.completed {
            background: linear-gradient(135deg, #a8e6cf 0%, #56ab2f 100%);
            color: white;
            font-weight: bold;
        }

        .weekly-day-item.today {
            border: 3px solid #667eea;
            font-weight: bold;
        }

        .weekly-day-label {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .weekly-day-hours {
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* ì˜¤ëŠ˜ì˜ ëˆ„ì  ìš”ì•½ */
        .fasting-today-summary {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* ìƒˆë¡œìš´ ëˆ„ì  ì‹œê°„ ì¹´ë“œ */
        .fasting-accumulated-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: #333;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(255, 154, 158, 0.3);
        }

        .accumulated-time-large {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: #ff5252;
        }

        .accumulated-sessions {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.85rem;
            opacity: 0.85;
            color: #666;
        }

        /* ìƒˆë¡œìš´ í”„ë¦¬ì…‹ ë²„íŠ¼ (ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼) */
        .fasting-preset-btn-new {
            padding: 18px 12px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
            line-height: 1.4;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .fasting-preset-btn-new:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.35);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 5px 18px rgba(0, 0, 0, 0.3);
        }

        .fasting-preset-btn-new:active {
            transform: translateY(0);
        }

        /* ìƒˆë¡œìš´ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
        .fasting-btn-pause, .fasting-btn-resume, .fasting-btn-stop {
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .fasting-btn-pause {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            flex: 1;
        }

        .fasting-btn-pause:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }

        .fasting-btn-resume {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            flex: 1;
        }

        .fasting-btn-resume:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .fasting-btn-stop {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            flex: 1;
        }

        .fasting-btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(250, 112, 154, 0.4);
        }

        /* íŒ ì¹´ë“œ */
        .fasting-tips-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* ë‹¨ì‹ ì„¸ì…˜ ì•„ì´í…œ */
        .fasting-session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: #555;
        }

        .fasting-session-item:last-child {
            border-bottom: none;
        }

        .fasting-duration-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .fasting-duration-input input {
            width: 80px;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid white;
            background: rgba(255,255,255,0.9);
            text-align: center;
            font-weight: bold;
        }

        .fasting-info {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .fasting-info details {
            margin-bottom: 15px;
        }

        .fasting-info summary {
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .fasting-info details[open] summary {
            background: #667eea;
            color: white;
        }

        /* ==================== ì•¨ë²” íƒ­ ==================== */
        .album-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .album-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .album-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .photo-item {
            aspect-ratio: 1;
            background: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-date-label {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 8px;
            font-size: 0.7rem;
            text-align: center;
        }

        .add-photo {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #999;
            border: 2px dashed #ddd;
            background: #fafafa;
        }

        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .photo-modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: white;
        }

        .photo-modal-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-modal-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 15px;
        }

        .photo-modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .photo-modal-btn {
            flex: 1;
            min-width: calc(50% - 4px);
            padding: 12px 8px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        @media (max-width: 480px) {
            .photo-modal-actions {
                gap: 6px;
                margin-top: 15px;
            }
            
            .photo-modal-btn {
                min-width: calc(50% - 3px);
                padding: 10px 6px;
                font-size: 0.75rem;
            }
        }

        /* ==================== ì•¨ë²” íƒ­: í…ìŠ¤íŠ¸ ì¹´ë“œ ==================== */
        .text-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 150px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .text-card:hover {
            transform: translateY(-3px);
        }

        .text-card-emoji {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .text-card-content {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            max-height: 60px;
            overflow: hidden;
            line-height: 1.4;
        }

        .text-card-nutrition {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #555;
            font-weight: 500;
        }

        .text-card.category-body {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .text-card.category-food {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .text-card.category-exercise {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        /* ==================== ì•¨ë²” íƒ­: ë°°ì¹˜ ì‘ì—… (Phase 4) ==================== */
        .album-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .album-header .card-title {
            margin: 0;
        }

        .select-mode-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .select-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .select-mode-btn.active {
            background: #ff5252;
        }

        .select-action-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .select-action-bar.hidden {
            display: none;
        }

        .selected-count {
            font-weight: bold;
            font-size: 1rem;
        }

        .select-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.85rem;
            background: white;
            color: #667eea;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .cancel-btn {
            background: #ff5252;
            color: white;
        }

        /* ì„ íƒ ëª¨ë“œ: ì²´í¬ë°•ìŠ¤ ì˜¤ë²„ë ˆì´ */
        .select-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            cursor: pointer;
            transition: all 0.3s;
        }

        .select-checkbox.checked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .select-checkbox.checked::after {
            content: 'âœ“';
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        /* ì„ íƒëœ í•­ëª© ê°•ì¡° */
        .photo-item.selected {
            outline: 3px solid #667eea;
            outline-offset: -3px;
            opacity: 0.8;
        }

        /* ==================== ìº˜ë¦°ë” íƒ­ ==================== */
        .calendar {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
        }

        .calendar-month {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-label {
            text-align: center;
            font-weight: bold;
            color: #666;
            padding: 10px 0;
            font-size: 0.9rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: #f5f5f5;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 0.75rem;
            padding: 8px 4px;
            overflow: hidden;
        }

        .calendar-day-number {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .calendar-day-preview {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: center;
            width: 100%;
        }

        .preview-item {
            font-size: 0.7rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .calendar-day.today {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .calendar-day.today .calendar-day-number {
            color: white;
        }

        .calendar-day.has-data {
            border: 2px solid #4caf50;
        }

        .calendar-day.future {
            opacity: 0.4;
            cursor: default;
        }

        /* ì£¼ê°„ ìš”ì•½ ì¹´ë“œ */
        .weekly-summary-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .weekly-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .weekly-summary-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }

        .summary-toggle-btn {
            background: #f0f0f0;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .weekly-summary-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .summary-stat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
        }

        .summary-stat.green {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        }

        .summary-stat.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .summary-stat.orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .summary-stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .summary-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .summary-stat-change {
            font-size: 0.8rem;
            margin-top: 5px;
            opacity: 0.9;
        }

        .summary-loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        /* AI ì½”ì¹­ ì¹´ë“œ */
        .ai-coaching-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .ai-coach-header {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .ai-coach-message {
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .calendar-day::after {
            content: '';
            position: absolute;
            bottom: 3px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #4caf50;
            display: none;
        }

        .calendar-day.has-data::after {
            display: block;
        }

        .day-report-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .day-report-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .day-report-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #667eea;
        }

        .day-report-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .day-report-section:last-child {
            border-bottom: none;
        }

        .day-report-section h4 {
            margin-bottom: 10px;
            color: #333;
        }

        /* ==================== ì†Œí†µ íƒ­ ==================== */
        .chat-container {
            height: calc(100vh - 350px);
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            max-width: 80%;
            animation: slideIn 0.3s;
        }

        .chat-message.mine {
            margin-left: auto;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8rem;
            color: #666;
        }

        .message-author {
            font-weight: bold;
        }

        .message-time {
            color: #999;
        }

        .message-bubble {
            padding: 12px 15px;
            border-radius: 15px;
            background: #f5f5f5;
        }

        .chat-message.mine .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-input-container {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
        }

        .send-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== AI í† ìŠ¤íŠ¸ íŒì—… ==================== */
        .ai-toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            max-width: 90%;
            width: 350px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideUp 0.4s ease-out;
        }

        .ai-toast.hidden {
            bottom: -200px;
            opacity: 0;
            pointer-events: none;
        }

        .ai-toast-content {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .ai-toast-icon {
            font-size: 2.5rem;
            animation: bounce 1s infinite;
        }

        .ai-toast-message {
            flex: 1;
            font-size: 1rem;
            line-height: 1.4;
            font-weight: 500;
        }

        .ai-toast-button {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-toast-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        @keyframes slideUp {
            from {
                bottom: -200px;
                opacity: 0;
            }
            to {
                bottom: 80px;
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        /* ==================== ìŠ¤ë§ˆíŠ¸ ë³‘í•© Bottom Sheet ==================== */
        .merge-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: flex-end;
            transition: opacity 0.3s;
        }

        .merge-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .merge-sheet {
            background: white;
            width: 100%;
            max-height: 70vh;
            border-radius: 25px 25px 0 0;
            padding: 30px 20px 20px;
            transform: translateY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.2);
        }

        .merge-overlay.hidden .merge-sheet {
            transform: translateY(100%);
        }

        .merge-header h3 {
            margin: 0 0 5px 0;
            font-size: 1.3rem;
            color: #333;
        }

        .merge-subtitle {
            margin: 0 0 20px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .merge-content {
            margin-bottom: 25px;
        }

        .merge-preview {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin-bottom: 20px;
            gap: 15px;
        }

        .merge-meal {
            flex: 1;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
        }

        .previous-meal {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .current-meal {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .meal-label {
            font-size: 0.75rem;
            color: #555;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .meal-name {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .meal-calories {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: bold;
        }

        .merge-plus {
            font-size: 1.5rem;
            color: #667eea;
            font-weight: bold;
        }

        .merge-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .total-calories {
            color: #667eea;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .merge-actions {
            display: flex;
            gap: 12px;
        }

        .merge-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .merge-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .merge-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .merge-cancel {
            background: #f0f0f0;
            color: #666;
        }

        .merge-cancel:hover {
            background: #e0e0e0;
        }

        /* ==================== Phase 4: ì¹´í…Œê³ ë¦¬ ë³€ê²½ ëª¨ë‹¬ ==================== */
        .category-change-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.3s;
        }

        .category-change-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .category-change-modal {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh; /* í™”ë©´ ë†’ì´ì˜ 90%ë¡œ ì œí•œ */
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transform: scale(1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .category-change-overlay.hidden .category-change-modal {
            transform: scale(0.9);
        }

        .category-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: #333;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .modal-close-btn:hover {
            color: #333;
        }

        .category-modal-description {
            color: #666;
            font-size: 0.95rem;
            margin: 0 0 20px 0;
        }

        .category-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .category-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .category-option:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .category-option.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .category-option.active .category-emoji {
            filter: brightness(1.2);
        }

        .category-emoji {
            font-size: 1.8rem;
        }

        .category-name {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .category-option.active .category-name {
            color: white;
        }

        /* ==================== Phase 4: ìˆ˜ë™ ë³‘í•© ëª¨ë‹¬ ==================== */
        .manual-merge-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: flex-end;
            transition: opacity 0.3s;
        }

        .manual-merge-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .manual-merge-sheet {
            background: white;
            width: 100%;
            max-height: 70vh;
            border-radius: 25px 25px 0 0;
            padding: 25px 20px 20px;
            transform: translateY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .manual-merge-overlay.hidden .manual-merge-sheet {
            transform: translateY(100%);
        }

        .manual-merge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .manual-merge-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: #333;
        }

        .manual-merge-description {
            color: #666;
            font-size: 0.9rem;
            margin: 0 0 15px 0;
        }

        .meal-list {
            overflow-y: auto;
            flex: 1;
            margin: 0 -20px;
            padding: 0 20px;
        }

        .meal-list-loading {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .meal-list-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .meal-list-item:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateX(3px);
        }

        .meal-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .meal-item-date {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .meal-item-time {
            font-size: 0.8rem;
            color: #999;
        }

        .meal-item-name {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .meal-item-calories {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: bold;
        }

        .meal-list-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        /* ==================== ì•Œë¦¼ íƒ­ ==================== */
        .notification-list {
            margin-top: 15px;
        }

        .notification-item {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .notification-details {
            font-size: 0.85rem;
            color: #666;
        }

        .notification-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .notification-edit {
            color: #667eea;
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }

        .notification-edit:hover {
            transform: scale(1.2);
        }

        .notification-delete {
            color: #f44336;
            cursor: pointer;
            font-size: 1.3rem;
            transition: transform 0.2s;
        }

        .notification-delete:hover {
            transform: scale(1.2);
        }

        /* ==================== ëˆ„ì  ë‹¨ì‹ í†µê³„ ==================== */
        .fasting-stats {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea20, #764ba220);
            border-radius: 15px;
        }

        .accumulated-time {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 15px 0;
        }

        .fasting-sessions {
            margin-top: 20px;
        }

        .fasting-session-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* ==================== ì•Œë¦¼ ê¶Œí•œ ë°°ë„ˆ ==================== */
        .notification-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(238, 90, 111, 0.3);
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .notification-banner-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-banner-icon { font-size: 1.8rem; }

        .notification-banner-text { flex: 1; }

        .notification-banner-title {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .notification-banner-desc {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .notification-banner-button {
            padding: 10px 20px;
            background: white;
            color: #ff6b6b;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .notification-banner-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        /* D-Day í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .dday-display {
            text-align: center;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            color: white;
            margin-top: 10px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .dday-main {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .dday-sub {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* ê¶Œì¥ ì¹¼ë¡œë¦¬ í‘œì‹œ */
        .calorie-recommendation {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 15px;
            border-radius: 15px;
            margin-top: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .calorie-rec-title {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .calorie-rec-desc {
            font-size: 0.8rem;
            color: #777;
            margin-top: 5px;
        }

        /* ==================== ì„¤ì • íƒ­ ==================== */
        .profile-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .profile-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .profile-info p {
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 15px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .settings-item {
            padding: 20px;
            background: white;
            border-radius: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .logout-btn {
            background: #ff5252;
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
        }

        /* ==================== PWA ì„¤ì¹˜ ë°°ë„ˆ ==================== */
        .pwa-install-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .pwa-install-text {
            flex: 1;
        }

        .pwa-install-text strong {
            display: block;
            margin-bottom: 5px;
        }

        .pwa-install-btn {
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== ëª¨ë˜ ì…ë ¥ ëª¨ë‹¬ ==================== */
        .modern-input-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            align-items: flex-end;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .modern-input-modal.show {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }
        
        .modern-input-content {
            background: #fff;
            width: 100%;
            max-width: 500px;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        .modern-input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modern-input-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        .modern-input-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5f5;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        .modern-input-field {
            width: 100%;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            margin-bottom: 12px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .modern-input-field:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modern-input-field::placeholder {
            color: #aaa;
        }
        
        .modern-input-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .modern-input-row .modern-input-field {
            margin-bottom: 0;
        }
        
        .modern-input-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
            display: block;
        }
        
        .modern-select-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .modern-select-btn {
            padding: 10px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modern-select-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        
        .modern-input-submit {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .modern-input-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ==================== ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ ==================== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: var(--z-modal-backdrop);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
            backdrop-filter: blur(4px);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* ê¸°ë³¸ê°’ none, JavaScriptê°€ flexë¡œ ë³€ê²½ */
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            overflow-y: auto; /* ëª¨ë‹¬ ìì²´ ìŠ¤í¬ë¡¤ */
            -webkit-overflow-scrolling: touch; /* iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
        }
        
        .modal-overlay.show {
            display: flex !important; /* show í´ë˜ìŠ¤ê°€ ìˆìœ¼ë©´ í‘œì‹œ */
        }
        
        /* ğŸ”¥ ì˜¨ë³´ë”© ëª¨ë‹¬ ê°•ì œ í‘œì‹œ (iframe/ìƒŒë“œë°•ìŠ¤ í™˜ê²½ ëŒ€ì‘) */
        #initialProfileSetupModal.show {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 2147483647 !important;
            position: fixed !important;
            inset: 0 !important;
            background: rgba(0, 0, 0, 0.85) !important;
        }
        
        #initialProfileSetupModal.show .modal-content {
            background: #ffffff !important;
            color: #333333 !important;
        }

        /* ==================== ì „ì²´ í™”ë©´ ì˜¨ë³´ë”© UI ==================== */
        .fullscreen-onboarding {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ffffff;
            z-index: 2147483647;
            display: none;
            flex-direction: column;
        }
        
        .fullscreen-onboarding.show {
            display: flex !important;
        }
        
        .onboarding-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .onboarding-back-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .onboarding-progress {
            flex: 1;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .onboarding-progress-bar {
            height: 100%;
            background: #000;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .onboarding-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px 30px;
            overflow-y: auto;
        }
        
        .onboarding-title {
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            line-height: 1.4;
            margin-bottom: 40px;
            color: #000;
        }
        
        .onboarding-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .onboarding-footer {
            padding: 20px 30px 40px;
        }
        
        .onboarding-next-btn {
            width: 100%;
            padding: 18px;
            background: #000;
            color: #fff;
            border: none;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .onboarding-next-btn:hover {
            background: #333;
        }
        
        .onboarding-next-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* ì´ë¦„ ì…ë ¥ ìŠ¤íƒ€ì¼ */
        .onboarding-text-input {
            width: 100%;
            font-size: 1.5rem;
            padding: 15px 0;
            border: none;
            border-bottom: 2px solid #e5e7eb;
            outline: none;
            text-align: left;
            background: transparent;
            color: #000;
        }
        
        .onboarding-text-input::placeholder {
            color: #999;
        }
        
        .onboarding-text-input:focus {
            border-bottom-color: #000;
        }
        
        /* ==================== Diet Mate ë…ì°½ì  ì…ë ¥ ì»´í¬ë„ŒíŠ¸ ==================== */
        
        /* í° ìˆ«ì ì…ë ¥ ë””ìŠ¤í”Œë ˆì´ */
        .dm-value-display {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .dm-value-main {
            font-size: 4rem;
            font-weight: 700;
            color: #000;
            cursor: pointer;
            display: inline-block;
            min-width: 150px;
            padding: 10px;
            border-radius: 12px;
            transition: background 0.2s;
        }
        
        .dm-value-main:hover {
            background: #f5f5f5;
        }
        
        .dm-value-unit {
            font-size: 1.2rem;
            color: #666;
            margin-left: 5px;
        }
        
        .dm-value-input {
            font-size: 4rem;
            font-weight: 700;
            color: #000;
            text-align: center;
            border: none;
            border-bottom: 3px solid #4f46e5;
            outline: none;
            width: 150px;
            background: transparent;
        }
        
        /* ë‹¨ìœ„ í† ê¸€ */
        .dm-unit-toggle {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 20px;
            background: #f0f0f0;
            border-radius: 25px;
            padding: 4px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        .dm-unit-btn {
            padding: 8px 20px;
            border: none;
            background: transparent;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #666;
        }
        
        .dm-unit-btn.active {
            background: #fff;
            color: #000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* í„°ì¹˜ ìŠ¬ë¼ì´ë” (ê°€ë¡œ ìŠ¤í¬ë¡¤) */
        .dm-slider-container {
            width: 100%;
            overflow: hidden;
            position: relative;
            padding: 20px 0;
        }
        
        .dm-slider-track {
            display: flex;
            align-items: flex-end;
            height: 80px;
            cursor: grab;
            user-select: none;
            padding: 0 50%;
        }
        
        .dm-slider-track:active {
            cursor: grabbing;
        }
        
        .dm-slider-tick {
            flex-shrink: 0;
            width: 2px;
            background: #ddd;
            margin: 0 4px;
            transition: height 0.1s, background 0.1s;
        }
        
        .dm-slider-tick.major {
            height: 40px;
            background: #999;
        }
        
        .dm-slider-tick.minor {
            height: 20px;
        }
        
        .dm-slider-tick.active {
            background: #4f46e5;
        }
        
        .dm-slider-indicator {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 0;
            width: 3px;
            height: 60px;
            background: #4f46e5;
            border-radius: 2px;
        }
        
        .dm-slider-indicator::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 10px solid #4f46e5;
        }
        
        /* ë‚˜ì´ ì„ íƒ - ì¹´ë“œ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .dm-age-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .dm-age-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border-radius: 12px;
            background: #f5f5f5;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .dm-age-item:hover {
            background: #e8e8e8;
        }
        
        .dm-age-item.selected {
            background: #4f46e5;
            color: #fff;
            font-weight: 700;
            border-color: #4f46e5;
        }
        
        /* ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼ */
        .dm-quick-select {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .dm-quick-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dm-quick-btn:hover {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        
        /* ë‹¬ë ¥ ë‚ ì§œ ì„ íƒ */
        .dm-calendar-picker {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        
        .dm-date-input {
            font-size: 1.3rem;
            padding: 16px 24px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            background: #fff;
            color: #333;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dm-date-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .dm-dday-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 40px;
        }
        
        .dday-label {
            font-size: 1rem;
            color: #666;
            margin-bottom: 8px;
        }
        
        .dday-number {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* í™œë™ëŸ‰ ì¹´ë“œ */
        .dm-activity-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        
        .dm-activity-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dm-activity-card:hover {
            background: #f0f0f0;
        }
        
        .dm-activity-card.selected {
            background: #f0f0ff;
            border-color: #4f46e5;
        }
        
        .activity-card-icon {
            font-size: 2rem;
            width: 50px;
            text-align: center;
        }
        
        .activity-card-info {
            flex: 1;
        }
        
        .activity-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #000;
        }
        
        .activity-card-desc {
            font-size: 0.85rem;
            color: #666;
            margin-top: 3px;
        }
        
        /* ì—°êµ¬ í™”ë©´ (ìƒˆë¡œìš´ ë””ìì¸) */
        .research-screen {
            text-align: center;
            padding: 20px;
        }
        
        .research-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .research-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: #000;
            margin-bottom: 25px;
        }
        
        .research-stat {
            margin-bottom: 25px;
        }
        
        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            color: #4f46e5;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #666;
        }
        
        .research-finding {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #333;
            margin-bottom: 30px;
        }
        
        .research-finding .highlight {
            color: #4f46e5;
            font-weight: 600;
        }
        
        .research-finding .big-highlight {
            font-size: 1.5rem;
            font-weight: 800;
            color: #4f46e5;
        }
        
        .research-visual {
            margin-bottom: 25px;
        }
        
        .research-bar-group {
            display: flex;
            justify-content: center;
            gap: 40px;
            height: 120px;
            align-items: flex-end;
        }
        
        .research-bar {
            width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .research-bar .bar-fill {
            width: 100%;
            border-radius: 8px 8px 0 0;
            transition: height 0.5s ease;
        }
        
        .research-bar.no-log .bar-fill {
            background: #e5e7eb;
        }
        
        .research-bar.with-log .bar-fill {
            background: linear-gradient(to top, #4f46e5, #818cf8);
        }
        
        .research-bar .bar-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: #4f46e5;
            margin-bottom: 5px;
        }
        
        .research-bar .bar-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
        }
        
        .research-citation {
            font-size: 0.75rem;
            color: #999;
            line-height: 1.5;
        }
        
        /* ì„±ë³„ ì„ íƒ ë¦¬ìŠ¤íŠ¸ */
        .gender-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .gender-item {
            padding: 20px 25px;
            border-radius: 12px;
            background: #f8f8f8;
            border: none;
            font-size: 1.1rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .gender-item.selected {
            background: #000;
            color: #fff;
        }
        
        /* ìˆ˜í‰ ëˆˆê¸ˆì ìŠ¬ë¼ì´ë” */
        .ruler-slider-container {
            width: 100%;
            text-align: center;
        }
        
        .ruler-value {
            font-size: 4rem;
            font-weight: 700;
            color: #000;
            margin-bottom: 10px;
        }
        
        .ruler-unit {
            font-size: 1rem;
            color: #666;
            margin-bottom: 20px;
        }
        
        .ruler-slider {
            position: relative;
            height: 60px;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .ruler-slider::-webkit-scrollbar {
            display: none;
        }
        
        .ruler-track {
            display: flex;
            align-items: flex-end;
            height: 100%;
            padding: 0 50%;
        }
        
        .ruler-mark {
            flex-shrink: 0;
            width: 2px;
            background: #ddd;
            margin: 0 4px;
        }
        
        .ruler-mark.major {
            height: 30px;
            background: #999;
        }
        
        .ruler-mark.minor {
            height: 15px;
        }
        
        .ruler-indicator {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 40px;
            background: #000;
        }
        
        .ruler-indicator::after {
            content: attr(data-unit);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            color: #666;
        }
        
        /* í™œë™ëŸ‰/ê°ëŸ‰ì†ë„ ìŠ¬ë¼ì´ë” */
        .level-slider-container {
            width: 100%;
            text-align: center;
        }
        
        .level-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .level-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #000;
            margin-bottom: 5px;
        }
        
        .level-unit {
            font-size: 1rem;
            color: #666;
            margin-bottom: 30px;
        }
        
        .level-slider {
            position: relative;
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .level-slider-thumb {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 40px;
            background: #000;
            border-radius: 4px;
            cursor: grab;
        }
        
        .level-slider-dots {
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
        }
        
        .level-slider-dot {
            width: 8px;
            height: 8px;
            background: #ddd;
            border-radius: 50%;
        }
        
        .level-label {
            font-size: 1.2rem;
            font-weight: 600;
            color: #000;
        }
        
        .level-description {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        /* ì •ë³´ í™”ë©´ */
        .info-screen {
            text-align: center;
        }
        
        .info-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .info-subtitle {
            font-size: 1rem;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.5;
        }
        
        .info-chart {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
        }
        
        .info-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .info-bar-label {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .info-bar-visual {
            width: 80px;
            border-radius: 8px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        .info-bar-caption {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }
        
        .info-citation {
            font-size: 0.75rem;
            color: #999;
            margin-top: 30px;
            line-height: 1.4;
        }
        
        /* ë‹¨ìœ„ í† ê¸€ */
        .unit-toggle {
            display: inline-flex;
            background: #f5f5f5;
            border-radius: 20px;
            padding: 4px;
            margin-bottom: 30px;
        }
        
        .unit-toggle-btn {
            padding: 8px 20px;
            border: none;
            background: transparent;
            border-radius: 16px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .unit-toggle-btn.active {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* ë¶„ì„ ì™„ë£Œ í™”ë©´ */
        .result-screen {
            text-align: center;
            width: 100%;
        }
        
        .result-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .result-subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 40px;
        }
        
        .calorie-display {
            margin-bottom: 40px;
        }
        
        .calorie-label {
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .calorie-value {
            font-size: 4rem;
            font-weight: 700;
            color: #000;
        }
        
        .calorie-unit {
            font-size: 1.2rem;
            color: #666;
            margin-left: 5px;
        }
        
        /* ë„ë„› ì°¨íŠ¸ */
        .donut-chart-container {
            position: relative;
            width: 220px;
            height: 220px;
            margin: 0 auto 30px;
        }
        
        .donut-chart {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                #3b82f6 0deg 180deg,
                #22c55e 180deg 288deg,
                #eab308 288deg 360deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .donut-hole {
            width: 140px;
            height: 140px;
            background: #fff;
            border-radius: 50%;
        }
        
        .donut-labels {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        
        .donut-label {
            position: absolute;
            font-size: 0.85rem;
            font-weight: 600;
            background: #fff;
            padding: 4px 10px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .donut-label.carbs {
            top: 50%;
            right: -20px;
            transform: translateY(-50%);
            color: #3b82f6;
        }
        
        .donut-label.protein {
            bottom: 10px;
            left: 10px;
            color: #22c55e;
        }
        
        .donut-label.fat {
            top: 10px;
            left: 20px;
            color: #eab308;
        }
        
        /* ğŸ”¥ v3.9.1: ìš´ë™ ì¶”ì²œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .exercise-recommendation {
            padding: 15px 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .exercise-recommendation:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .exercise-recommendation:hover div {
            color: white !important;
        }

        /* ë§¤í¬ë¡œ ìƒì„¸ */
        .macro-details {
            margin-top: 30px;
        }
        
        .macro-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        
        .macro-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .macro-dot.carbs { background: #3b82f6; }
        .macro-dot.protein { background: #22c55e; }
        .macro-dot.fat { background: #eab308; }
        
        .macro-name {
            flex: 1;
            text-align: left;
            font-size: 1rem;
            color: #666;
        }
        
        .macro-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #000;
        }
        
        .macro-unit {
            font-size: 1rem;
            color: #666;
            margin-left: 5px;
        }
        
        /* ë™ê¸°ë¶€ì—¬ í™”ë©´ */
        .motivation-screen {
            text-align: center;
            padding: 20px;
        }
        
        .motivation-emoji {
            font-size: 4rem;
            margin-bottom: 10px;
        }
        
        .motivation-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: #333;
            margin-bottom: 30px;
        }
        
        .motivation-message {
            margin-bottom: 30px;
        }
        
        .motivation-main {
            font-size: 1.1rem;
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .motivation-highlight-box {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 30px;
            margin-bottom: 20px;
        }
        
        .motivation-key {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
        }
        
        .motivation-desc {
            font-size: 1rem;
            color: #666;
            line-height: 1.6;
        }
        
        .motivation-tips {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 20px;
            margin: 25px 0;
        }
        
        .tip-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
        }
        
        .tip-icon {
            width: 24px;
            height: 24px;
            background: #10b981;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .tip-text {
            font-size: 0.95rem;
            color: #333;
        }
        
        .motivation-footer {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: 600;
        }
        
        .motivation-facts {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        .fact-item {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 20px 15px;
            color: #fff;
            text-align: center;
        }
        
        .fact-number {
            display: block;
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 8px;
        }
        
        .fact-text {
            display: block;
            font-size: 0.85rem;
            line-height: 1.4;
            opacity: 0.95;
        }
        
        .fact-source {
            display: block;
            font-size: 0.65rem;
            opacity: 0.7;
            margin-top: 8px;
            font-style: italic;
        }
        
        .motivation-tips.compact {
            margin: 15px 0;
            padding: 15px;
        }
        
        /* ê³„ì‚° ë°©ë²• ì„¤ëª… */
        .calculation-explain {
            margin-top: 25px;
            padding: 20px;
            background: #f0f4ff;
            border-radius: 16px;
            text-align: left;
        }
        
        .explain-title {
            font-size: 1rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }
        
        .explain-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .explain-label {
            font-size: 0.9rem;
            color: #555;
            flex: 1;
        }
        
        .explain-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4f46e5;
        }
        
        .explain-unit {
            font-size: 0.85rem;
            color: #888;
        }
        
        .explain-desc {
            font-size: 0.8rem;
            color: #888;
            margin-left: 4px;
            margin-top: 2px;
        }
        
        .explain-formula {
            margin-top: 15px;
            padding: 12px;
            background: #e8eeff;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
            color: #667eea;
            font-weight: 600;
        }
        
        .explain-formula-box {
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            text-align: center;
            color: #fff;
        }
        
        .formula-row {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .formula-row strong {
            font-size: 1.3rem;
            color: #ffeb3b;
        }
        
        .formula-label {
            font-size: 0.75rem;
            opacity: 0.85;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: scaleIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* í”„ë¡œí•„ ì„¤ì • ëª¨ë‹¬ ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            #initialProfileSetupModal {
                align-items: flex-start;
            }

            #initialProfileSetupModal .modal-content {
                background: white;
                border-radius: 20px 20px 0 0;
                padding: 20px;
                padding-bottom: 80px; /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ê³µê°„ í™•ë³´ */
                margin: 0;
                margin-top: auto;
                min-height: 100vh;
                max-height: none;
                width: 100%;
                max-width: 100%;
                position: relative;
                animation: slideUp 0.35s ease-out;
            }

            #initialProfileSetupModal .modal-content h3 {
                position: sticky;
                top: 0;
                background: white;
                padding: 15px 0;
                margin: -20px -20px 20px -20px;
                padding: 15px 20px;
                border-bottom: 1px solid #f0f0f0;
                z-index: 10;
            }

            #initialProfileSetupModal .modal-content > p {
                margin-top: 0;
            }

            #initialProfileSetupModal .merge-btn.merge-confirm {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                margin: 0;
                padding: 18px;
                border-radius: 0;
                z-index: 11;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            }

            /* í”„ë¡œí•„ ì¬ì„¤ì • ëª¨ë‹¬ ìŠ¤í¬ë¡¤ ìµœì í™” */
            .category-change-modal {
                max-height: 85vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: var(--spacing-lg);
            color: var(--primary);
        }

        .modal-footer {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        .modal-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .modal-btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .modal-btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .modal-btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .modal-btn-secondary:hover {
            background: var(--border);
        }

        /* ==================== ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ==================== */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 10px;
        }

        /* ==================== ë°˜ì‘í˜• ==================== */
        @media (max-width: 768px) {
            /* í…ìŠ¤íŠ¸ ì˜ë¦¼ ë°©ì§€ */
            * {
                word-wrap: break-word;
                overflow-wrap: break-word;
                hyphens: auto;
            }

            /* ì¹´ë“œ ë°˜ì‘í˜• */
            .card {
                max-width: 100%;
                box-sizing: border-box;
                margin: 10px 0;
                padding: 15px;
            }

            .card-title {
                font-size: 1.1rem;
            }

            /* ì‹ì‚¬ ë²„íŠ¼ 2ì—´ë¡œ */
            .meal-input-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            /* ì‹œê°„í‘œ í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
            .timetable-time {
                min-width: 50px;
                font-size: 0.9rem;
            }

            .timetable-input {
                font-size: 0.85rem;
                padding: 8px 10px;
            }

            /* ì˜ì–‘ ì¹´ë“œ */
            .nutrition-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .nutrition-card {
                padding: 12px;
            }

            .nutrition-value {
                font-size: 1.5rem;
            }


            /* ì…ë ¥ ë°©ë²• ë²„íŠ¼ */
            .input-method-btn {
                font-size: 0.9rem;
                padding: 10px 15px;
            }

            /* ë²„íŠ¼ ì „ì²´ */
            .btn, button {
                max-width: 100%;
                padding: 12px 20px;
                font-size: 0.95rem;
            }

            /* ì…ë ¥ í•„ë“œ (iOS ìë™ ì¤Œ ë°©ì§€) */
            input, select, textarea {
                max-width: 100%;
                font-size: 16px !important;
            }

            /* í—¤ë” */
            .header {
                padding: 20px 15px 20px 80px; /* ì™¼ìª½ì— í–„ë²„ê±° ë©”ë‰´ ê³µê°„ í™•ë³´ */
                border-radius: 0 0 20px 20px;
            }

            .header-title {
                font-size: 1.5rem;
            }

            /* ì»¨í…ì¸  */
            .content {
                padding: 15px;
            }

            /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
            .bottom-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding: 10px 5px;
            }

            .bottom-nav::-webkit-scrollbar {
                display: none;
            }

            .nav-item {
                min-width: 65px;
                padding: 5px 8px;
            }

            .nav-icon {
                font-size: 1.3rem;
            }

            .nav-label {
                font-size: 0.65rem;
            }

            /* ë¬¼ ë§ˆì‹œê¸° */
            .water-tracker {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 8px;
                justify-content: center;
            }

            .water-cup {
                width: calc(25% - 8px);
                min-width: 60px;
                aspect-ratio: 1;
            }

            /* ==================== ì‚¬ì´ë“œë°” ëª¨ë°”ì¼ ë“œë˜ì›Œ ==================== */
            /* ì‚¬ì´ë“œë°”ë¥¼ ë“œë˜ì›Œë¡œ ë³€í™˜ */
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.2);
                transition: transform var(--transition-base);
                z-index: 1030; /* ì˜¤ë²„ë ˆì´ë³´ë‹¤ ìœ„ */
            }

            /* ì‚¬ì´ë“œë°” ì—´ë¦° ìƒíƒœ */
            .sidebar.mobile-open {
                transform: translateX(0);
            }

            /* ë©”ì¸ ì»¨í…ì¸  ë§ˆì§„ ì œê±° */
            .main-content {
                margin-left: 0;
            }

            /* í–„ë²„ê±° ë²„íŠ¼ í‘œì‹œ */
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1025;
                background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
                color: white;
                width: 50px;
                height: 50px;
                border: none;
                border-radius: 8px;
                box-shadow: var(--shadow-primary);
                cursor: pointer;
                transition: all var(--transition-base);
            }

            .mobile-menu-btn:hover {
                transform: scale(1.05);
                box-shadow: var(--shadow-glow);
            }

            .mobile-menu-btn:active {
                transform: scale(0.95);
            }

            /* ì˜¤ë²„ë ˆì´ */
            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1029;
                opacity: 0;
                transition: opacity var(--transition-base);
            }

            .sidebar-overlay.active {
                display: block;
                opacity: 1;
            }
        }

        @media (max-width: 480px) {
            .landing-title {
                font-size: 2.2rem;
            }

            .landing-subtitle {
                font-size: 1rem;
            }

            /* ê±´ê°• ì§€í‘œ 3ì—´ ìœ ì§€ (ê°€ë¡œ ë°°ì¹˜) */
            .health-metrics {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .metric-card {
                padding: 12px 8px;
            }

            .metric-label {
                font-size: 0.75rem;
            }

            .metric-value {
                font-size: 1.2rem;
            }

            .metric-unit {
                font-size: 0.75rem;
            }

            /* ì‚¬ì§„ ê·¸ë¦¬ë“œ 2ì—´ë¡œ */
            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* ì‹ì‚¬ ë²„íŠ¼ ëª¨ë°”ì¼ ìµœì í™” */
            .meal-btn {
                padding: 10px 6px;
                font-size: 0.85rem;
            }

            .meal-emoji {
                font-size: 1.5rem;
            }

            /* ëª¨ë‹¬ íŒ¨ë”© ì¤„ì´ê¸° */
            .meal-input-modal,
            .day-report-content {
                padding: 20px;
            }

            /* í…Œì´ë¸” ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ */
            .timetable-row {
                gap: 8px;
                padding: 10px;
            }

            /* ì‚¬ì´ë“œë°” ì „ì²´ ë„ˆë¹„ */
            .sidebar {
                width: 100%;
            }
        }

        @media (max-width: 360px) {
            .card {
                padding: 12px;
                margin: 8px 0;
            }

            /* ì‹ì‚¬ ë²„íŠ¼ ë” ì‘ê²Œ */
            .meal-input-buttons {
                gap: 8px;
            }

            .meal-btn {
                padding: 8px 4px;
            }

            /* ì˜ì–‘ ì¹´ë“œ ê°„ê²© */
            .nutrition-grid {
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <!-- ëœë”© í˜ì´ì§€ -->
    <div id="landing" class="landing">
        <div class="landing-logo">ğŸ’ª</div>
        <h1 class="landing-title">Diet Mate</h1>
        <p class="landing-subtitle">AIì™€ í•¨ê»˜í•˜ëŠ”<br>ìŠ¤ë§ˆíŠ¸ ë‹¤ì´ì–´íŠ¸ ì—¬ì •</p>
        <button class="btn btn-primary" onclick="showAuth()">ì‹œì‘í•˜ê¸°</button>
    </div>

    <!-- ì¸ì¦ í˜ì´ì§€ -->
    <div id="auth" class="auth-container hidden">
        <div class="auth-logo">
            <div class="auth-logo-icon">ğŸ’ª</div>
        </div>

        <h2 class="auth-title" id="authTitle">ë¡œê·¸ì¸</h2>

        <div class="error-message" id="authError"></div>
        <div class="success-message" id="authSuccess"></div>

        <form id="authForm">
            <div class="form-group">
                <label class="form-label">ì´ë©”ì¼</label>
                <input type="email" class="form-input" id="email" required>
            </div>

            <div class="form-group">
                <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="form-input" id="password" required>
            </div>

            <div class="form-group" id="signupFields" style="display: none;">
                <label class="form-label">ì´ë¦„</label>
                <input type="text" class="form-input" id="displayName">

                <label class="form-label" style="margin-top: 15px;">ëª©í‘œ ì²´ì¤‘ (kg)</label>
                <input type="number" class="form-input" id="goalWeight" step="0.1">

                <label class="form-label" style="margin-top: 15px;">ì‹œì‘ ì²´ì¤‘ (kg)</label>
                <input type="number" class="form-input" id="startWeight" step="0.1">
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                <span id="authButtonText">ë¡œê·¸ì¸</span>
            </button>
        </form>

        <p class="link-text" onclick="toggleAuthMode()">
            <span id="authToggleText">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</span>
        </p>
    </div>

    <!-- ì•Œë¦¼ ê¶Œí•œ ë°°ë„ˆ -->
    <div id="notificationBanner" class="notification-banner hidden">
        <div class="notification-banner-content">
            <div class="notification-banner-icon">ğŸ””</div>
            <div class="notification-banner-text">
                <div class="notification-banner-title">ì•Œë¦¼ ë°›ê¸°</div>
                <div class="notification-banner-desc">ì‹ì‚¬ ì‹œê°„ê³¼ ìš´ë™ ì•Œë¦¼ì„ ë°›ìœ¼ì„¸ìš”</div>
            </div>
        </div>
        <button class="notification-banner-button" onclick="requestNotificationFromBanner()">í—ˆìš©</button>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ -->
    <div id="dashboard" class="dashboard hidden">
        <!-- ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ -->
        <aside class="sidebar" id="sidebar">
            <!-- ì‚¬ì´ë“œë°” í—¤ë” -->
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="sidebar-logo-icon">ğŸ’ª</span>
                    <span class="sidebar-logo-text">Diet Mate</span>
                </div>
            </div>

            <!-- ì‚¬ì´ë“œë°” ë©”ë‰´ -->
            <nav class="sidebar-nav">
                <div class="nav-item-sidebar active" onclick="switchTab('home')" data-tab="home">
                    <span class="nav-icon-sidebar">ğŸ </span>
                    <span class="nav-label-sidebar">í™ˆ</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('plan')" data-tab="plan">
                    <span class="nav-icon-sidebar">ğŸ“‹</span>
                    <span class="nav-label-sidebar">í”Œëœ</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('fasting')" data-tab="fasting">
                    <span class="nav-icon-sidebar">â±ï¸</span>
                    <span class="nav-label-sidebar">ë‹¨ì‹</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('exercise')" data-tab="exercise">
                    <span class="nav-icon-sidebar">ğŸ’ª</span>
                    <span class="nav-label-sidebar">ìš´ë™</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('album')" data-tab="album">
                    <span class="nav-icon-sidebar">ğŸ“¸</span>
                    <span class="nav-label-sidebar">ì•¨ë²”</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('calendar')" data-tab="calendar">
                    <span class="nav-icon-sidebar">ğŸ“…</span>
                    <span class="nav-label-sidebar">ìº˜ë¦°ë”</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('community')" data-tab="community">
                    <span class="nav-icon-sidebar">ğŸ’¬</span>
                    <span class="nav-label-sidebar">ì†Œí†µ</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('notification')" data-tab="notification">
                    <span class="nav-icon-sidebar">ğŸ””</span>
                    <span class="nav-label-sidebar">ì•Œë¦¼</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('settings')" data-tab="settings">
                    <span class="nav-icon-sidebar">âš™ï¸</span>
                    <span class="nav-label-sidebar">ì„¤ì •</span>
                </div>
            </nav>

            <!-- ì‚¬ì´ë“œë°” í‘¸í„° -->
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar">ğŸ‘¤</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="sidebarUserName">ì‚¬ìš©ì</div>
                        <div class="sidebar-user-status">í™œë™ ì¤‘</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
        <div class="main-content" id="mainContent">
            <div class="header">
                <h1 class="header-title">Diet Mate</h1>
                <p class="header-subtitle" id="headerSubtitle">ì•ˆë…•í•˜ì„¸ìš”!</p>
            </div>

            <div class="content">
            <!-- í™ˆ íƒ­ -->
            <div id="tab-home" class="tab-content active">
                <div class="health-metrics compact">
                    <div class="metric-card compact">
                        <div class="metric-label">ì‹œì‘ ì²´ì¤‘</div>
                        <div class="metric-inline">
                            <span class="metric-value-sm" id="startWeightDisplay">0</span><span class="metric-unit-sm">kg</span>
                        </div>
                    </div>
                    <div class="metric-card compact" onclick="openWeightGraphModal()" style="cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='';">
                        <div class="metric-label">í˜„ì¬ ì²´ì¤‘ ğŸ“Š</div>
                        <div class="metric-inline">
                            <span class="metric-value-sm" id="currentWeightDisplay">0</span><span class="metric-unit-sm">kg</span>
                        </div>
                        <div class="metric-date" id="currentWeightDate" style="font-size: 0.75rem; color: #999; margin-top: 5px;"></div>
                        <div style="font-size: 0.75rem; color: #667eea; margin-top: 5px; font-weight: 600;">í´ë¦­í•˜ì—¬ ê·¸ë˜í”„ ë³´ê¸°</div>
                    </div>
                    <div class="metric-card compact">
                        <div class="metric-label">ëª©í‘œ ì²´ì¤‘</div>
                        <div class="metric-inline">
                            <span class="metric-value-sm" id="goalWeightDisplay">0</span><span class="metric-unit-sm">kg</span>
                        </div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-header">
                        <span>ëª©í‘œ ë‹¬ì„±ë¥ </span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="progress-stats">
                        <span id="weightLost">ê°ëŸ‰: 0kg</span>
                        <span id="weightRemaining">ë‚¨ì€ ê°ëŸ‰: 0kg</span>
                    </div>
                    
                    <!-- D-Day í‘œì‹œ (ìƒˆë¡œ ì¶”ê°€) -->
                    <div id="ddayDisplay" class="dday-display hidden">
                        <div class="dday-main">D-0</div>
                        <div class="dday-sub">ëª©í‘œì¼ ì„¤ì • í•„ìš”</div>
                    </div>
                    
                    <!-- í˜„ì‹¤ì ì¸ ì˜ˆìƒ ë‹¬ì„±ì¼ -->
                    <div id="realisticGoalDisplay" class="realistic-goal-display hidden" style="margin-top: 10px; padding: 12px; background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #00695c; margin-bottom: 4px;">ğŸ’¡ ê±´ê°•í•œ ê°ëŸ‰ ì†ë„ ê¸°ì¤€</div>
                        <div id="realisticGoalText" style="font-size: 0.95rem; font-weight: 600; color: #004d40;">ì˜ˆìƒ ë‹¬ì„±ì¼: -</div>
                        <div style="font-size: 0.75rem; color: #00796b; margin-top: 4px;">ì£¼ë‹¹ 0.5-1kg ê°ëŸ‰ ê¸°ì¤€</div>
                    </div>
                </div>

                <!-- ì˜ì–‘ ëŒ€ì‹œë³´ë“œ -->
                <div class="card">
                    <h3 class="card-title">ğŸ½ï¸ ì˜¤ëŠ˜ì˜ ì˜ì–‘ ì„­ì·¨</h3>

                    <!-- í˜„ì¬ ì„­ì·¨ëŸ‰ -->
                    <h4 style="font-size: 0.95rem; color: #666; margin-bottom: 10px;">ğŸ“ˆ í˜„ì¬ ì„­ì·¨ëŸ‰</h4>
                    <div class="nutrition-summary">
                        ì˜¤ëŠ˜ <span id="todayMealCount">0</span>íšŒ ì‹ì‚¬
                    </div>
                    
                    <!-- ì˜¤ëŠ˜ ë¨¹ì€ ìŒì‹ ëª©ë¡ -->
                    <div id="todayMealsList" style="margin-top: 15px;"></div>
                    
                    <!-- ğŸ”¥ ìƒˆ ê¸°ëŠ¥: 100gë‹¹ ì˜ì–‘ì •ë³´ -->
                    <div id="per100gNutrition" style="margin-top: 15px; padding: 12px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #4a90e2; display: none;">
                        <div style="font-size: 0.9rem; font-weight: bold; color: #4a90e2; margin-bottom: 10px;">
                            ğŸ“Š 100gë‹¹ ì˜ì–‘ì •ë³´
                        </div>
                        <div id="per100gContainer" style="font-size: 0.85rem; line-height: 1.8;"></div>
                    </div>

                    <div class="nutrition-grid">
                        <div class="nutrition-card nutrition-calories">
                            <div class="nutrition-label">ì¹¼ë¡œë¦¬</div>
                            <div class="nutrition-value" id="todayCalories">0</div>
                            <div class="nutrition-remaining" id="remainingCalories">ê³„ì‚° ì¤‘...</div>
                        </div>
                        <div class="nutrition-card nutrition-carbs">
                            <div class="nutrition-label">íƒ„ìˆ˜í™”ë¬¼</div>
                            <div class="nutrition-value" id="todayCarbs">0</div>
                            <div class="nutrition-remaining" id="remainingCarbs">ê³„ì‚° ì¤‘...</div>
                        </div>
                        <div class="nutrition-card nutrition-protein">
                            <div class="nutrition-label">ë‹¨ë°±ì§ˆ</div>
                            <div class="nutrition-value" id="todayProtein">0</div>
                            <div class="nutrition-remaining" id="remainingProtein">ê³„ì‚° ì¤‘...</div>
                        </div>
                        <div class="nutrition-card nutrition-fat">
                            <div class="nutrition-label">ì§€ë°©</div>
                            <div class="nutrition-value" id="todayFat">0</div>
                            <div class="nutrition-remaining" id="remainingFat">ê³„ì‚° ì¤‘...</div>
                        </div>
                    </div>

                    <div style="border-top: 1px solid #e0e0e0; margin: 20px 0;"></div>

                    <!-- ì‹ì‚¬ ì…ë ¥ -->
                    <h4 style="font-size: 0.95rem; color: #666; margin-bottom: 10px;">ğŸ´ ì‹ì‚¬ ê¸°ë¡í•˜ê¸°</h4>
                    <div class="meal-input-buttons">
                        <button class="meal-btn meal-btn-breakfast" onclick="openMealInputModal('ì•„ì¹¨')">
                            <span class="meal-emoji">ğŸŒ…</span>
                            <span class="meal-label">ì•„ì¹¨</span>
                        </button>
                        <button class="meal-btn meal-btn-lunch" onclick="openMealInputModal('ì ì‹¬')">
                            <span class="meal-emoji">â˜€ï¸</span>
                            <span class="meal-label">ì ì‹¬</span>
                        </button>
                        <button class="meal-btn meal-btn-dinner" onclick="openMealInputModal('ì €ë…')">
                            <span class="meal-emoji">ğŸŒ™</span>
                            <span class="meal-label">ì €ë…</span>
                        </button>
                        <button class="meal-btn meal-btn-snack" onclick="openMealInputModal('ê°„ì‹')">
                            <span class="meal-emoji">ğŸª</span>
                            <span class="meal-label">ê°„ì‹</span>
                        </button>
                    </div>




                </div>

                <!-- ğŸ”¥ v3.9.3: ì²´ì¤‘ ê·¸ë˜í”„ëŠ” ëª¨ë‹¬ì—ì„œë§Œ í‘œì‹œ (í™ˆ íƒ­ì—ì„œ ì œê±°ë¨) -->

                <div class="ai-chat-section">
                    <div class="ai-chat-summary" onclick="toggleAIChat()">
                        <div>
                            <h3 class="card-title">ğŸ¤– AI ì½”ì¹˜</h3>
                            <p style="font-size: 0.9rem; color: #666;">í´ë¦­í•˜ì—¬ ì±„íŒ…í•˜ê¸°</p>
                        </div>
                        <span style="font-size: 1.5rem;">â–¼</span>
                    </div>
                    <div class="ai-chat-details" id="aiChatDetails">
                        <div class="ai-chat-messages" id="aiChatMessages"></div>
                        <div class="ai-chat-input-area">
                            <input type="text" class="ai-chat-input" id="aiChatInput" placeholder="ì˜ˆ: ì–´ì œë‘ ë¹„êµí•´ì¤˜">
                            <button class="ai-chat-send" onclick="sendAIMessage()">ì „ì†¡</button>
                        </div>
                    </div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                    <h3 class="card-title" style="color: #1976d2;">ğŸ’§ ìŠ¤ë§ˆíŠ¸ ë¬¼ ë§ˆì‹œê¸°</h3>
                    
                    <!-- ğŸ”¥ v3.9.3: ê°„ê²°í•œ ë””ìì¸ìœ¼ë¡œ ê°œì„  -->
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 2.5rem; font-weight: bold; color: #1976d2; margin-bottom: 10px;">
                            <span id="waterIntake">0</span><span style="font-size: 1.5rem;">ml</span>
                        </div>
                        <div style="font-size: 1rem; color: #666; margin-bottom: 15px;">
                            ëª©í‘œ: <span id="waterGoalDisplay">2000 ml</span> (<span id="waterPercentage">0%</span>)
                        </div>
                        
                        <!-- ì§„í–‰ë°” -->
                        <div style="background: #fff; border-radius: 50px; height: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                            <div id="waterProgressBar" style="background: linear-gradient(90deg, #2196f3 0%, #03a9f4 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        
                        <!-- ë¹ ë¥¸ ì¶”ê°€ ë²„íŠ¼ -->
                        <div id="waterButtonsContainer" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                            <!-- ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                        
                        <!-- ì»¤ìŠ¤í…€ ë²„íŠ¼ ì¶”ê°€ ì˜ì—­ -->
                        <div style="margin-top: 15px; padding: 15px; background: #f0f7ff; border-radius: 12px; border: 2px dashed #2196f3;">
                            <div style="display: flex; gap: 8px; align-items: center; justify-content: center; flex-wrap: wrap;">
                                <input type="number" id="customWaterAmount" placeholder="ì˜ˆ: 300" min="1" step="1" onkeypress="if(event.key==='Enter') addCustomWaterButton()" style="width: 100px; padding: 8px; border: 2px solid #2196f3; border-radius: 8px; font-size: 0.9rem;">
                                <span style="font-weight: bold; color: #1976d2;">ml</span>
                                <button onclick="addCustomWaterButton()" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
                                    â• ì¶”ê°€
                                </button>
                            </div>
                        </div>
                        
                        <!-- ìµœê·¼ ê¸°ë¡ ë° ì·¨ì†Œ ê¸°ëŠ¥ (ê°œì„ ëœ ë””ìì¸) -->
                        <div id="waterRecordsContainer" style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 16px; border: 1px solid rgba(33, 150, 243, 0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 1.1rem;">ğŸ’§</span>
                                    <span style="color: #1976d2; font-size: 0.9rem; font-weight: 600;">ìµœê·¼ ê¸°ë¡</span>
                                </div>
                                <span style="color: #999; font-size: 0.75rem;">í˜¸ë²„í•˜ì—¬ ì·¨ì†Œ</span>
                            </div>
                            <div id="waterRecordsList" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px;">
                                <!-- ê¸°ë¡ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                        
                        <!-- ì„¤ì • (ì ‘ê¸° ê°€ëŠ¥) -->
                        <details style="margin-top: 20px; background: white; padding: 15px; border-radius: 12px;">
                            <summary style="cursor: pointer; font-weight: bold; color: #1976d2;">âš™ï¸ ëª©í‘œ ì„¤ì •</summary>
                            <div class="water-settings" style="margin-top: 15px;">
                                <div style="display: flex; align-items: center; gap: 5px; justify-content: center;">
                                    <label style="font-size: 0.9rem;">ì¼ì¼ ëª©í‘œ:</label>
                                    <input type="number" id="waterGoal" placeholder="2" value="2" step="0.1" style="width: 60px; padding: 8px; border: 2px solid #2196f3; border-radius: 8px;">
                                    <span class="unit-label">L</span>
                                </div>
                                <button class="btn-add-weight" onclick="updateWaterTracker()" style="margin-top: 10px; background: #2196f3; color: white;">ì ìš©</button>
                            </div>
                        </details>
                    </div>
                </div>
            </div>

            <!-- í”Œëœ íƒ­ -->
            <div id="tab-plan" class="tab-content">
                <!-- ì˜¤ëŠ˜ì˜ ëª©í‘œ -->
                <div class="card">
                    <h3 class="card-title">ğŸ¯ ì˜¤ëŠ˜ì˜ ëª©í‘œ</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">ëª©í‘œë¥¼ ì²´í¬í•˜ë©° í•˜ë£¨ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>

                    <!-- ê¸°ë³¸ ëª©í‘œ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
                    <div class="goal-checklist" id="goalChecklist">
                        <!-- 1. ë¬¼ ë§ˆì‹œê¸° (í¸ì§‘ ê°€ëŠ¥) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-water" onchange="saveGoals()">
                            <span class="goal-icon">ğŸ’§</span>
                            <span class="goal-text" id="goal-water-text">ë¬¼ 2L ë§ˆì‹œê¸°</span>
                            <span class="goal-status" id="goal-water-status">0L / 2L</span>
                            <button class="edit-goal-btn" onclick="editGoalText('water', 'ëª©í‘œ ë¬¼ ì„­ì·¨ëŸ‰ (L)')">âœï¸</button>
                            <span class="goal-check">âœ“</span>
                        </label>

                        <!-- 2. ê°„í—ì  ë‹¨ì‹ (í¸ì§‘ ê°€ëŠ¥) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-fasting" onchange="saveGoals()">
                            <span class="goal-icon">â±ï¸</span>
                            <span class="goal-text" id="goal-fasting-text">ê°„í—ì  ë‹¨ì‹ 16ì‹œê°„</span>
                            <span class="goal-status" id="goal-fasting-status">ë¯¸ì§„í–‰</span>
                            <button class="edit-goal-btn" onclick="editGoalText('fasting', 'ë‹¨ì‹ ì‹œê°„ (ì‹œê°„)')">âœï¸</button>
                            <span class="goal-check">âœ“</span>
                        </label>

                        <!-- 3. ì €ë… ê¸ˆì‹ (í¸ì§‘ ê°€ëŠ¥) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-dinner" onchange="saveGoals()">
                            <span class="goal-icon">ğŸŒ™</span>
                            <span class="goal-text" id="goal-dinner-text">ì €ë… 8ì‹œ ì´í›„ ê¸ˆì‹</span>
                            <span class="goal-status" id="goal-dinner-status">-</span>
                            <button class="edit-goal-btn" onclick="editGoalText('dinner', 'ê¸ˆì‹ ì‹œì‘ ì‹œê°„ (ì˜ˆ: 20)')">âœï¸</button>
                            <span class="goal-check">âœ“</span>
                        </label>

                        <!-- 4. ìš´ë™ (í¸ì§‘ ê°€ëŠ¥) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-exercise" onchange="saveGoals()">
                            <span class="goal-icon">ğŸ’ª</span>
                            <span class="goal-text" id="goal-exercise-text">ìš´ë™ 30ë¶„ ì´ìƒ</span>
                            <button class="edit-goal-btn" onclick="editGoalText('exercise', 'ìš´ë™ ì‹œê°„ (ë¶„)')">âœï¸</button>
                            <span class="goal-check">âœ“</span>
                        </label>

                        <!-- 5. ëª©í‘œ ì¹¼ë¡œë¦¬ (í¸ì§‘ ê°€ëŠ¥) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-calories" onchange="saveGoals()">
                            <span class="goal-icon">ğŸ½ï¸</span>
                            <span class="goal-text" id="goal-calories-text">ëª©í‘œ ì¹¼ë¡œë¦¬ ì§€í‚¤ê¸°</span>
                            <span class="goal-status" id="goal-calories-status">0 / ëª©í‘œkcal</span>
                            <button class="edit-goal-btn" onclick="editGoalText('calories', 'ëª©í‘œ ì¹¼ë¡œë¦¬ (kcal)')">âœï¸</button>
                            <button class="edit-goal-btn" onclick="resetCalorieGoal()" style="background: #ff5252; margin-left: 3px;" title="ê¸°ë³¸ê°’ìœ¼ë¡œ ì¬ì„¤ì •">ğŸ”„</button>
                            <span class="goal-check">âœ“</span>
                        </label>

                        <!-- 6. ì²´ì¤‘ ê¸°ë¡ (ìë™ ì²´í¬) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-weight" onchange="saveGoals()">
                            <span class="goal-icon">âš–ï¸</span>
                            <span class="goal-text">ì²´ì¤‘ ê¸°ë¡í•˜ê¸°</span>
                            <span class="goal-status" id="goal-weight-status">ë¯¸ê¸°ë¡</span>
                            <span class="goal-check">âœ“</span>
                        </label>
                    </div>

                    <!-- ëª©í‘œ ë‹¬ì„±ë¥  í‘œì‹œ -->
                    <div class="goal-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="goalProgressBar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="goalProgressText">0 / 6 ì™„ë£Œ (0%)</div>
                    </div>

                    <!-- ë‚˜ë§Œì˜ ëª©í‘œ ì¶”ê°€ -->
                    <div class="custom-goal-input">
                        <input type="text" id="customGoalInput" placeholder="+ ë‚˜ë§Œì˜ ëª©í‘œ ì¶”ê°€í•˜ê¸°" maxlength="30">
                        <button onclick="addCustomGoal()">ì¶”ê°€</button>
                    </div>

                    <!-- ì»¤ìŠ¤í…€ ëª©í‘œ ë¦¬ìŠ¤íŠ¸ -->
                    <div class="custom-goals" id="customGoalsList"></div>
                </div>

                <!-- ì¼ê¸° ê¸°ëŠ¥ -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title">ğŸ“ ì˜¤ëŠ˜ì˜ ë‹¤ì§</h3>
                    <textarea id="dailyDiary"
                              placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì–´ë–»ê²Œ ë³´ëƒˆë‚˜ìš”? ì„±ê³µí•œ ê²ƒ, ë°˜ì„±í•  ê²ƒ, ë‚´ì¼ì˜ ë‹¤ì§ì„ ê¸°ë¡í•´ë³´ì„¸ìš”..."
                              style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; resize: vertical; font-family: inherit;"
                              oninput="updateCharCount(); saveDiary()"
                              onchange="saveDiary()"></textarea>
                    <div style="text-align: right; margin-top: 10px; font-size: 0.9rem; color: #666;">
                        <span id="diaryCharCount">0</span> / 500ì
                    </div>
                </div>

                <!-- ì´ë²ˆ ì£¼ ëª©í‘œ ë‹¬ì„± í†µê³„ -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title">ğŸ“Š ì´ë²ˆ ì£¼ ëª©í‘œ ë‹¬ì„±</h3>
                    <div class="weekly-stats" id="weeklyStats">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>

            <!-- ë‹¨ì‹ íƒ­ -->
            <div id="tab-fasting" class="tab-content">
                <!-- ğŸ”¥ ë‹¨ì‹ ìŠ¤íŠ¸ë¦­ & í†µê³„ (ìµœìƒë‹¨) -->
                <div class="fasting-streak-card">
                    <div style="display: flex; justify-content: space-around; align-items: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #ff6b6b;" id="fastingStreak">0</div>
                            <div style="font-size: 0.9rem; color: white; margin-top: 5px;">ğŸ”¥ ì—°ì† ì¼ìˆ˜</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #4ecdc4;" id="totalFastingDays">0</div>
                            <div style="font-size: 0.9rem; color: white; margin-top: 5px;">ğŸ¯ ì´ ë‹¨ì‹ ì¼ìˆ˜</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #a8e6cf;" id="avgFastingHours">0</div>
                            <div style="font-size: 0.9rem; color: white; margin-top: 5px;">â±ï¸ í‰ê·  ì‹œê°„</div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ† ë°°ì§€ ì‹œìŠ¤í…œ -->
                <div class="fasting-badges-card">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">ğŸ† ë‹¬ì„± ë°°ì§€</h4>
                    <div class="badges-grid" id="badgesGrid">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>

                <!-- ğŸ“Š ì›”ê°„ ë‹¨ì‹ ë¦¬í¬íŠ¸ -->
                <div class="fasting-monthly-report">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="font-size: 1rem; color: #555; font-weight: 600;">ğŸ“Š ì›”ê°„ ë¦¬í¬íŠ¸</h4>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="changeReportMonth(-1)" style="padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">â—€</button>
                            <span id="reportMonth" style="padding: 5px 15px; font-weight: 600; color: #667eea;">2025ë…„ 12ì›”</span>
                            <button onclick="changeReportMonth(1)" style="padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">â–¶</button>
                        </div>
                    </div>
                    <div class="monthly-stats-grid">
                        <div class="monthly-stat-item">
                            <div class="monthly-stat-value" id="monthlyTotalDays">0</div>
                            <div class="monthly-stat-label">ë‹¨ì‹ ì¼ìˆ˜</div>
                        </div>
                        <div class="monthly-stat-item">
                            <div class="monthly-stat-value" id="monthlyAvgHours">0h</div>
                            <div class="monthly-stat-label">í‰ê·  ì‹œê°„</div>
                        </div>
                        <div class="monthly-stat-item">
                            <div class="monthly-stat-value" id="monthlyLongest">0h</div>
                            <div class="monthly-stat-label">ìµœì¥ ì‹œê°„</div>
                        </div>
                        <div class="monthly-stat-item">
                            <div class="monthly-stat-value" id="monthlyWeightChange">0kg</div>
                            <div class="monthly-stat-label">ì²´ì¤‘ ë³€í™”</div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ“… ì›”ê°„ ë‹¨ì‹ ë‹¬ë ¥ -->
                <div class="fasting-calendar-card">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">ğŸ“… ì›”ê°„ ë‹¨ì‹ ë‹¬ë ¥</h4>
                    <div class="fasting-calendar" id="fastingCalendar">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </div>

                <!-- ğŸ“Š ì²´ì¤‘ ì—°ë™ ê·¸ë˜í”„ -->
                <div class="fasting-weight-chart-card">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">ğŸ“Š ë‹¨ì‹ & ì²´ì¤‘ ë³€í™”</h4>
                    <canvas id="fastingWeightChart" style="max-height: 300px;"></canvas>
                    <div style="margin-top: 10px; font-size: 0.85rem; color: #888; text-align: center;">
                        íŒŒë€ìƒ‰: ë‹¨ì‹ ì‹œê°„ | ì´ˆë¡ìƒ‰: ì²´ì¤‘
                    </div>
                </div>

                <!-- ğŸ’§ ë‹¨ì‹ ì¤‘ ë¬¼ ì„­ì·¨ ë¦¬ë§ˆì¸ë” -->
                <div class="fasting-water-reminder">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">ğŸ’§ ë‹¨ì‹ ì¤‘ ë¬¼ ì„­ì·¨ (í™ˆ íƒ­ ì—°ë™)</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 12px;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;" id="fastingWaterIntake">0ml</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">ì˜¤ëŠ˜ ë¬¼ ì„­ì·¨ëŸ‰ (í™ˆ íƒ­ ë™ê¸°í™”)</div>
                        </div>
                        <button onclick="quickAddWaterCup()" style="padding: 12px 20px; background: white; border: none; border-radius: 12px; font-weight: 600; color: #4ecdc4; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" id="quickAddWaterBtn">
                            +250ml ğŸ’§
                        </button>
                    </div>
                    <div style="margin-top: 12px; font-size: 0.85rem; color: #888;">
                        ğŸ’¡ ë‹¨ì‹ ì¤‘ì—ëŠ” í•˜ë£¨ 2~3Lì˜ ë¬¼ì„ ë§ˆì…”ì£¼ì„¸ìš”. íƒˆìˆ˜ ì˜ˆë°©ê³¼ ë…¸íë¬¼ ë°°ì¶œì— ë„ì›€ì´ ë©ë‹ˆë‹¤.<br>
                        âš¡ í™ˆ íƒ­ì˜ "ìŠ¤ë§ˆíŠ¸ ë¬¼ë§ˆì‹œê¸°"ì™€ ì™„ì „ ë™ê¸°í™”ë©ë‹ˆë‹¤!
                    </div>
                </div>

                <!-- ğŸ‘ ì£¼ê°„ ë¦¬í¬íŠ¸ -->
                <div class="fasting-weekly-report">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">ğŸ‘ ì£¼ê°„ ë¦¬í¬íŠ¸</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; line-height: 1.7;" id="weeklyReportText">
                        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>

                <!-- ğŸ‘ ì›”ê°„ ë¦¬í¬íŠ¸ í…ìŠ¤íŠ¸ -->
                <div class="fasting-monthly-report-text">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">ğŸ“„ ì›”ê°„ ìš”ì•½</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; line-height: 1.7;" id="monthlyReportText">
                        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>

                <!-- ğŸ‘ ì´ë²ˆ ì£¼ ë‹¨ì‹ í˜„í™© -->
                <div class="fasting-weekly-card">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">ğŸ“Š ì´ë²ˆ ì£¼ ë‹¨ì‹ í˜„í™©</h4>
                    <div class="weekly-fasting-grid" id="weeklyFastingGrid">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                    <div style="margin-top: 12px; font-size: 0.85rem; color: #888; text-align: center;" id="weeklyGoalStatus">
                        ì£¼ê°„ ëª©í‘œ: 5íšŒ ë‹¨ì‹ / í˜„ì¬: 0íšŒ ì™„ë£Œ
                    </div>
                </div>

                <div class="fasting-timer-card">
                    <!-- íƒ€ì´ë¨¸ ìƒë‹¨ì— í˜„ì¬ ìƒíƒœ í‘œì‹œ -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8); margin-bottom: 5px;" id="fastingStatusText">ë‹¨ì‹ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7);" id="lastMealTime"></div>
                    </div>

                    <div class="fasting-svg-container">
                        <svg width="250" height="250">
                            <circle class="fasting-circle-bg" cx="125" cy="125" r="110" />
                            <circle class="fasting-circle-progress" id="fastingProgress" cx="125" cy="125" r="110"
                                    stroke-dasharray="691" stroke-dashoffset="691" />
                        </svg>
                        <div class="fasting-time-display">
                            <div class="fasting-time-main" id="fastingTimeMain">00:00:00</div>
                            <div class="fasting-time-sub" id="fastingTimeSub">ë‹¨ì‹ ì‹œê°„ ì„ íƒ</div>
                        </div>
                    </div>

                    <!-- í˜„ì¬ ë‹¨ì‹ ë‹¨ê³„ í‘œì‹œ -->
                    <div id="fastingStageDisplay" style="text-align: center; margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white; display: none;">
                        <div style="font-size: 2rem;" id="fastingStageEmoji">ğŸ½ï¸</div>
                        <div style="font-size: 1.1rem; font-weight: bold; margin-top: 5px;" id="fastingStageTitle">ì†Œí™” ë‹¨ê³„</div>
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px;" id="fastingStageDesc">ìŒì‹ì„ ì†Œí™”í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤</div>
                    </div>

                    <!-- í”„ë¦¬ì…‹ ë²„íŠ¼ (ë‹¨ì‹ ì‹œì‘ ì „ì—ë§Œ í‘œì‹œ) -->
                    <div id="fastingPresetSection" style="margin-bottom: 20px;">
                        <div style="text-align: center; font-size: 0.95rem; color: rgba(255,255,255,0.9); margin-bottom: 12px; font-weight: 600;">â° ë‹¨ì‹ ì‹œê°„ ì„ íƒ</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <button class="fasting-preset-btn-new" onclick="startFastingQuick(12)">
                                <div style="font-size: 1.2rem; font-weight: 800;">12h</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">12:12</div>
                            </button>
                            <button class="fasting-preset-btn-new" onclick="startFastingQuick(16)">
                                <div style="font-size: 1.2rem; font-weight: 800;">16h</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">16:8 â­</div>
                            </button>
                            <button class="fasting-preset-btn-new" onclick="startFastingQuick(18)">
                                <div style="font-size: 1.2rem; font-weight: 800;">18h</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">18:6</div>
                            </button>
                            <button class="fasting-preset-btn-new" onclick="startFastingQuick(20)">
                                <div style="font-size: 1.2rem; font-weight: 800;">20h</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">20:4</div>
                            </button>
                            <button class="fasting-preset-btn-new" onclick="startFastingQuick(24)">
                                <div style="font-size: 1.2rem; font-weight: 800;">24h</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">OMAD</div>
                            </button>
                            <button class="fasting-preset-btn-new" onclick="openCustomFastingModal()" style="background: rgba(168, 237, 234, 0.3); border-color: rgba(168, 237, 234, 0.6);">
                                <div style="font-size: 1.2rem; font-weight: 800;">âš™ï¸</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">ì»¤ìŠ¤í…€</div>
                            </button>
                        </div>
                        <!-- ë§ˆì§€ë§‰ ì‹ì‚¬ ì‹œê°„ ê¸°ë¡ ë²„íŠ¼ -->
                        <button onclick="recordLastMealTime()" style="width: 100%; margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                            ğŸ½ï¸ ë§ˆì§€ë§‰ ì‹ì‚¬ ì‹œê°„ ê¸°ë¡
                        </button>
                    </div>

                    <!-- ì§„í–‰ ì¤‘ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
                    <div id="fastingActiveControls" class="fasting-controls" style="display: none; gap: 8px;">
                        <button class="fasting-btn-pause" id="fastingPauseBtn" onclick="pauseFasting()" style="flex: 1;">â¸ï¸ ì¼ì‹œì •ì§€</button>
                        <button class="fasting-btn-resume" id="fastingResumeBtn" onclick="resumeFasting()" style="display: none; flex: 1;">â–¶ï¸ ì¬ê°œ</button>
                        <button class="fasting-btn-stop" onclick="stopFasting()" style="flex: 1;">â¹ï¸ ì¤‘ë‹¨</button>
                        <button onclick="extendFasting()" style="flex: 0.8; padding: 15px 15px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">â°+1h</button>
                    </div>
                </div>

                <!-- ğŸ“Š ì˜¤ëŠ˜ì˜ ëˆ„ì  ë‹¨ì‹ ì‹œê°„ (í•˜ë‹¨ ì´ë™) -->
                <div class="fasting-today-summary">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 10px; font-weight: 600;">ğŸ“Š ì˜¤ëŠ˜ì˜ ëˆ„ì  ë‹¨ì‹</h4>
                    <div style="font-size: 2rem; font-weight: bold; color: #667eea; margin: 10px 0;" id="accumulatedTime">0ì‹œê°„ 0ë¶„</div>
                    <div class="accumulated-sessions" id="fastingSessions">
                        <!-- ì„¸ì…˜ ëª©ë¡ ìë™ í‘œì‹œ -->
                    </div>
                </div>

                <!-- ê°„ë‹¨í•œ íŒ ì¹´ë“œ -->
                <div class="fasting-tips-card">
                    <details>
                        <summary style="font-weight: 600; cursor: pointer; padding: 12px; background: #f8f9fa; border-radius: 8px;">ğŸ’¡ ë‹¨ì‹ íš¨ê³¼ & íŒ</summary>
                        <div style="padding: 15px; line-height: 1.7;">
                            <p style="margin-bottom: 10px;"><strong>ğŸ”¬ ìê°€í¬ì‹(Autophagy)</strong>ì€ 12~16ì‹œê°„ í›„ í™œì„±í™”ë˜ì–´ ì†ìƒëœ ì„¸í¬ë¥¼ ì¬ìƒí•©ë‹ˆë‹¤.</p>
                            <p style="margin-bottom: 10px;"><strong>ì£¼ìš” íš¨ê³¼:</strong> ì²´ì¤‘ ê°ëŸ‰, ì¸ìŠë¦° ê°œì„ , ì„¸í¬ ì¬ìƒ, ì§‘ì¤‘ë ¥ í–¥ìƒ</p>
                            <p style="color: #ff5252; font-weight: 500;">âš ï¸ ë‹¹ë‡¨ë³‘, ì„ì‚°ë¶€, ì²­ì†Œë…„ì€ ì£¼ì˜ í•„ìš”. ì–´ì§€ëŸ¬ì›€ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ì„¸ìš”.</p>
                        </div>
                    </details>
                </div>
            </div>

            <!-- ì•¨ë²” íƒ­ -->
            <div id="tab-album" class="tab-content">
                <div class="card">
                    <!-- ì•¨ë²” í—¤ë” -->
                    <div class="album-header">
                        <div>
                            <h3 class="card-title">ğŸ“¸ ë‚˜ì˜ ë³€í™” ì•¨ë²”</h3>
                            <div id="storageUsageDisplay" style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                ìŠ¤í† ë¦¬ì§€: <span id="storageUsageText">0MB</span> / 4.5GB
                            </div>
                        </div>
                        <button class="select-mode-btn" id="selectModeBtn" onclick="toggleSelectMode()">ì„ íƒ</button>
                    </div>

                    <!-- ì„ íƒ ëª¨ë“œ ì•¡ì…˜ ë°” -->
                    <div class="select-action-bar hidden" id="selectActionBar">
                        <div class="selected-count" id="selectedCount">0ê°œ ì„ íƒë¨</div>
                        <div class="select-actions">
                            <button class="action-btn download-btn" onclick="downloadSelectedItems()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                            <button class="action-btn share-btn" onclick="shareSelectedItems()">ğŸ“¤ ê³µìœ </button>
                            <button class="action-btn cancel-btn" onclick="cancelSelectMode()">ì·¨ì†Œ</button>
                        </div>
                    </div>

                    <div class="album-tabs">
                        <button class="album-tab active" onclick="changeAlbumTab('all')">ì „ì²´</button>
                        <button class="album-tab" onclick="changeAlbumTab('body')">ëˆˆë°”ë””</button>
                        <button class="album-tab" onclick="changeAlbumTab('food')">ì‹ë‹¨</button>
                        <button class="album-tab" onclick="changeAlbumTab('exercise')">ìš´ë™</button>
                    </div>
                    <div class="photo-grid" id="photoGrid">
                        <!-- 'ì „ì²´' íƒ­ì´ ê¸°ë³¸ì´ë¯€ë¡œ + ë²„íŠ¼ ì—†ìŒ, JavaScriptê°€ íƒ­ ì „í™˜ ì‹œ ë™ì ìœ¼ë¡œ ì¶”ê°€ -->
                    </div>
                </div>
            </div>

            <!-- ìº˜ë¦°ë” íƒ­ -->
            <div id="tab-calendar" class="tab-content">
                <!-- ì£¼ê°„ ìš”ì•½ ëŒ€ì‹œë³´ë“œ -->
                <div class="weekly-summary-card" id="weeklySummary">
                    <div class="weekly-summary-header">
                        <h3>ğŸ“Š ì£¼ê°„ ìš”ì•½</h3>
                        <button class="summary-toggle-btn" onclick="toggleWeeklySummary()">ì ‘ê¸°</button>
                    </div>
                    <div class="weekly-summary-content" id="weeklySummaryContent">
                        <div class="summary-loading">ë¡œë”© ì¤‘...</div>
                    </div>
                </div>

                <!-- AI ì½”ì¹­ ë©”ì‹œì§€ -->
                <div class="ai-coaching-card" id="aiCoachingCard">
                    <div class="ai-coach-header">
                        <span>ğŸ¤– AI ì½”ì¹˜ì˜ í•œë§ˆë””</span>
                    </div>
                    <div class="ai-coach-message" id="aiCoachMessage">
                        "ì£¼ê°„ ìš”ì•½ì„ í™•ì¸í•˜ê³  ê³„ì† í˜ë‚´ì„¸ìš”! ğŸ’ª"
                    </div>
                </div>

                <div class="calendar">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">â—€</button>
                        <div class="calendar-month" id="calendarMonth">2025ë…„ 1ì›”</div>
                        <button class="calendar-nav" onclick="changeMonth(1)">â–¶</button>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-day-label">ì¼</div>
                        <div class="calendar-day-label">ì›”</div>
                        <div class="calendar-day-label">í™”</div>
                        <div class="calendar-day-label">ìˆ˜</div>
                        <div class="calendar-day-label">ëª©</div>
                        <div class="calendar-day-label">ê¸ˆ</div>
                        <div class="calendar-day-label">í† </div>
                    </div>
                    <div class="calendar-grid" id="calendarDays"></div>
                </div>
            </div>

            <!-- ì†Œí†µ íƒ­ -->
            <div id="tab-community" class="tab-content">
                <div class="chat-container" id="chatContainer"></div>
            </div>
            <div class="chat-input-container hidden" id="chatInputContainer">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="communityInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                    <button class="send-btn" onclick="sendCommunityMessage()">ì „ì†¡</button>
                </div>
            </div>

            <!-- ğŸ”¥ v3.9.1: ìš´ë™ íƒ­ -->
            <div id="tab-exercise" class="tab-content">
                <div class="card">
                    <h3 class="card-title">ğŸ”¥ ìš´ë™ ì¹¼ë¡œë¦¬ ê³„ì‚°ê¸°</h3>
                    <p style="color: #667eea; font-size: 0.95rem; margin-bottom: 10px; font-weight: 600;">ğŸ’¡ ìš´ë™ë¿ ì•„ë‹ˆë¼ ê²½ë³´, ê³„ë‹¨ ì˜¤ë¥´ê¸°, ë…¸ë˜ ë¶€ë¥´ê¸° ë“± ëª¨ë“  í™œë™ ê°€ëŠ¥!</p>
                    <p style="color: #666; font-size: 0.85rem; margin-bottom: 20px;">í™œë™ ì¢…ë¥˜ì™€ ì‹œê°„ì„ ì…ë ¥í•˜ë©´ AIê°€ ì†Œëª¨ ì¹¼ë¡œë¦¬ë¥¼ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤</p>
                    
                    <!-- ìš´ë™ ì…ë ¥ í¼ -->
                    <div class="exercise-input-form">
                        <div class="form-group">
                            <label class="form-label">ìš´ë™ ì¢…ë¥˜</label>
                            <input type="text" id="exerciseType" class="form-input" placeholder="ì˜ˆ: íƒêµ¬, ëŸ°ë‹, ìˆ˜ì˜, ìì „ê±°..." style="margin-bottom: 12px;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ìš´ë™ ì‹œê°„ (ë¶„)</label>
                            <input type="number" id="exerciseDuration" class="form-input" placeholder="ì˜ˆ: 60" min="1" style="margin-bottom: 12px;">
                        </div>
                        
                        <button class="btn-add-plan" onclick="analyzeExercise()" style="width: 100%; margin-top: 10px;">
                            ğŸ¤– AIë¡œ ì¹¼ë¡œë¦¬ ê³„ì‚°í•˜ê¸°
                        </button>
                        
                        <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
                        <p style="margin-top: 12px; font-size: 0.85rem; color: #999; text-align: center;">
                            âš ï¸ í†µìƒì ì¸ ë¶„ì„ ê²°ê³¼ì´ë©° ê°œì¸ì°¨ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                        </p>
                    </div>

                    <!-- ë¶„ì„ ê²°ê³¼ í‘œì‹œ -->
                    <div id="exerciseAnalysisResult" style="display: none; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
                        <h4 style="margin: 0 0 15px 0; font-size: 1.1rem;">ğŸ“Š ë¶„ì„ ê²°ê³¼</h4>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 0.95rem;">ì†Œëª¨ ì¹¼ë¡œë¦¬</span>
                            <span style="font-size: 1.5rem; font-weight: bold;" id="exerciseCaloriesResult">0 kcal</span>
                        </div>
                        
                        <!-- ğŸ”¥ ê³¼í•™ì  ë¶„ì„ ì¶”ê°€ -->
                        <div id="exerciseScientificAnalysis" style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; margin-top: 12px; font-size: 0.85rem;">
                            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px; margin-top: 12px;">
                            <div style="font-size: 0.9rem; opacity: 0.9;" id="exerciseAdvice">AI ì¡°ì–¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                        </div>
                        <button class="btn-add-plan" onclick="saveExerciseRecord()" style="width: 100%; margin-top: 15px; background: white; color: #667eea;">
                            âœ… ìš´ë™ ê¸°ë¡ ì €ì¥
                        </button>
                    </div>
                </div>

                <!-- ğŸ”¥ v3.9.3: ìš´ë™ ì¹¼ë¡œë¦¬ ê³„ì‚°ê¸° -->
                <div class="card">
                    <h3 class="card-title">âš¡ í•˜ë£¨ ìš´ë™ & ê¸°ë¡</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px; line-height: 1.6;">
                        ğŸ’¡ <b>ëª¨ë“  í™œë™ì´ ìš´ë™ì…ë‹ˆë‹¤!</b><br>
                        ê±·ê¸°, ê³„ë‹¨ ì˜¤ë¥´ê¸°, ë…¸ë˜ ë¶€ë¥´ê¸°, ì²­ì†Œ, ì‡¼í•‘ ë“± ì¼ìƒì˜ ëª¨ë“  í™œë™ì„ ê¸°ë¡í•˜ì„¸ìš”.
                    </p>
                    <div id="todayExerciseList" style="margin-top: 15px;">
                        <p style="text-align: center; color: #999; padding: 30px;">ì•„ì§ ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                    
                    <!-- ì´ ìš´ë™ í†µê³„ -->
                    <div style="margin-top: 20px; padding: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; color: white; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.25);">
                        <h4 style="margin: 0 0 20px 0; font-size: 1.1rem; font-weight: 700; color: #ffffff; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">ğŸ“Š ì˜¤ëŠ˜ í•˜ë£¨ ìš´ë™ ì´ ì¹¼ë¡œë¦¬</h4>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 12px; backdrop-filter: blur(10px);">
                            <span style="font-size: 1rem; font-weight: 600; color: #ffffff;">ì´ ìš´ë™ ì‹œê°„</span>
                            <span style="font-weight: 700; font-size: 1.3rem; color: #ffffff; text-shadow: 0 2px 4px rgba(0,0,0,0.15);" id="totalExerciseTime">0ë¶„</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.2); border-radius: 12px; backdrop-filter: blur(10px);">
                            <span style="font-size: 1rem; font-weight: 600; color: #ffffff;">ì´ ì†Œëª¨ ì¹¼ë¡œë¦¬</span>
                            <span style="font-weight: 700; font-size: 1.8rem; color: #ffffff; text-shadow: 0 2px 6px rgba(0,0,0,0.2);" id="totalExerciseCalories">0 kcal</span>
                        </div>
                        
                        <!-- ğŸ”¥ ê³¼í•™ì  ë°ì´í„° íŒ©íŠ¸ -->
                        <div id="dailyExerciseAnalysis" style="background: rgba(255,255,255,0.2); padding: 16px; border-radius: 12px; font-size: 0.9rem; line-height: 1.7; color: #ffffff; backdrop-filter: blur(10px);">
                            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                        </div>
                    </div>
                </div>

                <!-- ì£¼ê°„ ìš´ë™ í†µê³„ -->
                <div class="card">
                    <h3 class="card-title">ğŸ“Š ì£¼ê°„ ìš´ë™ í†µê³„</h3>
                    <div id="weeklyExerciseChart" style="margin-top: 20px;">
                        <canvas id="exerciseChart" style="max-height: 250px;"></canvas>
                    </div>
                    <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">ì£¼ê°„ í‰ê· </div>
                            <div style="font-weight: bold; color: #333; font-size: 1.2rem;" id="weeklyAvgTime">0ë¶„/ì¼</div>
                        </div>
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                            <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">ì´ ì†Œëª¨</div>
                            <div style="font-weight: bold; color: #667eea; font-size: 1.2rem;" id="weeklyTotalCal">0 kcal</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ì•Œë¦¼ íƒ­ -->
            <div id="tab-notification" class="tab-content">
                <div class="card">
                    <h3 class="card-title">ğŸ”” ì•Œë¦¼ ê´€ë¦¬</h3>
                    <button class="btn-add-plan" style="width: 100%; margin-bottom: 15px;" onclick="openAddNotificationModal()">
                        + ìƒˆ ì•Œë¦¼ ì¶”ê°€
                    </button>
                    <button class="btn-add-plan" style="width: 100%; margin-bottom: 15px; background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);" onclick="addWaterNotificationPreset()">
                        ğŸ’§ ë¬¼ ë§ˆì‹œê¸° ì•Œë¦¼ (5íšŒ) í•œë²ˆì— ì¶”ê°€
                    </button>
                    <div class="notification-list" id="notificationList"></div>
                </div>
            </div>

            <!-- ì„¤ì • íƒ­ -->
            <div id="tab-settings" class="tab-content">
                <div class="pwa-install-banner hidden" id="pwaInstallBanner">
                    <div class="pwa-install-text">
                        <strong>ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</strong>
                        <span style="font-size: 0.9rem;">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê³  ë” í¸í•˜ê²Œ ì‚¬ìš©í•˜ì„¸ìš”!</span>
                    </div>
                    <button class="pwa-install-btn" onclick="installPWA()">ì„¤ì¹˜</button>
                </div>

                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">ğŸ’ª</div>
                        <div class="profile-info">
                            <h3 id="profileName">ì‚¬ìš©ì</h3>
                            <p id="profileEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e2878f838b8ea2879a838f928e87cc818d8f">[email&#160;protected]</a></p>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item" onclick="showDaysActiveDetail()" style="cursor: pointer;">
                            <div class="stat-value" id="totalDays">0</div>
                            <div class="stat-label">í•¨ê»˜í•œ ë‚ </div>
                        </div>
                        <div class="stat-item" onclick="showExerciseTimeDetail()" style="cursor: pointer;">
                            <div class="stat-value" id="totalExercise">0</div>
                            <div class="stat-label">ìš´ë™ ì‹œê°„ (ë¶„)</div>
                        </div>
                        <div class="stat-item" onclick="showCalorieSavingsDetail()" style="cursor: pointer;">
                            <div class="stat-value" id="totalCalories">0</div>
                            <div class="stat-label">ì ˆì•½ ì¹¼ë¡œë¦¬</div>
                        </div>
                        <div class="stat-item" onclick="showExpectedCompletionDetail()" style="cursor: pointer;">
                            <div class="stat-value" id="predictedDate">-</div>
                            <div class="stat-label">ì˜ˆìƒ ë‹¬ì„±ì¼</div>
                        </div>
                    </div>
                </div>

                <!-- í…Œë§ˆ ì„ íƒ -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title">ğŸ¨ í…Œë§ˆ ì„ íƒ</h3>
                    <div class="theme-selector" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px;">
                        <div class="theme-option" data-theme="light" onclick="setTheme('light')" style="border: 2px solid var(--border); padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <div style="font-size: 2rem;">â˜€ï¸</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">ë¼ì´íŠ¸</div>
                        </div>
                        <div class="theme-option" data-theme="dark" onclick="setTheme('dark')" style="border: 2px solid var(--border); padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <div style="font-size: 2rem;">ğŸŒ™</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">ë‹¤í¬</div>
                        </div>
                        <div class="theme-option" data-theme="pastel" onclick="setTheme('pastel')" style="border: 2px solid var(--border); padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <div style="font-size: 2rem;">ğŸŒ¸</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">íŒŒìŠ¤í…”</div>
                        </div>
                        <div class="theme-option" data-theme="high-contrast" onclick="setTheme('high-contrast')" style="border: 2px solid var(--border); padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <div style="font-size: 2rem;">ğŸ”†</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">ê³ ëŒ€ë¹„</div>
                        </div>
                    </div>
                </div>

                <div class="settings-item" onclick="openProfileOnboarding()">
                    <span>ğŸ‘¤ í”„ë¡œí•„ ì¬ì„¤ì •</span>
                    <span>â†’</span>
                </div>

                <div class="settings-item" onclick="emergencyReset()" style="color: #ff1744; background: #ffebee; font-weight: bold;">
                    <span>ğŸ—‘ï¸ ì´ˆê¸°í™”</span>
                    <div style="font-size: 0.75rem; color: #999; margin-top: 2px;">(ê³„ì •ì€ ìœ ì§€, ëª¨ë“  ê¸°ë¡ ì‚­ì œ)</div>
                </div>

                <div class="settings-item" onclick="exportData()">
                    <span>ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</span>
                    <span>â†’</span>
                </div>

                <div class="settings-item" onclick="importData()">
                    <span>ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</span>
                    <span>â†’</span>
                </div>

                <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ (ì‚¬ì´ë“œë°”ë¡œ ëŒ€ì²´ë¨ - ìˆ¨ê¹€ ì²˜ë¦¬) -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home')">
                <div class="nav-icon">ğŸ </div>
                <div class="nav-label">í™ˆ</div>
            </div>
            <div class="nav-item" onclick="switchTab('plan')">
                <div class="nav-icon">ğŸ“‹</div>
                <div class="nav-label">í”Œëœ</div>
            </div>
            <div class="nav-item" onclick="switchTab('fasting')">
                <div class="nav-icon">â±ï¸</div>
                <div class="nav-label">ë‹¨ì‹</div>
            </div>
            <div class="nav-item" onclick="switchTab('album')">
                <div class="nav-icon">ğŸ“¸</div>
                <div class="nav-label">ì•¨ë²”</div>
            </div>
            <div class="nav-item" onclick="switchTab('calendar')">
                <div class="nav-icon">ğŸ“…</div>
                <div class="nav-label">ìº˜ë¦°ë”</div>
            </div>
            <div class="nav-item" onclick="switchTab('community')">
                <div class="nav-icon">ğŸ’¬</div>
                <div class="nav-label">ì†Œí†µ</div>
            </div>
            <div class="nav-item" onclick="switchTab('notification')">
                <div class="nav-icon">ğŸ””</div>
                <div class="nav-label">ì•Œë¦¼</div>
            </div>
            <div class="nav-item" onclick="switchTab('settings')">
                <div class="nav-icon">âš™ï¸</div>
                <div class="nav-label">ì„¤ì •</div>
            </div>
        </div>

        <!-- ëª¨ë°”ì¼ í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ -->
        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">
            <span style="font-size: 24px;">â˜°</span>
        </button>

        <!-- ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ -->
        <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>
    </div>

    <!-- í”„ë¡œí•„ ì¬ì„¤ì • ëª¨ë‹¬ -->
    <div id="profileSettingsModal" class="category-change-overlay hidden">
        <div class="category-change-modal">
            <div class="category-modal-header">
                <h3>ğŸ‘¤ í”„ë¡œí•„ ì¬ì„¤ì •</h3>
                <button class="modal-close-btn" onclick="closeProfileSettings()">Ã—</button>
            </div>
            <p class="category-modal-description" style="font-size: 0.9rem; color: #666;">
                âš ï¸ í”„ë¡œí•„ ì •ë³´ë§Œ ìˆ˜ì •ë©ë‹ˆë‹¤. ê¸°ì¡´ ê¸°ë¡(ì²´ì¤‘, ë‹¨ì‹, ì‹ì‚¬)ì€ ìœ ì§€ë©ë‹ˆë‹¤.<br>
                ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ë ¤ë©´ <strong style="color: #ff5252;">"ì „ì²´ ì´ˆê¸°í™”"</strong>ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
            </p>
            
            <div class="form-group">
                <label class="form-label">ë‹‰ë„¤ì„</label>
                <input type="text" id="editName" class="form-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label class="form-label">ì‹œì‘ ì²´ì¤‘ (kg)</label>
                <input type="number" id="editStartWeight" class="form-input" placeholder="" step="0.1" min="0">
            </div>
            
            <div class="form-group">
                <label class="form-label">ëª©í‘œ ì²´ì¤‘ (kg)</label>
                <input type="number" id="editGoalWeight" class="form-input" placeholder="" step="0.1" min="0">
            </div>

            <div class="form-group">
                <label class="form-label">ë‚˜ì´</label>
                <input type="number" id="editAge" class="form-input" placeholder="" min="10" max="120">
            </div>

            <div class="form-group">
                <label class="form-label">í‚¤ (cm)</label>
                <input type="number" id="editHeight" class="form-input" placeholder="" step="0.1">
            </div>

            <div class="form-group">
                <label class="form-label">ì„±ë³„</label>
                <select id="editGender" class="form-input">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="male">ë‚¨ì„±</option>
                    <option value="female">ì—¬ì„±</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">ëª©í‘œ ë‚ ì§œ</label>
                <input type="date" id="editTargetDate" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">í™œë™ëŸ‰</label>
                <select id="editActivityLevel" class="form-input">
                    <option value="sedentary">ê±°ì˜ ìš´ë™ ì•ˆ í•¨</option>
                    <option value="light">ê°€ë²¼ìš´ ìš´ë™ (ì£¼ 1-3íšŒ)</option>
                    <option value="moderate">ë³´í†µ ìš´ë™ (ì£¼ 3-5íšŒ)</option>
                    <option value="active">ë§ì€ ìš´ë™ (ì£¼ 6-7íšŒ)</option>
                    <option value="veryActive">ë§¤ìš° ë§ì€ ìš´ë™ (í•˜ë£¨ 2íšŒ)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">ëª©í‘œ</label>
                <select id="editGoal" class="form-input">
                    <option value="lose">ì²´ì¤‘ ê°ëŸ‰</option>
                    <option value="maintain">ì²´ì¤‘ ìœ ì§€</option>
                    <option value="gain">ì²´ì¤‘ ì¦ê°€</option>
                </select>
            </div>
            
            <div class="merge-actions" style="margin-top: 25px;">
                <button class="merge-btn merge-cancel" onclick="closeProfileSettings()">ì·¨ì†Œ</button>
                <button class="merge-btn merge-confirm" onclick="saveProfileSettings()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ğŸ¯ ì „ì²´ í™”ë©´ ì˜¨ë³´ë”© UI (ìƒˆë¡œìš´ ë””ìì¸) -->
    <div id="fullscreenOnboarding" class="fullscreen-onboarding">
        <!-- í—¤ë” -->
        <div class="onboarding-header">
            <button class="onboarding-back-btn" onclick="prevOnboardingStep()">â†</button>
            <div class="onboarding-progress">
                <div class="onboarding-progress-bar" id="onboardingProgressBar" style="width: 11.1%;"></div>
            </div>
        </div>
        
        <!-- Step 1: ì´ë¦„ ì…ë ¥ -->
        <div id="obStep1" class="onboarding-body" style="display: flex;">
            <h2 class="onboarding-title">ì´ë¦„ì„<br>ì…ë ¥í•´ ì£¼ì„¸ìš”</h2>
            <div class="onboarding-content">
                <input type="text" id="obName" class="onboarding-text-input" placeholder="" maxlength="20">
            </div>
        </div>
        
        <!-- Step 2: ë‚˜ì´ ì„ íƒ (ê·¸ë¦¬ë“œ + ì§ì ‘ì…ë ¥) -->
        <div id="obStep2" class="onboarding-body" style="display: none;">
            <h2 class="onboarding-title">ë‚˜ì´ë¥¼<br>ì„ íƒí•´ ì£¼ì„¸ìš”</h2>
            <div class="onboarding-content">
                <div class="dm-value-display">
                    <span class="dm-value-main" id="ageDisplay" onclick="toggleAgeInput()">26</span>
                    <span class="dm-value-unit">ì„¸</span>
                </div>
                <div class="dm-age-grid" id="ageGrid"></div>
                <div class="dm-quick-select">
                    <button class="dm-quick-btn" onclick="selectAge(20)">20ëŒ€</button>
                    <button class="dm-quick-btn" onclick="selectAge(30)">30ëŒ€</button>
                    <button class="dm-quick-btn" onclick="selectAge(40)">40ëŒ€</button>
                    <button class="dm-quick-btn" onclick="selectAge(50)">50ëŒ€</button>
                </div>
            </div>
        </div>
        
        <!-- Step 3: ì„±ë³„ ì„ íƒ -->
        <div id="obStep3" class="onboarding-body" style="display: none;">
            <h2 class="onboarding-title">ì„±ë³„ì„<br>ì„ íƒí•´ ì£¼ì„¸ìš”</h2>
            <div class="onboarding-content">
                <div class="gender-list">
                    <button class="gender-item" data-value="male" onclick="selectObGender('male')">ë‚¨ì„±</button>
                    <button class="gender-item" data-value="female" onclick="selectObGender('female')">ì—¬ì„±</button>
                </div>
            </div>
        </div>
        
        <!-- Step 4: í‚¤ ì„ íƒ (í„°ì¹˜ ìŠ¬ë¼ì´ë”) -->
        <div id="obStep4" class="onboarding-body" style="display: none;">
            <h2 class="onboarding-title">í‚¤ë¥¼<br>ì•Œë ¤ì£¼ì„¸ìš”</h2>
            <div class="onboarding-content">
                <div class="dm-unit-toggle">
                    <button class="dm-unit-btn" id="heightFtBtn" onclick="toggleHeightUnit('ft')">ft</button>
                    <button class="dm-unit-btn active" id="heightCmBtn" onclick="toggleHeightUnit('cm')">cm</button>
                </div>
                <div class="dm-value-display">
                    <span class="dm-value-main" id="heightDisplay" onclick="toggleHeightInput()">170.0</span>
                    <span class="dm-value-unit" id="heightUnitLabel">cm</span>
                </div>
                <div class="dm-slider-container">
                    <div class="dm-slider-indicator"></div>
                    <div class="dm-slider-track" id="heightTrack"></div>
                </div>
            </div>
        </div>
        
        <!-- Step 5: í˜„ì¬ ì²´ì¤‘ (í„°ì¹˜ ìŠ¬ë¼ì´ë”) -->
        <div id="obStep5" class="onboarding-body" style="display: none;">
            <h2 class="onboarding-title">í˜„ì¬ ì²´ì¤‘ì„<br>ì•Œë ¤ì£¼ì„¸ìš”</h2>
            <div class="onboarding-content">
                <div class="dm-unit-toggle">
                    <button class="dm-unit-btn" id="weightLbBtn" onclick="toggleWeightUnit('lb')">lb</button>
                    <button class="dm-unit-btn active" id="weightKgBtn" onclick="toggleWeightUnit('kg')">kg</button>
                </div>
                <div class="dm-value-display">
                    <span class="dm-value-main" id="obCurrentWeightDisplay" onclick="toggleWeightInput('current')">70.0</span>
                    <span class="dm-value-unit" id="obCurrentWeightUnitLabel">kg</span>
                </div>
                <div class="dm-slider-container">
                    <div class="dm-slider-indicator"></div>
                    <div class="dm-slider-track" id="currentWeightTrack"></div>
                </div>
            </div>
        </div>
        
        <!-- Step 6: ëª©í‘œ ì²´ì¤‘ (í„°ì¹˜ ìŠ¬ë¼ì´ë”) -->
        <div id="obStep6" class="onboarding-body" style="display: none;">
            <h2 class="onboarding-title">ëª©í‘œ ì²´ì¤‘ì„<br>ì•Œë ¤ì£¼ì„¸ìš”</h2>
            <div class="onboarding-content">
                <div class="dm-value-display">
                    <span class="dm-value-main" id="obGoalWeightDisplay" onclick="toggleWeightInput('goal')">65.0</span>
                    <span class="dm-value-unit" id="obGoalWeightUnitLabel">kg</span>
                </div>
                <div class="dm-slider-container">
                    <div class="dm-slider-indicator"></div>
                    <div class="dm-slider-track" id="goalWeightTrack"></div>
                </div>
            </div>
        </div>
        
        <!-- Step 7: ëª©í‘œ ë‚ ì§œ ì„ íƒ -->
        <div id="obStep7" class="onboarding-body" style="display: none;">
            <h2 class="onboarding-title">ì–¸ì œê¹Œì§€<br>ëª©í‘œë¥¼ ì´ë£¨ê³  ì‹¶ìœ¼ì„¸ìš”?</h2>
            <div class="onboarding-content">
                <div class="dm-calendar-picker">
                    <input type="date" id="targetDateInput" class="dm-date-input" onchange="updateTargetDate(this.value)">
                </div>
                <div class="dm-dday-display">
                    <span class="dday-label">ëª©í‘œê¹Œì§€</span>
                    <span class="dday-number" id="targetDdayNumber">D-56</span>
                </div>
            </div>
        </div>
        
        <!-- Step 8: í™œë™ëŸ‰ ì„ íƒ (ì¹´ë“œ ë°©ì‹) -->
        <div id="obStep8" class="onboarding-body" style="display: none;">
            <h2 class="onboarding-title">í‰ì†Œ í™œë™ëŸ‰ì´<br>ì–´ëŠ ì •ë„ì¸ê°€ìš”?</h2>
            <div class="onboarding-content" style="overflow-y: auto;">
                <div class="dm-activity-cards">
                    <div class="dm-activity-card" data-level="sedentary" onclick="selectActivity('sedentary')">
                        <div class="activity-card-icon">ğŸ›‹ï¸</div>
                        <div class="activity-card-info">
                            <div class="activity-card-title">ê±°ì˜ ì›€ì§ì´ì§€ ì•Šì•„ìš”</div>
                            <div class="activity-card-desc">í•˜ë£¨ ëŒ€ë¶€ë¶„ ì•‰ì•„ì„œ ìƒí™œ</div>
                        </div>
                    </div>
                    <div class="dm-activity-card" data-level="light" onclick="selectActivity('light')">
                        <div class="activity-card-icon">ğŸš¶</div>
                        <div class="activity-card-info">
                            <div class="activity-card-title">ê°€ë³ê²Œ ì›€ì§ì—¬ìš”</div>
                            <div class="activity-card-desc">ì£¼ 1-2íšŒ ê°€ë²¼ìš´ ìš´ë™</div>
                        </div>
                    </div>
                    <div class="dm-activity-card selected" data-level="moderate" onclick="selectActivity('moderate')">
                        <div class="activity-card-icon">ğŸƒ</div>
                        <div class="activity-card-info">
                            <div class="activity-card-title">ì ë‹¹íˆ í™œë™ì ì´ì—ìš”</div>
                            <div class="activity-card-desc">ì£¼ 3-5íšŒ ìš´ë™</div>
                        </div>
                    </div>
                    <div class="dm-activity-card" data-level="active" onclick="selectActivity('active')">
                        <div class="activity-card-icon">ğŸ’ª</div>
                        <div class="activity-card-info">
                            <div class="activity-card-title">ë§ì´ ì›€ì§ì—¬ìš”</div>
                            <div class="activity-card-desc">ë§¤ì¼ ìš´ë™ ë˜ëŠ” ìœ¡ì²´ ë…¸ë™</div>
                        </div>
                    </div>
                    <div class="dm-activity-card" data-level="veryActive" onclick="selectActivity('veryActive')">
                        <div class="activity-card-icon">ğŸ†</div>
                        <div class="activity-card-info">
                            <div class="activity-card-title">ë§¤ìš° í™œë™ì ì´ì—ìš”</div>
                            <div class="activity-card-desc">ì„ ìˆ˜ê¸‰ ê°•ë„ ë†’ì€ ìš´ë™</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 9: ë™ê¸°ë¶€ì—¬ í™”ë©´ -->
        <div id="obStep9" class="onboarding-body" style="display: none;">
            <div class="onboarding-content">
                <div class="motivation-screen">
                    <div class="motivation-emoji">ğŸ“Š</div>
                    <h2 class="motivation-title">ê³¼í•™ì´ ì¦ëª…í•œ ì‚¬ì‹¤</h2>
                    <div class="motivation-message">
                        <p class="motivation-main">ì‹ë‹¨ì„ ê¸°ë¡í•˜ëŠ” ì‚¬ëŒì€</p>
                        <div class="motivation-highlight-box">
                            <span class="motivation-key">2ë°° ë” ì²´ì¤‘ ê°ëŸ‰</span>
                        </div>
                        <p class="motivation-desc">
                            Kaiser Permanente ì—°êµ¬(2008)<br>
                            <strong>1,685ëª… ëŒ€ìƒ 6ê°œì›” ì¶”ì  ê²°ê³¼</strong>
                        </p>
                    </div>
                    <div class="motivation-facts">
                        <div class="fact-item">
                            <span class="fact-number">64%</span>
                            <span class="fact-text">ë§¤ì¼ ê¸°ë¡í•œ ì‚¬ëŒë“¤ì˜<br>ëª©í‘œ ì²´ì¤‘ ë‹¬ì„±ë¥ </span>
                            <span class="fact-source">Journal of Medical Internet Research, 2019</span>
                        </div>
                        <div class="fact-item">
                            <span class="fact-number">3ë¶„</span>
                            <span class="fact-text">í•˜ë£¨ í‰ê·  ê¸°ë¡ ì‹œê°„<br>ì´ê²ƒë§Œìœ¼ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤</span>
                            <span class="fact-source">Obesity Research, 2005</span>
                        </div>
                    </div>
                    <div class="motivation-facts" style="margin-top: 15px;">
                        <div class="fact-item">
                            <span class="fact-number">25%</span>
                            <span class="fact-text">ê°„í—ì  ë‹¨ì‹ ë³‘í–‰ ì‹œ<br>ì¶”ê°€ ì²´ì§€ë°© ê°ì†Œ</span>
                            <span class="fact-source">New England Journal of Medicine, 2019</span>
                        </div>
                        <div class="fact-item">
                            <span class="fact-number">+40%</span>
                            <span class="fact-text">ìš´ë™ ê¸°ë¡ ë³‘í–‰ ì‹œ<br>ê°ëŸ‰ íš¨ê³¼ ì¦ê°€</span>
                            <span class="fact-source">Obesity Reviews, 2014</span>
                        </div>
                    </div>
                    <div class="motivation-tips compact">
                        <div class="tip-item">
                            <span class="tip-icon">âœ“</span>
                            <span class="tip-text">ì‚¬ì§„ë§Œ ì°ìœ¼ë©´ AIê°€ ìë™ ë¶„ì„</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">âœ“</span>
                            <span class="tip-text">ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ì•„ìš”</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">âœ“</span>
                            <span class="tip-text">ê¾¸ì¤€í•¨ì´ ì™„ë²½í•¨ë³´ë‹¤ ì¤‘ìš”í•´ìš”</span>
                        </div>
                        <div class="tip-item">
                            <span class="tip-icon">âœ“</span>
                            <span class="tip-text">ì‘ì€ ë³€í™”ê°€ í° ê²°ê³¼ë¥¼ ë§Œë“­ë‹ˆë‹¤</span>
                        </div>
                    </div>
                    <p class="motivation-footer">ë‹¹ì‹ ë„ í•  ìˆ˜ ìˆì–´ìš”! ğŸ’ª</p>
                </div>
            </div>
        </div>
        
        <!-- Step 10: ë¶„ì„ ì™„ë£Œ í™”ë©´ -->
        <div id="obStep10" class="onboarding-body" style="display: none;">
            <div class="onboarding-content" style="overflow-y: auto; padding-bottom: 20px;">
                <div class="result-screen">
                    <h2 class="result-title">ë¶„ì„ ì™„ë£Œ!</h2>
                    <p class="result-subtitle">ì‹ë‹¨ í”Œëœì´ ì¤€ë¹„ë˜ì—ˆì–´ìš”</p>
                    
                    <!-- ì¹¼ë¡œë¦¬ í‘œì‹œ -->
                    <div class="calorie-display">
                        <div class="calorie-label">ì¹¼ë¡œë¦¬</div>
                        <div>
                            <span class="calorie-value" id="obResultCalories">-</span>
                            <span class="calorie-unit">kcal / day</span>
                        </div>
                    </div>
                    
                    <!-- ë„ë„› ì°¨íŠ¸ -->
                    <div style="font-size: 1rem; color: #666; margin-bottom: 20px;">ì˜ì–‘ì„±ë¶„</div>
                    <div class="donut-chart-container">
                        <div class="donut-chart">
                            <div class="donut-hole"></div>
                        </div>
                        <div class="donut-labels">
                            <div class="donut-label carbs">íƒ„ìˆ˜í™”ë¬¼<br><strong>50%</strong></div>
                            <div class="donut-label protein">ë‹¨ë°±ì§ˆ<br><strong>30%</strong></div>
                            <div class="donut-label fat">ì§€ë°©<br><strong>20%</strong></div>
                        </div>
                    </div>
                    
                    <!-- ë§¤í¬ë¡œ ìƒì„¸ -->
                    <div class="macro-details">
                        <div class="macro-item">
                            <div class="macro-dot carbs"></div>
                            <div class="macro-name">íƒ„ìˆ˜í™”ë¬¼</div>
                            <span class="macro-value" id="obResultCarbs">-</span>
                            <span class="macro-unit">g</span>
                        </div>
                        <div class="macro-item">
                            <div class="macro-dot protein"></div>
                            <div class="macro-name">ë‹¨ë°±ì§ˆ</div>
                            <span class="macro-value" id="obResultProtein">-</span>
                            <span class="macro-unit">g</span>
                        </div>
                        <div class="macro-item">
                            <div class="macro-dot fat"></div>
                            <div class="macro-name">ì§€ë°©</div>
                            <span class="macro-value" id="obResultFat">-</span>
                            <span class="macro-unit">g</span>
                        </div>
                    </div>
                    
                    <!-- ê³„ì‚° ë°©ë²• ì„¤ëª… -->
                    <div class="calculation-explain">
                        <div class="explain-title">ğŸ“Š ì–´ë–»ê²Œ ê³„ì‚°í–ˆë‚˜ìš”?</div>
                        <div class="explain-item">
                            <span class="explain-label">ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ (BMR)</span>
                            <span class="explain-value" id="resultBmr">0</span>
                            <span class="explain-unit">kcal</span>
                        </div>
                        <div class="explain-desc">ì•„ë¬´ê²ƒë„ ì•ˆ í•´ë„ ëª¸ì´ ì“°ëŠ” ì—ë„ˆì§€</div>
                        <div class="explain-item" style="margin-top: 12px;">
                            <span class="explain-label">ì¼ì¼ ì†Œë¹„ëŸ‰ (TDEE)</span>
                            <span class="explain-value" id="resultTdee">0</span>
                            <span class="explain-unit">kcal</span>
                        </div>
                        <div class="explain-desc">í™œë™ëŸ‰ì„ í¬í•¨í•œ í•˜ë£¨ ì´ ì†Œë¹„ëŸ‰</div>
                        <div class="explain-item" style="margin-top: 12px;">
                            <span class="explain-label">ì¼ì¼ ì ì</span>
                            <span class="explain-value" id="resultDeficit">0</span>
                            <span class="explain-unit">kcal</span>
                        </div>
                        <div class="explain-desc">ì£¼ë‹¹ <span id="resultWeeklyLoss">0.5</span>kg ê°ëŸ‰ ëª©í‘œ</div>
                        <div class="explain-formula-box">
                            <div class="formula-row">
                                <span id="resultTdee2">0</span> - <span id="resultDeficit2">0</span> = <strong id="resultTarget">0</strong> kcal
                            </div>
                            <div class="formula-label">TDEE - ì ì = ëª©í‘œ ì¹¼ë¡œë¦¬</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- í‘¸í„° (ë‹¤ìŒ ë²„íŠ¼) -->
        <div class="onboarding-footer">
            <button class="onboarding-next-btn" id="obNextBtn" onclick="nextObStep()">ë‹¤ìŒ</button>
        </div>
    </div>
    
    <!-- ê¸°ì¡´ ì˜¨ë³´ë”© ëª¨ë‹¬ (ìˆ¨ê¹€ ì²˜ë¦¬, í˜¸í™˜ì„± ìœ ì§€) -->
    <div id="initialProfileSetupModal" class="modal-overlay" style="display: none !important;">

            <!-- Step 1: ë‹‰ë„¤ì„ -->
            <div id="onboardingStep1" class="onboarding-step">
                <h3 style="font-size: 1.8rem; margin-bottom: 10px;">ğŸ‘‹ ë°˜ê°€ì›Œìš”!</h3>
                <p style="color: #666; margin-bottom: 30px;">ì–´ë–»ê²Œ ë¶ˆëŸ¬ë“œë¦´ê¹Œìš”?</p>
                <input type="text" id="initialSetupName" class="form-input" 
                       placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" 
                       style="font-size: 1.1rem; padding: 15px;"
                       onkeypress="if(event.key === 'Enter') nextOnboardingStep()">
            </div>

            <!-- Step 2: ì„±ë³„ -->
            <div id="onboardingStep2" class="onboarding-step" style="display: none;">
                <h3 style="font-size: 1.8rem; margin-bottom: 10px;">ğŸš» ì„±ë³„ì„ ì•Œë ¤ì£¼ì„¸ìš”</h3>
                <p style="color: #666; margin-bottom: 30px;">ì •í™•í•œ ì¹¼ë¡œë¦¬ ê³„ì‚°ì„ ìœ„í•´ í•„ìš”í•´ìš”</p>
                <div style="display: flex; gap: 15px;">
                    <button class="onboarding-option-btn" data-value="male" 
                            style="flex: 1; padding: 40px 20px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; transition: all 0.3s;"
                            onclick="selectGender('male')">
                        <div style="font-size: 3rem; margin-bottom: 10px;">â™‚ï¸</div>
                        <div style="font-size: 1.1rem; font-weight: 600;">ë‚¨ì„±</div>
                    </button>
                    <button class="onboarding-option-btn" data-value="female"
                            style="flex: 1; padding: 40px 20px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; transition: all 0.3s;"
                            onclick="selectGender('female')">
                        <div style="font-size: 3rem; margin-bottom: 10px;">â™€ï¸</div>
                        <div style="font-size: 1.1rem; font-weight: 600;">ì—¬ì„±</div>
                    </button>
                </div>
                <input type="hidden" id="initialSetupGender" value="">
            </div>

            <!-- Step 3: ë‚˜ì´ -->
            <div id="onboardingStep3" class="onboarding-step" style="display: none;">
                <h3 style="font-size: 1.8rem; margin-bottom: 10px;">ğŸ‚ ë‚˜ì´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”</h3>
                <p style="color: #666; margin-bottom: 30px;">ê¸°ì´ˆëŒ€ì‚¬ëŸ‰ ê³„ì‚°ì— í•„ìš”í•´ìš”</p>
                <input type="number" id="initialSetupAge" class="form-input" 
                       placeholder="" min="10" max="120"
                       style="font-size: 1.1rem; padding: 15px;"
                       onkeypress="if(event.key === 'Enter') nextOnboardingStep()">
                <p style="font-size: 0.85rem; color: #9ca3af; margin-top: 10px;">ë§Œ ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            </div>

            <!-- Step 4: í‚¤ -->
            <div id="onboardingStep4" class="onboarding-step" style="display: none;">
                <h3 style="font-size: 1.8rem; margin-bottom: 10px;">ğŸ“ í‚¤ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”</h3>
                <p style="color: #666; margin-bottom: 30px;">í‘œì¤€ ì²´ì¤‘ ê³„ì‚°ì— í•„ìš”í•´ìš”</p>
                <input type="number" id="initialSetupHeight" class="form-input" 
                       placeholder="" step="0.1"
                       style="font-size: 1.1rem; padding: 15px;"
                       onkeypress="if(event.key === 'Enter') nextOnboardingStep()">
                <p style="font-size: 0.85rem; color: #9ca3af; margin-top: 10px;">ë‹¨ìœ„: cm</p>
            </div>

            <!-- Step 5: í˜„ì¬ ì²´ì¤‘ & ëª©í‘œ ì²´ì¤‘ -->
            <div id="onboardingStep5" class="onboarding-step" style="display: none;">
                <h3 style="font-size: 1.8rem; margin-bottom: 10px;">âš–ï¸ ì²´ì¤‘ ì •ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”</h3>
                <p style="color: #666; margin-bottom: 30px;">ëª©í‘œ ì„¤ì •ì„ ìœ„í•´ í•„ìš”í•´ìš”</p>
                <div style="margin-bottom: 20px;">
                    <label class="form-label" style="font-weight: 600;">í˜„ì¬ ì²´ì¤‘</label>
                    <input type="number" id="initialSetupStartWeight" class="form-input" 
                           placeholder="" step="0.1"
                           style="font-size: 1.1rem; padding: 15px;">
                </div>
                <div>
                    <label class="form-label" style="font-weight: 600;">ëª©í‘œ ì²´ì¤‘</label>
                    <input type="number" id="initialSetupGoalWeight" class="form-input" 
                           placeholder="" step="0.1"
                           style="font-size: 1.1rem; padding: 15px;"
                           onkeypress="if(event.key === 'Enter') nextOnboardingStep()">
                </div>
                <p style="font-size: 0.85rem; color: #9ca3af; margin-top: 10px;">ë‹¨ìœ„: kg</p>
            </div>

            <!-- Step 6: ëª©í‘œ -->
            <div id="onboardingStep6" class="onboarding-step" style="display: none;">
                <h3 style="font-size: 1.8rem; margin-bottom: 10px;">ğŸ¯ ëª©í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
                <p style="color: #666; margin-bottom: 30px;">ì–´ë–¤ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê³  ì‹¶ìœ¼ì„¸ìš”?</p>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="onboarding-option-btn" data-value="lose"
                            style="padding: 20px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; text-align: left; transition: all 0.3s;"
                            onclick="selectGoal('lose')">
                        <div style="font-size: 1.5rem; margin-bottom: 5px;">ğŸ”¥ ì²´ì¤‘ ê°ëŸ‰</div>
                        <div style="font-size: 0.9rem; color: #666;">ê±´ê°•í•˜ê²Œ ì²´ì¤‘ì„ ì¤„ì´ê³  ì‹¶ì–´ìš”</div>
                    </button>
                    <button class="onboarding-option-btn" data-value="maintain"
                            style="padding: 20px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; text-align: left; transition: all 0.3s;"
                            onclick="selectGoal('maintain')">
                        <div style="font-size: 1.5rem; margin-bottom: 5px;">âš–ï¸ ì²´ì¤‘ ìœ ì§€</div>
                        <div style="font-size: 0.9rem; color: #666;">í˜„ì¬ ì²´ì¤‘ì„ ìœ ì§€í•˜ê³  ì‹¶ì–´ìš”</div>
                    </button>
                    <button class="onboarding-option-btn" data-value="gain"
                            style="padding: 20px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; text-align: left; transition: all 0.3s;"
                            onclick="selectGoal('gain')">
                        <div style="font-size: 1.5rem; margin-bottom: 5px;">ğŸ’ª ì²´ì¤‘ ì¦ê°€</div>
                        <div style="font-size: 0.9rem; color: #666;">ê·¼ìœ¡ì„ í‚¤ìš°ê³  ì‹¶ì–´ìš”</div>
                    </button>
                </div>
                <input type="hidden" id="initialSetupGoal" value="lose">
            </div>

            <!-- Step 7: í™œë™ëŸ‰ -->
            <div id="onboardingStep7" class="onboarding-step" style="display: none;">
                <h3 style="font-size: 1.8rem; margin-bottom: 10px;">ğŸƒ í™œë™ëŸ‰ì„ ì„ íƒí•˜ì„¸ìš”</h3>
                <p style="color: #666; margin-bottom: 30px;">ì¼ìƒì ì¸ í™œë™ëŸ‰ì„ ì•Œë ¤ì£¼ì„¸ìš”</p>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="onboarding-option-btn" data-value="sedentary"
                            style="padding: 15px 20px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; text-align: left; transition: all 0.3s;"
                            onclick="selectActivity('sedentary')">
                        <div style="font-weight: 600;">ê±°ì˜ ìš´ë™ ì•ˆ í•¨</div>
                        <div style="font-size: 0.85rem; color: #666;">ì£¼ë¡œ ì•‰ì•„ì„œ ìƒí™œ</div>
                    </button>
                    <button class="onboarding-option-btn" data-value="light"
                            style="padding: 15px 20px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; text-align: left; transition: all 0.3s;"
                            onclick="selectActivity('light')">
                        <div style="font-weight: 600;">ê°€ë²¼ìš´ ìš´ë™ (ì£¼ 1-3íšŒ)</div>
                        <div style="font-size: 0.85rem; color: #666;">ê°€ë” ê±·ê¸°ë‚˜ ê°€ë²¼ìš´ ìš´ë™</div>
                    </button>
                    <button class="onboarding-option-btn" data-value="moderate"
                            style="padding: 15px 20px; border: 2px solid #4f46e5; border-radius: 12px; background: #eef2ff; cursor: pointer; text-align: left; transition: all 0.3s;"
                            onclick="selectActivity('moderate')">
                        <div style="font-weight: 600; color: #4f46e5;">ë³´í†µ ìš´ë™ (ì£¼ 3-5íšŒ)</div>
                        <div style="font-size: 0.85rem; color: #666;">ê·œì¹™ì ì¸ ìš´ë™</div>
                    </button>
                    <button class="onboarding-option-btn" data-value="active"
                            style="padding: 15px 20px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; text-align: left; transition: all 0.3s;"
                            onclick="selectActivity('active')">
                        <div style="font-weight: 600;">ë§ì€ ìš´ë™ (ì£¼ 6-7íšŒ)</div>
                        <div style="font-size: 0.85rem; color: #666;">ë§¤ì¼ ìš´ë™í•˜ëŠ” í¸</div>
                    </button>
                    <button class="onboarding-option-btn" data-value="veryActive"
                            style="padding: 15px 20px; border: 2px solid #e5e7eb; border-radius: 12px; background: white; cursor: pointer; text-align: left; transition: all 0.3s;"
                            onclick="selectActivity('veryActive')">
                        <div style="font-weight: 600;">ë§¤ìš° ë§ì€ ìš´ë™ (í•˜ë£¨ 2íšŒ)</div>
                        <div style="font-size: 0.85rem; color: #666;">ê²©ë ¬í•œ ìš´ë™ ë˜ëŠ” ìœ¡ì²´ ë…¸ë™</div>
                    </button>
                </div>
                <input type="hidden" id="initialSetupActivityLevel" value="moderate">
            </div>

            <!-- Step 8: ëª©í‘œ ë‚ ì§œ -->
            <div id="onboardingStep8" class="onboarding-step" style="display: none;">
                <h3 style="font-size: 1.8rem; margin-bottom: 10px;">ğŸ“… ëª©í‘œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
                <p style="color: #666; margin-bottom: 30px;">ì–¸ì œê¹Œì§€ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê³  ì‹¶ìœ¼ì„¸ìš”?</p>
                <input type="date" id="initialSetupTargetDate" class="form-input" 
                       style="font-size: 1.1rem; padding: 15px;">
                <p style="font-size: 0.85rem; color: #9ca3af; margin-top: 10px;">ì„ íƒ ì‚¬í•­ì´ì—ìš”. ë¹„ì›Œë‘˜ ìˆ˜ë„ ìˆì–´ìš”.</p>
            </div>

            <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button id="onboardingPrevBtn" class="btn btn-secondary" 
                        style="flex: 1; display: none;"
                        onclick="prevOnboardingStep()">
                    ì´ì „
                </button>
                <button id="onboardingNextBtn" class="btn btn-primary" 
                        style="flex: 1;"
                        onclick="nextOnboardingStep()">
                    <span id="onboardingNextBtnText">ë‹¤ìŒ</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ğŸ¯ Mealo ìŠ¤íƒ€ì¼ ìŒì‹ ë¶„ì„ ê²°ê³¼ ì¹´ë“œ -->
    <div id="foodAnalysisResultModal" class="modal-overlay" style="display: none; z-index: 10000;">
        <div class="modal-content" style="max-width: 500px; padding: 0; overflow: hidden;">
            <!-- ìŒì‹ ì‚¬ì§„ -->
            <div id="foodImageContainer" style="width: 100%; height: 250px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <img id="foodAnalysisImage" src="" alt="ìŒì‹ ì‚¬ì§„" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                <div id="foodImagePlaceholder" style="font-size: 5rem;">ğŸ½ï¸</div>
            </div>

            <!-- ë¶„ì„ ê²°ê³¼ ì¹´ë“œ -->
            <div style="padding: 25px;">
                <!-- ìŒì‹ëª… & AI ì¡°ì–¸ -->
                <div style="margin-bottom: 20px;">
                    <h3 id="analyzedFoodName" style="font-size: 1.5rem; margin-bottom: 10px; color: #1f2937;">ë¶„ì„ ì¤‘...</h3>
                    <div id="aiAdviceText" style="background: #f0fdf4; border-left: 3px solid #22c55e; padding: 12px 15px; border-radius: 8px; color: #166534; font-size: 0.9rem; line-height: 1.5;">
                        AIê°€ ìŒì‹ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...
                    </div>
                </div>

                <!-- ì˜ì–‘ ì •ë³´ ê·¸ë¦¬ë“œ -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                    <!-- ì¹¼ë¡œë¦¬ -->
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #78350f; margin-bottom: 5px; font-weight: 600;">ì¹¼ë¡œë¦¬</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #92400e;">
                            <span id="analyzedCalories">0</span>
                            <span style="font-size: 0.9rem;">kcal</span>
                        </div>
                    </div>

                    <!-- íƒ„ìˆ˜í™”ë¬¼ -->
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #1e40af; margin-bottom: 5px; font-weight: 600;">íƒ„ìˆ˜í™”ë¬¼</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #1e3a8a;">
                            <span id="analyzedCarbs">0</span>
                            <span style="font-size: 0.9rem;">g</span>
                        </div>
                    </div>

                    <!-- ë‹¨ë°±ì§ˆ -->
                    <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #9f1239; margin-bottom: 5px; font-weight: 600;">ë‹¨ë°±ì§ˆ</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #881337;">
                            <span id="analyzedProtein">0</span>
                            <span style="font-size: 0.9rem;">g</span>
                        </div>
                    </div>

                    <!-- ì§€ë°© -->
                    <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 15px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 0.75rem; color: #3730a3; margin-bottom: 5px; font-weight: 600;">ì§€ë°©</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: #312e81;">
                            <span id="analyzedFat">0</span>
                            <span style="font-size: 0.9rem;">g</span>
                        </div>
                    </div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeFoodAnalysisResult()">
                        ë‹«ê¸°
                    </button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="confirmFoodAnalysisResult()">
                        í™•ì¸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‹ì‚¬ ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editMealModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 450px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">ğŸ½ï¸ ì‹ì‚¬ ìˆ˜ì •</h3>
                <button class="modal-close-btn" onclick="closeEditMealModal()">Ã—</button>
            </div>
            
            <!-- ì‹ì‚¬ íƒ€ì… ì„ íƒ -->
            <div style="margin-bottom: 20px;">
                <label class="form-label">ì‹ì‚¬ ì‹œê°„</label>
                <div class="meal-input-buttons">
                    <button class="meal-btn meal-btn-breakfast" id="editMealType-ì•„ì¹¨" onclick="selectEditMealType('ì•„ì¹¨')">
                        <span class="meal-emoji">ğŸŒ…</span>
                        <span class="meal-label">ì•„ì¹¨</span>
                    </button>
                    <button class="meal-btn meal-btn-lunch" id="editMealType-ì ì‹¬" onclick="selectEditMealType('ì ì‹¬')">
                        <span class="meal-emoji">â˜€ï¸</span>
                        <span class="meal-label">ì ì‹¬</span>
                    </button>
                    <button class="meal-btn meal-btn-dinner" id="editMealType-ì €ë…" onclick="selectEditMealType('ì €ë…')">
                        <span class="meal-emoji">ğŸŒ™</span>
                        <span class="meal-label">ì €ë…</span>
                    </button>
                    <button class="meal-btn meal-btn-snack" id="editMealType-ê°„ì‹" onclick="selectEditMealType('ê°„ì‹')">
                        <span class="meal-emoji">ğŸª</span>
                        <span class="meal-label">ê°„ì‹</span>
                    </button>
                </div>
            </div>
            
            <!-- ì…ë ¥ ë°©ë²• ì„ íƒ -->
            <div style="margin-bottom: 20px;">
                <label class="form-label">ìˆ˜ì • ë°©ë²•</label>
                <div style="display: flex; gap: 10px;">
                    <button class="input-method-btn" onclick="selectEditMethod('ai')" style="flex: 1;">
                        ğŸ¤– AI ì¬ë¶„ì„
                    </button>
                    <button class="input-method-btn" onclick="selectEditMethod('manual')" style="flex: 1;">
                        âœï¸ ì§ì ‘ ì…ë ¥
                    </button>
                </div>
            </div>
            
            <!-- ì§ì ‘ ì…ë ¥ í•„ë“œ -->
            <div id="manualEditFields" style="display: none;">
                <div class="form-group">
                    <label class="form-label">ìŒì‹ ì´ë¦„</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="editFoodName" class="form-input" placeholder="ì˜ˆ: ì§¬ë½•, ê¿”ë°”ë¡œìš°" 
                               style="flex: 1;" onkeypress="if(event.key==='Enter') searchFoodForEdit();">
                        <button class="search-food-btn-edit" onclick="searchFoodForEdit()" style="padding: 10px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap;">
                            ğŸ” ê²€ìƒ‰
                        </button>
                    </div>
                </div>
                
                <!-- ìŒì‹ ê²€ìƒ‰ ê²°ê³¼ -->
                <div id="editFoodSearchResults" style="display: none; margin-bottom: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 250px; overflow-y: auto;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #333; font-size: 0.95rem;">
                            ğŸ“‹ ê²€ìƒ‰ ê²°ê³¼ (í´ë¦­í•˜ì—¬ ì„ íƒ)
                        </div>
                        <div id="editFoodOptionsContainer"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ì¹¼ë¡œë¦¬ (kcal)</label>
                    <input type="number" id="editCalories" class="form-input" placeholder="0" step="1">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 0.85rem;">íƒ„ìˆ˜í™”ë¬¼ (g)</label>
                        <input type="number" id="editCarbs" class="form-input" placeholder="0" step="0.1">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 0.85rem;">ë‹¨ë°±ì§ˆ (g)</label>
                        <input type="number" id="editProtein" class="form-input" placeholder="0" step="0.1">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 0.85rem;">ì§€ë°© (g)</label>
                        <input type="number" id="editFat" class="form-input" placeholder="0" step="0.1">
                    </div>
                </div>
                
                <div class="merge-actions">
                    <button class="merge-btn merge-cancel" onclick="closeEditMealModal()">ì·¨ì†Œ</button>
                    <button class="merge-btn merge-confirm" onclick="saveEditedMeal()">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Firebase ì´ˆê¸°í™” ====================
        // showAuth í•¨ìˆ˜ëŠ” ì´ë¯¸ head ë¶€ë¶„ì—ì„œ ì •ì˜ë¨
        const firebaseConfig = {
            apiKey: "AIzaSyDrw00jym_dKATz26qUzsALSqfYeAAkM-I",
            authDomain: "mate-9f45e.firebaseapp.com",
            projectId: "mate-9f45e",
            storageBucket: "mate-9f45e.firebasestorage.app",
            messagingSenderId: "1077932492908",
            appId: "1:1077932492908:web:722c068177e2e715183049"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ==================== Service Worker ë“±ë¡ (í‘¸ì‹œ ì•Œë¦¼ìš©) ====================
        let swRegistration = null;
        
        async function registerServiceWorker() {
            // file:// í”„ë¡œí† ì½œì—ì„œëŠ” Service Workerê°€ ì‘ë™í•˜ì§€ ì•ŠìŒ
            if (window.location.protocol === 'file:') {
                console.log('â„¹ï¸ file:// í”„ë¡œí† ì½œì—ì„œëŠ” Service Workerë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return null;
            }

            if ('serviceWorker' in navigator) {
                try {
                    swRegistration = await navigator.serviceWorker.register('./sw.js');
                    console.log('âœ… Service Worker ë“±ë¡ ì„±ê³µ:', swRegistration);

                    // Service Worker ë©”ì‹œì§€ ìˆ˜ì‹ 
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        if (event.data.type === 'CHECK_FASTING') {
                            // ë‹¨ì‹ ìƒíƒœ ì²´í¬ í›„ ì•Œë¦¼
                            checkAndNotifyFasting();
                        }
                    });

                    return swRegistration;
                } catch (error) {
                    console.error('Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
                }
            }
            return null;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Service Worker ë“±ë¡
        registerServiceWorker();

        // ==================== ì „ì—­ ë³€ìˆ˜ ====================
        let currentUser = null;
        let currentProfile = null;
        let currentTab = 'home';
        let currentAlbumTab = 'all';
        let isSignUp = false;
        let weightChart = null;
        let currentMonth = new Date();
        let fastingInterval = null;
        let fastingState = null;
        let deferredPrompt = null;
        let notificationCheckInterval = null;
        let nutritionChart = null;
        let aiToastTimeout = null;
        let pendingMealData = null;
        let recentMealDocId = null;
        let currentMealType = 'ì•„ì¹¨'; // í˜„ì¬ ì„ íƒëœ ì‹ì‚¬ íƒ€ì…
        const GEMINI_API_KEY = 'AIzaSyAsbGUSuVIrPes0kYmcz6HbghavnaI-bhc'; // Gemini API í‚¤ (ìµœì‹ )

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10001;
                animation: fadeIn 0.3s ease-in-out;
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ==================== ê³¼í•™ì  ì¹¼ë¡œë¦¬ ê³„ì‚° (Harris-Benedict ê³µì‹) ====================
        
        /**
         * Harris-Benedict ê³µì‹ìœ¼ë¡œ ê¸°ì´ˆëŒ€ì‚¬ëŸ‰(BMR) ê³„ì‚°
         * @param {string} gender - 'male' ë˜ëŠ” 'female'
         * @param {number} weight - ì²´ì¤‘ (kg)
         * @param {number} height - í‚¤ (cm)
         * @param {number} age - ë‚˜ì´
         * @returns {number} BMR (kcal/day)
         */
        function calculateBMR(gender, weight, height, age) {
            // Harris-Benedict ê³µì‹ (ìˆ˜ì • ë²„ì „, Mifflin-St Jeor ê³µì‹)
            // ë‚¨ì„±: BMR = (10 Ã— ì²´ì¤‘kg) + (6.25 Ã— í‚¤cm) - (5 Ã— ë‚˜ì´) + 5
            // ì—¬ì„±: BMR = (10 Ã— ì²´ì¤‘kg) + (6.25 Ã— í‚¤cm) - (5 Ã— ë‚˜ì´) - 161
            
            if (gender === 'male') {
                return (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                return (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
        }

        /**
         * í™œë™ëŸ‰ì— ë”°ë¥¸ TDEE (Total Daily Energy Expenditure) ê³„ì‚°
         * @param {number} bmr - ê¸°ì´ˆëŒ€ì‚¬ëŸ‰
         * @param {string} activityLevel - í™œë™ëŸ‰ ('sedentary', 'light', 'moderate', 'active', 'very_active')
         * @returns {number} TDEE (kcal/day)
         */
        function calculateTDEE(bmr, activityLevel) {
            const activityMultipliers = {
                'sedentary': 1.2,      // ê±°ì˜ ìš´ë™ ì•ˆ í•¨ (ì‚¬ë¬´ì§)
                'light': 1.375,        // ê°€ë²¼ìš´ ìš´ë™ (ì£¼ 1-3íšŒ) - ì‚¬ì„œ, ìš´í–‰ì›
                'moderate': 1.55,      // ë³´í†µ ìš´ë™ (ì£¼ 3-5íšŒ) - êµì‚¬, íŒë§¤ì§
                'active': 1.725,       // ì ê·¹ì  ìš´ë™ (ì£¼ 6-7íšŒ)
                'very_active': 1.9     // ë§¤ìš° ì ê·¹ì  (í•˜ë£¨ 2íšŒ ìš´ë™, ìœ¡ì²´ ë…¸ë™)
            };
            
            return Math.round(bmr * (activityMultipliers[activityLevel] || 1.55));
        }

        /**
         * ê°ëŸ‰ ëª©í‘œì— ë”°ë¥¸ ì¼ì¼ ê¶Œì¥ ì¹¼ë¡œë¦¬ ê³„ì‚°
         * @param {number} tdee - ì´ ì—ë„ˆì§€ ì†Œë¹„ëŸ‰
         * @param {number} weeklyGoalKg - ì£¼ê°„ ê°ëŸ‰ ëª©í‘œ (kg/ì£¼, ìŒìˆ˜ëŠ” ì¦ëŸ‰)
         * @returns {number} ì¼ì¼ ê¶Œì¥ ì¹¼ë¡œë¦¬ (kcal/day)
         */
        function calculateDailyCalories(tdee, weeklyGoalKg) {
            // 1kg ì²´ì¤‘ ê°ëŸ‰ = ì•½ 7700kcal ì ì
            const dailyDeficit = (weeklyGoalKg * 7700) / 7;
            const targetCalories = Math.round(tdee - dailyDeficit);
            
            // ì•ˆì „ ë²”ìœ„: ìµœì†Œ 1200kcal (ì—¬ì„±), 1500kcal (ë‚¨ì„±)
            // ìµœëŒ€ TDEE + 500kcal (ì¦ëŸ‰ ì‹œ)
            return Math.max(1000, Math.min(targetCalories, tdee + 500));
        }

        /**
         * ê³¼í•™ì  íƒ„ë‹¨ì§€ ë¹„ìœ¨ ê³„ì‚°
         * @param {number} dailyCalories - ì¼ì¼ ê¶Œì¥ ì¹¼ë¡œë¦¬
         * @param {string} goal - ëª©í‘œ ('lose_weight', 'maintain', 'gain_muscle')
         * @returns {object} {carbs: g, protein: g, fat: g}
         */
        function calculateMacros(dailyCalories, goal = 'lose_weight') {
            let carbPercent, proteinPercent, fatPercent;
            
            // ëª©í‘œì— ë”°ë¥¸ íƒ„ë‹¨ì§€ ë¹„ìœ¨
            if (goal === 'lose_weight') {
                // ë‹¤ì´ì–´íŠ¸: íƒ„ 45%, ë‹¨ 30%, ì§€ 25%
                carbPercent = 0.45;
                proteinPercent = 0.30;
                fatPercent = 0.25;
            } else if (goal === 'gain_muscle') {
                // ê·¼ìœ¡ ì¦ê°€: íƒ„ 40%, ë‹¨ 35%, ì§€ 25%
                carbPercent = 0.40;
                proteinPercent = 0.35;
                fatPercent = 0.25;
            } else {
                // ìœ ì§€: íƒ„ 50%, ë‹¨ 25%, ì§€ 25%
                carbPercent = 0.50;
                proteinPercent = 0.25;
                fatPercent = 0.25;
            }
            
            // ì¹¼ë¡œë¦¬ â†’ ê·¸ë¨ ë³€í™˜
            // íƒ„ìˆ˜í™”ë¬¼: 1g = 4kcal
            // ë‹¨ë°±ì§ˆ: 1g = 4kcal
            // ì§€ë°©: 1g = 9kcal
            return {
                carbs: Math.round((dailyCalories * carbPercent) / 4),
                protein: Math.round((dailyCalories * proteinPercent) / 4),
                fat: Math.round((dailyCalories * fatPercent) / 9)
            };
        }

        /**
         * í”„ë¡œí•„ ê¸°ë°˜ ì™„ì „í•œ ì˜ì–‘ ê³„íš ìƒì„±
         * @param {object} profile - {gender, weight, height, age, activityLevel, weeklyGoalKg, goal}
         * @returns {object} {bmr, tdee, dailyCalories, macros}
         */
        function generateNutritionPlan(profile) {
            const bmr = calculateBMR(profile.gender, profile.weight, profile.height, profile.age);
            const tdee = calculateTDEE(bmr, profile.activityLevel);
            const dailyCalories = calculateDailyCalories(tdee, profile.weeklyGoalKg);
            const macros = calculateMacros(dailyCalories, profile.goal);
            
            return {
                bmr: Math.round(bmr),
                tdee: Math.round(tdee),
                dailyCalories: dailyCalories,
                macros: macros
            };
        }

        // ==================== ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ====================
        
        // ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ í™•ì¸ ë° ë°°ë„ˆ í‘œì‹œ
        function checkNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            const permission = Notification.permission;
            console.log('í˜„ì¬ ì•Œë¦¼ ê¶Œí•œ:', permission);

            if (permission === 'default') {
                // ì•„ì§ ê¶Œí•œì„ ë¬»ì§€ ì•Šì€ ìƒíƒœ â†’ ë°°ë„ˆ í‘œì‹œ
                document.getElementById('notificationBanner').classList.remove('hidden');
            } else if (permission === 'denied') {
                console.warn('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else if (permission === 'granted') {
                console.log('âœ… ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ í•¨ìˆ˜ (ë°°ë„ˆìš© - ì•„ë˜ requestNotificationPermission í˜¸ì¶œ)
        async function requestNotificationFromBanner() {
            const granted = await requestNotificationPermission();
            if (granted) {
                document.getElementById('notificationBanner').classList.add('hidden');
                // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë°œì†¡
                sendPushNotification(
                    'ğŸ”” Diet Mate ì•Œë¦¼ í™œì„±í™”',
                    'ì´ì œ ì‹ì‚¬ ì‹œê°„ê³¼ ìš´ë™ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”! ğŸ’ª',
                    'welcome-notification'
                );
            } else if (Notification.permission === 'denied') {
                document.getElementById('notificationBanner').classList.add('hidden');
            }
        }

        // ==================== BMR/TDEE ê³„ì‚° ====================
        
        /**
         * BMR (ê¸°ì´ˆëŒ€ì‚¬ëŸ‰) ê³„ì‚° - Harris-Benedict ê³µì‹
         */
        function calculateBMR(weight, height, age, gender) {
            if (gender === 'male') {
                return 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                return 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
        }

        /**
         * TDEE (ì´ ì—ë„ˆì§€ ì†Œë¹„ëŸ‰) ê³„ì‚°
         */
        function calculateTDEE(bmr, activityLevel = 'light') {
            const multipliers = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                active: 1.725,
                veryActive: 1.9
            };
            return bmr * (multipliers[activityLevel] || 1.375);
        }

        /**
         * ëª©í‘œ ì¹¼ë¡œë¦¬ ê³„ì‚°
         */
        function calculateGoalCalories(tdee, goal = 'lose') {
            if (goal === 'lose') {
                return Math.round(tdee - 500);
            } else if (goal === 'gain') {
                return Math.round(tdee + 300);
            } else {
                return Math.round(tdee);
            }
        }


        // ==================== D-Day ê³„ì‚° ====================
        
        /**
         * D-Day í‘œì‹œ ì—…ë°ì´íŠ¸
         */
        function updateDDayDisplay(targetDate) {
            const ddayDisplay = document.getElementById('ddayDisplay');
            
            if (!targetDate) {
                ddayDisplay.classList.add('hidden');
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const target = new Date(targetDate);
            target.setHours(0, 0, 0, 0);

            const diffTime = target - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const diffWeeks = Math.floor(diffDays / 7);

            const ddayMain = ddayDisplay.querySelector('.dday-main');
            const ddaySub = ddayDisplay.querySelector('.dday-sub');

            const year = target.getFullYear();
            const month = String(target.getMonth() + 1).padStart(2, '0');
            const day = String(target.getDate()).padStart(2, '0');
            const dateStr = `${year.toString().slice(2)}-${month}-${day}`;

            if (diffDays > 0) {
                ddayMain.textContent = `D-${diffDays}`;
                ddaySub.textContent = `ëª©í‘œì¼: ${dateStr} (ì•½ ${diffWeeks}ì£¼)`;
            } else if (diffDays === 0) {
                ddayMain.textContent = `D-DAY`;
                ddaySub.textContent = `ğŸ‰ ëª©í‘œì¼ì…ë‹ˆë‹¤!`;
            } else {
                ddayMain.textContent = `D+${Math.abs(diffDays)}`;
                ddaySub.textContent = `ëª©í‘œì¼ ${Math.abs(diffDays)}ì¼ ê²½ê³¼`;
            }

            ddayDisplay.classList.remove('hidden');
        }
        
        /**
         * í˜„ì‹¤ì ì¸ ëª©í‘œ ë‹¬ì„±ì¼ ê³„ì‚° ë° í‘œì‹œ
         * - í˜„ì¬ ì²´ì¤‘ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚° (ì²´ì¤‘ ë³€í™”ì— ë”°ë¼ ìë™ ì—…ë°ì´íŠ¸)
         */
        function updateRealisticGoalDisplay(currentWeight) {
            const realisticDisplay = document.getElementById('realisticGoalDisplay');
            const realisticText = document.getElementById('realisticGoalText');
            
            const goalWeight = currentProfile.goalWeight || 0;
            const remaining = Math.abs(currentWeight - goalWeight);
            
            if (remaining <= 0) {
                realisticDisplay.classList.add('hidden');
                return;
            }
            
            // ê±´ê°•í•œ ê°ëŸ‰ ì†ë„: ì£¼ë‹¹ 0.5-1kg
            // ë³´ìˆ˜ì ìœ¼ë¡œ ì£¼ë‹¹ 0.75kg ê¸°ì¤€
            const weeksNeeded = Math.ceil(remaining / 0.75);
            const daysNeeded = weeksNeeded * 7;
            
            const today = new Date();
            const realisticDate = new Date(today);
            realisticDate.setDate(today.getDate() + daysNeeded);
            
            const year = realisticDate.getFullYear();
            const month = String(realisticDate.getMonth() + 1).padStart(2, '0');
            const day = String(realisticDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            realisticText.textContent = `ì˜ˆìƒ ë‹¬ì„±ì¼: ${dateStr} (ì•½ ${weeksNeeded}ì£¼ í›„)`;
            realisticDisplay.classList.remove('hidden');
            
            console.log('ğŸ’¡ í˜„ì‹¤ì ì¸ ëª©í‘œì¼:', dateStr, `(${daysNeeded}ì¼, ${weeksNeeded}ì£¼)`, `ë‚¨ì€ ê°ëŸ‰: ${remaining}kg`);
        }


        // ========== Phase 1: ì˜ì–‘ ì„­ì·¨ ê´€ë¦¬ ==========
        let todayIntake = {
            calories: 0,
            carbs: 0,
            protein: 0,
            fat: 0,
            meals: []
        };

        let dailyNutrition = {
            totalCalories: 0,
            targetCarbs: 0,
            targetProtein: 0,
            targetFat: 0
        };

        let midnightResetInterval = null;

        // Phase 4: ë°°ì¹˜ ì‘ì—…ì„ ìœ„í•œ ë³€ìˆ˜
        let isSelectMode = false;
        let selectedItems = new Set();
        let allPhotoItems = []; // í˜„ì¬ í‘œì‹œëœ ëª¨ë“  ì‚¬ì§„ í•­ëª© {docId, url}

        // Phase 4: ì¹´í…Œê³ ë¦¬ ë³€ê²½ì„ ìœ„í•œ ë³€ìˆ˜
        let changingPhotoId = null;
        let changingPhotoCurrentCategory = null;

        // Phase 4: ìˆ˜ë™ ë³‘í•©ì„ ìœ„í•œ ë³€ìˆ˜
        let mergingSourceId = null; // í˜„ì¬ ì„ íƒí•œ ì‹ì‚¬ (ë³‘í•©ë  í•­ëª©)

        // ì›”ë³„ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì¶”ì  (4.5GB ì œí•œ)
        const STORAGE_LIMIT = 4.5 * 1024 * 1024 * 1024; // 4.5GB in bytes
        const STORAGE_USAGE_KEY = 'diet_mate_storage_usage';

        // Gemini API í‚¤ ë°°ì—´
        const API_KEYS = [
            'AIzaSyAsbGUSuVIrPes0kYmcz6HbghavnaI-bhc'
        ];
        let currentAPIKeyIndex = 0;

        // LocalStorage í‚¤
        const LS_KEYS = {
            AI_CHAT: 'diet_mate_ai_chat',
            NOTIFICATIONS: 'diet_mate_notifications',
            FASTING: 'diet_mate_fasting',
            PWA_INSTALLED: 'diet_mate_pwa_installed',
            WATER_SETTINGS: 'diet_mate_water_settings'
        };

        // ==================== Gemini API í˜¸ì¶œ (ë¡œí…Œì´ì…˜ ë¡œì§) ====================
        // ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ ì¡°íšŒ (ë””ë²„ê¹…ìš©)
        async function listAvailableModels() {
            try {
                const apiKey = API_KEYS[currentAPIKeyIndex];
                console.log('ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹œì‘...');
                
                // v1beta APIë¡œ ì‹œë„
                let response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`
                );
                
                if (!response.ok) {
                    // v1 APIë¡œ ì‹œë„
                    response = await fetch(
                        `https://generativelanguage.googleapis.com/v1/models?key=${apiKey}`
                    );
                }
                
                if (response.ok) {
                    const data = await response.json();
                    const modelNames = data.models?.map(m => {
                        // "models/gemini-1.5-flash" í˜•ì‹ì—ì„œ "gemini-1.5-flash"ë§Œ ì¶”ì¶œ
                        return m.name.replace('models/', '');
                    }) || [];
                    console.log('âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡:', modelNames);
                    console.log('ğŸ“‹ ì „ì²´ ëª¨ë¸ ì •ë³´:', data.models);
                    return modelNames;
                } else {
                    const errorText = await response.text();
                    console.error('âŒ ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', response.status, errorText);
                }
            } catch (error) {
                console.error('âŒ ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì—ëŸ¬:', error);
            }
            return [];
        }

        // ==================== ê³µí†µ Gemini API í˜¸ì¶œ í•¨ìˆ˜ ====================
        async function callGeminiAPIBase(prompt, retries = 3) {
            try {
                // ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ (ìš°ì„ ìˆœìœ„ ìˆœ) - íš¨ìœ¨ì ì´ê³  ë§ì´ ì“¸ ìˆ˜ ìˆëŠ” ëª¨ë¸
                // Flash ëª¨ë¸: ë¹ ë¥´ê³  íš¨ìœ¨ì ì´ë©° í• ë‹¹ëŸ‰ì´ ë§ìŒ, í…ìŠ¤íŠ¸+ì´ë¯¸ì§€ ëª¨ë‘ ì§€ì›
                const modelNames = [
                    'gemini-2.5-flash',          // ìµœì‹  Flash (ê°€ì¥ íš¨ìœ¨ì , ë¹ ë¦„, í• ë‹¹ëŸ‰ ë§ìŒ) â­
                    'gemini-flash-latest',       // ìµœì‹  Flash ìë™ ì—…ë°ì´íŠ¸ (íš¨ìœ¨ì )
                    'gemini-2.0-flash',          // 2.0 Flash (ì•ˆì •ì )
                    'gemini-2.0-flash-exp',      // 2.0 Flash Experimental
                    'gemini-2.5-pro',            // Pro ëª¨ë¸ (í•„ìš”ì‹œë§Œ ì‚¬ìš©, ëŠë¦¬ì§€ë§Œ ì •í™•)
                    'gemini-pro-latest'          // Pro ìë™ ì—…ë°ì´íŠ¸
                ];
                // v1betaë§Œ ì‹œë„ (Google AI StudioëŠ” ì£¼ë¡œ v1beta ì‚¬ìš©)
                const apiVersions = ['v1beta'];
                
                // ê° API ë²„ì „ê³¼ ëª¨ë¸ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‹œë„
                for (const apiVersion of apiVersions) {
                    for (const modelName of modelNames) {
                        for (let attempt = 0; attempt < retries; attempt++) {
                            try {
                            const apiKey = API_KEYS[currentAPIKeyIndex];
                            console.log(`ğŸ”„ Gemini API í˜¸ì¶œ ì‹œë„ ${attempt + 1}/${retries} (${apiVersion}/${modelName})...`);

                            const response = await fetch(
                                `https://generativelanguage.googleapis.com/${apiVersion}/models/${modelName}:generateContent?key=${apiKey}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        contents: [{
                                            parts: [{ text: prompt }]
                                        }]
                                    })
                                }
                            );

                            if (response.status === 429) {
                                console.warn('âš ï¸ API í• ë‹¹ëŸ‰ ì´ˆê³¼ (429), ë‹¤ìŒ í‚¤ë¡œ ì „í™˜...');
                                currentAPIKeyIndex = (currentAPIKeyIndex + 1) % API_KEYS.length;
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                continue;
                            }

                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                // 403 ì—ëŸ¬ (ê¶Œí•œ/API í‚¤ ë¬¸ì œ)ì¸ ê²½ìš° ì¦‰ì‹œ ì‹¤íŒ¨ - ë‹¤ë¥¸ ëª¨ë¸ ì‹œë„ ì˜ë¯¸ ì—†ìŒ
                                if (response.status === 403) {
                                    console.error('âŒ API í‚¤ ê¶Œí•œ ì˜¤ë¥˜ (403):', errorData);
                                    throw new Error(`API í‚¤ ì˜¤ë¥˜: ${errorData.error?.message || 'API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.'}`);
                                }
                                // 404 ì—ëŸ¬ì¸ ê²½ìš° ë‹¤ìŒ ëª¨ë¸ ì‹œë„
                                if (response.status === 404) {
                                    console.warn(`âš ï¸ ëª¨ë¸ ${apiVersion}/${modelName}ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ìŒ ëª¨ë¸ ì‹œë„...`);
                                    break; // ë‹¤ìŒ ëª¨ë¸ë¡œ ì´ë™
                                }
                                console.error('âŒ API ì˜¤ë¥˜:', response.status, errorData);
                                throw new Error(`API Error: ${response.status} - ${JSON.stringify(errorData)}`);
                            }

                            const data = await response.json();
                            console.log(`âœ… Gemini API ì‘ë‹µ ì„±ê³µ (${apiVersion}/${modelName})`);
                            return data.candidates[0].content.parts[0].text;

                        } catch (error) {
                            // 403 ì—ëŸ¬(API í‚¤ ë¬¸ì œ)ì¸ ê²½ìš° ì¦‰ì‹œ ì‹¤íŒ¨ - ë‹¤ë¥¸ ëª¨ë¸ ì‹œë„ ì˜ë¯¸ ì—†ìŒ
                            if (error.message && (error.message.includes('403') || error.message.includes('API í‚¤'))) {
                                console.error('âŒ API í‚¤ ë¬¸ì œë¡œ ì¸í•œ ì‹¤íŒ¨:', error.message);
                                // ì „ì²´ í•¨ìˆ˜ì—ì„œ catchí•˜ë„ë¡ ì—ëŸ¬ ì¬ë°œìƒ
                                throw error;
                            }
                            // 404 ì—ëŸ¬ì¸ ê²½ìš° ë‹¤ìŒ ëª¨ë¸ë¡œ ì´ë™
                            if (error.message && error.message.includes('404')) {
                                console.warn(`âš ï¸ ëª¨ë¸ ${apiVersion}/${modelName} ì‹¤íŒ¨, ë‹¤ìŒ ëª¨ë¸ ì‹œë„...`);
                                break; // ë‹¤ìŒ ëª¨ë¸ë¡œ ì´ë™
                            }
                            console.error('âŒ Gemini API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                            if (attempt === retries - 1) {
                                // ë§ˆì§€ë§‰ ì‹œë„ ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ ëª¨ë¸ë¡œ ì´ë™
                                break;
                            }
                            await new Promise(resolve => setTimeout(resolve, 500 * (attempt + 1)));
                        }
                    }
                }
            }
            
            // ëª¨ë“  ëª¨ë¸ ì‹œë„ ì‹¤íŒ¨
            return 'AIê°€ íœ´ì‹ ì¤‘ì´ì—ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”! ğŸ˜Š\n(ì—ëŸ¬: ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)';
        } catch (apiKeyError) {
            // API í‚¤ ê´€ë ¨ ì—ëŸ¬ì¸ ê²½ìš° ëª…í™•í•œ ë©”ì‹œì§€ ë°˜í™˜
            if (apiKeyError.message && (apiKeyError.message.includes('403') || apiKeyError.message.includes('API í‚¤'))) {
                return 'ğŸ”‘ API í‚¤ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nGoogle AI Studioì—ì„œ ìƒˆë¡œìš´ API í‚¤ë¥¼ ìƒì„±í•˜ê³ , ì½”ë“œì˜ API_KEYS ë°°ì—´ì— ì¶”ê°€í•´ì£¼ì„¸ìš”.\n\ní˜„ì¬ API í‚¤ê°€ ìœ ì¶œëœ ê²ƒìœ¼ë¡œ ê°ì§€ë˜ì–´ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
            throw apiKeyError;
        }
        }

        // ğŸ”¥ 1. ìŒì‹ ê²€ìƒ‰ & ì˜ì–‘ DB (Flash 1.5 ëª¨ë¸)
        async function callGeminiFoodSearch(foodName) {
            console.log('ğŸ” [ìŒì‹ ê²€ìƒ‰] ì‹œì‘:', foodName);
            const prompt = `ë‹¹ì‹ ì€ í•œêµ­ ìŒì‹ ì „ë¬¸ ì˜ì–‘ ë°ì´í„°ë² ì´ìŠ¤ AIì…ë‹ˆë‹¤.

ì‚¬ìš©ìê°€ "${foodName}"ì„(ë¥¼) ê²€ìƒ‰í–ˆìŠµë‹ˆë‹¤.

**ìš”êµ¬ì‚¬í•­:**
1. í•œêµ­ì˜ ìœ ëª… í”„ëœì°¨ì´ì¦ˆ(ì˜ˆ: ì´ë°”ë”, ëˆ„ë¦¬ë§ˆì„, êµì´Œì¹˜í‚¨, êµ½ë„¤ì¹˜í‚¨, BBQ ë“±)ë‚˜ ì¼ë°˜ ì‹ë‹¹ì˜ "${foodName}" ì˜ì–‘ì •ë³´ë¥¼ **3~5ê°œ** ì œê³µ
2. **ë‹¨ìœ„ë¥¼ 1ì¸ë¶„(1íšŒ ì œê³µëŸ‰)ìœ¼ë¡œ í†µì¼**
3. ë¸Œëœë“œëª… ë˜ëŠ” ì¢…ë¥˜ë¥¼ ë°˜ë“œì‹œ í¬í•¨ (ì˜ˆ: 'ì´ë°”ë” ê°ìíƒ• 1ì¸ë¶„', 'ì¼ë°˜ ì‹ë‹¹ ê°ìíƒ• 1ì¸ë¶„')

**ì¶œë ¥ í˜•ì‹ (JSON):**
[
  {
    "foodName": "ë¸Œëœë“œ/ì¢…ë¥˜ëª… í¬í•¨ (ì˜ˆ: ì´ë°”ë” ê°ìíƒ• 1ì¸ë¶„)",
    "calories": ìˆ«ì,
    "carbs": ìˆ«ì,
    "protein": ìˆ«ì,
    "fat": ìˆ«ì
  }
]

**ì£¼ì˜:**
- JSON ë°°ì—´ë§Œ ì¶œë ¥í•˜ê³ , ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨ ê¸ˆì§€
- ì‹¤ì œ ì˜ì–‘ì •ë³´ ê¸°ë°˜ìœ¼ë¡œ ì •í™•íˆ ì œê³µ
- 1ì¸ë¶„ ê¸°ì¤€ í†µì¼`;
            
            return await callGeminiAPIBase(prompt);
        }

        // ğŸ”¥ 4. í…ìŠ¤íŠ¸ ë¶„ì„ (ë©”ëª¨ ì…ë ¥) - ë‹¨í˜¸í•œ í”¼ë“œë°±
        async function callGeminiNutritionAnalysis(foodName, grams, profile) {
            console.log('âœï¸ [í…ìŠ¤íŠ¸ ë¶„ì„] ì‹œì‘:', foodName, grams);
            const userName = profile?.name || 'íšŒì›';
            const prompt = `ë‹¹ì‹ ì€ ${userName} íšŒì›ë‹˜ì„ ë‹´ë‹¹í•˜ëŠ” ì—„ê²©í•œ ì˜ì–‘ íŠ¸ë ˆì´ë„ˆì…ë‹ˆë‹¤.

**ì…ë ¥ëœ ìŒì‹:**
- ìŒì‹ëª…: ${foodName}
${grams ? `- ì–‘: ${grams}g` : '- ì–‘: ì¼ë°˜ì ì¸ 1ì¸ë¶„ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°'}

**ë¶„ì„ ìš”ì²­:**
1. ìœ„ ìŒì‹ì˜ ì˜ì–‘ì„±ë¶„(ì¹¼ë¡œë¦¬, íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°©)ì„ ê³„ì‚°
2. ì–‘ì´ ëª…ì‹œë˜ì§€ ì•Šìœ¼ë©´ "ì¼ë°˜ì ì¸ 1ì¸ë¶„"ìœ¼ë¡œ ê°„ì£¼
3. ê³¼ì‹ì´ë‚˜ ê³ ì¹¼ë¡œë¦¬ ìŒì‹ì¸ ê²½ìš° ë‹¨í˜¸í•œ í”¼ë“œë°± ì œê³µ (ì˜ˆ: "${userName} íšŒì›ë‹˜, ì‚¼ê²¹ì‚´ 3ì¸ë¶„ì€ ì˜¤ëŠ˜ ìš´ë™ ê°•ë„ë¥¼ 2ë°°ë¡œ ë†’ì—¬ì•¼ í•˜ëŠ” ì–‘ì´ì—ìš”!")

**ì¶œë ¥ í˜•ì‹ (JSON):**
{
  "foodName": "ìŒì‹ëª…",
  "calories": ìˆ«ì,
  "carbs": ìˆ«ì,
  "protein": ìˆ«ì,
  "fat": ìˆ«ì,
  "advice": "${userName} íšŒì›ë‹˜... (ë‹¨í˜¸í•œ í”¼ë“œë°±, ìµœëŒ€ 50ì)"
}

**ì£¼ì˜:** JSONë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€`;
            
            return await callGeminiAPIBase(prompt);
        }

        // ğŸ”¥ 3. AI ì½”ì¹˜ (ë©”ì¸ ì±—ë´‡) - ì „ë¬¸ ë‹¤ì´ì–´íŠ¸ ì˜ì–‘ì‚¬ (v3.9.0 ê°œì„ )
        async function callGeminiCoach(userMessage, profile, todayData) {
            console.log('ğŸ’¬ [AI ì½”ì¹˜] ì‹œì‘:', userMessage);
            const userName = profile?.name || 'íšŒì›';
            const currentWeight = profile?.currentWeight || profile?.startWeight || 'ë¯¸ê¸°ë¡';
            const goalWeight = profile?.goalWeight || 'ë¯¸ì„¤ì •';
            const todayCalories = todayData?.calories || 0;
            const todayCarbs = todayData?.carbs || 0;
            const todayProtein = todayData?.protein || 0;
            const todayFat = todayData?.fat || 0;
            const todayMealCount = todayData?.meals?.length || 0;
            const targetCalories = profile?.calculatedCalories || 1620;
            const remainingCal = targetCalories - todayCalories;
            
            const prompt = `ë‹¹ì‹ ì€ ${userName} íšŒì›ë‹˜ì˜ ì „ë¬¸ ë‹¤ì´ì–´íŠ¸ ì˜ì–‘ì‚¬ì´ì ì‹ë‹¨ ì½”ì¹˜ì…ë‹ˆë‹¤.

**íšŒì› í”„ë¡œí•„:**
- ì´ë¦„: ${userName}
- í˜„ì¬ ì²´ì¤‘: ${currentWeight}kg
- ëª©í‘œ ì²´ì¤‘: ${goalWeight}kg
- ëª©í‘œ ì¹¼ë¡œë¦¬: ${targetCalories}kcal/ì¼
- ë‚˜ì´: ${profile?.age || 'ë¯¸ê¸°ë¡'}ì„¸
- í‚¤: ${profile?.height || 'ë¯¸ê¸°ë¡'}cm

**ì˜¤ëŠ˜ì˜ ì„­ì·¨ ê¸°ë¡:**
- ì¹¼ë¡œë¦¬: ${todayCalories}kcal / ${targetCalories}kcal (ë‚¨ì€ ì¹¼ë¡œë¦¬: ${remainingCal}kcal)
- íƒ„ìˆ˜í™”ë¬¼: ${todayCarbs}g
- ë‹¨ë°±ì§ˆ: ${todayProtein}g
- ì§€ë°©: ${todayFat}g
- ì‹ì‚¬ íšŸìˆ˜: ${todayMealCount}íšŒ

**íšŒì›ë‹˜ì˜ ì§ˆë¬¸:**
"${userMessage}"

**ğŸš« ì ˆëŒ€ ê¸ˆì§€ (ì´ëŸ° ë‹µë³€ ì‹œ ê°ì ):**
1. "ë‹¨ë°±ì§ˆê³¼ ì±„ì†Œ ìœ„ì£¼ë¡œ ë“œì„¸ìš”" ê°™ì€ ì¶”ìƒì  ë‹µë³€
2. "ê· í˜•ì¡íŒ ì‹ë‹¨ì„ í•˜ì„¸ìš”" ê°™ì€ ë»”í•œ ì¡°ì–¸
3. "ì ë‹¹íˆ ë“œì„¸ìš”" ê°™ì€ ì• ë§¤í•œ í‘œí˜„
4. êµ¬ì²´ì  ìŒì‹ëª…/ì¹¼ë¡œë¦¬ ì—†ì´ ë‹µë³€í•˜ê¸°
5. íƒ„ë‹¨ì§€ ì •ë³´ ì—†ì´ ì¹¼ë¡œë¦¬ë§Œ ì œì‹œí•˜ê¸°

**âœ… í•„ìˆ˜ í¬í•¨ ì‚¬í•­:**
1. **êµ¬ì²´ì ì¸ í•œêµ­ ìŒì‹ëª… + ì¹¼ë¡œë¦¬ + íƒ„ë‹¨ì§€ (íƒ„ìˆ˜í™”ë¬¼/ë‹¨ë°±ì§ˆ/ì§€ë°©)**
   ì˜ˆì‹œ: "ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œ(250kcal, íƒ„8g ë‹¨35g ì§€9g)"

2. **ìµœì†Œ 3ê°€ì§€ ë©”ë‰´ ì œì•ˆ (ë‹¤ì–‘í•œ ì¹´í…Œê³ ë¦¬)**
   - ìš”ì²­í•œ ìŒì‹ ì¹´í…Œê³ ë¦¬ì—ì„œ 1-2ê°œ
   - ë‹¤ë¥¸ ëŒ€ì•ˆ ì¹´í…Œê³ ë¦¬ì—ì„œ 1-2ê°œ
   ì˜ˆì‹œ: ì¤‘ì‹ ìš”ì²­ ì‹œ â†’ ì¤‘ì‹ 1ê°œ + í•œì‹ 1ê°œ + ê°„í¸ì‹ 1ê°œ

3. **ì‹¤ìš©ì ì¸ íŒ ì œê³µ**
   - "ë°¥ ë°˜ê³µê¸°ë§Œ ì£¼ì„¸ìš”" ë¯¸ë¦¬ ë§ì”€í•˜ì„¸ìš”!
   - ì†ŒìŠ¤ëŠ” ë”°ë¡œ ë‹¬ë¼ê³  í•˜ì„¸ìš”!
   - ë°°ë‹¬ ì‹œ ë°¥ ë¹¼ë‹¬ë¼ê³  ìš”ì²­í•˜ì„¸ìš”!

**ì‘ë‹µ í˜•ì‹ ì˜ˆì‹œ:**
"${userName} íšŒì›ë‹˜, ì¤‘ì‹ ë“œì‹œê³  ì‹¶ìœ¼ì‹œêµ°ìš”! ë‚¨ì€ ì¹¼ë¡œë¦¬ê°€ ${remainingCal}kcalì´ë‹ˆ ì´ë ‡ê²Œ ë“œì„¸ìš”:

ğŸ¥— ì¶”ì²œ ë©”ë‰´ (ì¹¼ë¡œë¦¬ ë‚®ì€ ìˆœ)
1. ê¹ì‡¼ìƒˆìš° + ê³„ë€ë³¶ìŒë°¥ ë°˜ê³µê¸° (550kcal, íƒ„65g ë‹¨28g ì§€18g)
2. ìƒˆìš°ë³¶ìŒë°¥ (450kcal, íƒ„60g ë‹¨22g ì§€14g)

ğŸš ë‹¤ë¥¸ ëŒ€ì•ˆ (ë” ê±´ê°•í•œ ì„ íƒ)
3. ë‹­ê°€ìŠ´ì‚´ ë®ë°¥ (420kcal, íƒ„55g ë‹¨38g ì§€8g)
4. ì°¸ì¹˜ ê¹€ë°¥ + ìƒëŸ¬ë“œ (380kcal, íƒ„48g ë‹¨20g ì§€12g)

ğŸ’¡ ì‹¤ì „ íŒ:
- ì¤‘ì‹ì§‘ ê°ˆ ë•Œ 'ë°¥ ë°˜ê³µê¸°ë§Œ ì£¼ì„¸ìš”!' ë¯¸ë¦¬ ë§ì”€í•˜ì„¸ìš”
- ì†ŒìŠ¤ëŠ” ë”°ë¡œ ë‹¬ë¼ê³  í•˜ë©´ ë‚˜íŠ¸ë¥¨ 50% â†“
- íƒ•ìˆ˜ìœ¡(1000kcal)ì€ í”¼í•˜ì„¸ìš”!

ì–´ë–¤ ê±¸ë¡œ ì„ íƒí•˜ì‹œê² ì–´ìš”? ğŸ˜Š"

**í•µì‹¬ ê·œì¹™:**
- ë°˜ë“œì‹œ ìŒì‹ëª…, ì¹¼ë¡œë¦¬, íƒ„ë‹¨ì§€(íƒ„ìˆ˜í™”ë¬¼/ë‹¨ë°±ì§ˆ/ì§€ë°©) ëª¨ë‘ í‘œê¸°
- 3ê°œ ì´ìƒ ë©”ë‰´ ì œì•ˆ (ì—¬ëŸ¬ ì¹´í…Œê³ ë¦¬ í¬í•¨)
- ë‚¨ì€ ì¹¼ë¡œë¦¬ë¥¼ ê³ ë ¤í•œ ì‹¤ì§ˆì  ì¡°ì–¸
- í•œêµ­ì¸ì—ê²Œ ìµìˆ™í•œ ìŒì‹ ìœ„ì£¼ ì¶”ì²œ
- ë”°ëœ»í•˜ì§€ë§Œ ì „ë¬¸ê°€ë‹¤ìš´ í†¤ ìœ ì§€

300ì ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”.`;
            
            return await callGeminiAPIBase(prompt);
        }

        // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•œ ê¸°ë³¸ í•¨ìˆ˜
        async function callGeminiAPI(prompt, retries = 3) {
            return await callGeminiAPIBase(prompt, retries);
        }

        // ==================== AI ì˜ì–‘ ë¶„ì„ í•¨ìˆ˜ ====================

        // íŒŒì¼ì„ Base64ë¡œ ì¸ì½”ë”©
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ğŸ”¥ 2. ì‚¬ì§„ ë¶„ì„ (AI íŠ¸ë ˆì´ë„ˆ+ì˜ì–‘ì‚¬)
        async function callGeminiVisionAPI(prompt, base64Image, retries = 3) {
            // ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ëª©ë¡ (ìš°ì„ ìˆœìœ„ ìˆœ) - íš¨ìœ¨ì ì´ê³  ë§ì´ ì“¸ ìˆ˜ ìˆëŠ” ëª¨ë¸
            // Flash ëª¨ë¸: ë¹ ë¥´ê³  íš¨ìœ¨ì ì´ë©° í• ë‹¹ëŸ‰ì´ ë§ìŒ, í…ìŠ¤íŠ¸+ì´ë¯¸ì§€ ëª¨ë‘ ì§€ì›
            const modelNames = [
                'gemini-2.5-flash',          // ìµœì‹  Flash (ê°€ì¥ íš¨ìœ¨ì , ë¹ ë¦„, í• ë‹¹ëŸ‰ ë§ìŒ) â­
                'gemini-flash-latest',       // ìµœì‹  Flash ìë™ ì—…ë°ì´íŠ¸ (íš¨ìœ¨ì )
                'gemini-2.0-flash',          // 2.0 Flash (ì•ˆì •ì )
                'gemini-2.0-flash-exp',      // 2.0 Flash Experimental
                'gemini-2.5-pro',            // Pro ëª¨ë¸ (í•„ìš”ì‹œë§Œ ì‚¬ìš©, ëŠë¦¬ì§€ë§Œ ì •í™•)
                'gemini-pro-latest'          // Pro ìë™ ì—…ë°ì´íŠ¸
            ];
            const apiVersion = 'v1beta';
            
            // ê° ëª¨ë¸ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‹œë„
            for (const modelName of modelNames) {
                for (let attempt = 0; attempt < retries; attempt++) {
                    try {
                        const apiKey = API_KEYS[currentAPIKeyIndex];
                        console.log(`ğŸ”„ Gemini Vision API (${modelName}) í˜¸ì¶œ ì‹œë„ ${attempt + 1}/${retries}...`);

                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/${apiVersion}/models/${modelName}:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: prompt },
                                        {
                                            inline_data: {
                                                mime_type: "image/jpeg",
                                                data: base64Image
                                            }
                                        }
                                    ]
                                }]
                            })
                        }
                    );

                    if (response.status === 429) {
                        console.warn('âš ï¸ API í• ë‹¹ëŸ‰ ì´ˆê³¼ (429), ë‹¤ìŒ í‚¤ë¡œ ì „í™˜...');
                        currentAPIKeyIndex = (currentAPIKeyIndex + 1) % API_KEYS.length;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            // 404 ì—ëŸ¬ì¸ ê²½ìš° ë‹¤ìŒ ëª¨ë¸ ì‹œë„
                            if (response.status === 404) {
                                console.warn(`âš ï¸ ëª¨ë¸ ${modelName}ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ìŒ ëª¨ë¸ ì‹œë„...`);
                                break; // ë‹¤ìŒ ëª¨ë¸ë¡œ ì´ë™
                            }
                            console.error('âŒ Vision API ì˜¤ë¥˜:', response.status, errorData);
                            throw new Error(`Vision API Error: ${response.status} - ${JSON.stringify(errorData)}`);
                        }

                        const data = await response.json();
                        console.log(`âœ… Gemini Vision API ì‘ë‹µ ì„±ê³µ (ëª¨ë¸: ${modelName})`);
                        return data.candidates[0].content.parts[0].text;

                    } catch (error) {
                        // 404 ì—ëŸ¬ì¸ ê²½ìš° ë‹¤ìŒ ëª¨ë¸ë¡œ ì´ë™
                        if (error.message && error.message.includes('404')) {
                            console.warn(`âš ï¸ ëª¨ë¸ ${modelName} ì‹¤íŒ¨, ë‹¤ìŒ ëª¨ë¸ ì‹œë„...`);
                            break; // ë‹¤ìŒ ëª¨ë¸ë¡œ ì´ë™
                        }
                        console.error('âŒ Gemini Vision API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                        if (attempt === retries - 1) {
                            // ë§ˆì§€ë§‰ ì‹œë„ ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ ëª¨ë¸ë¡œ ì´ë™
                            continue;
                        }
                        await new Promise(resolve => setTimeout(resolve, 500 * (attempt + 1)));
                    }
                }
            }
            
            // ëª¨ë“  ëª¨ë¸ ì‹œë„ ì‹¤íŒ¨
            throw new Error('ì´ë¯¸ì§€ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }

        // AI ì‘ë‹µì—ì„œ JSON íŒŒì‹± (ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°)
        function parseNutritionResponse(responseText) {
            try {
                // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
                let jsonText = responseText.trim();
                const codeBlockMatch = jsonText.match(/```json\s*([\s\S]*?)\s*```/);
                if (codeBlockMatch) {
                    jsonText = codeBlockMatch[1];
                }

                const data = JSON.parse(jsonText);

                return {
                    calories: parseFloat(data.calories) || 0,
                    carbs: parseFloat(data.carbs) || 0,
                    protein: parseFloat(data.protein) || 0,
                    fat: parseFloat(data.fat) || 0,
                    foodName: data.foodName || 'ì•Œ ìˆ˜ ì—†ìŒ',
                    advice: data.advice || 'ê· í˜•ì¡íŒ ì‹ì‚¬ë¥¼ í•˜ì„¸ìš”.'
                };
            } catch (error) {
                console.error('ì˜ì–‘ ì •ë³´ íŒŒì‹± ì‹¤íŒ¨:', error);
                return {
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0,
                    foodName: 'ì•Œ ìˆ˜ ì—†ìŒ',
                    advice: 'ì˜ì–‘ ë¶„ì„ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
                };
            }
        }

        // ì´ë¯¸ì§€ì—ì„œ ì˜ì–‘ ë¶„ì„
        async function analyzeNutritionFromImage(file, imageUrl) {
            try {
                // ğŸ”¥ Mealo ìŠ¤íƒ€ì¼ ì¹´ë“œ ëª¨ë‹¬ í‘œì‹œ (ë¶„ì„ ì¤‘ ìƒíƒœ)
                showFoodAnalysisCard(imageUrl, null, true); // ë¶„ì„ ì¤‘ ìƒíƒœ

                // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const weightsSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .orderBy('date', 'desc')
                    .limit(1)
                    .get();

                const currentWeight = weightsSnapshot.empty
                    ? currentProfile.startWeight
                    : weightsSnapshot.docs[0].data().weight;

                // Base64 ì¸ì½”ë”©
                const base64Image = await fileToBase64(file);

                // ğŸ”¥ 2. ì‚¬ì§„ ë¶„ì„ í”„ë¡¬í”„íŠ¸ (AI íŠ¸ë ˆì´ë„ˆ+ì˜ì–‘ì‚¬)
                console.log('ğŸ“¸ [ì‚¬ì§„ ë¶„ì„] ì‹œì‘');
                const userName = currentProfile?.name || 'íšŒì›';
                const weightDiff = currentWeight - currentProfile.goalWeight;
                const goalDescription = weightDiff > 0 ? `${Math.abs(weightDiff).toFixed(1)}kg ê°ëŸ‰` : (weightDiff < 0 ? `${Math.abs(weightDiff).toFixed(1)}kg ì¦ëŸ‰` : 'í˜„ì¬ ì²´ì¤‘ ìœ ì§€');

                const prompt = `ë‹¹ì‹ ì€ ${userName} íšŒì›ë‹˜ì„ ë‹´ë‹¹í•˜ëŠ” ì „ë¬¸ ì˜ì–‘ ë¶„ì„ AIì…ë‹ˆë‹¤.

**íšŒì› ì •ë³´:**
- ì´ë¦„: ${userName}
- í˜„ì¬ ì²´ì¤‘: ${currentWeight}kg
- ëª©í‘œ ì²´ì¤‘: ${currentProfile.goalWeight}kg
- ëª©í‘œ: ${goalDescription}

**ë¶„ì„ ìš”ì²­:**
1. ì‚¬ì§„ì—ì„œ ìŒì‹ ì¢…ë¥˜ì™€ ì–‘ì„ ì •í™•íˆ íŒŒì•… (ì˜ˆ: 'ì¡ê³¡ë°¥ 2/3ê³µê¸°(150g)', 'ì‚¼ê²¹ì‚´ êµ¬ì´ 200g')
2. ì˜ì–‘ì†Œ ì •ë°€ ì¶”ì • (ì¹¼ë¡œë¦¬, íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°©ì„ ê·¸ë¨ ë‹¨ìœ„ê¹Œì§€ ì •í™•íˆ)
3. íƒ„ë‹¨ì§€(íƒ„ìˆ˜í™”ë¬¼/ë‹¨ë°±ì§ˆ/ì§€ë°©) ë¹„ìœ¨ ë¶„ì„
4. 50ì ì´ë‚´ì˜ ì „ë¬¸ê°€ ì¡°ì–¸:
   - ë‹¨ë°±ì§ˆ ë¶€ì¡± ì‹œ: "${userName} íšŒì›ë‹˜, ë‹¨ë°±ì§ˆì´ ${Math.round(currentWeight * 1.5)}g í•„ìš”í•œë° ë¶€ì¡±í•´ìš”. ë‹­ê°€ìŠ´ì‚´ ì¶”ê°€ ë“œì„¸ìš”!"
   - íƒ„ìˆ˜í™”ë¬¼ ê³¼ë‹¤ ì‹œ: "${userName} íšŒì›ë‹˜, íƒ„ìˆ˜í™”ë¬¼ì´ ${Math.round((currentProfile.calculatedCalories || 1620) * 0.5 / 4)}g ì´ˆê³¼í–ˆì–´ìš”. ë‹¤ìŒ ë¼ë‹ˆëŠ” í˜„ë¯¸ë°¥ ë°˜ê³µê¸°ë¡œ!"
   - ë‚˜íŠ¸ë¥¨ ê³¼ë‹¤ ì‹œ: "${userName} íšŒì›ë‹˜, ë‚˜íŠ¸ë¥¨ì´ ë†’ì•„ìš”. ë¬¼ 500ml ë§ˆì‹œì„¸ìš”!"
   - ê³ ì¹¼ë¡œë¦¬ ì‹œ: "${userName} íšŒì›ë‹˜, ì˜¤ëŠ˜ ëª©í‘œ ì¹¼ë¡œë¦¬ ì´ˆê³¼! 30ë¶„ ê±·ê¸° ì¶”ì²œí•´ìš”!"
   - ê· í˜•ì¡íŒ ì‹ì‚¬ ì‹œ: "${userName} íšŒì›ë‹˜, ì™„ë²½í•œ íƒ„ë‹¨ì§€ ë¹„ìœ¨ì´ì—ìš”! ğŸ‘"

**ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ JSONë§Œ ì¶œë ¥):**
{
  "foodName": "ì •í™•í•œ ìŒì‹ëª… + ì–‘ (ì˜ˆ: ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œ 1ì¸ë¶„(280g))",
  "calories": ìˆ«ì (ì •ìˆ˜),
  "carbs": ìˆ«ì (ì†Œìˆ˜ì  1ìë¦¬, ê·¸ë¨ ë‹¨ìœ„),
  "protein": ìˆ«ì (ì†Œìˆ˜ì  1ìë¦¬, ê·¸ë¨ ë‹¨ìœ„),
  "fat": ìˆ«ì (ì†Œìˆ˜ì  1ìë¦¬, ê·¸ë¨ ë‹¨ìœ„),
  "advice": "${userName} íšŒì›ë‹˜... (50ì ì´ë‚´ ì „ë¬¸ê°€ ì¡°ì–¸)"
}

**ì¤‘ìš”:** JSONë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ í…ìŠ¤íŠ¸ í¬í•¨ ì ˆëŒ€ ê¸ˆì§€. ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì‚¬ìš© ê¸ˆì§€.`;

                // Gemini Vision API í˜¸ì¶œ
                const responseText = await callGeminiVisionAPI(prompt, base64Image);
                const nutrition = parseNutritionResponse(responseText);

                // ğŸ”¥ Mealo ìŠ¤íƒ€ì¼ ì¹´ë“œì— ê²°ê³¼ í‘œì‹œ
                showFoodAnalysisCard(imageUrl, nutrition, false); // ë¶„ì„ ì™„ë£Œ ìƒíƒœ

                return {
                    calories: nutrition.calories,
                    carbs: nutrition.carbs,
                    protein: nutrition.protein,
                    fat: nutrition.fat,
                    foodName: nutrition.foodName,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: nutrition.advice
                };

            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì˜ì–‘ ë¶„ì„ ì‹¤íŒ¨:', error);
                
                // ğŸ”¥ ì‹¤íŒ¨ ì‹œ ì¹´ë“œ ë‹«ê¸°
                closeFoodAnalysisResult();
                
                return {
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0,
                    foodName: 'ì•Œ ìˆ˜ ì—†ìŒ',
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `${currentProfile.name} íšŒì›ë‹˜, AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`
                };
            }
        }

        // í…ìŠ¤íŠ¸ì—ì„œ ì˜ì–‘ ë¶„ì„
        async function analyzeNutritionFromText(text) {
            try {
                // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const weightsSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .orderBy('date', 'desc')
                    .limit(1)
                    .get();

                const currentWeight = weightsSnapshot.empty
                    ? currentProfile.startWeight
                    : weightsSnapshot.docs[0].data().weight;

                // AI í”„ë¡¬í”„íŠ¸ ìƒì„± (íŠ¸ë ˆì´ë„ˆ í˜ë¥´ì†Œë‚˜)
                const weightDiff = currentWeight - currentProfile.goalWeight;
                const goalDescription = weightDiff > 0 ? `${Math.abs(weightDiff).toFixed(1)}kg ê°ëŸ‰` : (weightDiff < 0 ? `${Math.abs(weightDiff).toFixed(1)}kg ì¦ëŸ‰` : 'í˜„ì¬ ì²´ì¤‘ ìœ ì§€');

                const prompt = `ë‹¹ì‹ ì€ ${currentProfile.name} íšŒì›ë‹˜ì„ ë‹´ë‹¹í•˜ëŠ” ì „ë¬¸ í¼ìŠ¤ë„ íŠ¸ë ˆì´ë„ˆì´ì ì˜ì–‘ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ ì˜ì–‘ ì„±ë¶„ì„ ì¶”ì •í•´ì£¼ì„¸ìš”.

**íšŒì› ì •ë³´:**
- íšŒì›ëª…: ${currentProfile.name} íšŒì›ë‹˜
- í˜„ì¬ ì²´ì¤‘: ${currentWeight}kg
- ëª©í‘œ ì²´ì¤‘: ${currentProfile.goalWeight}kg
- ëª©í‘œ: ${goalDescription}

**íšŒì›ë‹˜ì´ ì…ë ¥í•œ ì‹ì‚¬ ë‚´ìš©:** "${text}"

ì´ ì‹ì‚¬ì˜ ì˜ì–‘ ì„±ë¶„ì„ ì •í™•íˆ ë¶„ì„í•˜ê³ , íšŒì›ë‹˜ì˜ ë‹¤ì´ì–´íŠ¸ ëª©í‘œë¥¼ ê³ ë ¤í•˜ì—¬ ì „ë¬¸ê°€ë‹µê²Œ ì¡°ì–¸í•´ì£¼ì„¸ìš”.

**ì¡°ì–¸ ì‘ì„± ì§€ì¹¨:**
- í˜¸ì¹­: ë°˜ë“œì‹œ "${currentProfile.name} íšŒì›ë‹˜"ìœ¼ë¡œ ì‹œì‘
- í†¤: "í˜ë“  ê±° ì•Œì§€ë§Œ, ì´ê±° ë“œì‹œë©´ [ê²°ê³¼]í•´ìš”" ê°™ì€ ê³µê°+í˜„ì‹¤ì  ì¡°ì–¸
- ê¸¸ì´: 40ì ì´ë‚´

**ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš”:**

{
  "calories": ìˆ«ìë§Œ (kcal),
  "carbs": ìˆ«ìë§Œ (ê·¸ë¨),
  "protein": ìˆ«ìë§Œ (ê·¸ë¨),
  "fat": ìˆ«ìë§Œ (ê·¸ë¨),
  "foodName": "ìŒì‹ëª…",
  "advice": "${currentProfile.name} íšŒì›ë‹˜ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í•œ ì¤„ ì¡°ì–¸ (40ì ì´ë‚´)"
}`;

                // Gemini Text API í˜¸ì¶œ
                const responseText = await callGeminiAPI(prompt);
                const nutrition = parseNutritionResponse(responseText);

                return {
                    calories: nutrition.calories,
                    carbs: nutrition.carbs,
                    protein: nutrition.protein,
                    fat: nutrition.fat,
                    foodName: nutrition.foodName,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: nutrition.advice
                };

            } catch (error) {
                console.error('í…ìŠ¤íŠ¸ ì˜ì–‘ ë¶„ì„ ì‹¤íŒ¨:', error);
                return {
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0,
                    foodName: 'ì•Œ ìˆ˜ ì—†ìŒ',
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `${currentProfile.name} íšŒì›ë‹˜, AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`
                };
            }
        }

        // ==================== ğŸ”¥ v3.9.1: ì²´ì¤‘ ê·¸ë˜í”„ ëª¨ë‹¬ ====================
        
        let weightGraphChart = null;

        // ì²´ì¤‘ ê·¸ë˜í”„ ëª¨ë‹¬ ì—´ê¸°
        async function openWeightGraphModal() {
            document.getElementById('weightGraphModal').style.display = 'flex';

            try {
                // ìµœê·¼ 30ì¼ ì²´ì¤‘ ë°ì´í„° ì¡°íšŒ
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const weights = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
                    .orderBy('date', 'asc')
                    .get();

                const weightData = [];
                const dateLabels = [];
                
                weights.forEach(doc => {
                    const data = doc.data();
                    const date = data.date.toDate();
                    const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                    dateLabels.push(dateStr);
                    weightData.push(data.weight);
                });

                // ğŸ”¥ v3.9.2: í†µê³„ ê³„ì‚° ë¡œì§ ê°œì„ 
                const startWeight = currentProfile?.startWeight || 0;
                // ìµœê·¼ ê¸°ë¡ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì‹œì‘ ì²´ì¤‘ ì‚¬ìš©
                const currentWeight = weightData.length > 0 ? weightData[weightData.length - 1] : startWeight;
                const weightChange = currentWeight - startWeight;

                document.getElementById('modalStartWeight').textContent = `${startWeight.toFixed(1)}kg`;
                document.getElementById('modalCurrentWeight').textContent = `${currentWeight.toFixed(1)}kg`;
                
                // ë³€í™”ëŸ‰ì´ 0ì´ë©´ "ë³€í™” ì—†ìŒ" í‘œì‹œ
                if (weightChange === 0) {
                    document.getElementById('modalWeightChange').textContent = 'ë³€í™” ì—†ìŒ';
                    document.getElementById('modalWeightChange').style.color = '#999';
                } else {
                    document.getElementById('modalWeightChange').textContent = weightChange >= 0 ? `+${weightChange.toFixed(1)}kg` : `${weightChange.toFixed(1)}kg`;
                    document.getElementById('modalWeightChange').style.color = weightChange >= 0 ? '#ef4444' : '#22c55e';
                }

                // ì²´ì¤‘ ê¸°ë¡ ìœ ë„ í‘œì‹œ (ë§ˆì§€ë§‰ ê¸°ë¡ì´ ì˜¤ëŠ˜ì´ ì•„ë‹Œ ê²½ìš°)
                const today = new Date().toDateString();
                const lastRecordDate = weights.empty ? null : weights.docs[weights.docs.length - 1].data().date.toDate();
                
                if (!lastRecordDate || lastRecordDate.toDateString() !== today) {
                    document.getElementById('weightRecordPrompt').style.display = 'block';
                    document.getElementById('lastWeightDate').textContent = lastRecordDate ? `${lastRecordDate.getMonth() + 1}ì›” ${lastRecordDate.getDate()}ì¼` : 'ì—†ìŒ';
                } else {
                    document.getElementById('weightRecordPrompt').style.display = 'none';
                }

                // ê·¸ë˜í”„ ë Œë”ë§
                const ctx = document.getElementById('weightGraphChart');
                if (weightGraphChart) {
                    weightGraphChart.destroy();
                }

                weightGraphChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dateLabels,
                        datasets: [{
                            label: 'ì²´ì¤‘ (kg)',
                            data: weightData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'ì²´ì¤‘: ' + context.parsed.y.toFixed(1) + 'kg';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(1) + 'kg';
                                    }
                                }
                            }
                        }
                    }
                });

                // ìµœê·¼ ê¸°ë¡ ëª©ë¡
                let recentHTML = '';
                weights.docs.reverse().slice(0, 10).forEach(doc => {
                    const data = doc.data();
                    const date = data.date.toDate();
                    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    
                    recentHTML += `
                        <div style="padding: 12px; background: #f8f9fa; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; color: #333;">${date.getMonth() + 1}ì›” ${date.getDate()}ì¼</div>
                                <div style="font-size: 0.85rem; color: #666;">${dateStr}</div>
                            </div>
                            <div style="font-weight: bold; color: #667eea; font-size: 1.1rem;">${data.weight.toFixed(1)}kg</div>
                        </div>
                    `;
                });

                document.getElementById('recentWeightList').innerHTML = recentHTML || '<p style="text-align: center; color: #999; padding: 20px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';

            } catch (error) {
                console.error('ì²´ì¤‘ ê·¸ë˜í”„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì²´ì¤‘ ê·¸ë˜í”„ ëª¨ë‹¬ ë‹«ê¸°
        function closeWeightGraphModal() {
            document.getElementById('weightGraphModal').style.display = 'none';
            if (weightGraphChart) {
                weightGraphChart.destroy();
                weightGraphChart = null;
            }
        }

        // ë¹ ë¥¸ ì²´ì¤‘ ì…ë ¥ ëª¨ë‹¬ ì—´ê¸°
        function openQuickWeightInput() {
            document.getElementById('quickWeightInputModal').style.display = 'flex';
            document.getElementById('quickWeightInput').focus();
        }

        // ë¹ ë¥¸ ì²´ì¤‘ ì…ë ¥ ëª¨ë‹¬ ë‹«ê¸°
        function closeQuickWeightInput() {
            document.getElementById('quickWeightInputModal').style.display = 'none';
            document.getElementById('quickWeightInput').value = '';
        }

        // ë¹ ë¥¸ ì²´ì¤‘ ì €ì¥
        async function saveQuickWeight() {
            const weight = parseFloat(document.getElementById('quickWeightInput').value);

            if (!weight || weight <= 0) {
                alert('ì˜¬ë°”ë¥¸ ì²´ì¤‘ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // ë‚ ì§œë§Œ ì €ì¥ (ì‹œê°„ ì œê±°)
                
                await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs').add({
                        weight: weight,
                        date: firebase.firestore.Timestamp.fromDate(today),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                showToast('âœ… ì²´ì¤‘ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeQuickWeightInput();
                
                // ğŸ”¥ v3.9.3: í™ˆ íƒ­ ë° ëª¨ë“  íƒ­ ì¦‰ì‹œ ë™ê¸°í™”
                await loadHomeTab(); // í™ˆ íƒ­ ìƒˆë¡œê³ ì¹¨
                
                // ë‹¨ì‹ íƒ­ë„ ë™ê¸°í™” (ì²´ì¤‘ ë³€í™” í‘œì‹œ)
                if (document.getElementById('tab-fasting')) {
                    await loadFastingTab();
                }

            } catch (error) {
                console.error('ì²´ì¤‘ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ==================== ğŸ”¥ v3.9.1: ìš´ë™ ì¹¼ë¡œë¦¬ AI ë¶„ì„ ====================
        
        let currentExerciseData = null; // í˜„ì¬ ë¶„ì„ëœ ìš´ë™ ë°ì´í„°

        // ìš´ë™ ì¹¼ë¡œë¦¬ AI ë¶„ì„
        async function analyzeExercise() {
            const exerciseType = document.getElementById('exerciseType').value.trim();
            const duration = parseInt(document.getElementById('exerciseDuration').value);

            if (!exerciseType) {
                alert('ìš´ë™ ì¢…ë¥˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!duration || duration <= 0) {
                alert('ìš´ë™ ì‹œê°„ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                console.log(`ğŸ’ª [ìš´ë™ ë¶„ì„] ì‹œì‘: ${exerciseType} ${duration}ë¶„`);

                // ì‚¬ìš©ì ì²´ì¤‘ ê°€ì ¸ì˜¤ê¸°
                const currentWeight = currentProfile?.currentWeight || currentProfile?.startWeight || 70;

                const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ìš´ë™ ìƒë¦¬í•™ìì´ì í”¼íŠ¸ë‹ˆìŠ¤ ì½”ì¹˜ì…ë‹ˆë‹¤.

**ì‚¬ìš©ì ì •ë³´:**
- ì²´ì¤‘: ${currentWeight}kg
- ìš´ë™: ${exerciseType}
- ì‹œê°„: ${duration}ë¶„

**ë¶„ì„ ìš”ì²­:**
1. ì´ ìš´ë™ì˜ í‰ê·  ì†Œëª¨ ì¹¼ë¡œë¦¬ ê³„ì‚° (ì²´ì¤‘ê³¼ ì‹œê°„ ê³ ë ¤)
2. ìš´ë™ ê°•ë„ í‰ê°€ (ì €ê°•ë„/ì¤‘ê°•ë„/ê³ ê°•ë„)
3. ìš´ë™ íš¨ê³¼ì— ëŒ€í•œ ì „ë¬¸ê°€ ì¡°ì–¸ (50ì ì´ë‚´)

**MET (Metabolic Equivalent) ì°¸ê³ ê°’:**
- ê±·ê¸°: 3.5 MET
- ë¹ ë¥´ê²Œ ê±·ê¸°: 4.5 MET
- ì¡°ê¹…: 6.0 MET
- ëŸ¬ë‹ (8km/h): 8.0 MET
- ëŸ¬ë‹ (12km/h): 12.0 MET
- ìˆ˜ì˜ (ììœ í˜•, ì¤‘ê°•ë„): 8.0 MET
- ìì „ê±° (í‰ì§€, ì¤‘ê°•ë„): 6.8 MET
- ìì „ê±° (ì˜¤ë¥´ë§‰): 10.0 MET
- íƒêµ¬: 4.0 MET
- ë°°ë“œë¯¼í„´: 5.5 MET
- í…Œë‹ˆìŠ¤: 7.3 MET
- ì¶•êµ¬: 10.0 MET
- ë†êµ¬: 6.5 MET
- ìš”ê°€: 2.5 MET
- í•„ë¼í…ŒìŠ¤: 3.0 MET
- ì›¨ì´íŠ¸ íŠ¸ë ˆì´ë‹ (ì¤‘ê°•ë„): 5.0 MET
- ì›¨ì´íŠ¸ íŠ¸ë ˆì´ë‹ (ê³ ê°•ë„): 6.0 MET
- ì¤„ë„˜ê¸°: 12.0 MET
- ë“±ì‚°: 7.0 MET
- ê³„ë‹¨ ì˜¤ë¥´ê¸°: 8.0 MET

**ì¹¼ë¡œë¦¬ ê³„ì‚° ê³µì‹:**
ì†Œëª¨ ì¹¼ë¡œë¦¬ = MET Ã— ì²´ì¤‘(kg) Ã— ì‹œê°„(ì‹œê°„) Ã— 1.05

**í•„ìˆ˜ ì¶œë ¥ í˜•ì‹ (JSONë§Œ ì¶œë ¥):**
{
  "calories": ì†Œëª¨ ì¹¼ë¡œë¦¬ (ì •ìˆ˜),
  "intensity": "ì €ê°•ë„" ë˜ëŠ” "ì¤‘ê°•ë„" ë˜ëŠ” "ê³ ê°•ë„",
  "met": MET ê°’ (ì†Œìˆ˜ì  1ìë¦¬),
  "advice": "50ì ì´ë‚´ì˜ ì „ë¬¸ê°€ ì¡°ì–¸ (ìš´ë™ íš¨ê³¼, ì£¼ì˜ì‚¬í•­, ì¶”ì²œ ì‚¬í•­ í¬í•¨)"
}

**ì¤‘ìš”:** JSONë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€. ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì‚¬ìš© ê¸ˆì§€.`;

                const responseText = await callGeminiAPI(prompt);
                console.log('ğŸ¤– [Gemini API ì‘ë‹µ]:', responseText);

                // JSON íŒŒì‹±
                let jsonText = responseText.trim();
                const codeBlockMatch = jsonText.match(/```json\s*([\s\S]*?)\s*```/);
                if (codeBlockMatch) {
                    jsonText = codeBlockMatch[1];
                } else {
                    const plainCodeMatch = jsonText.match(/```\s*([\s\S]*?)\s*```/);
                    if (plainCodeMatch) {
                        jsonText = plainCodeMatch[1];
                    }
                }

                const exerciseData = JSON.parse(jsonText);
                
                // í˜„ì¬ ìš´ë™ ë°ì´í„° ì €ì¥
                currentExerciseData = {
                    type: exerciseType,
                    duration: duration,
                    calories: exerciseData.calories || 0,
                    intensity: exerciseData.intensity || 'ì¤‘ê°•ë„',
                    met: exerciseData.met || 5.0,
                    advice: exerciseData.advice || 'ì¢‹ì€ ìš´ë™ì…ë‹ˆë‹¤!',
                    timestamp: new Date().toISOString()
                };

                // ğŸ”¥ ê³¼í•™ì  ë¶„ì„ ìƒì„±
                const age = currentProfile?.age || 30;
                const height = currentProfile?.height || 170;
                const gender = currentProfile?.gender || 'male';
                const goalWeight = currentProfile?.goalWeight || currentWeight;
                const weightToLose = currentWeight - goalWeight;
                
                let scientificAnalysis = `
                    ğŸ“Š <strong>ê³¼í•™ì  ë°ì´í„° íŒ©íŠ¸</strong><br>
                    â€¢ í˜„ì¬ ì²´ì¤‘: ${currentWeight.toFixed(1)}kg â†’ ëª©í‘œ ì²´ì¤‘: ${goalWeight.toFixed(1)}kg<br>
                    â€¢ ${weightToLose > 0 ? `ê°ëŸ‰ ëª©í‘œ: ${weightToLose.toFixed(1)}kg` : `í˜„ì¬ ëª©í‘œ ì²´ì¤‘ ë‹¬ì„±!`}<br>
                    â€¢ MET ê°’: ${currentExerciseData.met.toFixed(1)} (${currentExerciseData.intensity})<br>
                    â€¢ ì¹¼ë¡œë¦¬ ê³„ì‚°: ${currentExerciseData.met.toFixed(1)} Ã— ${currentWeight.toFixed(1)}kg Ã— ${(duration / 60).toFixed(2)}h Ã— 1.05 = ${currentExerciseData.calories}kcal
                `;
                
                if (weightToLose > 0) {
                    const exercisesNeeded = Math.ceil((weightToLose * 7700) / currentExerciseData.calories);
                    scientificAnalysis += `<br>â€¢ ğŸ’¡ <strong>1kg ê°ëŸ‰ = 7,700kcal ì†Œëª¨ í•„ìš”</strong><br>`;
                    scientificAnalysis += `  ëª©í‘œ ë‹¬ì„±ê¹Œì§€ ì´ ìš´ë™ ì•½ ${exercisesNeeded}íšŒ í•„ìš”!`;
                }

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('exerciseCaloriesResult').textContent = `${currentExerciseData.calories} kcal`;
                document.getElementById('exerciseScientificAnalysis').innerHTML = scientificAnalysis;
                document.getElementById('exerciseAdvice').textContent = currentExerciseData.advice;
                document.getElementById('exerciseAnalysisResult').style.display = 'block';

                console.log('âœ… [ìš´ë™ ë¶„ì„ ì„±ê³µ]:', currentExerciseData);

            } catch (error) {
                console.error('âŒ [ìš´ë™ ë¶„ì„ ì‹¤íŒ¨]:', error);
                alert('ìš´ë™ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\nì˜¤ë¥˜: ' + error.message);
            }
        }

        // ìš´ë™ ê¸°ë¡ ì €ì¥
        async function saveExerciseRecord() {
            if (!currentExerciseData) {
                alert('ë¨¼ì € ìš´ë™ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const today = new Date();
                const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                // Firestoreì— ì €ì¥
                await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('exercises').add({
                        type: currentExerciseData.type,
                        duration: currentExerciseData.duration,
                        calories: currentExerciseData.calories,
                        intensity: currentExerciseData.intensity,
                        met: currentExerciseData.met,
                        date: dateStr,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                console.log('âœ… ìš´ë™ ê¸°ë¡ ì €ì¥ ì™„ë£Œ');
                
                // UI ì´ˆê¸°í™”
                document.getElementById('exerciseType').value = '';
                document.getElementById('exerciseDuration').value = '';
                document.getElementById('exerciseAnalysisResult').style.display = 'none';
                currentExerciseData = null;

                showToast('âœ… ìš´ë™ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');

                // ğŸ”¥ v3.9.3: ëª¨ë“  íƒ­ ì¦‰ì‹œ ê°±ì‹  (Firestore ë°˜ì˜ ëŒ€ê¸° ë° ì¬ì‹œë„)
                let retryCount = 0;
                const maxRetries = 3;
                
                const refreshData = async () => {
                    try {
                        await loadTodayExercises(); // ì˜¤ëŠ˜ì˜ ìš´ë™ ê¸°ë¡
                        await loadWeeklyExerciseStats(); // ì£¼ê°„ í†µê³„ ì°¨íŠ¸
                        
                        // ë°ì´í„°ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                        const totalCalories = document.getElementById('totalExerciseCalories')?.textContent || '0 kcal';
                        const totalTime = document.getElementById('totalExerciseTime')?.textContent || '0ë¶„';
                        
                        // ë°ì´í„°ê°€ ì—¬ì „íˆ 0ì´ë©´ ì¬ì‹œë„
                        if (retryCount < maxRetries && (totalCalories === '0 kcal' || totalTime === '0ë¶„')) {
                            retryCount++;
                            setTimeout(refreshData, 1000 * retryCount); // ì¬ì‹œë„ ê°„ê²© ì¦ê°€
                        } else {
                            // ìº˜ë¦°ë”ì—ë„ ìë™ ë°˜ì˜
                            if (typeof renderCalendar === 'function') {
                                renderCalendar();
                            }
                        }
                    } catch (error) {
                        console.error('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                        if (retryCount < maxRetries) {
                            retryCount++;
                            setTimeout(refreshData, 1000 * retryCount);
                        }
                    }
                };
                
                setTimeout(refreshData, 800); // ì´ˆê¸° ì§€ì—°

            } catch (error) {
                console.error('âŒ ìš´ë™ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì˜¤ëŠ˜ì˜ ìš´ë™ ê¸°ë¡ ë¡œë“œ
        async function loadTodayExercises() {
            try {
                const today = new Date();
                const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                const exercises = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('exercises')
                    .where('date', '==', dateStr)
                    .get();

                const listContainer = document.getElementById('todayExerciseList');
                
                if (exercises.empty) {
                    listContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 30px;">ì•„ì§ ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                    document.getElementById('totalExerciseTime').textContent = '0ë¶„';
                    document.getElementById('totalExerciseCalories').textContent = '0 kcal';
                    return;
                }

                let totalTime = 0;
                let totalCalories = 0;
                let html = '';

                // ì‹œê°„ìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
                const exercisesArray = [];
                exercises.forEach(doc => {
                    exercisesArray.push({ id: doc.id, ...doc.data() });
                });
                exercisesArray.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return timeB - timeA; // ìµœì‹ ìˆœ
                });

                exercisesArray.forEach(exercise => {
                    const data = exercise;
                    totalTime += data.duration;
                    totalCalories += data.calories;

                    const intensityColor = data.intensity === 'ê³ ê°•ë„' ? '#ef4444' : (data.intensity === 'ì¤‘ê°•ë„' ? '#f59e0b' : '#10b981');
                    const intensityBg = data.intensity === 'ê³ ê°•ë„' ? 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)' : (data.intensity === 'ì¤‘ê°•ë„' ? 'linear-gradient(135deg, #feca57 0%, #ff9ff3 100%)' : 'linear-gradient(135deg, #48dbfb 0%, #0abde3 100%)');
                    const intensityEmoji = data.intensity === 'ê³ ê°•ë„' ? 'ğŸ”¥' : (data.intensity === 'ì¤‘ê°•ë„' ? 'ğŸ’ª' : 'âœ¨');
                    const exerciseEmoji = data.type.includes('ëŸ°ë‹') || data.type.includes('ë‹¬ë¦¬ê¸°') ? 'ğŸƒ' : 
                                         data.type.includes('ìì „ê±°') ? 'ğŸš´' : 
                                         data.type.includes('ìˆ˜ì˜') ? 'ğŸŠ' : 
                                         data.type.includes('íƒêµ¬') ? 'ğŸ“' : 
                                         data.type.includes('í…Œë‹ˆìŠ¤') ? 'ğŸ¾' : 
                                         data.type.includes('ì¶•êµ¬') ? 'âš½' : 
                                         data.type.includes('ë†êµ¬') ? 'ğŸ€' : 
                                         data.type.includes('ê±·ê¸°') ? 'ğŸš¶' : 'ğŸ’ª';

                    html += `
                        <div style="padding: 18px; background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%); border: 2px solid #e8ecf5; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.08); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.08)';">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="font-size: 1.8rem;">${exerciseEmoji}</span>
                                        <div>
                                            <div style="font-weight: 700; color: #2d3748; font-size: 1.1rem; margin-bottom: 4px;">${data.type}</div>
                                            <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                                                <span style="font-size: 0.9rem; color: #718096; font-weight: 500;">â±ï¸ ${data.duration}ë¶„</span>
                                                <span style="padding: 4px 10px; background: ${intensityBg}; color: white; border-radius: 12px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                                                    ${intensityEmoji} ${data.intensity}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; color: #667eea; font-size: 1.5rem; margin-bottom: 4px;">-${data.calories}</div>
                                    <div style="font-size: 0.75rem; color: #a0aec0; font-weight: 500;">kcal</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e8ecf5;">
                                <button onclick="editExercise('${exercise.id}', '${data.type}', ${data.duration})" 
                                        style="flex: 1; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);" 
                                        onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';" 
                                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)';">
                                    âœï¸ ìˆ˜ì •
                                </button>
                                <button onclick="deleteExercise('${exercise.id}')" 
                                        style="flex: 1; padding: 10px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);" 
                                        onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(255, 107, 107, 0.4)';" 
                                        onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(255, 107, 107, 0.3)';">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    `;
                });

                listContainer.innerHTML = html;
                document.getElementById('totalExerciseTime').textContent = `${totalTime}ë¶„`;
                document.getElementById('totalExerciseCalories').textContent = `${totalCalories} kcal`;

                // ğŸ”¥ v3.9.3: ì¼ì¼ ê¶Œì¥ ìš´ë™ ì¹¼ë¡œë¦¬ + ëª©í‘œ ëŒ€ë¹„ í”¼ë“œë°±
                const currentWeight = currentProfile?.currentWeight || currentProfile?.startWeight || 70;
                const goalWeight = currentProfile?.goalWeight || currentWeight;
                const targetCalories = currentProfile?.calculatedCalories || 1620;
                const weightToLose = currentWeight - goalWeight;
                
                // ğŸ”¬ ê³¼í•™ì  ê¸°ì¤€ì— ë”°ë¥¸ ì¼ì¼ ê¶Œì¥ ìš´ë™ ì¹¼ë¡œë¦¬ ê³„ì‚°
                // ê¸°ì¤€ 1: WHO/ACSM ê¶Œì¥ì‚¬í•­ (ì£¼ë‹¹ 150ë¶„ ì¤‘ê°•ë„ = ì£¼ë‹¹ ì•½ 1,050-1,400kcal, ì¼ì¼ ì•½ 150-200kcal)
                // ê¸°ì¤€ 2: ì²´ì¤‘ ê°ëŸ‰ ëª©í‘œ (ì£¼ë‹¹ 0.5kg ê°ëŸ‰ = ì£¼ë‹¹ 3,850kcal, ì¼ì¼ ì•½ 550kcal)
                // ê¸°ì¤€ 3: ê°œì¸ ì²´ì¤‘ ê³ ë ¤ (ì¤‘ê°•ë„ ìš´ë™: ì²´ì¤‘ 1kgë‹¹ ì‹œê°„ë‹¹ ì•½ 5-7kcal)
                
                let recommendedExerciseCalories;
                
                if (weightToLose > 0) {
                    // ì²´ì¤‘ ê°ëŸ‰ ëª©í‘œê°€ ìˆëŠ” ê²½ìš°
                    // ì£¼ë‹¹ ê°ëŸ‰ ëª©í‘œ ê³„ì‚° (í˜„ì‹¤ì ì¸ ëª©í‘œ: ì£¼ë‹¹ 0.5-1kg)
                    const weeklyGoalKg = Math.min(weightToLose / 10, 1.0); // ìµœëŒ€ ì£¼ë‹¹ 1kg
                    const weeklyCaloriesNeeded = weeklyGoalKg * 3850; // ì£¼ë‹¹ í•„ìš” ì¹¼ë¡œë¦¬ (0.5kg = 3,850kcal)
                    recommendedExerciseCalories = Math.round(weeklyCaloriesNeeded / 7); // ì¼ì¼ ê¶Œì¥
                    
                    // ìµœì†Œê°’ ë³´ì¥ (ê±´ê°• ìœ ì§€ ê¸°ì¤€)
                    const minCalories = Math.round(currentWeight * 2.5); // ì²´ì¤‘ Ã— 2.5 (ìµœì†Œ ê±´ê°• ìœ ì§€)
                    recommendedExerciseCalories = Math.max(recommendedExerciseCalories, minCalories);
                    
                    // ìµœëŒ€ê°’ ì œí•œ (ì•ˆì „í•œ ë²”ìœ„)
                    const maxCalories = Math.round(currentWeight * 12); // ì²´ì¤‘ Ã— 12 (ìµœëŒ€ ì•ˆì „ ë²”ìœ„)
                    recommendedExerciseCalories = Math.min(recommendedExerciseCalories, maxCalories);
                } else {
                    // ì²´ì¤‘ ìœ ì§€ ëª©í‘œì¸ ê²½ìš° (WHO/ACSM ê¶Œì¥ì‚¬í•­)
                    // ì¤‘ê°•ë„ ìš´ë™ 30ë¶„ ê¸°ì¤€: ì²´ì¤‘ Ã— 5-7kcal Ã— 0.5ì‹œê°„
                    recommendedExerciseCalories = Math.round(currentWeight * 3); // ì•½ 150-250kcal (ì²´ì¤‘ 50-80kg ê¸°ì¤€)
                }
                
                const caloriesDifference = totalCalories - recommendedExerciseCalories;
                
                let feedbackEmoji = '';
                let feedbackText = '';
                let foodEquivalent = '';
                
                if (caloriesDifference >= 0) {
                    // ëª©í‘œ ë‹¬ì„± ë˜ëŠ” ì´ˆê³¼
                    feedbackEmoji = 'ğŸ‰';
                    feedbackText = `<strong style="color: #ffd700; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">ëª©í‘œ ë‹¬ì„±!</strong> ê¶Œì¥ëŸ‰ë³´ë‹¤ ${Math.abs(caloriesDifference)} kcal ë” ì†Œëª¨í–ˆì–´ìš”!`;
                    
                    // ìŒì‹ ë“±ê°€ë¬¼ (ì´ˆê³¼ ì†Œëª¨í•œ ì¹¼ë¡œë¦¬ ê¸°ì¤€)
                    if (caloriesDifference >= 550) {
                        foodEquivalent = 'ë¹…ë§¥ ì„¸íŠ¸ 1ê°œë¶„ ì¶”ê°€ ì†Œëª¨! ğŸ”';
                    } else if (caloriesDifference >= 300) {
                        foodEquivalent = 'ì¹˜í‚¨ 2ì¡°ê°ë¶„ ì¶”ê°€ ì†Œëª¨! ğŸ—';
                    } else if (caloriesDifference >= 150) {
                        foodEquivalent = 'ì´ˆì½”íŒŒì´ 2ê°œë¶„ ì¶”ê°€ ì†Œëª¨! ğŸ«';
                    } else if (caloriesDifference >= 50) {
                        foodEquivalent = 'ì‚¬íƒ• 10ê°œë¶„ ì¶”ê°€ ì†Œëª¨! ğŸ¬';
                    } else {
                        foodEquivalent = 'ëª©í‘œ ë”± ë§ì¶¤! ì™„ë²½í•´ìš”! ğŸ‘';
                    }
                } else {
                    // ëª©í‘œ ë¯¸ë‹¬ì„±
                    feedbackEmoji = 'ğŸ’ª';
                    feedbackText = `<strong style="color: #ffd700; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">ì¡°ê¸ˆ ë” í˜ë‚´ì„¸ìš”!</strong> ê¶Œì¥ëŸ‰ê¹Œì§€ ${Math.abs(caloriesDifference)} kcal ë‚¨ì•˜ì–´ìš”.`;
                    
                    // ê¶Œì¥ í™œë™ (ë¶€ì¡±í•œ ì¹¼ë¡œë¦¬ ê¸°ì¤€)
                    const deficit = Math.abs(caloriesDifference);
                    if (deficit >= 400) {
                        foodEquivalent = 'ì¡°ê¹… 40ë¶„ì´ë©´ ë‹¬ì„± ê°€ëŠ¥! ğŸƒ';
                    } else if (deficit >= 200) {
                        foodEquivalent = 'ë¹ ë¥´ê²Œ ê±·ê¸° 30ë¶„ì´ë©´ ë‹¬ì„± ê°€ëŠ¥! ğŸš¶';
                    } else if (deficit >= 100) {
                        foodEquivalent = 'ê³„ë‹¨ ì˜¤ë¥´ê¸° 15ë¶„ì´ë©´ ë‹¬ì„± ê°€ëŠ¥! ğŸªœ';
                    } else {
                        foodEquivalent = 'ìŠ¤íŠ¸ë ˆì¹­ 10ë¶„ì´ë©´ ë‹¬ì„± ê°€ëŠ¥! ğŸ§˜';
                    }
                }
                
                // ê¶Œì¥ ì¹¼ë¡œë¦¬ ê¸°ì¤€ ì„¤ëª…
                let recommendationNote = '';
                if (weightToLose > 0) {
                    const weeklyGoal = Math.min(weightToLose / 10, 1.0);
                    recommendationNote = `(ì£¼ë‹¹ ${(weeklyGoal * 1000).toFixed(0)}g ê°ëŸ‰ ëª©í‘œ ê¸°ì¤€)`;
                } else {
                    recommendationNote = `(WHO/ACSM ê±´ê°• ìœ ì§€ ê¸°ì¤€)`;
                }
                
                let dailyAnalysis = `
                    <div style="color: #ffffff;">
                        ğŸ“Š <strong style="color: #ffffff; font-size: 1.05rem;">ì˜¤ëŠ˜ì˜ ìš´ë™ ë¶„ì„</strong><br><br>
                        â€¢ ì˜¤ëŠ˜ ì´ ìš´ë™: <strong style="color: #ffd700;">${totalTime}ë¶„</strong><br>
                        â€¢ ì´ ì†Œëª¨ ì¹¼ë¡œë¦¬: <strong style="color: #ffd700; font-size: 1.1rem;">${totalCalories} kcal</strong><br>
                        â€¢ ì¼ì¼ ê¶Œì¥ ìš´ë™: <strong style="color: #a8e6cf;">${recommendedExerciseCalories} kcal</strong> <span style="font-size: 0.8rem; opacity: 0.9;">${recommendationNote}</span><br><br>
                        
                        ${feedbackEmoji} ${feedbackText}<br>
                        ğŸ’¡ <span style="color: #ffffff;">${foodEquivalent}</span><br><br>
                    </div>
                `;
                
                if (weightToLose > 0) {
                    const totalCaloriesNeeded = weightToLose * 7700;
                    const progressPercent = ((totalCalories / totalCaloriesNeeded) * 100).toFixed(2);
                    dailyAnalysis += `
                        <div style="color: #ffffff;">
                            ğŸ¯ <strong style="color: #ffffff;">ëª©í‘œê¹Œì§€ ì–¼ë§ˆë‚˜?</strong><br>
                            â€¢ ëª©í‘œ ${weightToLose.toFixed(1)}kg ê°ëŸ‰: <strong style="color: #ffd700;">${totalCaloriesNeeded.toLocaleString()} kcal</strong> í•„ìš”<br>
                            â€¢ ì˜¤ëŠ˜ ìš´ë™ ê¸°ì—¬ë„: <strong style="color: #a8e6cf; font-size: 1.05rem;">${progressPercent}%</strong><br><br>
                        </div>
                    `;
                }
                
                dailyAnalysis += `
                    <div style="color: #ffffff;">
                        ğŸ”¥ <strong style="color: #ffffff;">ì‹ë‹¨ + ìš´ë™ = ì„±ê³µ!</strong><br>
                        ìš´ë™ì€ ì¹¼ë¡œë¦¬ ì†Œëª¨ë¿ ì•„ë‹ˆë¼ ê·¼ìœ¡ëŸ‰ ì¦ê°€ë¡œ<br>
                        ê¸°ì´ˆëŒ€ì‚¬ëŸ‰(BMR)ì„ ë†’ì—¬ ì¥ê¸°ì  ë‹¤ì´ì–´íŠ¸ì— íš¨ê³¼ì !
                    </div>
                `;
                
                document.getElementById('dailyExerciseAnalysis').innerHTML = dailyAnalysis;

            } catch (error) {
                console.error('ìš´ë™ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ìš´ë™ ê¸°ë¡ ì‚­ì œ
        async function deleteExercise(exerciseId) {
            if (!confirm('ì´ ìš´ë™ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('exercises').doc(exerciseId)
                    .delete();

                showToast('ìš´ë™ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // ğŸ”¥ v3.9.3: ëª¨ë“  íƒ­ ì¦‰ì‹œ ê°±ì‹ 
                await loadTodayExercises();
                await loadWeeklyExerciseStats();
                
                if (typeof renderCalendar === 'function') {
                    renderCalendar();
                }

            } catch (error) {
                console.error('ìš´ë™ ê¸°ë¡ ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìš´ë™ í¼ì— ì¶”ì²œ ìš´ë™ ìë™ ì…ë ¥
        function fillExerciseForm(type, duration) {
            document.getElementById('exerciseType').value = type;
            document.getElementById('exerciseDuration').value = duration;
            
            // ì…ë ¥ í•„ë“œë¡œ ìŠ¤í¬ë¡¤
            document.getElementById('exerciseType').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ğŸ”¥ v3.9.3: ìš´ë™ ê¸°ë¡ ìˆ˜ì •
        let currentEditingExerciseId = null;
        
        async function editExercise(exerciseId, type, duration) {
            // í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
            currentEditingExerciseId = exerciseId;
            
            const newDuration = prompt(`ìš´ë™ ì‹œê°„ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš” (í˜„ì¬: ${duration}ë¶„)`, duration);
            
            if (!newDuration || newDuration <= 0) {
                alert('ìœ íš¨í•œ ìš´ë™ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                currentEditingExerciseId = null;
                return;
            }
            
            try {
                // ìƒˆë¡œìš´ ì¹¼ë¡œë¦¬ ì¬ê³„ì‚°
                showToast('â³ ì¹¼ë¡œë¦¬ ì¬ê³„ì‚° ì¤‘...');
                
                const currentWeight = currentProfile?.currentWeight || currentProfile?.startWeight || 70;
                
                // Gemini APIë¡œ ìš´ë™ ì¹¼ë¡œë¦¬ ì¬ê³„ì‚°
                const prompt = `ë‹¤ìŒ ìš´ë™ì˜ ì¹¼ë¡œë¦¬ë¥¼ ì •í™•íˆ ê³„ì‚°í•´ì£¼ì„¸ìš”.
                
ì‚¬ìš©ì ì •ë³´:
- ì²´ì¤‘: ${currentWeight}kg
- ìš´ë™ ì¢…ë¥˜: ${type}
- ìš´ë™ ì‹œê°„: ${newDuration}ë¶„

ë‹¤ìŒ MET ê°’ì„ ì°¸ê³ í•˜ì—¬ ê³„ì‚°í•˜ì„¸ìš”:
ê±·ê¸°(ëŠë¦¬ê²Œ): 3.0, ê±·ê¸°(ë³´í†µ): 3.5, ê±·ê¸°(ë¹ ë¥´ê²Œ): 4.5, ì¡°ê¹…: 7.0, ë‹¬ë¦¬ê¸°: 9.0, 
ìì „ê±°(ëŠë¦¬ê²Œ): 4.0, ìì „ê±°(ë³´í†µ): 6.8, ìì „ê±°(ë¹ ë¥´ê²Œ): 10.0,
ìˆ˜ì˜(ë³´í†µ): 6.0, ìˆ˜ì˜(ë¹ ë¥´ê²Œ): 9.0, ë“±ì‚°: 7.0, ê³„ë‹¨ ì˜¤ë¥´ê¸°: 8.0,
í—¬ìŠ¤(ì›¨ì´íŠ¸): 6.0, ìš”ê°€: 3.0, í•„ë¼í…ŒìŠ¤: 3.5, ìŠ¤íŠ¸ë ˆì¹­: 2.5,
ì¶•êµ¬: 7.0, ë†êµ¬: 6.5, ë°°ë“œë¯¼í„´: 5.5, íƒêµ¬: 4.0, í…Œë‹ˆìŠ¤: 7.0,
ì¤„ë„˜ê¸°: 10.0, ëŒ„ìŠ¤: 5.0, ì—ì–´ë¡œë¹…: 7.0, ì²­ì†Œ: 3.5, ê³„ë‹¨ ì²­ì†Œ: 4.0, ë…¸ë˜: 2.0

ì¹¼ë¡œë¦¬ ê³„ì‚° ê³µì‹: calories = MET Ã— weight(kg) Ã— time(hours) Ã— 1.05

ê°•ë„ ê¸°ì¤€:
- ì €ê°•ë„: MET 2.0~4.0
- ì¤‘ê°•ë„: MET 4.0~7.0  
- ê³ ê°•ë„: MET 7.0 ì´ìƒ

JSON í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥:
{
  "calories": ê³„ì‚°ëœ ì¹¼ë¡œë¦¬ (ì •ìˆ˜),
  "intensity": "ì €ê°•ë„" ë˜ëŠ” "ì¤‘ê°•ë„" ë˜ëŠ” "ê³ ê°•ë„",
  "met": MET ê°’ (ì†Œìˆ˜ì  1ìë¦¬),
  "advice": "ì‹¤ìš©ì ì¸ ì¡°ì–¸ (30ì ì´ë‚´)"
}`;

                const response = await callGeminiAPI(prompt);
                const cleanResponse = response.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const analysisData = JSON.parse(cleanResponse);
                
                // Firestore ì—…ë°ì´íŠ¸
                await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('exercises').doc(exerciseId)
                    .update({
                        duration: parseInt(newDuration),
                        calories: analysisData.calories,
                        intensity: analysisData.intensity,
                        met: analysisData.met
                    });
                
                showToast(`âœ… ìš´ë™ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! (${newDuration}ë¶„ / ${analysisData.calories} kcal)`);
                
                currentEditingExerciseId = null;
                
                // ì¦‰ì‹œ ê°±ì‹  (Firestore ë°˜ì˜ ëŒ€ê¸° ë° ì¬ì‹œë„)
                let retryCount = 0;
                const maxRetries = 3;
                
                const refreshData = async () => {
                    try {
                        await loadTodayExercises();
                        await loadWeeklyExerciseStats();
                        
                        if (typeof renderCalendar === 'function') {
                            renderCalendar();
                        }
                    } catch (error) {
                        console.error('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                        if (retryCount < maxRetries) {
                            retryCount++;
                            setTimeout(refreshData, 1000 * retryCount);
                        }
                    }
                };
                
                setTimeout(refreshData, 800);
                
            } catch (error) {
                console.error('âŒ ìš´ë™ ê¸°ë¡ ìˆ˜ì • ì‹¤íŒ¨:', error);
                alert('ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                currentEditingExerciseId = null;
            }
        }

        // ğŸ”¥ v3.9.3: ì£¼ê°„ ìš´ë™ í†µê³„ ì°¨íŠ¸
        let weeklyExerciseChart = null;
        
        async function loadWeeklyExerciseStats() {
            try {
                // ì˜¤ëŠ˜ë¶€í„° 6ì¼ ì „ê¹Œì§€ (ìµœê·¼ 7ì¼)
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 6);
                
                // ê° ë‚ ì§œë³„ ë°ì´í„° ìˆ˜ì§‘
                const dailyData = [];
                const labels = [];
                
                for (let i = 0; i < 7; i++) {
                    const targetDate = new Date(sevenDaysAgo);
                    targetDate.setDate(sevenDaysAgo.getDate() + i);
                    const dateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
                    
                    // ìš”ì¼ ë¼ë²¨ (ì˜ˆ: ì›”, í™”, ìˆ˜...)
                    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                    labels.push(dayNames[targetDate.getDay()]);
                    
                    // í•´ë‹¹ ë‚ ì§œì˜ ìš´ë™ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
                    const exercises = await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(currentUser.uid)
                        .collection('exercises')
                        .where('date', '==', dateStr)
                        .get();
                    
                    let dailyTime = 0;
                    let dailyCalories = 0;
                    
                    exercises.forEach(doc => {
                        const data = doc.data();
                        dailyTime += data.duration || 0;
                        dailyCalories += data.calories || 0;
                    });
                    
                    dailyData.push({
                        time: dailyTime,
                        calories: dailyCalories
                    });
                }
                
                // Chart.jsë¡œ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
                const canvas = document.getElementById('exerciseChart');
                const ctx = canvas.getContext('2d');
                
                // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
                if (weeklyExerciseChart) {
                    weeklyExerciseChart.destroy();
                }
                
                weeklyExerciseChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'ìš´ë™ ì‹œê°„ (ë¶„)',
                                data: dailyData.map(d => d.time),
                                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 2,
                                yAxisID: 'y-time'
                            },
                            {
                                label: 'ì†Œëª¨ ì¹¼ë¡œë¦¬ (kcal)',
                                data: dailyData.map(d => d.calories),
                                backgroundColor: 'rgba(244, 67, 54, 0.6)',
                                borderColor: 'rgba(244, 67, 54, 1)',
                                borderWidth: 2,
                                yAxisID: 'y-calories'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            'y-time': {
                                type: 'linear',
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'ì‹œê°„ (ë¶„)'
                                },
                                ticks: {
                                    beginAtZero: true
                                }
                            },
                            'y-calories': {
                                type: 'linear',
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'ì¹¼ë¡œë¦¬ (kcal)'
                                },
                                ticks: {
                                    beginAtZero: true
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
                
                // ì£¼ê°„ í‰ê·  ë° ì´ ì†Œëª¨ ê³„ì‚°
                const totalTime = dailyData.reduce((sum, d) => sum + d.time, 0);
                const totalCalories = dailyData.reduce((sum, d) => sum + d.calories, 0);
                const avgTime = Math.round(totalTime / 7);
                const avgCalories = Math.round(totalCalories / 7);
                
                document.getElementById('weeklyAvgTime').textContent = `${avgTime}ë¶„/ì¼`;
                if (document.getElementById('weeklyAvgCalories')) {
                    document.getElementById('weeklyAvgCalories').textContent = `${avgCalories} kcal/ì¼`;
                }
                // ì´ ì†Œëª¨ ì¹¼ë¡œë¦¬ ì—…ë°ì´íŠ¸
                if (document.getElementById('weeklyTotalCal')) {
                    document.getElementById('weeklyTotalCal').textContent = `${totalCalories} kcal`;
                }
                
                console.log('âœ… ì£¼ê°„ ìš´ë™ í†µê³„ ë¡œë“œ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ì£¼ê°„ ìš´ë™ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ==================== ğŸ”¥ v3.9.0: ìŒì‹ ê²€ìƒ‰ ë°ì´í„°ë² ì´ìŠ¤ (5ê°œ ì´ìƒ ë¸Œëœë“œ + íƒ„ë‹¨ì§€) ====================
        
        async function searchFoodDatabase(foodName) {
            if (!foodName || foodName.trim() === '') {
                console.warn('ìŒì‹ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                return [];
            }

            try {
                console.log(`ğŸ” [ìŒì‹ ê²€ìƒ‰] ì‹œì‘: "${foodName}"`);
                
                const prompt = `ë‹¹ì‹ ì€ í•œêµ­ ìŒì‹ ì˜ì–‘ ë°ì´í„°ë² ì´ìŠ¤ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
ì‚¬ìš©ìê°€ "${foodName}"ì„(ë¥¼) ê²€ìƒ‰í–ˆìŠµë‹ˆë‹¤.

**ê²€ìƒ‰ ê·œì¹™:**
1. ë¸Œëœë“œ ì œí’ˆì´ ìˆëŠ” ê²½ìš°: ìµœì†Œ 5ê°œ ì´ìƒì˜ ëŒ€í‘œ ë¸Œëœë“œ ì œí’ˆ ì •ë³´ ì œê³µ
2. ì¼ë°˜ ìŒì‹ì¸ ê²½ìš°: ìµœì†Œ 5ê°œ ì´ìƒì˜ ë‹¤ì–‘í•œ ì¢…ë¥˜/ì¡°ë¦¬ë²• ì œê³µ
3. ê°„ì‹/ê³¼ìì¸ ê²½ìš°: ìµœì†Œ 5ê°œ ì´ìƒì˜ ëŒ€í‘œ ì œí’ˆ ë¸Œëœë“œ ì œê³µ

**ì˜ˆì‹œ ì¶œë ¥:**
- "ë¼ë©´" ê²€ìƒ‰ ì‹œ â†’ ì‹ ë¼ë©´, ì§„ë¼ë©´, ë„ˆêµ¬ë¦¬, ì§œíŒŒê²Œí‹°, ì•ˆì„±íƒ•ë©´
- "ê°ìíƒ•" ê²€ìƒ‰ ì‹œ â†’ ëˆ„ë¦¬ë§ˆì„ ê°ìíƒ•, ë§›ë‚˜ê°ìíƒ•, ì¼ë°˜ ê°ìíƒ•, ë¼ˆí•´ì¥êµ­, ê°ìíƒ• ë°±ë°˜
- "ì´ˆì½”íŒŒì´" ê²€ìƒ‰ ì‹œ â†’ ì˜¤ë¦¬ì˜¨ ì´ˆì½”íŒŒì´, ë¡¯ë° ëª½ì‰˜, í•´íƒœ ì´ˆì½”ì¹©, í¬ë¼ìš´ ì´ˆì½”í•˜ì„, ë¹™ê·¸ë ˆ ì¿ ì•¤í¬
- "ê¹€ë°¥" ê²€ìƒ‰ ì‹œ â†’ ì°¸ì¹˜ê¹€ë°¥, ì•¼ì±„ê¹€ë°¥, ì¹˜ì¦ˆê¹€ë°¥, ì†Œê³ ê¸°ê¹€ë°¥, ê¹€ì¹˜ê¹€ë°¥
- "ìš°ìœ " ê²€ìƒ‰ ì‹œ â†’ ì„œìš¸ìš°ìœ , ë§¤ì¼ìš°ìœ , ìƒí•˜ëª©ì¥, ë¹™ê·¸ë ˆ ë°”ë‚˜ë‚˜ë§›ìš°ìœ , í‘¸ë¥´ë°€

**í•„ìˆ˜ ì¶œë ¥ í˜•ì‹ (JSON ë°°ì—´, ìµœì†Œ 5ê°œ ì´ìƒ):**
[
  {
    "brand": "êµ¬ì²´ì ì¸ ë¸Œëœë“œëª… ë˜ëŠ” ì¢…ë¥˜ (ì˜ˆ: ì˜¤ë¦¬ì˜¨ ì´ˆì½”íŒŒì´, ì°¸ì¹˜ê¹€ë°¥)",
    "calories": ì¹¼ë¡œë¦¬ (ì •ìˆ˜),
    "carbs": íƒ„ìˆ˜í™”ë¬¼ (ì†Œìˆ˜ì  1ìë¦¬),
    "protein": ë‹¨ë°±ì§ˆ (ì†Œìˆ˜ì  1ìë¦¬),
    "fat": ì§€ë°© (ì†Œìˆ˜ì  1ìë¦¬)
  }
]

**ì¤‘ìš”:**
- ë°˜ë“œì‹œ 5ê°œ ì´ìƒ í•­ëª© ì œê³µ
- brand í•„ë“œì— "undefined" ì‚¬ìš© ê¸ˆì§€
- ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ë¸Œëœë“œ/ì œí’ˆëª…ë§Œ ì‚¬ìš©
- JSON ë°°ì—´ë§Œ ì¶œë ¥ (ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ê¸ˆì§€)
- ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì‚¬ìš© ê¸ˆì§€`;

                const responseText = await callGeminiAPI(prompt);
                console.log('ğŸ¤– [Gemini API ì‘ë‹µ]:', responseText);

                // JSON íŒŒì‹± (ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°)
                let jsonText = responseText.trim();
                const codeBlockMatch = jsonText.match(/```json\s*([\s\S]*?)\s*```/);
                if (codeBlockMatch) {
                    jsonText = codeBlockMatch[1];
                } else {
                    const plainCodeMatch = jsonText.match(/```\s*([\s\S]*?)\s*```/);
                    if (plainCodeMatch) {
                        jsonText = plainCodeMatch[1];
                    }
                }

                const foodOptions = JSON.parse(jsonText);
                
                if (!Array.isArray(foodOptions)) {
                    throw new Error('ì‘ë‹µì´ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.');
                }

                if (foodOptions.length === 0) {
                    throw new Error('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }

                console.log(`âœ… [ìŒì‹ ê²€ìƒ‰ ì„±ê³µ] ${foodOptions.length}ê°œ í•­ëª© ë°˜í™˜:`, foodOptions);
                
                // UI ì—…ë°ì´íŠ¸
                displayFoodOptions(foodOptions);
                
                return foodOptions;

            } catch (error) {
                console.error('âŒ [ìŒì‹ ê²€ìƒ‰ ì‹¤íŒ¨]:', error);
                alert('ìŒì‹ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\nì˜¤ë¥˜: ' + error.message);
                return [];
            }
        }

        // ìŒì‹ ê²€ìƒ‰ ê²°ê³¼ UI í‘œì‹œ (íƒ„ë‹¨ì§€ í¬í•¨)
        function displayFoodOptions(foodOptions) {
            const container = document.getElementById('foodOptionsContainer');
            const resultsDiv = document.getElementById('foodSearchResults');
            
            if (!container || !resultsDiv) {
                console.warn('ìŒì‹ ê²€ìƒ‰ ê²°ê³¼ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            container.innerHTML = '';
            
            foodOptions.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.style.cssText = `
                    padding: 12px 15px;
                    background: white;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                
                optionDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 4px;">
                                ${option.brand || 'ì•Œ ìˆ˜ ì—†ìŒ'}
                            </div>
                            <div style="font-size: 0.85rem; color: #666;">
                                <span style="color: #3b82f6;">íƒ„ ${option.carbs || 0}g</span> | 
                                <span style="color: #22c55e;">ë‹¨ ${option.protein || 0}g</span> | 
                                <span style="color: #eab308;">ì§€ ${option.fat || 0}g</span>
                            </div>
                        </div>
                        <div style="font-weight: bold; color: #667eea; font-size: 1.1rem;">
                            ${option.calories || 0}kcal
                        </div>
                    </div>
                `;
                
                optionDiv.addEventListener('mouseenter', function() {
                    this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    this.style.borderColor = '#667eea';
                    this.style.color = 'white';
                    this.querySelectorAll('div').forEach(el => el.style.color = 'white');
                    this.querySelectorAll('span').forEach(el => el.style.color = 'white');
                });
                
                optionDiv.addEventListener('mouseleave', function() {
                    this.style.background = 'white';
                    this.style.borderColor = '#e5e7eb';
                    this.style.color = '#333';
                });
                
                optionDiv.addEventListener('click', function() {
                    selectFoodOption(option);
                });
                
                container.appendChild(optionDiv);
            });
            
            resultsDiv.style.display = 'block';
        }

        // ìŒì‹ ì˜µì…˜ ì„ íƒ (íƒ„ë‹¨ì§€ ìë™ ì…ë ¥)
        function selectFoodOption(option) {
            document.getElementById('mealFoodName').value = option.brand || 'ì•Œ ìˆ˜ ì—†ìŒ';
            document.getElementById('resultCalories').textContent = option.calories || 0;
            document.getElementById('resultCarbs').textContent = option.carbs || 0;
            document.getElementById('resultProtein').textContent = option.protein || 0;
            document.getElementById('resultFat').textContent = option.fat || 0;
            
            // ê²°ê³¼ ì˜ì—­ í‘œì‹œ
            const nutritionResult = document.getElementById('nutritionResult');
            if (nutritionResult) {
                nutritionResult.classList.add('show');
            }
            
            // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            document.getElementById('foodSearchResults').style.display = 'none';
            
            console.log('âœ… ìŒì‹ ì„ íƒ:', option);
        }

        // ==================== ì˜ì–‘ ëŒ€ì‹œë³´ë“œ í•¨ìˆ˜ ====================

        // ì˜ì–‘ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
        async function loadNutritionDashboard() {
            // ğŸ”¥ ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (loadTodayNutritionìœ¼ë¡œ ëŒ€ì²´)
            // Firebase ì¸ë±ìŠ¤ ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ë¹„í™œì„±í™”
            console.log('âš ï¸ loadNutritionDashboardëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        // ì˜ì–‘ ì°¨íŠ¸ ë Œë”ë§ (Chart.js)
        function renderNutritionChart(carbs, protein, fat) {
            const ctx = document.getElementById('nutritionChart');
            if (!ctx) return;

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (nutritionChart) {
                nutritionChart.destroy();
            }

            // ë°ì´í„°ê°€ ëª¨ë‘ 0ì´ë©´ ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ì§€ ì•ŠìŒ
            if (carbs === 0 && protein === 0 && fat === 0) {
                nutritionChart = null;
                return;
            }

            nutritionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['íƒ„ìˆ˜í™”ë¬¼', 'ë‹¨ë°±ì§ˆ', 'ì§€ë°©'],
                    datasets: [{
                        data: [carbs, protein, fat],
                        backgroundColor: [
                            '#a1c4fd',
                            '#fccb90',
                            '#e0c3fc'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + Math.round(context.parsed) + 'g';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ì˜ì–‘ ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
        async function refreshDashboardNutrition() {
            await loadNutritionDashboard();
        }

        // ========== Phase 1: ì‹¤ì‹œê°„ ì˜ì–‘ ì„­ì·¨ ê´€ë¦¬ í•¨ìˆ˜ ==========

        // ì‹ì‚¬ ì¶”ê°€ í•¨ìˆ˜
        function addMeal(category, foodName, nutrition) {
            if (!nutrition || typeof nutrition !== 'object') {
                console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ì˜ì–‘ ì •ë³´:', nutrition);
                return;
            }

            const meal = {
                category: category || 'ì‹ì‚¬',
                foodName: foodName || 'ìŒì‹',
                food: foodName || 'ìŒì‹', // ğŸ”¥ displayTodayMealsList í˜¸í™˜ì„±
                calories: parseFloat(nutrition.calories) || 0,
                carbs: parseFloat(nutrition.carbs) || 0,
                protein: parseFloat(nutrition.protein) || 0,
                fat: parseFloat(nutrition.fat) || 0,
                per100g: nutrition.per100g || null, // ğŸ”¥ 100gë‹¹ ì •ë³´ ì €ì¥
                timestamp: new Date().toISOString()
            };

            todayIntake.meals.push(meal);
            todayIntake.calories += meal.calories;
            todayIntake.carbs += meal.carbs;
            todayIntake.protein += meal.protein;
            todayIntake.fat += meal.fat;

            console.log(`âœ… ì‹ì‚¬ ì¶”ê°€ë¨: ${foodName} (${meal.calories}kcal)`);

            updateNutritionUI();
            checkCalorieOverage();

            // Firestoreì— ì €ì¥
            saveTodayNutritionToFirestore();

            // ========== Phase 1: ìº˜ë¦°ë” í†µí•© ==========
            saveToDailyLog(new Date(), 'nutrition', {
                foodName: foodName,
                calories: meal.calories,
                carbs: meal.carbs,
                protein: meal.protein,
                fat: meal.fat,
                timestamp: meal.timestamp
            });
            // ========================================
        }

        // ê¶Œì¥ ì„­ì·¨ëŸ‰ ìë™ ê³„ì‚° (Mifflin-St Jeor ê³µì‹)
        function calculateRecommendedIntake() {
            // ========== ìš°ì„ ìˆœìœ„ 1: Firebase ì €ì¥ëœ ê³¼í•™ì  ê³„ì‚° ê°’ (v3.3.0) ==========
            if (currentProfile && currentProfile.calculatedCalories) {
                console.log('ğŸ“Š ê³¼í•™ì  ê³„ì‚° ì¹¼ë¡œë¦¬ ì‚¬ìš©:', currentProfile.calculatedCalories);
                return {
                    calories: currentProfile.calculatedCalories,
                    carbs: currentProfile.calculatedMacros ? currentProfile.calculatedMacros.carbs : Math.round(currentProfile.calculatedCalories * 0.45 / 4),
                    protein: currentProfile.calculatedMacros ? currentProfile.calculatedMacros.protein : Math.round(currentProfile.calculatedCalories * 0.30 / 4),
                    fat: currentProfile.calculatedMacros ? currentProfile.calculatedMacros.fat : Math.round(currentProfile.calculatedCalories * 0.25 / 9)
                };
            }
            
            // ========== ìš°ì„ ìˆœìœ„ 2: localStorage ì €ì¥ëœ ê°’ ==========
            const storedCalories = parseInt(localStorage.getItem('goal_calories_target'));
            const storedCarbs = parseInt(localStorage.getItem('goal_carbs_target'));
            const storedProtein = parseInt(localStorage.getItem('goal_protein_target'));
            const storedFat = parseInt(localStorage.getItem('goal_fat_target'));
            
            if (storedCalories) {
                console.log('ğŸ’¾ localStorage ì¹¼ë¡œë¦¬ ì‚¬ìš©:', storedCalories);
                return {
                    calories: storedCalories,
                    carbs: storedCarbs || Math.round(storedCalories * 0.45 / 4),
                    protein: storedProtein || Math.round(storedCalories * 0.30 / 4),
                    fat: storedFat || Math.round(storedCalories * 0.25 / 9)
                };
            }
            
            // ========== ìš°ì„ ìˆœìœ„ 3: ì‹¤ì‹œê°„ ê³„ì‚° (í”„ë¡œí•„ ìˆì„ ë•Œ) ==========
            if (!currentProfile || !currentProfile.age || !currentProfile.height || !currentProfile.startWeight) {
                // í”„ë¡œí•„ ë¯¸ì…ë ¥ ì‹œ 0ìœ¼ë¡œ í‘œì‹œ
                console.warn('âš ï¸ í”„ë¡œí•„ ë¯¸ì…ë ¥, 0 í‘œì‹œ');
                return {
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0
                };
            }

            const { age, height, startWeight, goalWeight, gender, activityLevel, goal, targetDate } = currentProfile;
            const weight = startWeight;

            // ì£¼ê°„ ê°ëŸ‰ ëª©í‘œ ê³„ì‚°
            const weightDiff = startWeight - (goalWeight || startWeight);
            const daysRemaining = targetDate ? Math.max(1, Math.round((targetDate.toDate() - new Date()) / (1000 * 60 * 60 * 24))) : 90;
            const weeksRemaining = Math.max(1, daysRemaining / 7);
            const weeklyGoalKg = weightDiff / weeksRemaining;

            // ê³¼í•™ì  ì˜ì–‘ ê³„íš ìƒì„±
            const nutritionPlan = generateNutritionPlan({
                gender: gender,
                weight: weight,
                height: height,
                age: age,
                activityLevel: activityLevel || 'moderate',
                weeklyGoalKg: weeklyGoalKg,
                goal: goal || 'lose_weight'
            });

            console.log('ğŸ”¬ ì‹¤ì‹œê°„ ê³¼í•™ì  ê³„ì‚°:', nutritionPlan);
            
            return {
                calories: nutritionPlan.dailyCalories,
                carbs: nutritionPlan.macros.carbs,
                protein: nutritionPlan.macros.protein,
                fat: nutritionPlan.macros.fat
            };
        }

        // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateNutritionUI() {
            // ê¶Œì¥ ì„­ì·¨ëŸ‰ ê³„ì‚°
            const recommended = calculateRecommendedIntake();

            // ğŸ”¥ í”„ë¡œí•„ ë¯¸ì„¤ì • ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
            if (recommended.calories === 0) {
                document.getElementById('todayCalories').textContent = 'í”„ë¡œí•„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”';
                document.getElementById('todayCarbs').textContent = '-';
                document.getElementById('todayProtein').textContent = '-';
                document.getElementById('todayFat').textContent = '-';
                document.getElementById('remainingCalories').textContent = '';
                document.getElementById('remainingCarbs').textContent = '';
                document.getElementById('remainingProtein').textContent = '';
                document.getElementById('remainingFat').textContent = '';
                return; // ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ
            }

            // ì‹ì‚¬ íšŸìˆ˜ í‘œì‹œ
            document.getElementById('todayMealCount').textContent = todayIntake.meals.length;
            
            // ========== ì˜¤ëŠ˜ ë¨¹ì€ ìŒì‹ ëª©ë¡ í‘œì‹œ ==========
            displayTodayMealsList();
            display100gNutrition(); // ğŸ”¥ 100gë‹¹ ì˜ì–‘ì •ë³´ í‘œì‹œ
            // =============================================

            // ë‚¨ì€ ì„­ì·¨ëŸ‰ ê³„ì‚°
            const remainingCalories = recommended.calories - todayIntake.calories;
            const remainingCarbs = recommended.carbs - todayIntake.carbs;
            const remainingProtein = recommended.protein - todayIntake.protein;
            const remainingFat = recommended.fat - todayIntake.fat;

            // í˜„ì¬ ì„­ì·¨ëŸ‰ í‘œì‹œ (í˜•ì‹: "0 / 2400 kcal")
            document.getElementById('todayCalories').textContent = `${Math.round(todayIntake.calories)} / ${recommended.calories} kcal`;
            document.getElementById('todayCarbs').textContent = `${Math.round(todayIntake.carbs)} / ${recommended.carbs} g`;
            document.getElementById('todayProtein').textContent = `${Math.round(todayIntake.protein)} / ${recommended.protein} g`;
            document.getElementById('todayFat').textContent = `${Math.round(todayIntake.fat)} / ${recommended.fat} g`;

            const caloriesElem = document.getElementById('remainingCalories');
            const carbsElem = document.getElementById('remainingCarbs');
            const proteinElem = document.getElementById('remainingProtein');
            const fatElem = document.getElementById('remainingFat');

            // ì¹¼ë¡œë¦¬ (í˜•ì‹: "(2400 ë‚¨ìŒ)" ë˜ëŠ” "(100 ì´ˆê³¼)")
            if (remainingCalories >= 0) {
                caloriesElem.textContent = `(${Math.round(remainingCalories)} ë‚¨ìŒ)`;
                caloriesElem.className = 'nutrition-remaining';
            } else {
                caloriesElem.textContent = `(${Math.abs(Math.round(remainingCalories))} ì´ˆê³¼)`;
                caloriesElem.className = 'nutrition-remaining over';
            }

            // íƒ„ìˆ˜í™”ë¬¼
            if (remainingCarbs >= 0) {
                carbsElem.textContent = `(${Math.round(remainingCarbs)}g ë‚¨ìŒ)`;
                carbsElem.className = 'nutrition-remaining';
            } else {
                carbsElem.textContent = `(${Math.abs(Math.round(remainingCarbs))}g ì´ˆê³¼)`;
                carbsElem.className = 'nutrition-remaining over';
            }

            // ë‹¨ë°±ì§ˆ
            if (remainingProtein >= 0) {
                proteinElem.textContent = `(${Math.round(remainingProtein)}g ë‚¨ìŒ)`;
                proteinElem.className = 'nutrition-remaining';
            } else {
                proteinElem.textContent = `(${Math.abs(Math.round(remainingProtein))}g ì´ˆê³¼)`;
                proteinElem.className = 'nutrition-remaining over';
            }

            // ì§€ë°©
            if (remainingFat >= 0) {
                fatElem.textContent = `(${Math.round(remainingFat)}g ë‚¨ìŒ)`;
                fatElem.className = 'nutrition-remaining';
            } else {
                fatElem.textContent = `(${Math.abs(Math.round(remainingFat))}g ì´ˆê³¼)`;
                fatElem.className = 'nutrition-remaining over';
            }

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            if (todayIntake.carbs > 0 || todayIntake.protein > 0 || todayIntake.fat > 0) {
                renderNutritionChart(todayIntake.carbs, todayIntake.protein, todayIntake.fat);
            }

            console.log('ğŸ“Š ì˜ì–‘ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ:', todayIntake);
        }
        
        // ì˜¤ëŠ˜ ë¨¹ì€ ìŒì‹ ëª©ë¡ í‘œì‹œ
        function displayTodayMealsList() {
            const container = document.getElementById('todayMealsList');
            
            console.log('ğŸ½ï¸ displayTodayMealsList í˜¸ì¶œ, meals:', todayIntake.meals);
            console.log('ğŸ½ï¸ meals ìƒì„¸:', JSON.stringify(todayIntake.meals, null, 2));
            
            if (todayIntake.meals.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ì•„ì§ ê¸°ë¡ëœ ì‹ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            // ì‹ì‚¬ ì‹œê°„ë³„ë¡œ ê·¸ë£¹í•‘
            const mealsByType = {
                'ì•„ì¹¨': [],
                'ì ì‹¬': [],
                'ì €ë…': [],
                'ê°„ì‹': []
            };
            
            todayIntake.meals.forEach((meal, globalIndex) => {
                console.log(`ğŸ½ï¸ ì²˜ë¦¬ ì¤‘ì¸ meal[${globalIndex}]:`, meal, 'type:', meal.type, 'mealType:', meal.mealType, 'category:', meal.category);
                const mealType = meal.type || meal.mealType || meal.meal || meal.category || 'ì ì‹¬'; // ğŸ”¥ category ì¶”ê°€
                
                // food í•„ë“œ ìš°ì„ ìˆœìœ„: food > foodName > name
                meal._displayName = meal.food || meal.foodName || meal.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ìŒì‹';
                meal._globalIndex = globalIndex; // ì „ì—­ ì¸ë±ìŠ¤ ì €ì¥
                
                if (mealsByType[mealType]) {
                    mealsByType[mealType].push(meal);
                } else {
                    // íƒ€ì…ì´ ì—†ê±°ë‚˜ ë‹¤ë¥¸ ê²½ìš° ì ì‹¬ìœ¼ë¡œ
                    console.warn('âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” mealType:', mealType, 'â†’ ì ì‹¬ìœ¼ë¡œ ë¶„ë¥˜');
                    mealsByType['ì ì‹¬'].push(meal);
                }
            });
            
            let html = '';
            
            Object.keys(mealsByType).forEach(mealType => {
                const meals = mealsByType[mealType];
                if (meals.length > 0) {
                    const emoji = mealType === 'ì•„ì¹¨' ? 'ğŸŒ…' : mealType === 'ì ì‹¬' ? 'â˜€ï¸' : mealType === 'ì €ë…' ? 'ğŸŒ™' : 'ğŸª';
                    
                    html += `
                        <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 8px;">
                                ${emoji} ${mealType}
                            </div>
                    `;
                    
                    meals.forEach((meal) => {
                        const time = meal.timestamp ? new Date(meal.timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '';
                        const foodName = meal._displayName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                        const globalIndex = meal._globalIndex;
                        
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div onclick="editMealByGlobalIndex(${globalIndex})" style="flex: 1; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateX(3px)'" onmouseout="this.style.transform=''">
                                    <div style="font-size: 0.95rem; color: #333; font-weight: 600;">${foodName}</div>
                                    ${time ? `<div style="font-size: 0.75rem; color: #999; margin-top: 3px;">â° ${time}</div>` : ''}
                                    <div style="font-size: 0.75rem; color: #666; margin-top: 3px;">
                                        ${meal.carbs && meal.carbs > 0 ? `íƒ„ ${Math.round(meal.carbs)}g` : ''}
                                        ${meal.protein && meal.protein > 0 ? ` | ë‹¨ ${Math.round(meal.protein)}g` : ''}
                                        ${meal.fat && meal.fat > 0 ? ` | ì§€ ${Math.round(meal.fat)}g` : ''}
                                        ${(!meal.carbs || meal.carbs === 0) && (!meal.protein || meal.protein === 0) && (!meal.fat || meal.fat === 0) ? '<span style="color: #ff6b6b;">âš ï¸ ì˜ì–‘ ì •ë³´ ì—†ìŒ</span>' : ''}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.95rem; color: #00B89A; font-weight: 700;">
                                            ${Math.round(meal.calories || 0)} kcal
                                        </div>
                                        <div style="font-size: 0.7rem; color: #999; margin-top: 2px;">âœï¸ ìˆ˜ì •</div>
                                    </div>
                                    <button onclick="event.stopPropagation(); if(confirm('${foodName}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { deleteMeal(${globalIndex}); }" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ff5252'" onmouseout="this.style.background='#ff6b6b'">
                                        ğŸ—‘ï¸ ì‚­ì œ
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
            });
            
            container.innerHTML = html;
        }
        
        // ğŸ”¥ ìƒˆ ê¸°ëŠ¥: 100gë‹¹ ì˜ì–‘ì •ë³´ í‘œì‹œ
        function display100gNutrition() {
            console.log('ğŸ“Š display100gNutrition í˜¸ì¶œ');
            const container = document.getElementById('per100gContainer');
            const wrapper = document.getElementById('per100gNutrition');
            
            if (!container || !wrapper) {
                console.error('âŒ 100g ì˜ì–‘ì •ë³´ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            console.log('ğŸ“Š todayIntake.meals:', todayIntake.meals);
            
            if (todayIntake.meals.length === 0) {
                console.log('ğŸ“Š ì‹ì‚¬ ê¸°ë¡ì´ ì—†ìŒ');
                wrapper.style.display = 'none';
                return;
            }
            
            let html = '';
            const uniqueFoods = new Map(); // ì¤‘ë³µ ì œê±°ìš©
            
            todayIntake.meals.forEach(meal => {
                const foodName = meal.food || meal.foodName || meal.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
                console.log(`ğŸ“Š ì²˜ë¦¬ ì¤‘: ${foodName}, per100g:`, meal.per100g, 'calories:', meal.calories);
                
                // ğŸ”¥ per100g ì •ë³´ í™•ì¸ ë° ìƒì„±
                let per100g = null;
                
                if (meal.per100g && typeof meal.per100g === 'object') {
                    // per100g ì •ë³´ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    per100g = meal.per100g;
                } else if (meal.calories > 0) {
                    // ğŸ”¥ per100g ì •ë³´ê°€ ì—†ìœ¼ë©´ ëŒ€ëµì ìœ¼ë¡œ ì¶”ì • (ì´ëŸ‰ ê¸°ì¤€)
                    // ì¼ë°˜ì ìœ¼ë¡œ 1ì¸ë¶„ì´ 200-300gì´ë¼ê³  ê°€ì •
                    const estimatedWeight = 250; // ê·¸ëŒ
                    per100g = {
                        calories: Math.round((meal.calories / estimatedWeight) * 100),
                        carbs: Math.round((meal.carbs / estimatedWeight) * 100),
                        protein: Math.round((meal.protein / estimatedWeight) * 100),
                        fat: Math.round((meal.fat / estimatedWeight) * 100)
                    };
                    console.log(`ğŸ’¡ ${foodName}: per100g ì •ë³´ ì¶”ì •ë¨`, per100g);
                }
                
                // ìœ íš¨í•œ ì˜ì–‘ ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
                if (per100g && (per100g.calories > 0 || per100g.carbs > 0 || per100g.protein > 0 || per100g.fat > 0)) {
                    if (!uniqueFoods.has(foodName)) {
                        uniqueFoods.set(foodName, per100g);
                        console.log(`âœ… ${foodName} ì¶”ê°€ë¨:`, per100g);
                    }
                }
            });
            
            console.log('ğŸ“Š uniqueFoods.size:', uniqueFoods.size);
            
            if (uniqueFoods.size === 0) {
                console.log('ğŸ“Š í‘œì‹œí•  ìŒì‹ì´ ì—†ìŒ');
                wrapper.style.display = 'none';
                return;
            }
            
            uniqueFoods.forEach((per100g, foodName) => {
                html += `
                    <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #ddd;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 4px;">ğŸ½ï¸ ${foodName}</div>
                        <div style="color: #666; padding-left: 15px;">
                            <span style="background: #fff3cd; padding: 2px 6px; border-radius: 4px; margin-right: 8px;">
                                ğŸ”¥ ${per100g.calories}kcal
                            </span>
                            <span style="margin-right: 8px;">íƒ„ ${per100g.carbs}g</span>
                            <span style="margin-right: 8px;">ë‹¨ ${per100g.protein}g</span>
                            <span>ì§€ ${per100g.fat}g</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            wrapper.style.display = 'block';
        }
        
        // í˜„ì¬ ìˆ˜ì • ì¤‘ì¸ ì‹ì‚¬ ì¸ë±ìŠ¤
        let editingMealIndex = -1;
        let editingMealType = 'ì ì‹¬';
        
        // ì‹ì‚¬ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function editMealByGlobalIndex(globalIndex) {
            console.log('ğŸ½ï¸ ì‹ì‚¬ ìˆ˜ì • (globalIndex):', globalIndex);
            
            const meal = todayIntake.meals[globalIndex];
            
            if (!meal) {
                console.error('âŒ ì‹ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', globalIndex);
                alert('ì‹ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ğŸ“ ìˆ˜ì •í•  ì‹ì‚¬:', meal);
            
            editingMealIndex = globalIndex;
            editingMealType = meal.type || meal.mealType || meal.meal || 'ì ì‹¬';
            
            // ëª¨ë‹¬ ì—´ê¸°
            document.getElementById('editMealModal').style.display = 'flex';
            
            // ê¸°ì¡´ ê°’ ì±„ìš°ê¸°
            document.getElementById('editFoodName').value = meal.food || meal.foodName || meal.name || '';
            document.getElementById('editCalories').value = meal.calories || 0;
            document.getElementById('editCarbs').value = meal.carbs || 0;
            document.getElementById('editProtein').value = meal.protein || 0;
            document.getElementById('editFat').value = meal.fat || 0;
            
            // ì‹ì‚¬ íƒ€ì… ë²„íŠ¼ í™œì„±í™”
            selectEditMealType(editingMealType);
            
            // ì§ì ‘ ì…ë ¥ í•„ë“œ ìˆ¨ê¹€
            document.getElementById('manualEditFields').style.display = 'none';
        }
        
        // ì‹ì‚¬ íƒ€ì… ì„ íƒ
        function selectEditMealType(type) {
            editingMealType = type;
            
            // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
            ['ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ê°„ì‹'].forEach(t => {
                const btn = document.getElementById(`editMealType-${t}`);
                if (btn) {
                    btn.style.opacity = '0.5';
                    btn.style.transform = 'scale(1)';
                }
            });
            
            // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
            const selectedBtn = document.getElementById(`editMealType-${type}`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.05)';
            }
        }
        
        // ìˆ˜ì • ë°©ë²• ì„ íƒ
        function selectEditMethod(method) {
            if (method === 'manual') {
                // ì§ì ‘ ì…ë ¥
                document.getElementById('manualEditFields').style.display = 'block';
            } else if (method === 'ai') {
                // AI ì¬ë¶„ì„ (ì‹œê°„ ìœ ì§€)
                const meal = todayIntake.meals[editingMealIndex];
                if (!meal) {
                    alert('ì‹ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const foodName = meal.food || meal.foodName || meal.name || 'ì´ ìŒì‹';
                const mealType = editingMealType;
                const originalTimestamp = meal.timestamp; // ğŸ”¥ ì›ë˜ ì‹œê°„ ì €ì¥
                const originalPhoto = meal.photo || meal.photoURL; // ğŸ”¥ ì›ë˜ ì‚¬ì§„ URL ì €ì¥
                
                closeEditMealModal();
                
                if (confirm(`"${foodName}"ì„ AIë¡œ ì¬ë¶„ì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në‚´ìš©ë§Œ ë³€ê²½ë˜ë©°, ë“±ë¡ ì‹œê°„ì€ ìœ ì§€ë©ë‹ˆë‹¤.`)) {
                    // ğŸ”¥ ì‹œê°„ê³¼ ì¸ë±ìŠ¤ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ (ì¬ì…ë ¥ ì‹œ ì‚¬ìš©)
                    window.editingMealData = {
                        index: editingMealIndex,
                        originalTimestamp: originalTimestamp,
                        originalPhoto: originalPhoto,
                        mealType: mealType
                    };
                    
                    // ì¬ë¶„ì„ ëª¨ë‹¬ í‘œì‹œ
                    showReanalysisModal(mealType, true); // true = ìˆ˜ì • ëª¨ë“œ
                }
            }
        }
        
        // ì¬ë¶„ì„ ì „ìš© ëª¨ë‹¬ (ê¹”ë”í•œ UI)
        function showReanalysisModal(mealType, isEditMode = false) {
            const mealTypeKorean = mealType === 'ì•„ì¹¨' ? 'ì•„ì¹¨' : 
                                   mealType === 'ì ì‹¬' ? 'ì ì‹¬' : 
                                   mealType === 'ì €ë…' ? 'ì €ë…' : 'ê°„ì‹';
            
            const titleText = isEditMode ? 'ì¬ë¶„ì„ (ì‹œê°„ ìœ ì§€)' : 'ì¬ë¶„ì„';
            const descText = isEditMode ? 
                'ë“±ë¡ ì‹œê°„ì€ ìœ ì§€ë˜ë©°, ë‚´ìš©ë§Œ ë³€ê²½ë©ë‹ˆë‹¤.' : 
                'ê¸°ì¡´ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.<br>ìƒˆë¡œìš´ ë°©ë²•ìœ¼ë¡œ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            
            // ëª¨ë‹¬ HTML ìƒì„±
            const modalHtml = `
                <div class="modal active" id="reanalysisModal" style="z-index: 10000;">
                    <div class="modal-content" style="max-width: 400px; animation: slideUp 0.3s;">
                        <div style="padding: 25px; text-align: center;">
                            <h3 style="margin: 0 0 20px; font-size: 1.3rem; color: #333;">
                                ğŸ½ï¸ ${mealTypeKorean} ${titleText}
                            </h3>
                            <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">
                                ${descText}
                            </p>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <button class="input-method-btn" onclick="closeReanalysisModal(); currentMealType='${mealType}'; openMealInputModal(${isEditMode});" 
                                        style="width: 100%; padding: 18px; font-size: 1.1rem; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s;">
                                    âœï¸ ê¸€ë¡œ ì…ë ¥í•˜ê¸°
                                </button>
                                <button class="input-method-btn" onclick="closeReanalysisModal(); currentMealType='${mealType}'; uploadFoodPhoto(${isEditMode});" 
                                        style="width: 100%; padding: 18px; font-size: 1.1rem; border-radius: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s;">
                                    ğŸ“· ì‚¬ì§„ ì´¬ì˜í•˜ê¸°
                                </button>
                                <button onclick="closeReanalysisModal(); window.editingMealData = null;" 
                                        style="width: 100%; padding: 15px; font-size: 1rem; border-radius: 10px; background: #f0f0f0; color: #666; border: none; cursor: pointer; margin-top: 8px;">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ê¸°ì¡´ ì¬ë¶„ì„ ëª¨ë‹¬ ì œê±°
            const existingModal = document.getElementById('reanalysisModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeReanalysisModal() {
            const modal = document.getElementById('reanalysisModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ì‹ì‚¬ ì‚­ì œ
        async function deleteMeal(globalIndex) {
            const meal = todayIntake.meals[globalIndex];
            if (!meal) return;
            
            try {
                // ğŸ”¥ ì•¨ë²” ë™ê¸°í™”: photos ì»¬ë ‰ì…˜ì—ì„œ ì‚­ì œ
                // 1) ì‚¬ì§„ì´ ìˆëŠ” ê²½ìš°: photoURL ê¸°ì¤€ ì‚­ì œ
                if (meal.photo || meal.photoURL) {
                    const photoURL = meal.photo || meal.photoURL;
                    console.log('ğŸ—‘ï¸ ì•¨ë²”ì—ì„œ ì‚¬ì§„ ì‚­ì œ ì‹œë„ (photoURL):', photoURL);
                    
                    const photosSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(currentUser.uid)
                        .collection('photos')
                        .where('url', '==', photoURL)
                        .get();
                    
                    photosSnapshot.forEach(async (doc) => {
                        await doc.ref.delete();
                        console.log('âœ… ì•¨ë²”ì—ì„œ ì‚¬ì§„ ì‚­ì œ ì™„ë£Œ:', doc.id);
                    });
                }
                
                // 2) text ê¸°ë°˜ ì‹ì‚¬ì¸ ê²½ìš°: food + mealType + timestamp ê¸°ì¤€ ì‚­ì œ
                const foodName = meal.food || meal.foodName || meal.name;
                const mealCategory = meal.category || meal.type || meal.mealType;
                const mealTimestamp = meal.timestamp;
                
                if (foodName && mealCategory) {
                    console.log('ğŸ—‘ï¸ ì•¨ë²”ì—ì„œ text ê¸°ë°˜ ì‹ì‚¬ ì‚­ì œ ì‹œë„:', foodName, mealCategory);
                    
                    // mealTypeê³¼ text ë§¤ì¹­ìœ¼ë¡œ ì‚­ì œ
                    const textPattern = `${mealCategory}: ${foodName}`;
                    console.log('ğŸ” ê²€ìƒ‰ íŒ¨í„´:', textPattern);
                    
                    const textMealsSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(currentUser.uid)
                        .collection('photos')
                        .where('category', '==', 'food')
                        .get();
                    
                    textMealsSnapshot.forEach(async (doc) => {
                        const data = doc.data();
                        
                        // text í•„ë“œ ë§¤ì¹­ (ì˜ˆ: "ì ì‹¬: ì§¬ë½•,ê¿”ë°”ë¡œìš°")
                        if (data.text && data.text === textPattern) {
                            await doc.ref.delete();
                            console.log('âœ… ì•¨ë²”ì—ì„œ text ì‹ì‚¬ ì‚­ì œ ì™„ë£Œ:', doc.id, textPattern);
                        }
                    });
                }
                
                // ğŸ”¥ ì¤‘ì²© êµ¬ì¡° ê³ ë ¤í•œ ì˜ì–‘ì†Œ ì¶”ì¶œ
                const mealCalories = meal.calories || (meal.nutrition?.calories) || 0;
                const mealCarbs = meal.carbs || (meal.nutrition?.carbs) || 0;
                const mealProtein = meal.protein || (meal.nutrition?.protein) || 0;
                const mealFat = meal.fat || (meal.nutrition?.fat) || 0;
                
                console.log(`ğŸ—‘ï¸ ì‚­ì œí•  ì‹ì‚¬ ì˜ì–‘ì†Œ: ${mealCalories}kcal, íƒ„${mealCarbs}g, ë‹¨${mealProtein}g, ì§€${mealFat}g`);
                
                // ì˜ì–‘ì†Œ ì°¨ê°
                todayIntake.calories -= mealCalories;
                todayIntake.carbs -= mealCarbs;
                todayIntake.protein -= mealProtein;
                todayIntake.fat -= mealFat;
                
                // ìŒìˆ˜ ë°©ì§€
                todayIntake.calories = Math.max(0, todayIntake.calories);
                todayIntake.carbs = Math.max(0, todayIntake.carbs);
                todayIntake.protein = Math.max(0, todayIntake.protein);
                todayIntake.fat = Math.max(0, todayIntake.fat);
                
                console.log('ğŸ—‘ï¸ ì°¨ê° í›„ ì´ ì˜ì–‘ì†Œ:', todayIntake);
                
                // ë°°ì—´ì—ì„œ ì œê±°
                todayIntake.meals.splice(globalIndex, 1);
                
                // Firebase ì €ì¥
                await saveTodayNutritionToFirestore();
                
                // UI ì—…ë°ì´íŠ¸
                updateNutritionUI();
                
                showAIToast('ì‹ì‚¬ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 3000);
            } catch (error) {
                console.error('ì‹ì‚¬ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ìˆ˜ì • ì €ì¥
        function saveEditedMeal() {
            const meal = todayIntake.meals[editingMealIndex];
            if (!meal) {
                alert('ì‹ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const foodName = document.getElementById('editFoodName').value.trim();
            const calories = parseFloat(document.getElementById('editCalories').value) || 0;
            const carbs = parseFloat(document.getElementById('editCarbs').value) || 0;
            const protein = parseFloat(document.getElementById('editProtein').value) || 0;
            const fat = parseFloat(document.getElementById('editFat').value) || 0;
            
            if (!foodName) {
                alert('ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ê¸°ì¡´ ê°’ ì œê±°
            todayIntake.calories -= (meal.calories || 0);
            todayIntake.carbs -= (meal.carbs || 0);
            todayIntake.protein -= (meal.protein || 0);
            todayIntake.fat -= (meal.fat || 0);
            
            // ìƒˆ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            meal.type = editingMealType;
            meal.mealType = editingMealType;
            meal.meal = editingMealType;
            meal.food = foodName;
            meal.foodName = foodName;
            meal.name = foodName;
            meal.calories = calories;
            meal.carbs = carbs;
            meal.protein = protein;
            meal.fat = fat;
            
            // ì´í•© ë‹¤ì‹œ ê³„ì‚°
            todayIntake.calories += calories;
            todayIntake.carbs += carbs;
            todayIntake.protein += protein;
            todayIntake.fat += fat;
            
            // Firebaseì— ì €ì¥
            saveTodayNutritionToFirestore();
            
            // UI ì—…ë°ì´íŠ¸
            updateNutritionUI();
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeEditMealModal();
            
            showAIToast(`âœ… ${foodName} ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`, 3000);
        }
        
        // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        function closeEditMealModal() {
            document.getElementById('editMealModal').style.display = 'none';
            editingMealIndex = -1;
        }

        // ì¹¼ë¡œë¦¬ ì´ˆê³¼ ì²´í¬
        // ğŸ”¥ 5. íŒ©íŠ¸ì²´í¬ & ë¯¸ë˜ ì˜ˆì¸¡ (ê³¼ì‹ ì‹œ ë‹¨í˜¸í•œ ê²½ê³ )
        async function checkCalorieOverage() {
            const remaining = dailyNutrition.totalCalories - todayIntake.calories;

            if (remaining < 0) {
                const overage = Math.abs(remaining);
                const userName = currentProfile?.name || 'íšŒì›”';
                
                // ğŸ”¥ ëª©í‘œ ë‹¬ì„±ì¼ ì§€ì—° ê³„ì‚°
                // 7,700kcal = 1kg ì²´ì§€ë°©
                // 500kcal ì´ˆê³¼ = ì•½ 0.5~1ì¼ ì§€ì—°
                const weightToLose = (currentProfile?.startWeight || 70) - (currentProfile?.goalWeight || 60); // ê°ëŸ‰ ëª©í‘œ (kg)
                const totalCalorieDeficit = weightToLose * 7700; // ì´ í•„ìš” ì¹¼ë¡œë¦¬ ì ì
                const delayDays = Math.ceil(overage / 500); // 500kcal ì´ˆê³¼ = ì•½ 1ì¼ ì§€ì—°
                
                console.warn('âš ï¸ ì¹¼ë¡œë¦¬ ì´ˆê³¼:', overage, 'kcal / ëª©í‘œ ë‹¬ì„± ì§€ì—°:', delayDays, 'ì¼');
                
                // ğŸ”¥ ë‹¨í˜¸í•œ ì„ ë°° íŠ¸ë ˆì´ë„ˆ í”„ë¡¬í”„íŠ¸
                const warningPrompt = `ë‹¹ì‹ ì€ ${userName} íšŒì›ë‹˜ì˜ ë‹´ë‹¹ ì„ ë°° íŠ¸ë ˆì´ë„ˆì…ë‹ˆë‹¤.

**ìƒí™©:**
- íšŒì›ë‹˜ì´ ì˜¤ëŠ˜ ëª©í‘œ ì¹¼ë¡œë¦¬ë¥¼ ${Math.round(overage)}kcal ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.
- ê¶Œì¥ ì„­ì·¨ëŸ‰: ${dailyNutrition.totalCalories}kcal
- ì‹¤ì œ ì„­ì·¨ëŸ‰: ${todayIntake.calories}kcal
- í˜„ì¬ ì²´ì¤‘: ${currentProfile?.startWeight || currentProfile?.currentWeight}kg
- ëª©í‘œ ì²´ì¤‘: ${currentProfile?.goalWeight}kg
- **ëª©í‘œ ë‹¬ì„±ì¼ì´ ìµœì†Œ ${delayDays}ì¼ ë” ë©€ì–´ì¡ŒìŠµë‹ˆë‹¤**

**ì‘ë‹µ ìš”êµ¬ì‚¬í•­:**
1. "${userName} íšŒì›ë‹˜"ìœ¼ë¡œ ì‹œì‘
2. ê³¼ì‹ì— ëŒ€í•œ ê°•ë ¥í•œ ê²½ê³  (ê±¸ë¦°í•˜ê³  í™”ë‚œ ë“¯í•œ í†¤)
3. ëª©í‘œ ë‹¬ì„±ì¼ ì§€ì—° ì‚¬ì‹¤ ëª…ì‹œ ("ìµœì†Œ ${delayDays}ì¼ ë” ë©€ì–´ì¡Œë‹¤")
4. êµ¬ì²´ì ì¸ ë³´ìƒ ìš´ë™ ë˜ëŠ” ë‹¨ì‹ ì§€ì‹œ (ì˜ˆ: "ì¸í„°ë²Œ ëŸ¬ë‹ 1ì‹œê°„", "ë‚´ì¼ ì •ì˜¤ê¹Œì§€ ë¬¼ ì™¸ ê¸ˆì‹")
5. ê¸¸ì´: 50ì ì´ë‚´
6. ê±¸ë¦°í•˜ê³  í™”ë‚œ ë“¯í•œ ì„ ë°° íŠ¸ë ˆì´ë„ˆ ë§íˆ¬

ë‹¨í˜¸í•˜ê³  í˜„ì‹¤ì ì¸ ê²½ê³  ë©”ì‹œì§€ë¥¼ 50ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”.`;
                
                try {
                    const warningResponse = await callGeminiAPIBase(warningPrompt);
                    showAIToast(warningResponse, 10000); // 10ì´ˆê°„ í‘œì‹œ
                } catch (error) {
                    console.error('âŒ AI ê²½ê³  ìƒì„± ì‹¤íŒ¨:', error);
                    // í´ë°± ë©”ì‹œì§€
                    showAIToast(`${userName} íšŒì›ë‹˜, ì˜¤ëŠ˜ ëª©í‘œ ì¹¼ë¡œë¦¬ë¥¼ ${Math.round(overage)}kcal ì´ˆê³¼í•˜ì…¨ìŠµë‹ˆë‹¤. ëª©í‘œ ë‹¬ì„±ì¼ì´ ìµœì†Œ ${delayDays}ì¼ ë” ë©€ì–´ì¡Œì–´ìš”. ë‚´ì¼ ë°˜ë“œì‹œ ë³´ìƒ ìš´ë™ í•˜ì„¸ìš”! ğŸ’ª`, 10000);
                }
                
            } else if (remaining < 300 && todayIntake.meals.length >= 2) {
                const userName = currentProfile?.name || 'íšŒì›';
                showAIToast(`${userName} íšŒì›ë‹˜, ì˜¤ëŠ˜ ë‚¨ì€ ì¹¼ë¡œë¦¬ê°€ ${Math.round(remaining)}kcalì…ë‹ˆë‹¤. ì˜ ê´€ë¦¬í•˜ê³  ê³„ì‹œë„¤ìš”! ğŸ‘`, 5000);
            }
        }

        // ìì • ì´ˆê¸°í™” í•¨ìˆ˜
        async function resetDailyNutrition() {
            console.log('ğŸŒ™ ìì • ì´ˆê¸°í™” ì‹œì‘...');

            // ì˜¤ëŠ˜ ë°ì´í„°ë¥¼ Firestoreì— ìµœì¢… ì €ì¥
            await saveTodayNutritionToFirestore();

            // todayIntake ì´ˆê¸°í™”
            todayIntake = {
                calories: 0,
                carbs: 0,
                protein: 0,
                fat: 0,
                meals: []
            };

            updateNutritionUI();
            console.log('âœ… ì˜ì–‘ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // ìì • ì´ˆê¸°í™” íƒ€ì´ë¨¸ ì„¤ì •
        function setupMidnightReset() {
            if (midnightResetInterval) {
                clearInterval(midnightResetInterval);
            }

            // 1ë¶„ë§ˆë‹¤ ì²´í¬
            midnightResetInterval = setInterval(() => {
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 0) {
                    resetDailyNutrition();
                }
            }, 60000); // 1ë¶„ë§ˆë‹¤ ì²´í¬

            console.log('â° ìì • ì´ˆê¸°í™” íƒ€ì´ë¨¸ ì„¤ì • ì™„ë£Œ');
        }

        // Firestoreì— ì˜¤ëŠ˜ ì˜ì–‘ ë°ì´í„° ì €ì¥
        async function saveTodayNutritionToFirestore() {
            if (!currentUser) return;

            try {
                const today = new Date();
                const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyNutrition').doc(dateStr)
                    .set({
                        date: dateStr,
                        calories: todayIntake.calories,
                        carbs: todayIntake.carbs,
                        protein: todayIntake.protein,
                        fat: todayIntake.fat,
                        mealCount: todayIntake.meals.length,
                        meals: todayIntake.meals,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                console.log('ğŸ’¾ ì˜ì–‘ ë°ì´í„° Firestore ì €ì¥ ì™„ë£Œ:', dateStr);
            } catch (error) {
                console.error('âŒ ì˜ì–‘ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // ì˜¤ëŠ˜ ì˜ì–‘ ë°ì´í„° ë¡œë“œ (ì•± ì‹œì‘ ì‹œ)
        async function loadTodayNutrition() {
            if (!currentUser) return;

            try {
                const today = new Date();
                const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                const doc = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyNutrition').doc(dateStr)
                    .get();

                if (doc.exists) {
                    const data = doc.data();
                    
                    // ğŸ”¥ ê¸°ì¡´ ë°ì´í„° êµ¬ì¡° ì •ê·œí™” (nutrition.calories â†’ calories)
                    const normalizedMeals = (data.meals || []).map(meal => {
                        if (meal.nutrition && typeof meal.nutrition === 'object') {
                            // ì¤‘ì²© êµ¬ì¡° â†’ flat êµ¬ì¡°ë¡œ ë³€í™˜
                            return {
                                ...meal,
                                food: meal.food || meal.foodName || meal.name,
                                foodName: meal.foodName || meal.food || meal.name,
                                calories: meal.nutrition.calories || meal.calories || 0,
                                carbs: meal.nutrition.carbs || meal.carbs || 0,
                                protein: meal.nutrition.protein || meal.protein || 0,
                                fat: meal.nutrition.fat || meal.fat || 0
                            };
                        }
                        // ì´ë¯¸ flat êµ¬ì¡°ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
                        return {
                            ...meal,
                            food: meal.food || meal.foodName || meal.name,
                            foodName: meal.foodName || meal.food || meal.name
                        };
                    });
                    
                    // ğŸ”¥ í•©ê³„ ì¬ê³„ì‚° (ê¸°ì¡´ í•©ê³„ê°€ ë¶€ì •í™•í•  ìˆ˜ ìˆìŒ)
                    let recalcCalories = 0, recalcCarbs = 0, recalcProtein = 0, recalcFat = 0;
                    normalizedMeals.forEach(meal => {
                        recalcCalories += meal.calories || 0;
                        recalcCarbs += meal.carbs || 0;
                        recalcProtein += meal.protein || 0;
                        recalcFat += meal.fat || 0;
                    });
                    
                    console.log('ğŸ“Š Firebase ì €ì¥ëœ í•©ê³„:', { calories: data.calories, carbs: data.carbs, protein: data.protein, fat: data.fat });
                    console.log('ğŸ“Š ì¬ê³„ì‚°ëœ í•©ê³„:', { calories: recalcCalories, carbs: recalcCarbs, protein: recalcProtein, fat: recalcFat });
                    
                    todayIntake = {
                        calories: recalcCalories, // ğŸ”¥ ì¬ê³„ì‚°ëœ ê°’ ì‚¬ìš©
                        carbs: recalcCarbs,
                        protein: recalcProtein,
                        fat: recalcFat,
                        meals: normalizedMeals
                    };
                    
                    console.log('ğŸ“¥ ì˜¤ëŠ˜ ì˜ì–‘ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', todayIntake);
                    console.log('ğŸ½ï¸ ì‹ì‚¬ ê°œìˆ˜:', todayIntake.meals.length);
                    if (todayIntake.meals.length > 0) {
                        console.log('ğŸ½ï¸ ì‹ì‚¬ ëª©ë¡:', todayIntake.meals);
                    }
                    updateNutritionUI();
                } else {
                    console.log('ğŸ“ ì˜¤ëŠ˜ì€ ì•„ì§ ì‹ì‚¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                    // ğŸ”¥ ì‹ì‚¬ ê¸°ë¡ ì—†ì–´ë„ ê¶Œì¥ ì„­ì·¨ëŸ‰ì€ í‘œì‹œ
                    updateNutritionUI();
                }
            } catch (error) {
                console.error('âŒ ì˜ì–‘ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                // ğŸ”¥ ì˜¤ë¥˜ ë°œìƒí•´ë„ ê¶Œì¥ ì„­ì·¨ëŸ‰ì€ í‘œì‹œ
                updateNutritionUI();
            }
        }

        // ========== Phase 1: ìº˜ë¦°ë” í†µí•© í•¨ìˆ˜ ==========

        // ì¼ì¼ ë¡œê·¸ì— ë°ì´í„° ì €ì¥ (ìº˜ë¦°ë” ì—°ë™)
        async function saveToDailyLog(date, type, data) {
            if (!currentUser) {
                console.warn('âš ï¸ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ');
                return;
            }

            try {
                // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const dateObj = date instanceof Date ? date : new Date(date);
                const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;

                // ê¸°ì¡´ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
                const logRef = db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').doc(dateStr);

                const logDoc = await logRef.get();
                let logData = logDoc.exists ? logDoc.data() : { date: dateStr };

                // íƒ€ì…ë³„ ë°ì´í„° ì €ì¥
                switch(type) {
                    case 'weight':
                        logData.weight = data.weight;
                        logData.weightTimestamp = data.timestamp || firebase.firestore.FieldValue.serverTimestamp();
                        break;

                    case 'nutrition':
                        if (!logData.nutrition) {
                            logData.nutrition = {
                                calories: 0,
                                carbs: 0,
                                protein: 0,
                                fat: 0,
                                meals: []
                            };
                        }
                        // ì˜ì–‘ ë°ì´í„° ëˆ„ì 
                        logData.nutrition.calories = (logData.nutrition.calories || 0) + (data.calories || 0);
                        logData.nutrition.carbs = (logData.nutrition.carbs || 0) + (data.carbs || 0);
                        logData.nutrition.protein = (logData.nutrition.protein || 0) + (data.protein || 0);
                        logData.nutrition.fat = (logData.nutrition.fat || 0) + (data.fat || 0);
                        if (data.foodName) {
                            logData.nutrition.meals.push({
                                foodName: data.foodName,
                                calories: data.calories,
                                timestamp: data.timestamp || new Date().toISOString()
                            });
                        }
                        break;

                    case 'exercise':
                        if (!logData.exercises) logData.exercises = [];
                        logData.exercises.push({
                            name: data.name,
                            duration: data.duration,
                            timestamp: data.timestamp || new Date().toISOString()
                        });
                        break;

                    case 'fasting':
                        logData.fasting = {
                            duration: data.duration, // ë¶„ ë‹¨ìœ„
                            startTime: data.startTime,
                            endTime: data.endTime,
                            stage: data.stage || 'ë‹¨ì‹ ì™„ë£Œ'
                        };
                        break;

                    case 'water':
                        logData.water = data.amount; // ml ë‹¨ìœ„
                        break;

                    case 'plan':
                        logData.plan = {
                            schedules: data.schedules || [],
                            diary: data.diary || ''
                        };
                        break;

                    case 'photo_body':
                    case 'photo_food':
                    case 'photo_exercise':
                        if (!logData.photos) logData.photos = [];
                        logData.photos.push({
                            category: type.replace('photo_', ''),
                            url: data.url,
                            timestamp: data.timestamp || new Date().toISOString()
                        });
                        break;

                    default:
                        console.warn('âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” íƒ€ì…:', type);
                        return;
                }

                // Firestoreì— ì €ì¥
                logData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                await logRef.set(logData, { merge: true });

                console.log(`ğŸ’¾ ì¼ì¼ ë¡œê·¸ ì €ì¥ ì™„ë£Œ [${dateStr}] ${type}:`, data);

            } catch (error) {
                console.error('âŒ ì¼ì¼ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // ìº˜ë¦°ë”ì—ì„œ íŠ¹ì • íƒ€ì…ì˜ ë°ì´í„° ì‚­ì œ
        async function removeFromDailyLog(date, type) {
            if (!currentUser) {
                console.warn('âš ï¸ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ');
                return;
            }

            try {
                // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const dateObj = date instanceof Date ? date : new Date(date);
                const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;

                // Firestoreì—ì„œ í•´ë‹¹ í•„ë“œ ì‚­ì œ
                const logRef = db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').doc(dateStr);

                await logRef.update({
                    [type]: firebase.firestore.FieldValue.delete()
                });

                console.log(`ğŸ—‘ï¸ ìº˜ë¦°ë”ì—ì„œ ì‚­ì œ ì™„ë£Œ [${dateStr}] ${type}`);

            } catch (error) {
                // ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°ëŠ” ë¬´ì‹œ
                if (error.code === 'not-found') {
                    console.log('ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                } else {
                    console.error('âŒ ìº˜ë¦°ë” ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', error);
                }
            }
        }

        // íŠ¹ì • ë‚ ì§œì˜ í†µí•© ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ìº˜ë¦°ë” ì¡°íšŒìš©)
        async function getDailyData(date) {
            if (!currentUser) return null;

            try {
                const dateObj = date instanceof Date ? date : new Date(date);
                const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;

                const logDoc = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').doc(dateStr)
                    .get();

                if (logDoc.exists) {
                    return logDoc.data();
                } else {
                    return null;
                }
            } catch (error) {
                console.error('âŒ ì¼ì¼ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // ==================== AI í† ìŠ¤íŠ¸ íŒì—… í•¨ìˆ˜ ====================

        // AI í† ìŠ¤íŠ¸ í‘œì‹œ
        function showAIToast(message, duration = 5000) {
            const toast = document.getElementById('aiToast');
            const messageEl = document.getElementById('aiToastMessage');

            // ê¸°ì¡´ íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
            if (aiToastTimeout) {
                clearTimeout(aiToastTimeout);
            }

            // ë©”ì‹œì§€ ì„¤ì • ë° í‘œì‹œ
            messageEl.textContent = message;
            toast.classList.remove('hidden');

            // ìë™ ìˆ¨ê¹€ (durationì´ 0ì´ë©´ ìˆ˜ë™ìœ¼ë¡œë§Œ ë‹«í˜)
            if (duration > 0) {
                aiToastTimeout = setTimeout(() => {
                    toast.classList.add('hidden');
                }, duration);
            }
        }

        // AI í† ìŠ¤íŠ¸ì—ì„œ ì±„íŒ… ì—´ê¸°
        function openAIChatFromToast() {
            // í† ìŠ¤íŠ¸ ìˆ¨ê¹€
            document.getElementById('aiToast').classList.add('hidden');

            // AI ì±„íŒ… íƒ­ìœ¼ë¡œ ì´ë™
            switchTab('home');

            // AI ì±„íŒ… ì„¹ì…˜ ì—´ê¸°
            const aiChatDetails = document.getElementById('aiChatDetails');
            if (aiChatDetails && aiChatDetails.style.display !== 'block') {
                toggleAIChat();
            }

            // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                const chatInput = document.getElementById('aiChatInput');
                if (chatInput) {
                    chatInput.focus();
                }
            }, 300);
        }

        // AI ëŒ€í™” ë§¥ë½ í”„ë¡¬í”„íŠ¸ ìƒì„±
        async function buildAIContextPrompt(userMessage, chatHistory) {
            try {
                // ìµœê·¼ 5ê°œ ëŒ€í™” ê°€ì ¸ì˜¤ê¸°
                const recentChats = chatHistory.slice(-10); // ìµœê·¼ 5ìŒ (user+assistant)
                const recentChatText = recentChats
                    .map(chat => `${chat.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${chat.content}`)
                    .join('\n');

                // ì˜¤ëŠ˜ì˜ ì˜ì–‘ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);

                const foodPhotosSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('category', '==', 'food')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(todayStart))
                    .where('uploadedAt', '<', firebase.firestore.Timestamp.fromDate(todayEnd))
                    .get();

                let totalCalories = 0;
                const meals = [];

                foodPhotosSnapshot.forEach(doc => {
                    const photo = doc.data();
                    if (photo.nutrition) {
                        totalCalories += photo.nutrition.calories || 0;
                        meals.push(`${photo.nutrition.foodName} (${Math.round(photo.nutrition.calories)}kcal)`);
                    }
                });

                // todayIntakeì—ì„œë„ ì‹ì‚¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const mealCount = todayIntake.meals ? todayIntake.meals.length : 0;
                const caloriesRemaining = dailyNutrition.totalCalories - (todayIntake.calories || 0);

                // ë¬¼ ì„­ì·¨ëŸ‰ ê°€ì ¸ì˜¤ê¸° (records ê¸°ë°˜)
                const waterSettings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"cupSize": 250, "goalLiters": 2, "filled": [], "records": []}');
                let waterIntake = 0;
                if (waterSettings.records && waterSettings.records.length > 0) {
                    // ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸
                    const today = new Date().toISOString().split('T')[0];
                    if (waterSettings.lastDate === today) {
                        waterIntake = waterSettings.records.reduce((sum, r) => sum + r.amount, 0);
                    }
                } else {
                    // ê¸°ì¡´ ë°©ì‹ (filled ë°°ì—´ ê¸°ë°˜)
                    waterIntake = (waterSettings.filled ? waterSettings.filled.length : 0) * (waterSettings.cupSize || 250);
                }
                const waterGoal = (waterSettings.goalLiters || 2) * 1000;

                // ì˜¤ëŠ˜ì˜ ë‹¨ì‹ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
                let fastingDuration = 0;
                const fastingRecords = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('fastingRecords')
                    .where('date', '==', today.toISOString().split('T')[0])
                    .get();

                fastingRecords.forEach(doc => {
                    const record = doc.data();
                    fastingDuration += record.duration || 0;
                });

                const fastingHours = Math.floor(fastingDuration / (1000 * 60 * 60));
                const fastingMinutes = Math.floor((fastingDuration % (1000 * 60 * 60)) / (1000 * 60));

                // í˜„ì¬ ì²´ì¤‘ ê°€ì ¸ì˜¤ê¸°
                const weightsSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .orderBy('date', 'desc')
                    .limit(1)
                    .get();

                const currentWeight = weightsSnapshot.empty
                    ? currentProfile.startWeight
                    : weightsSnapshot.docs[0].data().weight;

                // í•¨ê»˜í•œ ë‚  ê³„ì‚°
                const createdAt = currentProfile.createdAt ? currentProfile.createdAt.toDate() : new Date();
                const daysActive = Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24));

                // ì£¼ê°„ ì²´ì¤‘ ë³€í™” ê³„ì‚°
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const weeklyWeights = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(sevenDaysAgo))
                    .orderBy('date', 'asc')
                    .get();

                let weeklyWeightChange = 0;
                if (!weeklyWeights.empty && weeklyWeights.docs.length >= 2) {
                    const firstWeight = weeklyWeights.docs[0].data().weight;
                    const lastWeight = weeklyWeights.docs[weeklyWeights.docs.length - 1].data().weight;
                    weeklyWeightChange = firstWeight - lastWeight;
                }

                // ì»¨í…ìŠ¤íŠ¸ í¬í•¨ í”„ë¡¬í”„íŠ¸ ìƒì„± (AI íŠ¸ë ˆì´ë„ˆ í˜ë¥´ì†Œë‚˜)
                const weightDiff = currentWeight - currentProfile.goalWeight;
                const goalDescription = weightDiff > 0 ? `${Math.abs(weightDiff).toFixed(1)}kg ê°ëŸ‰` : (weightDiff < 0 ? `${Math.abs(weightDiff).toFixed(1)}kg ì¦ëŸ‰` : 'í˜„ì¬ ì²´ì¤‘ ìœ ì§€');

                const contextPrompt = `ë‹¹ì‹ ì€ ì „ë¬¸ í¼ìŠ¤ë„ íŠ¸ë ˆì´ë„ˆì…ë‹ˆë‹¤. ${currentProfile.name} íšŒì›ë‹˜ì˜ ë‹¤ì´ì–´íŠ¸ë¥¼ ë‹´ë‹¹í•˜ê³  ìˆìŠµë‹ˆë‹¤.

**[íŠ¸ë ˆì´ë„ˆ í˜ë¥´ì†Œë‚˜ ì§€ì¹¨]**
- í˜¸ì¹­: ë°˜ë“œì‹œ "${currentProfile.name} íšŒì›ë‹˜"ìœ¼ë¡œ í˜¸ì¹­í•˜ì„¸ìš”
- ë§íˆ¬: ì „ë¬¸ê°€ë‹µê²Œ ì •ì¤‘í•˜ì§€ë§Œ, í•„ìš”ì‹œ ë‹¨í˜¸í•˜ê²Œ ì¡°ì–¸í•˜ì„¸ìš”
- íƒœë„: "í˜ë“  ê±° ì•Œì•„ìš”"ë¼ëŠ” ê³µê°ê³¼ "ê·¸ë˜ë„ ì•ˆ ë©ë‹ˆë‹¤"ë¼ëŠ” ì›ì¹™ì„ ë³‘í–‰í•˜ì„¸ìš”
- ì‘ë‹µ: 3-4ë¬¸ì¥ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ, ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ì„¸ìš”
- ì¤‘ìš”: íŒ©íŠ¸ë§Œ ì´ì•¼ê¸°í•˜ê³  ê³¼ì¥í•˜ì§€ ë§ˆì„¸ìš”. ë¶ˆê°€ëŠ¥í•œ ëª©í‘œëŠ” ì œì‹œí•˜ì§€ ë§ˆì„¸ìš”.

**ì‚¬ìš©ì í”„ë¡œí•„:**
- íšŒì›ëª…: ${currentProfile.name} íšŒì›ë‹˜
- ì‹œì‘ ì²´ì¤‘: ${currentProfile.startWeight}kg
- í˜„ì¬ ì²´ì¤‘: ${currentWeight}kg
- ëª©í‘œ ì²´ì¤‘: ${currentProfile.goalWeight}kg
- ëª©í‘œ: ${goalDescription}
- í•¨ê»˜í•œ ë‚ : ${daysActive}ì¼

**ì˜¤ëŠ˜ì˜ í™œë™ ê¸°ë¡:**
- ì‹ì‚¬: ${mealCount}íšŒ (${Math.round(todayIntake.calories || 0)}kcal ì„­ì·¨)
- ë‚¨ì€ ì¹¼ë¡œë¦¬: ${Math.round(caloriesRemaining)}kcal
- ë¬¼ ì„­ì·¨: ${waterIntake}ml / ${waterGoal}ml
${fastingDuration > 0 ? `- ë‹¨ì‹ ì‹œê°„: ${fastingHours}ì‹œê°„ ${fastingMinutes}ë¶„` : '- ë‹¨ì‹: ë¯¸ì§„í–‰'}

**ì˜¤ëŠ˜ì˜ ì‹ì‚¬ ë‚´ì—­:**
${meals.length > 0 ? meals.map((m, i) => `${i + 1}. ${m}`).join('\n') : 'ì•„ì§ ê¸°ë¡ëœ ì‹ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.'}

**ì£¼ê°„ ë³€í™”:**
- ì²´ì¤‘ ë³€í™” (ìµœê·¼ 7ì¼): ${weeklyWeightChange > 0 ? '-' : '+'}${Math.abs(weeklyWeightChange).toFixed(1)}kg
${weeklyWeightChange > 0 ? '(ê°ëŸ‰ ì¤‘ ğŸ‘)' : weeklyWeightChange < 0 ? '(ì¦ê°€ ì¤‘ âš ï¸)' : '(ë³€í™” ì—†ìŒ)'}

**ìµœê·¼ ëŒ€í™” ë‚´ì—­:**
${recentChatText || 'ì´ì „ ëŒ€í™” ì—†ìŒ'}

**í˜„ì¬ ì§ˆë¬¸:**
${userMessage}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì „ë¬¸ íŠ¸ë ˆì´ë„ˆì²˜ëŸ¼ ì¡°ì–¸í•´ì£¼ì„¸ìš”. ë°˜ë“œì‹œ "${currentProfile.name} íšŒì›ë‹˜"ì´ë¼ëŠ” í˜¸ì¹­ì„ ì‚¬ìš©í•˜ì„¸ìš”. êµ¬ì²´ì ì´ê³  ì‹¤ì²œ ê°€ëŠ¥í•œ ì¡°ì–¸ì„ í•´ì£¼ì„¸ìš”.`;

                return contextPrompt;

            } catch (error) {
                console.error('AI ì»¨í…ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ ì‹œ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ (íŠ¸ë ˆì´ë„ˆ í˜ë¥´ì†Œë‚˜ ìœ ì§€)
                return `ë‹¹ì‹ ì€ ì „ë¬¸ í¼ìŠ¤ë„ íŠ¸ë ˆì´ë„ˆì…ë‹ˆë‹¤. ${currentProfile.name} íšŒì›ë‹˜ì˜ ë‹¤ì´ì–´íŠ¸ë¥¼ ë‹´ë‹¹í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ "${currentProfile.name} íšŒì›ë‹˜"ìœ¼ë¡œ í˜¸ì¹­í•˜ê³ , ì „ë¬¸ê°€ë‹µê²Œ ì¡°ì–¸í•´ì£¼ì„¸ìš”.\n\ní˜„ì¬ ì§ˆë¬¸: ${userMessage}`;
            }
        }

        // í”Œëœê³¼ ì‹¤ì œ ì‹ì‚¬ ë¹„êµ
        async function comparePlanWithMeal(mealTime, nutritionData) {
            try {
                // ì‹ì‚¬ ì‹œê°„ Â±1ì‹œê°„ ë²”ìœ„ì˜ í”Œëœ ê²€ìƒ‰
                const oneHourBefore = new Date(mealTime.getTime() - 60 * 60 * 1000);
                const oneHourAfter = new Date(mealTime.getTime() + 60 * 60 * 1000);

                const plansSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('plans')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(oneHourBefore))
                    .where('date', '<=', firebase.firestore.Timestamp.fromDate(oneHourAfter))
                    .get();

                // í”Œëœì´ ì—†ìœ¼ë©´ ë¹„êµí•˜ì§€ ì•ŠìŒ
                if (plansSnapshot.empty) {
                    return null;
                }

                // ê°€ì¥ ê°€ê¹Œìš´ í”Œëœ ì°¾ê¸°
                let closestPlan = null;
                let closestDiff = Infinity;

                plansSnapshot.forEach(doc => {
                    const plan = doc.data();
                    const planTime = plan.date.toDate();
                    const diff = Math.abs(planTime.getTime() - mealTime.getTime());

                    if (diff < closestDiff) {
                        closestDiff = diff;
                        closestPlan = plan;
                    }
                });

                if (!closestPlan) return null;

                // AIì—ê²Œ ë¹„êµ ìš”ì²­ (íŠ¸ë ˆì´ë„ˆ í˜ë¥´ì†Œë‚˜ - íŒ©íŠ¸ ì²´í¬)
                const prompt = `ë‹¹ì‹ ì€ ${currentProfile.name} íšŒì›ë‹˜ì„ ë‹´ë‹¹í•˜ëŠ” ì „ë¬¸ í¼ìŠ¤ë„ íŠ¸ë ˆì´ë„ˆì…ë‹ˆë‹¤. ê³„íšê³¼ ì‹¤ì œ ì‹ì‚¬ë¥¼ ë¹„êµí•˜ì—¬ íŒ©íŠ¸ ì²´í¬í•´ì£¼ì„¸ìš”.

**ê³„íší•œ ì‹ì‚¬:** ${closestPlan.activity}
**ì‹¤ì œ ì„­ì·¨í•œ ìŒì‹:** ${nutritionData.foodName} (${Math.round(nutritionData.calories)}kcal)

**ì§€ì¹¨:**
- í˜¸ì¹­: ë°˜ë“œì‹œ "${currentProfile.name} íšŒì›ë‹˜"ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”
- ì¼ì¹˜í•˜ë©´: "ì™„ë²½í•©ë‹ˆë‹¤! ê³„íšëŒ€ë¡œ ì‹¤ì²œí•˜ì…¨ë„¤ìš”." ê°™ì€ ì¹­ì°¬ (30ì ì´ë‚´)
- ë¶ˆì¼ì¹˜í•˜ë©´: "íšŒì›ë‹˜? ê³„íšì—” [ê³„íš]ì¸ë° ì‚¬ì§„ì€ [ì‹¤ì œ]ë„¤ìš”? ì´ëŸ¬ë©´ ì•ˆ ë©ë‹ˆë‹¤." ê°™ì€ íŒ©íŠ¸ í­ê²© (50ì ì´ë‚´)
- í†¤: ì „ë¬¸ê°€ë‹µê²Œ ë§¤ì„­ì§€ë§Œ ì •ì¤‘í•˜ê²Œ

ì§§ì€ í•œ ë¬¸ì¥ìœ¼ë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”:`;

                const response = await callGeminiAPI(prompt);

                return response || 'ì˜¤ëŠ˜ë„ ì‹ì‚¬ ê¸°ë¡ ì™„ë£Œ! ğŸ‘';

            } catch (error) {
                console.error('í”Œëœ-ì‹ì‚¬ ë¹„êµ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // ==================== ìŠ¤ë§ˆíŠ¸ ë³‘í•© í•¨ìˆ˜ ====================

        // ìµœê·¼ ì‹ì‚¬ í™•ì¸ (3ì‹œê°„ ì´ë‚´)
        async function checkForRecentMeal(newMealTime) {
            try {
                const threeHoursAgo = new Date(newMealTime.getTime() - 3 * 60 * 60 * 1000);

                const recentMealsSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('category', '==', 'food')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(threeHoursAgo))
                    .orderBy('uploadedAt', 'desc')
                    .limit(1)
                    .get();

                if (recentMealsSnapshot.empty) {
                    return null;
                }

                return {
                    id: recentMealsSnapshot.docs[0].id,
                    data: recentMealsSnapshot.docs[0].data()
                };
            } catch (error) {
                console.error('ìµœê·¼ ì‹ì‚¬ í™•ì¸ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // ë³‘í•© Bottom Sheet í‘œì‹œ
        function showMergeBottomSheet(newMealData, recentMeal) {
            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (confirmMergeì™€ createNewMealì—ì„œ ì‚¬ìš©)
            pendingMealData = newMealData;
            recentMealDocId = recentMeal.id;

            // UI ì—…ë°ì´íŠ¸
            const previousNutrition = recentMeal.data.nutrition || {};
            const currentNutrition = newMealData.nutrition || {};

            document.getElementById('previousMealName').textContent = previousNutrition.foodName || 'ì•Œ ìˆ˜ ì—†ìŒ';
            document.getElementById('previousMealCal').textContent = `${Math.round(previousNutrition.calories || 0)}kcal`;

            document.getElementById('currentMealName').textContent = currentNutrition.foodName || 'ì•Œ ìˆ˜ ì—†ìŒ';
            document.getElementById('currentMealCal').textContent = `${Math.round(currentNutrition.calories || 0)}kcal`;

            const totalCalories = (previousNutrition.calories || 0) + (currentNutrition.calories || 0);
            document.getElementById('mergeTotal').textContent = `${Math.round(totalCalories)}kcal`;

            // Bottom Sheet í‘œì‹œ
            document.getElementById('mergeBottomSheet').classList.remove('hidden');
        }

        // ë³‘í•© í™•ì¸
        async function confirmMerge() {
            try {
                if (!pendingMealData || !recentMealDocId) {
                    console.error('ë³‘í•©í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ê¸°ì¡´ ì‹ì‚¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const recentMealDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(recentMealDocId).get();

                const recentData = recentMealDoc.data();
                const mergedNutrition = {
                    calories: (recentData.nutrition?.calories || 0) + (pendingMealData.nutrition?.calories || 0),
                    carbs: (recentData.nutrition?.carbs || 0) + (pendingMealData.nutrition?.carbs || 0),
                    protein: (recentData.nutrition?.protein || 0) + (pendingMealData.nutrition?.protein || 0),
                    fat: (recentData.nutrition?.fat || 0) + (pendingMealData.nutrition?.fat || 0),
                    foodName: `${recentData.nutrition?.foodName || 'ì‹ì‚¬'} + ${pendingMealData.nutrition?.foodName || 'ì‹ì‚¬'}`,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `ì´ ${Math.round((recentData.nutrition?.calories || 0) + (pendingMealData.nutrition?.calories || 0))}kcal ì„­ì·¨`
                };

                // í…ìŠ¤íŠ¸ ë³‘í•©
                const mergedText = [recentData.text, pendingMealData.text]
                    .filter(t => t)
                    .join(' + ') || null;

                // Firestore ì—…ë°ì´íŠ¸
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(recentMealDocId).update({
                        nutrition: mergedNutrition,
                        text: mergedText
                    });

                // Bottom Sheet ë‹«ê¸°
                document.getElementById('mergeBottomSheet').classList.add('hidden');

                // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
                pendingMealData = null;
                recentMealDocId = null;

                // UI ìƒˆë¡œê³ ì¹¨
                await loadAlbumTab();

                // ========== Phase 1: ì‹¤ì‹œê°„ ì˜ì–‘ ì¶”ì  (ë³‘í•©ëœ ì¶”ê°€ ì¹¼ë¡œë¦¬ë§Œ) ==========
                // ê¸°ì¡´ ì‹ì‚¬ëŠ” ì´ë¯¸ ì¹´ìš´íŠ¸ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„ë§Œ ë”í•¨
                if (pendingMealData.nutrition) {
                    addMeal('ì‹ë‹¨ ì¶”ê°€', pendingMealData.nutrition.foodName, pendingMealData.nutrition);
                }
                // ================================================================

                await refreshDashboardNutrition();

                showAIToast(`${currentProfile.name} íšŒì›ë‹˜, ì‹ì‚¬ê°€ í•©ì³ì¡ŒìŠµë‹ˆë‹¤! ğŸ˜Š`, 3000);

            } catch (error) {
                console.error('ë³‘í•© ì‹¤íŒ¨:', error);
                showErrorToast('ë³‘í•©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìƒˆ ì‹ì‚¬ë¡œ ì €ì¥
        async function createNewMeal() {
            try {
                if (!pendingMealData) {
                    console.error('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ìƒˆ ë¬¸ì„œë¡œ ì €ì¥
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').add(pendingMealData);

                // Bottom Sheet ë‹«ê¸°
                document.getElementById('mergeBottomSheet').classList.add('hidden');

                // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
                pendingMealData = null;
                recentMealDocId = null;

                // UI ìƒˆë¡œê³ ì¹¨
                await loadAlbumTab();

                // ========== Phase 1: ì‹¤ì‹œê°„ ì˜ì–‘ ì¶”ì  ==========
                if (pendingMealData.nutrition) {
                    addMeal('ì‹ë‹¨', pendingMealData.nutrition.foodName, pendingMealData.nutrition);
                }
                // ===============================================

                await refreshDashboardNutrition();

                showSuccessToast('ìƒˆ ì‹ì‚¬ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');

            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                showErrorToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ==================== í…ìŠ¤íŠ¸ ì¹´ë“œ ì…ë ¥ ====================

        // ëª¨ë˜ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° í—¬í¼
        function openModernModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        
        function closeModernModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // í…ìŠ¤íŠ¸ ì¹´ë“œ ì¶”ê°€ (ëª¨ë‹¬ ì—´ê¸°)
        function addTextCard() {
            document.getElementById('textCardInput').value = '';
            openModernModal('textCardModal');
        }
        
        // í…ìŠ¤íŠ¸ ì¹´ë“œ ì œì¶œ
        async function submitTextCard() {
            try {
                const text = document.getElementById('textCardInput').value;
                if (!text || !text.trim()) {
                    showErrorToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                // ğŸ”¥ í˜„ì¬ ì„ íƒëœ íƒ­ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ìë™ìœ¼ë¡œ ì‚¬ìš©
                let categoryValue = currentAlbumTab;
                if (categoryValue === 'all') categoryValue = 'body';
                
                closeModernModal('textCardModal');

                // í…ìŠ¤íŠ¸ ì¹´ë“œ ë°ì´í„° ìƒì„±
                const cardData = {
                    url: null,
                    category: categoryValue,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    text: text.trim()
                };

                // ì‹ë‹¨ì¸ ê²½ìš° AI ì˜ì–‘ ë¶„ì„
                let nutritionData = null;
                if (categoryValue === 'food') {
                    try {
                        nutritionData = await analyzeNutritionFromText(text);
                        if (nutritionData) {
                            cardData.nutrition = nutritionData;
                        }
                    } catch (error) {
                        console.error('í…ìŠ¤íŠ¸ ì˜ì–‘ ë¶„ì„ ì‹¤íŒ¨:', error);
                    }
                }

                // ì‹ë‹¨ì¸ ê²½ìš° ìŠ¤ë§ˆíŠ¸ ë³‘í•© ì²´í¬
                if (categoryValue === 'food' && nutritionData) {
                    const recentMeal = await checkForRecentMeal(new Date());

                    if (recentMeal) {
                        // ìµœê·¼ ì‹ì‚¬ ë°œê²¬ - ë³‘í•© Bottom Sheet í‘œì‹œ
                        showMergeBottomSheet(cardData, recentMeal);
                        return; // confirmMerge()ë‚˜ createNewMeal()ì—ì„œ ì²˜ë¦¬
                    }
                }

                // ìŠ¤ë§ˆíŠ¸ ë³‘í•© ëŒ€ìƒì´ ì•„ë‹ˆê±°ë‚˜ ì‹ë‹¨ì´ ì•„ë‹Œ ê²½ìš° ë°”ë¡œ ì €ì¥
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').add(cardData);

                // ì•¨ë²” ìƒˆë¡œê³ ì¹¨
                await loadAlbumTab();

                // ì‹ë‹¨ì¸ ê²½ìš° ëŒ€ì‹œë³´ë“œë„ ìƒˆë¡œê³ ì¹¨ ë° AI í† ìŠ¤íŠ¸ í‘œì‹œ
                if (categoryValue === 'food' && nutritionData) {
                    // ========== Phase 1: ì‹¤ì‹œê°„ ì˜ì–‘ ì¶”ì  ==========
                    addMeal('ì‹ë‹¨', nutritionData.foodName, nutritionData);
                    // ===============================================

                    await refreshDashboardNutrition();

                    // í”Œëœê³¼ ë¹„êµ (ì„ íƒì )
                    let toastMessage = nutritionData.aiAdvice || 'ì‹ì‚¬ê°€ ê¸°ë¡ë˜ì—ˆì–´ìš”!';
                    try {
                        const comparisonResult = await comparePlanWithMeal(new Date(), nutritionData);
                        if (comparisonResult) {
                            toastMessage = comparisonResult;
                        }
                    } catch (error) {
                        console.error('í”Œëœ ë¹„êµ ì‹¤íŒ¨:', error);
                    }

                    showAIToast(toastMessage, 6000);
                } else {
                    showSuccessToast('í…ìŠ¤íŠ¸ ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }

            } catch (error) {
                console.error('í…ìŠ¤íŠ¸ ì¹´ë“œ ì¶”ê°€ ì‹¤íŒ¨:', error);
                showErrorToast('í…ìŠ¤íŠ¸ ì¹´ë“œ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ==================== ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ ====================
        function showAuth() {
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('auth').classList.remove('hidden');
        }
        
        // ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œ (onclick ì´ë²¤íŠ¸ìš© - ì´ë¯¸ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ë¶€ë¶„ì—ì„œ ì •ì˜ë¨)
        if (!window.showAuth) {
            window.showAuth = showAuth;
        }
        
        function showAuth() {
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('auth').classList.remove('hidden');
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            document.getElementById('authTitle').textContent = isSignUp ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸';
            document.getElementById('authButtonText').textContent = isSignUp ? 'ê°€ì…í•˜ê¸°' : 'ë¡œê·¸ì¸';
            document.getElementById('authToggleText').textContent = isSignUp ? 'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸' : 'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…';
            document.getElementById('signupFields').style.display = isSignUp ? 'block' : 'none';
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                if (isSignUp) {
                    const displayName = document.getElementById('displayName').value;
                    const goalWeight = parseFloat(document.getElementById('goalWeight').value);
                    const startWeight = parseFloat(document.getElementById('startWeight').value);

                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName });

                    await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(userCredential.user.uid).set({
                        name: displayName,
                        email: email,
                        goalWeight: goalWeight,
                        age: age,
                        height: height,
                        gender: gender,
                        targetDate: targetDate,
                        activityLevel: activityLevel,
                        goal: goal,
                        startWeight: startWeight,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showSuccessMessage('íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ ì¤‘...');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                showErrorMessage(getErrorMessage(error.code));
            }
        });

        function showErrorMessage(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        function showSuccessMessage(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.classList.add('show');
            setTimeout(() => successDiv.classList.remove('show'), 3000);
        }

        function getErrorMessage(code) {
            const messages = {
                'auth/email-already-in-use': 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.',
                'auth/invalid-email': 'ì˜ëª»ëœ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.',
                'auth/weak-password': 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.',
                'auth/user-not-found': 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì…ë‹ˆë‹¤.',
                'auth/wrong-password': 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'
            };
            return messages[code] || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        }

        // ==================== Firebase Auth State Listener ====================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("ë¡œê·¸ì¸ ì„±ê³µ:", user.email);
                currentUser = user;

                // ì‚¬ìš© ê°€ëŠ¥í•œ Gemini ëª¨ë¸ ëª©ë¡ ì¡°íšŒ (ë””ë²„ê¹…ìš©)
                listAvailableModels().catch(err => console.error('ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', err));

                try {
                    // 1. ì˜›ë‚  ë°ì´í„° ìœ„ì¹˜ í™•ì¸ (profile/main)
                    const oldDoc = await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(user.uid)
                        .collection('profile').doc('main').get();

                    // 2. ìƒˆ ë°ì´í„° ìœ„ì¹˜ í™•ì¸ (users/uid)
                    const newDoc = await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(user.uid).get();

                    let profileData = {
                        name: user.displayName || 'ê²ŒìŠ¤íŠ¸',  // âœ… ìˆ˜ì •: 'íšŒì›' â†’ 'ê²ŒìŠ¤íŠ¸'
                        goalWeight: 0,
                        startWeight: 0,
                        createdAt: firebase.firestore.Timestamp.now()
                    };

                    // 3. ë°ì´í„° í•©ì¹˜ê¸° (ì˜›ë‚  ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ì ìš©)
                    if (oldDoc.exists) {
                        const old = oldDoc.data();
                        profileData.name = old.name || old.displayName || profileData.name;
                        profileData.goalWeight = parseFloat(old.targetWeight || old.goalWeight) || 0;
                        profileData.startWeight = parseFloat(old.startWeight || old.startweight) || 0;
                    }

                    if (newDoc.exists) {
                        const curr = newDoc.data();
                        if (curr.name) profileData.name = curr.name;
                        if (curr.goalWeight) profileData.goalWeight = parseFloat(curr.goalWeight) || 0;
                        if (curr.startWeight) profileData.startWeight = parseFloat(curr.startWeight) || 0;
                        // ìƒˆ í•„ë“œ ë¡œë“œ (ë‚˜ì´, í‚¤, ì„±ë³„, ëª©í‘œì¼, í™œë™ëŸ‰)
                        if (curr.age) profileData.age = parseInt(curr.age) || null;
                        if (curr.height) profileData.height = parseFloat(curr.height) || null;
                        if (curr.gender) profileData.gender = curr.gender;
                        if (curr.targetDate) profileData.targetDate = curr.targetDate;
                        if (curr.activityLevel) profileData.activityLevel = curr.activityLevel;
                        if (curr.goal) profileData.goal = curr.goal;
                        // v3.3.0: ê³¼í•™ì  ì¹¼ë¡œë¦¬ ê³„ì‚° ê°’ ë¡œë“œ
                        if (curr.calculatedCalories) profileData.calculatedCalories = parseInt(curr.calculatedCalories) || null;
                        if (curr.calculatedMacros) profileData.calculatedMacros = curr.calculatedMacros;
                        if (curr.bmr) profileData.bmr = parseInt(curr.bmr) || null;
                        if (curr.tdee) profileData.tdee = parseInt(curr.tdee) || null;
                    }

                    // ========== ğŸ”¥ ìë™ ë³µêµ¬ ë° ë§ˆì´ê·¸ë ˆì´ì…˜ ==========
                    // âš ï¸ ì£¼ì˜: í”„ë¡œí•„ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ ë³µêµ¬ ì‹œë„
                    let needsUpdate = false;
                    let updateData = {};

                    // ì‹œì‘ ì²´ì¤‘ ë³µêµ¬ (logsì—ì„œ) - í”„ë¡œí•„ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ
                    if (newDoc.exists && (!profileData.startWeight || profileData.startWeight === 0)) {
                        console.log("âš ï¸ ì‹œì‘ ì²´ì¤‘ì´ ì—†ìŒ. logsì—ì„œ ë³µêµ¬ ì‹œë„...");

                        const firstLog = await db.collection('artifacts')
                            .doc('diet-mate-v2')
                            .collection('users').doc(user.uid)
                            .collection('logs')
                            .orderBy('date', 'asc')
                            .limit(1).get();

                        if (!firstLog.empty) {
                            profileData.startWeight = parseFloat(firstLog.docs[0].data().weight) || 0;
                            updateData.startWeight = profileData.startWeight;
                            needsUpdate = true;
                            console.log("âœ… ì‹œì‘ ì²´ì¤‘ ë³µêµ¬:", profileData.startWeight, "kg");
                        }
                    }

                    // ëª©í‘œ ì²´ì¤‘ ë³µêµ¬ (profile/main ë˜ëŠ” targetWeightì—ì„œ) - í”„ë¡œí•„ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ
                    if (newDoc.exists && (!profileData.goalWeight || profileData.goalWeight === 0)) {
                        console.log("âš ï¸ ëª©í‘œ ì²´ì¤‘ì´ ì—†ìŒ. ë³µêµ¬ ì‹œë„...");

                        // oldDocì—ì„œ ì´ë¯¸ í™•ì¸í–ˆìœ¼ë‹ˆ ì¬ì‚¬ìš©
                        if (oldDoc.exists) {
                            const old = oldDoc.data();
                            profileData.goalWeight = parseFloat(old.targetWeight || old.goalWeight) || 0;

                            if (profileData.goalWeight > 0) {
                                updateData.goalWeight = profileData.goalWeight;
                                needsUpdate = true;
                                console.log("âœ… ëª©í‘œ ì²´ì¤‘ ë³µêµ¬ (profile/main):", profileData.goalWeight, "kg");
                            }
                        }

                        // í˜„ì¬ ë¬¸ì„œì˜ targetWeight í™•ì¸
                        if (profileData.goalWeight === 0 && newDoc.exists) {
                            const curr = newDoc.data();
                            profileData.goalWeight = parseFloat(curr.targetWeight) || 0;

                            if (profileData.goalWeight > 0) {
                                updateData.goalWeight = profileData.goalWeight;
                                needsUpdate = true;
                                console.log("âœ… ëª©í‘œ ì²´ì¤‘ ë³µêµ¬ (targetWeight):", profileData.goalWeight, "kg");
                            }
                        }
                    }

                    // ê¸°ë³¸ ì •ë³´ í™•ë³´
                    if (!updateData.name && profileData.name) {
                        updateData.name = profileData.name;
                    }
                    if (!updateData.email && user.email) {
                        updateData.email = user.email;
                    }

                    // Firebaseì— ì €ì¥ (ë³µêµ¬ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´)
                    if (needsUpdate && Object.keys(updateData).length > 0) {
                        console.log("ğŸ’¾ ë³µêµ¬ëœ ë°ì´í„°ë¥¼ Firebaseì— ì €ì¥:", updateData);

                        await db.collection('artifacts')
                            .doc('diet-mate-v2')
                            .collection('users')
                            .doc(user.uid)
                            .set(updateData, { merge: true });

                        console.log("âœ… í”„ë¡œí•„ ìë™ ë³µêµ¬ ì™„ë£Œ!");
                    }
                    // ========== ìë™ ë³µêµ¬ ë ==========

                    currentProfile = profileData;

                    // ========== ğŸ”¥ ê¸°ì¡´ ì‚¬ìš©ì ì¹¼ë¡œë¦¬ ìë™ ê³„ì‚° (v3.3.1) ==========
                    if (!currentProfile.calculatedCalories && currentProfile.age && currentProfile.height && currentProfile.startWeight) {
                        console.log('âš ï¸ ê¸°ì¡´ í”„ë¡œí•„ì— calculatedCalories ì—†ìŒ. ìë™ ê³„ì‚°...');
                        
                        // BMR ê³„ì‚°
                        let bmr;
                        if (currentProfile.gender === 'male') {
                            bmr = 10 * currentProfile.startWeight + 6.25 * currentProfile.height - 5 * currentProfile.age + 5;
                        } else {
                            bmr = 10 * currentProfile.startWeight + 6.25 * currentProfile.height - 5 * currentProfile.age - 161;
                        }
                        
                        // TDEE ê³„ì‚°
                        const activityMultipliers = { sedentary: 1.2, light: 1.375, moderate: 1.55, active: 1.725, veryActive: 1.9 };
                        const tdee = Math.round(bmr * (activityMultipliers[currentProfile.activityLevel] || 1.55));
                        
                        // ì£¼ê°„ ê°ëŸ‰ ëª©í‘œ ê¸°ë°˜ ì ì ê³„ì‚°
                        const weightDiff = currentProfile.startWeight - (currentProfile.goalWeight || currentProfile.startWeight);
                        const weeksRemaining = 12; // ê¸°ë³¸ 12ì£¼
                        const weeklyGoalKg = Math.min(1, Math.max(0.25, weightDiff / weeksRemaining));
                        const dailyDeficit = Math.round((weeklyGoalKg * 7700) / 7);
                        
                        // ëª©í‘œ ì¹¼ë¡œë¦¬ (ìµœì†Œ 1200)
                        const calculatedCalories = Math.max(1200, tdee - dailyDeficit);
                        const calculatedMacros = {
                            carbs: Math.round(calculatedCalories * 0.5 / 4),
                            protein: Math.round(calculatedCalories * 0.3 / 4),
                            fat: Math.round(calculatedCalories * 0.2 / 9)
                        };
                        
                        // currentProfile ì—…ë°ì´íŠ¸
                        currentProfile.calculatedCalories = calculatedCalories;
                        currentProfile.calculatedMacros = calculatedMacros;
                        currentProfile.bmr = Math.round(bmr);
                        currentProfile.tdee = tdee;
                        
                        // localStorageì—ë„ ì €ì¥
                        localStorage.setItem('goal_calories_target', calculatedCalories);
                        localStorage.setItem('goal_carbs_target', calculatedMacros.carbs);
                        localStorage.setItem('goal_protein_target', calculatedMacros.protein);
                        localStorage.setItem('goal_fat_target', calculatedMacros.fat);
                        
                        // Firebaseì— ì €ì¥
                        await db.collection('artifacts').doc('diet-mate-v2')
                            .collection('users').doc(user.uid)
                            .set({
                                calculatedCalories: calculatedCalories,
                                calculatedMacros: calculatedMacros,
                                bmr: Math.round(bmr),
                                tdee: tdee
                            }, { merge: true });
                        
                        console.log('âœ… ê¸°ì¡´ í”„ë¡œí•„ ì¹¼ë¡œë¦¬ ìë™ ê³„ì‚° ì™„ë£Œ:', calculatedCalories, 'kcal');
                    }
                    // ========== ìë™ ê³„ì‚° ë ==========

                    // ========== ğŸ”¥ v3.9.3: í”„ë¡œí•„ ê²€ì¦ ê°œì„  ==========
                    // ì™„ì „íˆ ìƒˆë¡œìš´ ì‚¬ìš©ìë§Œ ì˜¨ë³´ë”© í‘œì‹œ
                    const isNewUser = !newDoc.exists && !oldDoc.exists; // í”„ë¡œí•„ ë¬¸ì„œê°€ ì•„ì˜ˆ ì—†ìŒ
                    
                    console.log('ğŸ” í”„ë¡œí•„ ê²€ì¦:', {
                        isNewUser,
                        hasNewDoc: newDoc.exists,
                        hasOldDoc: oldDoc.exists,
                        name: currentProfile.name,
                        startWeight: currentProfile.startWeight,
                        goalWeight: currentProfile.goalWeight
                    });
                    
                    // ğŸ”¥ ì˜¤ì§ ì™„ì „íˆ ìƒˆë¡œìš´ ì‚¬ìš©ìë§Œ ì˜¨ë³´ë”© í‘œì‹œ
                    if (isNewUser) {
                        console.warn('âš ï¸ ì™„ì „íˆ ìƒˆë¡œìš´ ì‚¬ìš©ìì…ë‹ˆë‹¤. ì˜¨ë³´ë”© í‘œì‹œ');

                        document.getElementById('landing').classList.add('hidden');
                        document.getElementById('auth').classList.add('hidden');
                        document.getElementById('dashboard').classList.add('hidden');

                        setTimeout(() => {
                            showInitialProfileSetup();
                        }, 100); // ì§€ì—° ì‹œê°„ ë‹¨ì¶•
                        return;
                    }
                    
                    // ğŸ”¥ ê¸°ì¡´ ì‚¬ìš©ìëŠ” ë¬´ì¡°ê±´ ëŒ€ì‹œë³´ë“œë¡œ ì§„ì…
                    console.log('âœ… ê¸°ì¡´ ì‚¬ìš©ì í™•ì¸. ëŒ€ì‹œë³´ë“œë¡œ ì´ë™:', currentProfile);
                    // ========================================

                    // ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
                    document.getElementById('landing').classList.add('hidden');
                    document.getElementById('auth').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    await initializeDashboard();

                } catch (error) {
                    console.error('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', error);

                    // ğŸ”¥ í”„ë¡œí•„ì´ ì‹¤ì œë¡œ ì—†ëŠ” ê²½ìš°ì—ë§Œ í”„ë¡œí•„ ì„¤ì • í‘œì‹œ
                    // initializeDashboard ì‹¤í–‰ ì¤‘ ë°œìƒí•œ ì—ëŸ¬ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
                    if (!currentProfile || !currentProfile.name) {
                        console.warn('âš ï¸ í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œí•„ ì„¤ì • í™”ë©´ í‘œì‹œ');
                        document.getElementById('landing').classList.add('hidden');
                        document.getElementById('auth').classList.add('hidden');
                        document.getElementById('dashboard').classList.add('hidden');

                        setTimeout(() => {
                            showInitialProfileSetup();
                        }, 500);
                    } else {
                        console.warn('âš ï¸ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì¤‘ ì—ëŸ¬ ë°œìƒí–ˆì§€ë§Œ í”„ë¡œí•„ì€ ìˆìœ¼ë¯€ë¡œ ê³„ì† ì§„í–‰');
                        // í”„ë¡œí•„ì€ ìˆìœ¼ë¯€ë¡œ ëŒ€ì‹œë³´ë“œ í‘œì‹œ
                        document.getElementById('landing').classList.add('hidden');
                        document.getElementById('auth').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                    }
                }
            } else {
                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                currentUser = null;
                currentProfile = null;
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('auth').classList.add('hidden');
                document.getElementById('landing').classList.remove('hidden');
            }
        });


        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                auth.signOut();
                location.reload();
            }
        }

        // ==================== ìƒˆë¡œìš´ ì „ì²´ í™”ë©´ ì˜¨ë³´ë”© ====================
        let obCurrentStep = 1;
        const obTotalSteps = 10;
        
        // ì˜¨ë³´ë”© ë°ì´í„°
        let obData = {
            name: '',
            age: 26,
            gender: '',
            height: 170,
            currentWeight: 70,
            goalWeight: 65,
            lossRate: 0.5,
            activityLevel: 'moderate'
        };
        
        // í™œë™ëŸ‰ ë ˆë²¨ ì •ë³´
        const activityLevels = [
            { value: 'sedentary', label: 'ê±°ì˜ ì—†ìŒ', desc: 'ì£¼ë¡œ ì•‰ì•„ì„œ ìƒí™œ', icon: 'ğŸª‘' },
            { value: 'light', label: 'ê°€ë²¼ì›€', desc: 'ê°€ë²¼ìš´ ìš´ë™ 1-3íšŒ/ì£¼', icon: 'ğŸš¶' },
            { value: 'moderate', label: 'ë³´í†µ', desc: 'êµì‚¬, íŒë§¤ì§', icon: 'ğŸ“Š' },
            { value: 'active', label: 'í™œë™ì ', desc: 'ë§ì´ ê±·ëŠ” ì§ì—…', icon: 'ğŸƒ' },
            { value: 'veryActive', label: 'ë§¤ìš° í™œë™ì ', desc: 'ìœ¡ì²´ ë…¸ë™, ìš´ë™ì„ ìˆ˜', icon: 'ğŸ’ª' }
        ];
        
        // ê°ëŸ‰ ì†ë„ ë ˆë²¨
        const lossRateLevels = [
            { value: 0.25, label: 'ì²œì²œíˆ' },
            { value: 0.4, label: 'ì•½ê°„ ëŠë¦¬ê²Œ' },
            { value: 0.5, label: 'ì ë‹¹íˆ' },
            { value: 0.75, label: 'ë¹ ë¥´ê²Œ' },
            { value: 1.0, label: 'ë§¤ìš° ë¹ ë¥´ê²Œ' }
        ];

        function showInitialProfileSetup() {
            console.log('ğŸ¯ ìƒˆë¡œìš´ ì „ì²´ í™”ë©´ ì˜¨ë³´ë”© ì‹œì‘!');
            
            const onboarding = document.getElementById('fullscreenOnboarding');
            if (!onboarding) {
                console.error('âŒ ì˜¨ë³´ë”© UIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì˜¨ë³´ë”© ì´ˆê¸°í™”
            obCurrentStep = 1;
            obData = {
                name: '',
                age: 26,
                gender: '',
                height: 170,
                currentWeight: 70,
                goalWeight: 65,
                lossRate: 0.5,
                activityLevel: 'moderate',
                targetDate: null
            };
            
            // UI ì´ˆê¸°í™”
            initializeAgePicker();
            initializeRulerSliders();
            initializeLevelSliders();
            
            // ğŸ”¥ ë‹¤ë¥¸ í™”ë©´ë“¤ ìˆ¨ê¸°ê¸°
            const landing = document.getElementById('landing');
            const authScreen = document.getElementById('auth');
            const dashboard = document.getElementById('dashboard');
            if (landing) landing.classList.add('hidden');
            if (authScreen) authScreen.classList.add('hidden');
            if (dashboard) dashboard.classList.add('hidden');
            
            // ğŸ”¥ ì˜¨ë³´ë”©ì„ body ë§¨ ë’¤ë¡œ ì´ë™ (z-index ë¬¸ì œ í•´ê²°)
            document.body.appendChild(onboarding);
            
            // ğŸ”¥ ê°•ì œ ìŠ¤íƒ€ì¼ ì ìš©
            onboarding.classList.add('show');
            onboarding.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: #ffffff !important;
                z-index: 2147483647 !important;
                flex-direction: column !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            document.body.style.overflow = 'hidden';
            
            // ì²« ë²ˆì§¸ ë‹¨ê³„ í‘œì‹œ
            showObStep(1);
            updateObProgress();
            
            console.log('ğŸ‰ ì˜¨ë³´ë”© UI í‘œì‹œ ì™„ë£Œ!');
            console.log('ğŸ“ ì˜¨ë³´ë”© display:', window.getComputedStyle(onboarding).display);
        }
        
        // ==================== Diet Mate ë…ì°½ì  ì…ë ¥ ì‹œìŠ¤í…œ ====================
        
        // ë‹¨ìœ„ ì„¤ì •
        let heightUnit = 'cm'; // cm or ft
        let weightUnit = 'kg'; // kg or lb
        
        // ìŠ¬ë¼ì´ë” ìƒíƒœ
        const sliderState = {
            height: { value: 170.0, min: 130, max: 220, isDragging: false, startX: 0, startValue: 0 },
            currentWeight: { value: 70.0, min: 30, max: 200, isDragging: false, startX: 0, startValue: 0 },
            goalWeight: { value: 65.0, min: 30, max: 200, isDragging: false, startX: 0, startValue: 0 }
        };
        
        // ë‚˜ì´ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
        function initializeAgePicker() {
            const grid = document.getElementById('ageGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // 10-80ì„¸ ê·¸ë¦¬ë“œ ìƒì„±
            for (let age = 10; age <= 80; age++) {
                const item = document.createElement('div');
                item.className = 'dm-age-item';
                item.textContent = age;
                item.dataset.age = age;
                if (age === obData.age) item.classList.add('selected');
                item.onclick = () => selectAge(age);
                grid.appendChild(item);
            }
            
            // ì„ íƒëœ ë‚˜ì´ë¡œ ìŠ¤í¬ë¡¤
            setTimeout(() => {
                const selectedItem = grid.querySelector('.selected');
                if (selectedItem) {
                    selectedItem.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }
            }, 100);
        }
        
        function selectAge(age) {
            obData.age = age;
            document.getElementById('ageDisplay').textContent = age;
            
            document.querySelectorAll('.dm-age-item').forEach(item => {
                item.classList.toggle('selected', parseInt(item.dataset.age) === age);
            });
        }
        
        function toggleAgeInput() {
            const display = document.getElementById('ageDisplay');
            const currentAge = obData.age;
            
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'dm-value-input';
            input.value = currentAge;
            input.min = 10;
            input.max = 80;
            
            display.replaceWith(input);
            input.focus();
            input.select();
            
            const finishInput = () => {
                let newAge = parseInt(input.value) || 26;
                newAge = Math.max(10, Math.min(80, newAge));
                selectAge(newAge);
                
                const newDisplay = document.createElement('span');
                newDisplay.className = 'dm-value-main';
                newDisplay.id = 'ageDisplay';
                newDisplay.textContent = newAge;
                newDisplay.onclick = toggleAgeInput;
                input.replaceWith(newDisplay);
            };
            
            input.onblur = finishInput;
            input.onkeydown = (e) => { if (e.key === 'Enter') finishInput(); };
        }
        
        // í„°ì¹˜ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
        function initializeRulerSliders() {
            createDMSlider('heightTrack', 'height', 'heightDisplay');
            createDMSlider('currentWeightTrack', 'currentWeight', 'obCurrentWeightDisplay');
            createDMSlider('goalWeightTrack', 'goalWeight', 'obGoalWeightDisplay');
        }
        
        function createDMSlider(trackId, stateKey, displayId) {
            const track = document.getElementById(trackId);
            if (!track) return;
            
            const state = sliderState[stateKey];
            track.innerHTML = '';
            
            // ëˆˆê¸ˆ ìƒì„± (0.1 ë‹¨ìœ„ë¡œ 1000ê°œ ì´ìƒì˜ ëˆˆê¸ˆ)
            const range = state.max - state.min;
            const tickCount = range * 10; // 0.1 ë‹¨ìœ„
            
            for (let i = 0; i <= tickCount; i++) {
                const tick = document.createElement('div');
                tick.className = 'dm-slider-tick';
                
                const value = state.min + (i / 10);
                if (i % 10 === 0) {
                    tick.classList.add('major');
                } else if (i % 5 === 0) {
                    tick.style.height = '30px';
                } else {
                    tick.classList.add('minor');
                }
                
                track.appendChild(tick);
            }
            
            // í„°ì¹˜/ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
            track.addEventListener('mousedown', (e) => startSliderDrag(e, stateKey, displayId));
            track.addEventListener('touchstart', (e) => startSliderDrag(e, stateKey, displayId), { passive: false });
            
            document.addEventListener('mousemove', (e) => moveSliderDrag(e, stateKey, displayId));
            document.addEventListener('touchmove', (e) => moveSliderDrag(e, stateKey, displayId), { passive: false });
            
            document.addEventListener('mouseup', () => endSliderDrag(stateKey));
            document.addEventListener('touchend', () => endSliderDrag(stateKey));
            
            // ì´ˆê¸° ìœ„ì¹˜
            setTimeout(() => {
                setSliderPosition(trackId, stateKey, state.value);
                updateSliderDisplay(stateKey, displayId);
            }, 100);
        }
        
        function startSliderDrag(e, stateKey, displayId) {
            e.preventDefault();
            const state = sliderState[stateKey];
            state.isDragging = true;
            state.startX = e.touches ? e.touches[0].clientX : e.clientX;
            state.startValue = state.value;
            
            const track = document.getElementById(stateKey === 'height' ? 'heightTrack' : 
                          stateKey === 'currentWeight' ? 'currentWeightTrack' : 'goalWeightTrack');
            if (track) track.style.cursor = 'grabbing';
        }
        
        function moveSliderDrag(e, stateKey, displayId) {
            const state = sliderState[stateKey];
            if (!state.isDragging) return;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const diff = state.startX - clientX;
            
            // í”½ì…€ë‹¹ 0.1 ë‹¨ìœ„ ì´ë™ (10px = 1 ë‹¨ìœ„)
            const valueDiff = diff / 10;
            let newValue = state.startValue + valueDiff;
            
            // ë²”ìœ„ ì œí•œ
            newValue = Math.max(state.min, Math.min(state.max, newValue));
            
            // 0.1 ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼
            state.value = Math.round(newValue * 10) / 10;
            
            // ë°ì´í„° ì—…ë°ì´íŠ¸
            if (stateKey === 'height') obData.height = state.value;
            else if (stateKey === 'currentWeight') obData.currentWeight = state.value;
            else if (stateKey === 'goalWeight') obData.goalWeight = state.value;
            
            updateSliderDisplay(stateKey, displayId);
            
            // íŠ¸ë™ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            const trackId = stateKey === 'height' ? 'heightTrack' : 
                           stateKey === 'currentWeight' ? 'currentWeightTrack' : 'goalWeightTrack';
            setSliderPosition(trackId, stateKey, state.value);
        }
        
        function endSliderDrag(stateKey) {
            const state = sliderState[stateKey];
            state.isDragging = false;
            
            const track = document.getElementById(stateKey === 'height' ? 'heightTrack' : 
                          stateKey === 'currentWeight' ? 'currentWeightTrack' : 'goalWeightTrack');
            if (track) track.style.cursor = 'grab';
        }
        
        function setSliderPosition(trackId, stateKey, value) {
            const track = document.getElementById(trackId);
            if (!track) return;
            
            const state = sliderState[stateKey];
            const range = state.max - state.min;
            const percent = (value - state.min) / range;
            
            // íŠ¸ë™ ì´ë™ (ì¤‘ì•™ ê¸°ì¤€)
            const tickWidth = 10; // 2px + 4px margin * 2
            const totalWidth = range * 10 * tickWidth;
            const offset = percent * totalWidth;
            
            track.style.transform = `translateX(${-offset}px)`;
        }
        
        function updateSliderDisplay(stateKey, displayId) {
            const state = sliderState[stateKey];
            const display = document.getElementById(displayId);
            if (!display) return;
            
            let displayValue = state.value;
            
            // ë‹¨ìœ„ ë³€í™˜
            if (stateKey === 'height' && heightUnit === 'ft') {
                // cm to ft/in
                const totalInches = state.value / 2.54;
                const feet = Math.floor(totalInches / 12);
                const inches = Math.round(totalInches % 12);
                display.textContent = `${feet}'${inches}"`;
                return;
            } else if ((stateKey === 'currentWeight' || stateKey === 'goalWeight') && weightUnit === 'lb') {
                displayValue = Math.round(state.value * 2.205 * 10) / 10;
            }
            
            display.textContent = displayValue.toFixed(1);
        }
        
        // ì§ì ‘ ì…ë ¥ í† ê¸€
        function toggleHeightInput() {
            const display = document.getElementById('heightDisplay');
            const currentValue = sliderState.height.value;
            
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'dm-value-input';
            input.value = heightUnit === 'cm' ? currentValue : Math.round(currentValue / 2.54);
            input.step = '0.1';
            
            display.replaceWith(input);
            input.focus();
            input.select();
            
            const finishInput = () => {
                let newValue = parseFloat(input.value) || 170;
                if (heightUnit === 'ft') newValue = newValue * 2.54; // ft inputì„ cmë¡œ ë³€í™˜
                newValue = Math.max(130, Math.min(220, newValue));
                
                sliderState.height.value = newValue;
                obData.height = newValue;
                
                const newDisplay = document.createElement('span');
                newDisplay.className = 'dm-value-main';
                newDisplay.id = 'heightDisplay';
                newDisplay.onclick = toggleHeightInput;
                input.replaceWith(newDisplay);
                
                updateSliderDisplay('height', 'heightDisplay');
                setSliderPosition('heightTrack', 'height', newValue);
            };
            
            input.onblur = finishInput;
            input.onkeydown = (e) => { if (e.key === 'Enter') finishInput(); };
        }
        
        function toggleWeightInput(type) {
            const displayId = type === 'current' ? 'obCurrentWeightDisplay' : 'obGoalWeightDisplay';
            const stateKey = type === 'current' ? 'currentWeight' : 'goalWeight';
            const display = document.getElementById(displayId);
            const currentValue = sliderState[stateKey].value;
            
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'dm-value-input';
            input.value = weightUnit === 'kg' ? currentValue : Math.round(currentValue * 2.205);
            input.step = '0.1';
            
            display.replaceWith(input);
            input.focus();
            input.select();
            
            const finishInput = () => {
                let newValue = parseFloat(input.value) || 70;
                if (weightUnit === 'lb') newValue = newValue / 2.205; // lbë¥¼ kgë¡œ ë³€í™˜
                newValue = Math.max(30, Math.min(200, newValue));
                
                sliderState[stateKey].value = newValue;
                if (stateKey === 'currentWeight') obData.currentWeight = newValue;
                else obData.goalWeight = newValue;
                
                const newDisplay = document.createElement('span');
                newDisplay.className = 'dm-value-main';
                newDisplay.id = displayId;
                newDisplay.onclick = () => toggleWeightInput(type);
                input.replaceWith(newDisplay);
                
                updateSliderDisplay(stateKey, displayId);
                const trackId = type === 'current' ? 'currentWeightTrack' : 'goalWeightTrack';
                setSliderPosition(trackId, stateKey, newValue);
            };
            
            input.onblur = finishInput;
            input.onkeydown = (e) => { if (e.key === 'Enter') finishInput(); };
        }
        
        // ë‹¨ìœ„ í† ê¸€ í•¨ìˆ˜
        function toggleHeightUnit(unit) {
            heightUnit = unit;
            
            document.getElementById('heightFtBtn').classList.toggle('active', unit === 'ft');
            document.getElementById('heightCmBtn').classList.toggle('active', unit === 'cm');
            document.getElementById('heightUnitLabel').textContent = unit;
            
            updateSliderDisplay('height', 'heightDisplay');
        }
        
        function toggleWeightUnit(unit) {
            weightUnit = unit;
            
            document.getElementById('weightLbBtn').classList.toggle('active', unit === 'lb');
            document.getElementById('weightKgBtn').classList.toggle('active', unit === 'kg');
            
            const obCurrentUnitLabel = document.getElementById('obCurrentWeightUnitLabel');
            if (obCurrentUnitLabel) obCurrentUnitLabel.textContent = unit;
            const obGoalUnitLabel = document.getElementById('obGoalWeightUnitLabel');
            if (obGoalUnitLabel) obGoalUnitLabel.textContent = unit;
            
            updateSliderDisplay('currentWeight', 'obCurrentWeightDisplay');
            updateSliderDisplay('goalWeight', 'obGoalWeightDisplay');
        }
        
        // ëª©í‘œ ë‚ ì§œ ê´€ë ¨ í•¨ìˆ˜
        function openDatePicker() {
            const input = document.getElementById('targetDateInput');
            input.showPicker ? input.showPicker() : input.click();
        }
        
        function updateTargetDate(dateStr) {
            if (!dateStr) return;
            
            const targetDate = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 7) {
                alert('ëª©í‘œ ë‚ ì§œëŠ” ìµœì†Œ 1ì£¼ì¼ ì´í›„ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            obData.targetDate = dateStr;
            
            // D-Day í‘œì‹œ ì—…ë°ì´íŠ¸
            const ddayEl = document.getElementById('targetDdayNumber');
            if (ddayEl) ddayEl.textContent = `D-${diffDays}`;
            
            // ê¶Œì¥ ê°ëŸ‰ ì†ë„ ê³„ì‚°
            const weightDiff = obData.currentWeight - obData.goalWeight;
            const weeks = Math.ceil(diffDays / 7);
            const weeklyRate = (weightDiff / weeks).toFixed(2);
            obData.lossRate = Math.min(1, Math.max(0.25, parseFloat(weeklyRate)));
        }
        
        function setTargetWeeks(weeks) {
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + (weeks * 7));
            
            const dateStr = targetDate.toISOString().split('T')[0];
            document.getElementById('targetDateInput').value = dateStr;
            updateTargetDate(dateStr);
        }
        
        function initializeTargetDate() {
            // ê¸°ë³¸ê°’: 8ì£¼ í›„
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + 56);
            
            const dateStr = targetDate.toISOString().split('T')[0];
            const input = document.getElementById('targetDateInput');
            if (input) {
                // ìµœì†Œ ë‚ ì§œ ì„¤ì • (1ì£¼ì¼ í›„)
                const minDate = new Date();
                minDate.setDate(minDate.getDate() + 7);
                input.min = minDate.toISOString().split('T')[0];
                input.value = dateStr;
            }
            updateTargetDate(dateStr);
        }
        
        // í™œë™ëŸ‰ ì„ íƒ (ì¹´ë“œ ë°©ì‹)
        function selectActivity(level) {
            obData.activityLevel = level;
            
            document.querySelectorAll('.dm-activity-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.level === level);
            });
        }
        
        // ë ˆë²¨ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        function initializeLevelSliders() {
            // ë ˆê±°ì‹œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
        }
        
        function setupLevelSlider(sliderId, thumbId, onChange) {
            const slider = document.getElementById(sliderId);
            const thumb = document.getElementById(thumbId);
            if (!slider || !thumb) return;
            
            let isDragging = false;
            
            const updatePosition = (e) => {
                if (!isDragging) return;
                
                const rect = slider.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                let percent = (clientX - rect.left) / rect.width;
                percent = Math.max(0, Math.min(1, percent));
                
                const snappedPercent = Math.round(percent * 4) / 4;
                thumb.style.left = (snappedPercent * 100) + '%';
                
                onChange(snappedPercent);
            };
            
            thumb.addEventListener('mousedown', () => isDragging = true);
            thumb.addEventListener('touchstart', () => isDragging = true);
            document.addEventListener('mousemove', updatePosition);
            document.addEventListener('touchmove', updatePosition);
            document.addEventListener('mouseup', () => isDragging = false);
            document.addEventListener('touchend', () => isDragging = false);
            
            slider.addEventListener('click', (e) => {
                isDragging = true;
                updatePosition(e);
                isDragging = false;
            });
        }
        
        // ì„±ë³„ ì„ íƒ
        function selectObGender(gender) {
            obData.gender = gender;
            document.querySelectorAll('.gender-item').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.value === gender);
            });
        }
        
        // ë‹¨ê³„ í‘œì‹œ
        function showObStep(step) {
            console.log(`ğŸ“ showObStep(${step}) í˜¸ì¶œ`);
            
            for (let i = 1; i <= obTotalSteps; i++) {
                const stepEl = document.getElementById(`obStep${i}`);
                if (stepEl) {
                    stepEl.style.display = i === step ? 'flex' : 'none';
                    if (i === step) {
                        console.log(`âœ… Step ${i} í‘œì‹œë¨:`, stepEl);
                    }
                } else {
                    console.warn(`âš ï¸ obStep${i} ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                }
            }
            
            // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
            const backBtn = document.querySelector('.onboarding-back-btn');
            if (backBtn) {
                backBtn.style.visibility = step === 1 ? 'hidden' : 'visible';
            }
            
            // ë‹¤ìŒ ë²„íŠ¼ í…ìŠ¤íŠ¸
            const nextBtn = document.getElementById('obNextBtn');
            if (nextBtn) {
                nextBtn.textContent = step === obTotalSteps ? 'ì‹œì‘í•˜ê¸°' : 'ë‹¤ìŒ';
            }
            
            // Step 7: ëª©í‘œ ë‚ ì§œ ì´ˆê¸°í™”
            if (step === 7) {
                initializeTargetDate();
            }
            
            // Step 10: ë¶„ì„ ê²°ê³¼ ê³„ì‚° ë° í‘œì‹œ
            if (step === 10) {
                // ğŸ”¥ DOMì´ ì™„ì „íˆ ë Œë”ë§ëœ í›„ ê³„ì‚° ì‹¤í–‰
                setTimeout(() => {
                    calculateAndShowResults();
                }, 50);
            }
        }
        
        // ë¶„ì„ ê²°ê³¼ ê³„ì‚° ë° í‘œì‹œ
        function calculateAndShowResults() {
            // ğŸ”¥ sliderStateì—ì„œ obDataë¡œ ëª…ì‹œì  ë™ê¸°í™”
            obData.height = sliderState.height.value || obData.height || 170;
            obData.currentWeight = sliderState.currentWeight.value || obData.currentWeight || 70;
            obData.goalWeight = sliderState.goalWeight.value || obData.goalWeight || 65;
            
            // ğŸ”¥ lossRate ê³„ì‚° (ëª©í‘œì¼ ê¸°ë°˜)
            if (obData.targetDate) {
                const today = new Date();
                const target = new Date(obData.targetDate);
                const diffDays = Math.max(7, Math.ceil((target - today) / (1000 * 60 * 60 * 24)));
                const weightDiff = obData.currentWeight - obData.goalWeight;
                const weeks = Math.max(1, Math.ceil(diffDays / 7));
                obData.lossRate = Math.min(1, Math.max(0.25, weightDiff / weeks));
            } else {
                obData.lossRate = obData.lossRate || 0.5;
            }
            
            console.log('ğŸ“Š ê³„ì‚°ì— ì‚¬ìš©ë  ë°ì´í„°:', {
                height: obData.height,
                currentWeight: obData.currentWeight,
                goalWeight: obData.goalWeight,
                age: obData.age,
                gender: obData.gender,
                activityLevel: obData.activityLevel,
                lossRate: obData.lossRate
            });
            
            // BMR ê³„ì‚° (Mifflin-St Jeor ê³µì‹)
            let bmr;
            if (obData.gender === 'male') {
                bmr = 10 * obData.currentWeight + 6.25 * obData.height - 5 * obData.age + 5;
            } else {
                bmr = 10 * obData.currentWeight + 6.25 * obData.height - 5 * obData.age - 161;
            }
            
            // í™œë™ ê³„ìˆ˜
            const activityMultipliers = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                active: 1.725,
                veryActive: 1.9
            };
            
            const tdee = Math.round(bmr * (activityMultipliers[obData.activityLevel] || 1.55));
            
            // ì¹¼ë¡œë¦¬ ì ì ê³„ì‚° (ì£¼ë‹¹ ê°ëŸ‰ ëª©í‘œ ê¸°ì¤€)
            const weeklyDeficit = obData.lossRate * 7700; // 1kg = 7700kcal
            const dailyDeficit = Math.round(weeklyDeficit / 7);
            
            // ëª©í‘œ ì¹¼ë¡œë¦¬ (ìµœì†Œ 1200kcal ë³´ì¥)
            let targetCalories = Math.max(1200, tdee - dailyDeficit);
            
            // ë§¤í¬ë¡œ ê³„ì‚° (íƒ„ìˆ˜í™”ë¬¼ 50%, ë‹¨ë°±ì§ˆ 30%, ì§€ë°© 20%)
            const carbsCalories = targetCalories * 0.5;
            const proteinCalories = targetCalories * 0.3;
            const fatCalories = targetCalories * 0.2;
            
            const carbsGrams = Math.round(carbsCalories / 4);
            const proteinGrams = Math.round(proteinCalories / 4);
            const fatGrams = Math.round(fatCalories / 9);
            
            // obDataì— ì €ì¥
            obData.calculatedCalories = targetCalories;
            obData.calculatedMacros = {
                carbs: carbsGrams,
                protein: proteinGrams,
                fat: fatGrams
            };
            obData.bmr = Math.round(bmr);
            obData.tdee = tdee;
            
            // UI ì—…ë°ì´íŠ¸ (ì˜¨ë³´ë”© ì „ìš© ID ì‚¬ìš©)
            const obResultCaloriesEl = document.getElementById('obResultCalories');
            const obResultCarbsEl = document.getElementById('obResultCarbs');
            const obResultProteinEl = document.getElementById('obResultProtein');
            const obResultFatEl = document.getElementById('obResultFat');
            
            if (obResultCaloriesEl) obResultCaloriesEl.textContent = targetCalories.toLocaleString();
            if (obResultCarbsEl) obResultCarbsEl.textContent = carbsGrams;
            if (obResultProteinEl) obResultProteinEl.textContent = proteinGrams;
            if (obResultFatEl) obResultFatEl.textContent = fatGrams;
            
            console.log('ğŸ¯ ì˜¨ë³´ë”© UI ì—…ë°ì´íŠ¸:', { 
                calories: targetCalories, 
                carbs: carbsGrams, 
                protein: proteinGrams, 
                fat: fatGrams,
                elements: { obResultCaloriesEl, obResultCarbsEl, obResultProteinEl, obResultFatEl }
            });
            
            // BMR/TDEE í‘œì‹œ
            const bmrEl = document.getElementById('resultBmr');
            const tdeeEl = document.getElementById('resultTdee');
            if (bmrEl) bmrEl.textContent = Math.round(bmr).toLocaleString();
            if (tdeeEl) tdeeEl.textContent = tdee.toLocaleString();
            
            // ì ì ë° ê³µì‹ í‘œì‹œ
            const deficitEl = document.getElementById('resultDeficit');
            const weeklyLossEl = document.getElementById('resultWeeklyLoss');
            const tdee2El = document.getElementById('resultTdee2');
            const deficit2El = document.getElementById('resultDeficit2');
            const targetEl = document.getElementById('resultTarget');
            
            if (deficitEl) deficitEl.textContent = dailyDeficit.toLocaleString();
            if (weeklyLossEl) weeklyLossEl.textContent = obData.lossRate.toFixed(2);
            if (tdee2El) tdee2El.textContent = tdee.toLocaleString();
            if (deficit2El) deficit2El.textContent = dailyDeficit.toLocaleString();
            if (targetEl) targetEl.textContent = targetCalories.toLocaleString();
            
            console.log('ğŸ“Š ë¶„ì„ ê²°ê³¼:', {
                bmr: Math.round(bmr),
                tdee,
                dailyDeficit,
                targetCalories,
                macros: { carbs: carbsGrams, protein: proteinGrams, fat: fatGrams }
            });
        }
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateObProgress() {
            const percent = (obCurrentStep / obTotalSteps) * 100;
            document.getElementById('onboardingProgressBar').style.width = percent + '%';
        }
        
        // ë‹¤ìŒ ë‹¨ê³„
        function nextObStep() {
            // ìœ íš¨ì„± ê²€ì‚¬
            if (obCurrentStep === 1 && !obData.name && document.getElementById('obName').value.trim()) {
                obData.name = document.getElementById('obName').value.trim();
            }
            
            if (obCurrentStep === 1 && (!obData.name || obData.name.length < 1)) {
                obData.name = document.getElementById('obName').value.trim();
                if (!obData.name || obData.name.length < 1) {
                    alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
            }
            
            if (obCurrentStep === 3 && !obData.gender) {
                alert('ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (obCurrentStep < obTotalSteps) {
                obCurrentStep++;
                showObStep(obCurrentStep);
                updateObProgress();
            } else {
                // ì™„ë£Œ
                completeNewOnboarding();
            }
        }
        
        // ì´ì „ ë‹¨ê³„
        function prevObStep() {
            if (obCurrentStep > 1) {
                obCurrentStep--;
                showObStep(obCurrentStep);
                updateObProgress();
            }
        }
        
        // ì˜¨ë³´ë”© ì™„ë£Œ
        async function completeNewOnboarding() {
            try {
                // ğŸ”¥ sliderStateì—ì„œ obDataë¡œ ìµœì¢… ë™ê¸°í™”
                obData.height = sliderState.height.value;
                obData.currentWeight = sliderState.currentWeight.value;
                obData.goalWeight = sliderState.goalWeight.value;
                
                // ì´ë¦„ ìµœì¢… í™•ì¸
                if (!obData.name) {
                    obData.name = document.getElementById('obName').value.trim() || 'ì‚¬ìš©ì';
                }
                
                console.log('ğŸ“Š ì˜¨ë³´ë”© ìµœì¢… ë°ì´í„°:', obData);
                console.log('ğŸ”¢ ì €ì¥ë  ì²´ì¤‘ê°’ - ì‹œì‘:', obData.currentWeight, 'ëª©í‘œ:', obData.goalWeight);
                
                // Step 10ì—ì„œ ì´ë¯¸ ê³„ì‚°ëœ ê°’ ì‚¬ìš©
                const calculatedCalories = obData.calculatedCalories;
                const calculatedMacros = obData.calculatedMacros;
                const bmr = obData.bmr;
                const tdee = obData.tdee;
                const weightDiff = obData.currentWeight - obData.goalWeight;
                
                // Firestoreì— ì €ì¥
                await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid).set({
                        name: obData.name,
                        age: obData.age,
                        gender: obData.gender,
                        height: obData.height,
                        startWeight: obData.currentWeight,
                        goalWeight: obData.goalWeight,
                        activityLevel: obData.activityLevel,
                        goal: weightDiff > 0 ? 'lose' : (weightDiff < 0 ? 'gain' : 'maintain'),
                        calculatedCalories: calculatedCalories,
                        calculatedMacros: calculatedMacros,
                        bmr: bmr,
                        tdee: tdee,
                        targetDate: obData.targetDate,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                
                console.log('âœ… í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ!');
                
                // ğŸ”¥ v3.9.2: ì‹œì‘ ì²´ì¤‘ì„ logs ì»¬ë ‰ì…˜ì— ìë™ ì €ì¥
                const today = new Date();
                await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs').add({
                        weight: obData.currentWeight,
                        date: firebase.firestore.Timestamp.fromDate(today),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                console.log('âœ… ì‹œì‘ ì²´ì¤‘ ìë™ ê¸°ë¡ ì™„ë£Œ:', obData.currentWeight, 'kg');
                
                // currentProfile ì—…ë°ì´íŠ¸
                currentProfile = {
                    name: obData.name,
                    age: obData.age,
                    gender: obData.gender,
                    height: obData.height,
                    startWeight: obData.currentWeight,
                    goalWeight: obData.goalWeight,
                    activityLevel: obData.activityLevel,
                    calculatedCalories: calculatedCalories,
                    calculatedMacros: calculatedMacros,
                    bmr: bmr,
                    tdee: tdee,
                    targetDate: obData.targetDate
                };
                
                console.log('ğŸ“Š currentProfile ì„¤ì •ë¨:', currentProfile);
                console.log('ğŸ¯ ëª©í‘œ ì¹¼ë¡œë¦¬:', calculatedCalories, 'íƒ„ë‹¨ì§€:', calculatedMacros);
                
                // localStorageì—ë„ ì €ì¥ (ëŒ€ì‹œë³´ë“œ ì¦‰ì‹œ ë°˜ì˜ìš©)
                localStorage.setItem('goal_calories_target', calculatedCalories);
                if (calculatedMacros) {
                    localStorage.setItem('goal_carbs_target', calculatedMacros.carbs);
                    localStorage.setItem('goal_protein_target', calculatedMacros.protein);
                    localStorage.setItem('goal_fat_target', calculatedMacros.fat);
                }
                
                // ì˜¨ë³´ë”© ë‹«ê¸° (ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë„ ì œê±°)
                const onboarding = document.getElementById('fullscreenOnboarding');
                onboarding.classList.remove('show');
                onboarding.style.cssText = ''; // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì œê±°
                onboarding.style.display = 'none';
                document.body.style.overflow = '';
                
                // ëŒ€ì‹œë³´ë“œ í‘œì‹œ
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('headerSubtitle').textContent = `${currentProfile.name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
                document.getElementById('profileName').textContent = currentProfile.name;
                document.getElementById('profileEmail').textContent = currentUser.email;
                
                await loadHomeTab();
                switchTab('home');
                
                // ğŸ”¥ ëŒ€ì‹œë³´ë“œ ì˜ì–‘ ì„­ì·¨ëŸ‰ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    updateNutritionUI();
                    console.log('ğŸ½ï¸ ëŒ€ì‹œë³´ë“œ ì˜ì–‘ UI ê°•ì œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                }, 100);
                
                showSuccessMessage('í”„ë¡œí•„ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
                
            } catch (error) {
                console.error('âŒ ì˜¨ë³´ë”© ì™„ë£Œ ì‹¤íŒ¨:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        // ê¸°ì¡´ í•¨ìˆ˜ í˜¸í™˜ì„± ìœ ì§€
        function nextOnboardingStep() { nextObStep(); }
        function prevOnboardingStep() { prevObStep(); }

        // ==================== Mealo ìŠ¤íƒ€ì¼ ìŒì‹ ë¶„ì„ ê²°ê³¼ ì¹´ë“œ ====================
        let pendingFoodAnalysisData = null;

        function showFoodAnalysisCard(imageUrl, nutritionData, isAnalyzing) {
            const modal = document.getElementById('foodAnalysisResultModal');
            const foodImage = document.getElementById('foodAnalysisImage');
            const foodImagePlaceholder = document.getElementById('foodImagePlaceholder');
            
            // ì´ë¯¸ì§€ í‘œì‹œ
            if (imageUrl) {
                foodImage.src = imageUrl;
                foodImage.style.display = 'block';
                foodImagePlaceholder.style.display = 'none';
            } else {
                foodImage.style.display = 'none';
                foodImagePlaceholder.style.display = 'flex';
            }

            if (isAnalyzing) {
                // ë¶„ì„ ì¤‘ ìƒíƒœ
                document.getElementById('analyzedFoodName').textContent = 'ë¶„ì„ ì¤‘...';
                document.getElementById('aiAdviceText').innerHTML = 'ğŸ¤– AIê°€ ìŒì‹ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                document.getElementById('analyzedCalories').textContent = '-';
                document.getElementById('analyzedCarbs').textContent = '-';
                document.getElementById('analyzedProtein').textContent = '-';
                document.getElementById('analyzedFat').textContent = '-';
            } else if (nutritionData) {
                // ë¶„ì„ ì™„ë£Œ ìƒíƒœ
                document.getElementById('analyzedFoodName').textContent = nutritionData.foodName || 'ìŒì‹ ë¶„ì„ ì™„ë£Œ';
                document.getElementById('aiAdviceText').innerHTML = `ğŸ’¡ ${nutritionData.advice || 'AI ì¡°ì–¸ì´ ì—†ìŠµë‹ˆë‹¤.'}`;
                document.getElementById('analyzedCalories').textContent = Math.round(nutritionData.calories);
                document.getElementById('analyzedCarbs').textContent = Math.round(nutritionData.carbs);
                document.getElementById('analyzedProtein').textContent = Math.round(nutritionData.protein);
                document.getElementById('analyzedFat').textContent = Math.round(nutritionData.fat);

                // ë°ì´í„° ì €ì¥ (í™•ì¸ ë²„íŠ¼ìš©)
                pendingFoodAnalysisData = nutritionData;
            }

            modal.style.display = 'flex';
        }

        function closeFoodAnalysisResult() {
            document.getElementById('foodAnalysisResultModal').style.display = 'none';
            pendingFoodAnalysisData = null;
        }

        function confirmFoodAnalysisResult() {
            if (pendingFoodAnalysisData) {
                // ë¶„ì„ ê²°ê³¼ë¥¼ ì•¨ë²” íƒ­ ë˜ëŠ” ì‹ì‚¬ ì…ë ¥ì— ë°˜ì˜
                // (ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ ì§„í–‰)
                closeFoodAnalysisResult();
                showToast('ìŒì‹ ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 2000);
            }
        }
        // ==================================================================

        // ==================== ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ====================
        async function initializeDashboard() {
            document.getElementById('headerSubtitle').textContent = `${currentProfile.name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
            document.getElementById('profileName').textContent = currentProfile.name;
            document.getElementById('profileEmail').textContent = currentUser.email;

            await loadHomeTab();
            await loadPlanTab();
            await loadAlbumTab();
            await loadCalendar();
            await loadCommunityMessages();
            await loadNotifications();
            await loadSettings();

            initializeFasting();
            initializePWA();
            startNotificationCheck();
            // ì•Œë¦¼ ê¶Œí•œ í™•ì¸ (ìƒˆë¡œ ì¶”ê°€)
            checkNotificationPermission();

            // AI ì±„íŒ… ê¸°ë¡ ë¡œë“œ
            loadAIChatHistory();

            // ========== Phase 1: ìì • ì´ˆê¸°í™” íƒ€ì´ë¨¸ ì„¤ì • ==========
            setupMidnightReset();
            // ====================================================
        }

        // ==================== íƒ­ ì „í™˜ ====================
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));

            // ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.nav-item-sidebar').forEach(nav => nav.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item-sidebar[data-tab="${tabName}"]`);
            if (activeNav) activeNav.classList.add('active');

            // ì„ íƒëœ íƒ­ í™œì„±í™”
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            currentTab = tabName;

            // ëª¨ë°”ì¼ì—ì„œ ì‚¬ì´ë“œë°” ë‹«ê¸°
            if (window.innerWidth <= 768) {
                closeMobileSidebar();
            }

            // ì†Œí†µ íƒ­ì˜ ì…ë ¥ì°½ í‘œì‹œ/ìˆ¨ê¹€
            const chatInput = document.getElementById('chatInputContainer');
            if (tabName === 'community') {
                chatInput.classList.remove('hidden');
            } else {
                chatInput.classList.add('hidden');
            }

            // íƒ­ë³„ ìƒˆë¡œê³ ì¹¨
            if (tabName === 'calendar') {
                renderCalendar();
            } else if (tabName === 'plan') {
                loadPlanTab();
            } else if (tabName === 'album') {
                loadAlbumTab();
            } else if (tabName === 'community') {
                loadCommunityMessages();
            } else if (tabName === 'exercise') {
                // ğŸ”¥ v3.9.3: ìš´ë™ íƒ­ ë¡œë“œ (ì˜¤ëŠ˜ ê¸°ë¡ + ì£¼ê°„ í†µê³„)
                loadTodayExercises();
                loadWeeklyExerciseStats();
            } else if (tabName === 'fasting') {
                // ë‹¨ì‹ íƒ­ ì „í™˜ ì‹œ ê·¸ë˜í”„ ë° ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                if (typeof loadFastingTab === 'function') {
                    loadFastingTab();
                }
            }
        }

        // ==================== ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ì œì–´ ====================
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');

            if (sidebar && overlay) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
                document.body.style.overflow = sidebar.classList.contains('mobile-open') ? 'hidden' : '';
            }
        }

        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');

            if (sidebar) {
                sidebar.classList.remove('mobile-open');
            }
            if (overlay) {
                overlay.classList.remove('active');
            }
            document.body.style.overflow = '';
        }

        // ==================== í™ˆ íƒ­ ====================
        async function loadHomeTab() {
            console.log('=== loadHomeTab ì‹œì‘ ===');
            console.log('currentProfile:', currentProfile);
            
            // ê±´ê°• ì§€í‘œ í‘œì‹œ
            const startWeight = parseFloat(currentProfile.startWeight) || 0;
            const goalWeight = parseFloat(currentProfile.goalWeight) || 0;
            
            console.log('startWeight:', startWeight, 'goalWeight:', goalWeight);

            document.getElementById('startWeightDisplay').textContent = startWeight.toFixed(1);
            document.getElementById('goalWeightDisplay').textContent = goalWeight.toFixed(1);

            // ì²´ì¤‘ ë°ì´í„° ë¡œë“œ
            console.log('ì²´ì¤‘ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            const weightData = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs').orderBy('date', 'desc').get(); // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            
            console.log('Firebaseì—ì„œ ë¡œë“œí•œ ë¬¸ì„œ ê°œìˆ˜:', weightData.docs.length);

            // 1ë‹¨ê³„: ìœ íš¨í•œ ë°ì´í„°ë§Œ ì¶”ì¶œ
            const allWeights = weightData.docs
                .map(doc => {
                    const data = doc.data();
                    let date;
                    
                    // date í•„ë“œë¥¼ ì•ˆì „í•˜ê²Œ ë³€í™˜
                    if (data.date && typeof data.date.toDate === 'function') {
                        date = data.date.toDate();
                    } else if (data.date instanceof Date) {
                        date = data.date;
                    } else if (typeof data.date === 'string' || typeof data.date === 'number') {
                        date = new Date(data.date);
                    } else {
                        console.warn('ì•Œ ìˆ˜ ì—†ëŠ” date í˜•ì‹:', data.date);
                        date = new Date();
                    }
                    
                    return {
                        date: date,
                        weight: data.weight,
                        timestamp: date.getTime() // ì •ë ¬ìš© íƒ€ì„ìŠ¤íƒ¬í”„
                    };
                })
                .filter(w => w.weight != null && !isNaN(w.weight)); // null, undefined, NaN ì œê±°

            // 2ë‹¨ê³„: ê°™ì€ ë‚ ì§œëŠ” ê°€ì¥ ìµœì‹  ê²ƒë§Œ ë‚¨ê¸°ê¸° (í•˜ë£¨ì— í•˜ë‚˜ë§Œ)
            const weightMap = new Map();
            allWeights.forEach(w => {
                const dateKey = `${w.date.getFullYear()}-${String(w.date.getMonth() + 1).padStart(2, '0')}-${String(w.date.getDate()).padStart(2, '0')}`;
                
                // ê°™ì€ ë‚ ì§œê°€ ì´ë¯¸ ìˆìœ¼ë©´ ë” ìµœì‹  ê²ƒìœ¼ë¡œ êµì²´
                if (!weightMap.has(dateKey) || w.timestamp > weightMap.get(dateKey).timestamp) {
                    weightMap.set(dateKey, w);
                }
            });

            // 3ë‹¨ê³„: ë‚ ì§œìˆœ ì •ë ¬ (ì˜¤ë¦„ì°¨ìˆœ)
            const weights = Array.from(weightMap.values())
                .sort((a, b) => a.timestamp - b.timestamp);

            let currentWeight = startWeight;
            let lastWeightDate = null;
            
            console.log('ìœ íš¨í•œ ì²´ì¤‘ ê¸°ë¡ ê°œìˆ˜:', weights.length);
            
            // ëª¨ë“  ì²´ì¤‘ ê¸°ë¡ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            console.log('=== ìœ íš¨í•œ ì²´ì¤‘ ê¸°ë¡ ===');
            weights.forEach((w, index) => {
                const dateStr = `${w.date.getFullYear()}-${String(w.date.getMonth() + 1).padStart(2, '0')}-${String(w.date.getDate()).padStart(2, '0')}`;
                console.log(`${index + 1}. ${w.weight}kg - ${dateStr}`);
            });
            console.log('========================');
            
            if (weights.length > 0) {
                const lastWeight = weights[weights.length - 1];
                currentWeight = lastWeight.weight;
                lastWeightDate = lastWeight.date;
                console.log('âœ… ë§ˆì§€ë§‰ ê¸°ë¡ (ìµœì‹ ):', currentWeight, 'kg at', lastWeightDate.toLocaleDateString('ko-KR'));
            } else {
                console.log('âš ï¸ ê¸°ë¡ ì—†ìŒ, ì‹œì‘ ì²´ì¤‘ ì‚¬ìš©:', currentWeight);
            }
            
            document.getElementById('currentWeightDisplay').textContent = currentWeight.toFixed(1);
            
            // ë§ˆì§€ë§‰ ê¸°ë¡ ë‚ ì§œ í‘œì‹œ
            const dateDisplay = document.getElementById('currentWeightDate');
            if (lastWeightDate) {
                const year = String(lastWeightDate.getFullYear()).slice(2);
                const month = String(lastWeightDate.getMonth() + 1).padStart(2, '0');
                const day = String(lastWeightDate.getDate()).padStart(2, '0');
                dateDisplay.textContent = `${year}-${month}-${day}`;
            } else {
                dateDisplay.textContent = 'ê¸°ë¡ ì—†ìŒ';
            }

            // ì§„í–‰ë¥  ê³„ì‚°
            const totalToLose = startWeight - goalWeight;
            const lostSoFar = startWeight - currentWeight;
            const remaining = currentWeight - goalWeight;
            const progress = totalToLose !== 0 ? (lostSoFar / totalToLose * 100) : 0;
            
            console.log('=== ê³„ì‚° ê²°ê³¼ ===');
            console.log('totalToLose:', totalToLose);
            console.log('lostSoFar:', lostSoFar);
            console.log('remaining:', remaining);
            console.log('progress:', progress);

            document.getElementById('progressPercent').textContent = `${Math.max(0, Math.min(100, progress)).toFixed(1)}%`;
            document.getElementById('progressBar').style.width = `${Math.max(0, Math.min(100, progress))}%`;
            
            // ê°ëŸ‰/ì¦ëŸ‰ í‘œì‹œ (ìŒìˆ˜ë„ í‘œì‹œ)
            const lostText = lostSoFar >= 0 ? `ê°ëŸ‰: ${lostSoFar.toFixed(1)}kg` : `ì¦ëŸ‰: ${Math.abs(lostSoFar).toFixed(1)}kg`;
            const remainingText = remaining >= 0 ? `ë‚¨ì€ ê°ëŸ‰: ${remaining.toFixed(1)}kg` : `ëª©í‘œ ì´ˆê³¼: ${Math.abs(remaining).toFixed(1)}kg`;
            
            document.getElementById('weightLost').textContent = lostText;
            document.getElementById('weightRemaining').textContent = remainingText;

            // ğŸ”¥ v3.9.3: í™ˆ íƒ­ì—ì„œ ì²´ì¤‘ ê·¸ë˜í”„ ì œê±° (ëª¨ë‹¬ì—ì„œë§Œ í‘œì‹œ)
            // drawWeightChart(weights); // ì œê±°ë¨

            // ì˜ì–‘ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
            await loadNutritionDashboard();

            // ========== Phase 1: ì˜¤ëŠ˜ì˜ ì˜ì–‘ ë°ì´í„° ë¡œë“œ ==========
            await loadTodayNutrition();
            // ====================================================

            // ë¬¼ ë§ˆì‹œê¸° íŠ¸ë˜ì»¤ ì´ˆê¸°í™”
            initializeWaterTracker();

            // ========== D-Day í‘œì‹œ ==========
            console.log('targetDate í™•ì¸:', currentProfile.targetDate, typeof currentProfile.targetDate);
            if (currentProfile.targetDate) {
                let dateToUse;
                if (currentProfile.targetDate.toDate) {
                    // Firestore Timestamp
                    dateToUse = currentProfile.targetDate.toDate();
                } else if (typeof currentProfile.targetDate === 'string') {
                    // ë¬¸ìì—´ í˜•ì‹ (YYYY-MM-DD)
                    dateToUse = new Date(currentProfile.targetDate);
                } else if (currentProfile.targetDate instanceof Date) {
                    dateToUse = currentProfile.targetDate;
                } else {
                    dateToUse = new Date(currentProfile.targetDate);
                }
                console.log('D-Day ì—…ë°ì´íŠ¸:', dateToUse);
                updateDDayDisplay(dateToUse);
            } else {
                console.log('ëª©í‘œ ë‚ ì§œê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
                // ëª©í‘œ ë‚ ì§œê°€ ì—†ì–´ë„ D-day ì˜ì—­ í‘œì‹œ (ì„¤ì • í•„ìš” ë©”ì‹œì§€)
                const ddayDisplay = document.getElementById('ddayDisplay');
                ddayDisplay.classList.remove('hidden');
                ddayDisplay.querySelector('.dday-main').textContent = 'D-?';
                ddayDisplay.querySelector('.dday-sub').textContent = 'ëª©í‘œì¼ì„ ì„¤ì •í•´ì£¼ì„¸ìš”';
            }
            
            // í˜„ì‹¤ì ì¸ ëª©í‘œì¼ í‘œì‹œ (í˜„ì¬ ì²´ì¤‘ ê¸°ì¤€)
            updateRealisticGoalDisplay(currentWeight);
            // =================================================================
        }

        function drawWeightChart(weights) {
            const ctx = document.getElementById('weightChart').getContext('2d');

            if (weightChart) {
                weightChart.destroy();
            }

            const labels = weights.map(w => {
                const date = w.date;
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });

            const data = weights.map(w => w.weight);

            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì²´ì¤‘ (kg)',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        async function addWeight() {
            const weight = parseFloat(document.getElementById('weightInput').value);

            if (!weight || weight <= 0) {
                alert('ì˜¬ë°”ë¥¸ ì²´ì¤‘ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                console.log('=== ì²´ì¤‘ ê¸°ë¡ ì‹œì‘ ===');
                console.log('ì…ë ¥ëœ ì²´ì¤‘:', weight);
                
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const todayEnd = new Date(todayStart.getTime() + 86400000);

                // ì˜¤ëŠ˜ ë‚ ì§œì˜ ê¸°ì¡´ ì²´ì¤‘ ê¸°ë¡ í™•ì¸
                const existingLogs = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(todayStart))
                    .where('date', '<', firebase.firestore.Timestamp.fromDate(todayEnd))
                    .get();

                // ê¸°ì¡´ ê¸°ë¡ì´ ìˆìœ¼ë©´ ì‚­ì œ (ë®ì–´ì“°ê¸°)
                const batch = db.batch();
                existingLogs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log(`ğŸ—‘ï¸ ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¡´ ì²´ì¤‘ ê¸°ë¡ ${existingLogs.size}ê°œ ì‚­ì œ`);

                // ìƒˆ ì²´ì¤‘ ê¸°ë¡ ì €ì¥
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs').add({
                        weight: weight,
                        date: firebase.firestore.Timestamp.now()
                    });
                
                console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ (ìµœì‹  ì²´ì¤‘:', weight, 'kg)');

                // ========== Phase 1: ìº˜ë¦°ë” í†µí•© ==========
                await saveToDailyLog(now, 'weight', {
                    weight: weight,
                    timestamp: now.toISOString()
                });
                // ========================================

                console.log('âœ… ì²´ì¤‘ ê¸°ë¡ ì¶”ê°€:', weight, 'kg');

                // ë‹¨ì‹ íƒ­ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
                if (typeof loadFastingWeightChart === 'function') {
                    await loadFastingWeightChart();
                }

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('weightInput').value = '';

                // ========== Phase 1: ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ ==========
                // ì „ì²´ í™ˆíƒ­ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ê·¸ë˜í”„ì™€ ì§„í–‰ë¥  ëª¨ë‘ ì—…ë°ì´íŠ¸
                console.log('í™ˆ íƒ­ ìƒˆë¡œê³ ì¹¨ ì‹œì‘...');
                await loadHomeTab();
                console.log('âœ… í™ˆ íƒ­ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');

                // âœ… í”Œëœ íƒ­ ì²´ì¤‘ ëª©í‘œ ìë™ ì²´í¬
                if (typeof checkTodayWeightRecord === 'function') {
                    await checkTodayWeightRecord();
                }

                // ì„±ê³µ ë©”ì‹œì§€
                showAIToast(`${currentProfile.name} íšŒì›ë‹˜, ì²´ì¤‘ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! (${weight}kg)`, 3000);
                // ==============================================

            } catch (error) {
                console.error('âŒ ì²´ì¤‘ ì¶”ê°€ ì‹¤íŒ¨:', error);
                alert('ì²´ì¤‘ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // AI ì±„íŒ…
        function toggleAIChat() {
            const details = document.getElementById('aiChatDetails');
            details.classList.toggle('open');
        }

        function loadAIChatHistory() {
            const history = JSON.parse(localStorage.getItem(LS_KEYS.AI_CHAT) || '[]');
            const messagesDiv = document.getElementById('aiChatMessages');
            messagesDiv.innerHTML = '';

            history.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `ai-message ${msg.role}`;
                msgDiv.textContent = msg.content;
                messagesDiv.appendChild(msgDiv);
            });

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();

            if (!message) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            const history = JSON.parse(localStorage.getItem(LS_KEYS.AI_CHAT) || '[]');
            history.push({ role: 'user', content: message });

            // ìµœê·¼ 50ê°œë§Œ ìœ ì§€
            if (history.length > 50) {
                history.shift();
            }

            localStorage.setItem(LS_KEYS.AI_CHAT, JSON.stringify(history));
            loadAIChatHistory();
            input.value = '';

            // AI ì‘ë‹µ ë°›ê¸° (ì»¨í…ìŠ¤íŠ¸ í¬í•¨)
            // ğŸ”¥ 3. AI ì½”ì¹˜ ì „ìš© API ì‚¬ìš© (ì˜¤ëŠ˜ì˜ ë°ì´í„° í¬í•¨)
            const todayData = {
                calories: todayIntake.calories,
                carbs: todayIntake.carbs,
                protein: todayIntake.protein,
                fat: todayIntake.fat,
                meals: todayIntake.meals,
                fasting: localStorage.getItem('todayFasting') || 'ë¯¸ê¸°ë¡',
                water: localStorage.getItem('todayWater') || 'ë¯¸ê¸°ë¡'
            };
            const response = await callGeminiCoach(message, currentProfile, todayData);

            history.push({ role: 'assistant', content: response });
            localStorage.setItem(LS_KEYS.AI_CHAT, JSON.stringify(history));
            loadAIChatHistory();
        }

        // ìŠ¤ë§ˆíŠ¸ ë¬¼ ë§ˆì‹œê¸°
        function initializeWaterTracker() {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"cupSize": 250, "goalLiters": 2, "filled": []}');

            // ë‚ ì§œ í™•ì¸ ë° ìë™ ì´ˆê¸°í™”
            const today = new Date().toISOString().split('T')[0];
            if (settings.lastDate !== today) {
                // ë‚ ì§œê°€ ë‹¤ë¥´ë©´ ë¬¼ ë§ˆì‹œê¸° ì´ˆê¸°í™”
                settings.filled = [];
                settings.lastDate = today;
                localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));
                console.log('âœ… ë¬¼ ë§ˆì‹œê¸° ìë™ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ë‚ ):', today);
            }

            // cupSizeëŠ” v3.9.3ì—ì„œ ì œê±°ë¨ (ê³ ì • 250ml ì‚¬ìš©)
            const waterGoalEl = document.getElementById('waterGoal');
            if (waterGoalEl) {
                waterGoalEl.value = settings.goalLiters || 2;
            }

            updateWaterTracker();
        }

        function updateWaterTracker() {
            // cupSizeëŠ” v3.9.3ì—ì„œ ì œê±°ë¨ (ê³ ì • 250ml ì‚¬ìš©)
            const cupSize = 250;
            const waterGoalEl = document.getElementById('waterGoal');
            const goalLiters = waterGoalEl ? parseFloat(waterGoalEl.value) || 2 : 2;
            const goalMl = goalLiters * 1000;
            const cupCount = Math.ceil(goalMl / cupSize);

            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"filled": []}');
            settings.cupSize = cupSize;
            settings.goalLiters = goalLiters;
            settings.lastDate = settings.lastDate || new Date().toISOString().split('T')[0];

            // waterTrackerëŠ” v3.9.3ì—ì„œ ì œê±°ë¨ (ì§„í–‰ë°”ì™€ ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´)
            const tracker = document.getElementById('waterTracker');
            if (tracker) {
                tracker.innerHTML = '';

                for (let i = 0; i < cupCount; i++) {
                    const cup = document.createElement('div');
                    cup.className = 'water-cup';
                    if (settings.filled && settings.filled.includes(i)) {
                        cup.classList.add('filled');
                    }
                    cup.textContent = 'ğŸ’§';
                    cup.onclick = () => toggleWaterCup(i);
                    tracker.appendChild(cup);
                }
            }

            // ========== Phase 2: ë¬¼ ì„­ì·¨ëŸ‰ í‘œì‹œ ì—…ë°ì´íŠ¸ (ê¸°ë¡ ê¸°ë°˜) ==========
            // ê¸°ë¡ì´ ìˆìœ¼ë©´ ê¸°ë¡ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°, ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹
            let intakeMl = 0;
            if (settings.records && settings.records.length > 0) {
                intakeMl = settings.records.reduce((sum, r) => sum + r.amount, 0);
            } else {
                const filledCount = settings.filled ? settings.filled.length : 0;
                intakeMl = filledCount * cupSize;
            }
            const percentage = Math.min(100, Math.round((intakeMl / goalMl) * 100));

            const waterIntakeEl = document.getElementById('waterIntake');
            const waterGoalDisplayEl = document.getElementById('waterGoalDisplay');
            const waterPercentageEl = document.getElementById('waterPercentage');

            if (waterIntakeEl) waterIntakeEl.textContent = intakeMl;
            if (waterGoalDisplayEl) waterGoalDisplayEl.textContent = `${goalMl} ml`;
            if (waterPercentageEl) waterPercentageEl.textContent = `${percentage}%`;
            
            // ğŸ”¥ v3.9.3: ì§„í–‰ë°” ì—…ë°ì´íŠ¸
            if (document.getElementById('waterProgressBar')) {
                document.getElementById('waterProgressBar').style.width = `${percentage}%`;
            }
            // ====================================================

            localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));
            
            // ì»¤ìŠ¤í…€ ë¬¼ ë²„íŠ¼ ë Œë”ë§
            if (typeof renderWaterButtons === 'function') {
                renderWaterButtons();
            }
            
            // ìµœê·¼ ê¸°ë¡ ëª©ë¡ ë Œë”ë§
            if (typeof renderWaterRecords === 'function') {
                renderWaterRecords();
            }
        }
        
        // ìµœê·¼ ë¬¼ ë§ˆì‹  ê¸°ë¡ ëª©ë¡ ë Œë”ë§ (ê°œì„ ëœ ì¹© ë””ìì¸)
        function renderWaterRecords() {
            const container = document.getElementById('waterRecordsList');
            if (!container) return;
            
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"records": []}');
            const records = settings.records || [];
            
            if (records.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #90caf9; font-size: 0.85rem; padding: 15px; width: 100%;">ğŸ’§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            // ìµœê·¼ ê¸°ë¡ë¶€í„° í‘œì‹œ (ì—­ìˆœ)
            const sortedRecords = [...records].sort((a, b) => new Date(b.time) - new Date(a.time));
            
            container.innerHTML = sortedRecords.map(record => {
                const time = new Date(record.time);
                const timeStr = time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                
                // mlì— ë”°ë¼ ìƒ‰ìƒ ê·¸ë¼ë°ì´ì…˜ ì¡°ì •
                const colors = {
                    small: { bg: 'linear-gradient(135deg, #81d4fa 0%, #4fc3f7 100%)', text: '#01579b' },
                    medium: { bg: 'linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%)', text: '#0d47a1' },
                    large: { bg: 'linear-gradient(135deg, #42a5f5 0%, #2196f3 100%)', text: '#0d47a1' }
                };
                
                let colorSet = colors.small;
                if (record.amount >= 500) colorSet = colors.large;
                else if (record.amount >= 300) colorSet = colors.medium;
                
                return `
                    <div class="water-record-chip" 
                         data-record-id="${record.id}"
                         style="
                             position: relative;
                             display: inline-flex;
                             align-items: center;
                             gap: 6px;
                             padding: 8px 14px;
                             background: ${colorSet.bg};
                             color: white;
                             border-radius: 20px;
                             font-size: 0.85rem;
                             font-weight: 600;
                             box-shadow: 0 2px 8px rgba(33, 150, 243, 0.25);
                             transition: all 0.3s ease;
                             cursor: pointer;
                             user-select: none;
                         "
                         onmouseover="
                             this.style.transform = 'translateY(-2px) scale(1.05)';
                             this.style.boxShadow = '0 4px 12px rgba(33, 150, 243, 0.4)';
                             this.querySelector('.water-record-delete')?.style.setProperty('opacity', '1');
                             this.querySelector('.water-record-delete')?.style.setProperty('transform', 'scale(1)');
                         "
                         onmouseout="
                             this.style.transform = 'translateY(0) scale(1)';
                             this.style.boxShadow = '0 2px 8px rgba(33, 150, 243, 0.25)';
                             this.querySelector('.water-record-delete')?.style.setProperty('opacity', '0');
                             this.querySelector('.water-record-delete')?.style.setProperty('transform', 'scale(0.8)');
                         ">
                        <span style="font-size: 1rem;">ğŸ’§</span>
                        <span style="font-weight: 700;">+${record.amount}ml</span>
                        <span style="font-size: 0.7rem; opacity: 0.9; margin-left: 2px;">${timeStr}</span>
                        <button 
                            class="water-record-delete"
                            onclick="event.stopPropagation(); removeWaterRecord('${record.id}');"
                            style="
                                position: absolute;
                                top: -6px;
                                right: -6px;
                                width: 20px;
                                height: 20px;
                                background: linear-gradient(135deg, #ff5252 0%, #f44336 100%);
                                color: white;
                                border: 2px solid white;
                                border-radius: 50%;
                                font-size: 12px;
                                font-weight: bold;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                opacity: 0;
                                transform: scale(0.8);
                                transition: all 0.2s ease;
                                box-shadow: 0 2px 6px rgba(244, 67, 54, 0.4);
                                z-index: 10;
                                line-height: 1;
                            "
                            onmouseover="
                                this.style.transform = 'scale(1.15)';
                                this.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
                            "
                            onmouseout="
                                this.style.transform = 'scale(1)';
                                this.style.background = 'linear-gradient(135deg, #ff5252 0%, #f44336 100%)';
                            ">
                            âœ•
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ğŸ”¥ v3.9.3: ë¹ ë¥¸ ë¬¼ ì¶”ê°€ ê¸°ëŠ¥ (ê°œë³„ ê¸°ë¡ ì¶”ì )
        async function addWater(amount) {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"filled": [], "cupSize": 250, "records": []}');
            
            // ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸
            const today = new Date().toISOString().split('T')[0];
            if (settings.lastDate !== today) {
                settings.filled = [];
                settings.records = []; // ê¸°ë¡ë„ ì´ˆê¸°í™”
                settings.lastDate = today;
            }
            
            // ê¸°ë¡ ë°°ì—´ ì´ˆê¸°í™” (ì—†ìœ¼ë©´)
            if (!settings.records) {
                settings.records = [];
            }
            
            // ìƒˆë¡œìš´ ê¸°ë¡ ì¶”ê°€
            const record = {
                amount: amount,
                time: new Date().toISOString(),
                id: Date.now() + Math.random() // ê³ ìœ  ID
            };
            settings.records.push(record);
            
            // í˜„ì¬ ì´ ì„­ì·¨ëŸ‰ ê³„ì‚° (ê¸°ë¡ ê¸°ë°˜)
            const currentIntake = settings.records.reduce((sum, r) => sum + r.amount, 0);
            
            // ì»µ ê°œìˆ˜ë¡œ ë³€í™˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            const cupSize = settings.cupSize || 250;
            const newCupCount = Math.ceil(currentIntake / cupSize);
            settings.filled = Array.from({length: newCupCount}, (_, i) => i);
            
            localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));
            updateWaterTracker();
            
            // ë‹¨ì‹ íƒ­ ë™ê¸°í™”
            if (document.getElementById('fastingWaterIntake')) {
                updateFastingWaterDisplay();
            }
            
            // ìº˜ë¦°ë” ë™ê¸°í™”
            await saveToDailyLog(new Date(), 'water', {
                amount: currentIntake
            });
            
            showToast(`âœ… ${amount}ml ì¶”ê°€! (ì´ ${currentIntake}ml)`);
        }
        
        // ë¬¼ ë§ˆì‹  ê¸°ë¡ ì·¨ì†Œ ê¸°ëŠ¥
        async function removeWaterRecord(recordId) {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"filled": [], "cupSize": 250, "records": []}');
            
            if (!settings.records || settings.records.length === 0) {
                showToast('ì·¨ì†Œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // IDë¥¼ ìˆ«ìë¡œ ë³€í™˜ ì‹œë„ (ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
            const idToFind = typeof recordId === 'string' && !isNaN(recordId) ? parseFloat(recordId) : recordId;
            
            // ê¸°ë¡ ì°¾ê¸° ë° ì‚­ì œ (ID ë¹„êµ - ìˆ«ì ë˜ëŠ” ë¬¸ìì—´ ëª¨ë‘ ì²˜ë¦¬)
            const recordIndex = settings.records.findIndex(r => {
                return r.id == idToFind || String(r.id) === String(idToFind);
            });
            if (recordIndex === -1) {
                showToast('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const removedRecord = settings.records.splice(recordIndex, 1)[0];
            
            // ì´ ì„­ì·¨ëŸ‰ ì¬ê³„ì‚°
            const currentIntake = settings.records.reduce((sum, r) => sum + r.amount, 0);
            
            // ì»µ ê°œìˆ˜ë¡œ ë³€í™˜
            const cupSize = settings.cupSize || 250;
            const newCupCount = Math.ceil(currentIntake / cupSize);
            settings.filled = Array.from({length: newCupCount}, (_, i) => i);
            
            localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));
            updateWaterTracker();
            
            // ë‹¨ì‹ íƒ­ ë™ê¸°í™”
            if (document.getElementById('fastingWaterIntake')) {
                updateFastingWaterDisplay();
            }
            
            // ìº˜ë¦°ë” ë™ê¸°í™”
            await saveToDailyLog(new Date(), 'water', {
                amount: currentIntake
            });
            
            showToast(`âœ… ${removedRecord.amount}ml ì·¨ì†Œë¨ (ì´ ${currentIntake}ml)`);
        }

        // ì»¤ìŠ¤í…€ ë¬¼ ë²„íŠ¼ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function getCustomWaterButtons() {
            const saved = localStorage.getItem('customWaterButtons');
            if (saved) {
                return JSON.parse(saved);
            }
            // ê¸°ë³¸ ë²„íŠ¼ë“¤
            return [250, 500];
        }

        function saveCustomWaterButtons(buttons) {
            localStorage.setItem('customWaterButtons', JSON.stringify(buttons));
        }

        function renderWaterButtons() {
            const container = document.getElementById('waterButtonsContainer');
            if (!container) return;

            const buttons = getCustomWaterButtons();
            container.innerHTML = '';

            buttons.forEach((amount, index) => {
                const buttonWrapper = document.createElement('div');
                buttonWrapper.style.position = 'relative';
                buttonWrapper.style.display = 'inline-block';

                const button = document.createElement('button');
                button.setAttribute('data-amount', amount); // data ì†ì„±ìœ¼ë¡œ amount ì €ì¥
                button.onclick = function() {
                    const btnAmount = parseInt(this.getAttribute('data-amount'));
                    addWater(btnAmount);
                };
                button.style.cssText = 'padding: 12px 20px; background: #2196f3; color: white; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(33,150,243,0.3); transition: all 0.2s; position: relative;';
                button.onmouseover = function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(33,150,243,0.4)';
                };
                button.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 8px rgba(33,150,243,0.3)';
                };
                
                // ë²„íŠ¼ í…ìŠ¤íŠ¸ (mlì— ë”°ë¼ ì´ëª¨ì§€ ê°œìˆ˜ ì¡°ì •)
                const emojiCount = amount >= 1000 ? 3 : amount >= 500 ? 2 : 1;
                button.textContent = `+${amount}ml ${'ğŸ’§'.repeat(emojiCount)}`;

                // ì‚­ì œ ë²„íŠ¼
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'âœ•';
                deleteBtn.style.cssText = 'position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #f44336; color: white; border: none; border-radius: 50%; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(244,67,54,0.4); transition: all 0.2s; z-index: 10;';
                deleteBtn.onmouseover = function() {
                    this.style.transform = 'scale(1.1)';
                    this.style.background = '#d32f2f';
                };
                deleteBtn.onmouseout = function() {
                    this.style.transform = 'scale(1)';
                    this.style.background = '#f44336';
                };
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeCustomWaterButton(index);
                };

                buttonWrapper.appendChild(button);
                buttonWrapper.appendChild(deleteBtn);
                container.appendChild(buttonWrapper);
            });
        }

        function addCustomWaterButton() {
            const input = document.getElementById('customWaterAmount');
            if (!input) return;

            const amount = parseInt(input.value);
            if (!amount || amount <= 0) {
                showToast('ì˜¬ë°”ë¥¸ ì–‘ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (1ml ì´ìƒ)');
                return;
            }

            const buttons = getCustomWaterButtons();
            if (buttons.includes(amount)) {
                showToast('ì´ë¯¸ ê°™ì€ ì–‘ì˜ ë²„íŠ¼ì´ ìˆìŠµë‹ˆë‹¤');
                return;
            }

            buttons.push(amount);
            buttons.sort((a, b) => a - b); // ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
            saveCustomWaterButtons(buttons);
            renderWaterButtons();
            
            input.value = '';
            showToast(`âœ… ${amount}ml ë²„íŠ¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
        }

        function removeCustomWaterButton(index) {
            const buttons = getCustomWaterButtons();
            if (buttons.length <= 1) {
                showToast('ìµœì†Œ 1ê°œì˜ ë²„íŠ¼ì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤');
                return;
            }

            const removed = buttons.splice(index, 1)[0];
            saveCustomWaterButtons(buttons);
            renderWaterButtons();
            showToast(`âœ… ${removed}ml ë²„íŠ¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`);
        }

        async function toggleWaterCup(index) {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS));
            if (!settings.filled) settings.filled = [];

            // ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸
            const today = new Date().toISOString().split('T')[0];
            if (settings.lastDate !== today) {
                // ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë©´ ì´ˆê¸°í™”
                settings.filled = [];
                settings.lastDate = today;
            }

            const idx = settings.filled.indexOf(index);
            if (idx > -1) {
                // ì²´í¬ í•´ì œ
                settings.filled.splice(idx, 1);
            } else {
                // ì²´í¬
                settings.filled.push(index);
            }

            localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));
            updateWaterTracker();

            // ========== ë‹¨ì‹ íƒ­ ë¬¼ ì„­ì·¨ëŸ‰ ë™ê¸°í™” ==========
            if (document.getElementById('fastingWaterIntake')) {
                updateFastingWaterDisplay();
            }
            // ==========================================

            // ========== ìº˜ë¦°ë” ë™ê¸°í™” (ì²´í¬/ì²´í¬ í•´ì œ ëª¨ë‘ ë°˜ì˜) ==========
            const cupSize = settings.cupSize || 250;
            const totalIntake = settings.filled.length * cupSize;

            if (totalIntake > 0) {
                // ë¬¼ ì„­ì·¨ëŸ‰ì´ ìˆìœ¼ë©´ ìº˜ë¦°ë”ì— ì €ì¥
                await saveToDailyLog(new Date(), 'water', {
                    amount: totalIntake
                });
            } else {
                // 0mlì´ë©´ ìº˜ë¦°ë”ì—ì„œ ì‚­ì œ
                await removeFromDailyLog(new Date(), 'water');
            }
            
            // ìº˜ë¦°ë”ê°€ í˜„ì¬ ì—´ë ¤ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
            if (currentTab === 'calendar' && typeof renderCalendar === 'function') {
                renderCalendar();
            }
            // ==========================================
        }

        // ==================== í”Œëœ íƒ­ (ì‹œê°„í‘œ í˜•ì‹) ====================
        let timetableData = {};  // {hour: {text: '', emoji: ''}}

        // ì£¼ê°„ í†µê³„ ë Œë”ë§
        function renderWeeklyStats() {
            const container = document.getElementById('weeklyStats');
            if (!container) return;

            const today = new Date();
            const dayOfWeek = today.getDay(); // 0(ì¼) ~ 6(í† )
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // ì´ë²ˆ ì£¼ ì›”ìš”ì¼

            const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = dateStr === today.toISOString().split('T')[0];
                const isFuture = date > today;

                // í•´ë‹¹ ë‚ ì§œì˜ ëª©í‘œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                let completed = 0;
                let total = 6; // ê¸°ë³¸ ëª©í‘œ 6ê°œ

                if (!isFuture) {
                    const saved = localStorage.getItem(`diet_goals_${dateStr}`);
                    if (saved) {
                        const goals = JSON.parse(saved);
                        // ì²´í¬ëœ ê¸°ë³¸ ëª©í‘œ ê°œìˆ˜
                        if (goals.water) completed++;
                        if (goals.fasting) completed++;
                        if (goals.dinner) completed++;
                        if (goals.exercise) completed++;
                        if (goals.calories) completed++;
                        if (goals.weight) completed++;
                        
                        // ì»¤ìŠ¤í…€ ëª©í‘œ ê°œìˆ˜ ì¶”ê°€
                        if (goals.custom && goals.custom.length > 0) {
                            total += goals.custom.length;
                            goals.custom.forEach(g => {
                                if (g.completed) completed++;
                            });
                        }
                    }
                }

                // ë‹¬ì„±ë¥  ê³„ì‚°
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                let circleClass = 'stat-circle';
                let bgColor = '#e9ecef';
                
                if (isToday) {
                    circleClass += ' today';
                } else if (isFuture) {
                    circleClass += ' future';
                } else if (percentage === 100) {
                    // 100% ë‹¬ì„± ì‹œ ê¸ˆìƒ‰
                    bgColor = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                } else if (percentage >= 80) {
                    // 80% ì´ìƒ ë…¹ìƒ‰
                    bgColor = 'linear-gradient(135deg, #00D4AA 0%, #009688 100%)';
                } else if (percentage >= 50) {
                    // 50% ì´ìƒ ë…¸ë€ìƒ‰
                    bgColor = 'linear-gradient(135deg, #FFC107 0%, #FF9800 100%)';
                } else if (percentage > 0) {
                    // 50% ë¯¸ë§Œ ë¹¨ê°„ìƒ‰
                    bgColor = 'linear-gradient(135deg, #FF5252 0%, #F44336 100%)';
                }

                html += `
                    <div class="stat-item">
                        <div class="stat-day">${days[i]}</div>
                        <div class="${circleClass}" style="${!isToday && !isFuture && completed > 0 ? `background: ${bgColor}; color: white;` : ''}">
                            ${isFuture ? '-' : `${completed}/${total}`}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        async function loadPlanTab() {
            // ëª©í‘œ ë¡œë“œ
            loadGoals();

            // ì¼ê¸° ë¡œë“œ
            loadDiary();

            // ëª©í‘œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™)
            updateGoalStatus();

            // ì£¼ê°„ í†µê³„ ë Œë”ë§
            renderWeeklyStats();
        }

        async function initializeTimetable() {
            const container = document.getElementById('timetableContainer');
            container.innerHTML = '';

            // ì˜¤ëŠ˜ ì €ì¥ëœ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
            const today = new Date().toISOString().split('T')[0];
            const savedTimetable = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('timetables').doc(today).get();

            if (savedTimetable.exists) {
                timetableData = savedTimetable.data().schedule || {};
            } else {
                timetableData = {};
            }

            // 06:00 ~ 23:00ê¹Œì§€ ì‹œê°„í‘œ ìƒì„±
            for (let hour = 6; hour <= 23; hour++) {
                const timeStr = `${String(hour).padStart(2, '0')}:00`;
                const row = createTimetableRow(hour, timetableData[hour] || {});
                container.appendChild(row);
            }
        }

        function createTimetableRow(hour, data) {
            const row = document.createElement('div');
            row.className = 'timetable-row';

            const timeStr = `${String(hour).padStart(2, '0')}:00`;

            row.innerHTML = `
                <div class="timetable-time">${timeStr}</div>
                <div class="timetable-input-wrapper">
                    <button class="timetable-emoji-btn" onclick="showEmojiPicker(${hour}, event)">
                        ${data.emoji || 'â•'}
                    </button>
                    <input
                        type="text"
                        class="timetable-input"
                        id="timetable-${hour}"
                        placeholder="ì¼ì •ì„ ì…ë ¥í•˜ì„¸ìš”..."
                        value="${data.text || ''}"
                        oninput="saveTimetableDebounced(${hour})"
                    />
                    ${data.text ? `<button class="timetable-clear-btn" onclick="clearTimetableRow(${hour})">âœ•</button>` : ''}
                </div>
            `;

            return row;
        }

        // ë””ë°”ìš´ìŠ¤ë¡œ ìë™ ì €ì¥
        let timetableSaveTimeout = null;

        function saveTimetableDebounced(hour) {
            clearTimeout(timetableSaveTimeout);
            timetableSaveTimeout = setTimeout(() => {
                saveTimetable(hour);
            }, 500);
        }

        async function saveTimetable(hour) {
            const input = document.getElementById(`timetable-${hour}`);
            const text = input.value.trim();

            // ì‹œê°„í‘œ ë°ì´í„° ì—…ë°ì´íŠ¸
            if (!timetableData[hour]) {
                timetableData[hour] = {};
            }
            timetableData[hour].text = text;

            // Firebaseì— ì €ì¥
            const today = new Date().toISOString().split('T')[0];
            await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('timetables').doc(today).set({
                    date: today,
                    schedule: timetableData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

            // UI ì—…ë°ì´íŠ¸ (ì‚­ì œ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€)
            await initializeTimetable();
        }

        function showEmojiPicker(hour, event) {
            event.stopPropagation();

            // ê¸°ì¡´ í”¼ì»¤ ì œê±°
            const existingPicker = document.querySelector('.timetable-emoji-picker');
            if (existingPicker) {
                existingPicker.remove();
            }

            const picker = document.createElement('div');
            picker.className = 'timetable-emoji-picker show';

            const emojis = ['ğŸƒ', 'ğŸ½ï¸', 'ğŸ’§', 'ğŸ“š', 'ğŸ’¼', 'ğŸ›Œ', 'ğŸ¯', 'ğŸ®', 'ğŸ“±', 'ğŸš¶', 'ğŸ§˜', 'ğŸ’ª', 'â˜•', 'ğŸµ'];

            emojis.forEach(emoji => {
                const option = document.createElement('span');
                option.className = 'timetable-emoji-option';
                option.textContent = emoji;
                option.onclick = () => selectEmoji(hour, emoji);
                picker.appendChild(option);
            });

            event.target.parentElement.appendChild(picker);

            // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            setTimeout(() => {
                document.addEventListener('click', closeEmojiPicker, { once: true });
            }, 0);
        }

        function closeEmojiPicker() {
            const picker = document.querySelector('.timetable-emoji-picker');
            if (picker) {
                picker.remove();
            }
        }

        async function selectEmoji(hour, emoji) {
            if (!timetableData[hour]) {
                timetableData[hour] = {};
            }
            timetableData[hour].emoji = emoji;

            // Firebaseì— ì €ì¥
            const today = new Date().toISOString().split('T')[0];
            await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('timetables').doc(today).set({
                    date: today,
                    schedule: timetableData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

            closeEmojiPicker();
            await initializeTimetable();
        }

        async function clearTimetableRow(hour) {
            timetableData[hour] = { text: '', emoji: '' };

            // Firebaseì— ì €ì¥
            const today = new Date().toISOString().split('T')[0];
            await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('timetables').doc(today).set({
                    date: today,
                    schedule: timetableData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

            await initializeTimetable();
        }

        // ========== Phase 2: ì‹œê°„í‘œ & ì¼ê¸° í•¨ìˆ˜ ==========

        let dailySchedules = [];  // ì˜¤ëŠ˜ì˜ ì¼ì • ë°°ì—´

        // ì¼ì • í•­ëª© ì¶”ê°€ (ëª¨ë‹¬ ì—´ê¸°)
        function addScheduleItem() {
            document.getElementById('scheduleTimeInput').value = '07:00';
            document.getElementById('scheduleActivityInput').value = '';
            openModernModal('scheduleModal');
        }
        
        // ì¼ì • í•­ëª© ì œì¶œ
        function submitScheduleItem() {
            const time = document.getElementById('scheduleTimeInput').value;
            const activity = document.getElementById('scheduleActivityInput').value;
            
            if (!time || !activity) {
                showErrorToast('ì‹œê°„ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            closeModernModal('scheduleModal');

            const scheduleId = Date.now();
            dailySchedules.push({
                id: scheduleId,
                time: time,
                activity: activity
            });

            renderScheduleList();
            saveDailyPlan();
            showSuccessToast('ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        // ì¼ì • í•­ëª© ì‚­ì œ
        function removeScheduleItem(scheduleId) {
            dailySchedules = dailySchedules.filter(s => s.id !== scheduleId);
            renderScheduleList();
            saveDailyPlan();
        }

        // ì¼ì • ëª©ë¡ ë Œë”ë§
        function renderScheduleList() {
            const scheduleList = document.getElementById('scheduleList');
            if (!scheduleList) return;

            if (dailySchedules.length === 0) {
                scheduleList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            scheduleList.innerHTML = dailySchedules.map(schedule => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <input type="time" value="${schedule.time}"
                           onchange="updateScheduleTime(${schedule.id}, this.value)"
                           style="padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
                    <input type="text" value="${schedule.activity}"
                           onchange="updateScheduleActivity(${schedule.id}, this.value)"
                           style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
                    <button onclick="removeScheduleItem(${schedule.id})"
                            style="padding: 5px 10px; background: #ff5252; color: white; border: none; border-radius: 5px; cursor: pointer;">Ã—</button>
                </div>
            `).join('');
        }

        // ì¼ì • ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateScheduleTime(scheduleId, newTime) {
            const schedule = dailySchedules.find(s => s.id === scheduleId);
            if (schedule) {
                schedule.time = newTime;
                saveDailyPlan();
            }
        }

        // ì¼ì • ë‚´ìš© ì—…ë°ì´íŠ¸
        function updateScheduleActivity(scheduleId, newActivity) {
            const schedule = dailySchedules.find(s => s.id === scheduleId);
            if (schedule) {
                schedule.activity = newActivity;
                saveDailyPlan();
            }
        }

        // ì¼ì • & ì¼ê¸° ì €ì¥
        // ==================== í”Œëœ íƒ­ - ëª©í‘œ ê´€ë¦¬ ====================
        let todayGoals = [];
        let customGoals = [];

        // ëª©í‘œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™)
        function updateGoalStatus() {
            // 1. ë¬¼ ë§ˆì‹œê¸°
            const waterSettings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"goalLiters": 2, "filled": []}');
            const cupSize = waterSettings.cupSize || 250;
            const goalLiters = waterSettings.goalLiters || 2;
            const filledCount = waterSettings.filled?.length || 0;
            const currentLiters = (filledCount * cupSize / 1000).toFixed(1);
            
            document.getElementById('goal-water-text').textContent = `ë¬¼ ${goalLiters}L ë§ˆì‹œê¸°`;
            document.getElementById('goal-water-status').textContent = `${currentLiters}L / ${goalLiters}L`;
            
            const waterPercent = (currentLiters / goalLiters) * 100;
            const waterStatus = document.getElementById('goal-water-status');
            if (waterPercent >= 100) {
                waterStatus.className = 'goal-status success';
                document.getElementById('goal-water').checked = true;
            } else if (waterPercent >= 70) {
                waterStatus.className = 'goal-status warning';
            } else {
                waterStatus.className = 'goal-status';
            }

            // 2. ê°„í—ì  ë‹¨ì‹
            const fastingState = JSON.parse(localStorage.getItem(LS_KEYS.FASTING) || '{"active": false}');
            if (fastingState.active && fastingState.targetHours) {
                const elapsed = Date.now() - fastingState.startTime;
                const hours = Math.floor(elapsed / 3600000);
                const targetHours = fastingState.targetHours;
                
                document.getElementById('goal-fasting-text').textContent = `ê°„í—ì  ë‹¨ì‹ ${targetHours}ì‹œê°„`;
                document.getElementById('goal-fasting-status').textContent = `${hours}h / ${targetHours}h`;
                
                if (hours >= targetHours) {
                    document.getElementById('goal-fasting-status').className = 'goal-status success';
                    document.getElementById('goal-fasting').checked = true;
                } else {
                    document.getElementById('goal-fasting-status').className = 'goal-status';
                }
            } else {
                document.getElementById('goal-fasting-status').textContent = 'ë¯¸ì§„í–‰';
                document.getElementById('goal-fasting-status').className = 'goal-status';
            }

            // 3. ì €ë… 8ì‹œ ì´í›„ ê¸ˆì‹
            if (todayIntake.meals && todayIntake.meals.length > 0) {
                const lastMeal = todayIntake.meals[todayIntake.meals.length - 1];
                const lastMealTime = new Date(lastMeal.timestamp);
                const lastMealHour = lastMealTime.getHours();
                
                if (lastMealHour < 20) {
                    document.getElementById('goal-dinner-status').textContent = `ë§ˆì§€ë§‰ ì‹ì‚¬ ${lastMealHour}ì‹œ`;
                    document.getElementById('goal-dinner-status').className = 'goal-status success';
                    document.getElementById('goal-dinner').checked = true;
                } else {
                    document.getElementById('goal-dinner-status').textContent = `ë§ˆì§€ë§‰ ì‹ì‚¬ ${lastMealHour}ì‹œ`;
                    document.getElementById('goal-dinner-status').className = 'goal-status danger';
                }
            } else {
                document.getElementById('goal-dinner-status').textContent = 'ì‹ì‚¬ ê¸°ë¡ ì—†ìŒ';
            }

            // 4. ëª©í‘œ ì¹¼ë¡œë¦¬ (ì‚¬ìš©ì ì„¤ì • ìš°ì„ , ì—†ìœ¼ë©´ í”„ë¡œí•„ ê³„ì‚°ê°’)
            const userTargetCal = parseInt(localStorage.getItem('goal_calories_target'));
            const targetCal = userTargetCal || dailyNutrition.totalCalories || 1620;
            const currentCal = todayIntake.calories || 0;
            
            document.getElementById('goal-calories-text').textContent = `ëª©í‘œ ì¹¼ë¡œë¦¬ ì§€í‚¤ê¸°`;
            document.getElementById('goal-calories-status').textContent = `${Math.round(currentCal)} / ${targetCal}kcal`;
            
            const calStatus = document.getElementById('goal-calories-status');
            if (currentCal <= targetCal && currentCal > 0) {
                calStatus.className = 'goal-status success';
                document.getElementById('goal-calories').checked = true;
            } else if (currentCal > targetCal) {
                calStatus.className = 'goal-status danger';
                document.getElementById('goal-calories').checked = false;
            } else {
                calStatus.className = 'goal-status';
            }

            // 5. ì²´ì¤‘ ê¸°ë¡
            checkTodayWeightRecord();
        }

        // ëª©í‘œ ì €ì¥
        function saveGoals() {
            const goals = {
                'goal-water': document.getElementById('goal-water')?.checked || false,
                'goal-fasting': document.getElementById('goal-fasting')?.checked || false,
                'goal-dinner': document.getElementById('goal-dinner')?.checked || false,
                'goal-exercise': document.getElementById('goal-exercise')?.checked || false,
                'goal-calories': document.getElementById('goal-calories')?.checked || false,
                'goal-weight': document.getElementById('goal-weight')?.checked || false,
                customGoals: customGoals
            };

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem(`diet_goals_${today}`, JSON.stringify(goals));

            // Firebase dailyPlansì— ëª©í‘œ ì €ì¥ (ìº˜ë¦°ë” ë™ê¸°í™”ìš©)
            if (currentUser) {
                db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyPlans').doc(today)
                    .set({ goals: goals }, { merge: true })
                    .catch(error => console.error('ëª©í‘œ ì €ì¥ ì‹¤íŒ¨:', error));
            }

            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            updateGoalProgress();
            
            // ì£¼ê°„ í†µê³„ ì—…ë°ì´íŠ¸
            renderWeeklyStats();
        }

        // ëª©í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadGoals() {
            const today = new Date().toISOString().split('T')[0];
            const saved = localStorage.getItem(`diet_goals_${today}`);

            if (saved) {
                const goals = JSON.parse(saved);
                document.getElementById('goal-water').checked = goals['goal-water'] || false;
                document.getElementById('goal-fasting').checked = goals['goal-fasting'] || false;
                document.getElementById('goal-dinner').checked = goals['goal-dinner'] || false;
                document.getElementById('goal-exercise').checked = goals['goal-exercise'] || false;
                document.getElementById('goal-calories').checked = goals['goal-calories'] || false;
                document.getElementById('goal-weight').checked = goals['goal-weight'] || false;
                customGoals = goals.customGoals || [];
                renderCustomGoals();
            }

            // âœ… ì²´ì¤‘ ê¸°ë¡ ìë™ ì²´í¬
            checkTodayWeightRecord();

            updateGoalProgress();
        }

        // ì˜¤ëŠ˜ ì²´ì¤‘ ê¸°ë¡ í™•ì¸ ë° ìë™ ì²´í¬
        async function checkTodayWeightRecord() {
            if (!currentUser) return;

            try {
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const todayEnd = new Date(todayStart.getTime() + 86400000);

                const weightSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(todayStart))
                    .where('date', '<', firebase.firestore.Timestamp.fromDate(todayEnd))
                    .limit(1)
                    .get();

                const weightCheckbox = document.getElementById('goal-weight');
                const weightStatus = document.getElementById('goal-weight-status');

                if (!weightSnapshot.empty) {
                    // ì˜¤ëŠ˜ ì²´ì¤‘ ê¸°ë¡ ìˆìŒ
                    weightCheckbox.checked = true;
                    const weight = weightSnapshot.docs[0].data().weight;
                    // ì†Œìˆ˜ì  1ìë¦¬ê¹Œì§€ í‘œì‹œ
                    weightStatus.textContent = `${parseFloat(weight).toFixed(1)}kg ê¸°ë¡ë¨`;
                    weightStatus.style.color = '#4caf50';
                    console.log('âœ… ì²´ì¤‘ ìë™ ì²´í¬:', weight, 'kg');
                } else {
                    // ì˜¤ëŠ˜ ì²´ì¤‘ ê¸°ë¡ ì—†ìŒ
                    weightCheckbox.checked = false;
                    weightStatus.textContent = 'ë¯¸ê¸°ë¡';
                    weightStatus.style.color = '#999';
                }

                // ëª©í‘œ ì €ì¥ (ìë™ ì²´í¬ ë°˜ì˜)
                saveGoals();
            } catch (error) {
                console.error('ì²´ì¤‘ ê¸°ë¡ í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateGoalProgress() {
            const checkboxes = document.querySelectorAll('.goal-checklist input[type="checkbox"]');
            const customChecks = document.querySelectorAll('.custom-goal-item input[type="checkbox"]');
            
            const totalGoals = checkboxes.length + customChecks.length;
            let completedGoals = 0;

            checkboxes.forEach(cb => {
                if (cb.checked) completedGoals++;
            });

            customChecks.forEach(cb => {
                if (cb.checked) completedGoals++;
            });

            const percentage = totalGoals > 0 ? Math.round((completedGoals / totalGoals) * 100) : 0;

            document.getElementById('goalProgressBar').style.width = percentage + '%';
            document.getElementById('goalProgressText').textContent = 
                `${completedGoals} / ${totalGoals} ì™„ë£Œ (${percentage}%)`;

            // ì „ë¶€ ì™„ë£Œ ì‹œ ì¶•í•˜ ë©”ì‹œì§€
            if (completedGoals === totalGoals && totalGoals > 0) {
                showAIToast('ğŸ‰ ì˜¤ëŠ˜ì˜ ëª¨ë“  ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! ì •ë§ ëŒ€ë‹¨í•´ìš”!', 5000);
            }
        }

        // ì»¤ìŠ¤í…€ ëª©í‘œ ì¶”ê°€
        function addCustomGoal() {
            const input = document.getElementById('customGoalInput');
            const goalText = input.value.trim();

            if (!goalText) {
                alert('ëª©í‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (customGoals.length >= 5) {
                alert('ì»¤ìŠ¤í…€ ëª©í‘œëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            customGoals.push({
                text: goalText,
                completed: false,
                id: Date.now()
            });

            input.value = '';
            renderCustomGoals();
            saveGoals();
        }

        // ==================== ëª©í‘œ í¸ì§‘ ê¸°ëŠ¥ (ì¸ë¼ì¸ í¸ì§‘) ====================
        // ëª©í‘œ ì¹¼ë¡œë¦¬ ì´ˆê¸°í™” í•¨ìˆ˜
        function resetCalorieGoal() {
            if (confirm('ëª©í‘œ ì¹¼ë¡œë¦¬ë¥¼ í”„ë¡œí•„ ê¸°ë°˜ ê³„ì‚°ê°’ìœ¼ë¡œ ì¬ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í‚¤, ëª¸ë¬´ê²Œ, ì„±ë³„, í™œë™ëŸ‰ ê¸°ë°˜)')) {
                localStorage.removeItem('goal_calories_target');
                showToast('âœ… ëª©í‘œ ì¹¼ë¡œë¦¬ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadPlanTab(); // í”Œëœ íƒ­ ìƒˆë¡œê³ ì¹¨
            }
        }

        function editGoalText(goalType, promptText) {
            // caloriesëŠ” status ìš”ì†Œë¥¼ í¸ì§‘
            const textEl = goalType === 'calories' 
                ? document.getElementById(`goal-${goalType}-status`)
                : document.getElementById(`goal-${goalType}-text`);
            
            if (!textEl) return;

            // í˜„ì¬ ê°’ ì¶”ì¶œ
            let currentValue;
            if (goalType === 'water') {
                currentValue = parseFloat(localStorage.getItem('goal_water_target') || '2');
            } else if (goalType === 'fasting') {
                currentValue = parseInt(localStorage.getItem('goal_fasting_hours') || '16');
            } else if (goalType === 'dinner') {
                currentValue = parseInt(localStorage.getItem('goal_dinner_hour') || '20');
            } else if (goalType === 'exercise') {
                currentValue = parseInt(localStorage.getItem('goal_exercise_minutes') || '30');
            } else if (goalType === 'calories') {
                currentValue = parseInt(localStorage.getItem('goal_calories_target') || '1620');
            }

            // ì›ë˜ í…ìŠ¤íŠ¸ ë°±ì—…
            const originalText = textEl.textContent;

            // ì¸ë¼ì¸ ì…ë ¥ í•„ë“œ ìƒì„±
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.style.cssText = 'width: 80px; padding: 5px; border: 2px solid #667eea; border-radius: 8px; font-size: 0.95rem; text-align: center; font-weight: 600;';
            
            if (goalType === 'water') {
                input.step = '0.1';
                input.min = '0.5';
                input.max = '10';
            } else if (goalType === 'fasting') {
                input.min = '1';
                input.max = '48';
            } else if (goalType === 'dinner') {
                input.min = '0';
                input.max = '23';
            } else if (goalType === 'exercise') {
                input.min = '5';
                input.max = '300';
            } else if (goalType === 'calories') {
                input.min = '500';
                input.max = '5000';
                input.step = '50';
                input.style.width = '100px';
            }

            // ì €ì¥/ì·¨ì†Œ í•¨ìˆ˜
            const save = () => {
                const newValue = goalType === 'water' ? parseFloat(input.value) : parseInt(input.value);

                // ìœ íš¨ì„± ê²€ì‚¬
                if (isNaN(newValue) || newValue <= 0) {
                    showToast('âŒ ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    textEl.textContent = originalText;
                    return;
                }

                // ê°’ ì €ì¥
                if (goalType === 'water') {
                    localStorage.setItem('goal_water_target', newValue);
                    textEl.textContent = `ë¬¼ ${newValue}L ë§ˆì‹œê¸°`;
                } else if (goalType === 'fasting') {
                    localStorage.setItem('goal_fasting_hours', newValue);
                    textEl.textContent = `ê°„í—ì  ë‹¨ì‹ ${newValue}ì‹œê°„`;
                } else if (goalType === 'dinner') {
                    localStorage.setItem('goal_dinner_hour', newValue);
                    textEl.textContent = `ì €ë… ${newValue}ì‹œ ì´í›„ ê¸ˆì‹`;
                } else if (goalType === 'exercise') {
                    localStorage.setItem('goal_exercise_minutes', newValue);
                    textEl.textContent = `ìš´ë™ ${newValue}ë¶„ ì´ìƒ`;
                } else if (goalType === 'calories') {
                    localStorage.setItem('goal_calories_target', newValue);
                    // goal-calories-status ì—…ë°ì´íŠ¸ í•„ìš”
                    loadPlanTab(); // í”Œëœ íƒ­ ìƒˆë¡œê³ ì¹¨
                }

                showToast(`âœ… ëª©í‘œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            };

            const cancel = () => {
                textEl.textContent = originalText;
            };

            // í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥ í•„ë“œë¡œ êµì²´
            textEl.textContent = '';
            textEl.appendChild(input);
            input.focus();
            input.select();

            // Enter: ì €ì¥
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    save();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancel();
                }
            });

            // í¬ì»¤ìŠ¤ ìƒìœ¼ë©´ ì €ì¥
            input.addEventListener('blur', () => {
                setTimeout(save, 100);
            });
        }

        // ì»¤ìŠ¤í…€ ëª©í‘œ ë Œë”ë§
        function renderCustomGoals() {
            const container = document.getElementById('customGoalsList');
            if (!container) return;

            container.innerHTML = customGoals.map(goal => `
                <div class="custom-goal-item">
                    <input type="checkbox" 
                           id="custom-goal-${goal.id}" 
                           ${goal.completed ? 'checked' : ''}
                           onchange="toggleCustomGoal(${goal.id})">
                    <span class="goal-icon">â­</span>
                    <span class="goal-text">${goal.text}</span>
                    <button class="delete-btn" onclick="deleteCustomGoal(${goal.id})">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        }

        // ì»¤ìŠ¤í…€ ëª©í‘œ í† ê¸€
        function toggleCustomGoal(id) {
            const goal = customGoals.find(g => g.id === id);
            if (goal) {
                goal.completed = !goal.completed;
                saveGoals();
            }
        }

        // ì»¤ìŠ¤í…€ ëª©í‘œ ì‚­ì œ
        function deleteCustomGoal(id) {
            if (confirm('ì´ ëª©í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                customGoals = customGoals.filter(g => g.id !== id);
                renderCustomGoals();
                saveGoals();
            }
        }

        // ì¼ê¸° ì €ì¥ (ê¸°ì¡´ í•¨ìˆ˜ ëŒ€ì²´)
        function saveDiary() {
            const diary = document.getElementById('dailyDiary')?.value || '';
            const today = new Date().toISOString().split('T')[0];

            localStorage.setItem(`diet_diary_${today}`, diary);

            if (currentUser) {
                db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('diaries').doc(today)
                    .set({
                        content: diary.substring(0, 500),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true })
                    .catch(error => console.error('ì¼ê¸° ì €ì¥ ì‹¤íŒ¨:', error));
            }
        }

        // ì¼ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadDiary() {
            const today = new Date().toISOString().split('T')[0];
            const saved = localStorage.getItem(`diet_diary_${today}`);

            if (saved) {
                const diaryEl = document.getElementById('dailyDiary');
                if (diaryEl) {
                    diaryEl.value = saved;
                    updateCharCount();
                }
            }
        }

        // ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateCharCount() {
            const diary = document.getElementById('dailyDiary')?.value || '';
            const charCount = Math.min(diary.length, 500);
            document.getElementById('diaryCharCount').textContent = charCount;
        }

        async function saveDailyPlan() {
            // ê¸°ì¡´ í•¨ìˆ˜ ìœ ì§€ (í˜¸í™˜ì„±)
            saveDiary();
        }

        // ì¼ì • & ì¼ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadDailyPlan() {
            if (!currentUser) return;

            try {
                const today = new Date().toISOString().split('T')[0];
                const doc = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyPlans').doc(today)
                    .get();

                if (doc.exists) {
                    const data = doc.data();
                    dailySchedules = data.schedules || [];

                    const diaryEl = document.getElementById('dailyDiary');
                    if (diaryEl) {
                        diaryEl.value = data.diary || '';
                        // ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
                        const charCount = diaryEl.value.length;
                        document.getElementById('diaryCharCount').textContent = charCount;
                    }

                    renderScheduleList();
                    console.log('ğŸ“¥ ì¼ì • & ì¼ê¸° ë¡œë“œ ì™„ë£Œ');
                }
            } catch (error) {
                console.error('âŒ ì¼ì • & ì¼ê¸° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ============================================

        async function suggestPlanWithAI() {
            // AIê°€ ì–´ì œ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ í”Œëœ ì¶”ì²œ
            const prompt = `ì‚¬ìš©ìì˜ ë‹¤ì´ì–´íŠ¸ ì•±ì„ ìœ„í•œ ì˜¤ëŠ˜ì˜ í”Œëœì„ 3-5ê°€ì§€ ì¶”ì²œí•´ì£¼ì„¸ìš”.
            í˜•ì‹: ì‹œê°„|ì¹´í…Œê³ ë¦¬|í™œë™ëª…|ì˜ˆìƒìˆ˜ì¹˜
            ì˜ˆì‹œ:
            07:00|ìš´ë™|ì•„ì¹¨ ì¡°ê¹…|30ë¶„
            12:00|ì‹ì‚¬|ì ì‹¬ (ì €ì—¼ì‹)|500kcal

            ê°„ë‹¨ëª…ë£Œí•˜ê²Œ ê° ì¤„ë§ˆë‹¤ í•˜ë‚˜ì”©ë§Œ ì‘ì„±í•´ì£¼ì„¸ìš”.`;

            const response = await callGeminiAPI(prompt);

            if (confirm(`AI ì¶”ì²œ í”Œëœ:\n\n${response}\n\nì´ í”Œëœë“¤ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const lines = response.trim().split('\n');
                for (const line of lines) {
                    const parts = line.split('|');
                    if (parts.length >= 3) {
                        await addPlan(parts[0].trim(), parts[1].trim(), parts[2].trim(), parts[3]?.trim() || '');
                    }
                }
                await loadPlanTab();
            }
        }

        // ==================== ë‹¨ì‹ íƒ­ ====================
        async function initializeFasting() {
            const saved = localStorage.getItem(LS_KEYS.FASTING);
            if (saved) {
                fastingState = JSON.parse(saved);
                if (fastingState.active) {
                    // UI ì „í™˜
                    document.getElementById('fastingPresetSection').style.display = 'none';
                    document.getElementById('fastingActiveControls').style.display = 'flex';
                    
                    // ì¼ì‹œì •ì§€ ìƒíƒœ ë³µì›
                    if (fastingState.paused) {
                        document.getElementById('fastingPauseBtn').style.display = 'none';
                        document.getElementById('fastingResumeBtn').style.display = 'inline-block';
                        document.getElementById('fastingTimeSub').textContent = 'ì¼ì‹œì •ì§€ ì¤‘';
                    } else {
                        document.getElementById('fastingPauseBtn').style.display = 'inline-block';
                        document.getElementById('fastingResumeBtn').style.display = 'none';
                        startFastingTimer();
                    }
                }
            }

            // ëˆ„ì  ì‹œê°„ ë¡œë“œ
            await loadTodayFastingStats();
            
            // ìƒˆë¡œìš´ í†µê³„ ë¡œë“œ
            const stats = await calculateFastingStreak();
            await loadWeeklyFastingStatus();
            
            // ë°°ì§€ ì—…ë°ì´íŠ¸
            updateBadges(stats);
            
            // ì›”ê°„ ë‹¬ë ¥ & ë¦¬í¬íŠ¸
            currentReportMonth = new Date();
            document.getElementById('reportMonth').textContent = 
                `${currentReportMonth.getFullYear()}ë…„ ${currentReportMonth.getMonth() + 1}ì›”`;
            await loadMonthlyCalendar();
            await loadMonthlyReport();
            await loadWeeklyReport();
            
            // ì²´ì¤‘ ì—°ë™ ì°¨íŠ¸
            await loadFastingWeightChart();
            
            // ë¬¼ ì„­ì·¨ í‘œì‹œ
            await updateFastingWaterDisplay();
            
            // ë§ˆì§€ë§‰ ì‹ì‚¬ ì‹œê°„ í‘œì‹œ
            updateLastMealDisplay();
            
            // ë§ˆì§€ë§‰ ì‹ì‚¬ ì‹œê°„ ìë™ ì—…ë°ì´íŠ¸ (1ë¶„ë§ˆë‹¤)
            setInterval(updateLastMealDisplay, 60000);
            
            // ì•Œë¦¼ ê¶Œí•œì€ ì‚¬ìš©ì ì œìŠ¤ì²˜(ë²„íŠ¼ í´ë¦­)ì—ì„œë§Œ ìš”ì²­
            // requestNotificationPermission(); // ìë™ ìš”ì²­ ì œê±°
        }

        // ========== Phase 2: ë‹¨ì‹ í”„ë¦¬ì…‹ & ë‹¨ê³„ í•¨ìˆ˜ ==========

        // ë‹¨ì‹ ë‹¨ê³„ ì •ì˜
        const fastingStages = [
            { startHour: 0, endHour: 4, title: "ì†Œí™” ë‹¨ê³„", emoji: "ğŸ½ï¸", desc: "ìŒì‹ì„ ì†Œí™”í•˜ê³  ìˆìŠµë‹ˆë‹¤" },
            { startHour: 4, endHour: 8, title: "ë‹¹ ì†Œëª¨ ë‹¨ê³„", emoji: "âš¡", desc: "ì²´ë‚´ ë‹¹ì´ ì†Œëª¨ë˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤" },
            { startHour: 8, endHour: 12, title: "ì§€ë°© ì—°ì†Œ ì‹œì‘", emoji: "ğŸ”¥", desc: "ì§€ë°©ì´ ì—ë„ˆì§€ë¡œ ì „í™˜ë˜ê¸° ì‹œì‘í•©ë‹ˆë‹¤" },
            { startHour: 12, endHour: 16, title: "ìê°€í¬ì‹ í™œì„±í™”", emoji: "â™»ï¸", desc: "ì†ìƒëœ ì„¸í¬ê°€ ì¬ìƒë˜ê³  ìˆìŠµë‹ˆë‹¤" },
            { startHour: 16, endHour: 72, title: "ì‹¬í™” ìê°€í¬ì‹", emoji: "âœ¨", desc: "ê¹Šì€ ì„¸í¬ ì¬ìƒì´ ì¼ì–´ë‚˜ê³  ìˆìŠµë‹ˆë‹¤" }
        ];

        // í”„ë¦¬ì…‹ ì„¤ì • í•¨ìˆ˜
        function setFastingPreset(hours) {
            document.getElementById('fastingHours').value = hours;
            console.log(`âœ… ë‹¨ì‹ í”„ë¦¬ì…‹ ì„¤ì •: ${hours}ì‹œê°„`);
        }

        // í˜„ì¬ ë‹¨ì‹ ë‹¨ê³„ ê°€ì ¸ì˜¤ê¸°
        function getCurrentFastingStage(elapsedHours) {
            for (const stage of fastingStages) {
                if (elapsedHours >= stage.startHour && elapsedHours < stage.endHour) {
                    return stage;
                }
            }
            return fastingStages[fastingStages.length - 1];  // ë§ˆì§€ë§‰ ë‹¨ê³„ ë°˜í™˜
        }

        // ë‹¨ì‹ ë‹¨ê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateFastingStageDisplay(elapsedHours) {
            const stage = getCurrentFastingStage(elapsedHours);
            const stageDisplay = document.getElementById('fastingStageDisplay');

            if (stageDisplay) {
                stageDisplay.style.display = 'block';
                document.getElementById('fastingStageEmoji').textContent = stage.emoji;
                document.getElementById('fastingStageTitle').textContent = stage.title;
                document.getElementById('fastingStageDesc').textContent = stage.desc;
            }
        }

        // ===============================================

        // ========== ìƒˆë¡œìš´ ë¹ ë¥¸ ì‹œì‘ í•¨ìˆ˜ ==========
        function startFastingQuick(hours) {
            if (fastingState && fastingState.active) {
                alert('ì´ë¯¸ ë‹¨ì‹ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ë¨¼ì € ì¤‘ë‹¨í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (hours > 24) {
                if (!confirm(`${hours}ì‹œê°„ ë‹¨ì‹ì€ ê±´ê°•ì— ìœ„í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            }

            const now = Date.now();
            fastingState = {
                active: true,
                paused: false,
                startTime: now,
                duration: hours * 60 * 60 * 1000,
                endTime: now + (hours * 60 * 60 * 1000),
                pausedAt: null,
                totalPausedDuration: 0
            };

            localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));
            startFastingTimer();

            // UI ì „í™˜
            document.getElementById('fastingPresetSection').style.display = 'none';
            document.getElementById('fastingActiveControls').style.display = 'flex';
            document.getElementById('fastingStatusText').textContent = `${hours}ì‹œê°„ ë‹¨ì‹ ì§„í–‰ ì¤‘`;
            
            // í‘¸ì‹œ ì•Œë¦¼ ì˜ˆì•½
            scheduleFastingNotification(hours);
            
            console.log(`âœ… ${hours}ì‹œê°„ ë‹¨ì‹ ì‹œì‘!`);
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            setTimeout(async () => {
                const stats = await calculateFastingStreak();
                await loadWeeklyFastingStatus();
                await loadWeeklyReport();
                await loadMonthlyReport();
                await loadMonthlyCalendar();
                await loadFastingWeightChart();
                updateBadges(stats);
            }, 1000);
        }

        // ========== ì»¤ìŠ¤í…€ ë‹¨ì‹ ì‹œê°„ ì…ë ¥ ëª¨ë‹¬ ==========
        function openCustomFastingModal() {
            document.getElementById('customFastingInput').value = '16';
            // 16ì‹œê°„ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('#customFastingModal .modern-select-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === '16ì‹œê°„') btn.classList.add('active');
            });
            openModernModal('customFastingModal');
        }
        
        // ë‹¨ì‹ ì‹œê°„ ì„ íƒ ë²„íŠ¼
        function selectFastingHour(hours) {
            document.getElementById('customFastingInput').value = hours;
            document.querySelectorAll('#customFastingModal .modern-select-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }
        
        // ì»¤ìŠ¤í…€ ë‹¨ì‹ ì œì¶œ
        function submitCustomFasting() {
            const hours = parseInt(document.getElementById('customFastingInput').value);
            if (!hours || hours <= 0) {
                showErrorToast('ì˜¬ë°”ë¥¸ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            closeModernModal('customFastingModal');
            startFastingQuick(hours);
        }

        // ========== ì¼ì‹œì •ì§€ ê¸°ëŠ¥ ==========
        function pauseFasting() {
            if (!fastingState || !fastingState.active || fastingState.paused) return;

            fastingState.paused = true;
            fastingState.pausedAt = Date.now();
            localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));

            if (fastingInterval) {
                clearInterval(fastingInterval);
            }

            document.getElementById('fastingPauseBtn').style.display = 'none';
            document.getElementById('fastingResumeBtn').style.display = 'inline-block';
            document.getElementById('fastingTimeSub').textContent = 'ì¼ì‹œì •ì§€ ì¤‘';
            console.log('â¸ï¸ ë‹¨ì‹ ì¼ì‹œì •ì§€');
        }

        // ========== ì¬ê°œ ê¸°ëŠ¥ ==========
        function resumeFasting() {
            if (!fastingState || !fastingState.active || !fastingState.paused) return;

            const now = Date.now();
            const pausedDuration = now - fastingState.pausedAt;
            fastingState.totalPausedDuration += pausedDuration;
            fastingState.endTime += pausedDuration;  // ì¼ì‹œì •ì§€í•œ ë§Œí¼ ì¢…ë£Œ ì‹œê°„ ì—°ì¥
            fastingState.paused = false;
            fastingState.pausedAt = null;
            localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));

            startFastingTimer();

            document.getElementById('fastingPauseBtn').style.display = 'inline-block';
            document.getElementById('fastingResumeBtn').style.display = 'none';
            console.log('â–¶ï¸ ë‹¨ì‹ ì¬ê°œ');
        }

        // ===============================================

        function startFasting() {
            const hours = parseInt(document.getElementById('fastingHours').value) || 16;

            if (hours > 24) {
                if (!confirm('24ì‹œê°„ ì´ìƒì˜ ë‹¨ì‹ì€ ê±´ê°•ì— ìœ„í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }

            const now = Date.now();
            fastingState = {
                active: true,
                startTime: now,
                duration: hours * 60 * 60 * 1000,
                endTime: now + (hours * 60 * 60 * 1000)
            };

            localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));
            startFastingTimer();

            document.getElementById('fastingStartBtn').style.display = 'none';
            document.getElementById('fastingStopBtn').style.display = 'inline-block';
            document.getElementById('fastingDurationInput').style.display = 'none';
        }

        async function stopFasting() {

            // Firestoreì— ê¸°ë¡ ì €ì¥
            if (fastingState && fastingState.active) {
                try {
                    const now = Date.now();
                    const duration = now - fastingState.startTime - (fastingState.totalPausedDuration || 0);
                    const today = new Date().toISOString().split('T')[0];

                    await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                        .collection('fastingRecords').add({
                            startTime: firebase.firestore.Timestamp.fromMillis(fastingState.startTime),
                            endTime: firebase.firestore.Timestamp.fromMillis(now),
                            duration: duration,
                            date: today,
                            completed: false
                        });

                    // ëˆ„ì  ì‹œê°„ ìƒˆë¡œê³ ì¹¨
                    await loadTodayFastingStats();
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸
                    const stats = await calculateFastingStreak();
                    await loadWeeklyFastingStatus();
                    await loadWeeklyReport();
                    await loadMonthlyReport();
                    await loadMonthlyCalendar();
                    await loadFastingWeightChart();
                    updateBadges(stats);
                } catch (error) {
                    console.error('ë‹¨ì‹ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
                }
            }

            fastingState = null;
            localStorage.removeItem(LS_KEYS.FASTING);

            if (fastingInterval) {
                clearInterval(fastingInterval);
            }

            // UI ë¦¬ì…‹
            document.getElementById('fastingPresetSection').style.display = 'block';
            document.getElementById('fastingActiveControls').style.display = 'none';
            document.getElementById('fastingTimeMain').textContent = '00:00:00';
            document.getElementById('fastingStatusText').textContent = 'ë‹¨ì‹ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
            document.getElementById('fastingProgress').style.strokeDashoffset = 691;
            document.getElementById('fastingStageDisplay').style.display = 'none';
            
            // ì•Œë¦¼ ì·¨ì†Œ
            cancelFastingNotification();
        }

        function startFastingTimer() {
            updateFastingDisplay();
            fastingInterval = setInterval(updateFastingDisplay, 1000);
        }

        async function updateFastingDisplay() {
            if (!fastingState || !fastingState.active) return;
            
            // ì¼ì‹œì •ì§€ ìƒíƒœë©´ ì—…ë°ì´íŠ¸ ì¤‘ë‹¨
            if (fastingState.paused) return;

            const now = Date.now();
            const elapsed = now - fastingState.startTime - (fastingState.totalPausedDuration || 0);
            const remaining = fastingState.endTime - now;

            if (remaining <= 0) {
                // ë‹¨ì‹ ì™„ë£Œ - Firestoreì— ê¸°ë¡ ì €ì¥
                try {
                    await saveFastingRecord(true);  // completed: true
                } catch (error) {
                    console.error('ë‹¨ì‹ ì™„ë£Œ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
                }
                
                // í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
                sendFastingCompletionNotification();
                
                await stopFasting();
                showToast('ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¨ì‹ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! ğŸ‰', 5000);
                return;
            }

            const elapsedHours = Math.floor(elapsed / (1000 * 60 * 60));
            const elapsedMinutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const elapsedSeconds = Math.floor((elapsed % (1000 * 60)) / 1000);

            // ========== Phase 2: ë‹¨ê³„ í‘œì‹œ ì—…ë°ì´íŠ¸ ==========
            updateFastingStageDisplay(elapsedHours);
            // ===============================================
            
            // ë‹¨ì‹ ë‹¨ê³„ë³„ ì•Œë¦¼ (í•œ ë²ˆë§Œ í‘œì‹œ)
            if (!fastingState.lastStageNotified || fastingState.lastStageNotified !== elapsedHours) {
                const stage = getCurrentFastingStage(elapsedHours);
                if (stage && elapsedHours > 0) {
                    // íŠ¹ì • ì‹œê°„ì—ë§Œ ì•Œë¦¼ (12ì‹œê°„, 16ì‹œê°„, 20ì‹œê°„ ë“±)
                    if (elapsedHours === 12 || elapsedHours === 16 || elapsedHours === 20 || elapsedHours === 24) {
                        sendPushNotification(
                            'â±ï¸ ë‹¨ì‹ ì§„í–‰ ì¤‘',
                            `${elapsedHours}ì‹œê°„ ê²½ê³¼: ${stage.title} - ${stage.desc}`,
                            `fasting-stage-${elapsedHours}`
                        );
                    }
                    fastingState.lastStageNotified = elapsedHours;
                    localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));
                }
            }

            const remainingHours = Math.floor(remaining / (1000 * 60 * 60));
            const remainingMinutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const remainingSeconds = Math.floor((remaining % (1000 * 60)) / 1000);

            document.getElementById('fastingTimeMain').textContent =
                `${String(elapsedHours).padStart(2, '0')}:${String(elapsedMinutes).padStart(2, '0')}:${String(elapsedSeconds).padStart(2, '0')}`;

            document.getElementById('fastingTimeSub').textContent =
                `ë‚¨ì€ ì‹œê°„: ${remainingHours}ì‹œê°„ ${remainingMinutes}ë¶„`;

            // ì§„í–‰ë¥  ê³„ì‚°
            const progress = elapsed / fastingState.duration;
            const circumference = 691; // 2 * Ï€ * r (r=110)
            const offset = circumference - (progress * circumference);
            document.getElementById('fastingProgress').style.strokeDashoffset = offset;
        }

        // ë‹¨ì‹ ê¸°ë¡ ì €ì¥
        async function saveFastingRecord(completed = false) {
            if (!fastingState || !fastingState.active) return;

            const now = Date.now();
            const duration = now - fastingState.startTime;
            const today = new Date().toISOString().split('T')[0];

            await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('fastingRecords').add({
                    startTime: firebase.firestore.Timestamp.fromMillis(fastingState.startTime),
                    endTime: firebase.firestore.Timestamp.fromMillis(now),
                    duration: duration,
                    date: today,
                    completed: completed
                });
        }

        // ì˜¤ëŠ˜ì˜ ëˆ„ì  ì‹œê°„ ë¡œë“œ
        async function loadTodayFastingStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('fastingRecords')
                    .where('date', '==', today)
                    .get();

                let totalDuration = 0;
                const sessions = [];

                records.forEach(doc => {
                    const data = doc.data();
                    totalDuration += data.duration;
                    sessions.push({
                        startTime: data.startTime.toDate(),
                        endTime: data.endTime.toDate(),
                        duration: data.duration,
                        completed: data.completed
                    });
                });

                // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë‹¨ì‹ë„ í¬í•¨
                if (fastingState && fastingState.active && !fastingState.paused) {
                    const currentDuration = Date.now() - fastingState.startTime - (fastingState.totalPausedDuration || 0);
                    totalDuration += currentDuration;
                }

                const hours = Math.floor(totalDuration / (1000 * 60 * 60));
                const minutes = Math.floor((totalDuration % (1000 * 60 * 60)) / (1000 * 60));

                const accumulatedEl = document.getElementById('accumulatedTime');
                if (accumulatedEl) {
                    if (hours === 0 && minutes === 0) {
                        accumulatedEl.textContent = 'ì•„ì§ ë‹¨ì‹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤';
                        accumulatedEl.style.fontSize = '1.5rem';
                    } else {
                        accumulatedEl.textContent = `${hours}ì‹œê°„ ${minutes}ë¶„`;
                        accumulatedEl.style.fontSize = '2.5rem';
                    }
                }

                displayFastingSessions(sessions);
            } catch (error) {
                console.error('ë‹¨ì‹ í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì„¸ì…˜ ëª©ë¡ í‘œì‹œ
        function displayFastingSessions(sessions) {
            const container = document.getElementById('fastingSessions');
            if (!container) return;

            container.innerHTML = '';

            if (sessions.length === 0) {
                return;
            }

            sessions.forEach((session, index) => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'fasting-session-item';

                const duration = Math.floor(session.duration / (1000 * 60));
                const hours = Math.floor(duration / 60);
                const minutes = duration % 60;

                const statusIcon = session.completed ? 'âœ…' : 'â¸ï¸';
                const startTime = session.startTime.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
                const endTime = session.endTime.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});

                sessionDiv.innerHTML = `
                    <span>${statusIcon} ì„¸ì…˜ ${index + 1}</span>
                    <span>${startTime} - ${endTime}</span>
                    <span>${hours}ì‹œê°„ ${minutes}ë¶„</span>
                `;

                container.appendChild(sessionDiv);
            });
        }

        // ========== ìƒˆë¡œìš´ ë‹¨ì‹ í†µê³„ í•¨ìˆ˜ë“¤ ==========
        
        // ë‹¨ì‹ ìŠ¤íŠ¸ë¦­ ê³„ì‚° (ì—°ì† ì¼ìˆ˜)
        async function calculateFastingStreak() {
            try {
                const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('fastingRecords')
                    .orderBy('date', 'desc')
                    .limit(30)
                    .get();

                let streak = 0;
                let totalDays = 0;
                let totalHours = 0;
                const dates = new Set();
                
                records.forEach(doc => {
                    const data = doc.data();
                    dates.add(data.date);
                    totalHours += data.duration / (1000 * 60 * 60);
                });

                totalDays = dates.size;

                // ì—°ì† ì¼ìˆ˜ ê³„ì‚°
                const sortedDates = Array.from(dates).sort().reverse();
                const today = new Date().toISOString().split('T')[0];
                
                if (sortedDates.length > 0) {
                    // ì˜¤ëŠ˜ë¶€í„° ì—°ì†ìœ¼ë¡œ ë‹¨ì‹í•œ ë‚  ê³„ì‚°
                    let currentDate = new Date(today);
                    
                    for (let date of sortedDates) {
                        const checkDate = currentDate.toISOString().split('T')[0];
                        if (date === checkDate) {
                            streak++;
                            currentDate.setDate(currentDate.getDate() - 1);
                        } else {
                            break;
                        }
                    }
                }

                const avgHours = totalDays > 0 ? Math.round(totalHours / totalDays) : 0;

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('fastingStreak').textContent = streak;
                document.getElementById('totalFastingDays').textContent = totalDays;
                document.getElementById('avgFastingHours').textContent = avgHours + 'h';

                return { streak, totalDays, avgHours };
            } catch (error) {
                console.error('ë‹¨ì‹ ìŠ¤íŠ¸ë¦­ ê³„ì‚° ì‹¤íŒ¨:', error);
                return { streak: 0, totalDays: 0, avgHours: 0 };
            }
        }

        // ì´ë²ˆ ì£¼ ë‹¨ì‹ í˜„í™© í‘œì‹œ
        async function loadWeeklyFastingStatus() {
            try {
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0(ì¼) ~ 6(í† )
                const monday = new Date(today);
                monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                monday.setHours(0, 0, 0, 0);

                const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('fastingRecords')
                    .where('date', '>=', monday.toISOString().split('T')[0])
                    .get();

                const weekData = {};
                records.forEach(doc => {
                    const data = doc.data();
                    if (!weekData[data.date]) {
                        weekData[data.date] = { totalHours: 0, completed: false };
                    }
                    weekData[data.date].totalHours += data.duration / (1000 * 60 * 60);
                    if (data.completed) {
                        weekData[data.date].completed = true;
                    }
                });

                const container = document.getElementById('weeklyFastingGrid');
                container.innerHTML = '';

                const weekDays = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
                let completedCount = 0;

                for (let i = 0; i < 7; i++) {
                    const date = new Date(monday);
                    date.setDate(monday.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    const todayStr = new Date().toISOString().split('T')[0];
                    
                    const dayData = weekData[dateStr] || { totalHours: 0, completed: false };
                    const hours = Math.round(dayData.totalHours);
                    
                    if (hours >= 12) completedCount++; // 12ì‹œê°„ ì´ìƒì´ë©´ ì™„ë£Œë¡œ ê°„ì£¼

                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'weekly-day-item';
                    if (hours >= 12) dayDiv.classList.add('completed');
                    if (dateStr === todayStr) dayDiv.classList.add('today');

                    dayDiv.innerHTML = `
                        <div class="weekly-day-label">${weekDays[i]}</div>
                        <div class="weekly-day-hours">${hours > 0 ? hours + 'h' : '-'}</div>
                    `;

                    container.appendChild(dayDiv);
                }

                document.getElementById('weeklyGoalStatus').textContent = 
                    `ì£¼ê°„ ëª©í‘œ: 5íšŒ ë‹¨ì‹ / í˜„ì¬: ${completedCount}íšŒ ì™„ë£Œ`;

            } catch (error) {
                console.error('ì£¼ê°„ ë‹¨ì‹ í˜„í™© ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë§ˆì§€ë§‰ ì‹ì‚¬ ì‹œê°„ ê¸°ë¡
        function recordLastMealTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            
            localStorage.setItem('lastMealTime', now.toISOString());
            
            document.getElementById('lastMealTime').textContent = `ë§ˆì§€ë§‰ ì‹ì‚¬: ${timeStr}`;
            
            // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
            showToast(`âœ… ë§ˆì§€ë§‰ ì‹ì‚¬ ì‹œê°„ì´ ${timeStr}ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        // ë‹¨ì‹ ì‹œê°„ ì—°ì¥ (+1ì‹œê°„)
        function extendFasting() {
            if (!fastingState || !fastingState.active) return;

            const oneHour = 60 * 60 * 1000;
            fastingState.endTime += oneHour;
            fastingState.duration += oneHour;
            
            localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));
            
            showToast('â° ë‹¨ì‹ ì‹œê°„ì´ 1ì‹œê°„ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            console.log('ë‹¨ì‹ 1ì‹œê°„ ì—°ì¥');
        }

        // ë§ˆì§€ë§‰ ì‹ì‚¬ ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateLastMealDisplay() {
            const lastMeal = localStorage.getItem('lastMealTime');
            if (lastMeal) {
                const mealTime = new Date(lastMeal);
                const now = new Date();
                const elapsed = now - mealTime;
                const hours = Math.floor(elapsed / (1000 * 60 * 60));
                const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                
                const timeStr = mealTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('lastMealTime').textContent = 
                    `ë§ˆì§€ë§‰ ì‹ì‚¬: ${timeStr} (${hours}ì‹œê°„ ${minutes}ë¶„ ì „)`;
            }
        }

        // ========== ë°°ì§€ ì‹œìŠ¤í…œ ==========
        const badges = [
            { id: 'first', emoji: 'ğŸŒŸ', name: 'ì²« ë‹¨ì‹', condition: (stats) => stats.totalDays >= 1 },
            { id: 'week1', emoji: 'ğŸ”¥', name: '7ì¼ ì—°ì†', condition: (stats) => stats.streak >= 7 },
            { id: 'week2', emoji: 'ğŸ’ª', name: '14ì¼ ì—°ì†', condition: (stats) => stats.streak >= 14 },
            { id: 'month', emoji: 'ğŸ†', name: '30ì¼ ë‹¬ì„±', condition: (stats) => stats.totalDays >= 30 },
            { id: 'master', emoji: 'ğŸ‘‘', name: 'ë§ˆìŠ¤í„°', condition: (stats) => stats.streak >= 30 },
            { id: 'pro', emoji: 'â­', name: 'í”„ë¡œ', condition: (stats) => stats.totalDays >= 100 }
        ];

        function updateBadges(stats) {
            const container = document.getElementById('badgesGrid');
            container.innerHTML = '';

            badges.forEach(badge => {
                const unlocked = badge.condition(stats);
                const badgeDiv = document.createElement('div');
                badgeDiv.className = 'badge-item' + (unlocked ? ' unlocked' : '');
                badgeDiv.innerHTML = `
                    <div class="badge-emoji">${badge.emoji}</div>
                    <div class="badge-name">${badge.name}</div>
                `;
                container.appendChild(badgeDiv);
            });
        }

        // ========== ì›”ê°„ ë‹¬ë ¥ ìƒì„± ==========
        let currentReportMonth = new Date();

        async function loadMonthlyCalendar() {
            const year = currentReportMonth.getFullYear();
            const month = currentReportMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // í•´ë‹¹ ì›”ì˜ ë‹¨ì‹ ê¸°ë¡ ì¡°íšŒ
            const startDate = firstDay.toISOString().split('T')[0];
            const endDate = lastDay.toISOString().split('T')[0];
            
            const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('fastingRecords')
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();

            const monthData = {};
            records.forEach(doc => {
                const data = doc.data();
                if (!monthData[data.date]) {
                    monthData[data.date] = 0;
                }
                monthData[data.date] += data.duration / (1000 * 60 * 60);
            });

            const container = document.getElementById('fastingCalendar');
            container.innerHTML = '';

            // ìš”ì¼ í—¤ë”
            const weekDays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.textAlign = 'center';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.fontSize = '0.85rem';
                dayHeader.style.padding = '5px';
                dayHeader.style.color = '#666';
                dayHeader.textContent = day;
                container.appendChild(dayHeader);
            });

            // ë¹ˆ ì¹¸ ì¶”ê°€ (ì›”ì˜ ì²«ë‚  ì•)
            const firstDayOfWeek = firstDay.getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDiv = document.createElement('div');
                container.appendChild(emptyDiv);
            }

            // ë‚ ì§œ ìƒì„±
            const today = new Date().toISOString().split('T')[0];
            for (let date = 1; date <= lastDay.getDate(); date++) {
                const dateStr = new Date(year, month, date).toISOString().split('T')[0];
                const hours = Math.round(monthData[dateStr] || 0);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                if (hours >= 12) dayDiv.classList.add('fasted');
                if (dateStr === today) dayDiv.classList.add('today');

                dayDiv.innerHTML = `
                    <div class="calendar-day-number">${date}</div>
                    ${hours > 0 ? `<div class="calendar-day-hours">${hours}h</div>` : ''}
                `;
                container.appendChild(dayDiv);
            }
        }

        function changeReportMonth(direction) {
            currentReportMonth.setMonth(currentReportMonth.getMonth() + direction);
            document.getElementById('reportMonth').textContent = 
                `${currentReportMonth.getFullYear()}ë…„ ${currentReportMonth.getMonth() + 1}ì›”`;
            loadMonthlyCalendar();
            loadMonthlyReport();
        }

        // ========== ì›”ê°„ ë¦¬í¬íŠ¸ ==========
        async function loadMonthlyReport() {
            // ğŸ”¥ í”„ë¡œí•„ ì‹œì‘ì¼ ê°€ì ¸ì˜¤ê¸°
            const profileDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid).get();
            const profile = profileDoc.data();
            let profileStartDate = null;

            if (profile && profile.createdAt) {
                profileStartDate = profile.createdAt.toDate().toISOString().split('T')[0];
                console.log('ğŸ“… í”„ë¡œí•„ ì‹œì‘ì¼:', profileStartDate);
            }

            const year = currentReportMonth.getFullYear();
            const month = currentReportMonth.getMonth();
            const monthStartDate = new Date(year, month, 1).toISOString().split('T')[0];
            const monthEndDate = new Date(year, month + 1, 0).toISOString().split('T')[0];

            // ğŸ”¥ ì¡°íšŒ ì‹œì‘ì¼ = max(ì›” ì‹œì‘ì¼, í”„ë¡œí•„ ì‹œì‘ì¼)
            const queryStartDate = profileStartDate && profileStartDate > monthStartDate 
                ? profileStartDate 
                : monthStartDate;

            console.log(`ğŸ“Š ì›”ê°„ ë¦¬í¬íŠ¸ ì¡°íšŒ: ${queryStartDate} ~ ${monthEndDate}`);

            const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('fastingRecords')
                .where('date', '>=', queryStartDate)
                .where('date', '<=', monthEndDate)
                .get();

            let totalHours = 0;
            let longestHours = 0;
            const dates = new Set();

            records.forEach(doc => {
                const data = doc.data();
                const hours = data.duration / (1000 * 60 * 60);
                totalHours += hours;
                if (hours > longestHours) longestHours = hours;
                dates.add(data.date);
            });

            const totalDays = dates.size;
            const avgHours = totalDays > 0 ? Math.round(totalHours / totalDays) : 0;

            // ğŸ”¥ ì²´ì¤‘ ë³€í™”ë„ profile.createdAt ì´í›„ë§Œ ì¡°íšŒ
            const weightQueryStartDate = profileStartDate && profileStartDate > monthStartDate
                ? new Date(profileStartDate)
                : new Date(monthStartDate);

            const weights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs')
                .where('date', '>=', firebase.firestore.Timestamp.fromDate(weightQueryStartDate))
                .where('date', '<=', firebase.firestore.Timestamp.fromDate(new Date(monthEndDate)))
                .orderBy('date', 'asc')
                .get();

            console.log('ì›”ê°„ ì²´ì¤‘ ê¸°ë¡ ê°œìˆ˜:', weights.docs.length);

            let weightChange = 0;
            if (weights.docs.length >= 2) {
                const firstWeight = weights.docs[0].data().weight;
                const lastWeight = weights.docs[weights.docs.length - 1].data().weight;
                weightChange = (lastWeight - firstWeight).toFixed(1);
                console.log(`ì²´ì¤‘ ë³€í™”: ${firstWeight}kg -> ${lastWeight}kg = ${weightChange}kg`);
            } else if (weights.docs.length === 1) {
                // ê¸°ë¡ì´ 1ê°œë§Œ ìˆìœ¼ë©´ 0
                weightChange = 0;
                console.log('ì²´ì¤‘ ê¸°ë¡ 1ê°œ â†’ ì²´ì¤‘ ë³€í™” 0kg');
            } else {
                console.log('ì²´ì¤‘ ê¸°ë¡ ì—†ìŒ â†’ ì²´ì¤‘ ë³€í™” 0kg');
            }

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('monthlyTotalDays').textContent = totalDays;
            document.getElementById('monthlyAvgHours').textContent = avgHours + 'h';
            document.getElementById('monthlyLongest').textContent = Math.round(longestHours) + 'h';
            document.getElementById('monthlyWeightChange').textContent = 
                (weightChange > 0 ? '+' : '') + weightChange + 'kg';
            document.getElementById('monthlyWeightChange').style.color = 
                weightChange < 0 ? '#56ab2f' : weightChange > 0 ? '#ff5252' : '#666';

            // ì›”ê°„ ìš”ì•½ í…ìŠ¤íŠ¸
            const monthName = `${year}ë…„ ${month + 1}ì›”`;
            let reportText = `ğŸ“Š <strong>${monthName} ë‹¨ì‹ ìš”ì•½</strong><br><br>`;
            reportText += `âœ… ì´ <strong>${totalDays}ì¼</strong> ë‹¨ì‹ì„ ì‹¤ì²œí–ˆìŠµë‹ˆë‹¤.<br>`;
            reportText += `â±ï¸ í‰ê·  <strong>${avgHours}ì‹œê°„</strong> ë‹¨ì‹í–ˆìŠµë‹ˆë‹¤.<br>`;
            reportText += `ğŸ”¥ ìµœì¥ <strong>${Math.round(longestHours)}ì‹œê°„</strong> ê¸°ë¡ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.<br>`;
            if (Math.abs(weightChange) > 0) {
                reportText += `âš–ï¸ ì²´ì¤‘ì´ <strong>${Math.abs(weightChange)}kg ${weightChange < 0 ? 'ê°ì†Œ' : 'ì¦ê°€'}</strong>í–ˆìŠµë‹ˆë‹¤.<br>`;
            }
            reportText += `<br>ğŸ’ª ${totalDays >= 20 ? 'ì •ë§ í›Œë¥­í•©ë‹ˆë‹¤!' : totalDays >= 10 ? 'ì˜í•˜ê³  ìˆì–´ìš”!' : 'ì¡°ê¸ˆ ë” í˜ë‚´ì„¸ìš”!'}`;

            document.getElementById('monthlyReportText').innerHTML = reportText;
        }

        // ========== ì£¼ê°„ ë¦¬í¬íŠ¸ ==========
        async function loadWeeklyReport() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            monday.setHours(0, 0, 0, 0);

            const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('fastingRecords')
                .where('date', '>=', monday.toISOString().split('T')[0])
                .get();

            let totalHours = 0;
            const dates = new Set();
            records.forEach(doc => {
                const data = doc.data();
                totalHours += data.duration / (1000 * 60 * 60);
                dates.add(data.date);
            });

            const completedDays = dates.size;
            const avgHours = completedDays > 0 ? Math.round(totalHours / completedDays) : 0;

            let reportText = `ğŸ“Š <strong>ì´ë²ˆ ì£¼ ë‹¨ì‹ ìš”ì•½</strong><br><br>`;
            reportText += `âœ… ì´ë²ˆ ì£¼ <strong>${completedDays}ì¼</strong> ë‹¨ì‹í–ˆìŠµë‹ˆë‹¤.<br>`;
            reportText += `â±ï¸ í‰ê·  <strong>${avgHours}ì‹œê°„</strong> ë‹¨ì‹í–ˆìŠµë‹ˆë‹¤.<br>`;
            reportText += `ğŸ¯ ì£¼ê°„ ëª©í‘œ 5íšŒ ì¤‘ <strong>${completedDays}íšŒ</strong> ë‹¬ì„±!<br>`;
            reportText += `<br>ğŸ’ª ${completedDays >= 5 ? 'ëª©í‘œ ë‹¬ì„±! ë©‹ì ¸ìš”! ğŸ‰' : completedDays >= 3 ? 'ì˜í•˜ê³  ìˆì–´ìš”! ì¡°ê¸ˆë§Œ ë”!' : 'ì´ë²ˆ ì£¼ íŒŒì´íŒ…!'}`;

            document.getElementById('weeklyReportText').innerHTML = reportText;
        }

        // ========== ì²´ì¤‘ ì—°ë™ ì°¨íŠ¸ ==========
        let fastingWeightChart = null;

        async function loadFastingWeightChart() {
            try {
                // í”„ë¡œí•„ì—ì„œ ì‹œì‘ì¼ ê°€ì ¸ì˜¤ê¸°
                const profileDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid).get();
                const profile = profileDoc.data();
                
                let startDate;
                if (profile && profile.createdAt) {
                    startDate = profile.createdAt.toDate();
                } else {
                    // createdAtì´ ì—†ìœ¼ë©´ 30ì¼ ì „ë¶€í„°
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                }

                const today = new Date();
                console.log(`ì°¨íŠ¸ ê¸°ê°„: ${startDate.toISOString().split('T')[0]} ~ ${today.toISOString().split('T')[0]}`);

                // ë‹¨ì‹ ê¸°ë¡
                const fastingRecords = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('fastingRecords')
                    .where('date', '>=', startDate.toISOString().split('T')[0])
                    .orderBy('date', 'asc')
                    .get();

                const fastingData = {};
                fastingRecords.forEach(doc => {
                    const data = doc.data();
                    if (!fastingData[data.date]) {
                        fastingData[data.date] = 0;
                    }
                    fastingData[data.date] += data.duration / (1000 * 60 * 60);
                });

                // ì²´ì¤‘ ê¸°ë¡ (logs ì»¬ë ‰ì…˜ ì‚¬ìš©)
                const weightRecords = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs')  // weights -> logsë¡œ ìˆ˜ì •
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(startDate))
                    .orderBy('date', 'asc')
                    .get();

                console.log('ì²´ì¤‘ ê¸°ë¡ ê°œìˆ˜:', weightRecords.size);

                const weightData = {};
                weightRecords.forEach(doc => {
                    const data = doc.data();
                    const dateStr = data.date.toDate().toISOString().split('T')[0];
                    weightData[dateStr] = data.weight;
                    console.log('ì²´ì¤‘ ë°ì´í„°:', dateStr, data.weight + 'kg');
                });

                // ë‚ ì§œ ë ˆì´ë¸” ìƒì„± (ì‹œì‘ì¼ë¶€í„° ì˜¤ëŠ˜ê¹Œì§€)
                const labels = [];
                const fastingHours = [];
                const weights = [];
                
                const daysDiff = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
                console.log(`ì´ ${daysDiff}ì¼`);
                
                for (let i = 0; i <= daysDiff; i++) {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    labels.push(`${date.getMonth() + 1}/${date.getDate()}`);
                    fastingHours.push(Math.round(fastingData[dateStr] || 0));
                    weights.push(weightData[dateStr] || null);
                }

                console.log('ì°¨íŠ¸ ë°ì´í„°:', { labels, fastingHours, weights });

                // Chart.jsë¡œ ê·¸ë˜í”„ ìƒì„±
                const ctx = document.getElementById('fastingWeightChart');
                if (!ctx) {
                    console.error('ì°¨íŠ¸ ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                if (fastingWeightChart) fastingWeightChart.destroy();

                fastingWeightChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'ë‹¨ì‹ ì‹œê°„ (h)',
                                data: fastingHours,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                yAxisID: 'y',
                                tension: 0.4,
                                borderWidth: 2
                            },
                            {
                                label: 'ì²´ì¤‘ (kg)',
                                data: weights,
                                borderColor: '#56ab2f',
                                backgroundColor: 'rgba(86, 171, 47, 0.1)',
                                yAxisID: 'y1',
                                tension: 0.4,
                                spanGaps: true,
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: 'ë‹¨ì‹ ì‹œê°„ (h)', color: '#667eea' },
                                ticks: { color: '#667eea' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: 'ì²´ì¤‘ (kg)', color: '#56ab2f' },
                                grid: { drawOnChartArea: false },
                                ticks: { color: '#56ab2f' }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                enabled: true
                            }
                        }
                    }
                });

                console.log('âœ… ì²´ì¤‘ ì°¨íŠ¸ ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('ì²´ì¤‘ ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ========== ë¬¼ ì„­ì·¨ ì—°ë™ (í™ˆ íƒ­ê³¼ ì™„ì „ ë™ê¸°í™”) ==========
        
        // í™ˆ íƒ­ "ìŠ¤ë§ˆíŠ¸ ë¬¼ë§ˆì‹œê¸°"ì—ì„œ ì»µ í¬ê¸° ê°€ì ¸ì˜¤ê¸°
        function getWaterCupSize() {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"cupSize": 250}');
            return settings.cupSize || 250;
        }

        // ë‹¨ì‹ íƒ­ì—ì„œ ë¬¼ ì¶”ê°€ (í™ˆ íƒ­ê³¼ ì™„ì „ ë™ê¸°í™” - records ë°°ì—´ ì‚¬ìš©)
        async function quickAddWaterCup() {
            const cupSize = getWaterCupSize();
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"cupSize": 250, "goalLiters": 2, "filled": [], "records": []}');
            
            // ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸
            const today = new Date().toISOString().split('T')[0];
            if (settings.lastDate !== today) {
                settings.filled = [];
                settings.records = []; // ê¸°ë¡ë„ ì´ˆê¸°í™”
                settings.lastDate = today;
            }

            // records ë°°ì—´ ì´ˆê¸°í™” (ì—†ìœ¼ë©´)
            if (!settings.records) {
                settings.records = [];
            }

            // ìƒˆë¡œìš´ ê¸°ë¡ ì¶”ê°€
            const record = {
                amount: cupSize,
                time: new Date().toISOString(),
                id: Date.now() + Math.random() // ê³ ìœ  ID
            };
            settings.records.push(record);

            // í˜„ì¬ ì´ ì„­ì·¨ëŸ‰ ê³„ì‚° (ê¸°ë¡ ê¸°ë°˜)
            const currentIntake = settings.records.reduce((sum, r) => sum + r.amount, 0);

            // ì»µ ê°œìˆ˜ë¡œ ë³€í™˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            const newCupCount = Math.ceil(currentIntake / cupSize);
            settings.filled = Array.from({length: newCupCount}, (_, i) => i);

            localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));

            // ========== ìº˜ë¦°ë” ë™ê¸°í™” ==========
            await saveToDailyLog(new Date(), 'water', {
                amount: currentIntake
            });
            
            // ìº˜ë¦°ë”ê°€ í˜„ì¬ ì—´ë ¤ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
            if (currentTab === 'calendar' && typeof renderCalendar === 'function') {
                renderCalendar();
            }
            // ==========================================

            // í™ˆ íƒ­ UI ì—…ë°ì´íŠ¸ (í•¨ìˆ˜ê°€ ìˆìœ¼ë©´)
            if (typeof updateWaterTracker === 'function') {
                updateWaterTracker();
            }

            // ë‹¨ì‹ íƒ­ UI ì—…ë°ì´íŠ¸
            updateFastingWaterDisplay();

            showToast(`ğŸ’§ ë¬¼ ${cupSize}ml ì¶”ê°€! (í™ˆ íƒ­ì—ë„ ë°˜ì˜ë¨)`);
        }

        // ë‹¨ì‹ íƒ­ ë¬¼ ì„­ì·¨ëŸ‰ í‘œì‹œ ì—…ë°ì´íŠ¸ (records ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •)
        async function updateFastingWaterDisplay() {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"cupSize": 250, "filled": [], "records": []}');
            
            // records ë°°ì—´ì´ ìˆìœ¼ë©´ records ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°, ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
            let totalMl = 0;
            if (settings.records && settings.records.length > 0) {
                // ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸
                const today = new Date().toISOString().split('T')[0];
                if (settings.lastDate === today) {
                    totalMl = settings.records.reduce((sum, r) => sum + r.amount, 0);
                }
            } else {
                // ê¸°ì¡´ ë°©ì‹ (filled ë°°ì—´ ê¸°ë°˜)
                const cupSize = settings.cupSize || 250;
                const filledCount = settings.filled ? settings.filled.length : 0;
                totalMl = filledCount * cupSize;
            }

            const fastingWaterEl = document.getElementById('fastingWaterIntake');
            if (fastingWaterEl) {
                fastingWaterEl.textContent = totalMl + 'ml';
            }
            
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ë„ ì»µ í¬ê¸°ì— ë§ì¶° ì—…ë°ì´íŠ¸
            const btn = document.getElementById('quickAddWaterBtn');
            if (btn) {
                const cupSize = settings.cupSize || 250;
                btn.innerHTML = `+${cupSize}ml ğŸ’§`;
            }
        }

        // í™ˆ íƒ­ì˜ ë¬¼ë§ˆì‹œê¸° í•¨ìˆ˜ í™•ì¥ (ë‹¨ì‹ íƒ­ ë™ê¸°í™”)
        const originalToggleWaterCup = window.toggleWaterCup;
        if (originalToggleWaterCup) {
            window.toggleWaterCup = function(index) {
                originalToggleWaterCup(index);
                // ë‹¨ì‹ íƒ­ì´ ì´ˆê¸°í™”ë˜ì–´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                if (document.getElementById('fastingWaterIntake')) {
                    updateFastingWaterDisplay();
                }
            };
        }

        // ========== ë‹¨ì‹ íƒ€ì´ë¨¸ í‘¸ì‹œ ì•Œë¦¼ ê¸°ëŠ¥ ==========
        let fastingNotificationTimeout = null;

        // ğŸ”” í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ì‚¬ìš©ì ì œìŠ¤ì²˜ í•„ìš”)
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                showErrorToast('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            }

            if (Notification.permission === 'denied') {
                showErrorToast('ì•Œë¦¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”');
                return false;
            }

            // ê¶Œí•œ ìš”ì²­ (ì‚¬ìš©ì ì œìŠ¤ì²˜ì—ì„œë§Œ í˜¸ì¶œ)
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showSuccessToast('ğŸ”” ì•Œë¦¼ì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    return true;
                }
            } catch (e) {
                console.error('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨:', e);
            }
            return false;
        }

        // ğŸ”” Service Workerë¥¼ í†µí•œ í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡
        async function sendPushNotification(title, body, tag = 'diet-mate') {
            // ê¶Œí•œ í™•ì¸
            if (Notification.permission !== 'granted') {
                console.log('ì•Œë¦¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return false;
            }
            
            // Service Workerë¥¼ í†µí•œ ì•Œë¦¼ (ë°±ê·¸ë¼ìš´ë“œì—ì„œë„ ì‘ë™)
            if (swRegistration && swRegistration.active) {
                swRegistration.active.postMessage({
                    type: 'SHOW_NOTIFICATION',
                    title: title,
                    body: body,
                    tag: tag,
                    icon: 'https://cdn-icons-png.flaticon.com/512/2917/2917995.png'
                });
                return true;
            }
            
            // í´ë°±: ì¼ë°˜ Notification API
            try {
                new Notification(title, {
                    body: body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/2917/2917995.png',
                    badge: 'https://cdn-icons-png.flaticon.com/512/2917/2917995.png',
                    vibrate: [200, 100, 200],
                    tag: tag,
                    requireInteraction: true
                });
                return true;
            } catch (e) {
                console.error('ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', e);
                return false;
            }
        }

        // ë‹¨ì‹ ì™„ë£Œ ì•Œë¦¼ ì˜ˆì•½
        async function scheduleFastingNotification(hours) {
            if (Notification.permission !== 'granted') {
                console.log('ì•Œë¦¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ì•Œë¦¼ ì˜ˆì•½ ê±´ë„ˆëœ€.');
                return;
            }

            // ê¸°ì¡´ ì•Œë¦¼ ì·¨ì†Œ
            if (fastingNotificationTimeout) {
                clearTimeout(fastingNotificationTimeout);
            }

            // ë‹¨ì‹ ì™„ë£Œ ì‹œê°„ ê³„ì‚° (ë°€ë¦¬ì´ˆ)
            const duration = hours * 60 * 60 * 1000;

            // ë‹¨ì‹ ì™„ë£Œ ì‹œ ì•Œë¦¼ ì˜ˆì•½
            fastingNotificationTimeout = setTimeout(() => {
                sendFastingCompletionNotification();
            }, duration);

            console.log(`âœ… ${hours}ì‹œê°„ í›„ ë‹¨ì‹ ì™„ë£Œ ì•Œë¦¼ ì˜ˆì•½ë¨`);
        }

        // ë‹¨ì‹ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡
        function sendFastingCompletionNotification() {
            sendPushNotification(
                'ğŸ‰ ë‹¨ì‹ ì™„ë£Œ!',
                'ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¨ì‹ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤. ì´ì œ ê±´ê°•í•œ ì‹ì‚¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”!',
                'fasting-complete'
            );
            // ì•Œë¦¼ìŒ ì¬ìƒ (ì„ íƒì‚¬í•­)
            playNotificationSound();
        }

        // ì•Œë¦¼ ì·¨ì†Œ
        function cancelFastingNotification() {
            if (fastingNotificationTimeout) {
                clearTimeout(fastingNotificationTimeout);
                fastingNotificationTimeout = null;
                console.log('ë‹¨ì‹ ì•Œë¦¼ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì•Œë¦¼ìŒ ì¬ìƒ (ì„ íƒì‚¬í•­)
        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjCH0fPTgjMGHm7A7+OZUQ0OVqzn77BeFwxInOLyt3EdCDSP1PLEcyYGKn/L79uKOwoVYbfq7qVUFQpEn+HxtGwhBjCH0fPTgjMGHm7A7+OZUQ0OVqzn77BeFwxInOLyt3EdCDSP1PLEcyYGKn/L79uKOwoVYbfq7qVUFQpEn+HxtGwhBjCH0fPTgjMGHm7A7+OZUQ0OVqzn77BeFwxInOLyt3EdCDSP1PLEcyYGKn/L79uKOwoVYbfq7qVUFQo=');
                audio.play().catch(e => console.log('ì•Œë¦¼ìŒ ì¬ìƒ ì‹¤íŒ¨:', e));
            } catch (error) {
                console.log('ì•Œë¦¼ìŒ ì¬ìƒ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ì„ íƒì‚¬í•­)
        // window.addEventListener('load', () => {
        //     requestNotificationPermission();
        // });

        // ==================== ì•¨ë²” íƒ­ ====================
        async function loadAlbumTab() {
            // ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateStorageUsageDisplay();

            const photos = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('photos')
                .orderBy('uploadedAt', 'desc')
                .get();

            const grid = document.getElementById('photoGrid');
            // 'ì „ì²´' íƒ­ì—ì„œëŠ” + ë²„íŠ¼ ì œê±°
            if (currentAlbumTab === 'all') {
                grid.innerHTML = '';
            } else {
                grid.innerHTML = '<div class="photo-item add-photo" onclick="addPhoto()">+</div>';
            }

            // Phase 4: ë°°ì¹˜ ì‘ì—…ì„ ìœ„í•´ í˜„ì¬ í‘œì‹œëœ í•­ëª© ì €ì¥
            allPhotoItems = [];

            photos.forEach(doc => {
                const photo = doc.data();
                if (currentAlbumTab === 'all' || photo.category === currentAlbumTab) {
                    const photoDiv = document.createElement('div');
                    const docId = doc.id;

                    // Phase 4: í•­ëª© ì €ì¥ (ì´ë¯¸ì§€ë§Œ, í…ìŠ¤íŠ¸ ì¹´ë“œëŠ” ë‹¤ìš´ë¡œë“œ/ê³µìœ  ëŒ€ìƒ ì•„ë‹˜)
                    if (photo.url) {
                        allPhotoItems.push({ docId, url: photo.url, photo });
                    }

                    // í…ìŠ¤íŠ¸ ì¹´ë“œì¸ ê²½ìš° (urlì´ nullì´ê³  textê°€ ìˆìŒ)
                    if (!photo.url && photo.text) {
                        photoDiv.className = `photo-item text-card category-${photo.category}`;
                        photoDiv.dataset.docId = docId;

                        let nutritionHtml = '';
                        if (photo.nutrition && photo.category === 'food') {
                            nutritionHtml = `
                                <div class="text-card-nutrition">
                                    ${Math.round(photo.nutrition.calories)}kcal
                                </div>
                            `;
                        }

                        photoDiv.innerHTML = `
                            <div class="text-card-emoji">${getCategoryEmoji(photo.category)}</div>
                            <div class="text-card-content">${photo.text}</div>
                            ${nutritionHtml}
                            <div class="photo-date-label" style="position: relative; bottom: auto; left: auto; right: auto; margin-top: 10px; font-size: 0.8rem;">
                                ${photo.uploadedAt ? formatDetailedTimestamp(photo.uploadedAt.toDate()) : ''}
                            </div>
                        `;
                    }
                    // ì¼ë°˜ ì´ë¯¸ì§€ ì¹´ë“œ
                    else if (photo.url) {
                        photoDiv.className = 'photo-item';
                        photoDiv.dataset.docId = docId;

                        // Phase 4: ì„ íƒ ëª¨ë“œì¼ ë•Œ ì²´í¬ë°•ìŠ¤ ì¶”ê°€
                        let checkboxHtml = '';
                        if (isSelectMode) {
                            const isChecked = selectedItems.has(docId);
                            checkboxHtml = `<div class="select-checkbox ${isChecked ? 'checked' : ''}" onclick="event.stopPropagation(); toggleItemSelection('${docId}')"></div>`;
                            if (isChecked) {
                                photoDiv.classList.add('selected');
                            }
                        }

                        photoDiv.innerHTML = `
                            ${checkboxHtml}
                            <img src="${photo.url}" alt="ì‚¬ì§„">
                            <div class="photo-date-label">${formatDetailedTimestamp(photo.uploadedAt.toDate())}</div>
                        `;
                    }

                    // Phase 4: ì„ íƒ ëª¨ë“œì¼ ë•ŒëŠ” ì„ íƒ í† ê¸€, ì•„ë‹ˆë©´ ëª¨ë‹¬ ì—´ê¸°
                    photoDiv.onclick = () => {
                        if (isSelectMode && photo.url) {
                            toggleItemSelection(docId);
                        } else {
                            openPhotoModal(photo.url || photo.text, docId);
                        }
                    };

                    grid.appendChild(photoDiv);
                }
            });
        }

        // ì¹´í…Œê³ ë¦¬ë³„ ì´ëª¨ì§€ ë§¤í•‘
        function getCategoryEmoji(category) {
            const emojiMap = {
                'body': 'ğŸ’ª',
                'food': 'ğŸ½ï¸',
                'exercise': 'ğŸƒâ€â™‚ï¸'
            };
            return emojiMap[category] || 'ğŸ“';
        }
        
        // ğŸ”¥ ìƒˆ ê¸°ëŠ¥: ë‚ ì§œ+ìš”ì¼+ì‹œê°„ ìƒì„¸ í‘œì‹œ
        function formatDetailedTimestamp(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            const weekday = weekdays[date.getDay()];
            
            const hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
            const displayHours = hours % 12 || 12; // 0ì‹œëŠ” 12ì‹œë¡œ í‘œì‹œ
            
            return `${year}ë…„ ${month}ì›” ${day}ì¼ (${weekday}) ${ampm} ${displayHours}:${minutes}`;
        }

        function changeAlbumTab(tab) {
            currentAlbumTab = tab;
            document.querySelectorAll('.album-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            loadAlbumTab();
        }

        // ==================== Phase 4: ë°°ì¹˜ ì‘ì—… í•¨ìˆ˜ë“¤ ====================

        // ì„ íƒ ëª¨ë“œ í† ê¸€
        function toggleSelectMode() {
            isSelectMode = !isSelectMode;

            const selectModeBtn = document.getElementById('selectModeBtn');
            const selectActionBar = document.getElementById('selectActionBar');

            if (isSelectMode) {
                selectModeBtn.classList.add('active');
                selectModeBtn.textContent = 'ì·¨ì†Œ';
                selectActionBar.classList.remove('hidden');
            } else {
                selectModeBtn.classList.remove('active');
                selectModeBtn.textContent = 'ì„ íƒ';
                selectActionBar.classList.add('hidden');
                selectedItems.clear();
            }

            // ì•¨ë²” ì¬ë Œë”ë§ (ì²´í¬ë°•ìŠ¤ í‘œì‹œ/ìˆ¨ê¹€)
            loadAlbumTab();
            updateSelectedCount();
        }

        // ê°œë³„ í•­ëª© ì„ íƒ/í•´ì œ
        function toggleItemSelection(docId) {
            if (selectedItems.has(docId)) {
                selectedItems.delete(docId);
            } else {
                selectedItems.add(docId);
            }

            // UI ì—…ë°ì´íŠ¸
            const photoDiv = document.querySelector(`.photo-item[data-doc-id="${docId}"]`);
            if (photoDiv) {
                const checkbox = photoDiv.querySelector('.select-checkbox');
                if (selectedItems.has(docId)) {
                    photoDiv.classList.add('selected');
                    if (checkbox) checkbox.classList.add('checked');
                } else {
                    photoDiv.classList.remove('selected');
                    if (checkbox) checkbox.classList.remove('checked');
                }
            }

            updateSelectedCount();
        }

        // ì„ íƒëœ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateSelectedCount() {
            const count = selectedItems.size;
            document.getElementById('selectedCount').textContent = `${count}ê°œ ì„ íƒë¨`;
        }

        // ì„ íƒëœ í•­ëª© ë‹¤ìš´ë¡œë“œ
        async function downloadSelectedItems() {
            if (selectedItems.size === 0) {
                showToast('ë‹¤ìš´ë¡œë“œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 2000);
                return;
            }

            try {
                // ì„ íƒëœ í•­ëª©ë“¤ì˜ URL ê°€ì ¸ì˜¤ê¸°
                const selectedUrls = allPhotoItems
                    .filter(item => selectedItems.has(item.docId))
                    .map(item => item.url);

                if (selectedUrls.length === 0) {
                    showToast('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 2000);
                    return;
                }

                // ê° ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                for (let i = 0; i < selectedUrls.length; i++) {
                    const url = selectedUrls[i];
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `diet-mate-photo-${i + 1}.jpg`;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // ë¸Œë¼ìš°ì €ê°€ ë‹¤ìš´ë¡œë“œë¥¼ ì²˜ë¦¬í•  ì‹œê°„ ì£¼ê¸°
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                showToast(`${selectedUrls.length}ê°œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.`, 2000);
                cancelSelectMode();
            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 2000);
            }
        }

        // ì„ íƒëœ í•­ëª© ê³µìœ  (Web Share API)
        async function shareSelectedItems() {
            if (selectedItems.size === 0) {
                showToast('ê³µìœ í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 2000);
                return;
            }

            // Web Share API ì§€ì› ì—¬ë¶€ í™•ì¸
            if (!navigator.share) {
                showToast('ì´ ë¸Œë¼ìš°ì €ëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 2000);
                return;
            }

            try {
                // ì„ íƒëœ í•­ëª©ë“¤ì˜ URL ê°€ì ¸ì˜¤ê¸°
                const selectedUrls = allPhotoItems
                    .filter(item => selectedItems.has(item.docId))
                    .map(item => item.url);

                if (selectedUrls.length === 0) {
                    showToast('ê³µìœ í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 2000);
                    return;
                }

                // URLë“¤ì„ í…ìŠ¤íŠ¸ë¡œ ê³µìœ  (ì´ë¯¸ì§€ íŒŒì¼ì€ fetch í•„ìš”)
                const shareText = `Diet Mate ì‚¬ì§„ ${selectedUrls.length}ê°œ\n\n${selectedUrls.join('\n')}`;

                await navigator.share({
                    title: 'Diet Mate ì‚¬ì§„',
                    text: shareText
                });

                console.log('ê³µìœ  ì„±ê³µ');
                cancelSelectMode();
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('ê³µìœ  ì˜¤ë¥˜:', error);
                    showToast('ê³µìœ  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 2000);
                }
            }
        }

        // ì„ íƒ ëª¨ë“œ ì·¨ì†Œ
        function cancelSelectMode() {
            isSelectMode = false;
            selectedItems.clear();

            const selectModeBtn = document.getElementById('selectModeBtn');
            const selectActionBar = document.getElementById('selectActionBar');

            selectModeBtn.classList.remove('active');
            selectModeBtn.textContent = 'ì„ íƒ';
            selectActionBar.classList.add('hidden');

            // ì•¨ë²” ì¬ë Œë”ë§
            loadAlbumTab();
            updateSelectedCount();
        }

        // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ë° ì••ì¶• í•¨ìˆ˜ (ìš©ëŸ‰ ìµœì í™”)
        async function compressImage(file, maxWidth = 1920, maxHeight = 1920, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // ë¹„ìœ¨ ìœ ì§€í•˜ë©° ë¦¬ì‚¬ì´ì¦ˆ
                        if (width > maxWidth || height > maxHeight) {
                            if (width > height) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            } else {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // JPEGë¡œ ë³€í™˜ (ìš©ëŸ‰ ìµœì í™”)
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨'));
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ì „ì²´ ì‚¬ìš©ì ê¸°ì¤€ ì›”ë³„ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ê°€ì ¸ì˜¤ê¸° (Firestore)
        async function getMonthlyStorageUsage() {
            try {
                const now = new Date();
                const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
                const usageDoc = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('storage').doc('monthly-usage')
                    .get();
                
                if (usageDoc.exists) {
                    const data = usageDoc.data();
                    return data[monthKey] || 0;
                }
                return 0;
            } catch (error) {
                console.error('ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨:', error);
                return 0;
            }
        }

        // ì „ì²´ ì‚¬ìš©ì ê¸°ì¤€ ì›”ë³„ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸ (Firestore)
        async function updateMonthlyStorageUsage(size) {
            try {
                const now = new Date();
                const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
                const usageRef = db.collection('artifacts').doc('diet-mate-v2')
                    .collection('storage').doc('monthly-usage');
                
                // Firestoreì˜ incrementë¥¼ ì‚¬ìš©í•˜ì—¬ ì›ìì ìœ¼ë¡œ ì¦ê°€
                await usageRef.set({
                    [monthKey]: firebase.firestore.FieldValue.increment(size),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // ì—…ë°ì´íŠ¸ëœ ê°’ ë°˜í™˜
                const updatedDoc = await usageRef.get();
                const data = updatedDoc.data();
                return data[monthKey] || size;
            } catch (error) {
                console.error('ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        // ì „ì²´ ì‚¬ìš©ì ê¸°ì¤€ ì›”ë³„ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì°¨ê° (Firestore)
        async function subtractMonthlyStorageUsage(size) {
            try {
                const now = new Date();
                const monthKey = `${now.getFullYear()}-${now.getMonth()}`;
                const usageRef = db.collection('artifacts').doc('diet-mate-v2')
                    .collection('storage').doc('monthly-usage');
                
                // Firestoreì˜ incrementë¥¼ ì‚¬ìš©í•˜ì—¬ ì›ìì ìœ¼ë¡œ ê°ì†Œ
                await usageRef.set({
                    [monthKey]: firebase.firestore.FieldValue.increment(-size),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // ì—…ë°ì´íŠ¸ëœ ê°’ ë°˜í™˜
                const updatedDoc = await usageRef.get();
                const data = updatedDoc.data();
                const newUsage = Math.max(0, data[monthKey] || 0);
                
                // í‘œì‹œ ì—…ë°ì´íŠ¸
                await updateStorageUsageDisplay();
                return newUsage;
            } catch (error) {
                console.error('ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì°¨ê° ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        // ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ í‘œì‹œ ì—…ë°ì´íŠ¸ (Firestoreì—ì„œ ê°€ì ¸ì˜´)
        async function updateStorageUsageDisplay() {
            try {
                const currentUsage = await getMonthlyStorageUsage();
                const usageMB = (currentUsage / 1024 / 1024).toFixed(2);
                const usagePercent = ((currentUsage / STORAGE_LIMIT) * 100).toFixed(1);
                
                const usageTextEl = document.getElementById('storageUsageText');
                if (usageTextEl) {
                    let color = '#666';
                    if (usagePercent >= 90) {
                        color = '#f44336'; // ë¹¨ê°„ìƒ‰
                    } else if (usagePercent >= 70) {
                        color = '#ff9800'; // ì£¼í™©ìƒ‰
                    } else if (usagePercent >= 50) {
                        color = '#ffc107'; // ë…¸ë€ìƒ‰
                    }
                    
                    usageTextEl.textContent = `${usageMB}MB (${usagePercent}%)`;
                    usageTextEl.style.color = color;
                    usageTextEl.style.fontWeight = usagePercent >= 70 ? 'bold' : 'normal';
                }
            } catch (error) {
                console.error('ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ í‘œì‹œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        async function addPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // íŒŒì¼ í¬ê¸° ê²€ì¦ (10MB ì œí•œ)
                const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
                if (file.size > MAX_FILE_SIZE) {
                    showToast('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.', 2000);
                    return;
                }

                // ğŸ”¥ í˜„ì¬ ì„ íƒëœ íƒ­ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ìë™ìœ¼ë¡œ ì‚¬ìš©
                let categoryValue = currentAlbumTab;
                if (categoryValue === 'all') categoryValue = 'body'; // ì „ì²´ íƒ­ì—ì„œëŠ” ê¸°ë³¸ê°’ ëˆˆë°”ë””

                try {
                    // ì›”ë³„ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì²´í¬ (ì „ì²´ ì‚¬ìš©ì ê¸°ì¤€)
                    const currentUsage = await getMonthlyStorageUsage();
                    if (currentUsage >= STORAGE_LIMIT) {
                        showToast('ì›” 4.5GB ì‚¬ìš©ëŸ‰ ì œí•œì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë‹¬ê¹Œì§€ ì—…ë¡œë“œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.', 4000);
                        return;
                    }

                    // ì´ë¯¸ì§€ ì••ì¶• (ìš©ëŸ‰ ìµœì í™”)
                    showToast('ì´ë¯¸ì§€ ìµœì í™” ì¤‘...', 1000);
                    const compressedFile = await compressImage(file);
                    
                    // ì••ì¶• í›„ì—ë„ ì œí•œ ì²´í¬
                    const newUsage = currentUsage + compressedFile.size;
                    if (newUsage > STORAGE_LIMIT) {
                        const limitMB = (STORAGE_LIMIT / 1024 / 1024).toFixed(1);
                        showToast(`ì—…ë¡œë“œ ì‹œ ì›” ì‚¬ìš©ëŸ‰ì´ 4.5GBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. (í˜„ì¬: ${(currentUsage / 1024 / 1024).toFixed(2)}MB / ${limitMB}MB)`, 4000);
                        return;
                    }

                    const timestamp = Date.now();
                    const fileName = `${currentUser.uid}/${timestamp}_${file.name}`;
                    const storageRef = storage.ref().child(fileName);

                    // ì••ì¶•ëœ íŒŒì¼ ì—…ë¡œë“œ
                    const snapshot = await storageRef.put(compressedFile);
                    const downloadURL = await snapshot.ref.getDownloadURL();

                    // ì›”ë³„ ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸ (ì „ì²´ ì‚¬ìš©ì ê¸°ì¤€)
                    const updatedUsage = await updateMonthlyStorageUsage(compressedFile.size);
                    await updateStorageUsageDisplay(); // í‘œì‹œ ì—…ë°ì´íŠ¸
                    const usageMB = (updatedUsage / 1024 / 1024).toFixed(2);
                    const limitMB = (STORAGE_LIMIT / 1024 / 1024).toFixed(1);
                    console.log(`ğŸ“Š [ì „ì²´ ì‚¬ìš©ì] ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰: ${usageMB}MB / ${limitMB}MB (${((updatedUsage / STORAGE_LIMIT) * 100).toFixed(1)}%)`);
                    
                    // 90% ì´ìƒ ì‚¬ìš© ì‹œ ê²½ê³ 
                    if (updatedUsage >= STORAGE_LIMIT * 0.9) {
                        showToast(`âš ï¸ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ì´ ${((updatedUsage / STORAGE_LIMIT) * 100).toFixed(0)}%ì…ë‹ˆë‹¤. (${usageMB}MB / ${limitMB}MB)`, 4000);
                    }

                    // ì‹ë‹¨ì¸ ê²½ìš° AI ì˜ì–‘ ë¶„ì„
                    let nutritionData = null;
                    if (categoryValue === 'food') {
                        try {
                            nutritionData = await analyzeNutritionFromImage(file, downloadURL);
                        } catch (error) {
                            console.error('ì˜ì–‘ ë¶„ì„ ì‹¤íŒ¨:', error);
                            // ì˜ì–‘ ë¶„ì„ ì‹¤íŒ¨í•´ë„ ì‚¬ì§„ì€ ì €ì¥
                        }
                    }

                    // Firestoreì— ë©”íƒ€ë°ì´í„° ì €ì¥ (íŒŒì¼ í¬ê¸° í¬í•¨)
                    const photoData = {
                        url: downloadURL,
                        category: categoryValue,
                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        text: null,
                        fileSize: compressedFile.size // íŒŒì¼ í¬ê¸° ì €ì¥ (ì‚­ì œ ì‹œ ì‚¬ìš©ëŸ‰ ì°¨ê°ìš©)
                    };

                    if (nutritionData) {
                        photoData.nutrition = nutritionData;
                    }

                    // ì‹ë‹¨ì¸ ê²½ìš° ìŠ¤ë§ˆíŠ¸ ë³‘í•© ì²´í¬
                    if (categoryValue === 'food' && nutritionData) {
                        const recentMeal = await checkForRecentMeal(new Date());

                        if (recentMeal) {
                            // ìµœê·¼ ì‹ì‚¬ ë°œê²¬ - ë³‘í•© Bottom Sheet í‘œì‹œ
                            showMergeBottomSheet(photoData, recentMeal);
                            return; // confirmMerge()ë‚˜ createNewMeal()ì—ì„œ ì²˜ë¦¬
                        }
                    }

                    // ìŠ¤ë§ˆíŠ¸ ë³‘í•© ëŒ€ìƒì´ ì•„ë‹ˆê±°ë‚˜ ì‹ë‹¨ì´ ì•„ë‹Œ ê²½ìš° ë°”ë¡œ ì €ì¥
                    await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                        .collection('photos').add(photoData);

                    // ì•¨ë²” ìƒˆë¡œê³ ì¹¨
                    await loadAlbumTab();

                    // ì‹ë‹¨ì¸ ê²½ìš° ëŒ€ì‹œë³´ë“œë„ ìƒˆë¡œê³ ì¹¨ ë° AI í† ìŠ¤íŠ¸ í‘œì‹œ
                    if (categoryValue === 'food' && nutritionData) {
                        // ========== Phase 1: ì‹¤ì‹œê°„ ì˜ì–‘ ì¶”ì  ==========
                        addMeal('ì‹ë‹¨', nutritionData.foodName, nutritionData);
                        // ===============================================

                        await refreshDashboardNutrition();

                        // í”Œëœê³¼ ë¹„êµ (ì„ íƒì )
                        let toastMessage = nutritionData.aiAdvice || 'ì‹ì‚¬ê°€ ê¸°ë¡ë˜ì—ˆì–´ìš”!';
                        try {
                            const comparisonResult = await comparePlanWithMeal(new Date(), nutritionData);
                            if (comparisonResult) {
                                toastMessage = comparisonResult;
                            }
                        } catch (error) {
                            console.error('í”Œëœ ë¹„êµ ì‹¤íŒ¨:', error);
                        }

                        showAIToast(toastMessage, 6000);
                    } else {
                        showSuccessToast('ì‚¬ì§„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }

                } catch (error) {
                    console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);

                    // Firebase Storage ì—ëŸ¬ ì²˜ë¦¬
                    if (error.code === 'storage/unauthorized') {
                        showErrorToast('ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                    } else if (error.code === 'storage/canceled') {
                        showErrorToast('ì—…ë¡œë“œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        showErrorToast('ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                }
            };
            input.click();
        }

        // ì„±ê³µ í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showSuccessToast(message) {
            console.log('âœ“ ' + message);
            showToast(message, 3000);
        }

        // ì—ëŸ¬ í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showErrorToast(message) {
            console.error('âœ— ' + message);
            showToast(message, 3000);
        }

        async function openPhotoModal(url, photoId) {
            // Phase 4: í˜„ì¬ ì‚¬ì§„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì¹´í…Œê³ ë¦¬ ì •ë³´ í•„ìš”)
            const photoDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('photos').doc(photoId).get();
            const photoData = photoDoc.data();
            const currentCategory = photoData ? photoData.category : null;

            // Phase 4: ì‹ë‹¨ ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° "ì´ì „ ì‹ì‚¬ì™€ í•©ì¹˜ê¸°" ë²„íŠ¼ ì¶”ê°€
            let mergeButtonHtml = '';
            if (currentCategory === 'food') {
                mergeButtonHtml = `<button class="photo-modal-btn" style="background: #9c27b0; color: white;" onclick="showManualMergeList('${photoId}')">ì´ì „ ì‹ì‚¬ì™€ í•©ì¹˜ê¸°</button>`;
            }

            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.innerHTML = `
                <div class="photo-modal-header">
                    <h3>ì‚¬ì§„ ë³´ê¸°</h3>
                    <button style="background: none; border: none; color: white; font-size: 2rem; cursor: pointer;" onclick="this.closest('.photo-modal').remove()">Ã—</button>
                </div>
                <div class="photo-modal-content">
                    <img src="${url}" class="photo-modal-image">
                </div>
                <div class="photo-modal-actions">
                    <button class="photo-modal-btn" style="background: #667eea; color: white;" onclick="downloadPhoto('${url}')">ë‹¤ìš´ë¡œë“œ</button>
                    <button class="photo-modal-btn" style="background: #4caf50; color: white;" onclick="sharePhoto('${url}')">ê³µìœ </button>
                    ${mergeButtonHtml}
                    <button class="photo-modal-btn" style="background: #ff9800; color: white;" onclick="showCategoryChangeModal('${photoId}', '${currentCategory}')">ì¹´í…Œê³ ë¦¬ ë³€ê²½</button>
                    <button class="photo-modal-btn" style="background: #f44336; color: white;" onclick="deletePhoto('${photoId}')">ì‚­ì œ</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function downloadPhoto(url) {
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diet_mate_photo.jpg';
            a.click();
        }

        async function sharePhoto(url) {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Diet Mate ì‚¬ì§„',
                        text: 'ë‚˜ì˜ ë‹¤ì´ì–´íŠ¸ ë³€í™”',
                        url: url
                    });
                } catch (error) {
                    console.error('ê³µìœ  ì‹¤íŒ¨:', error);
                }
            } else {
                showToast('ì´ ë¸Œë¼ìš°ì €ëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 2000);
            }
        }

        async function deletePhoto(photoId) {
            try {
                // 1. ì‚¬ì§„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const photoDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(photoId).get();
                const photoData = photoDoc.data();

                // 2. ì‚¬ì§„ ì‚­ì œ ë° ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì°¨ê° (ì „ì²´ ì‚¬ìš©ì ê¸°ì¤€)
                const fileSize = photoData.fileSize || 0;
                if (fileSize > 0) {
                    await subtractMonthlyStorageUsage(fileSize);
                    const currentUsage = await getMonthlyStorageUsage();
                    const limitMB = (STORAGE_LIMIT / 1024 / 1024).toFixed(1);
                    console.log(`ğŸ“Š [ì „ì²´ ì‚¬ìš©ì] ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì°¨ê°: ${(fileSize / 1024 / 1024).toFixed(2)}MB (í˜„ì¬: ${(currentUsage / 1024 / 1024).toFixed(2)}MB / ${limitMB}MB)`);
                }
                
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(photoId).delete();

                // 3. ì‹ë‹¨ ì‚¬ì§„ì´ì—ˆê³  ì˜ì–‘ ì •ë³´ê°€ ìˆë‹¤ë©´ dailyLogsì—ì„œë„ ì œê±°
                if (photoData && photoData.category === 'food' && photoData.nutrition) {
                    const uploadDate = photoData.uploadedAt.toDate();
                    const dateStr = `${uploadDate.getFullYear()}-${String(uploadDate.getMonth() + 1).padStart(2, '0')}-${String(uploadDate.getDate()).padStart(2, '0')}`;
                    
                    const dailyLogRef = db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(currentUser.uid)
                        .collection('dailyLogs').doc(dateStr);
                    
                    const dailyLogDoc = await dailyLogRef.get();
                    if (dailyLogDoc.exists) {
                        const logData = dailyLogDoc.data();
                        if (logData.nutrition && logData.nutrition.meals) {
                            // í•´ë‹¹ ì‹ì‚¬ ì œê±°
                            const updatedMeals = logData.nutrition.meals.filter(meal => {
                                // uploadedAt ì‹œê°„ìœ¼ë¡œ ì‹ë³„ (ë°€ë¦¬ì´ˆ ë‹¨ìœ„ ë¹„êµ)
                                const mealTime = meal.timestamp?.seconds * 1000 || 0;
                                const photoTime = photoData.uploadedAt.seconds * 1000;
                                return Math.abs(mealTime - photoTime) > 1000; // 1ì´ˆ ì´ìƒ ì°¨ì´ë‚˜ë©´ ë‹¤ë¥¸ ì‹ì‚¬
                            });

                            // ì´ ì¹¼ë¡œë¦¬ ë° ì˜ì–‘ì†Œ ì¬ê³„ì‚°
                            let totalCal = 0, totalCarbs = 0, totalProtein = 0, totalFat = 0;
                            updatedMeals.forEach(meal => {
                                totalCal += meal.calories || 0;
                                totalCarbs += meal.carbs || 0;
                                totalProtein += meal.protein || 0;
                                totalFat += meal.fat || 0;
                            });

                            // dailyLogs ì—…ë°ì´íŠ¸
                            await dailyLogRef.update({
                                'nutrition.calories': totalCal,
                                'nutrition.carbs': totalCarbs,
                                'nutrition.protein': totalProtein,
                                'nutrition.fat': totalFat,
                                'nutrition.meals': updatedMeals
                            });

                            console.log(`âœ… dailyLogs ë™ê¸°í™” ì™„ë£Œ: ${dateStr}, ë‚¨ì€ ì‹ì‚¬: ${updatedMeals.length}ê°œ`);
                        }
                    }
                }

                document.querySelector('.photo-modal').remove();
                await loadAlbumTab();
                
                // í™ˆ íƒ­ ìƒˆë¡œê³ ì¹¨ (ì˜ì–‘ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸)
                if (photoData && photoData.category === 'food') {
                    await loadHomeTab();
                }
                
                showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 2000);
            } catch (error) {
                console.error('ì‚¬ì§„ ì‚­ì œ ì˜¤ë¥˜:', error);
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 2000);
            }
        }

        // ==================== Phase 4: ì¹´í…Œê³ ë¦¬ ë³€ê²½ í•¨ìˆ˜ë“¤ ====================

        // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ëª¨ë‹¬ í‘œì‹œ
        function showCategoryChangeModal(photoId, currentCategory) {
            changingPhotoId = photoId;
            changingPhotoCurrentCategory = currentCategory;

            const overlay = document.getElementById('categoryChangeOverlay');
            const options = document.querySelectorAll('.category-option');

            // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ê°•ì¡°
            options.forEach(option => {
                const category = option.dataset.category;
                if (category === currentCategory) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });

            // ëª¨ë‹¬ í‘œì‹œ
            overlay.classList.remove('hidden');
        }

        // ì¹´í…Œê³ ë¦¬ ë³€ê²½ í™•ì¸
        async function changeCategoryConfirm(newCategory) {
            if (!changingPhotoId) {
                alert('ì˜¤ë¥˜: ë³€ê²½í•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                closeCategoryModal();
                return;
            }

            // ê°™ì€ ì¹´í…Œê³ ë¦¬ë¡œ ë³€ê²½í•˜ë ¤ëŠ” ê²½ìš°
            if (newCategory === changingPhotoCurrentCategory) {
                alert('ì´ë¯¸ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤.');
                return;
            }

            try {
                // Firestoreì—ì„œ í˜„ì¬ ì‚¬ì§„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const photoDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(changingPhotoId).get();
                const photoData = photoDoc.data();

                // ì‹ë‹¨ â†’ ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬: ì˜ì–‘ ë°ì´í„° ì†ì‹¤ ê²½ê³ 
                if (changingPhotoCurrentCategory === 'food' && photoData.nutrition) {
                    if (!confirm('ì‹ë‹¨ ì¹´í…Œê³ ë¦¬ì—ì„œ ì´ë™í•˜ë©´ ì˜ì–‘ ì •ë³´ê°€ ëŒ€ì‹œë³´ë“œì—ì„œ ì œì™¸ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        return;
                    }
                }

                // ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ â†’ ì‹ë‹¨: AI ì¬ë¶„ì„ í•„ìš” ì—¬ë¶€ í™•ì¸
                if (newCategory === 'food' && changingPhotoCurrentCategory !== 'food') {
                    if (photoData.url && !photoData.nutrition) {
                        // ì´ë¯¸ì§€ê°€ ìˆì§€ë§Œ ì˜ì–‘ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° - AI ì¬ë¶„ì„ ì œì•ˆ
                        const reanalyze = confirm('ì‹ë‹¨ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•©ë‹ˆë‹¤. AI ì˜ì–‘ ë¶„ì„ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                        if (reanalyze) {
                            // AI ì˜ì–‘ ë¶„ì„ ì‹¤í–‰ (ê¸°ì¡´ analyzeNutritionFromImage ì‚¬ìš©)
                            alert('ì˜ì–‘ ë¶„ì„ì€ ì•¨ë²”ì—ì„œ ì‚¬ì§„ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                        }
                    }
                }

                // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹¤í–‰
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(changingPhotoId).update({
                        category: newCategory
                    });

                alert('ì¹´í…Œê³ ë¦¬ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ëª¨ë‹¬ë“¤ ë‹«ê¸°
                closeCategoryModal();
                const photoModal = document.querySelector('.photo-modal');
                if (photoModal) photoModal.remove();

                // ì•¨ë²” ìƒˆë¡œê³ ì¹¨
                await loadAlbumTab();

                // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨ (ì˜ì–‘ ì •ë³´ ë³€ê²½ ì‹œ)
                if (changingPhotoCurrentCategory === 'food' || newCategory === 'food') {
                    if (typeof loadNutritionDashboard === 'function') {
                        await loadNutritionDashboard();
                    }
                }
            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì˜¤ë¥˜:', error);
                alert('ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ëª¨ë‹¬ ë‹«ê¸°
        function closeCategoryModal() {
            const overlay = document.getElementById('categoryChangeOverlay');
            overlay.classList.add('hidden');
            changingPhotoId = null;
            changingPhotoCurrentCategory = null;
        }

        // ==================== Phase 4: ìˆ˜ë™ ë³‘í•© í•¨ìˆ˜ë“¤ ====================

        // ìˆ˜ë™ ë³‘í•© ëª¨ë‹¬ í‘œì‹œ ë° ì‹ì‚¬ ëª©ë¡ ë¡œë“œ
        async function showManualMergeList(currentPhotoId) {
            mergingSourceId = currentPhotoId;

            const overlay = document.getElementById('manualMergeOverlay');
            overlay.classList.remove('hidden');

            // ì‹ì‚¬ ëª©ë¡ ë¡œë“œ
            await loadRecentMeals(30, currentPhotoId);
        }

        // ìµœê·¼ ì‹ì‚¬ ëª©ë¡ ë¡œë“œ (ìµœê·¼ 30ì¼)
        async function loadRecentMeals(limit = 30, excludeId = null) {
            const mealListDiv = document.getElementById('mealList');
            mealListDiv.innerHTML = '<div class="meal-list-loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                // 30ì¼ ì „ ë‚ ì§œ ê³„ì‚°
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                // Firestoreì—ì„œ ìµœê·¼ 30ì¼ ì‹ë‹¨ ì¡°íšŒ
                const mealsSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('category', '==', 'food')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
                    .orderBy('uploadedAt', 'desc')
                    .limit(50) // ìµœëŒ€ 50ê°œê¹Œì§€ ë¡œë“œ
                    .get();

                if (mealsSnapshot.empty) {
                    mealListDiv.innerHTML = '<div class="meal-list-empty">ìµœê·¼ 30ì¼ ë‚´ ì‹ì‚¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                // ì‹ì‚¬ ëª©ë¡ ë Œë”ë§
                mealListDiv.innerHTML = '';
                let count = 0;

                mealsSnapshot.forEach(doc => {
                    // í˜„ì¬ í•­ëª©ì€ ì œì™¸
                    if (doc.id === excludeId) return;

                    const meal = doc.data();
                    const mealId = doc.id;

                    // ì˜ì–‘ ì •ë³´ê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
                    if (!meal.nutrition) return;

                    // ë‚ ì§œ í¬ë§·íŒ…
                    const uploadDate = meal.uploadedAt.toDate();
                    const dateStr = uploadDate.toLocaleDateString('ko-KR');
                    const timeStr = uploadDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                    const mealItem = document.createElement('div');
                    mealItem.className = 'meal-list-item';
                    mealItem.onclick = () => confirmManualMerge(mergingSourceId, mealId);

                    mealItem.innerHTML = `
                        <div class="meal-item-header">
                            <span class="meal-item-date">${dateStr}</span>
                            <span class="meal-item-time">${timeStr}</span>
                        </div>
                        <div class="meal-item-name">${meal.nutrition.foodName || 'ì‹ì‚¬'}</div>
                        <div class="meal-item-calories">${Math.round(meal.nutrition.calories)}kcal</div>
                    `;

                    mealListDiv.appendChild(mealItem);
                    count++;

                    if (count >= limit) return;
                });

                // í•­ëª©ì´ í•˜ë‚˜ë„ ë Œë”ë§ë˜ì§€ ì•Šì€ ê²½ìš°
                if (count === 0) {
                    mealListDiv.innerHTML = '<div class="meal-list-empty">ë³‘í•© ê°€ëŠ¥í•œ ì‹ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br/>(ì˜ì–‘ ì •ë³´ê°€ ìˆëŠ” ì‹ì‚¬ë§Œ ë³‘í•© ê°€ëŠ¥í•©ë‹ˆë‹¤)</div>';
                }
            } catch (error) {
                console.error('ì‹ì‚¬ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                mealListDiv.innerHTML = '<div class="meal-list-empty">ì‹ì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ìˆ˜ë™ ë³‘í•© í™•ì¸ ë° ì‹¤í–‰
        async function confirmManualMerge(sourceId, targetId) {
            if (!sourceId || !targetId) {
                alert('ì˜¤ë¥˜: ë³‘í•©í•  í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // í™•ì¸ ë©”ì‹œì§€
            if (!confirm('ì„ íƒí•œ ì‹ì‚¬ì™€ ë³‘í•©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜„ì¬ ì‹ì‚¬ì˜ ì˜ì–‘ ì •ë³´ê°€ ì„ íƒí•œ ì‹ì‚¬ì— í•©ì‚°ë˜ê³ , í˜„ì¬ ì‹ì‚¬ëŠ” ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                // ë‘ ì‹ì‚¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const sourceDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(sourceId).get();
                const targetDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(targetId).get();

                const sourceData = sourceDoc.data();
                const targetData = targetDoc.data();

                // ì˜ì–‘ ì •ë³´ê°€ ì—†ìœ¼ë©´ ë³‘í•© ë¶ˆê°€
                if (!sourceData.nutrition || !targetData.nutrition) {
                    alert('ì˜ì–‘ ì •ë³´ê°€ ì—†ëŠ” í•­ëª©ì€ ë³‘í•©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì˜ì–‘ ì •ë³´ í•©ì‚°
                const mergedNutrition = {
                    calories: (targetData.nutrition.calories || 0) + (sourceData.nutrition.calories || 0),
                    carbs: (targetData.nutrition.carbs || 0) + (sourceData.nutrition.carbs || 0),
                    protein: (targetData.nutrition.protein || 0) + (sourceData.nutrition.protein || 0),
                    fat: (targetData.nutrition.fat || 0) + (sourceData.nutrition.fat || 0),
                    foodName: `${targetData.nutrition.foodName} + ${sourceData.nutrition.foodName}`,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `ë³‘í•©ëœ ì‹ì‚¬ (${Math.round((targetData.nutrition.calories || 0) + (sourceData.nutrition.calories || 0))}kcal)`
                };

                // í…ìŠ¤íŠ¸ë„ ì—°ê²°
                let mergedText = targetData.text || '';
                if (sourceData.text) {
                    mergedText = mergedText ? `${mergedText} + ${sourceData.text}` : sourceData.text;
                }

                // target ì—…ë°ì´íŠ¸
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(targetId).update({
                        nutrition: mergedNutrition,
                        text: mergedText || null
                    });

                // source ì‚­ì œ
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(sourceId).delete();

                alert('ì‹ì‚¬ê°€ ì„±ê³µì ìœ¼ë¡œ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ëª¨ë‹¬ë“¤ ë‹«ê¸°
                closeManualMergeModal();
                const photoModal = document.querySelector('.photo-modal');
                if (photoModal) photoModal.remove();

                // ì•¨ë²” ìƒˆë¡œê³ ì¹¨
                await loadAlbumTab();

                // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                if (typeof loadNutritionDashboard === 'function') {
                    await loadNutritionDashboard();
                }
            } catch (error) {
                console.error('ë³‘í•© ì˜¤ë¥˜:', error);
                alert('ì‹ì‚¬ ë³‘í•© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ìˆ˜ë™ ë³‘í•© ëª¨ë‹¬ ë‹«ê¸°
        function closeManualMergeModal() {
            const overlay = document.getElementById('manualMergeOverlay');
            overlay.classList.add('hidden');
            mergingSourceId = null;
        }

        // ==================== ìº˜ë¦°ë” íƒ­ ====================
        async function loadCalendar() {
            await loadWeeklySummary();
            renderCalendar();
        }

        // ì£¼ê°„ ìš”ì•½ ë¡œë“œ
        async function loadWeeklySummary() {
            const container = document.getElementById('weeklySummaryContent');
            container.innerHTML = '<div class="summary-loading">ë¡œë”© ì¤‘...</div>';

            try {
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 86400000);

                // ì£¼ê°„ ì²´ì¤‘ ë°ì´í„°
                const weekWeights = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(weekAgo))
                    .orderBy('date', 'desc')
                    .get();

                // ì£¼ê°„ dailyLogs ë°ì´í„°
                const weekStart = `${weekAgo.getFullYear()}-${String(weekAgo.getMonth() + 1).padStart(2, '0')}-${String(weekAgo.getDate()).padStart(2, '0')}`;
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                
                const weekLogs = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs')
                    .where(firebase.firestore.FieldPath.documentId(), '>=', weekStart)
                    .where(firebase.firestore.FieldPath.documentId(), '<=', todayStr)
                    .get();

                // ê³„ì‚°
                let avgWeight = 0;
                let weightChange = 0;
                if (!weekWeights.empty) {
                    const weights = [];
                    weekWeights.forEach(doc => weights.push(parseFloat(doc.data().weight)));
                    avgWeight = (weights.reduce((a, b) => a + b, 0) / weights.length).toFixed(1);
                    if (weights.length >= 2) {
                        weightChange = (weights[0] - weights[weights.length - 1]).toFixed(1);
                    }
                }

                let totalCal = 0, calCount = 0;
                let totalWater = 0, waterDays = 0;
                let totalFastingHours = 0, fastingDays = 0;

                weekLogs.forEach(doc => {
                    const data = doc.data();
                    if (data.nutrition && data.nutrition.calories) {
                        totalCal += data.nutrition.calories;
                        calCount++;
                    }
                    if (data.water && data.water > 0) {
                        totalWater += data.water;
                        waterDays++;
                    }
                    if (data.fasting && data.fasting.duration) {
                        totalFastingHours += data.fasting.duration / 60;
                        fastingDays++;
                    }
                });

                const avgCal = calCount > 0 ? Math.round(totalCal / calCount) : 0;
                const avgWater = waterDays > 0 ? (totalWater / waterDays / 1000).toFixed(1) : 0;
                const avgFasting = fastingDays > 0 ? (totalFastingHours / fastingDays / 60).toFixed(1) : 0;

                // UI ë Œë”ë§
                container.innerHTML = `
                    <div class="summary-stat">
                        <div class="summary-stat-label">í‰ê·  ì²´ì¤‘</div>
                        <div class="summary-stat-value">${avgWeight}kg</div>
                        <div class="summary-stat-change">${weightChange > 0 ? '+' : ''}${weightChange}kg</div>
                    </div>
                    <div class="summary-stat green">
                        <div class="summary-stat-label">í‰ê·  ì¹¼ë¡œë¦¬</div>
                        <div class="summary-stat-value">${avgCal}kcal</div>
                        <div class="summary-stat-change">${calCount}ì¼ ê¸°ë¡</div>
                    </div>
                    <div class="summary-stat blue">
                        <div class="summary-stat-label">í‰ê·  ë¬¼ ì„­ì·¨</div>
                        <div class="summary-stat-value">${avgWater}L</div>
                        <div class="summary-stat-change">${waterDays}/7ì¼ ë‹¬ì„±</div>
                    </div>
                    <div class="summary-stat orange">
                        <div class="summary-stat-label">í‰ê·  ë‹¨ì‹ ì‹œê°„</div>
                        <div class="summary-stat-value">${avgFasting}h</div>
                        <div class="summary-stat-change">${fastingDays}/7ì¼ ì„±ê³µ</div>
                    </div>
                `;

                // AI ì½”ì¹­ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                updateAICoachingMessage({avgWeight, weightChange, avgCal, avgWater, avgFasting, calCount, waterDays, fastingDays});

            } catch (error) {
                console.error('ì£¼ê°„ ìš”ì•½ ë¡œë“œ ì˜¤ë¥˜:', error);
                container.innerHTML = '<div class="summary-loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // AI ì½”ì¹­ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        function updateAICoachingMessage(stats) {
            const messageEl = document.getElementById('aiCoachMessage');
            
            // TODO: ì‹¤ì œ AI API ì—°ë™ ì‹œ ì—¬ê¸°ì„œ í˜¸ì¶œ
            // const aiMessage = await fetch('/api/ai-coaching', { method: 'POST', body: JSON.stringify(stats) });
            
            // ì„ì‹œ ë¡œì§ (AI API êµ¬í˜„ ì „)
            let message = "";
            
            if (stats.weightChange < -0.5) {
                message = `ì´ë²ˆ ì£¼ ${Math.abs(stats.weightChange)}kg ê°ëŸ‰! ì •ë§ ì˜í•˜ê³  ê³„ì„¸ìš”! ğŸ‰`;
            } else if (stats.weightChange > 0.5) {
                message = `ì´ë²ˆ ì£¼ ì²´ì¤‘ì´ ì¡°ê¸ˆ ëŠ˜ì—ˆì§€ë§Œ, í¬ê¸°í•˜ì§€ ë§ˆì„¸ìš”. ì¥ê¸°ì ì¸ ëª©í‘œì— ì§‘ì¤‘í•˜ì„¸ìš”! ğŸ’ª`;
            } else {
                message = `ì²´ì¤‘ì´ ì•ˆì •ì ì´ë„¤ìš”. ê¾¸ì¤€íˆ ìœ ì§€í•˜ë©´ì„œ ê±´ê°•í•œ ìŠµê´€ì„ ë§Œë“¤ì–´ê°€ì„¸ìš”! âœ¨`;
            }

            if (stats.calCount >= 6) {
                message += ` ì¹¼ë¡œë¦¬ ê¸°ë¡ì„ ${stats.calCount}ì¼ì´ë‚˜ í•˜ì…¨ì–´ìš”!`;
            }

            if (stats.fastingDays >= 5) {
                message += ` ë‹¨ì‹ë„ ${stats.fastingDays}ì¼ ì„±ê³µ! ğŸ‘`;
            }

            messageEl.textContent = message || "ì£¼ê°„ ìš”ì•½ì„ í™•ì¸í•˜ê³  ê³„ì† í˜ë‚´ì„¸ìš”! ğŸ’ª";
        }

        // ì£¼ê°„ ìš”ì•½ í† ê¸€
        function toggleWeeklySummary() {
            const content = document.getElementById('weeklySummaryContent');
            const btn = event.target;
            
            if (content.style.display === 'none') {
                content.style.display = 'grid';
                btn.textContent = 'ì ‘ê¸°';
            } else {
                content.style.display = 'none';
                btn.textContent = 'í¼ì¹˜ê¸°';
            }
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            document.getElementById('calendarMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            // ë¹ˆ ì¹¸
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                calendarDays.appendChild(emptyDay);
            }

            // ë‚ ì§œë“¤
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                const currentDate = new Date(year, month, day);
                // íƒ€ì„ì¡´ ë¬¸ì œ í•´ê²°: ë¡œì»¬ ë‚ ì§œë¥¼ ì§ì ‘ ë¬¸ìì—´ë¡œ ë³€í™˜
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // ë‚ ì§œ ë²ˆí˜¸
                const dateNumber = document.createElement('div');
                dateNumber.className = 'calendar-day-number';
                dateNumber.textContent = day;
                dayDiv.appendChild(dateNumber);

                // ë¯¸ë¦¬ë³´ê¸° ì •ë³´ ì»¨í…Œì´ë„ˆ
                const previewDiv = document.createElement('div');
                previewDiv.className = 'calendar-day-preview';
                dayDiv.appendChild(previewDiv);

                if (currentDate.toDateString() === today.toDateString()) {
                    dayDiv.classList.add('today');
                }

                if (currentDate > today) {
                    dayDiv.classList.add('future');
                } else {
                    dayDiv.onclick = () => showDayReport(dateStr);
                    // ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° ë¡œë“œ
                    loadDayPreview(dateStr, previewDiv);
                }

                calendarDays.appendChild(dayDiv);
            }
        }

        // ë‚ ì§œë³„ ë¯¸ë¦¬ë³´ê¸° ì •ë³´ ë¡œë“œ
        async function loadDayPreview(dateStr, container) {
            try {
                const date = new Date(dateStr);
                const nextDay = new Date(date.getTime() + 86400000);

                // ì²´ì¤‘ ì¡°íšŒ
                const weights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(date))
                    .where('date', '<', firebase.firestore.Timestamp.fromDate(nextDay))
                    .limit(1)
                    .get();

                // dailyLogs ì¡°íšŒ (ì¹¼ë¡œë¦¬, ë¬¼)
                const dailyLog = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').doc(dateStr)
                    .get();

                let previewHTML = '';

                // ì²´ì¤‘
                if (!weights.empty) {
                    const weight = parseFloat(weights.docs[0].data().weight).toFixed(1);
                    previewHTML += `<div class="preview-item">âš–ï¸ ${weight}kg</div>`;
                    container.parentElement.classList.add('has-data');
                }

                // ì¹¼ë¡œë¦¬
                if (dailyLog.exists && dailyLog.data().nutrition) {
                    const calories = Math.round(dailyLog.data().nutrition.calories || 0);
                    if (calories > 0) {
                        previewHTML += `<div class="preview-item">ğŸ½ï¸ ${calories}kcal</div>`;
                    }
                }

                // ë¬¼
                if (dailyLog.exists && dailyLog.data().water) {
                    const waterLiters = (dailyLog.data().water / 1000).toFixed(2);
                    previewHTML += `<div class="preview-item">ğŸ’§ ${waterLiters}L</div>`;
                }

                // ğŸ”¥ v3.9.3: ìš´ë™ ê¸°ë¡
                const exercises = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('exercises')
                    .where('date', '==', dateStr)
                    .get();
                
                if (!exercises.empty) {
                    let totalExerciseCalories = 0;
                    exercises.forEach(doc => {
                        totalExerciseCalories += doc.data().calories || 0;
                    });
                    if (totalExerciseCalories > 0) {
                        previewHTML += `<div class="preview-item" style="color: #667eea;">ğŸƒ -${totalExerciseCalories}kcal</div>`;
                        container.parentElement.classList.add('has-data');
                    }
                }

                // ëª©í‘œ ë‹¬ì„± (dailyPlansì—ì„œ)
                const dailyPlan = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyPlans').doc(dateStr)
                    .get();

                if (dailyPlan.exists && dailyPlan.data().goals) {
                    const goals = dailyPlan.data().goals;
                    const completed = Object.values(goals).filter(g => g.completed).length;
                    const total = Object.keys(goals).length;
                    const percentage = Math.round((completed / total) * 100);
                    
                    if (percentage >= 70) {
                        previewHTML += `<div class="preview-item">âœ…</div>`;
                    } else if (percentage >= 50) {
                        previewHTML += `<div class="preview-item">âš ï¸</div>`;
                    }
                }

                container.innerHTML = previewHTML;
            } catch (error) {
                console.error('ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        async function checkDayData(dateStr) {
            const weights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs')
                .where('date', '>=', firebase.firestore.Timestamp.fromDate(new Date(dateStr)))
                .where('date', '<', firebase.firestore.Timestamp.fromDate(new Date(new Date(dateStr).getTime() + 86400000)))
                .limit(1)
                .get();

            return !weights.empty;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        // ìƒˆë¡œìš´ showDayReport í•¨ìˆ˜ (v3.0 - ì™„ì „ ì¢…í•© ë¦¬í¬íŠ¸)
        async function showDayReport(dateStr) {
            const date = new Date(dateStr);
            const yesterday = new Date(date);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            // ========== ì˜¤ëŠ˜ ë°ì´í„° ìˆ˜ì§‘ ==========
            const weights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs')
                .where('date', '>=', firebase.firestore.Timestamp.fromDate(date))
                .where('date', '<', firebase.firestore.Timestamp.fromDate(new Date(date.getTime() + 86400000)))
                .get();

            // ì–´ì œ ì²´ì¤‘
            const yesterdayWeights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs')
                .where('date', '>=', firebase.firestore.Timestamp.fromDate(yesterday))
                .where('date', '<', firebase.firestore.Timestamp.fromDate(date))
                .get();

            // dailyLogs (ì˜¤ëŠ˜)
            const dailyLog = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('dailyLogs').doc(dateStr)
                .get();
            const logData = dailyLog.exists ? dailyLog.data() : null;

            // dailyLogs (ì–´ì œ)
            const yesterdayLog = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('dailyLogs').doc(yesterdayStr)
                .get();
            const yesterdayLogData = yesterdayLog.exists ? yesterdayLog.data() : null;

            // ë‹¨ì‹ ê¸°ë¡
            const fastingRecords = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('fastingRecords')
                .where('date', '==', dateStr)
                .get();

            // ì‚¬ì§„/ì•¨ë²”
            const photos = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('photos')
                .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(date))
                .where('uploadedAt', '<', firebase.firestore.Timestamp.fromDate(new Date(date.getTime() + 86400000)))
                .get();

            // ì¼ê¸°
            const dailyPlan = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('dailyPlans').doc(dateStr)
                .get();
            const diaryData = dailyPlan.exists ? dailyPlan.data() : null;

            // ëª©í‘œ (Firestore dailyPlansì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
            let goals = null;
            if (diaryData && diaryData.goals) {
                goals = diaryData.goals;
            } else {
                // localStorage fallback (ì˜¤ëŠ˜ ë‚ ì§œë§Œ)
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                if (dateStr === todayStr) {
                    const goalsData = localStorage.getItem(`diet_goals_${dateStr}`);
                    goals = goalsData ? JSON.parse(goalsData) : null;
                }
            }

            // ========== ëª¨ë‹¬ ìƒì„± ==========
            const modal = document.createElement('div');
            modal.className = 'day-report-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px; overflow-y: auto;';

            let content = `
                <div class="day-report-content" style="background: white; border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative;">
                    <button onclick="this.closest('.day-report-modal').remove()" style="position: absolute; top: 20px; right: 20px; font-size: 28px; border: none; background: none; cursor: pointer; color: #999;">Ã—</button>
                    
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="font-size: 1.5rem; color: #333; margin: 0;">${date.getMonth() + 1}ì›” ${date.getDate()}ì¼</h2>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 5px;">${['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'][date.getDay()]}</p>
                    </div>
            `;

            // ========== 1. ì²´ì¤‘ ==========
            if (!weights.empty) {
                const todayWeight = parseFloat(weights.docs[0].data().weight).toFixed(1);
                const yesterdayWeight = yesterdayWeights.empty ? null : parseFloat(yesterdayWeights.docs[0].data().weight).toFixed(1);
                const weightDiff = yesterdayWeight ? (parseFloat(todayWeight) - parseFloat(yesterdayWeight)).toFixed(1) : null;

                content += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 20px; margin-bottom: 20px; color: white;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 1.5rem;">âš–ï¸</span>
                            <h3 style="margin: 0; font-size: 1.1rem;">ì²´ì¤‘</h3>
                        </div>
                        <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 5px;">${todayWeight}kg</div>
                        ${weightDiff ? `
                            <div style="font-size: 1rem; opacity: 0.9;">
                                ì–´ì œ ëŒ€ë¹„ ${weightDiff > 0 ? '+' : ''}${weightDiff}kg 
                                <span style="font-size: 1.2rem;">${weightDiff > 0 ? 'ğŸ“ˆ' : weightDiff < 0 ? 'ğŸ“‰' : 'â¡ï¸'}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // ========== 2. ì‹ì‚¬ & ì˜ì–‘ (í•­ìƒ í‘œì‹œ) ==========
            const todayCal = (logData && logData.nutrition) ? Math.round(logData.nutrition.calories || 0) : 0;
            const yesterdayCal = yesterdayLogData && yesterdayLogData.nutrition ? Math.round(yesterdayLogData.nutrition.calories) : null;
            const calDiff = yesterdayCal !== null ? (todayCal - yesterdayCal) : null;
            
            // ğŸ”¥ ëª©í‘œ ì¹¼ë¡œë¦¬ (í”„ë¡œí•„ ê¸°ë°˜ - v3.9.1 ë™ê¸°í™”)
            const targetCal = currentProfile?.calculatedCalories || parseInt(localStorage.getItem('goal_calories_target')) || 1620;
            const calVsTarget = todayCal - targetCal;

            // ì£¼ê°„ í‰ê·  (ìµœê·¼ 7ì¼)
            const weekStart = new Date(date);
            weekStart.setDate(weekStart.getDate() - 6);
            const weekLogs = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('dailyLogs')
                .where(firebase.firestore.FieldPath.documentId(), '>=', `${weekStart.getFullYear()}-${String(weekStart.getMonth() + 1).padStart(2, '0')}-${String(weekStart.getDate()).padStart(2, '0')}`)
                .where(firebase.firestore.FieldPath.documentId(), '<=', dateStr)
                .get();
            
            let weekTotalCal = 0;
            let weekDays = 0;
            weekLogs.forEach(doc => {
                const data = doc.data();
                if (data.nutrition && data.nutrition.calories) {
                    weekTotalCal += data.nutrition.calories;
                    weekDays++;
                }
            });
            const weekAvgCal = weekDays > 0 ? Math.round(weekTotalCal / weekDays) : null;
            const weekDiff = weekAvgCal !== null ? (todayCal - weekAvgCal) : null;

            // ì›”ê°„ í‰ê·  (ì´ë²ˆ ë‹¬ 1ì¼ë¶€í„° ì˜¤ëŠ˜ê¹Œì§€)
            const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
            const monthStartStr = `${monthStart.getFullYear()}-${String(monthStart.getMonth() + 1).padStart(2, '0')}-01`;
            const monthLogs = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('dailyLogs')
                .where(firebase.firestore.FieldPath.documentId(), '>=', monthStartStr)
                .where(firebase.firestore.FieldPath.documentId(), '<=', dateStr)
                .get();
            
            let monthTotalCal = 0;
            let monthDays = 0;
            monthLogs.forEach(doc => {
                const data = doc.data();
                if (data.nutrition && data.nutrition.calories) {
                    monthTotalCal += data.nutrition.calories;
                    monthDays++;
                }
            });
            const monthAvgCal = monthDays > 0 ? Math.round(monthTotalCal / monthDays) : null;
            const monthDiff = monthAvgCal !== null ? (todayCal - monthAvgCal) : null;

            const meals = (logData && logData.nutrition && logData.nutrition.meals) ? logData.nutrition.meals : [];
            const carbs = (logData && logData.nutrition) ? Math.round(logData.nutrition.carbs || 0) : 0;
            const protein = (logData && logData.nutrition) ? Math.round(logData.nutrition.protein || 0) : 0;
            const fat = (logData && logData.nutrition) ? Math.round(logData.nutrition.fat || 0) : 0;

            content += `
                <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <span style="font-size: 1.5rem;">ğŸ½ï¸</span>
                        <h3 style="margin: 0; font-size: 1.1rem; color: #333;">ì‹ì‚¬ & ì˜ì–‘</h3>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: ${todayCal > 0 ? '#ff6b6b' : '#999'};">${todayCal} kcal</div>
                            <div style="font-size: 0.9rem; color: #999; margin-top: 5px;">
                                ëª©í‘œ ${targetCal}kcal ëŒ€ë¹„ ${calVsTarget > 0 ? '+' : ''}${calVsTarget}kcal ${calVsTarget > 0 ? 'ì´ˆê³¼ âš ï¸' : calVsTarget < 0 ? 'ë‚¨ìŒ âœ…' : ''}
                            </div>
                            ${calDiff !== null ? `
                                <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                    ì–´ì œ: ${calDiff > 0 ? '+' : ''}${calDiff}kcal
                                </div>
                            ` : ''}
                            ${weekDiff !== null ? `
                                <div style="font-size: 0.85rem; color: #666; margin-top: 2px;">
                                    ì£¼ê°„ í‰ê· : ${weekDiff > 0 ? '+' : ''}${weekDiff}kcal
                                </div>
                            ` : ''}
                            ${monthDiff !== null ? `
                                <div style="font-size: 0.85rem; color: #666; margin-top: 2px;">
                                    ì›”ê°„ í‰ê· : ${monthDiff > 0 ? '+' : ''}${monthDiff}kcal
                                </div>
                            ` : ''}
                        </div>
                        <div style="text-align: right; font-size: 0.85rem; color: #666;">
                            íƒ„ìˆ˜í™”ë¬¼: ${carbs}g<br>
                            ë‹¨ë°±ì§ˆ: ${protein}g<br>
                            ì§€ë°©: ${fat}g
                        </div>
                    </div>
                    ${meals.length > 0 ? `
                        <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                            <strong style="font-size: 0.95rem; color: #555;">ì‹ì‚¬ ë‚´ì—­</strong>
                            ${meals.map(m => `
                                <div style="padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem;">
                                    <span style="color: #333;">â€¢ ${m.foodName}</span>
                                    <span style="float: right; color: #ff6b6b; font-weight: 600;">${Math.round(m.calories)}kcal</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; color: #999; padding: 20px 0; font-size: 0.9rem;">
                            ì‹ì‚¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤
                        </div>
                    `}
                </div>
            `;

            // ========== 3. ë¬¼ ì„­ì·¨ (í•­ìƒ í‘œì‹œ) ==========
            const waterMl = (logData && logData.water) ? logData.water : 0;
            const waterLiters = (waterMl / 1000).toFixed(2);
            const goalLiters = parseFloat(localStorage.getItem('goal_water_target') || '2');
            const waterPercent = Math.round((waterMl / (goalLiters * 1000)) * 100);

            content += `
                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 15px; padding: 20px; margin-bottom: 20px; color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 1.5rem;">ğŸ’§</span>
                        <h3 style="margin: 0; font-size: 1.1rem;">ë¬¼ ì„­ì·¨</h3>
                    </div>
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${waterLiters}L / ${goalLiters}L</div>
                    <div style="font-size: 1rem; opacity: 0.9;">
                        ëª©í‘œ ë‹¬ì„±ë¥ : ${waterPercent}% ${waterPercent >= 100 ? 'ğŸ‰' : waterPercent >= 75 ? 'ğŸ’ª' : waterPercent > 0 ? 'ğŸ˜…' : ''}
                    </div>
                </div>
            `;

            // ========== 4. ë‹¨ì‹ ê¸°ë¡ ==========
            if (!fastingRecords.empty) {
                let totalFastingMinutes = 0;
                fastingRecords.forEach(doc => {
                    const data = doc.data();
                    totalFastingMinutes += data.duration / (1000 * 60);
                });
                const fastingHours = Math.floor(totalFastingMinutes / 60);
                const fastingMins = Math.round(totalFastingMinutes % 60);

                content += `
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 15px; padding: 20px; margin-bottom: 20px; color: white;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 1.5rem;">â±ï¸</span>
                            <h3 style="margin: 0; font-size: 1.1rem;">ê°„í—ì  ë‹¨ì‹</h3>
                        </div>
                        <div style="font-size: 2rem; font-weight: bold;">${fastingHours}ì‹œê°„ ${fastingMins}ë¶„</div>
                        <div style="font-size: 0.95rem; opacity: 0.9; margin-top: 5px;">
                            ${fastingHours >= 16 ? 'âœ¨ ëª©í‘œ ë‹¬ì„±!' : fastingHours >= 12 ? 'ğŸ’ª ê±°ì˜ ë‹¤ ì™”ì–´ìš”!' : 'ğŸ”¥ ì¢‹ì€ ì‹œì‘!'}
                        </div>
                    </div>
                `;
            }

            // ========== 5. ìš´ë™ ==========
            if (logData && logData.exercises && logData.exercises.length > 0) {
                const totalMinutes = logData.exercises.reduce((sum, ex) => sum + (ex.duration || 0), 0);

                content += `
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 1.5rem;">ğŸƒ</span>
                            <h3 style="margin: 0; font-size: 1.1rem; color: #333;">ìš´ë™</h3>
                        </div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #4caf50; margin-bottom: 10px;">ì´ ${totalMinutes}ë¶„</div>
                        ${logData.exercises.map(ex => `
                            <div style="padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem;">
                                <span style="color: #333;">â€¢ ${ex.name}</span>
                                <span style="float: right; color: #4caf50; font-weight: 600;">${ex.duration}ë¶„</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // ========== 6. ì˜¤ëŠ˜ì˜ ëª©í‘œ ==========
            if (goals) {
                const totalGoals = 6 + (goals.customGoals || []).length;
                let completed = 0;
                if (goals['goal-water']) completed++;
                if (goals['goal-fasting']) completed++;
                if (goals['goal-dinner']) completed++;
                if (goals['goal-exercise']) completed++;
                if (goals['goal-calories']) completed++;
                if (goals['goal-weight']) completed++;
                (goals.customGoals || []).forEach(g => { if (g.completed) completed++; });

                const achievementRate = Math.round((completed / totalGoals) * 100);

                content += `
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 1.5rem;">ğŸ¯</span>
                            <h3 style="margin: 0; font-size: 1.1rem; color: #333;">ì˜¤ëŠ˜ì˜ ëª©í‘œ</h3>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 1.3rem; font-weight: bold; color: #667eea;">${completed} / ${totalGoals} ì™„ë£Œ (${achievementRate}%)</div>
                            <div style="height: 8px; background: #e0e0e0; border-radius: 10px; margin-top: 10px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: ${achievementRate}%;"></div>
                            </div>
                        </div>
                        ${achievementRate === 100 ? '<div style="text-align: center; font-size: 1rem; color: #4caf50;">ğŸ‰ ëª¨ë“  ëª©í‘œ ë‹¬ì„±! ëŒ€ë‹¨í•´ìš”!</div>' : ''}
                    </div>
                `;
            }

            // ========== 7. ì˜¤ëŠ˜ì˜ ë‹¤ì§ (í•­ìƒ í‘œì‹œ) ==========
            const diaryContent = (diaryData && diaryData.content) ? diaryData.content : null;
            
            content += `
                <div style="background: #fff8e1; border-left: 4px solid #ffd54f; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 1.5rem;">ğŸ“</span>
                        <h3 style="margin: 0; font-size: 1.1rem; color: #333;">ì˜¤ëŠ˜ì˜ ë‹¤ì§</h3>
                    </div>
                    ${diaryContent ? `
                        <p style="white-space: pre-wrap; line-height: 1.7; color: #555; margin: 0; font-size: 0.95rem;">${diaryContent}</p>
                    ` : `
                        <p style="color: #999; margin: 0; font-size: 0.9rem; text-align: center;">ì‘ì„±ëœ ë‹¤ì§ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    `}
                </div>
            `;

            // ========== 8. ì•¨ë²” (ì‚¬ì§„) ==========
            if (!photos.empty) {
                const bodyPhotos = [];
                const foodPhotos = [];
                const exercisePhotos = [];

                photos.forEach(doc => {
                    const photo = doc.data();
                    if (photo.category === 'body') bodyPhotos.push(photo);
                    else if (photo.category === 'food') foodPhotos.push(photo);
                    else if (photo.category === 'exercise') exercisePhotos.push(photo);
                });

                content += `
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 1.5rem;">ğŸ“¸</span>
                            <h3 style="margin: 0; font-size: 1.1rem; color: #333;">ì•¨ë²”</h3>
                        </div>
                        ${bodyPhotos.length > 0 ? `
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">ğŸ‘¤ ëˆˆë°”ë”” (${bodyPhotos.length}ì¥)</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${bodyPhotos.map(p => `<img src="${p.url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px; cursor: pointer;" onclick="window.open('${p.url}', '_blank')">`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${foodPhotos.length > 0 ? `
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">ğŸ½ï¸ ì‹ë‹¨ (${foodPhotos.length}ì¥)</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${foodPhotos.map(p => `<img src="${p.url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px; cursor: pointer;" onclick="window.open('${p.url}', '_blank')">`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${exercisePhotos.length > 0 ? `
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">ğŸƒ ìš´ë™ (${exercisePhotos.length}ì¥)</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${exercisePhotos.map(p => `<img src="${p.url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px; cursor: pointer;" onclick="window.open('${p.url}', '_blank')">`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // ========== ë°ì´í„° ì—†ìŒ í‘œì‹œ ==========
            const hasAnyData = !weights.empty || (logData && (logData.nutrition || logData.water || (logData.exercises && logData.exercises.length > 0))) || !fastingRecords.empty || (diaryData && diaryData.content) || !photos.empty || goals;

            if (!hasAnyData) {
                content += `
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ“­</div>
                        <div style="font-size: 1.1rem;">ì´ ë‚ ì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <div style="font-size: 0.9rem; margin-top: 10px; color: #bbb;">ê¸°ë¡ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</div>
                    </div>
                `;
            }

            content += `
                    <button onclick="this.closest('.day-report-modal').remove()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;">
                        ë‹«ê¸°
                    </button>
                </div>
            `;

            modal.innerHTML = content;
            document.body.appendChild(modal);
        }

        // íŠ¹ì • ë‚ ì§œì˜ ë°ì´í„° ë™ê¸°í™” (photos ê¸°ì¤€ìœ¼ë¡œ dailyLogs ì¬êµ¬ì„±)
        async function syncDailyData(dateStr) {
            const modal = document.querySelector('.day-report-modal');
            const syncBtn = Array.from(modal.querySelectorAll('button')).find(btn => btn.textContent.includes('ë™ê¸°í™”'));
            if (!syncBtn) return;
            
            const originalText = syncBtn.innerHTML;
            syncBtn.innerHTML = 'ğŸ”„ ë™ê¸°í™” ì¤‘...';
            syncBtn.disabled = true;

            try {
                const date = new Date(dateStr);
                const nextDay = new Date(date);
                nextDay.setDate(nextDay.getDate() + 1);

                // 1. í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ì‚¬ì§„ ê°€ì ¸ì˜¤ê¸° (ì¸ë±ìŠ¤ ì—†ì´ ë‹¨ìˆœ ì¿¼ë¦¬)
                const photosSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(date))
                    .where('uploadedAt', '<', firebase.firestore.Timestamp.fromDate(nextDay))
                    .get();

                // 2. ì‹ë‹¨ ì‚¬ì§„ë§Œ í•„í„°ë§í•˜ê³  ì˜ì–‘ ë°ì´í„° ìˆ˜ì§‘
                let totalCal = 0, totalCarbs = 0, totalProtein = 0, totalFat = 0;
                const meals = [];

                photosSnapshot.forEach(doc => {
                    const photo = doc.data();
                    if (photo.category === 'food' && photo.nutrition) {
                        totalCal += photo.nutrition.calories || 0;
                        totalCarbs += photo.nutrition.carbs || 0;
                        totalProtein += photo.nutrition.protein || 0;
                        totalFat += photo.nutrition.fat || 0;

                        meals.push({
                            foodName: photo.nutrition.foodName || 'ìŒì‹',
                            calories: photo.nutrition.calories || 0,
                            carbs: photo.nutrition.carbs || 0,
                            protein: photo.nutrition.protein || 0,
                            fat: photo.nutrition.fat || 0,
                            timestamp: photo.uploadedAt
                        });
                    }
                });

                // 3. dailyLogs ì—…ë°ì´íŠ¸
                const dailyLogRef = db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').doc(dateStr);

                const dailyLogDoc = await dailyLogRef.get();
                
                if (meals.length > 0) {
                    // ì˜ì–‘ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                    if (dailyLogDoc.exists) {
                        await dailyLogRef.update({
                            'nutrition.calories': totalCal,
                            'nutrition.carbs': totalCarbs,
                            'nutrition.protein': totalProtein,
                            'nutrition.fat': totalFat,
                            'nutrition.meals': meals
                        });
                    } else {
                        await dailyLogRef.set({
                            nutrition: {
                                calories: totalCal,
                                carbs: totalCarbs,
                                protein: totalProtein,
                                fat: totalFat,
                                meals: meals
                            }
                        });
                    }
                    showToast(`âœ… ë™ê¸°í™” ì™„ë£Œ! ì´ ${meals.length}ê°œ ì‹ì‚¬, ${Math.round(totalCal)}kcal`);
                } else {
                    // ì˜ì–‘ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ nutrition í•„ë“œ ì‚­ì œ
                    if (dailyLogDoc.exists && dailyLogDoc.data().nutrition) {
                        await dailyLogRef.update({
                            nutrition: firebase.firestore.FieldValue.delete()
                        });
                    }
                    showToast('âœ… ë™ê¸°í™” ì™„ë£Œ! ì‹ë‹¨ ì‚¬ì§„ì´ ì—†ì–´ ì˜ì–‘ ë°ì´í„°ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }

                // 4. ëª¨ë‹¬ ë‹«ê³  ìƒˆë¡œê³ ì¹¨
                document.querySelector('.day-report-modal').remove();
                await showDayReport(dateStr);

            } catch (error) {
                console.error('ë°ì´í„° ë™ê¸°í™” ì˜¤ë¥˜:', error);
                showToast('âŒ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                syncBtn.innerHTML = originalText;
                syncBtn.disabled = false;
            }
        }

        // ==================== ì†Œí†µ íƒ­ ====================
        // [ìˆ˜ì • 2] ì†Œí†µë°© ë¶ˆëŸ¬ì˜¤ê¸° (ì˜›ë‚  ì£¼ì†Œ + ì•ˆì „ì¥ì¹˜)
        async function loadCommunityMessages() {
            try {
                // ê²½ë¡œ: public -> data -> posts (ì˜›ë‚  ê²½ë¡œ)
                db.collection('artifacts').doc('diet-mate-v2').collection('public')
                    .doc('data').collection('posts')
                    .orderBy('at', 'asc') // ì˜›ë‚  ì‹œê°„ í•„ë“œ 'at' ì‚¬ìš©
                    .limit(50)
                    .onSnapshot(snapshot => {
                        const container = document.getElementById('chatContainer');
                        if (!container) return;
                        
                        container.innerHTML = '';
                        snapshot.forEach(doc => {
                            const msg = doc.data();
                            const msgDiv = document.createElement('div');
                            msgDiv.className = 'chat-message';
                            if (msg.userId === currentUser.uid) msgDiv.classList.add('mine');

                            // ë‚ ì§œ ì•ˆì „í•˜ê²Œ ë³€í™˜
                            let timeStr = "";
                            try {
                                const d = msg.at ? msg.at.toDate() : new Date();
                                timeStr = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
                            } catch(e) { timeStr = "ë‚ ì§œ ì˜¤ë¥˜"; }

                            // ë‚´ìš© í‘œì‹œ (ì˜›ë‚  í•„ë“œ í˜¸í™˜)
                            const name = msg.name || msg.userName || 'ìµëª…';
                            const text = msg.text || msg.message || '';

                            msgDiv.innerHTML = `
                                <div class=\"message-header\">
                                    <span class=\"message-author\">${name}</span>
                                    <span class=\"message-time\">${timeStr}</span>
                                </div>
                                <div class=\"message-bubble\">${text}</div>
                            `;
                            container.appendChild(msgDiv);
                        });
                        container.scrollTop = container.scrollHeight;
                    });
            } catch (e) {
                console.error("ì±„íŒ… ë¡œë“œ ì‹¤íŒ¨:", e);
            }
        }

        // [ìˆ˜ì • 3] ì±„íŒ… ë³´ë‚´ê¸° (ì˜›ë‚  ì£¼ì†Œë¡œ ì „ì†¡)
        async function sendCommunityMessage() {
            const input = document.getElementById('communityInput');
            const message = input.value.trim();
            
            if (!message) return;
            if (!currentProfile) {
                alert("í”„ë¡œí•„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
                return;
            }

            try {
                await db.collection('artifacts').doc('diet-mate-v2').collection('public')
                    .doc('data').collection('posts').add({
                    userId: currentUser.uid,
                    name: currentProfile.name, // ë‚´ ì´ë¦„
                    text: message,             // ë©”ì‹œì§€ ë‚´ìš©
                    at: firebase.firestore.FieldValue.serverTimestamp()
                });
                input.value = '';
            } catch (e) {
                alert("ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: " + e.message);
            }
        }

        // ==================== ì•Œë¦¼ íƒ­ ====================
        function loadNotifications() {
            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            const list = document.getElementById('notificationList');
            list.innerHTML = '';

            if (notifications.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">ì„¤ì •ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            notifications.forEach((notif, index) => {
                const notifDiv = document.createElement('div');
                notifDiv.className = 'notification-item';
                notifDiv.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-title">${notif.title}</div>
                        <div class="notification-details">${notif.time} - ${notif.repeat}</div>
                    </div>
                    <div class="notification-actions">
                        <div class="notification-edit" onclick="editNotification(${index})">âœï¸</div>
                        <div class="notification-delete" onclick="deleteNotification(${index})">ğŸ—‘ï¸</div>
                    </div>
                `;
                list.appendChild(notifDiv);
            });
        }

        function openAddNotificationModal() {
            document.getElementById('notificationTitleInput').value = '';
            document.getElementById('notificationTimeInput').value = '09:00';
            // ë§¤ì¼ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('#notificationRepeatGroup .modern-select-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.value === 'ë§¤ì¼') btn.classList.add('active');
            });
            openModernModal('addNotificationModal');
        }
        
        // ì•Œë¦¼ ë°˜ë³µ ì„ íƒ
        function selectNotificationRepeat(btn) {
            document.querySelectorAll('#notificationRepeatGroup .modern-select-btn').forEach(b => {
                b.classList.remove('active');
            });
            btn.classList.add('active');
        }
        
        // ì•Œë¦¼ ì œì¶œ
        function submitNotification() {
            const title = document.getElementById('notificationTitleInput').value;
            const time = document.getElementById('notificationTimeInput').value;
            const repeatBtn = document.querySelector('#notificationRepeatGroup .modern-select-btn.active');
            const repeatValue = repeatBtn ? repeatBtn.dataset.value : 'ë§¤ì¼';
            
            if (!title) {
                showErrorToast('ì•Œë¦¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            if (!time) {
                showErrorToast('ì•Œë¦¼ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            closeModernModal('addNotificationModal');

            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            notifications.push({
                title: title,
                time: time,
                repeat: repeatValue,
                lastTriggered: null
            });

            localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
            loadNotifications();
            showSuccessToast('ì•Œë¦¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        function addWaterNotificationPreset() {
            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');

            // ì¤‘ë³µ ì²´í¬
            const hasWaterAlerts = notifications.some(n => n.title.includes('ë¬¼ ë§ˆì‹œê¸°'));
            if (hasWaterAlerts) {
                if (!confirm('ì´ë¯¸ ë¬¼ ë§ˆì‹œê¸° ì•Œë¦¼ì´ ìˆìŠµë‹ˆë‹¤. ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            }

            // ë¬¼ ë§ˆì‹œê¸° ì•Œë¦¼ 5íšŒ ì¶”ê°€ (9ì‹œ, 12ì‹œ, 15ì‹œ, 18ì‹œ, 21ì‹œ)
            const waterTimes = ['09:00', '12:00', '15:00', '18:00', '21:00'];
            waterTimes.forEach(time => {
                notifications.push({
                    title: 'ğŸ’§ ë¬¼ ë§ˆì‹œê¸°',
                    time: time,
                    repeat: 'ë§¤ì¼',
                    lastTriggered: null
                });
            });

            localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
            loadNotifications();
            alert('ë¬¼ ë§ˆì‹œê¸° ì•Œë¦¼ 5ê°œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\n(9ì‹œ, 12ì‹œ, 15ì‹œ, 18ì‹œ, 21ì‹œ)');
        }

        function deleteNotification(index) {
            if (!confirm('ì´ ì•Œë¦¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            notifications.splice(index, 1);
            localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
            loadNotifications();
        }

        let editingNotificationIndex = null;

        function editNotification(index) {
            editingNotificationIndex = index;
            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            const notif = notifications[index];

            // ëª¨ë‹¬ì— í˜„ì¬ ê°’ ì±„ìš°ê¸°
            document.getElementById('editNotifTitle').value = notif.title;
            document.getElementById('editNotifTime').value = notif.time;
            document.getElementById('editNotifRepeat').value = notif.repeat;

            // ëª¨ë‹¬ ì—´ê¸°
            document.getElementById('editNotificationModalOverlay').classList.add('show');
        }

        function closeEditNotificationModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('editNotificationModalOverlay');
            modal.classList.remove('show');
            editingNotificationIndex = null;
        }

        function saveEditedNotification() {
            if (editingNotificationIndex === null) return;

            const title = document.getElementById('editNotifTitle').value.trim();
            const time = document.getElementById('editNotifTime').value;
            const repeat = document.getElementById('editNotifRepeat').value;

            if (!title || !time) {
                alert('ì•Œë¦¼ ë‚´ìš©ê³¼ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            notifications[editingNotificationIndex] = {
                title: title,
                time: time,
                repeat: repeat,
                lastTriggered: notifications[editingNotificationIndex].lastTriggered
            };

            localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
            loadNotifications();
            closeEditNotificationModal();
            showSuccessToast('ì•Œë¦¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function startNotificationCheck() {
            // ì•Œë¦¼ ê¶Œí•œì€ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ìš”ì²­ (ìë™ ìš”ì²­ ì œê±°)
            
            // 1ë¶„ë§ˆë‹¤ ì•Œë¦¼ ì²´í¬
            notificationCheckInterval = setInterval(() => {
                checkAndTriggerNotifications();
            }, 60000);

            checkAndTriggerNotifications();
        }

        function checkAndTriggerNotifications() {
            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            notifications.forEach((notif, index) => {
                if (notif.time === currentTime) {
                    const lastTriggered = notif.lastTriggered ? new Date(notif.lastTriggered) : null;

                    let shouldTrigger = false;
                    if (!lastTriggered) {
                        shouldTrigger = true;
                    } else if (notif.repeat === 'ë§¤ì¼') {
                        const daysDiff = Math.floor((now - lastTriggered) / (1000 * 60 * 60 * 24));
                        if (daysDiff >= 1) shouldTrigger = true;
                    } else if (notif.repeat === 'ë§¤ì£¼') {
                        const daysDiff = Math.floor((now - lastTriggered) / (1000 * 60 * 60 * 24));
                        if (daysDiff >= 7) shouldTrigger = true;
                    }

                    if (shouldTrigger) {
                        // ğŸ”” Service Worker ê¸°ë°˜ í‘¸ì‹œ ì•Œë¦¼ (ëª¨ë°”ì¼ ì§€ì›)
                        sendPushNotification(
                            'â° Diet Mate ì•Œë¦¼',
                            notif.title,
                            'diet-mate-reminder'
                        );

                        // ë§ˆì§€ë§‰ íŠ¸ë¦¬ê±° ì‹œê°„ ì—…ë°ì´íŠ¸
                        notifications[index].lastTriggered = now.toISOString();
                        localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
                    }
                }
            });
        }
        
        // ğŸ”” ë‹¨ì‹ ìƒíƒœ ì²´í¬ ë° ì•Œë¦¼ (Service Workerì—ì„œ í˜¸ì¶œ)
        function checkAndNotifyFasting() {
            if (!fastingState || !fastingState.active) return;
            
            const elapsed = Date.now() - fastingState.startTime;
            const targetMs = fastingState.targetHours * 60 * 60 * 1000;
            
            if (elapsed >= targetMs) {
                sendFastingCompletionNotification();
            }
        }

        // ==================== ì„¤ì • íƒ­ ====================
        async function loadSettings() {
            // í•¨ê»˜í•œ ë‚  ê³„ì‚°
            const createdAt = currentProfile.createdAt ? currentProfile.createdAt.toDate() : new Date();
            const daysSince = Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24));
            document.getElementById('totalDays').textContent = daysSince;

            // ì´ ìš´ë™ ì‹œê°„ (í”Œëœì—ì„œ ìš´ë™ ì¹´í…Œê³ ë¦¬ í•©ì‚°)
            try {
                const plansSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('plans').get();

                let totalExerciseMinutes = 0;
                plansSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.category === 'ìš´ë™' && data.value) {
                        // valueì—ì„œ ìˆ«ì ì¶”ì¶œ (ì˜ˆ: "30ë¶„", "1ì‹œê°„" ë“±)
                        const match = data.value.match(/(\d+)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            if (data.value.includes('ì‹œê°„')) {
                                totalExerciseMinutes += num * 60;
                            } else {
                                totalExerciseMinutes += num;
                            }
                        }
                    }
                });

                // ë‹¨ì‹ ê¸°ë¡ì—ì„œë„ ìš´ë™ ì‹œê°„ ì¶”ê°€ (ë‹¨ì‹ ì¤‘ ìš´ë™í•œ ê²½ìš°)
                const fastingRecords = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('fastingRecords').get();

                // ìš´ë™ ì‹œê°„ í‘œì‹œ
                document.getElementById('totalExercise').textContent = totalExerciseMinutes;
            } catch (error) {
                console.error('ìš´ë™ ì‹œê°„ ê³„ì‚° ì‹¤íŒ¨:', error);
                document.getElementById('totalExercise').textContent = '0';
            }

            // ì ˆì•½ ì¹¼ë¡œë¦¬ (ê°„ë‹¨ ê³„ì‚°)
            const startWeight = currentProfile.startWeight || 0;
            const weightData = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs').orderBy('date', 'desc').limit(1).get();

            const currentWeight = weightData.empty ? startWeight : weightData.docs[0].data().weight;
            const weightLost = startWeight - currentWeight;
            const caloriesSaved = Math.floor(weightLost * 7700); // 1kg = ì•½ 7700kcal
            document.getElementById('totalCalories').textContent = caloriesSaved > 0 ? caloriesSaved : 0;

            // AI ì˜ˆì¸¡ ë‹¬ì„±ì¼ (ìµœê·¼ 30ì¼ ë°ì´í„° ê¸°ë°˜)
            const goalWeight = currentProfile.goalWeight || 0;
            const remaining = currentWeight - goalWeight;

            if (remaining > 0) {
                try {
                    // ìµœê·¼ 30ì¼ ì²´ì¤‘ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                    const recentWeights = await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(currentUser.uid)
                        .collection('logs')
                        .where('date', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
                        .orderBy('date', 'asc')
                        .get();

                    if (!recentWeights.empty && recentWeights.docs.length >= 2) {
                        const firstWeight = recentWeights.docs[0].data().weight;
                        const lastWeight = recentWeights.docs[recentWeights.docs.length - 1].data().weight;
                        const daysInPeriod = recentWeights.docs.length;

                        const recentWeightLoss = firstWeight - lastWeight;

                        if (recentWeightLoss > 0) {
                            // ì£¼ê°„ ê°ëŸ‰ ì†ë„ ê³„ì‚°
                            const avgWeeklyLoss = (recentWeightLoss / daysInPeriod) * 7;
                            const weeksNeeded = Math.ceil(remaining / avgWeeklyLoss);
                            const daysNeeded = weeksNeeded * 7;

                            const predictedDate = new Date();
                            predictedDate.setDate(predictedDate.getDate() + daysNeeded);
                            document.getElementById('predictedDate').textContent = `${predictedDate.getMonth() + 1}/${predictedDate.getDate()}`;
                        } else {
                            // ì²´ì¤‘ ì¦ê°€ ì¤‘
                            document.getElementById('predictedDate').textContent = 'ì²´ì¤‘ ê´€ë¦¬ í•„ìš”';
                        }
                    } else if (weightLost > 0 && daysSince > 0) {
                        // ë°ì´í„°ê°€ ë¶€ì¡±í•˜ë©´ ì „ì²´ ê¸°ê°„ í‰ê·  ì‚¬ìš©
                        const avgLossPerDay = weightLost / daysSince;
                        const daysNeeded = Math.ceil(remaining / avgLossPerDay);
                        const predictedDate = new Date();
                        predictedDate.setDate(predictedDate.getDate() + daysNeeded);
                        document.getElementById('predictedDate').textContent = `${predictedDate.getMonth() + 1}/${predictedDate.getDate()}`;
                    } else {
                        document.getElementById('predictedDate').textContent = '-';
                    }
                } catch (error) {
                    console.error('ì˜ˆìƒ ë‹¬ì„±ì¼ ê³„ì‚° ì‹¤íŒ¨:', error);
                    document.getElementById('predictedDate').textContent = '-';
                }
            } else {
                document.getElementById('predictedDate').textContent = 'ëª©í‘œ ë‹¬ì„±!';
            }
        }

        async function exportData() {
            try {
                const data = {
                    profile: currentProfile,
                    weights: [],
                    plans: [],
                    photos: []
                };

                const weights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid).collection('logs').get();
                weights.forEach(doc => data.weights.push({ id: doc.id, ...doc.data() }));

                const plans = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid).collection('plans').get();
                plans.forEach(doc => data.plans.push({ id: doc.id, ...doc.data() }));

                const photos = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid).collection('photos').get();
                photos.forEach(doc => data.photos.push({ id: doc.id, ...doc.data() }));

                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `diet_mate_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();

                URL.revokeObjectURL(url);
                alert('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!');
            } catch (error) {
                console.error('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
                alert('ë°ì´í„° ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    if (!confirm('ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ? (ì·¨ì†Œí•˜ë©´ ë³‘í•©ë©ë‹ˆë‹¤)')) {
                        // ë³‘í•© ëª¨ë“œ
                        alert('ë³‘í•© ê¸°ëŠ¥ì€ í˜„ì¬ êµ¬í˜„ ì¤‘ì…ë‹ˆë‹¤. ë°ì´í„°ë¥¼ ë®ì–´ì”ë‹ˆë‹¤.');
                    }

                    // ì²´ì¤‘ ë°ì´í„° ë³µì›
                    for (const weight of data.weights) {
                        const { id, ...weightData } = weight;
                        await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                            .collection('logs').add(weightData);
                    }

                    // í”Œëœ ë°ì´í„° ë³µì›
                    for (const plan of data.plans) {
                        const { id, ...planData } = plan;
                        await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                            .collection('plans').add(planData);
                    }

                    alert('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ! í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                    location.reload();
                } catch (error) {
                    console.error('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                    alert('ë°ì´í„° ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            };
            input.click();
        }

        // ==================== ì‹ì‚¬ ì§ì ‘ ì…ë ¥ ê¸°ëŠ¥ ====================
        let analyzedNutrition = null;

        // ì‹ì‚¬ íƒ€ì… ì„ íƒ
        function selectMeal(mealType) {
            currentMealType = mealType;
            const methodDiv = document.getElementById('mealInputMethod');
            
            // í† ê¸€ ê¸°ëŠ¥: ì´ë¯¸ ì—´ë ¤ìˆê³  ê°™ì€ ì‹ì‚¬ íƒ€ì…ì´ë©´ ë‹«ê¸°
            if (methodDiv.style.display === 'block' && document.getElementById('selectedMealType').textContent === mealType) {
                methodDiv.style.display = 'none';
                console.log('ì‹ì‚¬ ì…ë ¥ ë‹«ê¸°');
            } else {
                // ì—´ê¸°
                document.getElementById('selectedMealType').textContent = mealType;
                methodDiv.style.display = 'block';
                console.log('ì‹ì‚¬ ì…ë ¥ ì—´ê¸°:', mealType);
            }
        }

        // ì‚¬ì§„ìœ¼ë¡œ ìŒì‹ ë¶„ì„ (Gemini Vision API)
        async function uploadFoodPhoto(isEditMode = false) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'camera'; // ëª¨ë°”ì¼ì—ì„œ ì¹´ë©”ë¼ ì§ì ‘ ì—´ê¸°

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                showLoading('AIê°€ ìŒì‹ì„ ë¶„ì„ ì¤‘...');

                try {
                    // 1. Firebase Storageì— ì—…ë¡œë“œ
                    const timestamp = Date.now();
                    const storageRef = storage.ref(`meals/${currentUser.uid}/${timestamp}.jpg`);
                    await storageRef.put(file);
                    const photoURL = await storageRef.getDownloadURL();

                    // 2. ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ë³€í™˜
                    const base64Image = await fileToBase64(file);

                    // 3. Gemini Flash 1.5ë¡œ ìŒì‹ ë¶„ì„
                    const analysis = await analyzeImageWithGemini(base64Image);

                    hideLoading();

                    if (analysis) {
                        // ğŸ”¥ ìˆ˜ì • ëª¨ë“œ í™•ì¸
                        if (isEditMode && window.editingMealData) {
                            const editData = window.editingMealData;
                            const meal = todayIntake.meals[editData.index];
                            
                            if (meal) {
                                // ê¸°ì¡´ ì˜ì–‘ì†Œ ì°¨ê°
                                todayIntake.calories -= (meal.calories || 0);
                                todayIntake.carbs -= (meal.carbs || 0);
                                todayIntake.protein -= (meal.protein || 0);
                                todayIntake.fat -= (meal.fat || 0);
                                
                                // ìƒˆ ì˜ì–‘ ì •ë³´ë¡œ ì—…ë°ì´íŠ¸ (ì‹œê°„ì€ ìœ ì§€, ì‚¬ì§„ì€ ë³€ê²½)
                                meal.food = analysis.foodName;
                                meal.foodName = analysis.foodName;
                                meal.name = analysis.foodName;
                                meal.calories = analysis.calories;
                                meal.carbs = analysis.carbs;
                                meal.protein = analysis.protein;
                                meal.fat = analysis.fat;
                                meal.photo = photoURL;
                                meal.photoURL = photoURL;
                                // meal.timestampëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
                                
                                // ìƒˆ ì˜ì–‘ì†Œ ì¶”ê°€
                                todayIntake.calories += analysis.calories;
                                todayIntake.carbs += analysis.carbs;
                                todayIntake.protein += analysis.protein;
                                todayIntake.fat += analysis.fat;
                                
                                // Firebase ì €ì¥
                                await saveTodayNutritionToFirestore();
                                
                                // ğŸ”¥ ì•¨ë²” íƒ­ ë™ê¸°í™”: ê¸°ì¡´ ì‚¬ì§„ ì‚­ì œ + ìƒˆ ì‚¬ì§„ ì¶”ê°€
                                if (editData.originalPhoto) {
                                    // ê¸°ì¡´ ì‚¬ì§„ ì‚­ì œ
                                    const oldPhotosSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                                        .collection('users').doc(currentUser.uid)
                                        .collection('photos')
                                        .where('url', '==', editData.originalPhoto)
                                        .get();
                                    
                                    oldPhotosSnapshot.forEach(async (doc) => {
                                        await doc.ref.delete();
                                        console.log('ğŸ—‘ï¸ ì•¨ë²” ê¸°ì¡´ ì‚¬ì§„ ì‚­ì œ:', doc.id);
                                    });
                                }
                                
                                // ìƒˆ ì‚¬ì§„ ì¶”ê°€
                                await db.collection('artifacts').doc('diet-mate-v2')
                                    .collection('users').doc(currentUser.uid)
                                    .collection('photos').add({
                                        category: 'food',
                                        url: photoURL,
                                        meal: currentMealType,
                                        food: analysis.foodName,
                                        nutrition: {
                                            calories: analysis.calories,
                                            carbs: analysis.carbs,
                                            protein: analysis.protein,
                                            fat: analysis.fat
                                        },
                                        uploadedAt: editData.originalTimestamp || firebase.firestore.FieldValue.serverTimestamp(),
                                        mealType: currentMealType
                                    });
                                
                                // UI ì—…ë°ì´íŠ¸
                                updateNutritionUI();
                                
                                // ìˆ˜ì • ë°ì´í„° ì´ˆê¸°í™”
                                window.editingMealData = null;
                                
                                showAIToast(`âœ… ${analysis.foodName} ìˆ˜ì • ì™„ë£Œ! (ì‹œê°„ ìœ ì§€)\nì¹¼ë¡œë¦¬: ${analysis.calories}kcal`, 5000);
                            }
                        } else {
                            // ğŸ”¥ ì‹ ê·œ ë“±ë¡ ëª¨ë“œ
                            // 4. ì˜ì–‘ ì„­ì·¨ì— ì¶”ê°€
                            addMeal(currentMealType, analysis.foodName, {
                                calories: analysis.calories,
                                carbs: analysis.carbs,
                                protein: analysis.protein,
                                fat: analysis.fat,
                                timestamp: new Date(),
                                photo: photoURL
                            });

                            // 5. ì•¨ë²”ì— ì €ì¥
                            await db.collection('artifacts').doc('diet-mate-v2')
                                .collection('users').doc(currentUser.uid)
                                .collection('photos').add({
                                    category: 'food',
                                    url: photoURL,
                                    meal: currentMealType,
                                    food: analysis.foodName,
                                    nutrition: {
                                        calories: analysis.calories,
                                        carbs: analysis.carbs,
                                        protein: analysis.protein,
                                        fat: analysis.fat
                                    },
                                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    mealType: currentMealType
                                });

                            // 6. UI ì—…ë°ì´íŠ¸
                            updateNutritionUI();

                            // 7. ì…ë ¥ ë°©ë²• ì„ íƒ ì˜ì—­ ìˆ¨ê¸°ê¸°
                            document.getElementById('mealInputMethod').style.display = 'none';

                            showAIToast(`ğŸ“¸ ${analysis.foodName} ì¶”ê°€ ì™„ë£Œ!\nì¹¼ë¡œë¦¬: ${analysis.calories}kcal`, 5000);
                        }
                    } else {
                        alert('ìŒì‹ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }

                } catch (error) {
                    console.error('ìŒì‹ ì‚¬ì§„ ë¶„ì„ ì˜¤ë¥˜:', error);
                    hideLoading();
                    alert('ìŒì‹ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };

            input.click();
        }

        // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // data:image/jpeg;base64,... í˜•ì‹ì—ì„œ base64 ë¶€ë¶„ë§Œ ì¶”ì¶œ
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Geminië¡œ ì´ë¯¸ì§€ ë¶„ì„ (íš¨ìœ¨ì ì¸ Flash ëª¨ë¸ ì‚¬ìš©)
        async function analyzeImageWithGemini(base64Image) {
            try {
                // gemini-2.5-flash: ê°€ì¥ íš¨ìœ¨ì ì´ê³  ë¹ ë¥´ë©° í• ë‹¹ëŸ‰ì´ ë§ìŒ, ì´ë¯¸ì§€ ë¶„ì„ë„ ì™„ë²½ ì§€ì›
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;

                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: "ì´ ìŒì‹ ì‚¬ì§„ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ì •ë³´ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì •í™•í•˜ê²Œ ì œê³µí•´ì£¼ì„¸ìš”:\n1. foodName: ìŒì‹ ì´ë¦„ (í•œêµ­ì–´)\n2. calories: ì˜ˆìƒ ì¹¼ë¡œë¦¬ (ìˆ«ìë§Œ)\n3. carbs: íƒ„ìˆ˜í™”ë¬¼ (g, ìˆ«ìë§Œ)\n4. protein: ë‹¨ë°±ì§ˆ (g, ìˆ«ìë§Œ)\n5. fat: ì§€ë°© (g, ìˆ«ìë§Œ)\n6. per100g: 100gë‹¹ ì˜ì–‘ì •ë³´ ê°ì²´ {calories, carbs, protein, fat}\n\nì‘ë‹µ í˜•ì‹:\n{\"foodName\": \"ë‹­ê°€ìŠ´ì‚´ ìƒëŸ¬ë“œ\", \"calories\": 250, \"carbs\": 15, \"protein\": 30, \"fat\": 8, \"per100g\": {\"calories\": 120, \"carbs\": 7, \"protein\": 14, \"fat\": 4}}\n\nì°¸ê³ : ìŒì‹ì˜ ì–‘ê³¼ ì¢…ë¥˜ë¥¼ ê³ ë ¤í•˜ì—¬ ì‹¤ì œì— ê°€ê¹Œìš´ ì˜ì–‘ ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”."
                            },
                            {
                                inline_data: {
                                    mime_type: "image/jpeg",
                                    data: base64Image
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.4,
                        maxOutputTokens: 200,
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;

                // JSON ì¶”ì¶œ (```jsonìœ¼ë¡œ ê°ì‹¸ì ¸ ìˆì„ ìˆ˜ ìˆìŒ)
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const nutritionData = JSON.parse(jsonMatch[0]);
                    return nutritionData;
                } else {
                    throw new Error('JSON í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

            } catch (error) {
                console.error('Gemini API ë¶„ì„ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        function openMealInputModal(mealType) {
            if (mealType) {
                currentMealType = mealType;
            }
            
            // currentMealTypeì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
            if (!currentMealType) {
                currentMealType = 'ì ì‹¬';
            }
            
            const modal = document.getElementById('mealInputModalOverlay');
            const title = document.getElementById('mealInputTitle');

            // ì´ëª¨ì§€ ë§¤í•‘
            const emojiMap = {
                'ì•„ì¹¨': 'ğŸŒ…',
                'ì ì‹¬': 'â˜€ï¸',
                'ì €ë…': 'ğŸŒ™',
                'ê°„ì‹': 'ğŸª'
            };

            title.textContent = `${emojiMap[currentMealType] || 'ğŸ½ï¸'} ${currentMealType} ì…ë ¥`;
            modal.classList.add('show');

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('mealFoodName').value = '';
            document.getElementById('mealGrams').value = '';
            document.getElementById('nutritionResult').classList.remove('show');
            document.getElementById('manualInputFields').classList.remove('show');
            document.getElementById('foodSearchResults').style.display = 'none'; // ğŸ”¥ ê²€ìƒ‰ ê²°ê³¼ ì´ˆê¸°í™”
            analyzedNutrition = null;
        }

        function closeMealInputModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('mealInputModalOverlay');
            modal.classList.remove('show');
        }

        async function analyzeMealWithAI() {
            const foodName = document.getElementById('mealFoodName').value.trim();
            const grams = document.getElementById('mealGrams').value.trim();

            if (!foodName) {
                alert('ìŒì‹ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const btn = document.getElementById('aiAnalyzeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>â³</span><span>ë¶„ì„ ì¤‘...</span>';

            try {
                // ğŸ”¥ ì˜ì–‘ ë¶„ì„ ì „ìš© API ì‚¬ìš©
                const response = await callGeminiNutritionAnalysis(foodName, grams, currentProfile);
                const nutrition = parseNutritionResponse(response);

                if (nutrition) {
                    analyzedNutrition = nutrition;

                    // ê²°ê³¼ í‘œì‹œ
                    document.getElementById('resultCalories').textContent = Math.round(nutrition.calories);
                    document.getElementById('resultCarbs').textContent = Math.round(nutrition.carbs);
                    document.getElementById('resultProtein').textContent = Math.round(nutrition.protein);
                    document.getElementById('resultFat').textContent = Math.round(nutrition.fat);

                    document.getElementById('nutritionResult').classList.add('show');

                    showAIToast(nutrition.advice || 'ì˜ì–‘ ë¶„ì„ ì™„ë£Œ!', 3000);
                } else {
                    throw new Error('ì˜ì–‘ ë¶„ì„ ì‹¤íŒ¨');
                }

            } catch (error) {
                console.error('AI ë¶„ì„ ì˜¤ë¥˜:', error);
                alert('ì˜ì–‘ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('nutritionResult').classList.add('show');
                document.getElementById('manualInputFields').classList.add('show');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>ğŸ¤–</span><span>AIë¡œ ì˜ì–‘ ë¶„ì„</span>';
            }
        }
        
        // ğŸ”¥ ìƒˆ ê¸°ëŠ¥: ìŒì‹ ê²€ìƒ‰ (ë¸Œëœë“œë³„ ì˜ì–‘ ì •ë³´ ì œê³µ)
        // ğŸ”¥ ê¸°ë³¸ ìŒì‹ ë°ì´í„°ë² ì´ìŠ¤ (API ì—†ì´ë„ ì‘ë™)
        const BASIC_FOOD_DB = {
            'ë¼ë©´': [
                {foodName: 'ì‹ ë¼ë©´ 1ì¸ë¶„', calories: 500, carbs: 80, protein: 10, fat: 16},
                {foodName: 'ì§„ë¼ë©´ 1ì¸ë¶„', calories: 480, carbs: 78, protein: 9, fat: 15},
                {foodName: 'ë„ˆêµ¬ë¦¬ 1ì¸ë¶„', calories: 520, carbs: 82, protein: 11, fat: 17}
            ],
            'ê¹€ì¹˜ì°Œê°œ': [
                {foodName: 'ê¹€ì¹˜ì°Œê°œ 1ì¸ë¶„', calories: 250, carbs: 15, protein: 18, fat: 12},
                {foodName: 'ì°¸ì¹˜ê¹€ì¹˜ì°Œê°œ 1ì¸ë¶„', calories: 280, carbs: 16, protein: 22, fat: 14}
            ],
            'ëœì¥ì°Œê°œ': [
                {foodName: 'ëœì¥ì°Œê°œ 1ì¸ë¶„', calories: 180, carbs: 12, protein: 15, fat: 8}
            ],
            'ì‚¼ê²¹ì‚´': [
                {foodName: 'ì‚¼ê²¹ì‚´ 100g', calories: 518, carbs: 0, protein: 17, fat: 50},
                {foodName: 'ì‚¼ê²¹ì‚´ 1ì¸ë¶„(200g)', calories: 1036, carbs: 0, protein: 34, fat: 100}
            ],
            'ì¹˜í‚¨': [
                {foodName: 'í›„ë¼ì´ë“œì¹˜í‚¨ 1ì¡°ê°', calories: 250, carbs: 12, protein: 20, fat: 15},
                {foodName: 'ì–‘ë…ì¹˜í‚¨ 1ì¡°ê°', calories: 280, carbs: 18, protein: 19, fat: 16}
            ],
            'í”¼ì': [
                {foodName: 'í”¼ì 1ì¡°ê°', calories: 280, carbs: 35, protein: 12, fat: 10}
            ],
            'í–„ë²„ê±°': [
                {foodName: 'ë¶ˆê³ ê¸°ë²„ê±°', calories: 450, carbs: 50, protein: 22, fat: 18},
                {foodName: 'ì¹˜ì¦ˆë²„ê±°', calories: 380, carbs: 40, protein: 18, fat: 15}
            ],
            'ë°¥': [
                {foodName: 'ë°±ë¯¸ë°¥ 1ê³µê¸°', calories: 300, carbs: 65, protein: 6, fat: 1},
                {foodName: 'ì¡ê³¡ë°¥ 1ê³µê¸°', calories: 280, carbs: 60, protein: 7, fat: 2}
            ],
            'ë¹µ': [
                {foodName: 'ì‹ë¹µ 1ì¡°ê°', calories: 80, carbs: 15, protein: 3, fat: 1},
                {foodName: 'í¬ë¡œì™€ìƒ 1ê°œ', calories: 230, carbs: 26, protein: 5, fat: 12}
            ]
        };
        
        async function searchFoodDatabase() {
            const foodName = document.getElementById('mealFoodName').value.trim();
            
            if (!foodName) {
                alert('ê²€ìƒ‰í•  ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const searchBtn = document.querySelector('.search-food-btn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = 'â³ ê²€ìƒ‰ ì¤‘...';
            
            try {
                // ğŸ”¥ 1ë‹¨ê³„: ê¸°ë³¸ DBì—ì„œ ê²€ìƒ‰
                let foodOptions = searchBasicDB(foodName);
                
                // ğŸ”¥ 2ë‹¨ê³„: ê¸°ë³¸ DBì— ì—†ìœ¼ë©´ AI ê²€ìƒ‰ ì‹œë„
                if (!foodOptions || foodOptions.length === 0) {
                    try {
                        const response = await callGeminiFoodSearch(foodName);
                        foodOptions = parseFoodSearchResponse(response);
                    } catch (apiError) {
                        console.warn('AI ê²€ìƒ‰ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì œê³µ:', apiError);
                        // AI ì‹¤íŒ¨ ì‹œ ì¶”ì •ê°’ ì œê³µ
                        foodOptions = [{
                            foodName: `${foodName} 1ì¸ë¶„ (ì¶”ì •)`,
                            calories: 300,
                            carbs: 40,
                            protein: 15,
                            fat: 10
                        }];
                    }
                }
                
                if (foodOptions && foodOptions.length > 0) {
                    displayFoodOptions(foodOptions);
                } else {
                    throw new Error('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                console.error('ìŒì‹ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                alert('ìŒì‹ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì˜ì–‘ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                // ìˆ˜ë™ ì…ë ¥ í•„ë“œ í‘œì‹œ
                document.getElementById('manualInputFields').classList.add('show');
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = 'ğŸ” ê²€ìƒ‰';
            }
        }
        
        // ê¸°ë³¸ DB ê²€ìƒ‰ í•¨ìˆ˜
        function searchBasicDB(query) {
            const results = [];
            query = query.toLowerCase().trim();
            
            for (const [key, items] of Object.entries(BASIC_FOOD_DB)) {
                if (key.includes(query) || query.includes(key)) {
                    results.push(...items);
                }
            }
            
            return results;
        }
        
        function parseFoodSearchResponse(response) {
            try {
                // JSON ë°°ì—´ ì¶”ì¶œ
                const jsonMatch = response.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                throw new Error('JSON í˜•ì‹ ì˜¤ë¥˜');
            } catch (error) {
                console.error('ê²€ìƒ‰ ê²°ê³¼ íŒŒì‹± ì‹¤íŒ¨:', error);
                return null;
            }
        }
        
        function displayFoodOptions(options) {
            const container = document.getElementById('foodOptionsContainer');
            const resultsDiv = document.getElementById('foodSearchResults');
            
            container.innerHTML = options.map((option, index) => `
                <div onclick="selectFoodOption(${index})" 
                     style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                     onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateX(5px)';"
                     onmouseout="this.style.borderColor='transparent'; this.style.transform='translateX(0)';">
                    <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                        ${option.name}
                    </div>
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                        ${option.serving}
                    </div>
                    <div style="display: flex; gap: 15px; font-size: 0.85rem; color: #999;">
                        <span>ğŸ”¥ ${option.calories}kcal</span>
                        <span>ğŸš íƒ„${option.carbs}g</span>
                        <span>ğŸ’ª ë‹¨${option.protein}g</span>
                        <span>ğŸ§ˆ ì§€${option.fat}g</span>
                    </div>
                </div>
            `).join('');
            
            resultsDiv.style.display = 'block';
            
            // ê²€ìƒ‰ ê²°ê³¼ ì €ì¥
            window.currentFoodOptions = options;
        }
        
        function selectFoodOption(index) {
            const option = window.currentFoodOptions[index];
            if (!option) return;
            
            // ìŒì‹ëª… ì—…ë°ì´íŠ¸
            document.getElementById('mealFoodName').value = option.name;
            
            // ì˜ì–‘ ì •ë³´ ìë™ ì±„ìš°ê¸° (100gë‹¹ ì •ë³´ í¬í•¨)
            analyzedNutrition = {
                calories: option.calories,
                carbs: option.carbs,
                protein: option.protein,
                fat: option.fat,
                foodName: option.name,
                per100g: option.per100g || null, // ğŸ”¥ 100gë‹¹ ì •ë³´ ì €ì¥
                advice: `${option.name} ì„ íƒ ì™„ë£Œ!`
            };
            
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('resultCalories').textContent = Math.round(option.calories);
            document.getElementById('resultCarbs').textContent = Math.round(option.carbs);
            document.getElementById('resultProtein').textContent = Math.round(option.protein);
            document.getElementById('resultFat').textContent = Math.round(option.fat);
            
            document.getElementById('nutritionResult').classList.add('show');
            document.getElementById('foodSearchResults').style.display = 'none';
            
            showAIToast(`âœ… ${option.name} ì„ íƒ ì™„ë£Œ!`, 3000);
        }
        
        // ğŸ”¥ ìˆ˜ì • ëª¨ë‹¬ìš© ê²€ìƒ‰ í•¨ìˆ˜
        async function searchFoodForEdit() {
            const foodName = document.getElementById('editFoodName').value.trim();
            
            if (!foodName) {
                alert('ê²€ìƒ‰í•  ìŒì‹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const searchBtn = document.querySelector('.search-food-btn-edit');
            searchBtn.disabled = true;
            searchBtn.innerHTML = 'â³ ê²€ìƒ‰ ì¤‘...';
            
            try {
                const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ì˜ì–‘ ë°ì´í„°ë² ì´ìŠ¤ AIì…ë‹ˆë‹¤.
ì‚¬ìš©ìê°€ ê²€ìƒ‰í•œ ìŒì‹: "${foodName}"

ì´ ìŒì‹ì— ëŒ€í•œ ë¸Œëœë“œë³„, ì¢…ë¥˜ë³„ ì˜ì–‘ ì •ë³´ë¥¼ **ìµœëŒ€ 5ê°€ì§€**ë¡œ ì œê³µí•´ì£¼ì„¸ìš”.
ê° í•­ëª©ì€ ë‹¤ìŒ ì •ë³´ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:
- name: ë¸Œëœë“œ/ì¢…ë¥˜ í¬í•¨ ìŒì‹ëª… (ì˜ˆ: "ë†ì‹¬ ì‹ ë¼ë©´ 1ê°œ(120g)")
- serving: 1íšŒ ì œê³µëŸ‰ (ì˜ˆ: "1ê°œ(120g)", "1ê·¸ë¦‡(500g)", "100g")
- calories: ì¹¼ë¡œë¦¬ (kcal)
- carbs: íƒ„ìˆ˜í™”ë¬¼ (g)
- protein: ë‹¨ë°±ì§ˆ (g)
- fat: ì§€ë°© (g)
- per100g: 100gë‹¹ ì˜ì–‘ ì •ë³´ {calories, carbs, protein, fat}

**ë°˜ë“œì‹œ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œë§Œ** ì‘ë‹µí•˜ì„¸ìš”:
[
  {
    "name": "ë¸Œëœë“œ/ì¢…ë¥˜ í¬í•¨ ìŒì‹ëª…",
    "serving": "1íšŒ ì œê³µëŸ‰",
    "calories": ìˆ«ì,
    "carbs": ìˆ«ì,
    "protein": ìˆ«ì,
    "fat": ìˆ«ì,
    "per100g": {
      "calories": ìˆ«ì,
      "carbs": ìˆ«ì,
      "protein": ìˆ«ì,
      "fat": ìˆ«ì
    }
  }
]

ì£¼ì˜:
1. JSON ì™¸ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”
2. ì‹¤ì œ ì˜ì–‘ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•˜ê²Œ ì œê³µí•˜ì„¸ìš”
3. ë¸Œëœë“œëª…ì´ë‚˜ ìƒì„¸ ì¢…ë¥˜ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”
4. per100g ì •ë³´ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”`;

                const response = await callGeminiAPI(prompt);
                const foodOptions = parseFoodSearchResponse(response);
                
                if (foodOptions && foodOptions.length > 0) {
                    displayEditFoodOptions(foodOptions);
                } else {
                    throw new Error('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                console.error('ìŒì‹ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                alert('ìŒì‹ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = 'ğŸ” ê²€ìƒ‰';
            }
        }
        
        function displayEditFoodOptions(options) {
            const container = document.getElementById('editFoodOptionsContainer');
            const resultsDiv = document.getElementById('editFoodSearchResults');
            
            container.innerHTML = options.map((option, index) => `
                <div onclick="selectEditFoodOption(${index})" 
                     style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                     onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateX(5px)';"
                     onmouseout="this.style.borderColor='transparent'; this.style.transform='translateX(0)';">
                    <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                        ${option.name}
                    </div>
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                        ${option.serving}
                    </div>
                    <div style="display: flex; gap: 15px; font-size: 0.85rem; color: #999;">
                        <span>ğŸ”¥ ${option.calories}kcal</span>
                        <span>ğŸš íƒ„${option.carbs}g</span>
                        <span>ğŸ’ª ë‹¨${option.protein}g</span>
                        <span>ğŸ§ˆ ì§€${option.fat}g</span>
                    </div>
                </div>
            `).join('');
            
            resultsDiv.style.display = 'block';
            
            // ê²€ìƒ‰ ê²°ê³¼ ì €ì¥
            window.currentEditFoodOptions = options;
        }
        
        function selectEditFoodOption(index) {
            const option = window.currentEditFoodOptions[index];
            if (!option) return;
            
            // ì…ë ¥ í•„ë“œì— ìë™ ì±„ìš°ê¸°
            document.getElementById('editFoodName').value = option.name;
            document.getElementById('editCalories').value = Math.round(option.calories);
            document.getElementById('editCarbs').value = Math.round(option.carbs);
            document.getElementById('editProtein').value = Math.round(option.protein);
            document.getElementById('editFat').value = Math.round(option.fat);
            
            // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            document.getElementById('editFoodSearchResults').style.display = 'none';
            
            showAIToast(`âœ… ${option.name} ì„ íƒ ì™„ë£Œ!`, 3000);
        }

        function toggleManualInput() {
            const manualFields = document.getElementById('manualInputFields');
            manualFields.classList.toggle('show');

            if (manualFields.classList.contains('show')) {
                // AI ë¶„ì„ ê²°ê³¼ë¥¼ ìˆ˜ë™ ì…ë ¥ í•„ë“œì— ì±„ìš°ê¸°
                if (analyzedNutrition) {
                    document.getElementById('manualCalories').value = Math.round(analyzedNutrition.calories);
                    document.getElementById('manualCarbs').value = Math.round(analyzedNutrition.carbs);
                    document.getElementById('manualProtein').value = Math.round(analyzedNutrition.protein);
                    document.getElementById('manualFat').value = Math.round(analyzedNutrition.fat);
                }
            }
        }

        async function saveMealInput() {
            const foodName = document.getElementById('mealFoodName').value.trim();

            if (!foodName) {
                alert('ìŒì‹ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ìˆ˜ë™ ì…ë ¥ ê°’ í™•ì¸
            const manualFields = document.getElementById('manualInputFields');
            let nutrition;

            if (manualFields.classList.contains('show')) {
                // ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ
                const calories = parseFloat(document.getElementById('manualCalories').value) || 0;
                const carbs = parseFloat(document.getElementById('manualCarbs').value) || 0;
                const protein = parseFloat(document.getElementById('manualProtein').value) || 0;
                const fat = parseFloat(document.getElementById('manualFat').value) || 0;
                
                nutrition = {
                    calories: calories,
                    carbs: carbs,
                    protein: protein,
                    fat: fat,
                    foodName: foodName,
                    advice: `${currentMealType} ì‹ì‚¬ ê¸°ë¡ ì™„ë£Œ!`,
                    // ğŸ”¥ ìˆ˜ë™ ì…ë ¥ì˜ ê²½ìš° ëŒ€ëµì ì¸ 100gë‹¹ ê°’ ì¶”ì •
                    per100g: {
                        calories: Math.round(calories * 0.5),
                        carbs: Math.round(carbs * 0.5),
                        protein: Math.round(protein * 0.5),
                        fat: Math.round(fat * 0.5)
                    }
                };
            } else if (analyzedNutrition) {
                // AI ë¶„ì„ ê²°ê³¼ ì‚¬ìš©
                nutrition = analyzedNutrition;
            } else {
                alert('ì˜ì–‘ ë¶„ì„ì„ ë¨¼ì € ì§„í–‰í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (nutrition.calories === 0) {
                if (!confirm('ì¹¼ë¡œë¦¬ê°€ 0ì…ë‹ˆë‹¤. ê·¸ë˜ë„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }

            try {
                // ğŸ”¥ ìˆ˜ì • ëª¨ë“œ í™•ì¸
                const isEditMode = window.editingMealData && window.editingMealData.index !== undefined;
                
                if (isEditMode) {
                    // ğŸ”¥ ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ ë°ì´í„° ì—…ë°ì´íŠ¸ (ì‹œê°„ ìœ ì§€)
                    const editData = window.editingMealData;
                    const meal = todayIntake.meals[editData.index];
                    
                    if (meal) {
                        // ê¸°ì¡´ ì˜ì–‘ì†Œ ì°¨ê°
                        todayIntake.calories -= (meal.calories || 0);
                        todayIntake.carbs -= (meal.carbs || 0);
                        todayIntake.protein -= (meal.protein || 0);
                        todayIntake.fat -= (meal.fat || 0);
                        
                        // ìƒˆ ì˜ì–‘ ì •ë³´ë¡œ ì—…ë°ì´íŠ¸ (ì‹œê°„ì€ ìœ ì§€)
                        meal.food = foodName;
                        meal.foodName = foodName;
                        meal.name = foodName;
                        meal.calories = nutrition.calories;
                        meal.carbs = nutrition.carbs;
                        meal.protein = nutrition.protein;
                        meal.fat = nutrition.fat;
                        meal.per100g = nutrition.per100g || null; // ğŸ”¥ 100gë‹¹ ì •ë³´ ì €ì¥
                        // meal.timestampëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ (ìˆ˜ì •í•˜ì§€ ì•ŠìŒ)
                        
                        // ìƒˆ ì˜ì–‘ì†Œ ì¶”ê°€
                        todayIntake.calories += nutrition.calories;
                        todayIntake.carbs += nutrition.carbs;
                        todayIntake.protein += nutrition.protein;
                        todayIntake.fat += nutrition.fat;
                        
                        // Firebase ì €ì¥
                        await saveTodayNutritionToFirestore();
                        
                        // ğŸ”¥ ì•¨ë²” íƒ­ ë™ê¸°í™”: photos ì»¬ë ‰ì…˜ ì—…ë°ì´íŠ¸
                        if (editData.originalPhoto) {
                            const photosSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                                .collection('users').doc(currentUser.uid)
                                .collection('photos')
                                .where('url', '==', editData.originalPhoto)
                                .get();
                            
                            photosSnapshot.forEach(async (doc) => {
                                await doc.ref.update({
                                    text: `${currentMealType}: ${foodName}`,
                                    nutrition: nutrition,
                                    food: foodName,
                                    mealType: currentMealType
                                });
                                console.log('âœ… ì•¨ë²” ì‚¬ì§„ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', doc.id);
                            });
                        }
                        
                        // UI ì—…ë°ì´íŠ¸
                        updateNutritionUI();
                        
                        // ìˆ˜ì • ë°ì´í„° ì´ˆê¸°í™”
                        window.editingMealData = null;
                        
                        closeMealInputModal();
                        showAIToast(`âœ… ${currentMealType} ì‹ì‚¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! (ì‹œê°„ ìœ ì§€)`, 3000);
                    }
                } else {
                    // ğŸ”¥ ì‹ ê·œ ë“±ë¡ ëª¨ë“œ
                    const today = new Date();
                    const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                    // photos ì»¬ë ‰ì…˜ì— í…ìŠ¤íŠ¸ ì‹ì‚¬ ê¸°ë¡ ì €ì¥
                    await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(currentUser.uid)
                        .collection('photos').add({
                            category: 'food',
                            text: `${currentMealType}: ${foodName}`,
                            nutrition: nutrition,
                            uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            mealType: currentMealType,
                            food: foodName
                        });

                    // Phase 1: ì‹¤ì‹œê°„ ì˜ì–‘ ì¶”ì ì— ë°˜ì˜
                    addMeal(currentMealType, foodName, nutrition);

                    // ì˜¤ëŠ˜ì˜ ì˜ì–‘ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    await refreshDashboardNutrition();

                    // ëª¨ë‹¬ ë‹«ê¸°
                    closeMealInputModal();

                    showSuccessToast(`${currentMealType} ì‹ì‚¬ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                }

            } catch (error) {
                console.error('ì‹ì‚¬ ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì‹ì‚¬ ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ==================== PWA ê¸°ëŠ¥ ====================
        function initializePWA() {
            // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ê°ì§€
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;

                const installed = localStorage.getItem(LS_KEYS.PWA_INSTALLED);
                if (!installed) {
                    document.getElementById('pwaInstallBanner').classList.remove('hidden');
                }
            });

            // ì„¤ì¹˜ ì™„ë£Œ ê°ì§€
            window.addEventListener('appinstalled', () => {
                localStorage.setItem(LS_KEYS.PWA_INSTALLED, 'true');
                document.getElementById('pwaInstallBanner').classList.add('hidden');
                deferredPrompt = null;
            });
        }

        async function installPWA() {
            if (!deferredPrompt) {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” PWA ì„¤ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                localStorage.setItem(LS_KEYS.PWA_INSTALLED, 'true');
                document.getElementById('pwaInstallBanner').classList.add('hidden');
            }

            deferredPrompt = null;
        }

        // ==================== í”„ë¡œí•„ í†µê³„ ìƒì„¸ ëª¨ë‹¬ ====================
        function showDaysActiveDetail() {
            if (!currentProfile.createdAt) {
                alert('í”„ë¡œí•„ ì •ë³´ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }

            const startDate = currentProfile.createdAt.toDate();
            const today = new Date();
            const diffDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));

            const badges = [];
            if (diffDays >= 30) badges.push('ğŸ† 30ì¼ ë‹¬ì„±!');
            if (diffDays >= 100) badges.push('ğŸ† 100ì¼ ë‹¬ì„±!');
            if (diffDays >= 365) badges.push('ğŸ† 365ì¼ ë‹¬ì„±!');

            const modal = document.createElement('div');
            modal.className = 'day-report-modal';
            modal.innerHTML = `
                <div class="day-report-content" style="max-width: 400px;">
                    <div class="day-report-header">ğŸ—“ï¸ í•¨ê»˜í•œ ë‚ </div>
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="font-size: 3rem; font-weight: bold; color: #667eea;">${diffDays}ì¼</div>
                        <p style="margin-top: 10px; color: #666;">ì‹œì‘ì¼: ${startDate.toLocaleDateString('ko-KR')}</p>
                        <p style="margin-top: 20px; line-height: 1.6; color: #555;">
                            ${diffDays}ì¼ ë™ì•ˆ ì—´ì‹¬íˆ ë…¸ë ¥í•˜ì…¨ì–´ìš”! ğŸ‘
                        </p>
                        ${badges.length > 0 ? `
                            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px;">
                                ${badges.map(b => `<div style="margin: 5px 0; font-weight: bold;">${b}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <button class="modal-btn modal-btn-primary" onclick="this.closest('.day-report-modal').remove()">ë‹«ê¸°</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function showExerciseTimeDetail() {
            try {
                // dailyLogsì—ì„œ ëª¨ë“  ìš´ë™ ë°ì´í„° ìˆ˜ì§‘
                const logsSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').get();

                const exerciseBreakdown = {};
                let totalMinutes = 0;

                logsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.exercises && data.exercises.length > 0) {
                        data.exercises.forEach(ex => {
                            if (!exerciseBreakdown[ex.name]) {
                                exerciseBreakdown[ex.name] = 0;
                            }
                            exerciseBreakdown[ex.name] += ex.duration || 0;
                            totalMinutes += ex.duration || 0;
                        });
                    }
                });

                const totalHours = Math.floor(totalMinutes / 60);
                const remainingMinutes = totalMinutes % 60;

                const sortedExercises = Object.entries(exerciseBreakdown)
                    .sort((a, b) => b[1] - a[1]);

                const modal = document.createElement('div');
                modal.className = 'day-report-modal';
                modal.innerHTML = `
                    <div class="day-report-content" style="max-width: 400px;">
                        <div class="day-report-header">ğŸ’ª ì´ ìš´ë™ ì‹œê°„</div>
                        <div style="text-align: center; margin: 30px 0;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #667eea;">
                                ${totalHours}ì‹œê°„ ${remainingMinutes}ë¶„
                            </div>
                            <p style="margin-top: 5px; color: #999; font-size: 0.9rem;">ì´ ${totalMinutes}ë¶„</p>
                        </div>
                        ${sortedExercises.length > 0 ? `
                            <div style="margin-top: 20px;">
                                <h4 style="margin-bottom: 15px; color: #333;">ìš´ë™ë³„ ëˆ„ì  ì‹œê°„:</h4>
                                ${sortedExercises.map(([name, minutes]) => `
                                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                                        <span style="font-weight: 600;">${name}</span>
                                        <span style="color: #667eea;">${Math.floor(minutes / 60)}ì‹œê°„ ${minutes % 60}ë¶„</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="text-align: center; color: #999;">ì•„ì§ ìš´ë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                        ${totalMinutes >= 360 ? '<div style="margin-top: 20px; padding: 12px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; text-align: center; font-weight: bold; color: #2e7d32;">ğŸ† 6ì‹œê°„ ì´ìƒ ìš´ë™ ë‹¬ì„±!</div>' : ''}
                        <button class="modal-btn modal-btn-primary" onclick="this.closest('.day-report-modal').remove()">ë‹«ê¸°</button>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('ìš´ë™ ì‹œê°„ ì¡°íšŒ ì‹¤íŒ¨:', error);
                alert('ìš´ë™ ì‹œê°„ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function showCalorieSavingsDetail() {
            try {
                // dailyLogsì—ì„œ ì˜ì–‘ ë°ì´í„° ìˆ˜ì§‘
                const logsSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').get();

                const dailyTarget = currentProfile.recommendedCalories || 2400;
                let totalSaved = 0;
                let totalOverage = 0;
                let daysCount = 0;

                logsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nutrition && data.nutrition.calories) {
                        daysCount++;
                        const diff = dailyTarget - data.nutrition.calories;
                        if (diff > 0) {
                            totalSaved += diff;
                        } else {
                            totalOverage += Math.abs(diff);
                        }
                    }
                });

                const netSavings = totalSaved - totalOverage;
                const avgDailySavings = daysCount > 0 ? Math.round(netSavings / daysCount) : 0;

                const modal = document.createElement('div');
                modal.className = 'day-report-modal';
                modal.innerHTML = `
                    <div class="day-report-content" style="max-width: 400px;">
                        <div class="day-report-header">ğŸ”¥ ì ˆì•½ ì¹¼ë¡œë¦¬</div>
                        <div style="text-align: center; margin: 30px 0;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: ${netSavings >= 0 ? '#4caf50' : '#ff5252'};">
                                ${netSavings >= 0 ? '' : '+'}${Math.abs(netSavings).toLocaleString()}kcal
                            </div>
                        </div>
                        ${netSavings >= 0 ? `
                            <div style="padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; margin-bottom: 20px;">
                                <p style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">âœ… ëª©í‘œë³´ë‹¤ ${netSavings.toLocaleString()}kcal ëœ ì„­ì·¨í–ˆì–´ìš”!</p>
                                <p style="font-size: 0.9rem; color: #555;">ì´ëŒ€ë¡œë§Œ ê³„ì†í•˜ë©´ ëª©í‘œ ë‹¬ì„±ì´ ê°€ê¹Œì›Œìš”! ğŸ’ª</p>
                            </div>
                        ` : `
                            <div style="padding: 15px; background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-radius: 12px; margin-bottom: 20px;">
                                <p style="font-weight: bold; color: #c62828; margin-bottom: 5px;">âš ï¸ ëª©í‘œë³´ë‹¤ ${Math.abs(netSavings).toLocaleString()}kcal ë” ì„­ì·¨í–ˆì–´ìš”</p>
                                <p style="font-size: 0.9rem; color: #555;">ì¡°ê¸ˆë§Œ ë” ì ˆì œí•˜ë©´ ì¢‹ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì–´ìš”!</p>
                            </div>
                        `}
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>ì´ ì ˆì•½:</span>
                                <span style="color: #4caf50; font-weight: bold;">${totalSaved.toLocaleString()}kcal</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>ì´ ì´ˆê³¼:</span>
                                <span style="color: #ff5252; font-weight: bold;">+${totalOverage.toLocaleString()}kcal</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold; padding-top: 10px; border-top: 2px solid #e0e0e0;">
                                <span>ìˆœ ì ˆì•½:</span>
                                <span style="color: ${netSavings >= 0 ? '#4caf50' : '#ff5252'};">${netSavings.toLocaleString()}kcal</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem; color: #666;">
                                <span>ì¼í‰ê· :</span>
                                <span>${avgDailySavings.toLocaleString()}kcal</span>
                            </div>
                        </div>
                        <button class="modal-btn modal-btn-primary" style="margin-top: 20px;" onclick="this.closest('.day-report-modal').remove()">ë‹«ê¸°</button>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('ì¹¼ë¡œë¦¬ ì¡°íšŒ ì‹¤íŒ¨:', error);
                alert('ì¹¼ë¡œë¦¬ ì ˆì•½ëŸ‰ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function showExpectedCompletionDetail() {
            if (!currentProfile.goalWeight) {
                alert('ëª©í‘œ ì²´ì¤‘ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // ìµœê·¼ 30ì¼ ì²´ì¤‘ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const weightsSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
                    .orderBy('date', 'desc')
                    .get();

                if (weightsSnapshot.empty) {
                    alert('ì²´ì¤‘ ê¸°ë¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 2ê°œ ì´ìƒì˜ ì²´ì¤‘ ê¸°ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                const weights = [];
                weightsSnapshot.forEach(doc => {
                    const data = doc.data();
                    weights.push({
                        date: data.date.toDate(),
                        weight: data.weight
                    });
                });

                weights.reverse(); // ì˜¤ë˜ëœ ìˆœìœ¼ë¡œ ì •ë ¬

                if (weights.length < 2) {
                    alert('ì²´ì¤‘ ê¸°ë¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ìµœì†Œ 2ê°œ ì´ìƒì˜ ì²´ì¤‘ ê¸°ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                // í‰ê·  ì£¼ê°„ ê°ëŸ‰ ì†ë„ ê³„ì‚°
                const firstWeight = weights[0].weight;
                const lastWeight = weights[weights.length - 1].weight;
                const daysDiff = (weights[weights.length - 1].date - weights[0].date) / (1000 * 60 * 60 * 24);
                const totalLoss = firstWeight - lastWeight;
                const weeklyLoss = (totalLoss / daysDiff) * 7;

                const currentWeight = lastWeight;
                const goalWeight = currentProfile.goalWeight;
                const remainingWeight = currentWeight - goalWeight;

                if (weeklyLoss <= 0) {
                    const modal = document.createElement('div');
                    modal.className = 'day-report-modal';
                    modal.innerHTML = `
                        <div class="day-report-content" style="max-width: 400px;">
                            <div class="day-report-header">ğŸ“… ì˜ˆìƒ ë‹¬ì„±ì¼</div>
                            <div style="text-align: center; margin: 30px 0;">
                                <p style="font-size: 1.2rem; color: #ff5252; font-weight: bold;">âš ï¸ í˜„ì¬ ì²´ì¤‘ì´ ì¦ê°€ ì¤‘ì´ê±°ë‚˜ ë³€í™”ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                <p style="margin-top: 20px; color: #666; line-height: 1.6;">
                                    ì²´ì¤‘ ê°ëŸ‰ì„ ìœ„í•´ ì‹ë‹¨ ì¡°ì ˆê³¼ ìš´ë™ì„ ì‹œì‘í•´ë³´ì„¸ìš”!
                                </p>
                            </div>
                            <button class="modal-btn modal-btn-primary" onclick="this.closest('.day-report-modal').remove()">ë‹«ê¸°</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    return;
                }

                const weeksNeeded = Math.ceil(remainingWeight / weeklyLoss);
                const daysNeeded = weeksNeeded * 7;

                const expectedDate = new Date();
                expectedDate.setDate(expectedDate.getDate() + daysNeeded);

                const originalGoalDate = currentProfile.targetDate ? currentProfile.targetDate.toDate() : null;
                let daysDifference = 0;
                if (originalGoalDate) {
                    daysDifference = Math.ceil((expectedDate - originalGoalDate) / (1000 * 60 * 60 * 24));
                }

                const modal = document.createElement('div');
                modal.className = 'day-report-modal';
                modal.innerHTML = `
                    <div class="day-report-content" style="max-width: 400px;">
                        <div class="day-report-header">ğŸ“… ì˜ˆìƒ ë‹¬ì„±ì¼</div>
                        <div style="text-align: center; margin: 30px 0;">
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea;">${expectedDate.toLocaleDateString('ko-KR')}</div>
                            <p style="margin-top: 10px; color: #999; font-size: 0.9rem;">ì•½ ${daysNeeded}ì¼ í›„</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                            <p style="margin-bottom: 10px;"><strong>ìµœê·¼ ê°ëŸ‰ ì†ë„:</strong> ì£¼ë‹¹ ${weeklyLoss.toFixed(2)}kg</p>
                            ${originalGoalDate ? `<p><strong>ì›ë˜ ëª©í‘œì¼:</strong> ${originalGoalDate.toLocaleDateString('ko-KR')}</p>` : ''}
                        </div>
                        ${originalGoalDate ? (daysDifference < 0 ? `
                            <div style="padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px;">
                                <p style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">ğŸ‰ ëª©í‘œì¼ë³´ë‹¤ ${Math.abs(daysDifference)}ì¼ ë¹¨ë¼ìš”!</p>
                                <p style="font-size: 0.9rem; color: #555;">í˜„ì¬ í˜ì´ìŠ¤ê°€ ì™„ë²½í•´ìš”! ì´ëŒ€ë¡œë§Œ ê°€ë©´ ëª©í‘œë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆì–´ìš”!</p>
                            </div>
                        ` : daysDifference > 0 ? `
                            <div style="padding: 15px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px;">
                                <p style="font-weight: bold; color: #e65100; margin-bottom: 5px;">âš ï¸ ëª©í‘œì¼ë³´ë‹¤ ${daysDifference}ì¼ ëŠ¦ì„ ê²ƒ ê°™ì•„ìš”</p>
                                <p style="font-size: 0.9rem; color: #555;">ì¡°ê¸ˆ ë” ë…¸ë ¥í•˜ë©´ ëª©í‘œì¼ì— ë§ì¶œ ìˆ˜ ìˆì–´ìš”!</p>
                            </div>
                        ` : `
                            <div style="padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px;">
                                <p style="font-weight: bold; color: #2e7d32;">âœ… ëª©í‘œì¼ì— ì •í™•íˆ ë§ì¶°ê°€ê³  ìˆì–´ìš”!</p>
                            </div>
                        `) : ''}
                        <button class="modal-btn modal-btn-primary" style="margin-top: 20px;" onclick="this.closest('.day-report-modal').remove()">ë‹«ê¸°</button>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('ì˜ˆìƒ ë‹¬ì„±ì¼ ê³„ì‚° ì‹¤íŒ¨:', error);
                alert('ì˜ˆìƒ ë‹¬ì„±ì¼ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ==================== í”„ë¡œí•„ ì¬ì„¤ì • (ì˜¨ë³´ë”© ìŠ¤íƒ€ì¼) ====================
        function openProfileOnboarding() {
            if (!confirm('í”„ë¡œí•„ì„ ë‹¤ì‹œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê¸°ì¡´ ì‹ë‹¨ ê¸°ë¡ì€ ìœ ì§€ë©ë‹ˆë‹¤.')) {
                return;
            }
            
            // ğŸ”¥ ì™„ì „íˆ ì²˜ìŒë¶€í„° ì‹œì‘ (ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”)
            obData = {
                name: '',
                age: 26,
                gender: '',
                height: 170,
                currentWeight: 70,
                goalWeight: 65,
                activityLevel: 'moderate',
                targetDate: null,
                lossRate: 0.5
            };
            
            // ìŠ¬ë¼ì´ë” ìƒíƒœë„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
            sliderState.height.value = 170;
            sliderState.currentWeight.value = 70;
            sliderState.goalWeight.value = 65;
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            const nameInput = document.getElementById('obName');
            if (nameInput) nameInput.value = '';
            
            // ğŸ”¥ ì²˜ìŒ ë¡œê·¸ì¸ ì‹œì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì˜¨ë³´ë”© ì—´ê¸°
            const onboarding = document.getElementById('fullscreenOnboarding');
            onboarding.classList.add('show');
            onboarding.style.cssText = `
                display: flex !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: #ffffff !important;
                z-index: 2147483647 !important;
                flex-direction: column !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            document.body.style.overflow = 'hidden';
            
            // Step 1ë¶€í„° ì‹œì‘
            obCurrentStep = 1;
            showObStep(1);
            updateObProgress();
            
            console.log('ğŸ”„ í”„ë¡œí•„ ì¬ì„¤ì • ì˜¨ë³´ë”© ì‹œì‘ (ì²˜ìŒ ë¡œê·¸ì¸ê³¼ ë™ì¼)');
        }
        
        // ê¸°ì¡´ í”„ë¡œí•„ ì„¤ì • ëª¨ë‹¬ (ë°±ì—…ìš©)
        function openProfileSettings() {
            const modal = document.getElementById('profileSettingsModal');

            // ëª¨ë“  ì…ë ¥ í•„ë“œë¥¼ ê³µë°±ìœ¼ë¡œ ì´ˆê¸°í™”
            document.getElementById('editName').value = '';
            document.getElementById('editStartWeight').value = '';
            document.getElementById('editGoalWeight').value = '';
            document.getElementById('editAge').value = '';
            document.getElementById('editHeight').value = '';
            document.getElementById('editGender').value = '';
            document.getElementById('editTargetDate').value = '';
            document.getElementById('editActivityLevel').value = 'sedentary';
            document.getElementById('editGoal').value = 'lose';

            modal.classList.remove('hidden');
        }

        function closeProfileSettings() {
            document.getElementById('profileSettingsModal').classList.add('hidden');
        }

        async function saveProfileSettings() {
            const name = document.getElementById('editName').value.trim();
            const startWeight = parseFloat(document.getElementById('editStartWeight').value);
            const goalWeight = parseFloat(document.getElementById('editGoalWeight').value);
            const age = parseInt(document.getElementById('editAge').value) || currentProfile.age || null;
            const height = parseFloat(document.getElementById('editHeight').value) || currentProfile.height || null;
            const gender = document.getElementById('editGender').value || currentProfile.gender || null;
            const targetDateStr = document.getElementById('editTargetDate').value;
            const targetDate = targetDateStr ? firebase.firestore.Timestamp.fromDate(new Date(targetDateStr)) : currentProfile.targetDate;
            const activityLevel = document.getElementById('editActivityLevel').value || currentProfile.activityLevel || 'light';
            const goal = document.getElementById('editGoal').value || currentProfile.goal || 'lose';
            
            console.log('=== í”„ë¡œí•„ ì €ì¥ ì‹œì‘ (ê¸°ë¡ ìœ ì§€) ===');
            console.log('name:', name);
            console.log('startWeight:', startWeight);
            console.log('goalWeight:', goalWeight);
            console.log('targetDate:', targetDate);
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!name) {
                alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!startWeight || startWeight <= 0) {
                alert('ì‹œì‘ ì²´ì¤‘ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!goalWeight || goalWeight <= 0) {
                alert('ëª©í‘œ ì²´ì¤‘ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // ========== ê³¼í•™ì  ì¹¼ë¡œë¦¬ ê³„ì‚° (v3.3.0) ==========
                let calculatedCalories = null;
                let calculatedMacros = null;
                let bmr = null;
                let tdee = null;
                
                if (age && height && gender && goalWeight && startWeight) {
                    // ì£¼ê°„ ê°ëŸ‰ ëª©í‘œ ê³„ì‚°
                    const weightDiff = startWeight - goalWeight; // ê°ëŸ‰í•  ì²´ì¤‘ (kg)
                    const daysRemaining = targetDate ? Math.max(1, Math.round((targetDate.toDate() - new Date()) / (1000 * 60 * 60 * 24))) : 90;
                    const weeksRemaining = Math.max(1, daysRemaining / 7);
                    const weeklyGoalKg = weightDiff / weeksRemaining; // ì£¼ë‹¹ ê°ëŸ‰ ëª©í‘œ
                    
                    // í˜„ì¬ ì²´ì¤‘ìœ¼ë¡œ ê³„ì‚° (ì‹œì‘ ì²´ì¤‘ ëŒ€ì‹ )
                    const currentWeight = startWeight; // TODO: ìµœì‹  ì²´ì¤‘ ê¸°ë¡ ì‚¬ìš©
                    
                    const nutritionPlan = generateNutritionPlan({
                        gender: gender,
                        weight: currentWeight,
                        height: height,
                        age: age,
                        activityLevel: activityLevel,
                        weeklyGoalKg: weeklyGoalKg,
                        goal: goal
                    });
                    
                    calculatedCalories = nutritionPlan.dailyCalories;
                    calculatedMacros = nutritionPlan.macros;
                    bmr = nutritionPlan.bmr;
                    tdee = nutritionPlan.tdee;
                    
                    console.log('ğŸ“Š ê³¼í•™ì  ì¹¼ë¡œë¦¬ ê³„ì‚° ì™„ë£Œ:', {
                        bmr: bmr,
                        tdee: tdee,
                        weeklyGoalKg: weeklyGoalKg.toFixed(2) + 'kg/ì£¼',
                        dailyCalories: calculatedCalories,
                        macros: calculatedMacros
                    });
                    
                    // localStorageì—ë„ ì €ì¥
                    localStorage.setItem('goal_calories_target', calculatedCalories);
                    localStorage.setItem('goal_carbs_target', calculatedMacros.carbs);
                    localStorage.setItem('goal_protein_target', calculatedMacros.protein);
                    localStorage.setItem('goal_fat_target', calculatedMacros.fat);
                }
                
                // âœ… í”„ë¡œí•„ ì •ë³´ë§Œ ì—…ë°ì´íŠ¸ (ê¸°ë¡ì€ ìœ ì§€)
                await db.collection('artifacts')
                    .doc('diet-mate-v2')
                    .collection('users')
                    .doc(currentUser.uid)
                    .set({
                        name: name,
                        startWeight: startWeight,
                        goalWeight: goalWeight,
                        age: age,
                        height: height,
                        gender: gender,
                        targetDate: targetDate,
                        activityLevel: activityLevel,
                        goal: goal,
                        calculatedCalories: calculatedCalories,
                        calculatedMacros: calculatedMacros,
                        bmr: bmr,
                        tdee: tdee,
                        email: currentUser.email,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                
                console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ (ê¸°ë¡ ìœ ì§€)');
                
                // ë¡œì»¬ í”„ë¡œí•„ ì™„ì „íˆ ì—…ë°ì´íŠ¸
                currentProfile.name = name;
                currentProfile.startWeight = startWeight;
                currentProfile.goalWeight = goalWeight;
                currentProfile.age = age;
                currentProfile.height = height;
                currentProfile.gender = gender;
                currentProfile.targetDate = targetDate;
                currentProfile.activityLevel = activityLevel;
                currentProfile.goal = goal;
                
                console.log('âœ… ë¡œì»¬ í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', currentProfile);
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('headerSubtitle').textContent = `${name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
                document.getElementById('profileName').textContent = name;
                
                // ëª¨ë‹¬ ë‹«ê¸°
                closeProfileSettings();
                
                // ì„±ê³µ ë©”ì‹œì§€ (ê³¼í•™ì  ì¹¼ë¡œë¦¬ í¬í•¨)
                let successMsg = 'âœ… í”„ë¡œí•„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!\nê¸°ì¡´ ê¸°ë¡ì€ ëª¨ë‘ ìœ ì§€ë©ë‹ˆë‹¤.';
                if (calculatedCalories) {
                    successMsg += `\n\nğŸ“Š ê³¼í•™ì  ì¹¼ë¡œë¦¬ ê³„ì‚° ê²°ê³¼:\n`;
                    successMsg += `â€¢ ì¼ì¼ ê¶Œì¥ ì¹¼ë¡œë¦¬: ${calculatedCalories}kcal\n`;
                    successMsg += `â€¢ íƒ„ìˆ˜í™”ë¬¼: ${calculatedMacros.carbs}g\n`;
                    successMsg += `â€¢ ë‹¨ë°±ì§ˆ: ${calculatedMacros.protein}g\n`;
                    successMsg += `â€¢ ì§€ë°©: ${calculatedMacros.fat}g`;
                }
                alert(successMsg);
                
                // í™ˆ íƒ­ ê°•ì œ ìƒˆë¡œê³ ì¹¨
                await loadHomeTab();
                
                // ì„¤ì • íƒ­ë„ ìƒˆë¡œê³ ì¹¨ (í˜„ì¬ ì„¤ì • íƒ­ì´ë©´)
                if (currentTab === 'settings') {
                    await loadSettings();
                }
                
            } catch (error) {
                console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                alert('âŒ í”„ë¡œí•„ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ==================== ì „ì²´ ì´ˆê¸°í™” ====================
        function openFullReset() {
            if (!confirm('âš ï¸ ê²½ê³ : ì „ì²´ ì´ˆê¸°í™”ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\n\në‹¤ìŒ ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤:\n- ëª¨ë“  ì²´ì¤‘ ê¸°ë¡\n- ëª¨ë“  ë‹¨ì‹ ê¸°ë¡\n- ëª¨ë“  ì‹ì‚¬/ì•¨ë²” ê¸°ë¡\n- í”„ë¡œí•„ ì •ë³´\n\nì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            if (!confirm('ğŸ”¥ ìµœì¢… í™•ì¸: ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
                return;
            }

            performFullReset();
        }

        async function performFullReset() {
            try {
                const userRef = db.collection('artifacts')
                    .doc('diet-mate-v2')
                    .collection('users')
                    .doc(currentUser.uid);

                console.log('ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™” ì‹œì‘...');

                // 1. logs ì»¬ë ‰ì…˜ ì‚­ì œ
                const logsSnapshot = await userRef.collection('logs').get();
                const logsBatch = db.batch();
                logsSnapshot.docs.forEach(doc => logsBatch.delete(doc.ref));
                await logsBatch.commit();
                console.log(`âœ… logs ì‚­ì œ: ${logsSnapshot.size}ê±´`);

                // 2. fastingRecords ì»¬ë ‰ì…˜ ì‚­ì œ
                const fastingSnapshot = await userRef.collection('fastingRecords').get();
                const fastingBatch = db.batch();
                fastingSnapshot.docs.forEach(doc => fastingBatch.delete(doc.ref));
                await fastingBatch.commit();
                console.log(`âœ… fastingRecords ì‚­ì œ: ${fastingSnapshot.size}ê±´`);

                // 3. albums ì»¬ë ‰ì…˜ ì‚­ì œ
                const albumsSnapshot = await userRef.collection('albums').get();
                const albumsBatch = db.batch();
                albumsSnapshot.docs.forEach(doc => albumsBatch.delete(doc.ref));
                await albumsBatch.commit();
                console.log(`âœ… albums ì‚­ì œ: ${albumsSnapshot.size}ê±´`);

                // 4. photos ì»¬ë ‰ì…˜ ì‚­ì œ
                const photosSnapshot = await userRef.collection('photos').get();
                const photosBatch = db.batch();
                photosSnapshot.docs.forEach(doc => photosBatch.delete(doc.ref));
                await photosBatch.commit();
                console.log(`âœ… photos ì‚­ì œ: ${photosSnapshot.size}ê±´`);

                // 5. dailyLogs ì»¬ë ‰ì…˜ ì‚­ì œ
                const dailyLogsSnapshot = await userRef.collection('dailyLogs').get();
                const dailyLogsBatch = db.batch();
                dailyLogsSnapshot.docs.forEach(doc => dailyLogsBatch.delete(doc.ref));
                await dailyLogsBatch.commit();
                console.log(`âœ… dailyLogs ì‚­ì œ: ${dailyLogsSnapshot.size}ê±´`);

                // 6. dailyPlans ì»¬ë ‰ì…˜ ì‚­ì œ
                const dailyPlansSnapshot = await userRef.collection('dailyPlans').get();
                const dailyPlansBatch = db.batch();
                dailyPlansSnapshot.docs.forEach(doc => dailyPlansBatch.delete(doc.ref));
                await dailyPlansBatch.commit();
                console.log(`âœ… dailyPlans ì‚­ì œ: ${dailyPlansSnapshot.size}ê±´`);

                // 7. dailyNutrition ì»¬ë ‰ì…˜ ì‚­ì œ
                const dailyNutritionSnapshot = await userRef.collection('dailyNutrition').get();
                const dailyNutritionBatch = db.batch();
                dailyNutritionSnapshot.docs.forEach(doc => dailyNutritionBatch.delete(doc.ref));
                await dailyNutritionBatch.commit();
                console.log(`âœ… dailyNutrition ì‚­ì œ: ${dailyNutritionSnapshot.size}ê±´`);

                // 8. í”„ë¡œí•„ ë¬¸ì„œ ì‚­ì œ
                await userRef.delete();
                console.log('âœ… í”„ë¡œí•„ ì‚­ì œ ì™„ë£Œ');

                // 9. Firebase Auth displayName ì´ˆê¸°í™”
                await currentUser.updateProfile({
                    displayName: '',  // âœ… ìˆ˜ì •: null â†’ '' (ë¹ˆ ë¬¸ìì—´)
                    photoURL: null
                });
                console.log('âœ… Firebase Auth displayName ì´ˆê¸°í™”');

                // 10. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”
                localStorage.clear();
                console.log('âœ… ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”');

                alert('âœ… ì „ì²´ ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');

                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                window.location.reload();

            } catch (error) {
                console.error('ì „ì²´ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                alert('âŒ ì „ì²´ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ==================== ğŸš¨ ê¸´ê¸‰ ì™„ì „ ì´ˆê¸°í™” ====================
        async function emergencyReset() {
            const confirmText = 'ğŸ—‘ï¸ ê¸´ê¸‰ ì™„ì „ ì´ˆê¸°í™”\n\nğŸ“Œ ìœ ì§€ë˜ëŠ” ê²ƒ:\nâ€¢ ë¡œê·¸ì¸ ê³„ì • (ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸)\n\nğŸ—‘ï¸ ì‚­ì œë˜ëŠ” ê²ƒ:\nâ€¢ í”„ë¡œí•„ ì •ë³´ (ì´ë¦„, í‚¤, ëª¸ë¬´ê²Œ ë“±)\nâ€¢ ëª¨ë“  ì‹ë‹¨ ê¸°ë¡\nâ€¢ ì²´ì¤‘ ê¸°ë¡\nâ€¢ ë‹¨ì‹ ê¸°ë¡\nâ€¢ ì•¨ë²” ì‚¬ì§„\nâ€¢ ëª¨ë“  ì„¤ì •\n\nâš ï¸ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!\nì •ë§ë¡œ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            if (!confirm(confirmText)) {
                return;
            }

            try {
                const userRef = db.collection('artifacts')
                    .doc('diet-mate-v2')
                    .collection('users')
                    .doc(currentUser.uid);

                console.log('ğŸš¨ ê¸´ê¸‰ ì™„ì „ ì´ˆê¸°í™” ì‹œì‘...');

                // 1. ëª¨ë“  ì„œë¸Œì»¬ë ‰ì…˜ ì‚­ì œ
                const collections = ['logs', 'fastingRecords', 'albums', 'photos', 'dailyLogs', 'dailyPlans', 'dailyNutrition'];
                
                for (const collectionName of collections) {
                    const snapshot = await userRef.collection(collectionName).get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    console.log('âœ… ' + collectionName + ' ì‚­ì œ: ' + snapshot.size + 'ê±´');
                }

                // 1-1. profile/main (ì˜›ë‚  ë°ì´í„°) ì‚­ì œ
                try {
                    const oldProfileSnapshot = await userRef.collection('profile').get();
                    const oldProfileBatch = db.batch();
                    oldProfileSnapshot.docs.forEach(doc => oldProfileBatch.delete(doc.ref));
                    await oldProfileBatch.commit();
                    console.log('âœ… profile/main (ì˜›ë‚  ë°ì´í„°) ì‚­ì œ: ' + oldProfileSnapshot.size + 'ê±´');
                } catch (err) {
                    console.warn('profile/main ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œ):', err);
                }

                // 2. í”„ë¡œí•„ ë¬¸ì„œ ì‚­ì œ
                await userRef.delete();
                console.log('âœ… í”„ë¡œí•„ ì‚­ì œ ì™„ë£Œ');

                // 3. Firebase Auth displayName ì™„ì „ ì œê±°
                await auth.currentUser.updateProfile({
                    displayName: '',
                    photoURL: null
                });
                console.log('âœ… Firebase Auth displayName ì‚­ì œ');

                // 4. localStorage ì™„ì „ ì‚­ì œ
                localStorage.clear();
                sessionStorage.clear();
                console.log('âœ… localStorage & sessionStorage ì‚­ì œ');

                // 5. IndexedDB ì‚­ì œ
                try {
                    const dbs = await indexedDB.databases();
                    for (const db of dbs) {
                        indexedDB.deleteDatabase(db.name);
                        console.log('âœ… IndexedDB ì‚­ì œ: ' + db.name);
                    }
                } catch (err) {
                    console.warn('IndexedDB ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œ):', err);
                }

                // 6. Service Worker ìºì‹œ ì‚­ì œ (ê°€ëŠ¥í•˜ë©´)
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        console.log('âœ… ìºì‹œ ì‚­ì œ: ' + cacheName);
                    }
                }

                // 7. ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                const successText = 'âœ… ê¸´ê¸‰ ì™„ì „ ì´ˆê¸°í™” ì™„ë£Œ!\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.\nì´ˆê¸°í™” í›„ ë‹‰ë„¤ì„ì´ ê²ŒìŠ¤íŠ¸ë¡œ í‘œì‹œë˜ì–´ì•¼ ì •ìƒì…ë‹ˆë‹¤.';
                alert(successText);

                // 8. ğŸ”¥ ê°•ì œ ë¡œê·¸ì•„ì›ƒ í›„ ìƒˆë¡œê³ ì¹¨ (ìë™ ë³µêµ¬ ë°©ì§€)
                await auth.signOut();
                
                // 9. ğŸ”¥ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ê°•ì œ ìºì‹œ ë¬´íš¨í™” ë²„ì „ íŒŒë¼ë¯¸í„° ì¶”ê°€)
                const cacheBuster = 'v=' + Date.now();
                window.location.href = window.location.origin + window.location.pathname + '?' + cacheBuster;

            } catch (error) {
                console.error('ğŸš¨ ê¸´ê¸‰ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                const errText1 = 'âŒ ê¸´ê¸‰ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                const errText2 = 'F12 Consoleì„ í™•ì¸í•˜ê±°ë‚˜ ë¸Œë¼ìš°ì €ë¥¼ ì¬ì‹œì‘í•´ ì£¼ì„¸ìš”.';
                const fullErrText = errText1 + '\n\n' + errText2;
                alert(fullErrText);
            }
        }
    </script>
    <!-- AI í† ìŠ¤íŠ¸ íŒì—… -->
    <div id="aiToast" class="ai-toast hidden">
        <div class="ai-toast-content">
            <div class="ai-toast-icon">ğŸ¤–</div>
            <div class="ai-toast-message" id="aiToastMessage">AI ì½”ì¹˜ê°€ ë¶„ì„ ì¤‘ì´ì—ìš”...</div>
        </div>
        <button class="ai-toast-button" onclick="openAIChatFromToast()">
            ì½”ì¹˜ì—ê²Œ ì§ˆë¬¸í•˜ê¸°
        </button>
    </div>

    <!-- ìŠ¤ë§ˆíŠ¸ ë³‘í•© Bottom Sheet -->
    <div id="mergeBottomSheet" class="merge-overlay hidden">
        <div class="merge-sheet">
            <div class="merge-header">
                <h3>ğŸ¤” ì´ì „ ì‹ì‚¬ì™€ í•©ì¹ ê¹Œìš”?</h3>
                <p class="merge-subtitle">3ì‹œê°„ ì´ë‚´ì— ë¹„ìŠ·í•œ ì‹ì‚¬ê°€ ìˆì–´ìš”</p>
            </div>
            <div class="merge-content">
                <div class="merge-preview">
                    <div class="merge-meal previous-meal">
                        <div class="meal-label">ì´ì „ ì‹ì‚¬</div>
                        <div class="meal-name" id="previousMealName">-</div>
                        <div class="meal-calories" id="previousMealCal">0kcal</div>
                    </div>
                    <div class="merge-plus">+</div>
                    <div class="merge-meal current-meal">
                        <div class="meal-label">ë°©ê¸ˆ ì¶”ê°€í•œ ì‹ì‚¬</div>
                        <div class="meal-name" id="currentMealName">-</div>
                        <div class="meal-calories" id="currentMealCal">0kcal</div>
                    </div>
                </div>
                <div class="merge-total">
                    <span>í•©ê³„:</span>
                    <span id="mergeTotal" class="total-calories">0kcal</span>
                </div>
            </div>
            <div class="merge-actions">
                <button class="merge-btn merge-confirm" onclick="confirmMerge()">
                    í•©ì¹˜ê¸°
                </button>
                <button class="merge-btn merge-cancel" onclick="createNewMeal()">
                    ë”°ë¡œ ì €ì¥
                </button>
            </div>
        </div>
    </div>

    <!-- Phase 4: ì¹´í…Œê³ ë¦¬ ë³€ê²½ ëª¨ë‹¬ -->
    <div class="category-change-overlay hidden" id="categoryChangeOverlay" onclick="closeCategoryModal()">
        <div class="category-change-modal" onclick="event.stopPropagation()">
            <div class="category-modal-header">
                <h3>ì¹´í…Œê³ ë¦¬ ë³€ê²½</h3>
                <button class="modal-close-btn" onclick="closeCategoryModal()">Ã—</button>
            </div>
            <div class="category-modal-content">
                <p class="category-modal-description">ì´ í•­ëª©ì„ ì–´ëŠ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div class="category-options" id="categoryOptions">
                    <button class="category-option" data-category="body" onclick="changeCategoryConfirm('body')">
                        <span class="category-emoji">ğŸ’ª</span>
                        <span class="category-name">ëˆˆë°”ë””</span>
                    </button>
                    <button class="category-option" data-category="food" onclick="changeCategoryConfirm('food')">
                        <span class="category-emoji">ğŸ½ï¸</span>
                        <span class="category-name">ì‹ë‹¨</span>
                    </button>
                    <button class="category-option" data-category="exercise" onclick="changeCategoryConfirm('exercise')">
                        <span class="category-emoji">ğŸƒâ€â™‚ï¸</span>
                        <span class="category-name">ìš´ë™</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 4: ìˆ˜ë™ ë³‘í•© - ì‹ì‚¬ ì„ íƒ ëª¨ë‹¬ -->
    <div class="manual-merge-overlay hidden" id="manualMergeOverlay" onclick="closeManualMergeModal()">
        <div class="manual-merge-sheet" onclick="event.stopPropagation()">
            <div class="manual-merge-header">
                <h3>ì´ì „ ì‹ì‚¬ ì„ íƒ</h3>
                <button class="modal-close-btn" onclick="closeManualMergeModal()">Ã—</button>
            </div>
            <p class="manual-merge-description">ë³‘í•©í•  ì´ì „ ì‹ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš” (ìµœê·¼ 30ì¼)</p>
            <div class="meal-list" id="mealList">
                <!-- ì‹ì‚¬ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                <div class="meal-list-loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- ì‹ì‚¬ ì§ì ‘ ì…ë ¥ ëª¨ë‹¬ -->
    <div class="meal-input-modal-overlay" id="mealInputModalOverlay" onclick="closeMealInputModal(event)">
        <div class="meal-input-modal" onclick="event.stopPropagation()">
            <div class="meal-input-header">
                <h2 class="meal-input-title" id="mealInputTitle">ğŸ½ï¸ ì‹ì‚¬ ì…ë ¥</h2>
                <button class="modal-close" onclick="closeMealInputModal()">&times;</button>
            </div>

            <div class="meal-input-form">
                <div class="form-group-meal">
                    <label class="form-label-meal">ìŒì‹ëª…</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="mealFoodName" class="form-input-meal" placeholder="ì˜ˆ: í˜í˜ë¡œ, ê°ìíƒ•, ë¼ë©´" 
                               style="flex: 1;" onkeypress="if(event.key==='Enter') searchFoodDatabase();">
                        <button class="search-food-btn" onclick="searchFoodDatabase()" style="padding: 10px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap;">
                            ğŸ” ê²€ìƒ‰
                        </button>
                    </div>
                </div>
                
                <!-- ìŒì‹ ê²€ìƒ‰ ê²°ê³¼ (ë¸Œëœë“œë³„) -->
                <div id="foodSearchResults" style="display: none; margin-top: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 300px; overflow-y: auto;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #333; font-size: 0.95rem;">
                            ğŸ“‹ ê²€ìƒ‰ ê²°ê³¼ (í´ë¦­í•˜ì—¬ ì„ íƒ)
                        </div>
                        <div id="foodOptionsContainer"></div>
                    </div>
                </div>

                <div class="form-group-meal">
                    <label class="form-label-meal">ì–‘ (ê·¸ëŒ)</label>
                    <input type="number" id="mealGrams" class="form-input-meal" placeholder="ì˜ˆ: 150">
                </div>
                
                <!-- ğŸ”¥ ì§ì ‘ ì…ë ¥ / AI ë¶„ì„ ì„ íƒ -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="ai-analyze-btn" id="aiAnalyzeBtn" onclick="analyzeMealWithAI()" style="flex: 1;">
                        <span>ğŸ¤–</span>
                        <span>AIë¡œ ì˜ì–‘ ë¶„ì„</span>
                    </button>
                    <button class="ai-analyze-btn" onclick="toggleManualInput(); document.getElementById('nutritionResult').classList.add('show');" style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <span>âœï¸</span>
                        <span>ì§ì ‘ ì…ë ¥</span>
                    </button>
                </div>

                <div class="nutrition-result show" id="nutritionResult">
                    <div class="nutrition-result-title">ğŸ“Š ë¶„ì„ ê²°ê³¼</div>
                    <div class="nutrition-result-grid">
                        <div class="nutrition-result-item">
                            <div class="nutrition-result-label">ì¹¼ë¡œë¦¬</div>
                            <div class="nutrition-result-value" id="resultCalories">0</div>
                            <div class="nutrition-result-label">kcal</div>
                        </div>
                        <div class="nutrition-result-item">
                            <div class="nutrition-result-label">íƒ„ìˆ˜í™”ë¬¼</div>
                            <div class="nutrition-result-value" id="resultCarbs">0</div>
                            <div class="nutrition-result-label">g</div>
                        </div>
                        <div class="nutrition-result-item">
                            <div class="nutrition-result-label">ë‹¨ë°±ì§ˆ</div>
                            <div class="nutrition-result-value" id="resultProtein">0</div>
                            <div class="nutrition-result-label">g</div>
                        </div>
                        <div class="nutrition-result-item">
                            <div class="nutrition-result-label">ì§€ë°©</div>
                            <div class="nutrition-result-value" id="resultFat">0</div>
                            <div class="nutrition-result-label">g</div>
                        </div>
                    </div>

                    <div class="manual-input-toggle" onclick="toggleManualInput()">
                        ğŸ’¡ ìˆ˜ë™ìœ¼ë¡œ ì§ì ‘ ì…ë ¥í•˜ê¸°
                    </div>

                    <div class="manual-input-fields show" id="manualInputFields">
                        <div class="form-group-meal" style="flex: 1; min-width: 0;">
                            <label class="form-label-meal" style="white-space: nowrap;">ì¹¼ë¡œë¦¬ (kcal)</label>
                            <input type="number" id="manualCalories" class="form-input-meal" placeholder="0" style="width: 100%;">
                        </div>
                        <div class="form-group-meal" style="flex: 1; min-width: 0;">
                            <label class="form-label-meal" style="white-space: nowrap;">íƒ„ìˆ˜í™”ë¬¼ (g)</label>
                            <input type="number" id="manualCarbs" class="form-input-meal" placeholder="0" style="width: 100%;">
                        </div>
                        <div class="form-group-meal" style="flex: 1; min-width: 0;">
                            <label class="form-label-meal" style="white-space: nowrap;">ë‹¨ë°±ì§ˆ (g)</label>
                            <input type="number" id="manualProtein" class="form-input-meal" placeholder="0" style="width: 100%;">
                        </div>
                        <div class="form-group-meal" style="flex: 1; min-width: 0;">
                            <label class="form-label-meal" style="white-space: nowrap;">ì§€ë°© (g)</label>
                            <input type="number" id="manualFat" class="form-input-meal" placeholder="0" style="width: 100%;">
                        </div>
                    </div>

                    <button class="save-meal-btn" onclick="saveMealInput()">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="meal-input-modal-overlay" id="editNotificationModalOverlay" onclick="closeEditNotificationModal(event)">
        <div class="meal-input-modal" onclick="event.stopPropagation()">
            <div class="meal-input-header">
                <h2 class="meal-input-title">âœï¸ ì•Œë¦¼ ìˆ˜ì •</h2>
                <button class="modal-close" onclick="closeEditNotificationModal()">&times;</button>
            </div>

            <div class="meal-input-form">
                <div class="form-group-meal">
                    <label class="form-label-meal">ì•Œë¦¼ ë‚´ìš©</label>
                    <input type="text" id="editNotifTitle" class="form-input-meal" placeholder="ì˜ˆ: ë¬¼ ë§ˆì‹œê¸°">
                </div>

                <div class="form-group-meal">
                    <label class="form-label-meal">ì•Œë¦¼ ì‹œê°„</label>
                    <input type="time" id="editNotifTime" class="form-input-meal">
                </div>

                <div class="form-group-meal">
                    <label class="form-label-meal">ë°˜ë³µ ì£¼ê¸°</label>
                    <select id="editNotifRepeat" class="form-input-meal">
                        <option value="ë§¤ì¼">ë§¤ì¼</option>
                        <option value="ë§¤ì£¼">ë§¤ì£¼</option>
                        <option value="í•œ ë²ˆë§Œ">í•œ ë²ˆë§Œ</option>
                    </select>
                </div>

                <button class="save-meal-btn" onclick="saveEditedNotification()">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ëª¨ë˜ ì…ë ¥ ëª¨ë‹¬ë“¤ -->
    <!-- í…ìŠ¤íŠ¸ ì¹´ë“œ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="textCardModal" class="modern-input-modal" onclick="if(event.target===this) closeModernModal('textCardModal')">
        <div class="modern-input-content">
            <div class="modern-input-header">
                <span class="modern-input-title">ğŸ“ ë©”ëª¨ ì¶”ê°€</span>
                <button class="modern-input-close" onclick="closeModernModal('textCardModal')">Ã—</button>
            </div>
            <textarea id="textCardInput" class="modern-input-field" rows="4" placeholder="ì˜¤ëŠ˜ì˜ ë‹¤ì§, ëŠë‚€ì ì„ ì ì–´ë³´ì„¸ìš”..."></textarea>
            <button class="modern-input-submit" onclick="submitTextCard()">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>

    <!-- ì¼ì • ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="scheduleModal" class="modern-input-modal" onclick="if(event.target===this) closeModernModal('scheduleModal')">
        <div class="modern-input-content">
            <div class="modern-input-header">
                <span class="modern-input-title">ğŸ“… ì¼ì • ì¶”ê°€</span>
                <button class="modern-input-close" onclick="closeModernModal('scheduleModal')">Ã—</button>
            </div>
            <label class="modern-input-label">ì‹œê°„</label>
            <input type="time" id="scheduleTimeInput" class="modern-input-field" value="07:00">
            <label class="modern-input-label">ì¼ì • ë‚´ìš©</label>
            <input type="text" id="scheduleActivityInput" class="modern-input-field" placeholder="ì˜ˆ: ì•„ì¹¨ ìš´ë™, ì ì‹¬ ì‹ì‚¬...">
            <button class="modern-input-submit" onclick="submitScheduleItem()">ì¶”ê°€í•˜ê¸°</button>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ ë‹¨ì‹ ì‹œê°„ ëª¨ë‹¬ -->
    <div id="customFastingModal" class="modern-input-modal" onclick="if(event.target===this) closeModernModal('customFastingModal')">
        <div class="modern-input-content">
            <div class="modern-input-header">
                <span class="modern-input-title">â±ï¸ ë‹¨ì‹ ì‹œê°„ ì„¤ì •</span>
                <button class="modern-input-close" onclick="closeModernModal('customFastingModal')">Ã—</button>
            </div>
            <label class="modern-input-label">ë‹¨ì‹ ì‹œê°„ (ì‹œê°„ ë‹¨ìœ„)</label>
            <div class="modern-select-group">
                <button class="modern-select-btn" onclick="selectFastingHour(12)">12ì‹œê°„</button>
                <button class="modern-select-btn active" onclick="selectFastingHour(16)">16ì‹œê°„</button>
                <button class="modern-select-btn" onclick="selectFastingHour(18)">18ì‹œê°„</button>
                <button class="modern-select-btn" onclick="selectFastingHour(20)">20ì‹œê°„</button>
                <button class="modern-select-btn" onclick="selectFastingHour(24)">24ì‹œê°„</button>
            </div>
            <input type="number" id="customFastingInput" class="modern-input-field" value="16" min="1" max="72" placeholder="ì§ì ‘ ì…ë ¥">
            <button class="modern-input-submit" onclick="submitCustomFasting()">ë‹¨ì‹ ì‹œì‘</button>
        </div>
    </div>

    <!-- ì•Œë¦¼ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addNotificationModal" class="modern-input-modal" onclick="if(event.target===this) closeModernModal('addNotificationModal')">
        <div class="modern-input-content">
            <div class="modern-input-header">
                <span class="modern-input-title">ğŸ”” ì•Œë¦¼ ì¶”ê°€</span>
                <button class="modern-input-close" onclick="closeModernModal('addNotificationModal')">Ã—</button>
            </div>
            <label class="modern-input-label">ì•Œë¦¼ ë‚´ìš©</label>
            <input type="text" id="notificationTitleInput" class="modern-input-field" placeholder="ì˜ˆ: ë¬¼ ë§ˆì‹œê¸°, ìŠ¤íŠ¸ë ˆì¹­...">
            <label class="modern-input-label">ì•Œë¦¼ ì‹œê°„</label>
            <input type="time" id="notificationTimeInput" class="modern-input-field" value="09:00">
            <label class="modern-input-label">ë°˜ë³µ</label>
            <div class="modern-select-group" id="notificationRepeatGroup">
                <button class="modern-select-btn active" data-value="ë§¤ì¼" onclick="selectNotificationRepeat(this)">ë§¤ì¼</button>
                <button class="modern-select-btn" data-value="ë§¤ì£¼" onclick="selectNotificationRepeat(this)">ë§¤ì£¼</button>
                <button class="modern-select-btn" data-value="í•œ ë²ˆë§Œ" onclick="selectNotificationRepeat(this)">í•œ ë²ˆë§Œ</button>
            </div>
            <button class="modern-input-submit" onclick="submitNotification()">ì¶”ê°€í•˜ê¸°</button>
        </div>
    </div>

    <!-- ğŸ”¥ v3.9.1: ì²´ì¤‘ ê·¸ë˜í”„ ëª¨ë‹¬ -->
    <div id="weightGraphModal" class="modern-input-modal" style="display: none;" onclick="if(event.target===this) closeWeightGraphModal()">
        <div class="modern-input-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modern-input-header">
                <span class="modern-input-title">ğŸ“Š ì²´ì¤‘ ë³€í™” ê·¸ë˜í”„</span>
                <button class="modern-input-close" onclick="closeWeightGraphModal()">Ã—</button>
            </div>
            
            <!-- ì²´ì¤‘ ê¸°ë¡ ìœ ë„ -->
            <div id="weightRecordPrompt" style="display: none; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-weight: bold; margin-bottom: 5px;">ğŸ“ ì˜¤ëŠ˜ ì²´ì¤‘ì„ ê¸°ë¡í•´ì£¼ì„¸ìš”!</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">ë§ˆì§€ë§‰ ê¸°ë¡: <span id="lastWeightDate">-</span></div>
                    </div>
                    <button onclick="openQuickWeightInput()" style="padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        ê¸°ë¡í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- ì²´ì¤‘ í†µê³„ ìš”ì•½ -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">ì‹œì‘ ì²´ì¤‘</div>
                    <div style="font-weight: bold; color: #333; font-size: 1.1rem;" id="modalStartWeight">-</div>
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">í˜„ì¬ ì²´ì¤‘</div>
                    <div style="font-weight: bold; color: #667eea; font-size: 1.1rem;" id="modalCurrentWeight">-</div>
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 5px;">ë³€í™”ëŸ‰</div>
                    <div style="font-weight: bold; font-size: 1.1rem;" id="modalWeightChange">-</div>
                </div>
            </div>

            <!-- ê·¸ë˜í”„ -->
            <div style="margin-bottom: 20px;">
                <canvas id="weightGraphChart" style="max-height: 300px;"></canvas>
            </div>

            <!-- ìµœê·¼ ê¸°ë¡ ëª©ë¡ -->
            <div>
                <h4 style="margin: 0 0 15px 0; font-size: 1rem; color: #333;">ğŸ“‹ ìµœê·¼ ê¸°ë¡</h4>
                <div id="recentWeightList" style="max-height: 200px; overflow-y: auto;">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ”¥ ë¹ ë¥¸ ì²´ì¤‘ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="quickWeightInputModal" class="modern-input-modal" style="display: none;" onclick="if(event.target===this) closeQuickWeightInput()">
        <div class="modern-input-content" style="max-width: 400px;">
            <div class="modern-input-header">
                <span class="modern-input-title">âš–ï¸ ì˜¤ëŠ˜ ì²´ì¤‘ ê¸°ë¡</span>
                <button class="modern-input-close" onclick="closeQuickWeightInput()">Ã—</button>
            </div>
            <label class="modern-input-label">ì²´ì¤‘ (kg)</label>
            <input type="number" id="quickWeightInput" class="modern-input-field" placeholder="ì˜ˆ: 70.5" step="0.1" onkeypress="if(event.key==='Enter') saveQuickWeight()">
            <button class="modern-input-submit" onclick="saveQuickWeight()">ê¸°ë¡í•˜ê¸°</button>
        </div>
    </div>
</body>
</html>