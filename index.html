<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <title>Diet Mate Pro v2.5</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <style>
        /* === [ê¸°ë³¸ ìŠ¤íƒ€ì¼] === */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; overflow-x: hidden; padding-bottom: 90px; }
        .hidden { display: none !important; }
        
        /* === [ê³µí†µ ì»´í¬ë„ŒíŠ¸] === */
        .btn { padding: 12px 20px; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .btn-danger { background: #ff5252; color: white; }
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .input-box, .form-input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 1rem; margin-bottom: 10px; }
        
        /* === [ë„¤ë¹„ê²Œì´ì…˜ (8 Tabs)] === */
        .bottom-nav { 
            position: fixed; bottom: 0; left:0; right:0; background: white; 
            display: flex; overflow-x: auto; padding: 10px 0; 
            border-top: 1px solid #eee; z-index: 1000; 
            -ms-overflow-style: none; scrollbar-width: none; 
        }
        .bottom-nav::-webkit-scrollbar { display: none; }
        .nav-item { 
            min-width: 70px; flex-shrink: 0; text-align: center; 
            color: #999; cursor: pointer; font-size: 0.7rem; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .nav-item.active { color: #667eea; font-weight: bold; }
        .nav-icon { font-size: 1.4rem; margin-bottom: 4px; }

        /* === [ìƒë‹¨ í—¤ë”] === */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 20px; border-radius: 0 0 30px 30px; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3); margin-bottom: 20px; }
        .header-title { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        
        /* === [AI ì±„íŒ… (Hybrid)] === */
        .ai-chat-section { margin-top: 15px; }
        .ai-chat-details { background: white; border-radius: 15px; overflow: hidden; border: 1px solid #eee; }
        .ai-chat-summary { 
            padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .chat-container { height: 350px; overflow-y: auto; padding: 15px; background: #f8f9fa; }
        .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 15px; margin-bottom: 10px; font-size: 0.9rem; line-height: 1.4; position: relative; }
        .chat-ai { background: white; color: #333; float: left; clear: both; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chat-user { background: #667eea; color: white; float: right; clear: both; border-bottom-right-radius: 4px; }
        .chat-input-area { display: flex; padding: 10px; background: white; border-top: 1px solid #eee; gap: 8px; }

        /* === [ë‹¨ì‹ (Fasting)] === */
        .fasting-timer-card { text-align: center; padding: 30px 20px; }
        .timer-display { font-size: 3.5rem; font-weight: bold; color: #333; font-variant-numeric: tabular-nums; margin: 10px 0; }
        .fasting-accordion { margin-top: 15px; background: #e3f2fd; border-radius: 15px; padding: 10px; }
        .fasting-accordion summary { font-weight: bold; color: #1565c0; cursor: pointer; list-style: none; }
        .fasting-content { padding: 10px; font-size: 0.9rem; line-height: 1.6; border-top: 1px solid rgba(0,0,0,0.05); margin-top: 5px; }
        .benefit { color: #2e7d32; font-weight: bold; display: block; margin-top: 5px; }
        .risk { color: #c62828; font-weight: bold; display: block; margin-top: 5px; }

        /* === [ì•Œë¦¼ (Notifications)] === */
        .notification-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 15px; margin-bottom: 10px; border-left: 4px solid #ddd; }
        .notification-item.pending { border-left-color: #ffc107; background: #fffde7; }
        .noti-badge { font-size: 0.75rem; background: #e0e0e0; padding: 2px 8px; border-radius: 10px; margin-left: 5px; }

        /* === [ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ (Goals, Album, etc)] === */
        .goal-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s; }
        .goal-card.completed { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; }
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .photo-item { aspect-ratio: 1; background: #eee; border-radius: 10px; overflow: hidden; position: relative; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-day { aspect-ratio: 1; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.9rem; background: #fff; }
        .calendar-day.today { background: #667eea; color: white; font-weight: bold; }
        
        /* === [ëª¨ë‹¬ & ë¡œë”©] === */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; display:flex; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:25px; border-radius:20px; width:90%; max-width:400px; max-height:85vh; overflow-y:auto; }
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #667eea; display: flex; justify-content: center; align-items: center; color: white; z-index: 10000; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div style="text-align: center;">
            <div class="spinner" style="margin: 0 auto 15px;"></div>
            <h2>Diet Mate Pro v2.5</h2>
        </div>
    </div>

    <div id="auth-view" class="hidden" style="padding: 40px 20px; height: 100vh; display: flex; flex-direction: column; justify-content: center; background: white;">
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="font-size: 3rem; margin-bottom: 10px;">ğŸ’ª</h1>
            <h2>Diet Mate</h2>
            <p style="color: #666;">AIì™€ í•¨ê»˜í•˜ëŠ” ê±´ê°•í•œ ìŠµê´€</p>
        </div>
        <input type="email" id="email" class="input-box" placeholder="ì´ë©”ì¼">
        <input type="password" id="password" class="input-box" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button onclick="handleLogin()" class="btn btn-primary" style="width: 100%; margin-top: 10px;">ì‹œì‘í•˜ê¸°</button>
        <p id="auth-msg" style="color: red; text-align: center; margin-top: 10px; font-size: 0.9rem;"></p>
    </div>

    <div id="app-view" class="hidden">
        
        <div id="tab-home" class="tab-content active" style="padding: 20px;">
            <div class="header" style="margin: -20px -20px 20px -20px;">
                <h2 class="header-title" id="user-greeting">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h2>
                <p>ì˜¤ëŠ˜ë„ ê±´ê°•í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”</p>
            </div>

            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h3>ğŸ¤– AI ë°ì¼ë¦¬ ì½”ì¹˜</h3>
                <div id="daily-advice" style="margin-top:10px; opacity:0.9; line-height:1.5;">ë¶„ì„ ì¤‘...</div>
                <button onclick="loadAICoaching()" class="btn" style="margin-top:10px; background:rgba(255,255,255,0.2); color:white; width:100%; padding:8px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>

            <div class="ai-chat-section">
                <details class="ai-chat-details" open>
                    <summary class="ai-chat-summary">ğŸ’¬ AIì™€ ëŒ€í™”í•˜ê¸°</summary>
                    <div class="chat-container" id="chat-history">
                        <div class="chat-bubble chat-ai">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”. "ì–´ì œë‘ ë¹„êµí•´ì¤˜", "ì˜¤ëŠ˜ ìš´ë™ ì¶”ì²œí•´ì¤˜" ë¼ê³  í•´ë³´ì„¸ìš”!</div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" class="input-box" style="margin:0; border-radius: 20px;" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()" class="btn btn-primary" style="border-radius: 50%; width: 45px; height: 45px; padding: 0;">â¤</button>
                    </div>
                </details>
            </div>
            
            <div class="card" style="margin-top:20px;">
                <h3>ğŸ“Š ì²´ì¤‘ & ë¬¼</h3>
                <div style="height:200px; margin:10px 0;"><canvas id="weight-chart"></canvas></div>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="weight-input" class="input-box" placeholder="kg" style="margin:0;">
                    <button onclick="addWeight()" class="btn btn-primary">ê¸°ë¡</button>
                </div>
                <div id="water-tracker" style="display:grid; grid-template-columns:repeat(8,1fr); gap:5px; margin-top:15px;"></div>
            </div>

            <div id="nagging-alert-area" style="margin-top: 20px;"></div>
        </div>

        <div id="tab-goals" class="tab-content hidden" style="padding: 20px;">
            <h2>ğŸ¯ ëª©í‘œ ê´€ë¦¬</h2>
            <div style="display:flex; gap:5px; overflow-x:auto; margin:15px 0;">
                <button class="btn" onclick="renderGoalsList('all')">ì „ì²´</button>
                <button class="btn" onclick="renderGoalsList('diet')">ì‹ë‹¨</button>
                <button class="btn" onclick="renderGoalsList('exercise')">ìš´ë™</button>
            </div>
            <div id="goals-list"></div>
            <button onclick="showGoalModal()" class="btn btn-primary" style="width:100%; margin-top:10px;">+ ëª©í‘œ ì¶”ê°€</button>
        </div>

        <div id="tab-fasting" class="tab-content hidden" style="padding: 20px;">
            <div class="card fasting-timer-card">
                <h3>â±ï¸ ë‹¨ì‹ íƒ€ì´ë¨¸</h3>
                <div class="timer-display" id="timer-display">00:00:00</div>
                <p id="timer-status" style="color:#666; margin-bottom:20px;">ë‹¨ì‹ ì¤€ë¹„ ì¤‘</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                    <button class="btn" style="background:#f0f0f0;" onclick="setFastingTarget(12)">12:12</button>
                    <button class="btn" style="background:#f0f0f0;" onclick="setFastingTarget(16)">16:8</button>
                    <button class="btn" style="background:#f0f0f0;" onclick="setFastingTarget(24)">24h</button>
                    <button class="btn" style="background:#f0f0f0;" onclick="setCustomFasting()">ì§ì ‘</button>
                </div>
                <button id="btn-fasting-toggle" class="btn btn-primary" style="width:100%;" onclick="toggleFasting()">ë‹¨ì‹ ì‹œì‘</button>
            </div>
            <details class="fasting-accordion">
                <summary>ğŸ’¡ ë‹¨ì‹ì˜ ê³¼í•™ (ì´ì  & ì£¼ì˜ì‚¬í•­)</summary>
                <div class="fasting-content">
                    <span class="benefit">âœ¨ ê¸ì •ì  íš¨ê³¼</span>
                    12h+: ì¸ìŠë¦° ì €í•­ì„± ê°œì„ <br>16h+: ì§€ë°© ì—°ì†Œ ê°€ì†<br>24h+: ìê°€í¬ì‹ (ì„¸í¬ ì²­ì†Œ) ì‹œì‘<br><br>
                    <span class="risk">âš ï¸ ì£¼ì˜ì‚¬í•­</span>
                    <strong>íœ´ì§€ê¸° íƒˆëª¨:</strong> ì˜ì–‘ ë¶€ì¡± ì£¼ì˜. ë‹¨ë°±ì§ˆ í•„ìˆ˜!<br>
                    <strong>ë‹´ì„ì¦:</strong> ìˆ˜ë¶„ ë¶€ì¡± ì‹œ ìœ„í—˜. ë¬¼ ë§ì´ ë“œì„¸ìš”.<br>
                    <strong>ì–´ì§€ëŸ¬ì›€:</strong> ì†Œê¸ˆë¬¼ì„ ì„­ì·¨í•˜ê±°ë‚˜ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ì„¸ìš”.
                </div>
            </details>
        </div>

        <div id="tab-album" class="tab-content hidden" style="padding: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>ğŸ“¸ ì•¨ë²”</h2>
                <button onclick="showTimelapse()" class="btn" style="font-size:0.8rem; background:#eee;">ğŸ¬ íƒ€ì„ë©ìŠ¤</button>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn btn-primary" onclick="currentAlbumTab='body'; loadAlbumPhotos()">ëˆˆë°”ë””</button>
                <button class="btn" style="background:#eee;" onclick="currentAlbumTab='food'; loadAlbumPhotos()">ì‹ë‹¨</button>
            </div>
            <div id="photo-grid" class="photo-grid"></div>
            <button onclick="document.getElementById('photo-input').click()" class="btn btn-primary" style="width:100%; margin-top:20px;">+ ì‚¬ì§„ ì¶”ê°€</button>
            <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
        </div>

        <div id="tab-calendar" class="tab-content hidden" style="padding: 20px;">
            <h2>ğŸ“… ìº˜ë¦°ë”</h2>
            <div class="card" style="margin-top:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <button onclick="changeMonth(-1)" class="btn">â—€</button>
                    <h3 id="calendar-month-year"></h3>
                    <button onclick="changeMonth(1)" class="btn">â–¶</button>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </div>

        <div id="tab-community" class="tab-content hidden" style="padding: 20px; display:flex; flex-direction:column; height:calc(100vh - 80px);">
            <h2>ğŸ’¬ ìˆ˜ë‹¤ë°©</h2>
            <div id="comm-messages" style="flex:1; overflow-y:auto; padding:10px; background:#f9f9f9; border-radius:15px; margin:10px 0;"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="comm-input" class="input-box" style="margin:0;">
                <button onclick="sendCommunityMessage()" class="btn btn-primary">ì „ì†¡</button>
            </div>
        </div>

        <div id="tab-notifications" class="tab-content hidden" style="padding: 20px;">
            <div class="card">
                <h3>ğŸ”” ëˆì§ˆê¸´ ì•Œë¦¼ ì„¤ì •</h3>
                <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">ì™„ë£Œí•  ë•Œê¹Œì§€ ê³„ì† ì•Œë ¤ë“œë¦½ë‹ˆë‹¤!</p>
                <div style="background:#f9f9f9; padding:15px; border-radius:15px; margin-bottom:15px;">
                    <input type="text" id="noti-text" class="input-box" placeholder="í•  ì¼ (ì˜ˆ: ìœ ì‚°ê·  ë¨¹ê¸°)">
                    <div style="display:flex; gap:5px;">
                        <input type="time" id="noti-time" class="input-box">
                        <select id="noti-interval" class="input-box">
                            <option value="1">1ë¶„ë§ˆë‹¤</option>
                            <option value="3" selected>3ë¶„ë§ˆë‹¤</option>
                            <option value="5">5ë¶„ë§ˆë‹¤</option>
                            <option value="10">10ë¶„ë§ˆë‹¤</option>
                        </select>
                    </div>
                    <button onclick="addNotification()" class="btn btn-primary" style="width:100%;">ì•Œë¦¼ ì¶”ê°€</button>
                </div>
                <div id="noti-list"></div>
                <button onclick="requestNotiPermission()" class="btn" style="width:100%; margin-top:10px; font-size:0.8rem; background:#eee;">ğŸ”” ê¶Œí•œ ì¼œê¸°</button>
            </div>
        </div>

        <div id="tab-settings" class="tab-content hidden" style="padding: 20px;">
            <h2>âš™ï¸ ì„¤ì •</h2>
            <div class="card" style="margin-top:15px;">
                <h3>ğŸ‘¤ í”„ë¡œí•„</h3>
                <p id="profile-info" style="color:#666; margin:10px 0;"></p>
                <div id="bmi-info" style="background:#f0f3ff; padding:10px; border-radius:10px;"></div>
            </div>
            <div class="card">
                <h3>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
                <button onclick="exportData()" class="btn" style="width:100%; margin-bottom:10px; background:#eee;">ğŸ“¦ ë°±ì—… (ë‚´ë³´ë‚´ê¸°)</button>
                <button onclick="importData()" class="btn" style="width:100%; background:#eee;">ğŸ“¥ ë³µì› (ê°€ì ¸ì˜¤ê¸°)</button>
            </div>
            <div class="card" id="pwa-install-area" style="display:none;">
                <h3>ğŸ“± ì•± ì„¤ì¹˜</h3>
                <button onclick="installPWA()" class="btn btn-primary" style="width:100%;">í™ˆ í™”ë©´ì— ì¶”ê°€</button>
            </div>
            <button onclick="auth.signOut()" class="btn btn-danger" style="width:100%;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home')"><div class="nav-icon">ğŸ </div>í™ˆ</div>
            <div class="nav-item" onclick="switchTab('goals')"><div class="nav-icon">ğŸ¯</div>ëª©í‘œ</div>
            <div class="nav-item" onclick="switchTab('fasting')"><div class="nav-icon">â±ï¸</div>ë‹¨ì‹</div>
            <div class="nav-item" onclick="switchTab('album')"><div class="nav-icon">ğŸ“¸</div>ì•¨ë²”</div>
            <div class="nav-item" onclick="switchTab('calendar')"><div class="nav-icon">ğŸ“…</div>ë‹¬ë ¥</div>
            <div class="nav-item" onclick="switchTab('community')"><div class="nav-icon">ğŸ’¬</div>ì†Œí†µ</div>
            <div class="nav-item" onclick="switchTab('notifications')"><div class="nav-icon">ğŸ””</div>ì•Œë¦¼</div>
            <div class="nav-item" onclick="switchTab('settings')"><div class="nav-icon">âš™ï¸</div>ì„¤ì •</div>
        </div>
    </div>

    <script>
        // === [1] ì„¤ì • ë° ì „ì—­ ë³€ìˆ˜ ===
        // TODO: ì—¬ê¸°ì— ë³¸ì¸ì˜ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
        const API_KEYS = [
            'AIzaSyA9pV6incQB-IoNyfStdnmtF5-Lnc7nV2c',
            'YOUR_GEMINI_API_KEY_2'
        ];
        
        const firebaseConfig = {
            apiKey: "AIzaSyDrw00jym_dKATz26qUzsALSqfYeAAkM-I",
            authDomain: "mate-9f45e.firebaseapp.com",
            projectId: "mate-9f45e",
            storageBucket: "mate-9f45e.firebasestorage.app",
            messagingSenderId: "1077932492908",
            appId: "1:1077932492908:web:722c068177e2e715183049"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const appId = 'diet-mate-v2';

        let currentUser = null, currentProfile = null;
        let currentAPIKeyIndex = 0;
        let weightChart = null;
        let currentAlbumTab = 'body';
        let currentMonth = new Date();
        let deferredPrompt = null; // PWA

        // === [2] AI ë¡œì§ (Rotation & Hybrid) ===
        async function callGemini(prompt, imageBase64 = null, retry = 0) {
            if (retry >= API_KEYS.length) return "AI ì„œë²„ê°€ í˜¼ì¡í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            const key = API_KEYS[currentAPIKeyIndex];
            if (!key || key.startsWith('YOUR_')) return "API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.";

            const body = { contents: [{ parts: [{ text: prompt }] }] };
            if (imageBase64) body.contents[0].parts.unshift({ inline_data: { mime_type: "image/jpeg", data: imageBase64 } });

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                });
                if (res.status === 429) { // Quota exceeded
                    console.log("Quota exceeded, switching key...");
                    currentAPIKeyIndex = (currentAPIKeyIndex + 1) % API_KEYS.length;
                    return callGemini(prompt, imageBase64, retry + 1);
                }
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                console.error(e);
                currentAPIKeyIndex = (currentAPIKeyIndex + 1) % API_KEYS.length;
                return callGemini(prompt, imageBase64, retry + 1);
            }
        }

        async function loadAICoaching() {
            const adviceDiv = document.getElementById('daily-advice');
            adviceDiv.innerHTML = '<div class="spinner" style="width:20px; height:20px;"></div> ë¶„ì„ ì¤‘...';
            // ì‹¤ì œ ë°ì´í„° ë¡œë“œ (ê°„ì†Œí™”)
            const today = new Date().toISOString().split('T')[0];
            const prompt = `ë„ˆëŠ” ë‹¤ì´ì–´íŠ¸ ì½”ì¹˜ì•¼. ì‚¬ìš©ì(${currentProfile?.name})ì˜ ì˜¤ëŠ˜(${today}) ìƒíƒœë¥¼ ë³´ê³  3ì¤„ ìš”ì•½ ì¡°ì–¸í•´ì¤˜. ê¸ì •ì ì´ê³  ì´ëª¨ì§€ ë§ì´ ì¨ì¤˜.`;
            const text = await callGemini(prompt);
            adviceDiv.innerHTML = text.replace(/\n/g, '<br>');
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            appendChat(text, true);
            input.value = '';
            
            const loading = appendChat("ìƒê° ì¤‘...", false);
            // Context Injection (ê³¼ê±° ê¸°ë¡ í¬í•¨)
            const history = "ì‚¬ìš©ì í”„ë¡œí•„: " + JSON.stringify(currentProfile); 
            const prompt = `${history}\nì‚¬ìš©ì ì§ˆë¬¸: ${text}\nìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¹œì ˆí•˜ê²Œ ë‹µë³€í•´ì¤˜.`;
            
            const reply = await callGemini(prompt);
            loading.remove();
            appendChat(reply, false);
        }

        function appendChat(text, isUser) {
            const container = document.getElementById('chat-history');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isUser ? 'chat-user' : 'chat-ai'}`;
            bubble.innerHTML = text.replace(/\n/g, '<br>');
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
            return bubble;
        }

        // === [3] ë‹¨ì‹ ë¡œì§ (Fasting) ===
        let fastingState = JSON.parse(localStorage.getItem('fasting_state')) || { isFasting: false, startTime: null, targetHours: 12 };
        
        function updateFastingTimer() {
            const display = document.getElementById('timer-display');
            const btn = document.getElementById('btn-fasting-toggle');
            const status = document.getElementById('timer-status');

            if (!fastingState.isFasting) {
                display.textContent = "00:00:00";
                status.textContent = "ë‹¨ì‹ ì¤€ë¹„";
                btn.textContent = "ë‹¨ì‹ ì‹œì‘";
                btn.className = "btn btn-primary";
                return;
            }

            const diff = Math.floor((Date.now() - fastingState.startTime) / 1000);
            const h = Math.floor(diff / 3600);
            const m = Math.floor((diff % 3600) / 60);
            const s = diff % 60;
            display.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            status.textContent = `ëª©í‘œ: ${fastingState.targetHours}ì‹œê°„ ì¤‘`;
            btn.textContent = "ë‹¨ì‹ ì¢…ë£Œ";
            btn.className = "btn btn-danger";
        }

        function toggleFasting() {
            if (fastingState.isFasting) {
                if(confirm("ë‹¨ì‹ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    fastingState.isFasting = false;
                    localStorage.setItem('fasting_state', JSON.stringify(fastingState));
                    updateFastingTimer();
                }
            } else {
                if(fastingState.targetHours >= 24) {
                    showModal("âš ï¸ ì¥ê¸° ë‹¨ì‹ ì•ˆì „ í™•ì¸", 
                        "ì¥ê¸° ë‹¨ì‹ì€ ì „ë¬¸ê°€ ìƒë‹´ì´ ê¶Œì¥ë©ë‹ˆë‹¤.<br>ë¬¼ê³¼ ì†Œê¸ˆì„ ì¶©ë¶„íˆ ë“œì„¸ìš”.<br>ì–´ì§€ëŸ¬ìš°ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ì„¸ìš”.", 
                        startFastingReal);
                } else {
                    startFastingReal();
                }
            }
        }
        function startFastingReal() {
            fastingState.isFasting = true;
            fastingState.startTime = Date.now();
            localStorage.setItem('fasting_state', JSON.stringify(fastingState));
            updateFastingTimer();
            switchTab('fasting');
        }
        function setFastingTarget(h) { fastingState.targetHours = h; alert(h+"ì‹œê°„ ì„¤ì • ì™„ë£Œ"); localStorage.setItem('fasting_state', JSON.stringify(fastingState)); }
        function setCustomFasting() { const h = prompt("ì‹œê°„ ì…ë ¥:"); if(h) setFastingTarget(h); }

        // === [4] ì•Œë¦¼ ë¡œì§ (Nagging) ===
        let notifications = JSON.parse(localStorage.getItem('diet_notis')) || [];
        
        function checkNotifications() {
            const now = new Date();
            const hm = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            notifications.forEach(n => {
                if(n.time === hm && !n.triggeredToday) {
                    triggerNoti(n);
                    n.triggeredToday = true;
                    n.pending = true;
                    n.lastNag = Date.now();
                }
                if(n.pending) {
                    const elapsedMin = Math.floor((Date.now() - n.lastNag)/60000);
                    if(elapsedMin >= n.interval) {
                        triggerNoti(n, true);
                        n.lastNag = Date.now();
                    }
                }
            });
            localStorage.setItem('diet_notis', JSON.stringify(notifications));
            renderAlertArea();
        }

        function triggerNoti(n, isNag=false) {
            const title = isNag ? "ğŸ”´ ì•„ì§ ì•ˆ í•˜ì…¨ë‚˜ìš”?" : "ğŸ”” ì•Œë¦¼";
            const body = isNag ? `${n.text} ì™„ë£Œí•´ì£¼ì„¸ìš”!` : n.text;
            if(Notification.permission === 'granted') new Notification(title, { body });
        }

        function addNotification() {
            const text = document.getElementById('noti-text').value;
            const time = document.getElementById('noti-time').value;
            const interval = document.getElementById('noti-interval').value;
            if(!text || !time) return;
            notifications.push({ id:Date.now(), text, time, interval:parseInt(interval), pending:false, triggeredToday:false, lastNag:0 });
            localStorage.setItem('diet_notis', JSON.stringify(notifications));
            renderNotiList();
            alert("ì•Œë¦¼ ì¶”ê°€ë¨");
        }
        function renderNotiList() {
            const list = document.getElementById('noti-list');
            list.innerHTML = notifications.map(n => `
                <div class="notification-item">
                    <div><b>${n.time}</b> ${n.text} <span class="noti-badge">${n.interval}ë¶„ ë°˜ë³µ</span></div>
                    <button class="btn btn-danger" style="padding:5px 10px; font-size:0.7rem;" onclick="delNoti(${n.id})">ì‚­ì œ</button>
                </div>
            `).join('');
        }
        function delNoti(id) { notifications = notifications.filter(n=>n.id!==id); localStorage.setItem('diet_notis', JSON.stringify(notifications)); renderNotiList(); }
        function completeNoti(id) {
            const n = notifications.find(x=>x.id===id);
            if(n) { n.pending = false; localStorage.setItem('diet_notis', JSON.stringify(notifications)); renderAlertArea(); alert("ì™„ë£Œ! ê³ ìƒí•˜ì…¨ì–´ìš” ğŸ‰"); }
        }
        function renderAlertArea() {
            const area = document.getElementById('nagging-alert-area');
            const pendings = notifications.filter(n=>n.pending);
            if(pendings.length === 0) { area.innerHTML=''; return; }
            area.innerHTML = `
                <div class="card" style="background:#ffebee; border:2px solid #ffcdd2;">
                    <h4 style="color:#c62828;">ğŸ”´ ë¯¸ì™„ë£Œ ì•Œë¦¼!</h4>
                    ${pendings.map(n=>`
                        <div style="display:flex; justify-content:space-between; margin-top:5px;">
                            <span>${n.text}</span>
                            <button class="btn btn-primary" style="padding:5px 10px;" onclick="completeNoti(${n.id})">ì™„ë£Œí•¨</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        function requestNotiPermission() { Notification.requestPermission().then(p=>alert(p)); }

        // === [5] ê¸°ì¡´ ê¸°ëŠ¥ (Goals, Album, etc) ===
        // íƒ­ ì „í™˜
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            // Nav Active ì²˜ë¦¬ ìƒëµ (ê°„ì†Œí™”)
            if(tab==='goals') renderGoalsList('all');
            if(tab==='album') loadAlbumPhotos();
            if(tab==='calendar') renderCalendar();
            if(tab==='community') loadCommunity();
        }

        // Goals (CRUD + AI Food - ê¸°ì¡´ ë¡œì§ ìœ ì§€ ë° ìµœì í™”)
        async function renderGoalsList(filter) {
            const list = document.getElementById('goals-list');
            list.innerHTML = '<div class="spinner"></div>';
            const snap = await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('goals').where('active','==',true).get();
            let goals = snap.docs.map(d=>({id:d.id, ...d.data()}));
            if(filter !== 'all') goals = goals.filter(g=>g.type===filter);
            
            list.innerHTML = goals.map(g => `
                <div class="goal-card">
                    <div style="font-weight:bold;">${g.icon} ${g.title}</div>
                    <div style="font-size:0.8rem; color:#666;">${g.type}</div>
                    <button class="btn btn-danger" style="padding:5px; font-size:0.7rem; float:right;" onclick="deleteGoal('${g.id}')">ì‚­ì œ</button>
                </div>
            `).join('') || '<p style="text-align:center; color:#999;">ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
        async function showGoalModal() {
            const title = prompt("ëª©í‘œ ì´ë¦„:");
            if(!title) return;
            const type = prompt("íƒ€ì… (diet/exercise/water/custom):", "custom");
            await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('goals').add({
                title, type, icon:'ğŸ¯', active:true, createdAt: new Date().toISOString()
            });
            renderGoalsList('all');
        }
        async function deleteGoal(id) {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('goals').doc(id).update({active:false});
                renderGoalsList('all');
            }
        }

        // Album & Timelapse
        async function loadAlbumPhotos() {
            const grid = document.getElementById('photo-grid');
            grid.innerHTML = '<div class="spinner"></div>';
            const snap = await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('photos').where('type','==',currentAlbumTab).orderBy('timestamp','desc').get();
            const photos = snap.docs.map(d=>d.data());
            grid.innerHTML = photos.map(p=>`<div class="photo-item"><img src="${p.url}"></div>`).join('');
        }
        async function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const ref = storage.ref(`photos/${currentUser.uid}/${Date.now()}`);
            await ref.put(file);
            const url = await ref.getDownloadURL();
            await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('photos').add({
                url, type: currentAlbumTab, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            loadAlbumPhotos();
        }
        function showTimelapse() { alert("íƒ€ì„ë©ìŠ¤ ê¸°ëŠ¥ì€ ì‚¬ì§„ì´ 2ì¥ ì´ìƒì¼ ë•Œ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤!"); }

        // Calendar
        function renderCalendar() {
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            document.getElementById('calendar-month-year').innerText = `${y}ë…„ ${m+1}ì›”`;
            const first = new Date(y, m, 1).getDay();
            const last = new Date(y, m+1, 0).getDate();
            let html = "";
            for(let i=0; i<first; i++) html += `<div></div>`;
            for(let i=1; i<=last; i++) html += `<div class="calendar-day">${i}</div>`;
            document.getElementById('calendar-grid').innerHTML = html;
        }
        function changeMonth(d) { currentMonth.setMonth(currentMonth.getMonth()+d); renderCalendar(); }

        // Community
        function loadCommunity() {
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').orderBy('at','desc').limit(20)
            .onSnapshot(snap => {
                const msgs = snap.docs.map(d=>d.data()).reverse();
                document.getElementById('comm-messages').innerHTML = msgs.map(m=>`
                    <div style="margin-bottom:10px;"><b>${m.name}</b>: ${m.text}</div>
                `).join('');
            });
        }
        function sendCommunityMessage() {
            const input = document.getElementById('comm-input');
            if(!input.value) return;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').add({
                name: currentProfile.name, text: input.value, at: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = '';
        }

        // Settings (Backup/Restore)
        async function exportData() {
            const data = { profile: currentProfile, notis: notifications }; // ê°„ì†Œí™”: ì‹¤ì œë¡  ì „ì²´ ì»¬ë ‰ì…˜ ë¤í”„ í•„ìš”
            const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download='backup.json'; a.click();
        }
        function importData() {
            const input = document.createElement('input'); input.type='file';
            input.onchange = async e => {
                const text = await e.target.files[0].text();
                const data = JSON.parse(text);
                if(confirm("ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    alert("ë³µì› ì™„ë£Œ (ë°ëª¨)"); // ì‹¤ì œ êµ¬í˜„ ì‹œ DB ì—…ë°ì´íŠ¸ ë¡œì§ í•„ìš”
                }
            };
            input.click();
        }

        // PWA
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            document.getElementById('pwa-install-area').style.display='block';
        });
        function installPWA() {
            if(deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; }
        }

        // === [6] ì´ˆê¸°í™” ë° ì¸ì¦ ===
        auth.onAuthStateChanged(async user => {
            document.getElementById('loading-screen').classList.add('hidden');
            if(user) {
                currentUser = user;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                const doc = await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('profile').doc('main').get();
                if(doc.exists) {
                    currentProfile = doc.data();
                    document.getElementById('user-greeting').innerText = `${currentProfile.name}ë‹˜ ë°˜ê°€ì›Œìš”!`;
                    document.getElementById('profile-info').innerText = `${currentProfile.height}cm / ëª©í‘œ ${currentProfile.targetWeight}kg`;
                    loadAICoaching();
                    loadChart();
                    renderNotiList();
                    setInterval(updateFastingTimer, 1000);
                    setInterval(checkNotifications, 1000);
                }
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
            }
        });

        function handleLogin() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(e,p).catch(err => {
                if(err.code === 'auth/user-not-found') auth.createUserWithEmailAndPassword(e,p);
                else alert("ì˜¤ë¥˜: "+err.message);
            });
        }
        
        // Chart.js ë¡œë“œ
        async function loadChart() {
            const ctx = document.getElementById('weight-chart');
            const snap = await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('logs').orderBy('date','asc').limit(7).get();
            const data = snap.docs.map(d=>d.data());
            if(weightChart) weightChart.destroy();
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d=>d.date.substr(5)),
                    datasets: [{ label: 'ì²´ì¤‘', data: data.map(d=>d.weight), borderColor: '#667eea', tension: 0.4 }]
                }
            });
        }
        async function addWeight() {
            const w = document.getElementById('weight-input').value;
            if(!w) return;
            const today = new Date().toISOString().split('T')[0];
            await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('logs').doc(today).set({
                date: today, weight: w
            }, {merge:true});
            loadChart();
        }

        // Helper: Init Water
        (function initWater(){
            const div = document.getElementById('water-tracker');
            for(let i=0;i<8;i++) {
                const btn = document.createElement('div');
                btn.innerText='ğŸ’§'; btn.style.fontSize='1.5rem'; btn.style.cursor='pointer';
                btn.onclick = function(){ this.style.opacity = this.style.opacity==='0.3'?'1':'0.3'; };
                div.appendChild(btn);
            }
        })();

        // Modal Helper
        function showModal(title, html, onConfirm) {
            const m = document.createElement('div'); m.className='modal';
            m.innerHTML = `<div class="modal-content"><h3>${title}</h3><div style="margin:15px 0;">${html}</div><div style="text-align:center;"><button class="btn btn-primary" id="modal-ok">í™•ì¸</button> <button class="btn" onclick="this.closest('.modal').remove()">ì·¨ì†Œ</button></div></div>`;
            document.body.appendChild(m);
            document.getElementById('modal-ok').onclick = () => { onConfirm(); m.remove(); };
        }
    </script>
</body>
</html>