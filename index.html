<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="AI 코치와 함께하는 스마트 다이어트 관리 앱">

    <title>Diet Mate v2.5 - 스마트 다이어트 매니저</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <style>
        /* ==================== CSS 변수 (디자인 시스템) ==================== */
        :root {
            /* === 주요 색상 (민트/청록 테마) === */
            --primary: #00B89A;              /* 메인 민트 */
            --primary-dark: #009688;         /* 진한 청록 */
            --primary-light: #00D4AA;        /* 밝은 민트 */
            --secondary: #26A69A;            /* 세컨더리 청록 */
            --accent: #00E5CC;               /* 액센트 민트 */
            --accent-secondary: #4DD0E1;     /* 액센트 시안 */

            /* === 그라데이션 조합용 보조 색상 === */
            --gradient-teal: #009688;        /* 청록 */
            --gradient-cyan: #00BCD4;        /* 시안 */
            --gradient-blue: #2196F3;        /* 파랑 */
            --gradient-purple: #9C27B0;      /* 보라 */
            --gradient-pink: #E91E63;        /* 핑크 */
            --gradient-lime: #7CB342;        /* 라임 */

            /* === 상태 색상 (민트 계열 재조정) === */
            --success: #00C853;              /* 밝은 그린 */
            --success-light: #69F0AE;        /* 연한 그린 */
            --success-dark: #00A044;         /* 진한 그린 */
            --warning: #FFA726;              /* 오렌지 */
            --warning-light: #FFB74D;        /* 밝은 오렌지 */
            --error: #EF5350;                /* 레드 */
            --error-light: #FF8A80;          /* 연한 레드 */
            --info: #00BCD4;                 /* 시안 (청록 계열) */
            --info-light: #4DD0E1;           /* 밝은 시안 */

            /* === 중립 색상 (동일 유지) === */
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fafafa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border: #e0e0e0;
            --border-light: #f0f0f0;

            /* === 그림자 (민트/청록 계열 추가) === */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 12px 40px rgba(0, 0, 0, 0.15);
            --shadow-primary: 0 4px 16px rgba(0, 184, 154, 0.35);      /* 민트 글로우 */
            --shadow-secondary: 0 4px 16px rgba(38, 166, 154, 0.35);   /* 청록 글로우 */
            --shadow-success: 0 4px 12px rgba(0, 200, 83, 0.3);        /* 그린 글로우 */
            --shadow-glow: 0 0 20px rgba(0, 212, 170, 0.5);            /* 강한 글로우 효과 */

            /* === 둥근 모서리 (각진 스타일로 변경) === */
            --radius-xs: 4px;                /* 매우 작음 */
            --radius-sm: 6px;                /* 작음 */
            --radius-md: 8px;                /* 중간 (기본) */
            --radius-lg: 8px;                /* 큼 (8px 고정) */
            --radius-xl: 8px;                /* 매우 큼 (8px 고정) */
            --radius-full: 9999px;           /* 원형 (프로필 등에만 사용) */

            /* === 사이드바 관련 변수 (신규) === */
            --sidebar-width: 260px;          /* 데스크탑 사이드바 너비 */
            --sidebar-collapsed-width: 70px; /* 접힌 사이드바 너비 */
            --sidebar-bg: #ffffff;           /* 사이드바 배경 */
            --sidebar-border: #e0e0e0;       /* 사이드바 테두리 */

            /* === 간격 (동일 유지) === */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* === 전환 효과 (동일 유지) === */
            --transition-fast: 0.15s ease;
            --transition-base: 0.25s ease;
            --transition-slow: 0.35s ease;

            /* === Z-index (사이드바 추가) === */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-sidebar: 1025;               /* 신규: 사이드바 */
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
        }

        /* ==================== 테마 시스템 ==================== */
        /* 다크 모드 */
        [data-theme="dark"] {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #1a202c;
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --text-tertiary: #a0aec0;
            --border: #4a5568;
            --border-light: #2d3748;
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        /* 소프트 파스텔 */
        [data-theme="pastel"] {
            --primary: #ff9a9e;
            --primary-dark: #fbc2eb;
            --primary-light: #ffeaa7;
            --bg-primary: #fef6f6;
            --bg-secondary: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
        }

        /* 하이 컨트라스트 */
        [data-theme="high-contrast"] {
            --primary: #0066cc;
            --primary-dark: #004499;
            --primary-light: #3399ff;
            --bg-primary: #ffffff;
            --bg-secondary: #f0f4f8;
            --text-primary: #000000;
            --text-secondary: #333333;
            --border: #0066cc;
        }

        /* ==================== 화려한 그라데이션 프리셋 ==================== */
        /* 민트 → 시안 → 파랑 (메인 그라데이션) */
        .gradient-vibrant-1 {
            background: linear-gradient(135deg, #00D4AA 0%, #00BCD4 50%, #2196F3 100%);
        }

        /* 청록 → 민트 → 라임 (생동감) */
        .gradient-vibrant-2 {
            background: linear-gradient(135deg, #009688 0%, #00B89A 50%, #7CB342 100%);
        }

        /* 민트 → 시안 → 보라 (대담한) */
        .gradient-vibrant-3 {
            background: linear-gradient(135deg, #00E5CC 0%, #00BCD4 50%, #9C27B0 100%);
        }

        /* 청록 → 핑크 (과감한 대비) */
        .gradient-vibrant-4 {
            background: linear-gradient(135deg, #26A69A 0%, #E91E63 100%);
        }

        /* 민트 → 파랑 (부드러운 생동감) */
        .gradient-vibrant-5 {
            background: linear-gradient(135deg, #00B89A 0%, #2196F3 100%);
        }

        /* 민트 → 청록 (프라이머리 그라데이션) */
        .gradient-primary {
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
        }

        /* 서브틀한 그라데이션 (카드 배경용) */
        .gradient-subtle {
            background: linear-gradient(135deg, #f0fffc 0%, #e0f7f4 100%);
        }

        /* 텍스트 그라데이션 */
        .text-gradient {
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ==================== 기본 스타일 ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* ==================== 랜딩 페이지 ==================== */
        .landing {
            min-height: 100vh;
            background: linear-gradient(135deg, #00D4AA 0%, #00BCD4 50%, #2196F3 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 20px;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .landing-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* ==================== 추가 애니메이션 ==================== */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* 애니메이션 유틸리티 클래스 */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.4s ease-out;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out;
        }

        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }

        .animate-slide-down {
            animation: slideDown 0.3s ease-out;
        }

        .landing-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .landing-subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            margin-bottom: 50px;
            text-align: center;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: var(--radius-full);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--bg-secondary);
            color: var(--primary);
            box-shadow: var(--shadow-xl);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.25), var(--shadow-glow);
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            color: white;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-secondary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 184, 154, 0.4), var(--shadow-glow);
        }

        .btn-secondary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow-success);
        }

        .btn-success:hover {
            background: var(--success-light);
            transform: translateY(-2px);
        }

        .btn-success:active {
            transform: translateY(0) scale(0.98);
        }

        /* ==================== 인증 페이지 ==================== */
        .auth-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            background: white;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-logo-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            border-radius: 8px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .auth-title {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #666;
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            transition: all var(--transition-base);
            background: var(--bg-secondary);
        }

        .form-input:hover {
            border-color: var(--primary-light);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .error-message {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .link-text {
            text-align: center;
            margin-top: 20px;
            color: #667eea;
            cursor: pointer;
            font-weight: bold;
        }

        /* ==================== 대시보드 ==================== */
        .dashboard {
            min-height: 100vh;
            padding-bottom: 80px;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #00D4AA 0%, #00BCD4 50%, #2196F3 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 5px 20px rgba(0, 184, 154, 0.3);
        }

        .header-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 20px;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            border: 1px solid transparent;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 212, 170, 0.25), var(--shadow-glow);
            border: 2px solid transparent;
            background-image:
                linear-gradient(white, white),
                linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            background-origin: border-box;
            background-clip: padding-box, border-box;
        }

        .card:active {
            transform: translateY(-2px) scale(0.99);
            box-shadow: var(--shadow-md);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--text-primary);
        }

        /* ==================== 하단 네비게이션 (8개 탭) - 데스크탑에서 숨김 ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: none; /* 사이드바로 대체 */
            overflow-x: auto;
            padding: 12px 0;
            border-top: 1px solid #e0e0e0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            -webkit-overflow-scrolling: touch;
        }

        .bottom-nav::-webkit-scrollbar {
            height: 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
            padding: 5px 15px;
            min-width: 70px;
            flex-shrink: 0;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 0.7rem;
            font-weight: bold;
            white-space: nowrap;
        }

        /* ==================== 사이드바 네비게이션 (신규) ==================== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #ffffff 0%, #f0fffc 100%);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            z-index: var(--z-sidebar);
            transition: transform var(--transition-base);
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 184, 154, 0.08);
        }

        /* 사이드바 헤더 */
        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-light);
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            color: white;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .sidebar-logo-icon {
            font-size: 2rem;
            animation: pulse 2s infinite;
        }

        .sidebar-logo-text {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: -0.5px;
        }

        /* 사이드바 네비게이션 */
        .sidebar-nav {
            flex: 1;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .nav-item-sidebar {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .nav-item-sidebar::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            transform: scaleY(0);
            transition: transform var(--transition-base);
        }

        .nav-item-sidebar:hover {
            background: linear-gradient(135deg, #f0fffc 0%, #e0f7f4 100%);
            color: var(--primary);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .nav-item-sidebar:hover::before {
            transform: scaleY(1);
        }

        .nav-item-sidebar.active {
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .nav-item-sidebar.active::before {
            transform: scaleY(1);
            background: white;
        }

        .nav-icon-sidebar {
            font-size: 1.5rem;
            min-width: 24px;
            transition: transform var(--transition-base);
        }

        .nav-item-sidebar:hover .nav-icon-sidebar {
            transform: scale(1.2) rotate(5deg);
        }

        .nav-item-sidebar.active .nav-icon-sidebar {
            transform: scale(1.15);
        }

        .nav-label-sidebar {
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
        }

        /* 사이드바 푸터 */
        .sidebar-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-light);
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, #f0fffc 0%, #e0f7f4 100%);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .sidebar-user:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .sidebar-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .sidebar-user-info {
            flex: 1;
        }

        .sidebar-user-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-user-status {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* 메인 컨텐츠 영역 (사이드바만큼 왼쪽 마진) */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: margin-left var(--transition-base);
        }

        /* 모바일 햄버거 버튼 */
        .mobile-menu-btn {
            display: none; /* 데스크탑에서는 숨김 */
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: calc(var(--z-sidebar) + 1);
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: var(--radius-md);
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-primary);
            transition: all var(--transition-base);
            align-items: center;
            justify-content: center;
        }

        .mobile-menu-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-glow);
        }

        /* 사이드바 오버레이 (모바일) */
        .sidebar-overlay {
            display: none; /* 기본 숨김 */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: calc(var(--z-sidebar) - 1);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* ==================== 탭 컨텐츠 ==================== */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeInUp 0.4s ease-out;
        }

        /* ==================== 홈 탭: 건강 지표 ==================== */
        .health-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .metric-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
            border: 1px solid transparent;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }

        .metric-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .metric-unit {
            font-size: 0.9rem;
            color: #999;
        }

        .progress-section {
            background: linear-gradient(135deg, #009688 0%, #00B89A 50%, #7CB342 100%);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        /* 진행률 섹션 shimmer 효과 */
        .progress-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 3s infinite;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        /* 페이드인 애니메이션 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 슬라이드인 애니메이션 */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* 펄스 애니메이션 (중요 요소 강조) */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .progress-bar-container {
            background: rgba(255,255,255,0.3);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: white;
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* ==================== 홈 탭: AI 채팅 ==================== */
        .ai-chat-section {
            background: white;
            border-radius: 20px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .ai-chat-summary {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-summary:hover {
            background: #f8f9fa;
            border-radius: 20px;
        }

        .ai-chat-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .ai-chat-details.open {
            max-height: 500px;
        }

        .ai-chat-messages {
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            border-top: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
        }

        .ai-message {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 12px;
            animation: slideIn 0.3s;
        }

        .ai-message.user {
            background: #667eea;
            color: white;
            margin-left: 20%;
        }

        .ai-message.assistant {
            background: #f5f5f5;
            color: #333;
            margin-right: 20%;
        }

        .ai-chat-input-area {
            padding: 15px;
            display: flex;
            gap: 10px;
        }

        .ai-chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
        }

        .ai-chat-send {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== 홈 탭: 스마트 물 마시기 ==================== */
        .water-settings {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .water-settings input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }

        .unit-label {
            font-weight: bold;
            color: #667eea;
            font-size: 1rem;
        }

        /* [수정] 물 마시기 화면이 폰에서 잘리는 문제 해결 */
        .water-tracker {
            display: flex;
            flex-wrap: wrap;       /* 줄바꿈 허용 (이게 없어서 잘린 겁니다) */
            gap: 10px;
            justify-content: center;
        }

        .water-cup {
            width: calc(25% - 10px);  /* 한 줄에 4개 */
            aspect-ratio: 1;
            background: #e3f2fd;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 60px;  /* 최소 너비 보장 */
        }

        .water-cup.filled {
            background: #2196f3;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        /* ==================== 홈 탭: 영양 대시보드 ==================== */
        .nutrition-summary {
            text-align: center;
            font-size: 1rem;
            color: #666;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .nutrition-summary span {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .nutrition-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .nutrition-card:hover {
            transform: translateY(-3px);
        }

        .nutrition-calories {
            background: linear-gradient(135deg, #26A69A 0%, #E91E63 100%);
        }

        .nutrition-carbs {
            background: linear-gradient(135deg, #00B89A 0%, #2196F3 100%);
        }

        .nutrition-protein {
            background: linear-gradient(135deg, #00E5CC 0%, #00BCD4 50%, #9C27B0 100%);
        }

        .nutrition-fat {
            background: linear-gradient(135deg, #00D4AA 0%, #00BCD4 50%, #2196F3 100%);
        }

        .nutrition-label {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .nutrition-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .nutrition-unit {
            font-size: 0.85rem;
            color: #666;
        }

        .nutrition-remaining {
            font-size: 0.75rem;
            color: #4caf50;
            margin-top: 4px;
            font-weight: 600;
        }

        .nutrition-remaining.over {
            color: #ff5252;
        }

        .nutrition-chart-container {
            max-width: 300px;
            margin: 0 auto;
            padding: 20px 0;
        }


        /* 입력 방법 선택 버튼 */
        .input-method-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .input-method-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .input-method-btn:active {
            transform: translateY(0);
        }

        /* ==================== 식사 직접 입력 버튼 ==================== */
        .meal-input-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0 20px 0;
        }

        .meal-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .meal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .meal-btn:active {
            transform: translateY(0);
        }

        .meal-emoji {
            font-size: 1.8rem;
        }

        .meal-label {
            font-weight: 600;
            color: #333;
        }

        .meal-btn-breakfast:hover {
            border-color: #ff9800;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        }

        .meal-btn-lunch:hover {
            border-color: #4caf50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }

        .meal-btn-dinner:hover {
            border-color: #9c27b0;
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        }

        .meal-btn-snack:hover {
            border-color: #f44336;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        /* ==================== 식사 입력 모달 ==================== */
        .meal-input-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal-backdrop);
            padding: 20px;
            transition: background var(--transition-base);
            backdrop-filter: blur(0px);
        }

        .meal-input-modal-overlay.show {
            display: flex;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            animation: overlayFadeIn 0.3s ease-out;
        }

        @keyframes overlayFadeIn {
            from {
                background: rgba(0, 0, 0, 0);
                backdrop-filter: blur(0px);
            }
            to {
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(4px);
            }
        }

        .meal-input-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .meal-input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .meal-input-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #333;
        }

        .meal-input-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group-meal {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label-meal {
            font-weight: 600;
            color: #555;
            font-size: 0.95rem;
        }

        .form-input-meal {
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all var(--transition-base);
            background: var(--bg-secondary);
        }

        .form-input-meal:hover {
            border-color: var(--primary-light);
        }

        .form-input-meal:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .ai-analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .ai-analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .ai-analyze-btn:active {
            transform: translateY(0);
        }

        .ai-analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .nutrition-result {
            background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f0 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .nutrition-result.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .nutrition-result-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .nutrition-result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .nutrition-result-item {
            background: white;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .nutrition-result-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .nutrition-result-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
        }

        .manual-input-toggle {
            text-align: center;
            margin-top: 15px;
            color: #667eea;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .manual-input-toggle:hover {
            text-decoration: underline;
        }

        .manual-input-fields {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .manual-input-fields.show {
            display: grid;
        }

        .save-meal-btn {
            background: var(--success);
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-base);
            margin-top: var(--spacing-lg);
            box-shadow: var(--shadow-success);
            position: relative;
            overflow: hidden;
        }

        .save-meal-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .save-meal-btn:active::before {
            width: 300px;
            height: 300px;
        }

        .save-meal-btn:hover {
            background: var(--success-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(76, 175, 80, 0.4);
        }

        .save-meal-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* ==================== 플랜 탭 - 목표 체크리스트 ==================== */
        .goal-checklist {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }

        .goal-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .goal-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .goal-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #00D4AA;
        }

        .goal-icon {
            font-size: 1.5rem;
        }

        .goal-text {
            flex: 1;
            font-size: 1rem;
            color: #333;
        }

        .goal-status {
            font-size: 0.85rem;
            color: #666;
            background: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .goal-status.success {
            background: #d4edda;
            color: #155724;
        }

        .goal-status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .goal-status.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .edit-goal-btn {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s ease;
            padding: 4px;
        }

        .edit-goal-btn:hover {
            opacity: 1;
        }

        .goal-check {
            font-size: 1.5rem;
            color: #00D4AA;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .goal-item input[type="checkbox"]:checked ~ .goal-check {
            opacity: 1;
        }

        .goal-item input[type="checkbox"]:checked ~ .goal-text {
            text-decoration: line-through;
            color: #999;
        }

        /* 목표 달성률 */
        .goal-progress {
            margin: 25px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* 커스텀 목표 입력 */
        .custom-goal-input {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .custom-goal-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .custom-goal-input button {
            padding: 12px 20px;
            background: #00D4AA;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-goal-input button:hover {
            background: #00b894;
            transform: translateY(-2px);
        }

        /* 커스텀 목표 리스트 */
        .custom-goals {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .custom-goal-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #fff3cd;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
        }

        .custom-goal-item .delete-btn {
            margin-left: auto;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .custom-goal-item .delete-btn:hover {
            opacity: 1;
            color: #dc3545;
        }

        /* 주간 통계 */
        .weekly-stats {
            display: flex;
            justify-content: space-around;
            padding: 20px 0;
            gap: 8px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-day {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
            color: #666;
            margin: 0 auto;
            transition: all 0.3s ease;
        }

        .stat-circle.today {
            background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.4);
            transform: scale(1.1);
        }

        .stat-circle.future {
            background: #f8f9fa;
            color: #ccc;
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .stat-circle {
                width: 40px;
                height: 40px;
                font-size: 0.75rem;
            }

            .stat-day {
                font-size: 0.8rem;
            }

            .weekly-stats {
                gap: 4px;
                padding: 15px 0;
            }
        }
        }

        .plan-activity {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .plan-value {
            font-size: 0.9rem;
            color: #666;
        }

        .plan-delete {
            color: #f44336;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* ==================== 시간표 ==================== */
        .timetable-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .timetable-row {
            display: flex;
            gap: 12px;
            align-items: stretch;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            transition: all 0.2s;
        }

        .timetable-row:hover {
            background: #e9ecef;
        }

        .timetable-time {
            font-size: 1rem;
            font-weight: 600;
            color: #667eea;
            min-width: 60px;
            display: flex;
            align-items: center;
        }

        .timetable-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timetable-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.95rem;
            background: white;
            transition: all 0.2s;
            font-family: inherit;
        }

        .timetable-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .timetable-input::placeholder {
            color: #bbb;
        }

        .timetable-emoji-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .timetable-emoji-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .timetable-emoji-picker {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 12px;
            display: none;
            z-index: 1000;
            margin-top: 5px;
        }

        .timetable-emoji-picker.show {
            display: block;
        }

        .timetable-emoji-option {
            display: inline-block;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            font-size: 1.5rem;
        }

        /* 플랜 탭 모바일 최적화 */
        @media (max-width: 768px) {
            .timetable-container {
                gap: 8px;
                width: 100%;
                padding: 0;
            }

            .timetable-row {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px;
                margin: 0;
                width: 100%;
                box-sizing: border-box;
            }

            .timetable-time {
                font-size: 0.85rem;
                min-width: 50px;
                max-width: 50px;
                flex-shrink: 0;
                padding: 0;
            }

            .timetable-input-wrapper {
                flex: 1;
                min-width: 0;
                gap: 6px;
            }

            .timetable-input {
                flex: 1;
                min-width: 0;
                padding: 8px 10px;
                font-size: 0.85rem;
                width: 100%;
                box-sizing: border-box;
            }

            .timetable-emoji-btn {
                width: 36px;
                height: 36px;
                min-width: 36px;
                flex-shrink: 0;
                font-size: 1.1rem;
            }
        }

        .timetable-emoji-option:hover {
            background: #f0f4ff;
        }

        .timetable-clear-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .timetable-clear-btn:hover {
            background: #ffebee;
            color: #f44336;
        }

        /* ==================== 단식 탭 ==================== */
        .fasting-timer-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }

        .fasting-svg-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 20px auto;
        }

        .fasting-circle-bg {
            fill: none;
            stroke: rgba(255,255,255,0.2);
            stroke-width: 15;
        }

        .fasting-circle-progress {
            fill: none;
            stroke: white;
            stroke-width: 15;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 1s linear;
        }

        .fasting-time-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .fasting-time-main {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .fasting-time-sub {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .fasting-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .fasting-btn {
            padding: 12px 30px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .fasting-btn:hover {
            background: white;
            color: #667eea;
        }

        /* 배지 그리드 */
        .fasting-badges-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .badge-item {
            text-align: center;
            padding: 15px 10px;
            border-radius: 12px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .badge-item.unlocked {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            transform: scale(1.05);
        }

        .badge-emoji {
            font-size: 2rem;
            margin-bottom: 5px;
            filter: grayscale(100%);
        }

        .badge-item.unlocked .badge-emoji {
            filter: grayscale(0%);
            animation: bounce 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .badge-name {
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 5px;
        }

        /* 월간 리포트 */
        .fasting-monthly-report {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .monthly-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .monthly-stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }

        .monthly-stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .monthly-stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* 단식 달력 */
        .fasting-calendar-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .fasting-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            background: #f8f9fa;
            font-size: 0.85rem;
            padding: 5px;
        }

        .calendar-day.fasted {
            background: linear-gradient(135deg, #a8e6cf 0%, #56ab2f 100%);
            color: white;
            font-weight: bold;
        }

        .calendar-day.today {
            border: 2px solid #667eea;
        }

        .calendar-day-number {
            font-weight: 600;
        }

        .calendar-day-hours {
            font-size: 0.7rem;
            margin-top: 2px;
        }

        /* 체중 차트 카드 */
        .fasting-weight-chart-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* 물 섭취 리마인더 */
        .fasting-water-reminder {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* 주간/월간 리포트 텍스트 */
        .fasting-weekly-report, .fasting-monthly-report-text {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* 단식 스트릭 & 통계 카드 */
        .fasting-streak-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .fasting-streak-card > div > div {
            color: white !important;
        }

        /* 주간 단식 현황 카드 */
        .fasting-weekly-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .weekly-fasting-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .weekly-day-item {
            text-align: center;
            padding: 10px 5px;
            border-radius: 12px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .weekly-day-item.completed {
            background: linear-gradient(135deg, #a8e6cf 0%, #56ab2f 100%);
            color: white;
            font-weight: bold;
        }

        .weekly-day-item.today {
            border: 3px solid #667eea;
            font-weight: bold;
        }

        .weekly-day-label {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .weekly-day-hours {
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* 오늘의 누적 요약 */
        .fasting-today-summary {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* 새로운 누적 시간 카드 */
        .fasting-accumulated-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: #333;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(255, 154, 158, 0.3);
        }

        .accumulated-time-large {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            color: #ff5252;
        }

        .accumulated-sessions {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.85rem;
            opacity: 0.85;
            color: #666;
        }

        /* 새로운 프리셋 버튼 (그리드 스타일) */
        .fasting-preset-btn-new {
            padding: 18px 12px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
            line-height: 1.4;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .fasting-preset-btn-new:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.35);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 5px 18px rgba(0, 0, 0, 0.3);
        }

        .fasting-preset-btn-new:active {
            transform: translateY(0);
        }

        /* 새로운 컨트롤 버튼 */
        .fasting-btn-pause, .fasting-btn-resume, .fasting-btn-stop {
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .fasting-btn-pause {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            flex: 1;
        }

        .fasting-btn-pause:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }

        .fasting-btn-resume {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            flex: 1;
        }

        .fasting-btn-resume:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .fasting-btn-stop {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            flex: 1;
        }

        .fasting-btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(250, 112, 154, 0.4);
        }

        /* 팁 카드 */
        .fasting-tips-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* 단식 세션 아이템 */
        .fasting-session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: #555;
        }

        .fasting-session-item:last-child {
            border-bottom: none;
        }

        .fasting-duration-input {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .fasting-duration-input input {
            width: 80px;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid white;
            background: rgba(255,255,255,0.9);
            text-align: center;
            font-weight: bold;
        }

        .fasting-info {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .fasting-info details {
            margin-bottom: 15px;
        }

        .fasting-info summary {
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .fasting-info details[open] summary {
            background: #667eea;
            color: white;
        }

        /* ==================== 앨범 탭 ==================== */
        .album-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .album-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .album-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .photo-item {
            aspect-ratio: 1;
            background: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-date-label {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 8px;
            font-size: 0.7rem;
            text-align: center;
        }

        .add-photo {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #999;
            border: 2px dashed #ddd;
            background: #fafafa;
        }

        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .photo-modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: white;
        }

        .photo-modal-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-modal-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 15px;
        }

        .photo-modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .photo-modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== 앨범 탭: 텍스트 카드 ==================== */
        .text-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 150px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .text-card:hover {
            transform: translateY(-3px);
        }

        .text-card-emoji {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .text-card-content {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            max-height: 60px;
            overflow: hidden;
            line-height: 1.4;
        }

        .text-card-nutrition {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #555;
            font-weight: 500;
        }

        .text-card.category-body {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .text-card.category-food {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .text-card.category-exercise {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }

        /* ==================== 앨범 탭: 배치 작업 (Phase 4) ==================== */
        .album-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .album-header .card-title {
            margin: 0;
        }

        .select-mode-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .select-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .select-mode-btn.active {
            background: #ff5252;
        }

        .select-action-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .select-action-bar.hidden {
            display: none;
        }

        .selected-count {
            font-weight: bold;
            font-size: 1rem;
        }

        .select-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.85rem;
            background: white;
            color: #667eea;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .cancel-btn {
            background: #ff5252;
            color: white;
        }

        /* 선택 모드: 체크박스 오버레이 */
        .select-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            cursor: pointer;
            transition: all 0.3s;
        }

        .select-checkbox.checked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }

        .select-checkbox.checked::after {
            content: '✓';
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        /* 선택된 항목 강조 */
        .photo-item.selected {
            outline: 3px solid #667eea;
            outline-offset: -3px;
            opacity: 0.8;
        }

        /* ==================== 캘린더 탭 ==================== */
        .calendar {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px 10px;
        }

        .calendar-month {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-label {
            text-align: center;
            font-weight: bold;
            color: #666;
            padding: 10px 0;
            font-size: 0.9rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: #f5f5f5;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 0.75rem;
            padding: 8px 4px;
            overflow: hidden;
        }

        .calendar-day-number {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .calendar-day-preview {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: center;
            width: 100%;
        }

        .preview-item {
            font-size: 0.7rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .calendar-day.today {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .calendar-day.today .calendar-day-number {
            color: white;
        }

        .calendar-day.has-data {
            border: 2px solid #4caf50;
        }

        .calendar-day.future {
            opacity: 0.4;
            cursor: default;
        }

        /* 주간 요약 카드 */
        .weekly-summary-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .weekly-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .weekly-summary-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }

        .summary-toggle-btn {
            background: #f0f0f0;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .weekly-summary-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .summary-stat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
        }

        .summary-stat.green {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        }

        .summary-stat.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .summary-stat.orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .summary-stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .summary-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .summary-stat-change {
            font-size: 0.8rem;
            margin-top: 5px;
            opacity: 0.9;
        }

        .summary-loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        /* AI 코칭 카드 */
        .ai-coaching-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .ai-coach-header {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .ai-coach-message {
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .calendar-day::after {
            content: '';
            position: absolute;
            bottom: 3px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #4caf50;
            display: none;
        }

        .calendar-day.has-data::after {
            display: block;
        }

        .day-report-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .day-report-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .day-report-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #667eea;
        }

        .day-report-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .day-report-section:last-child {
            border-bottom: none;
        }

        .day-report-section h4 {
            margin-bottom: 10px;
            color: #333;
        }

        /* ==================== 소통 탭 ==================== */
        .chat-container {
            height: calc(100vh - 350px);
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            max-width: 80%;
            animation: slideIn 0.3s;
        }

        .chat-message.mine {
            margin-left: auto;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.8rem;
            color: #666;
        }

        .message-author {
            font-weight: bold;
        }

        .message-time {
            color: #999;
        }

        .message-bubble {
            padding: 12px 15px;
            border-radius: 15px;
            background: #f5f5f5;
        }

        .chat-message.mine .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-input-container {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
        }

        .send-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== AI 토스트 팝업 ==================== */
        .ai-toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            max-width: 90%;
            width: 350px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: slideUp 0.4s ease-out;
        }

        .ai-toast.hidden {
            bottom: -200px;
            opacity: 0;
            pointer-events: none;
        }

        .ai-toast-content {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .ai-toast-icon {
            font-size: 2.5rem;
            animation: bounce 1s infinite;
        }

        .ai-toast-message {
            flex: 1;
            font-size: 1rem;
            line-height: 1.4;
            font-weight: 500;
        }

        .ai-toast-button {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-toast-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        @keyframes slideUp {
            from {
                bottom: -200px;
                opacity: 0;
            }
            to {
                bottom: 80px;
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }

        /* ==================== 스마트 병합 Bottom Sheet ==================== */
        .merge-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: flex-end;
            transition: opacity 0.3s;
        }

        .merge-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .merge-sheet {
            background: white;
            width: 100%;
            max-height: 70vh;
            border-radius: 25px 25px 0 0;
            padding: 30px 20px 20px;
            transform: translateY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.2);
        }

        .merge-overlay.hidden .merge-sheet {
            transform: translateY(100%);
        }

        .merge-header h3 {
            margin: 0 0 5px 0;
            font-size: 1.3rem;
            color: #333;
        }

        .merge-subtitle {
            margin: 0 0 20px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .merge-content {
            margin-bottom: 25px;
        }

        .merge-preview {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin-bottom: 20px;
            gap: 15px;
        }

        .merge-meal {
            flex: 1;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
        }

        .previous-meal {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .current-meal {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }

        .meal-label {
            font-size: 0.75rem;
            color: #555;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .meal-name {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .meal-calories {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: bold;
        }

        .merge-plus {
            font-size: 1.5rem;
            color: #667eea;
            font-weight: bold;
        }

        .merge-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .total-calories {
            color: #667eea;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .merge-actions {
            display: flex;
            gap: 12px;
        }

        .merge-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .merge-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .merge-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .merge-cancel {
            background: #f0f0f0;
            color: #666;
        }

        .merge-cancel:hover {
            background: #e0e0e0;
        }

        /* ==================== Phase 4: 카테고리 변경 모달 ==================== */
        .category-change-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.3s;
        }

        .category-change-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .category-change-modal {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh; /* 화면 높이의 90%로 제한 */
            overflow-y: auto; /* 스크롤 가능 */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transform: scale(1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .category-change-overlay.hidden .category-change-modal {
            transform: scale(0.9);
        }

        .category-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: #333;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .modal-close-btn:hover {
            color: #333;
        }

        .category-modal-description {
            color: #666;
            font-size: 0.95rem;
            margin: 0 0 20px 0;
        }

        .category-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .category-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .category-option:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .category-option.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .category-option.active .category-emoji {
            filter: brightness(1.2);
        }

        .category-emoji {
            font-size: 1.8rem;
        }

        .category-name {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .category-option.active .category-name {
            color: white;
        }

        /* ==================== Phase 4: 수동 병합 모달 ==================== */
        .manual-merge-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: flex-end;
            transition: opacity 0.3s;
        }

        .manual-merge-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .manual-merge-sheet {
            background: white;
            width: 100%;
            max-height: 70vh;
            border-radius: 25px 25px 0 0;
            padding: 25px 20px 20px;
            transform: translateY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .manual-merge-overlay.hidden .manual-merge-sheet {
            transform: translateY(100%);
        }

        .manual-merge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .manual-merge-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: #333;
        }

        .manual-merge-description {
            color: #666;
            font-size: 0.9rem;
            margin: 0 0 15px 0;
        }

        .meal-list {
            overflow-y: auto;
            flex: 1;
            margin: 0 -20px;
            padding: 0 20px;
        }

        .meal-list-loading {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .meal-list-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .meal-list-item:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateX(3px);
        }

        .meal-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .meal-item-date {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .meal-item-time {
            font-size: 0.8rem;
            color: #999;
        }

        .meal-item-name {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .meal-item-calories {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: bold;
        }

        .meal-list-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        /* ==================== 알림 탭 ==================== */
        .notification-list {
            margin-top: 15px;
        }

        .notification-item {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .notification-details {
            font-size: 0.85rem;
            color: #666;
        }

        .notification-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .notification-edit {
            color: #667eea;
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }

        .notification-edit:hover {
            transform: scale(1.2);
        }

        .notification-delete {
            color: #f44336;
            cursor: pointer;
            font-size: 1.3rem;
            transition: transform 0.2s;
        }

        .notification-delete:hover {
            transform: scale(1.2);
        }

        /* ==================== 누적 단식 통계 ==================== */
        .fasting-stats {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea20, #764ba220);
            border-radius: 15px;
        }

        .accumulated-time {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 15px 0;
        }

        .fasting-sessions {
            margin-top: 20px;
        }

        .fasting-session-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* ==================== 알림 권한 배너 ==================== */
        .notification-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(238, 90, 111, 0.3);
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .notification-banner-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-banner-icon { font-size: 1.8rem; }

        .notification-banner-text { flex: 1; }

        .notification-banner-title {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .notification-banner-desc {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .notification-banner-button {
            padding: 10px 20px;
            background: white;
            color: #ff6b6b;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .notification-banner-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        /* D-Day 표시 스타일 */
        .dday-display {
            text-align: center;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            color: white;
            margin-top: 10px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .dday-main {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .dday-sub {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* 권장 칼로리 표시 */
        .calorie-recommendation {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 15px;
            border-radius: 15px;
            margin-top: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .calorie-rec-title {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .calorie-rec-desc {
            font-size: 0.8rem;
            color: #777;
            margin-top: 5px;
        }

        /* ==================== 설정 탭 ==================== */
        .profile-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }

        .profile-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .profile-info p {
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 15px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .settings-item {
            padding: 20px;
            background: white;
            border-radius: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .logout-btn {
            background: #ff5252;
            color: white;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
        }

        /* ==================== PWA 설치 배너 ==================== */
        .pwa-install-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .pwa-install-text {
            flex: 1;
        }

        .pwa-install-text strong {
            display: block;
            margin-bottom: 5px;
        }

        .pwa-install-btn {
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ==================== 모달 공통 스타일 ==================== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: var(--z-modal-backdrop);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
            backdrop-filter: blur(4px);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            animation: fadeIn 0.3s ease-out;
            backdrop-filter: blur(4px);
            overflow-y: auto; /* 모달 자체 스크롤 */
            -webkit-overflow-scrolling: touch; /* iOS 부드러운 스크롤 */
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: scaleIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* 프로필 설정 모달 모바일 최적화 */
        @media (max-width: 768px) {
            #initialProfileSetupModal {
                align-items: flex-start;
            }

            #initialProfileSetupModal .modal-content {
                background: white;
                border-radius: 20px 20px 0 0;
                padding: 20px;
                padding-bottom: 80px; /* 하단 고정 버튼 공간 확보 */
                margin: 0;
                margin-top: auto;
                min-height: 100vh;
                max-height: none;
                width: 100%;
                max-width: 100%;
                position: relative;
                animation: slideUp 0.35s ease-out;
            }

            #initialProfileSetupModal .modal-content h3 {
                position: sticky;
                top: 0;
                background: white;
                padding: 15px 0;
                margin: -20px -20px 20px -20px;
                padding: 15px 20px;
                border-bottom: 1px solid #f0f0f0;
                z-index: 10;
            }

            #initialProfileSetupModal .modal-content > p {
                margin-top: 0;
            }

            #initialProfileSetupModal .merge-btn.merge-confirm {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                margin: 0;
                padding: 18px;
                border-radius: 0;
                z-index: 11;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            }

            /* 프로필 재설정 모달 스크롤 최적화 */
            .category-change-modal {
                max-height: 85vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: var(--spacing-lg);
            color: var(--primary);
        }

        .modal-footer {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        .modal-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .modal-btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .modal-btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .modal-btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .modal-btn-secondary:hover {
            background: var(--border);
        }

        /* ==================== 차트 컨테이너 ==================== */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 10px;
        }

        /* ==================== 반응형 ==================== */
        @media (max-width: 768px) {
            /* 텍스트 잘림 방지 */
            * {
                word-wrap: break-word;
                overflow-wrap: break-word;
                hyphens: auto;
            }

            /* 카드 반응형 */
            .card {
                max-width: 100%;
                box-sizing: border-box;
                margin: 10px 0;
                padding: 15px;
            }

            .card-title {
                font-size: 1.1rem;
            }

            /* 식사 버튼 2열로 */
            .meal-input-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            /* 시간표 텍스트 크기 조정 */
            .timetable-time {
                min-width: 50px;
                font-size: 0.9rem;
            }

            .timetable-input {
                font-size: 0.85rem;
                padding: 8px 10px;
            }

            /* 영양 카드 */
            .nutrition-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .nutrition-card {
                padding: 12px;
            }

            .nutrition-value {
                font-size: 1.5rem;
            }


            /* 입력 방법 버튼 */
            .input-method-btn {
                font-size: 0.9rem;
                padding: 10px 15px;
            }

            /* 버튼 전체 */
            .btn, button {
                max-width: 100%;
                padding: 12px 20px;
                font-size: 0.95rem;
            }

            /* 입력 필드 (iOS 자동 줌 방지) */
            input, select, textarea {
                max-width: 100%;
                font-size: 16px !important;
            }

            /* 헤더 */
            .header {
                padding: 20px 15px 20px 80px; /* 왼쪽에 햄버거 메뉴 공간 확보 */
                border-radius: 0 0 20px 20px;
            }

            .header-title {
                font-size: 1.5rem;
            }

            /* 컨텐츠 */
            .content {
                padding: 15px;
            }

            /* 하단 네비게이션 */
            .bottom-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding: 10px 5px;
            }

            .bottom-nav::-webkit-scrollbar {
                display: none;
            }

            .nav-item {
                min-width: 65px;
                padding: 5px 8px;
            }

            .nav-icon {
                font-size: 1.3rem;
            }

            .nav-label {
                font-size: 0.65rem;
            }

            /* 물 마시기 */
            .water-tracker {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 8px;
                justify-content: center;
            }

            .water-cup {
                width: calc(25% - 8px);
                min-width: 60px;
                aspect-ratio: 1;
            }

            /* ==================== 사이드바 모바일 드래워 ==================== */
            /* 사이드바를 드래워로 변환 */
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                box-shadow: 2px 0 20px rgba(0, 0, 0, 0.2);
                transition: transform var(--transition-base);
                z-index: 1030; /* 오버레이보다 위 */
            }

            /* 사이드바 열린 상태 */
            .sidebar.mobile-open {
                transform: translateX(0);
            }

            /* 메인 컨텐츠 마진 제거 */
            .main-content {
                margin-left: 0;
            }

            /* 햄버거 버튼 표시 */
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1025;
                background: linear-gradient(135deg, #00D4AA 0%, #009688 100%);
                color: white;
                width: 50px;
                height: 50px;
                border: none;
                border-radius: 8px;
                box-shadow: var(--shadow-primary);
                cursor: pointer;
                transition: all var(--transition-base);
            }

            .mobile-menu-btn:hover {
                transform: scale(1.05);
                box-shadow: var(--shadow-glow);
            }

            .mobile-menu-btn:active {
                transform: scale(0.95);
            }

            /* 오버레이 */
            .sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1029;
                opacity: 0;
                transition: opacity var(--transition-base);
            }

            .sidebar-overlay.active {
                display: block;
                opacity: 1;
            }
        }

        @media (max-width: 480px) {
            .landing-title {
                font-size: 2.2rem;
            }

            .landing-subtitle {
                font-size: 1rem;
            }

            /* 건강 지표 3열 유지 (가로 배치) */
            .health-metrics {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .metric-card {
                padding: 12px 8px;
            }

            .metric-label {
                font-size: 0.75rem;
            }

            .metric-value {
                font-size: 1.2rem;
            }

            .metric-unit {
                font-size: 0.75rem;
            }

            /* 사진 그리드 2열로 */
            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* 식사 버튼 모바일 최적화 */
            .meal-btn {
                padding: 10px 6px;
                font-size: 0.85rem;
            }

            .meal-emoji {
                font-size: 1.5rem;
            }

            /* 모달 패딩 줄이기 */
            .meal-input-modal,
            .day-report-content {
                padding: 20px;
            }

            /* 테이블 오버플로우 방지 */
            .timetable-row {
                gap: 8px;
                padding: 10px;
            }

            /* 사이드바 전체 너비 */
            .sidebar {
                width: 100%;
            }
        }

        @media (max-width: 360px) {
            .card {
                padding: 12px;
                margin: 8px 0;
            }

            /* 식사 버튼 더 작게 */
            .meal-input-buttons {
                gap: 8px;
            }

            .meal-btn {
                padding: 8px 4px;
            }

            /* 영양 카드 간격 */
            .nutrition-grid {
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <!-- 랜딩 페이지 -->
    <div id="landing" class="landing">
        <div class="landing-logo">💪</div>
        <h1 class="landing-title">Diet Mate</h1>
        <p class="landing-subtitle">AI와 함께하는<br>스마트 다이어트 여정</p>
        <button class="btn btn-primary" onclick="showAuth()">시작하기</button>
    </div>

    <!-- 인증 페이지 -->
    <div id="auth" class="auth-container hidden">
        <div class="auth-logo">
            <div class="auth-logo-icon">💪</div>
        </div>

        <h2 class="auth-title" id="authTitle">로그인</h2>

        <div class="error-message" id="authError"></div>
        <div class="success-message" id="authSuccess"></div>

        <form id="authForm">
            <div class="form-group">
                <label class="form-label">이메일</label>
                <input type="email" class="form-input" id="email" required>
            </div>

            <div class="form-group">
                <label class="form-label">비밀번호</label>
                <input type="password" class="form-input" id="password" required>
            </div>

            <div class="form-group" id="signupFields" style="display: none;">
                <label class="form-label">이름</label>
                <input type="text" class="form-input" id="displayName">

                <label class="form-label" style="margin-top: 15px;">목표 체중 (kg)</label>
                <input type="number" class="form-input" id="goalWeight" step="0.1">

                <label class="form-label" style="margin-top: 15px;">시작 체중 (kg)</label>
                <input type="number" class="form-input" id="startWeight" step="0.1">
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                <span id="authButtonText">로그인</span>
            </button>
        </form>

        <p class="link-text" onclick="toggleAuthMode()">
            <span id="authToggleText">계정이 없으신가요? 회원가입</span>
        </p>
    </div>

    <!-- 알림 권한 배너 -->
    <div id="notificationBanner" class="notification-banner hidden">
        <div class="notification-banner-content">
            <div class="notification-banner-icon">🔔</div>
            <div class="notification-banner-text">
                <div class="notification-banner-title">알림 받기</div>
                <div class="notification-banner-desc">식사 시간과 운동 알림을 받으세요</div>
            </div>
        </div>
        <button class="notification-banner-button" onclick="requestNotificationPermission()">허용</button>
    </div>

    <!-- 대시보드 -->
    <div id="dashboard" class="dashboard hidden">
        <!-- 사이드바 네비게이션 -->
        <aside class="sidebar" id="sidebar">
            <!-- 사이드바 헤더 -->
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span class="sidebar-logo-icon">💪</span>
                    <span class="sidebar-logo-text">Diet Mate</span>
                </div>
            </div>

            <!-- 사이드바 메뉴 -->
            <nav class="sidebar-nav">
                <div class="nav-item-sidebar active" onclick="switchTab('home')" data-tab="home">
                    <span class="nav-icon-sidebar">🏠</span>
                    <span class="nav-label-sidebar">홈</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('plan')" data-tab="plan">
                    <span class="nav-icon-sidebar">📋</span>
                    <span class="nav-label-sidebar">플랜</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('fasting')" data-tab="fasting">
                    <span class="nav-icon-sidebar">⏱️</span>
                    <span class="nav-label-sidebar">단식</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('album')" data-tab="album">
                    <span class="nav-icon-sidebar">📸</span>
                    <span class="nav-label-sidebar">앨범</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('calendar')" data-tab="calendar">
                    <span class="nav-icon-sidebar">📅</span>
                    <span class="nav-label-sidebar">캘린더</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('community')" data-tab="community">
                    <span class="nav-icon-sidebar">💬</span>
                    <span class="nav-label-sidebar">소통</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('notification')" data-tab="notification">
                    <span class="nav-icon-sidebar">🔔</span>
                    <span class="nav-label-sidebar">알림</span>
                </div>
                <div class="nav-item-sidebar" onclick="switchTab('settings')" data-tab="settings">
                    <span class="nav-icon-sidebar">⚙️</span>
                    <span class="nav-label-sidebar">설정</span>
                </div>
            </nav>

            <!-- 사이드바 푸터 -->
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar">👤</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="sidebarUserName">사용자</div>
                        <div class="sidebar-user-status">활동 중</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 메인 컨텐츠 영역 -->
        <div class="main-content" id="mainContent">
            <div class="header">
                <h1 class="header-title">Diet Mate</h1>
                <p class="header-subtitle" id="headerSubtitle">안녕하세요!</p>
            </div>

            <div class="content">
            <!-- 홈 탭 -->
            <div id="tab-home" class="tab-content active">
                <div class="health-metrics">
                    <div class="metric-card">
                        <div class="metric-label">시작 체중</div>
                        <div class="metric-value" id="startWeightDisplay">0</div>
                        <div class="metric-unit">kg</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">현재 체중</div>
                        <div class="metric-value" id="currentWeightDisplay">0</div>
                        <div class="metric-unit">kg</div>
                        <div class="metric-date" id="currentWeightDate" style="font-size: 0.75rem; color: #999; margin-top: 4px;"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">목표 체중</div>
                        <div class="metric-value" id="goalWeightDisplay">0</div>
                        <div class="metric-unit">kg</div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-header">
                        <span>목표 달성률</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="progress-stats">
                        <span id="weightLost">감량: 0kg</span>
                        <span id="weightRemaining">남은 감량: 0kg</span>
                    </div>
                    
                    <!-- D-Day 표시 (새로 추가) -->
                    <div id="ddayDisplay" class="dday-display hidden">
                        <div class="dday-main">D-0</div>
                        <div class="dday-sub">목표일 설정 필요</div>
                    </div>
                    
                    <!-- 현실적인 예상 달성일 -->
                    <div id="realisticGoalDisplay" class="realistic-goal-display hidden" style="margin-top: 10px; padding: 12px; background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #00695c; margin-bottom: 4px;">💡 건강한 감량 속도 기준</div>
                        <div id="realisticGoalText" style="font-size: 0.95rem; font-weight: 600; color: #004d40;">예상 달성일: -</div>
                        <div style="font-size: 0.75rem; color: #00796b; margin-top: 4px;">주당 0.5-1kg 감량 기준</div>
                    </div>
                </div>

                <!-- 영양 대시보드 -->
                <div class="card">
                    <h3 class="card-title">🍽️ 오늘의 영양 섭취</h3>

                    <!-- 현재 섭취량 -->
                    <h4 style="font-size: 0.95rem; color: #666; margin-bottom: 10px;">📈 현재 섭취량</h4>
                    <div class="nutrition-summary">
                        오늘 <span id="todayMealCount">0</span>회 식사
                    </div>
                    
                    <!-- 오늘 먹은 음식 목록 -->
                    <div id="todayMealsList" style="margin-top: 15px;"></div>
                    
                    <!-- 🔥 새 기능: 100g당 영양정보 -->
                    <div id="per100gNutrition" style="margin-top: 15px; padding: 12px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #4a90e2; display: none;">
                        <div style="font-size: 0.9rem; font-weight: bold; color: #4a90e2; margin-bottom: 10px;">
                            📊 100g당 영양정보
                        </div>
                        <div id="per100gContainer" style="font-size: 0.85rem; line-height: 1.8;"></div>
                    </div>

                    <div class="nutrition-grid">
                        <div class="nutrition-card nutrition-calories">
                            <div class="nutrition-label">칼로리</div>
                            <div class="nutrition-value" id="todayCalories">0</div>
                            <div class="nutrition-remaining" id="remainingCalories">2400 남음</div>
                        </div>
                        <div class="nutrition-card nutrition-carbs">
                            <div class="nutrition-label">탄수화물</div>
                            <div class="nutrition-value" id="todayCarbs">0</div>
                            <div class="nutrition-remaining" id="remainingCarbs">300 남음</div>
                        </div>
                        <div class="nutrition-card nutrition-protein">
                            <div class="nutrition-label">단백질</div>
                            <div class="nutrition-value" id="todayProtein">0</div>
                            <div class="nutrition-remaining" id="remainingProtein">100 남음</div>
                        </div>
                        <div class="nutrition-card nutrition-fat">
                            <div class="nutrition-label">지방</div>
                            <div class="nutrition-value" id="todayFat">0</div>
                            <div class="nutrition-remaining" id="remainingFat">80 남음</div>
                        </div>
                    </div>

                    <div style="border-top: 1px solid #e0e0e0; margin: 20px 0;"></div>

                    <!-- 식사 입력 -->
                    <h4 style="font-size: 0.95rem; color: #666; margin-bottom: 10px;">🍴 식사 기록하기</h4>
                    <div class="meal-input-buttons">
                        <button class="meal-btn meal-btn-breakfast" onclick="openMealInputModal('아침')">
                            <span class="meal-emoji">🌅</span>
                            <span class="meal-label">아침</span>
                        </button>
                        <button class="meal-btn meal-btn-lunch" onclick="openMealInputModal('점심')">
                            <span class="meal-emoji">☀️</span>
                            <span class="meal-label">점심</span>
                        </button>
                        <button class="meal-btn meal-btn-dinner" onclick="openMealInputModal('저녁')">
                            <span class="meal-emoji">🌙</span>
                            <span class="meal-label">저녁</span>
                        </button>
                        <button class="meal-btn meal-btn-snack" onclick="openMealInputModal('간식')">
                            <span class="meal-emoji">🍪</span>
                            <span class="meal-label">간식</span>
                        </button>
                    </div>




                </div>


                <div class="card">
                    <h3 class="card-title">📊 체중 그래프</h3>
                    <div class="chart-container">
                        <canvas id="weightChart"></canvas>
                    </div>
                    <div class="weight-input-group" style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="number" id="weightInput" class="weight-input" placeholder="체중 (kg)" step="0.1">
                        <button class="btn-add-weight" onclick="addWeight()">추가</button>
                    </div>
                </div>

                <div class="ai-chat-section">
                    <div class="ai-chat-summary" onclick="toggleAIChat()">
                        <div>
                            <h3 class="card-title">🤖 AI 코치</h3>
                            <p style="font-size: 0.9rem; color: #666;">클릭하여 채팅하기</p>
                        </div>
                        <span style="font-size: 1.5rem;">▼</span>
                    </div>
                    <div class="ai-chat-details" id="aiChatDetails">
                        <div class="ai-chat-messages" id="aiChatMessages"></div>
                        <div class="ai-chat-input-area">
                            <input type="text" class="ai-chat-input" id="aiChatInput" placeholder="예: 어제랑 비교해줘">
                            <button class="ai-chat-send" onclick="sendAIMessage()">전송</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">💧 스마트 물 마시기</h3>
                    <div class="water-settings">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="cupSize" placeholder="250" value="250" style="width: 80px;">
                            <span class="unit-label">ml</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="number" id="waterGoal" placeholder="2" value="2" step="0.1" style="width: 60px;">
                            <span class="unit-label">L</span>
                        </div>
                        <button class="btn-add-weight" onclick="updateWaterTracker()">설정</button>
                    </div>
                    <!-- ========== Phase 2: 물 섭취량 표시 ========== -->
                    <div style="text-align: center; margin: 15px 0; font-size: 1.1rem; color: #2196f3; font-weight: bold;">
                        <span id="waterIntake">0 ml</span> / <span id="waterGoalDisplay">2000 ml</span>
                        <span style="display: block; font-size: 0.9rem; color: #666; margin-top: 5px;" id="waterPercentage">0%</span>
                    </div>
                    <!-- ============================================ -->
                    <div class="water-tracker" id="waterTracker"></div>
                </div>
            </div>

            <!-- 플랜 탭 -->
            <div id="tab-plan" class="tab-content">
                <!-- 오늘의 목표 -->
                <div class="card">
                    <h3 class="card-title">🎯 오늘의 목표</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">목표를 체크하며 하루를 관리하세요</p>

                    <!-- 기본 목표 체크리스트 -->
                    <div class="goal-checklist" id="goalChecklist">
                        <!-- 1. 물 마시기 (편집 가능) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-water" onchange="saveGoals()">
                            <span class="goal-icon">💧</span>
                            <span class="goal-text" id="goal-water-text">물 2L 마시기</span>
                            <span class="goal-status" id="goal-water-status">0L / 2L</span>
                            <button class="edit-goal-btn" onclick="editGoalText('water', '목표 물 섭취량 (L)')">✏️</button>
                            <span class="goal-check">✓</span>
                        </label>

                        <!-- 2. 간헐적 단식 (편집 가능) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-fasting" onchange="saveGoals()">
                            <span class="goal-icon">⏱️</span>
                            <span class="goal-text" id="goal-fasting-text">간헐적 단식 16시간</span>
                            <span class="goal-status" id="goal-fasting-status">미진행</span>
                            <button class="edit-goal-btn" onclick="editGoalText('fasting', '단식 시간 (시간)')">✏️</button>
                            <span class="goal-check">✓</span>
                        </label>

                        <!-- 3. 저녁 금식 (편집 가능) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-dinner" onchange="saveGoals()">
                            <span class="goal-icon">🌙</span>
                            <span class="goal-text" id="goal-dinner-text">저녁 8시 이후 금식</span>
                            <span class="goal-status" id="goal-dinner-status">-</span>
                            <button class="edit-goal-btn" onclick="editGoalText('dinner', '금식 시작 시간 (예: 20)')">✏️</button>
                            <span class="goal-check">✓</span>
                        </label>

                        <!-- 4. 운동 (편집 가능) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-exercise" onchange="saveGoals()">
                            <span class="goal-icon">💪</span>
                            <span class="goal-text" id="goal-exercise-text">운동 30분 이상</span>
                            <button class="edit-goal-btn" onclick="editGoalText('exercise', '운동 시간 (분)')">✏️</button>
                            <span class="goal-check">✓</span>
                        </label>

                        <!-- 5. 목표 칼로리 (편집 가능) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-calories" onchange="saveGoals()">
                            <span class="goal-icon">🍽️</span>
                            <span class="goal-text" id="goal-calories-text">목표 칼로리 지키기</span>
                            <span class="goal-status" id="goal-calories-status">0 / 1620kcal</span>
                            <button class="edit-goal-btn" onclick="editGoalText('calories', '목표 칼로리 (kcal)')">✏️</button>
                            <button class="edit-goal-btn" onclick="resetCalorieGoal()" style="background: #ff5252; margin-left: 3px;" title="기본값으로 재설정">🔄</button>
                            <span class="goal-check">✓</span>
                        </label>

                        <!-- 6. 체중 기록 (자동 체크) -->
                        <label class="goal-item">
                            <input type="checkbox" id="goal-weight" onchange="saveGoals()">
                            <span class="goal-icon">⚖️</span>
                            <span class="goal-text">체중 기록하기</span>
                            <span class="goal-status" id="goal-weight-status">미기록</span>
                            <span class="goal-check">✓</span>
                        </label>
                    </div>

                    <!-- 목표 달성률 표시 -->
                    <div class="goal-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="goalProgressBar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="goalProgressText">0 / 6 완료 (0%)</div>
                    </div>

                    <!-- 나만의 목표 추가 -->
                    <div class="custom-goal-input">
                        <input type="text" id="customGoalInput" placeholder="+ 나만의 목표 추가하기" maxlength="30">
                        <button onclick="addCustomGoal()">추가</button>
                    </div>

                    <!-- 커스텀 목표 리스트 -->
                    <div class="custom-goals" id="customGoalsList"></div>
                </div>

                <!-- 일기 기능 -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title">📝 오늘의 다짐</h3>
                    <textarea id="dailyDiary"
                              placeholder="오늘 하루를 어떻게 보냈나요? 성공한 것, 반성할 것, 내일의 다짐을 기록해보세요..."
                              style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; resize: vertical; font-family: inherit;"
                              oninput="updateCharCount(); saveDiary()"
                              onchange="saveDiary()"></textarea>
                    <div style="text-align: right; margin-top: 10px; font-size: 0.9rem; color: #666;">
                        <span id="diaryCharCount">0</span> / 500자
                    </div>
                </div>

                <!-- 이번 주 목표 달성 통계 -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title">📊 이번 주 목표 달성</h3>
                    <div class="weekly-stats" id="weeklyStats">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                </div>
            </div>

            <!-- 단식 탭 -->
            <div id="tab-fasting" class="tab-content">
                <!-- 🔥 단식 스트릭 & 통계 (최상단) -->
                <div class="fasting-streak-card">
                    <div style="display: flex; justify-content: space-around; align-items: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #ff6b6b;" id="fastingStreak">0</div>
                            <div style="font-size: 0.9rem; color: white; margin-top: 5px;">🔥 연속 일수</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #4ecdc4;" id="totalFastingDays">0</div>
                            <div style="font-size: 0.9rem; color: white; margin-top: 5px;">🎯 총 단식 일수</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #a8e6cf;" id="avgFastingHours">0</div>
                            <div style="font-size: 0.9rem; color: white; margin-top: 5px;">⏱️ 평균 시간</div>
                        </div>
                    </div>
                </div>

                <!-- 🏆 배지 시스템 -->
                <div class="fasting-badges-card">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">🏆 달성 배지</h4>
                    <div class="badges-grid" id="badgesGrid">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                </div>

                <!-- 📊 월간 단식 리포트 -->
                <div class="fasting-monthly-report">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="font-size: 1rem; color: #555; font-weight: 600;">📊 월간 리포트</h4>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="changeReportMonth(-1)" style="padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">◀</button>
                            <span id="reportMonth" style="padding: 5px 15px; font-weight: 600; color: #667eea;">2025년 12월</span>
                            <button onclick="changeReportMonth(1)" style="padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">▶</button>
                        </div>
                    </div>
                    <div class="monthly-stats-grid">
                        <div class="monthly-stat-item">
                            <div class="monthly-stat-value" id="monthlyTotalDays">0</div>
                            <div class="monthly-stat-label">단식 일수</div>
                        </div>
                        <div class="monthly-stat-item">
                            <div class="monthly-stat-value" id="monthlyAvgHours">0h</div>
                            <div class="monthly-stat-label">평균 시간</div>
                        </div>
                        <div class="monthly-stat-item">
                            <div class="monthly-stat-value" id="monthlyLongest">0h</div>
                            <div class="monthly-stat-label">최장 시간</div>
                        </div>
                        <div class="monthly-stat-item">
                            <div class="monthly-stat-value" id="monthlyWeightChange">0kg</div>
                            <div class="monthly-stat-label">체중 변화</div>
                        </div>
                    </div>
                </div>

                <!-- 📅 월간 단식 달력 -->
                <div class="fasting-calendar-card">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">📅 월간 단식 달력</h4>
                    <div class="fasting-calendar" id="fastingCalendar">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                </div>

                <!-- 📊 체중 연동 그래프 -->
                <div class="fasting-weight-chart-card">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">📊 단식 & 체중 변화</h4>
                    <canvas id="fastingWeightChart" style="max-height: 300px;"></canvas>
                    <div style="margin-top: 10px; font-size: 0.85rem; color: #888; text-align: center;">
                        파란색: 단식 시간 | 초록색: 체중
                    </div>
                </div>

                <!-- 💧 단식 중 물 섭취 리마인더 -->
                <div class="fasting-water-reminder">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">💧 단식 중 물 섭취 (홈 탭 연동)</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 12px;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;" id="fastingWaterIntake">0ml</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">오늘 물 섭취량 (홈 탭 동기화)</div>
                        </div>
                        <button onclick="quickAddWaterCup()" style="padding: 12px 20px; background: white; border: none; border-radius: 12px; font-weight: 600; color: #4ecdc4; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" id="quickAddWaterBtn">
                            +250ml 💧
                        </button>
                    </div>
                    <div style="margin-top: 12px; font-size: 0.85rem; color: #888;">
                        💡 단식 중에는 하루 2~3L의 물을 마셔주세요. 탈수 예방과 노폐물 배출에 도움이 됩니다.<br>
                        ⚡ 홈 탭의 "스마트 물마시기"와 완전 동기화됩니다!
                    </div>
                </div>

                <!-- 👍 주간 리포트 -->
                <div class="fasting-weekly-report">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">👍 주간 리포트</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; line-height: 1.7;" id="weeklyReportText">
                        데이터를 불러오는 중...
                    </div>
                </div>

                <!-- 👍 월간 리포트 텍스트 -->
                <div class="fasting-monthly-report-text">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">📄 월간 요약</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; line-height: 1.7;" id="monthlyReportText">
                        데이터를 불러오는 중...
                    </div>
                </div>

                <!-- 👍 이번 주 단식 현황 -->
                <div class="fasting-weekly-card">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 15px; font-weight: 600;">📊 이번 주 단식 현황</h4>
                    <div class="weekly-fasting-grid" id="weeklyFastingGrid">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                    <div style="margin-top: 12px; font-size: 0.85rem; color: #888; text-align: center;" id="weeklyGoalStatus">
                        주간 목표: 5회 단식 / 현재: 0회 완료
                    </div>
                </div>

                <div class="fasting-timer-card">
                    <!-- 타이머 상단에 현재 상태 표시 -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8); margin-bottom: 5px;" id="fastingStatusText">단식 시간을 선택해주세요</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7);" id="lastMealTime"></div>
                    </div>

                    <div class="fasting-svg-container">
                        <svg width="250" height="250">
                            <circle class="fasting-circle-bg" cx="125" cy="125" r="110" />
                            <circle class="fasting-circle-progress" id="fastingProgress" cx="125" cy="125" r="110"
                                    stroke-dasharray="691" stroke-dashoffset="691" />
                        </svg>
                        <div class="fasting-time-display">
                            <div class="fasting-time-main" id="fastingTimeMain">00:00:00</div>
                            <div class="fasting-time-sub" id="fastingTimeSub">단식 시간 선택</div>
                        </div>
                    </div>

                    <!-- 현재 단식 단계 표시 -->
                    <div id="fastingStageDisplay" style="text-align: center; margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white; display: none;">
                        <div style="font-size: 2rem;" id="fastingStageEmoji">🍽️</div>
                        <div style="font-size: 1.1rem; font-weight: bold; margin-top: 5px;" id="fastingStageTitle">소화 단계</div>
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 5px;" id="fastingStageDesc">음식을 소화하는 단계입니다</div>
                    </div>

                    <!-- 프리셋 버튼 (단식 시작 전에만 표시) -->
                    <div id="fastingPresetSection" style="margin-bottom: 20px;">
                        <div style="text-align: center; font-size: 0.95rem; color: rgba(255,255,255,0.9); margin-bottom: 12px; font-weight: 600;">⏰ 단식 시간 선택</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <button class="fasting-preset-btn-new" onclick="startFastingQuick(12)">
                                <div style="font-size: 1.2rem; font-weight: 800;">12h</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">12:12</div>
                            </button>
                            <button class="fasting-preset-btn-new" onclick="startFastingQuick(16)">
                                <div style="font-size: 1.2rem; font-weight: 800;">16h</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">16:8 ⭐</div>
                            </button>
                            <button class="fasting-preset-btn-new" onclick="startFastingQuick(18)">
                                <div style="font-size: 1.2rem; font-weight: 800;">18h</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">18:6</div>
                            </button>
                            <button class="fasting-preset-btn-new" onclick="startFastingQuick(20)">
                                <div style="font-size: 1.2rem; font-weight: 800;">20h</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">20:4</div>
                            </button>
                            <button class="fasting-preset-btn-new" onclick="startFastingQuick(24)">
                                <div style="font-size: 1.2rem; font-weight: 800;">24h</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">OMAD</div>
                            </button>
                            <button class="fasting-preset-btn-new" onclick="openCustomFastingModal()" style="background: rgba(168, 237, 234, 0.3); border-color: rgba(168, 237, 234, 0.6);">
                                <div style="font-size: 1.2rem; font-weight: 800;">⚙️</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 3px;">커스텀</div>
                            </button>
                        </div>
                        <!-- 마지막 식사 시간 기록 버튼 -->
                        <button onclick="recordLastMealTime()" style="width: 100%; margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                            🍽️ 마지막 식사 시간 기록
                        </button>
                    </div>

                    <!-- 진행 중 컨트롤 버튼 -->
                    <div id="fastingActiveControls" class="fasting-controls" style="display: none; gap: 8px;">
                        <button class="fasting-btn-pause" id="fastingPauseBtn" onclick="pauseFasting()" style="flex: 1;">⏸️ 일시정지</button>
                        <button class="fasting-btn-resume" id="fastingResumeBtn" onclick="resumeFasting()" style="display: none; flex: 1;">▶️ 재개</button>
                        <button class="fasting-btn-stop" onclick="stopFasting()" style="flex: 1;">⏹️ 중단</button>
                        <button onclick="extendFasting()" style="flex: 0.8; padding: 15px 15px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); border-radius: 25px; color: white; font-weight: bold; cursor: pointer;">⏰+1h</button>
                    </div>
                </div>

                <!-- 📊 오늘의 누적 단식 시간 (하단 이동) -->
                <div class="fasting-today-summary">
                    <h4 style="font-size: 1rem; color: #555; margin-bottom: 10px; font-weight: 600;">📊 오늘의 누적 단식</h4>
                    <div style="font-size: 2rem; font-weight: bold; color: #667eea; margin: 10px 0;" id="accumulatedTime">0시간 0분</div>
                    <div class="accumulated-sessions" id="fastingSessions">
                        <!-- 세션 목록 자동 표시 -->
                    </div>
                </div>

                <!-- 간단한 팁 카드 -->
                <div class="fasting-tips-card">
                    <details>
                        <summary style="font-weight: 600; cursor: pointer; padding: 12px; background: #f8f9fa; border-radius: 8px;">💡 단식 효과 & 팁</summary>
                        <div style="padding: 15px; line-height: 1.7;">
                            <p style="margin-bottom: 10px;"><strong>🔬 자가포식(Autophagy)</strong>은 12~16시간 후 활성화되어 손상된 세포를 재생합니다.</p>
                            <p style="margin-bottom: 10px;"><strong>주요 효과:</strong> 체중 감량, 인슐린 개선, 세포 재생, 집중력 향상</p>
                            <p style="color: #ff5252; font-weight: 500;">⚠️ 당뇨병, 임산부, 청소년은 주의 필요. 어지러움 시 즉시 중단하세요.</p>
                        </div>
                    </details>
                </div>
            </div>

            <!-- 앨범 탭 -->
            <div id="tab-album" class="tab-content">
                <div class="card">
                    <!-- 앨범 헤더 -->
                    <div class="album-header">
                        <h3 class="card-title">📸 나의 변화 앨범</h3>
                        <button class="select-mode-btn" id="selectModeBtn" onclick="toggleSelectMode()">선택</button>
                    </div>

                    <!-- 선택 모드 액션 바 -->
                    <div class="select-action-bar hidden" id="selectActionBar">
                        <div class="selected-count" id="selectedCount">0개 선택됨</div>
                        <div class="select-actions">
                            <button class="action-btn download-btn" onclick="downloadSelectedItems()">📥 다운로드</button>
                            <button class="action-btn share-btn" onclick="shareSelectedItems()">📤 공유</button>
                            <button class="action-btn cancel-btn" onclick="cancelSelectMode()">취소</button>
                        </div>
                    </div>

                    <div class="album-tabs">
                        <button class="album-tab active" onclick="changeAlbumTab('all')">전체</button>
                        <button class="album-tab" onclick="changeAlbumTab('body')">눈바디</button>
                        <button class="album-tab" onclick="changeAlbumTab('food')">식단</button>
                        <button class="album-tab" onclick="changeAlbumTab('exercise')">운동</button>
                    </div>
                    <div class="photo-grid" id="photoGrid">
                        <!-- '전체' 탭이 기본이므로 + 버튼 없음, JavaScript가 탭 전환 시 동적으로 추가 -->
                    </div>
                </div>
            </div>

            <!-- 캘린더 탭 -->
            <div id="tab-calendar" class="tab-content">
                <!-- 주간 요약 대시보드 -->
                <div class="weekly-summary-card" id="weeklySummary">
                    <div class="weekly-summary-header">
                        <h3>📊 주간 요약</h3>
                        <button class="summary-toggle-btn" onclick="toggleWeeklySummary()">접기</button>
                    </div>
                    <div class="weekly-summary-content" id="weeklySummaryContent">
                        <div class="summary-loading">로딩 중...</div>
                    </div>
                </div>

                <!-- AI 코칭 메시지 -->
                <div class="ai-coaching-card" id="aiCoachingCard">
                    <div class="ai-coach-header">
                        <span>🤖 AI 코치의 한마디</span>
                    </div>
                    <div class="ai-coach-message" id="aiCoachMessage">
                        "주간 요약을 확인하고 계속 힘내세요! 💪"
                    </div>
                </div>

                <div class="calendar">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">◀</button>
                        <div class="calendar-month" id="calendarMonth">2025년 1월</div>
                        <button class="calendar-nav" onclick="changeMonth(1)">▶</button>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-day-label">일</div>
                        <div class="calendar-day-label">월</div>
                        <div class="calendar-day-label">화</div>
                        <div class="calendar-day-label">수</div>
                        <div class="calendar-day-label">목</div>
                        <div class="calendar-day-label">금</div>
                        <div class="calendar-day-label">토</div>
                    </div>
                    <div class="calendar-grid" id="calendarDays"></div>
                </div>
            </div>

            <!-- 소통 탭 -->
            <div id="tab-community" class="tab-content">
                <div class="chat-container" id="chatContainer"></div>
            </div>
            <div class="chat-input-container hidden" id="chatInputContainer">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="communityInput" placeholder="메시지를 입력하세요...">
                    <button class="send-btn" onclick="sendCommunityMessage()">전송</button>
                </div>
            </div>

            <!-- 알림 탭 -->
            <div id="tab-notification" class="tab-content">
                <div class="card">
                    <h3 class="card-title">🔔 알림 관리</h3>
                    <button class="btn-add-plan" style="width: 100%; margin-bottom: 15px;" onclick="openAddNotificationModal()">
                        + 새 알림 추가
                    </button>
                    <button class="btn-add-plan" style="width: 100%; margin-bottom: 15px; background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);" onclick="addWaterNotificationPreset()">
                        💧 물 마시기 알림 (5회) 한번에 추가
                    </button>
                    <div class="notification-list" id="notificationList"></div>
                </div>
            </div>

            <!-- 설정 탭 -->
            <div id="tab-settings" class="tab-content">
                <div class="pwa-install-banner hidden" id="pwaInstallBanner">
                    <div class="pwa-install-text">
                        <strong>앱으로 설치하기</strong>
                        <span style="font-size: 0.9rem;">홈 화면에 추가하고 더 편하게 사용하세요!</span>
                    </div>
                    <button class="pwa-install-btn" onclick="installPWA()">설치</button>
                </div>

                <div class="profile-card">
                    <div class="profile-header">
                        <div class="profile-avatar">💪</div>
                        <div class="profile-info">
                            <h3 id="profileName">사용자</h3>
                            <p id="profileEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="e2878f838b8ea2879a838f928e87cc818d8f">[email&#160;protected]</a></p>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item" onclick="showDaysActiveDetail()" style="cursor: pointer;">
                            <div class="stat-value" id="totalDays">0</div>
                            <div class="stat-label">함께한 날</div>
                        </div>
                        <div class="stat-item" onclick="showExerciseTimeDetail()" style="cursor: pointer;">
                            <div class="stat-value" id="totalExercise">0</div>
                            <div class="stat-label">운동 시간 (분)</div>
                        </div>
                        <div class="stat-item" onclick="showCalorieSavingsDetail()" style="cursor: pointer;">
                            <div class="stat-value" id="totalCalories">0</div>
                            <div class="stat-label">절약 칼로리</div>
                        </div>
                        <div class="stat-item" onclick="showExpectedCompletionDetail()" style="cursor: pointer;">
                            <div class="stat-value" id="predictedDate">-</div>
                            <div class="stat-label">예상 달성일</div>
                        </div>
                    </div>
                </div>

                <!-- 테마 선택 -->
                <div class="card" style="margin-top: 20px;">
                    <h3 class="card-title">🎨 테마 선택</h3>
                    <div class="theme-selector" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px;">
                        <div class="theme-option" data-theme="light" onclick="setTheme('light')" style="border: 2px solid var(--border); padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <div style="font-size: 2rem;">☀️</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">라이트</div>
                        </div>
                        <div class="theme-option" data-theme="dark" onclick="setTheme('dark')" style="border: 2px solid var(--border); padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <div style="font-size: 2rem;">🌙</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">다크</div>
                        </div>
                        <div class="theme-option" data-theme="pastel" onclick="setTheme('pastel')" style="border: 2px solid var(--border); padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <div style="font-size: 2rem;">🌸</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">파스텔</div>
                        </div>
                        <div class="theme-option" data-theme="high-contrast" onclick="setTheme('high-contrast')" style="border: 2px solid var(--border); padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <div style="font-size: 2rem;">🔆</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">고대비</div>
                        </div>
                    </div>
                </div>

                <div class="settings-item" onclick="openProfileSettings()">
                    <span>👤 프로필 재설정</span>
                    <span>→</span>
                </div>

                <div class="settings-item" onclick="openFullReset()" style="color: #ff5252;">
                    <span>🗑️ 전체 초기화</span>
                    <span>→</span>
                </div>

                <div class="settings-item" onclick="exportData()">
                    <span>📤 데이터 내보내기</span>
                    <span>→</span>
                </div>

                <div class="settings-item" onclick="importData()">
                    <span>📥 데이터 가져오기</span>
                    <span>→</span>
                </div>

                <button class="logout-btn" onclick="logout()">로그아웃</button>
            </div>
        </div>

        <!-- 하단 네비게이션 (사이드바로 대체됨 - 숨김 처리) -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home')">
                <div class="nav-icon">🏠</div>
                <div class="nav-label">홈</div>
            </div>
            <div class="nav-item" onclick="switchTab('plan')">
                <div class="nav-icon">📋</div>
                <div class="nav-label">플랜</div>
            </div>
            <div class="nav-item" onclick="switchTab('fasting')">
                <div class="nav-icon">⏱️</div>
                <div class="nav-label">단식</div>
            </div>
            <div class="nav-item" onclick="switchTab('album')">
                <div class="nav-icon">📸</div>
                <div class="nav-label">앨범</div>
            </div>
            <div class="nav-item" onclick="switchTab('calendar')">
                <div class="nav-icon">📅</div>
                <div class="nav-label">캘린더</div>
            </div>
            <div class="nav-item" onclick="switchTab('community')">
                <div class="nav-icon">💬</div>
                <div class="nav-label">소통</div>
            </div>
            <div class="nav-item" onclick="switchTab('notification')">
                <div class="nav-icon">🔔</div>
                <div class="nav-label">알림</div>
            </div>
            <div class="nav-item" onclick="switchTab('settings')">
                <div class="nav-icon">⚙️</div>
                <div class="nav-label">설정</div>
            </div>
        </div>

        <!-- 모바일 햄버거 메뉴 버튼 -->
        <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">
            <span style="font-size: 24px;">☰</span>
        </button>

        <!-- 모바일 사이드바 오버레이 -->
        <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>
    </div>

    <!-- 프로필 재설정 모달 -->
    <div id="profileSettingsModal" class="category-change-overlay hidden">
        <div class="category-change-modal">
            <div class="category-modal-header">
                <h3>👤 프로필 재설정</h3>
                <button class="modal-close-btn" onclick="closeProfileSettings()">×</button>
            </div>
            <p class="category-modal-description" style="font-size: 0.9rem; color: #666;">
                ⚠️ 프로필 정보만 수정됩니다. 기존 기록(체중, 단식, 식사)은 유지됩니다.<br>
                모든 기록을 삭제하려면 <strong style="color: #ff5252;">"전체 초기화"</strong>를 사용하세요.
            </p>
            
            <div class="form-group">
                <label class="form-label">닉네임</label>
                <input type="text" id="editName" class="form-input" placeholder="닉네임을 입력하세요">
            </div>
            
            <div class="form-group">
                <label class="form-label">시작 체중 (kg)</label>
                <input type="number" id="editStartWeight" class="form-input" placeholder="" step="0.1" min="0">
            </div>
            
            <div class="form-group">
                <label class="form-label">목표 체중 (kg)</label>
                <input type="number" id="editGoalWeight" class="form-input" placeholder="" step="0.1" min="0">
            </div>

            <div class="form-group">
                <label class="form-label">나이</label>
                <input type="number" id="editAge" class="form-input" placeholder="" min="10" max="120">
            </div>

            <div class="form-group">
                <label class="form-label">키 (cm)</label>
                <input type="number" id="editHeight" class="form-input" placeholder="" step="0.1">
            </div>

            <div class="form-group">
                <label class="form-label">성별</label>
                <select id="editGender" class="form-input">
                    <option value="">선택하세요</option>
                    <option value="male">남성</option>
                    <option value="female">여성</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">목표 날짜</label>
                <input type="date" id="editTargetDate" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">활동량</label>
                <select id="editActivityLevel" class="form-input">
                    <option value="sedentary">거의 운동 안 함</option>
                    <option value="light">가벼운 운동 (주 1-3회)</option>
                    <option value="moderate">보통 운동 (주 3-5회)</option>
                    <option value="active">많은 운동 (주 6-7회)</option>
                    <option value="veryActive">매우 많은 운동 (하루 2회)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">목표</label>
                <select id="editGoal" class="form-input">
                    <option value="lose">체중 감량</option>
                    <option value="maintain">체중 유지</option>
                    <option value="gain">체중 증가</option>
                </select>
            </div>
            
            <div class="merge-actions" style="margin-top: 25px;">
                <button class="merge-btn merge-cancel" onclick="closeProfileSettings()">취소</button>
                <button class="merge-btn merge-confirm" onclick="saveProfileSettings()">저장</button>
            </div>
        </div>
    </div>

    <!-- 초기 설정 필수 모달 (프로필이 없을 때 강제 표시) -->
    <div id="initialProfileSetupModal" class="modal-overlay" style="display: none; z-index: 9999;">
        <div class="modal-content" style="max-width: 400px;">
            <h3 style="text-align: center; margin-bottom: 10px;">🎯 환영합니다!</h3>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Diet Mate를 시작하기 위해 기본 정보를 입력해주세요.
            </p>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">닉네임</label>
                <input type="text" id="initialSetupName" class="form-input"
                       placeholder="예: 홍길동" value="" required>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">현재 체중 (kg)</label>
                <input type="number" id="initialSetupStartWeight" class="form-input"
                       step="0.1" placeholder="예: 70.0" value="" required>
            </div>

            <div class="form-group" style="margin-bottom: 30px;">
                <label class="form-label">목표 체중 (kg)</label>
                <input type="number" id="initialSetupGoalWeight" class="form-input"
                       step="0.1" placeholder="예: 65.0" value="" required>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">나이</label>
                <input type="number" id="initialSetupAge" class="form-input"
                       placeholder="예: 30" min="10" max="120" value="">
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">키 (cm)</label>
                <input type="number" id="initialSetupHeight" class="form-input"
                       step="0.1" placeholder="예: 170.0" value="">
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">성별</label>
                <select id="initialSetupGender" class="form-input">
                    <option value="" selected>선택하세요</option>
                    <option value="male">남성</option>
                    <option value="female">여성</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">목표 날짜</label>
                <input type="date" id="initialSetupTargetDate" class="form-input" value="">
            </div>

            <div class="form-group" style="margin-bottom: 20px;">
                <label class="form-label">활동량</label>
                <select id="initialSetupActivityLevel" class="form-input">
                    <option value="sedentary">거의 운동 안 함</option>
                    <option value="light" selected>가벼운 운동 (주 1-3회)</option>
                    <option value="moderate">보통 운동 (주 3-5회)</option>
                    <option value="active">많은 운동 (주 6-7회)</option>
                    <option value="veryActive">매우 많은 운동 (하루 2회)</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 30px;">
                <label class="form-label">목표</label>
                <select id="initialSetupGoal" class="form-input">
                    <option value="lose" selected>체중 감량</option>
                    <option value="maintain">체중 유지</option>
                    <option value="gain">체중 증가</option>
                </select>
            </div>
            </div>

            <button class="merge-btn merge-confirm" style="width: 100%;"
                    onclick="completeInitialSetup()">
                시작하기 🚀
            </button>
        </div>
    </div>
    
    <!-- 식사 수정 모달 -->
    <div id="editMealModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 450px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">🍽️ 식사 수정</h3>
                <button class="modal-close-btn" onclick="closeEditMealModal()">×</button>
            </div>
            
            <!-- 식사 타입 선택 -->
            <div style="margin-bottom: 20px;">
                <label class="form-label">식사 시간</label>
                <div class="meal-input-buttons">
                    <button class="meal-btn meal-btn-breakfast" id="editMealType-아침" onclick="selectEditMealType('아침')">
                        <span class="meal-emoji">🌅</span>
                        <span class="meal-label">아침</span>
                    </button>
                    <button class="meal-btn meal-btn-lunch" id="editMealType-점심" onclick="selectEditMealType('점심')">
                        <span class="meal-emoji">☀️</span>
                        <span class="meal-label">점심</span>
                    </button>
                    <button class="meal-btn meal-btn-dinner" id="editMealType-저녁" onclick="selectEditMealType('저녁')">
                        <span class="meal-emoji">🌙</span>
                        <span class="meal-label">저녁</span>
                    </button>
                    <button class="meal-btn meal-btn-snack" id="editMealType-간식" onclick="selectEditMealType('간식')">
                        <span class="meal-emoji">🍪</span>
                        <span class="meal-label">간식</span>
                    </button>
                </div>
            </div>
            
            <!-- 입력 방법 선택 -->
            <div style="margin-bottom: 20px;">
                <label class="form-label">수정 방법</label>
                <div style="display: flex; gap: 10px;">
                    <button class="input-method-btn" onclick="selectEditMethod('ai')" style="flex: 1;">
                        🤖 AI 재분석
                    </button>
                    <button class="input-method-btn" onclick="selectEditMethod('manual')" style="flex: 1;">
                        ✍️ 직접 입력
                    </button>
                </div>
            </div>
            
            <!-- 직접 입력 필드 -->
            <div id="manualEditFields" style="display: none;">
                <div class="form-group">
                    <label class="form-label">음식 이름</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="editFoodName" class="form-input" placeholder="예: 짬뽕, 꿔바로우" 
                               style="flex: 1;" onkeypress="if(event.key==='Enter') searchFoodForEdit();">
                        <button class="search-food-btn-edit" onclick="searchFoodForEdit()" style="padding: 10px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap;">
                            🔍 검색
                        </button>
                    </div>
                </div>
                
                <!-- 음식 검색 결과 -->
                <div id="editFoodSearchResults" style="display: none; margin-bottom: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 250px; overflow-y: auto;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #333; font-size: 0.95rem;">
                            📋 검색 결과 (클릭하여 선택)
                        </div>
                        <div id="editFoodOptionsContainer"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">칼로리 (kcal)</label>
                    <input type="number" id="editCalories" class="form-input" placeholder="0" step="1">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 0.85rem;">탄수화물 (g)</label>
                        <input type="number" id="editCarbs" class="form-input" placeholder="0" step="0.1">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 0.85rem;">단백질 (g)</label>
                        <input type="number" id="editProtein" class="form-input" placeholder="0" step="0.1">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label" style="font-size: 0.85rem;">지방 (g)</label>
                        <input type="number" id="editFat" class="form-input" placeholder="0" step="0.1">
                    </div>
                </div>
                
                <div class="merge-actions">
                    <button class="merge-btn merge-cancel" onclick="closeEditMealModal()">취소</button>
                    <button class="merge-btn merge-confirm" onclick="saveEditedMeal()">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // ==================== Firebase 초기화 ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDrw00jym_dKATz26qUzsALSqfYeAAkM-I",
            authDomain: "mate-9f45e.firebaseapp.com",
            projectId: "mate-9f45e",
            storageBucket: "mate-9f45e.firebasestorage.app",
            messagingSenderId: "1077932492908",
            appId: "1:1077932492908:web:722c068177e2e715183049"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ==================== 전역 변수 ====================
        let currentUser = null;
        let currentProfile = null;
        let currentTab = 'home';
        let currentAlbumTab = 'all';
        let isSignUp = false;
        let weightChart = null;
        let currentMonth = new Date();
        let fastingInterval = null;
        let fastingState = null;
        let deferredPrompt = null;
        let notificationCheckInterval = null;
        let nutritionChart = null;
        let aiToastTimeout = null;
        let pendingMealData = null;
        let recentMealDocId = null;
        let currentMealType = '아침'; // 현재 선택된 식사 타입
        const GEMINI_API_KEY = 'AIzaSyBylUs1l7GeyyaXpTdwwfGiOHM3stdKc_4'; // Gemini API 키 (최신)

        // 토스트 메시지 표시 함수
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10001;
                animation: fadeIn 0.3s ease-in-out;
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }


        // ==================== 알림 권한 요청 ====================
        
        // 알림 권한 상태 확인 및 배너 표시
        function checkNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('이 브라우저는 알림을 지원하지 않습니다.');
                return;
            }

            const permission = Notification.permission;
            console.log('현재 알림 권한:', permission);

            if (permission === 'default') {
                // 아직 권한을 묻지 않은 상태 → 배너 표시
                document.getElementById('notificationBanner').classList.remove('hidden');
            } else if (permission === 'denied') {
                console.warn('알림 권한이 거부되었습니다.');
            } else if (permission === 'granted') {
                console.log('✅ 알림 권한이 허용되었습니다!');
            }
        }

        // 알림 권한 요청 함수
        async function requestNotificationPermission() {
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    console.log('✅ 알림 권한 허용됨!');
                    document.getElementById('notificationBanner').classList.add('hidden');
                    
                    // 테스트 알림 발송
                    new Notification('Diet Mate 알림 활성화', {
                        body: '이제 식사 시간과 운동 알림을 받을 수 있어요! 💪',
                        icon: 'https://via.placeholder.com/192',
                        badge: 'https://via.placeholder.com/96'
                    });
                    
                    showSuccessToast('알림이 활성화되었습니다! 🔔');
                } else if (permission === 'denied') {
                    alert('알림이 차단되었습니다.\n\n설정 > 사이트 설정 > 알림에서 다시 활성화할 수 있습니다.');
                    document.getElementById('notificationBanner').classList.add('hidden');
                }
            } catch (error) {
                console.error('알림 권한 요청 실패:', error);
            }
        }

        // ==================== BMR/TDEE 계산 ====================
        
        /**
         * BMR (기초대사량) 계산 - Harris-Benedict 공식
         */
        function calculateBMR(weight, height, age, gender) {
            if (gender === 'male') {
                return 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                return 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
        }

        /**
         * TDEE (총 에너지 소비량) 계산
         */
        function calculateTDEE(bmr, activityLevel = 'light') {
            const multipliers = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                active: 1.725,
                veryActive: 1.9
            };
            return bmr * (multipliers[activityLevel] || 1.375);
        }

        /**
         * 목표 칼로리 계산
         */
        function calculateGoalCalories(tdee, goal = 'lose') {
            if (goal === 'lose') {
                return Math.round(tdee - 500);
            } else if (goal === 'gain') {
                return Math.round(tdee + 300);
            } else {
                return Math.round(tdee);
            }
        }


        // ==================== D-Day 계산 ====================
        
        /**
         * D-Day 표시 업데이트
         */
        function updateDDayDisplay(targetDate) {
            const ddayDisplay = document.getElementById('ddayDisplay');
            
            if (!targetDate) {
                ddayDisplay.classList.add('hidden');
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const target = new Date(targetDate);
            target.setHours(0, 0, 0, 0);

            const diffTime = target - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const diffWeeks = Math.floor(diffDays / 7);

            const ddayMain = ddayDisplay.querySelector('.dday-main');
            const ddaySub = ddayDisplay.querySelector('.dday-sub');

            const year = target.getFullYear();
            const month = String(target.getMonth() + 1).padStart(2, '0');
            const day = String(target.getDate()).padStart(2, '0');
            const dateStr = `${year.toString().slice(2)}-${month}-${day}`;

            if (diffDays > 0) {
                ddayMain.textContent = `D-${diffDays}`;
                ddaySub.textContent = `목표일: ${dateStr} (약 ${diffWeeks}주)`;
            } else if (diffDays === 0) {
                ddayMain.textContent = `D-DAY`;
                ddaySub.textContent = `🎉 목표일입니다!`;
            } else {
                ddayMain.textContent = `D+${Math.abs(diffDays)}`;
                ddaySub.textContent = `목표일 ${Math.abs(diffDays)}일 경과`;
            }

            ddayDisplay.classList.remove('hidden');
        }
        
        /**
         * 현실적인 목표 달성일 계산 및 표시
         * - 현재 체중 기준으로 계산 (체중 변화에 따라 자동 업데이트)
         */
        function updateRealisticGoalDisplay(currentWeight) {
            const realisticDisplay = document.getElementById('realisticGoalDisplay');
            const realisticText = document.getElementById('realisticGoalText');
            
            const goalWeight = currentProfile.goalWeight || 0;
            const remaining = Math.abs(currentWeight - goalWeight);
            
            if (remaining <= 0) {
                realisticDisplay.classList.add('hidden');
                return;
            }
            
            // 건강한 감량 속도: 주당 0.5-1kg
            // 보수적으로 주당 0.75kg 기준
            const weeksNeeded = Math.ceil(remaining / 0.75);
            const daysNeeded = weeksNeeded * 7;
            
            const today = new Date();
            const realisticDate = new Date(today);
            realisticDate.setDate(today.getDate() + daysNeeded);
            
            const year = realisticDate.getFullYear();
            const month = String(realisticDate.getMonth() + 1).padStart(2, '0');
            const day = String(realisticDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            realisticText.textContent = `예상 달성일: ${dateStr} (약 ${weeksNeeded}주 후)`;
            realisticDisplay.classList.remove('hidden');
            
            console.log('💡 현실적인 목표일:', dateStr, `(${daysNeeded}일, ${weeksNeeded}주)`, `남은 감량: ${remaining}kg`);
        }


        // ========== Phase 1: 영양 섭취 관리 ==========
        let todayIntake = {
            calories: 0,
            carbs: 0,
            protein: 0,
            fat: 0,
            meals: []
        };

        let dailyNutrition = {
            totalCalories: 2400,
            targetCarbs: 300,
            targetProtein: 120,
            targetFat: 60
        };

        let midnightResetInterval = null;

        // Phase 4: 배치 작업을 위한 변수
        let isSelectMode = false;
        let selectedItems = new Set();
        let allPhotoItems = []; // 현재 표시된 모든 사진 항목 {docId, url}

        // Phase 4: 카테고리 변경을 위한 변수
        let changingPhotoId = null;
        let changingPhotoCurrentCategory = null;

        // Phase 4: 수동 병합을 위한 변수
        let mergingSourceId = null; // 현재 선택한 식사 (병합될 항목)

        // Gemini API 키 배열
        const API_KEYS = [
            'AIzaSyBylUs1l7GeyyaXpTdwwfGiOHM3stdKc_4'
        ];
        let currentAPIKeyIndex = 0;

        // LocalStorage 키
        const LS_KEYS = {
            AI_CHAT: 'diet_mate_ai_chat',
            NOTIFICATIONS: 'diet_mate_notifications',
            FASTING: 'diet_mate_fasting',
            PWA_INSTALLED: 'diet_mate_pwa_installed',
            WATER_SETTINGS: 'diet_mate_water_settings'
        };

        // ==================== Gemini API 호출 (로테이션 로직) ====================
        // ==================== 공통 Gemini API 호출 함수 ====================
        async function callGeminiAPIBase(prompt, retries = 3) {
            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    const apiKey = API_KEYS[currentAPIKeyIndex];
                    console.log(`🔄 Gemini API 호출 시도 ${attempt + 1}/${retries}...`);

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{ text: prompt }]
                                }]
                            })
                        }
                    );

                    if (response.status === 429) {
                        console.warn('⚠️ API 할당량 초과 (429), 다음 키로 전환...');
                        currentAPIKeyIndex = (currentAPIKeyIndex + 1) % API_KEYS.length;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('❌ API 오류:', response.status, errorData);
                        throw new Error(`API Error: ${response.status} - ${JSON.stringify(errorData)}`);
                    }

                    const data = await response.json();
                    console.log('✅ Gemini API 응답 성공');
                    return data.candidates[0].content.parts[0].text;

                } catch (error) {
                    console.error('❌ Gemini API 호출 실패:', error);
                    if (attempt === retries - 1) {
                        return 'AI가 휴식 중이에요. 잠시 후 다시 시도해주세요! 😊\n(에러: ' + error.message + ')';
                    }
                    await new Promise(resolve => setTimeout(resolve, 500 * (attempt + 1)));
                }
            }
        }

        // 🔥 1. 음식 검색 & 영양 DB (Flash 1.5 모델)
        async function callGeminiFoodSearch(foodName) {
            console.log('🔍 [음식 검색] 시작:', foodName);
            const prompt = `당신은 한국 음식 전문 영양 데이터베이스 AI입니다.

사용자가 "${foodName}"을(를) 검색했습니다.

**요구사항:**
1. 한국의 유명 프랜차이즈(예: 이바돔, 누리마을, 교촌치킨, 굽네치킨, BBQ 등)나 일반 식당의 "${foodName}" 영양정보를 **3~5개** 제공
2. **단위를 1인분(1회 제공량)으로 통일**
3. 브랜드명 또는 종류를 반드시 포함 (예: '이바돔 감자탕 1인분', '일반 식당 감자탕 1인분')

**출력 형식 (JSON):**
[
  {
    "foodName": "브랜드/종류명 포함 (예: 이바돔 감자탕 1인분)",
    "calories": 숫자,
    "carbs": 숫자,
    "protein": 숫자,
    "fat": 숫자
  }
]

**주의:**
- JSON 배열만 출력하고, 다른 텍스트는 절대 포함 금지
- 실제 영양정보 기반으로 정확히 제공
- 1인분 기준 통일`;
            
            return await callGeminiAPIBase(prompt);
        }

        // 🔥 4. 텍스트 분석 (메모 입력) - 단호한 피드백
        async function callGeminiNutritionAnalysis(foodName, grams, profile) {
            console.log('✍️ [텍스트 분석] 시작:', foodName, grams);
            const userName = profile?.name || '회원';
            const prompt = `당신은 ${userName} 회원님을 담당하는 엄격한 영양 트레이너입니다.

**입력된 음식:**
- 음식명: ${foodName}
${grams ? `- 양: ${grams}g` : '- 양: 일반적인 1인분 기준으로 계산'}

**분석 요청:**
1. 위 음식의 영양성분(칼로리, 탄수화물, 단백질, 지방)을 계산
2. 양이 명시되지 않으면 "일반적인 1인분"으로 간주
3. 과식이나 고칼로리 음식인 경우 단호한 피드백 제공 (예: "${userName} 회원님, 삼겹살 3인분은 오늘 운동 강도를 2배로 높여야 하는 양이에요!")

**출력 형식 (JSON):**
{
  "foodName": "음식명",
  "calories": 숫자,
  "carbs": 숫자,
  "protein": 숫자,
  "fat": 숫자,
  "advice": "${userName} 회원님... (단호한 피드백, 최대 50자)"
}

**주의:** JSON만 출력하고 다른 텍스트 포함 금지`;
            
            return await callGeminiAPIBase(prompt);
        }

        // 🔥 3. AI 코치 (메인 챗봇) - 선배 트레이너
        async function callGeminiCoach(userMessage, profile, todayData) {
            console.log('💬 [AI 코치] 시작:', userMessage);
            const userName = profile?.name || '회원';
            const currentWeight = profile?.currentWeight || profile?.startWeight || '미기록';
            const goalWeight = profile?.goalWeight || '미설정';
            const todayCalories = todayData?.calories || 0;
            const todayCarbs = todayData?.carbs || 0;
            const todayMealCount = todayData?.meals?.length || 0;
            
            const prompt = `당신은 ${userName} 회원님의 모든 기록을 모니터링하는 선배 트레이너입니다.

**회원 프로필:**
- 이름: ${userName}
- 현재 체중: ${currentWeight}kg
- 목표 체중: ${goalWeight}kg
- 나이: ${profile?.age || '미기록'}세
- 키: ${profile?.height || '미기록'}cm

**오늘의 기록:**
- 섭취 칼로리: ${todayCalories}kcal
- 탄수화물: ${todayCarbs}g
- 식사 횟수: ${todayMealCount}회
- 체중 기록: ${currentWeight}kg
- 간헐적 단식: ${todayData?.fasting || '미기록'}
- 물 섭취: ${todayData?.water || '미기록'}

**회원님의 질문:**
"${userMessage}"

**응답 요구사항:**
1. "${userName} 회원님"으로 시작
2. 데이터 기반 피드백 제공 (예: "오늘 어때?" → 칼로리/탄수화물 언급)
3. 따뜻하지만 전문가다운 조언
4. 동기부여와 응원 포함
5. 친절하지만 단호한 선배 트레이너 말투

답변을 200자 이내로 간결하게 작성하세요.`;
            
            return await callGeminiAPIBase(prompt);
        }

        // 하위 호환성을 위한 기본 함수
        async function callGeminiAPI(prompt, retries = 3) {
            return await callGeminiAPIBase(prompt, retries);
        }

        // ==================== AI 영양 분석 함수 ====================

        // 파일을 Base64로 인코딩
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // 🔥 2. 사진 분석 (AI 트레이너+영양사) - gemini-1.5-flash
        async function callGeminiVisionAPI(prompt, base64Image, retries = 3) {
            for (let attempt = 0; attempt < retries; attempt++) {
                try {
                    const apiKey = API_KEYS[currentAPIKeyIndex];
                    console.log(`🔄 Gemini Vision API (gemini-1.5-flash) 호출 시도 ${attempt + 1}/${retries}...`);

                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: prompt },
                                        {
                                            inline_data: {
                                                mime_type: "image/jpeg",
                                                data: base64Image
                                            }
                                        }
                                    ]
                                }]
                            })
                        }
                    );

                    if (response.status === 429) {
                        console.warn('⚠️ API 할당량 초과 (429), 다음 키로 전환...');
                        currentAPIKeyIndex = (currentAPIKeyIndex + 1) % API_KEYS.length;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('❌ Vision API 오류:', response.status, errorData);
                        throw new Error(`Vision API Error: ${response.status} - ${JSON.stringify(errorData)}`);
                    }

                    const data = await response.json();
                    console.log('✅ Gemini Vision API 응답 성공');
                    return data.candidates[0].content.parts[0].text;

                } catch (error) {
                    console.error('❌ Gemini Vision API 호출 실패:', error);
                    if (attempt === retries - 1) {
                        throw new Error('이미지 분석에 실패했습니다: ' + error.message);
                    }
                    await new Promise(resolve => setTimeout(resolve, 500 * (attempt + 1)));
                }
            }
        }

        // AI 응답에서 JSON 파싱 (마크다운 코드 블록 제거)
        function parseNutritionResponse(responseText) {
            try {
                // 마크다운 코드 블록 제거
                let jsonText = responseText.trim();
                const codeBlockMatch = jsonText.match(/```json\s*([\s\S]*?)\s*```/);
                if (codeBlockMatch) {
                    jsonText = codeBlockMatch[1];
                }

                const data = JSON.parse(jsonText);

                return {
                    calories: parseFloat(data.calories) || 0,
                    carbs: parseFloat(data.carbs) || 0,
                    protein: parseFloat(data.protein) || 0,
                    fat: parseFloat(data.fat) || 0,
                    foodName: data.foodName || '알 수 없음',
                    advice: data.advice || '균형잡힌 식사를 하세요.'
                };
            } catch (error) {
                console.error('영양 정보 파싱 실패:', error);
                return {
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0,
                    foodName: '알 수 없음',
                    advice: '영양 분석에 실패했어요. 나중에 다시 시도해주세요.'
                };
            }
        }

        // 이미지에서 영양 분석
        async function analyzeNutritionFromImage(file, imageUrl) {
            try {
                // 사용자 정보 가져오기
                const weightsSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .orderBy('date', 'desc')
                    .limit(1)
                    .get();

                const currentWeight = weightsSnapshot.empty
                    ? currentProfile.startWeight
                    : weightsSnapshot.docs[0].data().weight;

                // Base64 인코딩
                const base64Image = await fileToBase64(file);

                // 🔥 2. 사진 분석 프롬프트 (AI 트레이너+영양사)
                console.log('📸 [사진 분석] 시작');
                const userName = currentProfile?.name || '회원';
                const weightDiff = currentWeight - currentProfile.goalWeight;
                const goalDescription = weightDiff > 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 감량` : (weightDiff < 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 증량` : '현재 체중 유지');

                const prompt = `당신은 ${userName} 회원님을 담당하는 전문 퍼스널 트레이너이자 영양 전문가입니다.

**회원 정보:**
- 이름: ${userName}
- 현재 체중: ${currentWeight}kg
- 목표 체중: ${currentProfile.goalWeight}kg
- 목표: ${goalDescription}

**분석 요청:**
1. 사진에서 음식 종류와 양을 파악 (예: '잡곡밥 2/3공기', '삼겹살 200g')
2. 영양소 추정 (칼로리, 탄수화물, 단백질, 지방)
3. 40자 이내의 조언 제공:
   - 단백질 부족 시: "${userName} 회원님, 단백질이 부족해요. 닭가슴살이나 두부를 추가하세요!"
   - 나트륨 과다 시: "${userName} 회원님, 나트륨이 높아요. 물을 충분히 드세요!"
   - 고칼로리 시: "${userName} 회원님, 오늘 운동 강도를 높여야 할 양이에요!"

**출력 형식 (JSON):**
{
  "foodName": "분석된 음식명 (양 포함)",
  "calories": 숫자,
  "carbs": 숫자,
  "protein": 숫자,
  "fat": 숫자,
  "advice": "${userName} 회원님... (40자 이내 조언)"
}

**주의:** JSON만 출력하고 다른 텍스트 포함 금지`;

                // Gemini Vision API 호출
                const responseText = await callGeminiVisionAPI(prompt, base64Image);
                const nutrition = parseNutritionResponse(responseText);

                return {
                    calories: nutrition.calories,
                    carbs: nutrition.carbs,
                    protein: nutrition.protein,
                    fat: nutrition.fat,
                    foodName: nutrition.foodName,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: nutrition.advice
                };

            } catch (error) {
                console.error('이미지 영양 분석 실패:', error);
                return {
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0,
                    foodName: '알 수 없음',
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `${currentProfile.name} 회원님, AI 분석에 실패했습니다. 나중에 다시 시도해주세요.`
                };
            }
        }

        // 텍스트에서 영양 분석
        async function analyzeNutritionFromText(text) {
            try {
                // 사용자 정보 가져오기
                const weightsSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .orderBy('date', 'desc')
                    .limit(1)
                    .get();

                const currentWeight = weightsSnapshot.empty
                    ? currentProfile.startWeight
                    : weightsSnapshot.docs[0].data().weight;

                // AI 프롬프트 생성 (트레이너 페르소나)
                const weightDiff = currentWeight - currentProfile.goalWeight;
                const goalDescription = weightDiff > 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 감량` : (weightDiff < 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 증량` : '현재 체중 유지');

                const prompt = `당신은 ${currentProfile.name} 회원님을 담당하는 전문 퍼스널 트레이너이자 영양 전문가입니다. 텍스트를 분석하여 영양 성분을 추정해주세요.

**회원 정보:**
- 회원명: ${currentProfile.name} 회원님
- 현재 체중: ${currentWeight}kg
- 목표 체중: ${currentProfile.goalWeight}kg
- 목표: ${goalDescription}

**회원님이 입력한 식사 내용:** "${text}"

이 식사의 영양 성분을 정확히 분석하고, 회원님의 다이어트 목표를 고려하여 전문가답게 조언해주세요.

**조언 작성 지침:**
- 호칭: 반드시 "${currentProfile.name} 회원님"으로 시작
- 톤: "힘든 거 알지만, 이거 드시면 [결과]해요" 같은 공감+현실적 조언
- 길이: 40자 이내

**반드시 아래 JSON 형식으로만 응답해주세요:**

{
  "calories": 숫자만 (kcal),
  "carbs": 숫자만 (그램),
  "protein": 숫자만 (그램),
  "fat": 숫자만 (그램),
  "foodName": "음식명",
  "advice": "${currentProfile.name} 회원님으로 시작하는 한 줄 조언 (40자 이내)"
}`;

                // Gemini Text API 호출
                const responseText = await callGeminiAPI(prompt);
                const nutrition = parseNutritionResponse(responseText);

                return {
                    calories: nutrition.calories,
                    carbs: nutrition.carbs,
                    protein: nutrition.protein,
                    fat: nutrition.fat,
                    foodName: nutrition.foodName,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: nutrition.advice
                };

            } catch (error) {
                console.error('텍스트 영양 분석 실패:', error);
                return {
                    calories: 0,
                    carbs: 0,
                    protein: 0,
                    fat: 0,
                    foodName: '알 수 없음',
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `${currentProfile.name} 회원님, AI 분석에 실패했습니다. 나중에 다시 시도해주세요.`
                };
            }
        }

        // ==================== 영양 대시보드 함수 ====================

        // 영양 대시보드 로드
        async function loadNutritionDashboard() {
            // 🔥 이 함수는 더 이상 사용하지 않음 (loadTodayNutrition으로 대체)
            // Firebase 인덱스 오류 방지를 위해 비활성화
            console.log('⚠️ loadNutritionDashboard는 더 이상 사용하지 않습니다.');
        }

        // 영양 차트 렌더링 (Chart.js)
        function renderNutritionChart(carbs, protein, fat) {
            const ctx = document.getElementById('nutritionChart');
            if (!ctx) return;

            // 기존 차트 제거
            if (nutritionChart) {
                nutritionChart.destroy();
            }

            // 데이터가 모두 0이면 차트를 그리지 않음
            if (carbs === 0 && protein === 0 && fat === 0) {
                nutritionChart = null;
                return;
            }

            nutritionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['탄수화물', '단백질', '지방'],
                    datasets: [{
                        data: [carbs, protein, fat],
                        backgroundColor: [
                            '#a1c4fd',
                            '#fccb90',
                            '#e0c3fc'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + Math.round(context.parsed) + 'g';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 영양 대시보드 새로고침
        async function refreshDashboardNutrition() {
            await loadNutritionDashboard();
        }

        // ========== Phase 1: 실시간 영양 섭취 관리 함수 ==========

        // 식사 추가 함수
        function addMeal(category, foodName, nutrition) {
            if (!nutrition || typeof nutrition !== 'object') {
                console.warn('유효하지 않은 영양 정보:', nutrition);
                return;
            }

            const meal = {
                category: category || '식사',
                foodName: foodName || '음식',
                food: foodName || '음식', // 🔥 displayTodayMealsList 호환성
                calories: parseFloat(nutrition.calories) || 0,
                carbs: parseFloat(nutrition.carbs) || 0,
                protein: parseFloat(nutrition.protein) || 0,
                fat: parseFloat(nutrition.fat) || 0,
                per100g: nutrition.per100g || null, // 🔥 100g당 정보 저장
                timestamp: new Date().toISOString()
            };

            todayIntake.meals.push(meal);
            todayIntake.calories += meal.calories;
            todayIntake.carbs += meal.carbs;
            todayIntake.protein += meal.protein;
            todayIntake.fat += meal.fat;

            console.log(`✅ 식사 추가됨: ${foodName} (${meal.calories}kcal)`);

            updateNutritionUI();
            checkCalorieOverage();

            // Firestore에 저장
            saveTodayNutritionToFirestore();

            // ========== Phase 1: 캘린더 통합 ==========
            saveToDailyLog(new Date(), 'nutrition', {
                foodName: foodName,
                calories: meal.calories,
                carbs: meal.carbs,
                protein: meal.protein,
                fat: meal.fat,
                timestamp: meal.timestamp
            });
            // ========================================
        }

        // 권장 섭취량 자동 계산 (Mifflin-St Jeor 공식)
        function calculateRecommendedIntake() {
            if (!currentProfile || !currentProfile.age || !currentProfile.height || !currentProfile.startWeight) {
                // 프로필 미입력 시 기본값
                return {
                    calories: 2400,
                    carbs: 300,
                    protein: 100,
                    fat: 80
                };
            }

            const { age, height, startWeight, gender, activityLevel, goal } = currentProfile;
            const weight = startWeight;

            // 기초대사량 계산 (Mifflin-St Jeor 공식)
            let bmr;
            if (gender === 'male' || gender === '남성') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }

            // 활동량 계수
            const activityMultipliers = {
                'sedentary': 1.2,
                'light': 1.375,
                'moderate': 1.55,
                'active': 1.725,
                'veryActive': 1.9
            };
            const activityMultiplier = activityMultipliers[activityLevel] || 1.55;

            // 총 에너지 소비량 (TDEE)
            let tdee = Math.round(bmr * activityMultiplier);

            // 목표에 따라 칼로리 조정
            if (goal === 'lose') {
                tdee = tdee - 500; // 체중 감량: -500kcal
            } else if (goal === 'gain') {
                tdee = tdee + 500; // 체중 증가: +500kcal
            }

            const targetCalories = Math.max(1200, tdee); // 최소 1200kcal 보장

            return {
                calories: targetCalories,
                carbs: Math.round(targetCalories * 0.5 / 4), // 50% 탄수화물
                protein: Math.round(targetCalories * 0.3 / 4), // 30% 단백질
                fat: Math.round(targetCalories * 0.2 / 9) // 20% 지방
            };
        }

        // UI 업데이트 함수
        function updateNutritionUI() {
            // 권장 섭취량 계산
            const recommended = calculateRecommendedIntake();

            // 식사 횟수 표시
            document.getElementById('todayMealCount').textContent = todayIntake.meals.length;
            
            // ========== 오늘 먹은 음식 목록 표시 ==========
            displayTodayMealsList();
            display100gNutrition(); // 🔥 100g당 영양정보 표시
            // =============================================

            // 남은 섭취량 계산
            const remainingCalories = recommended.calories - todayIntake.calories;
            const remainingCarbs = recommended.carbs - todayIntake.carbs;
            const remainingProtein = recommended.protein - todayIntake.protein;
            const remainingFat = recommended.fat - todayIntake.fat;

            // 현재 섭취량 표시 (형식: "0 / 2400 kcal")
            document.getElementById('todayCalories').textContent = `${Math.round(todayIntake.calories)} / ${recommended.calories} kcal`;
            document.getElementById('todayCarbs').textContent = `${Math.round(todayIntake.carbs)} / ${recommended.carbs} g`;
            document.getElementById('todayProtein').textContent = `${Math.round(todayIntake.protein)} / ${recommended.protein} g`;
            document.getElementById('todayFat').textContent = `${Math.round(todayIntake.fat)} / ${recommended.fat} g`;

            const caloriesElem = document.getElementById('remainingCalories');
            const carbsElem = document.getElementById('remainingCarbs');
            const proteinElem = document.getElementById('remainingProtein');
            const fatElem = document.getElementById('remainingFat');

            // 칼로리 (형식: "(2400 남음)" 또는 "(100 초과)")
            if (remainingCalories >= 0) {
                caloriesElem.textContent = `(${Math.round(remainingCalories)} 남음)`;
                caloriesElem.className = 'nutrition-remaining';
            } else {
                caloriesElem.textContent = `(${Math.abs(Math.round(remainingCalories))} 초과)`;
                caloriesElem.className = 'nutrition-remaining over';
            }

            // 탄수화물
            if (remainingCarbs >= 0) {
                carbsElem.textContent = `(${Math.round(remainingCarbs)}g 남음)`;
                carbsElem.className = 'nutrition-remaining';
            } else {
                carbsElem.textContent = `(${Math.abs(Math.round(remainingCarbs))}g 초과)`;
                carbsElem.className = 'nutrition-remaining over';
            }

            // 단백질
            if (remainingProtein >= 0) {
                proteinElem.textContent = `(${Math.round(remainingProtein)}g 남음)`;
                proteinElem.className = 'nutrition-remaining';
            } else {
                proteinElem.textContent = `(${Math.abs(Math.round(remainingProtein))}g 초과)`;
                proteinElem.className = 'nutrition-remaining over';
            }

            // 지방
            if (remainingFat >= 0) {
                fatElem.textContent = `(${Math.round(remainingFat)}g 남음)`;
                fatElem.className = 'nutrition-remaining';
            } else {
                fatElem.textContent = `(${Math.abs(Math.round(remainingFat))}g 초과)`;
                fatElem.className = 'nutrition-remaining over';
            }

            // 차트 업데이트
            if (todayIntake.carbs > 0 || todayIntake.protein > 0 || todayIntake.fat > 0) {
                renderNutritionChart(todayIntake.carbs, todayIntake.protein, todayIntake.fat);
            }

            console.log('📊 영양 UI 업데이트 완료:', todayIntake);
        }
        
        // 오늘 먹은 음식 목록 표시
        function displayTodayMealsList() {
            const container = document.getElementById('todayMealsList');
            
            console.log('🍽️ displayTodayMealsList 호출, meals:', todayIntake.meals);
            console.log('🍽️ meals 상세:', JSON.stringify(todayIntake.meals, null, 2));
            
            if (todayIntake.meals.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">아직 기록된 식사가 없습니다</div>';
                return;
            }
            
            // 식사 시간별로 그룹핑
            const mealsByType = {
                '아침': [],
                '점심': [],
                '저녁': [],
                '간식': []
            };
            
            todayIntake.meals.forEach((meal, globalIndex) => {
                console.log(`🍽️ 처리 중인 meal[${globalIndex}]:`, meal, 'type:', meal.type, 'mealType:', meal.mealType, 'category:', meal.category);
                const mealType = meal.type || meal.mealType || meal.meal || meal.category || '점심'; // 🔥 category 추가
                
                // food 필드 우선순위: food > foodName > name
                meal._displayName = meal.food || meal.foodName || meal.name || '알 수 없는 음식';
                meal._globalIndex = globalIndex; // 전역 인덱스 저장
                
                if (mealsByType[mealType]) {
                    mealsByType[mealType].push(meal);
                } else {
                    // 타입이 없거나 다른 경우 점심으로
                    console.warn('⚠️ 알 수 없는 mealType:', mealType, '→ 점심으로 분류');
                    mealsByType['점심'].push(meal);
                }
            });
            
            let html = '';
            
            Object.keys(mealsByType).forEach(mealType => {
                const meals = mealsByType[mealType];
                if (meals.length > 0) {
                    const emoji = mealType === '아침' ? '🌅' : mealType === '점심' ? '☀️' : mealType === '저녁' ? '🌙' : '🍪';
                    
                    html += `
                        <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-weight: bold; color: #333; margin-bottom: 8px;">
                                ${emoji} ${mealType}
                            </div>
                    `;
                    
                    meals.forEach((meal) => {
                        const time = meal.timestamp ? new Date(meal.timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '';
                        const foodName = meal._displayName || '알 수 없음';
                        const globalIndex = meal._globalIndex;
                        
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div onclick="editMealByGlobalIndex(${globalIndex})" style="flex: 1; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform='translateX(3px)'" onmouseout="this.style.transform=''">
                                    <div style="font-size: 0.95rem; color: #333; font-weight: 600;">${foodName}</div>
                                    ${time ? `<div style="font-size: 0.75rem; color: #999; margin-top: 3px;">⏰ ${time}</div>` : ''}
                                    <div style="font-size: 0.75rem; color: #666; margin-top: 3px;">
                                        ${meal.carbs && meal.carbs > 0 ? `탄 ${Math.round(meal.carbs)}g` : ''}
                                        ${meal.protein && meal.protein > 0 ? ` | 단 ${Math.round(meal.protein)}g` : ''}
                                        ${meal.fat && meal.fat > 0 ? ` | 지 ${Math.round(meal.fat)}g` : ''}
                                        ${(!meal.carbs || meal.carbs === 0) && (!meal.protein || meal.protein === 0) && (!meal.fat || meal.fat === 0) ? '<span style="color: #ff6b6b;">⚠️ 영양 정보 없음</span>' : ''}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.95rem; color: #00B89A; font-weight: 700;">
                                            ${Math.round(meal.calories || 0)} kcal
                                        </div>
                                        <div style="font-size: 0.7rem; color: #999; margin-top: 2px;">✏️ 수정</div>
                                    </div>
                                    <button onclick="event.stopPropagation(); if(confirm('${foodName}을(를) 삭제하시겠습니까?')) { deleteMeal(${globalIndex}); }" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ff5252'" onmouseout="this.style.background='#ff6b6b'">
                                        🗑️ 삭제
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
            });
            
            container.innerHTML = html;
        }
        
        // 🔥 새 기능: 100g당 영양정보 표시
        function display100gNutrition() {
            console.log('📊 display100gNutrition 호출');
            const container = document.getElementById('per100gContainer');
            const wrapper = document.getElementById('per100gNutrition');
            
            if (!container || !wrapper) {
                console.error('❌ 100g 영양정보 컨테이너를 찾을 수 없습니다');
                return;
            }
            
            console.log('📊 todayIntake.meals:', todayIntake.meals);
            
            if (todayIntake.meals.length === 0) {
                console.log('📊 식사 기록이 없음');
                wrapper.style.display = 'none';
                return;
            }
            
            let html = '';
            const uniqueFoods = new Map(); // 중복 제거용
            
            todayIntake.meals.forEach(meal => {
                const foodName = meal.food || meal.foodName || meal.name || '알 수 없음';
                console.log(`📊 처리 중: ${foodName}, per100g:`, meal.per100g, 'calories:', meal.calories);
                
                // 🔥 per100g 정보 확인 및 생성
                let per100g = null;
                
                if (meal.per100g && typeof meal.per100g === 'object') {
                    // per100g 정보가 있으면 그대로 사용
                    per100g = meal.per100g;
                } else if (meal.calories > 0) {
                    // 🔥 per100g 정보가 없으면 대략적으로 추정 (총량 기준)
                    // 일반적으로 1인분이 200-300g이라고 가정
                    const estimatedWeight = 250; // 그람
                    per100g = {
                        calories: Math.round((meal.calories / estimatedWeight) * 100),
                        carbs: Math.round((meal.carbs / estimatedWeight) * 100),
                        protein: Math.round((meal.protein / estimatedWeight) * 100),
                        fat: Math.round((meal.fat / estimatedWeight) * 100)
                    };
                    console.log(`💡 ${foodName}: per100g 정보 추정됨`, per100g);
                }
                
                // 유효한 영양 정보가 있는지 확인
                if (per100g && (per100g.calories > 0 || per100g.carbs > 0 || per100g.protein > 0 || per100g.fat > 0)) {
                    if (!uniqueFoods.has(foodName)) {
                        uniqueFoods.set(foodName, per100g);
                        console.log(`✅ ${foodName} 추가됨:`, per100g);
                    }
                }
            });
            
            console.log('📊 uniqueFoods.size:', uniqueFoods.size);
            
            if (uniqueFoods.size === 0) {
                console.log('📊 표시할 음식이 없음');
                wrapper.style.display = 'none';
                return;
            }
            
            uniqueFoods.forEach((per100g, foodName) => {
                html += `
                    <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #ddd;">
                        <div style="font-weight: 600; color: #333; margin-bottom: 4px;">🍽️ ${foodName}</div>
                        <div style="color: #666; padding-left: 15px;">
                            <span style="background: #fff3cd; padding: 2px 6px; border-radius: 4px; margin-right: 8px;">
                                🔥 ${per100g.calories}kcal
                            </span>
                            <span style="margin-right: 8px;">탄 ${per100g.carbs}g</span>
                            <span style="margin-right: 8px;">단 ${per100g.protein}g</span>
                            <span>지 ${per100g.fat}g</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            wrapper.style.display = 'block';
        }
        
        // 현재 수정 중인 식사 인덱스
        let editingMealIndex = -1;
        let editingMealType = '점심';
        
        // 식사 수정 모달 열기
        function editMealByGlobalIndex(globalIndex) {
            console.log('🍽️ 식사 수정 (globalIndex):', globalIndex);
            
            const meal = todayIntake.meals[globalIndex];
            
            if (!meal) {
                console.error('❌ 식사를 찾을 수 없습니다:', globalIndex);
                alert('식사 정보를 찾을 수 없습니다.');
                return;
            }
            
            console.log('📝 수정할 식사:', meal);
            
            editingMealIndex = globalIndex;
            editingMealType = meal.type || meal.mealType || meal.meal || '점심';
            
            // 모달 열기
            document.getElementById('editMealModal').style.display = 'flex';
            
            // 기존 값 채우기
            document.getElementById('editFoodName').value = meal.food || meal.foodName || meal.name || '';
            document.getElementById('editCalories').value = meal.calories || 0;
            document.getElementById('editCarbs').value = meal.carbs || 0;
            document.getElementById('editProtein').value = meal.protein || 0;
            document.getElementById('editFat').value = meal.fat || 0;
            
            // 식사 타입 버튼 활성화
            selectEditMealType(editingMealType);
            
            // 직접 입력 필드 숨김
            document.getElementById('manualEditFields').style.display = 'none';
        }
        
        // 식사 타입 선택
        function selectEditMealType(type) {
            editingMealType = type;
            
            // 모든 버튼 비활성화
            ['아침', '점심', '저녁', '간식'].forEach(t => {
                const btn = document.getElementById(`editMealType-${t}`);
                if (btn) {
                    btn.style.opacity = '0.5';
                    btn.style.transform = 'scale(1)';
                }
            });
            
            // 선택된 버튼 활성화
            const selectedBtn = document.getElementById(`editMealType-${type}`);
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.05)';
            }
        }
        
        // 수정 방법 선택
        function selectEditMethod(method) {
            if (method === 'manual') {
                // 직접 입력
                document.getElementById('manualEditFields').style.display = 'block';
            } else if (method === 'ai') {
                // AI 재분석 (시간 유지)
                const meal = todayIntake.meals[editingMealIndex];
                if (!meal) {
                    alert('식사 정보를 찾을 수 없습니다.');
                    return;
                }
                
                const foodName = meal.food || meal.foodName || meal.name || '이 음식';
                const mealType = editingMealType;
                const originalTimestamp = meal.timestamp; // 🔥 원래 시간 저장
                const originalPhoto = meal.photo || meal.photoURL; // 🔥 원래 사진 URL 저장
                
                closeEditMealModal();
                
                if (confirm(`"${foodName}"을 AI로 재분석하시겠습니까?\n\n내용만 변경되며, 등록 시간은 유지됩니다.`)) {
                    // 🔥 시간과 인덱스를 전역 변수로 저장 (재입력 시 사용)
                    window.editingMealData = {
                        index: editingMealIndex,
                        originalTimestamp: originalTimestamp,
                        originalPhoto: originalPhoto,
                        mealType: mealType
                    };
                    
                    // 재분석 모달 표시
                    showReanalysisModal(mealType, true); // true = 수정 모드
                }
            }
        }
        
        // 재분석 전용 모달 (깔끔한 UI)
        function showReanalysisModal(mealType, isEditMode = false) {
            const mealTypeKorean = mealType === '아침' ? '아침' : 
                                   mealType === '점심' ? '점심' : 
                                   mealType === '저녁' ? '저녁' : '간식';
            
            const titleText = isEditMode ? '재분석 (시간 유지)' : '재분석';
            const descText = isEditMode ? 
                '등록 시간은 유지되며, 내용만 변경됩니다.' : 
                '기존 데이터가 삭제되었습니다.<br>새로운 방법으로 다시 입력해주세요.';
            
            // 모달 HTML 생성
            const modalHtml = `
                <div class="modal active" id="reanalysisModal" style="z-index: 10000;">
                    <div class="modal-content" style="max-width: 400px; animation: slideUp 0.3s;">
                        <div style="padding: 25px; text-align: center;">
                            <h3 style="margin: 0 0 20px; font-size: 1.3rem; color: #333;">
                                🍽️ ${mealTypeKorean} ${titleText}
                            </h3>
                            <p style="color: #666; margin-bottom: 30px; line-height: 1.6;">
                                ${descText}
                            </p>
                            
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <button class="input-method-btn" onclick="closeReanalysisModal(); currentMealType='${mealType}'; openMealInputModal(${isEditMode});" 
                                        style="width: 100%; padding: 18px; font-size: 1.1rem; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s;">
                                    ✍️ 글로 입력하기
                                </button>
                                <button class="input-method-btn" onclick="closeReanalysisModal(); currentMealType='${mealType}'; uploadFoodPhoto(${isEditMode});" 
                                        style="width: 100%; padding: 18px; font-size: 1.1rem; border-radius: 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; cursor: pointer; transition: transform 0.2s;">
                                    📷 사진 촬영하기
                                </button>
                                <button onclick="closeReanalysisModal(); window.editingMealData = null;" 
                                        style="width: 100%; padding: 15px; font-size: 1rem; border-radius: 10px; background: #f0f0f0; color: #666; border: none; cursor: pointer; margin-top: 8px;">
                                    취소
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 재분석 모달 제거
            const existingModal = document.getElementById('reanalysisModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeReanalysisModal() {
            const modal = document.getElementById('reanalysisModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 식사 삭제
        async function deleteMeal(globalIndex) {
            const meal = todayIntake.meals[globalIndex];
            if (!meal) return;
            
            try {
                // 🔥 앨범 동기화: photos 컬렉션에서 삭제
                // 1) 사진이 있는 경우: photoURL 기준 삭제
                if (meal.photo || meal.photoURL) {
                    const photoURL = meal.photo || meal.photoURL;
                    console.log('🗑️ 앨범에서 사진 삭제 시도 (photoURL):', photoURL);
                    
                    const photosSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(currentUser.uid)
                        .collection('photos')
                        .where('url', '==', photoURL)
                        .get();
                    
                    photosSnapshot.forEach(async (doc) => {
                        await doc.ref.delete();
                        console.log('✅ 앨범에서 사진 삭제 완료:', doc.id);
                    });
                }
                
                // 2) text 기반 식사인 경우: food + mealType + timestamp 기준 삭제
                const foodName = meal.food || meal.foodName || meal.name;
                const mealCategory = meal.category || meal.type || meal.mealType;
                const mealTimestamp = meal.timestamp;
                
                if (foodName && mealCategory) {
                    console.log('🗑️ 앨범에서 text 기반 식사 삭제 시도:', foodName, mealCategory);
                    
                    // mealType과 text 매칭으로 삭제
                    const textPattern = `${mealCategory}: ${foodName}`;
                    console.log('🔍 검색 패턴:', textPattern);
                    
                    const textMealsSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(currentUser.uid)
                        .collection('photos')
                        .where('category', '==', 'food')
                        .get();
                    
                    textMealsSnapshot.forEach(async (doc) => {
                        const data = doc.data();
                        
                        // text 필드 매칭 (예: "점심: 짬뽕,꿔바로우")
                        if (data.text && data.text === textPattern) {
                            await doc.ref.delete();
                            console.log('✅ 앨범에서 text 식사 삭제 완료:', doc.id, textPattern);
                        }
                    });
                }
                
                // 🔥 중첩 구조 고려한 영양소 추출
                const mealCalories = meal.calories || (meal.nutrition?.calories) || 0;
                const mealCarbs = meal.carbs || (meal.nutrition?.carbs) || 0;
                const mealProtein = meal.protein || (meal.nutrition?.protein) || 0;
                const mealFat = meal.fat || (meal.nutrition?.fat) || 0;
                
                console.log(`🗑️ 삭제할 식사 영양소: ${mealCalories}kcal, 탄${mealCarbs}g, 단${mealProtein}g, 지${mealFat}g`);
                
                // 영양소 차감
                todayIntake.calories -= mealCalories;
                todayIntake.carbs -= mealCarbs;
                todayIntake.protein -= mealProtein;
                todayIntake.fat -= mealFat;
                
                // 음수 방지
                todayIntake.calories = Math.max(0, todayIntake.calories);
                todayIntake.carbs = Math.max(0, todayIntake.carbs);
                todayIntake.protein = Math.max(0, todayIntake.protein);
                todayIntake.fat = Math.max(0, todayIntake.fat);
                
                console.log('🗑️ 차감 후 총 영양소:', todayIntake);
                
                // 배열에서 제거
                todayIntake.meals.splice(globalIndex, 1);
                
                // Firebase 저장
                await saveTodayNutritionToFirestore();
                
                // UI 업데이트
                updateNutritionUI();
                
                showAIToast('식사 기록이 삭제되었습니다.', 3000);
            } catch (error) {
                console.error('식사 삭제 오류:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }
        
        // 수정 저장
        function saveEditedMeal() {
            const meal = todayIntake.meals[editingMealIndex];
            if (!meal) {
                alert('식사 정보를 찾을 수 없습니다.');
                return;
            }
            
            const foodName = document.getElementById('editFoodName').value.trim();
            const calories = parseFloat(document.getElementById('editCalories').value) || 0;
            const carbs = parseFloat(document.getElementById('editCarbs').value) || 0;
            const protein = parseFloat(document.getElementById('editProtein').value) || 0;
            const fat = parseFloat(document.getElementById('editFat').value) || 0;
            
            if (!foodName) {
                alert('음식 이름을 입력해주세요.');
                return;
            }
            
            // 기존 값 제거
            todayIntake.calories -= (meal.calories || 0);
            todayIntake.carbs -= (meal.carbs || 0);
            todayIntake.protein -= (meal.protein || 0);
            todayIntake.fat -= (meal.fat || 0);
            
            // 새 값으로 업데이트
            meal.type = editingMealType;
            meal.mealType = editingMealType;
            meal.meal = editingMealType;
            meal.food = foodName;
            meal.foodName = foodName;
            meal.name = foodName;
            meal.calories = calories;
            meal.carbs = carbs;
            meal.protein = protein;
            meal.fat = fat;
            
            // 총합 다시 계산
            todayIntake.calories += calories;
            todayIntake.carbs += carbs;
            todayIntake.protein += protein;
            todayIntake.fat += fat;
            
            // Firebase에 저장
            saveTodayNutritionToFirestore();
            
            // UI 업데이트
            updateNutritionUI();
            
            // 모달 닫기
            closeEditMealModal();
            
            showAIToast(`✅ ${foodName} 정보가 수정되었습니다!`, 3000);
        }
        
        // 수정 모달 닫기
        function closeEditMealModal() {
            document.getElementById('editMealModal').style.display = 'none';
            editingMealIndex = -1;
        }

        // 칼로리 초과 체크
        // 🔥 5. 팩트체크 & 미래 예측 (과식 시 단호한 경고)
        async function checkCalorieOverage() {
            const remaining = dailyNutrition.totalCalories - todayIntake.calories;

            if (remaining < 0) {
                const overage = Math.abs(remaining);
                const userName = currentProfile?.name || '회월';
                
                // 🔥 목표 달성일 지연 계산
                // 7,700kcal = 1kg 체지방
                // 500kcal 초과 = 약 0.5~1일 지연
                const weightToLose = (currentProfile?.startWeight || 70) - (currentProfile?.goalWeight || 60); // 감량 목표 (kg)
                const totalCalorieDeficit = weightToLose * 7700; // 총 필요 칼로리 적자
                const delayDays = Math.ceil(overage / 500); // 500kcal 초과 = 약 1일 지연
                
                console.warn('⚠️ 칼로리 초과:', overage, 'kcal / 목표 달성 지연:', delayDays, '일');
                
                // 🔥 단호한 선배 트레이너 프롬프트
                const warningPrompt = `당신은 ${userName} 회원님의 담당 선배 트레이너입니다.

**상황:**
- 회원님이 오늘 목표 칼로리를 ${Math.round(overage)}kcal 초과했습니다.
- 권장 섭취량: ${dailyNutrition.totalCalories}kcal
- 실제 섭취량: ${todayIntake.calories}kcal
- 현재 체중: ${currentProfile?.startWeight || currentProfile?.currentWeight}kg
- 목표 체중: ${currentProfile?.goalWeight}kg
- **목표 달성일이 최소 ${delayDays}일 더 멀어졌습니다**

**응답 요구사항:**
1. "${userName} 회원님"으로 시작
2. 과식에 대한 강력한 경고 (걸린하고 화난 듯한 톤)
3. 목표 달성일 지연 사실 명시 ("최소 ${delayDays}일 더 멀어졌다")
4. 구체적인 보상 운동 또는 단식 지시 (예: "인터벌 러닝 1시간", "내일 정오까지 물 외 금식")
5. 길이: 50자 이내
6. 걸린하고 화난 듯한 선배 트레이너 말투

단호하고 현실적인 경고 메시지를 50자 이내로 작성하세요.`;
                
                try {
                    const warningResponse = await callGeminiAPIBase(warningPrompt);
                    showAIToast(warningResponse, 10000); // 10초간 표시
                } catch (error) {
                    console.error('❌ AI 경고 생성 실패:', error);
                    // 폴백 메시지
                    showAIToast(`${userName} 회원님, 오늘 목표 칼로리를 ${Math.round(overage)}kcal 초과하셨습니다. 목표 달성일이 최소 ${delayDays}일 더 멀어졌어요. 내일 반드시 보상 운동 하세요! 💪`, 10000);
                }
                
            } else if (remaining < 300 && todayIntake.meals.length >= 2) {
                const userName = currentProfile?.name || '회원';
                showAIToast(`${userName} 회원님, 오늘 남은 칼로리가 ${Math.round(remaining)}kcal입니다. 잘 관리하고 계시네요! 👍`, 5000);
            }
        }

        // 자정 초기화 함수
        async function resetDailyNutrition() {
            console.log('🌙 자정 초기화 시작...');

            // 오늘 데이터를 Firestore에 최종 저장
            await saveTodayNutritionToFirestore();

            // todayIntake 초기화
            todayIntake = {
                calories: 0,
                carbs: 0,
                protein: 0,
                fat: 0,
                meals: []
            };

            updateNutritionUI();
            console.log('✅ 영양 데이터 초기화 완료');
        }

        // 자정 초기화 타이머 설정
        function setupMidnightReset() {
            if (midnightResetInterval) {
                clearInterval(midnightResetInterval);
            }

            // 1분마다 체크
            midnightResetInterval = setInterval(() => {
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 0) {
                    resetDailyNutrition();
                }
            }, 60000); // 1분마다 체크

            console.log('⏰ 자정 초기화 타이머 설정 완료');
        }

        // Firestore에 오늘 영양 데이터 저장
        async function saveTodayNutritionToFirestore() {
            if (!currentUser) return;

            try {
                const today = new Date();
                const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyNutrition').doc(dateStr)
                    .set({
                        date: dateStr,
                        calories: todayIntake.calories,
                        carbs: todayIntake.carbs,
                        protein: todayIntake.protein,
                        fat: todayIntake.fat,
                        mealCount: todayIntake.meals.length,
                        meals: todayIntake.meals,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                console.log('💾 영양 데이터 Firestore 저장 완료:', dateStr);
            } catch (error) {
                console.error('❌ 영양 데이터 저장 실패:', error);
            }
        }

        // 오늘 영양 데이터 로드 (앱 시작 시)
        async function loadTodayNutrition() {
            if (!currentUser) return;

            try {
                const today = new Date();
                const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                const doc = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyNutrition').doc(dateStr)
                    .get();

                if (doc.exists) {
                    const data = doc.data();
                    
                    // 🔥 기존 데이터 구조 정규화 (nutrition.calories → calories)
                    const normalizedMeals = (data.meals || []).map(meal => {
                        if (meal.nutrition && typeof meal.nutrition === 'object') {
                            // 중첩 구조 → flat 구조로 변환
                            return {
                                ...meal,
                                food: meal.food || meal.foodName || meal.name,
                                foodName: meal.foodName || meal.food || meal.name,
                                calories: meal.nutrition.calories || meal.calories || 0,
                                carbs: meal.nutrition.carbs || meal.carbs || 0,
                                protein: meal.nutrition.protein || meal.protein || 0,
                                fat: meal.nutrition.fat || meal.fat || 0
                            };
                        }
                        // 이미 flat 구조면 그대로 반환
                        return {
                            ...meal,
                            food: meal.food || meal.foodName || meal.name,
                            foodName: meal.foodName || meal.food || meal.name
                        };
                    });
                    
                    // 🔥 합계 재계산 (기존 합계가 부정확할 수 있음)
                    let recalcCalories = 0, recalcCarbs = 0, recalcProtein = 0, recalcFat = 0;
                    normalizedMeals.forEach(meal => {
                        recalcCalories += meal.calories || 0;
                        recalcCarbs += meal.carbs || 0;
                        recalcProtein += meal.protein || 0;
                        recalcFat += meal.fat || 0;
                    });
                    
                    console.log('📊 Firebase 저장된 합계:', { calories: data.calories, carbs: data.carbs, protein: data.protein, fat: data.fat });
                    console.log('📊 재계산된 합계:', { calories: recalcCalories, carbs: recalcCarbs, protein: recalcProtein, fat: recalcFat });
                    
                    todayIntake = {
                        calories: recalcCalories, // 🔥 재계산된 값 사용
                        carbs: recalcCarbs,
                        protein: recalcProtein,
                        fat: recalcFat,
                        meals: normalizedMeals
                    };
                    
                    console.log('📥 오늘 영양 데이터 로드 완료:', todayIntake);
                    console.log('🍽️ 식사 개수:', todayIntake.meals.length);
                    if (todayIntake.meals.length > 0) {
                        console.log('🍽️ 식사 목록:', todayIntake.meals);
                    }
                    updateNutritionUI();
                } else {
                    console.log('📝 오늘은 아직 식사 기록이 없습니다.');
                }
            } catch (error) {
                console.error('❌ 영양 데이터 로드 실패:', error);
            }
        }

        // ========== Phase 1: 캘린더 통합 함수 ==========

        // 일일 로그에 데이터 저장 (캘린더 연동)
        async function saveToDailyLog(date, type, data) {
            if (!currentUser) {
                console.warn('⚠️ 사용자가 로그인되지 않음');
                return;
            }

            try {
                // 날짜를 YYYY-MM-DD 형식으로 변환
                const dateObj = date instanceof Date ? date : new Date(date);
                const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;

                // 기존 로그 가져오기
                const logRef = db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').doc(dateStr);

                const logDoc = await logRef.get();
                let logData = logDoc.exists ? logDoc.data() : { date: dateStr };

                // 타입별 데이터 저장
                switch(type) {
                    case 'weight':
                        logData.weight = data.weight;
                        logData.weightTimestamp = data.timestamp || firebase.firestore.FieldValue.serverTimestamp();
                        break;

                    case 'nutrition':
                        if (!logData.nutrition) {
                            logData.nutrition = {
                                calories: 0,
                                carbs: 0,
                                protein: 0,
                                fat: 0,
                                meals: []
                            };
                        }
                        // 영양 데이터 누적
                        logData.nutrition.calories = (logData.nutrition.calories || 0) + (data.calories || 0);
                        logData.nutrition.carbs = (logData.nutrition.carbs || 0) + (data.carbs || 0);
                        logData.nutrition.protein = (logData.nutrition.protein || 0) + (data.protein || 0);
                        logData.nutrition.fat = (logData.nutrition.fat || 0) + (data.fat || 0);
                        if (data.foodName) {
                            logData.nutrition.meals.push({
                                foodName: data.foodName,
                                calories: data.calories,
                                timestamp: data.timestamp || new Date().toISOString()
                            });
                        }
                        break;

                    case 'exercise':
                        if (!logData.exercises) logData.exercises = [];
                        logData.exercises.push({
                            name: data.name,
                            duration: data.duration,
                            timestamp: data.timestamp || new Date().toISOString()
                        });
                        break;

                    case 'fasting':
                        logData.fasting = {
                            duration: data.duration, // 분 단위
                            startTime: data.startTime,
                            endTime: data.endTime,
                            stage: data.stage || '단식 완료'
                        };
                        break;

                    case 'water':
                        logData.water = data.amount; // ml 단위
                        break;

                    case 'plan':
                        logData.plan = {
                            schedules: data.schedules || [],
                            diary: data.diary || ''
                        };
                        break;

                    case 'photo_body':
                    case 'photo_food':
                    case 'photo_exercise':
                        if (!logData.photos) logData.photos = [];
                        logData.photos.push({
                            category: type.replace('photo_', ''),
                            url: data.url,
                            timestamp: data.timestamp || new Date().toISOString()
                        });
                        break;

                    default:
                        console.warn('⚠️ 알 수 없는 타입:', type);
                        return;
                }

                // Firestore에 저장
                logData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                await logRef.set(logData, { merge: true });

                console.log(`💾 일일 로그 저장 완료 [${dateStr}] ${type}:`, data);

            } catch (error) {
                console.error('❌ 일일 로그 저장 실패:', error);
            }
        }

        // 캘린더에서 특정 타입의 데이터 삭제
        async function removeFromDailyLog(date, type) {
            if (!currentUser) {
                console.warn('⚠️ 사용자가 로그인되지 않음');
                return;
            }

            try {
                // 날짜를 YYYY-MM-DD 형식으로 변환
                const dateObj = date instanceof Date ? date : new Date(date);
                const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;

                // Firestore에서 해당 필드 삭제
                const logRef = db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').doc(dateStr);

                await logRef.update({
                    [type]: firebase.firestore.FieldValue.delete()
                });

                console.log(`🗑️ 캘린더에서 삭제 완료 [${dateStr}] ${type}`);

            } catch (error) {
                // 문서가 존재하지 않는 경우는 무시
                if (error.code === 'not-found') {
                    console.log('삭제할 데이터가 없습니다.');
                } else {
                    console.error('❌ 캘린더 데이터 삭제 실패:', error);
                }
            }
        }

        // 특정 날짜의 통합 데이터 가져오기 (캘린더 조회용)
        async function getDailyData(date) {
            if (!currentUser) return null;

            try {
                const dateObj = date instanceof Date ? date : new Date(date);
                const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;

                const logDoc = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').doc(dateStr)
                    .get();

                if (logDoc.exists) {
                    return logDoc.data();
                } else {
                    return null;
                }
            } catch (error) {
                console.error('❌ 일일 데이터 조회 실패:', error);
                return null;
            }
        }

        // ==================== AI 토스트 팝업 함수 ====================

        // AI 토스트 표시
        function showAIToast(message, duration = 5000) {
            const toast = document.getElementById('aiToast');
            const messageEl = document.getElementById('aiToastMessage');

            // 기존 타임아웃 취소
            if (aiToastTimeout) {
                clearTimeout(aiToastTimeout);
            }

            // 메시지 설정 및 표시
            messageEl.textContent = message;
            toast.classList.remove('hidden');

            // 자동 숨김 (duration이 0이면 수동으로만 닫힘)
            if (duration > 0) {
                aiToastTimeout = setTimeout(() => {
                    toast.classList.add('hidden');
                }, duration);
            }
        }

        // AI 토스트에서 채팅 열기
        function openAIChatFromToast() {
            // 토스트 숨김
            document.getElementById('aiToast').classList.add('hidden');

            // AI 채팅 탭으로 이동
            switchTab('home');

            // AI 채팅 섹션 열기
            const aiChatDetails = document.getElementById('aiChatDetails');
            if (aiChatDetails && aiChatDetails.style.display !== 'block') {
                toggleAIChat();
            }

            // 입력창에 포커스
            setTimeout(() => {
                const chatInput = document.getElementById('aiChatInput');
                if (chatInput) {
                    chatInput.focus();
                }
            }, 300);
        }

        // AI 대화 맥락 프롬프트 생성
        async function buildAIContextPrompt(userMessage, chatHistory) {
            try {
                // 최근 5개 대화 가져오기
                const recentChats = chatHistory.slice(-10); // 최근 5쌍 (user+assistant)
                const recentChatText = recentChats
                    .map(chat => `${chat.role === 'user' ? '사용자' : 'AI'}: ${chat.content}`)
                    .join('\n');

                // 오늘의 영양 데이터 가져오기
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);

                const foodPhotosSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('category', '==', 'food')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(todayStart))
                    .where('uploadedAt', '<', firebase.firestore.Timestamp.fromDate(todayEnd))
                    .get();

                let totalCalories = 0;
                const meals = [];

                foodPhotosSnapshot.forEach(doc => {
                    const photo = doc.data();
                    if (photo.nutrition) {
                        totalCalories += photo.nutrition.calories || 0;
                        meals.push(`${photo.nutrition.foodName} (${Math.round(photo.nutrition.calories)}kcal)`);
                    }
                });

                // todayIntake에서도 식사 정보 가져오기
                const mealCount = todayIntake.meals ? todayIntake.meals.length : 0;
                const caloriesRemaining = dailyNutrition.totalCalories - (todayIntake.calories || 0);

                // 물 섭취량 가져오기
                const waterSettings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"cupSize": 250, "goalLiters": 2, "filled": []}');
                const waterIntake = (waterSettings.filled ? waterSettings.filled.length : 0) * waterSettings.cupSize;
                const waterGoal = waterSettings.goalLiters * 1000;

                // 오늘의 단식 기록 가져오기
                let fastingDuration = 0;
                const fastingRecords = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('fastingRecords')
                    .where('date', '==', today.toISOString().split('T')[0])
                    .get();

                fastingRecords.forEach(doc => {
                    const record = doc.data();
                    fastingDuration += record.duration || 0;
                });

                const fastingHours = Math.floor(fastingDuration / (1000 * 60 * 60));
                const fastingMinutes = Math.floor((fastingDuration % (1000 * 60 * 60)) / (1000 * 60));

                // 현재 체중 가져오기
                const weightsSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .orderBy('date', 'desc')
                    .limit(1)
                    .get();

                const currentWeight = weightsSnapshot.empty
                    ? currentProfile.startWeight
                    : weightsSnapshot.docs[0].data().weight;

                // 함께한 날 계산
                const createdAt = currentProfile.createdAt ? currentProfile.createdAt.toDate() : new Date();
                const daysActive = Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24));

                // 주간 체중 변화 계산
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const weeklyWeights = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(sevenDaysAgo))
                    .orderBy('date', 'asc')
                    .get();

                let weeklyWeightChange = 0;
                if (!weeklyWeights.empty && weeklyWeights.docs.length >= 2) {
                    const firstWeight = weeklyWeights.docs[0].data().weight;
                    const lastWeight = weeklyWeights.docs[weeklyWeights.docs.length - 1].data().weight;
                    weeklyWeightChange = firstWeight - lastWeight;
                }

                // 컨텍스트 포함 프롬프트 생성 (AI 트레이너 페르소나)
                const weightDiff = currentWeight - currentProfile.goalWeight;
                const goalDescription = weightDiff > 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 감량` : (weightDiff < 0 ? `${Math.abs(weightDiff).toFixed(1)}kg 증량` : '현재 체중 유지');

                const contextPrompt = `당신은 전문 퍼스널 트레이너입니다. ${currentProfile.name} 회원님의 다이어트를 담당하고 있습니다.

**[트레이너 페르소나 지침]**
- 호칭: 반드시 "${currentProfile.name} 회원님"으로 호칭하세요
- 말투: 전문가답게 정중하지만, 필요시 단호하게 조언하세요
- 태도: "힘든 거 알아요"라는 공감과 "그래도 안 됩니다"라는 원칙을 병행하세요
- 응답: 3-4문장 이내로 간결하게, 존댓말을 사용하세요
- 중요: 팩트만 이야기하고 과장하지 마세요. 불가능한 목표는 제시하지 마세요.

**사용자 프로필:**
- 회원명: ${currentProfile.name} 회원님
- 시작 체중: ${currentProfile.startWeight}kg
- 현재 체중: ${currentWeight}kg
- 목표 체중: ${currentProfile.goalWeight}kg
- 목표: ${goalDescription}
- 함께한 날: ${daysActive}일

**오늘의 활동 기록:**
- 식사: ${mealCount}회 (${Math.round(todayIntake.calories || 0)}kcal 섭취)
- 남은 칼로리: ${Math.round(caloriesRemaining)}kcal
- 물 섭취: ${waterIntake}ml / ${waterGoal}ml
${fastingDuration > 0 ? `- 단식 시간: ${fastingHours}시간 ${fastingMinutes}분` : '- 단식: 미진행'}

**오늘의 식사 내역:**
${meals.length > 0 ? meals.map((m, i) => `${i + 1}. ${m}`).join('\n') : '아직 기록된 식사가 없습니다.'}

**주간 변화:**
- 체중 변화 (최근 7일): ${weeklyWeightChange > 0 ? '-' : '+'}${Math.abs(weeklyWeightChange).toFixed(1)}kg
${weeklyWeightChange > 0 ? '(감량 중 👍)' : weeklyWeightChange < 0 ? '(증가 중 ⚠️)' : '(변화 없음)'}

**최근 대화 내역:**
${recentChatText || '이전 대화 없음'}

**현재 질문:**
${userMessage}

위 정보를 바탕으로 전문 트레이너처럼 조언해주세요. 반드시 "${currentProfile.name} 회원님"이라는 호칭을 사용하세요. 구체적이고 실천 가능한 조언을 해주세요.`;

                return contextPrompt;

            } catch (error) {
                console.error('AI 컨텍스트 생성 실패:', error);
                // 에러 시 기본 프롬프트 (트레이너 페르소나 유지)
                return `당신은 전문 퍼스널 트레이너입니다. ${currentProfile.name} 회원님의 다이어트를 담당하고 있습니다. 반드시 "${currentProfile.name} 회원님"으로 호칭하고, 전문가답게 조언해주세요.\n\n현재 질문: ${userMessage}`;
            }
        }

        // 플랜과 실제 식사 비교
        async function comparePlanWithMeal(mealTime, nutritionData) {
            try {
                // 식사 시간 ±1시간 범위의 플랜 검색
                const oneHourBefore = new Date(mealTime.getTime() - 60 * 60 * 1000);
                const oneHourAfter = new Date(mealTime.getTime() + 60 * 60 * 1000);

                const plansSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('plans')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(oneHourBefore))
                    .where('date', '<=', firebase.firestore.Timestamp.fromDate(oneHourAfter))
                    .get();

                // 플랜이 없으면 비교하지 않음
                if (plansSnapshot.empty) {
                    return null;
                }

                // 가장 가까운 플랜 찾기
                let closestPlan = null;
                let closestDiff = Infinity;

                plansSnapshot.forEach(doc => {
                    const plan = doc.data();
                    const planTime = plan.date.toDate();
                    const diff = Math.abs(planTime.getTime() - mealTime.getTime());

                    if (diff < closestDiff) {
                        closestDiff = diff;
                        closestPlan = plan;
                    }
                });

                if (!closestPlan) return null;

                // AI에게 비교 요청 (트레이너 페르소나 - 팩트 체크)
                const prompt = `당신은 ${currentProfile.name} 회원님을 담당하는 전문 퍼스널 트레이너입니다. 계획과 실제 식사를 비교하여 팩트 체크해주세요.

**계획한 식사:** ${closestPlan.activity}
**실제 섭취한 음식:** ${nutritionData.foodName} (${Math.round(nutritionData.calories)}kcal)

**지침:**
- 호칭: 반드시 "${currentProfile.name} 회원님"으로 시작하세요
- 일치하면: "완벽합니다! 계획대로 실천하셨네요." 같은 칭찬 (30자 이내)
- 불일치하면: "회원님? 계획엔 [계획]인데 사진은 [실제]네요? 이러면 안 됩니다." 같은 팩트 폭격 (50자 이내)
- 톤: 전문가답게 매섭지만 정중하게

짧은 한 문장으로만 답변해주세요:`;

                const response = await callGeminiAPI(prompt);

                return response || '오늘도 식사 기록 완료! 👍';

            } catch (error) {
                console.error('플랜-식사 비교 실패:', error);
                return null;
            }
        }

        // ==================== 스마트 병합 함수 ====================

        // 최근 식사 확인 (3시간 이내)
        async function checkForRecentMeal(newMealTime) {
            try {
                const threeHoursAgo = new Date(newMealTime.getTime() - 3 * 60 * 60 * 1000);

                const recentMealsSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('category', '==', 'food')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(threeHoursAgo))
                    .orderBy('uploadedAt', 'desc')
                    .limit(1)
                    .get();

                if (recentMealsSnapshot.empty) {
                    return null;
                }

                return {
                    id: recentMealsSnapshot.docs[0].id,
                    data: recentMealsSnapshot.docs[0].data()
                };
            } catch (error) {
                console.error('최근 식사 확인 실패:', error);
                return null;
            }
        }

        // 병합 Bottom Sheet 표시
        function showMergeBottomSheet(newMealData, recentMeal) {
            // 전역 변수에 저장 (confirmMerge와 createNewMeal에서 사용)
            pendingMealData = newMealData;
            recentMealDocId = recentMeal.id;

            // UI 업데이트
            const previousNutrition = recentMeal.data.nutrition || {};
            const currentNutrition = newMealData.nutrition || {};

            document.getElementById('previousMealName').textContent = previousNutrition.foodName || '알 수 없음';
            document.getElementById('previousMealCal').textContent = `${Math.round(previousNutrition.calories || 0)}kcal`;

            document.getElementById('currentMealName').textContent = currentNutrition.foodName || '알 수 없음';
            document.getElementById('currentMealCal').textContent = `${Math.round(currentNutrition.calories || 0)}kcal`;

            const totalCalories = (previousNutrition.calories || 0) + (currentNutrition.calories || 0);
            document.getElementById('mergeTotal').textContent = `${Math.round(totalCalories)}kcal`;

            // Bottom Sheet 표시
            document.getElementById('mergeBottomSheet').classList.remove('hidden');
        }

        // 병합 확인
        async function confirmMerge() {
            try {
                if (!pendingMealData || !recentMealDocId) {
                    console.error('병합할 데이터가 없습니다.');
                    return;
                }

                // 기존 식사 데이터 가져오기
                const recentMealDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(recentMealDocId).get();

                const recentData = recentMealDoc.data();
                const mergedNutrition = {
                    calories: (recentData.nutrition?.calories || 0) + (pendingMealData.nutrition?.calories || 0),
                    carbs: (recentData.nutrition?.carbs || 0) + (pendingMealData.nutrition?.carbs || 0),
                    protein: (recentData.nutrition?.protein || 0) + (pendingMealData.nutrition?.protein || 0),
                    fat: (recentData.nutrition?.fat || 0) + (pendingMealData.nutrition?.fat || 0),
                    foodName: `${recentData.nutrition?.foodName || '식사'} + ${pendingMealData.nutrition?.foodName || '식사'}`,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `총 ${Math.round((recentData.nutrition?.calories || 0) + (pendingMealData.nutrition?.calories || 0))}kcal 섭취`
                };

                // 텍스트 병합
                const mergedText = [recentData.text, pendingMealData.text]
                    .filter(t => t)
                    .join(' + ') || null;

                // Firestore 업데이트
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(recentMealDocId).update({
                        nutrition: mergedNutrition,
                        text: mergedText
                    });

                // Bottom Sheet 닫기
                document.getElementById('mergeBottomSheet').classList.add('hidden');

                // 전역 변수 초기화
                pendingMealData = null;
                recentMealDocId = null;

                // UI 새로고침
                await loadAlbumTab();

                // ========== Phase 1: 실시간 영양 추적 (병합된 추가 칼로리만) ==========
                // 기존 식사는 이미 카운트되어 있으므로, 새로 추가된 부분만 더함
                if (pendingMealData.nutrition) {
                    addMeal('식단 추가', pendingMealData.nutrition.foodName, pendingMealData.nutrition);
                }
                // ================================================================

                await refreshDashboardNutrition();

                showAIToast(`${currentProfile.name} 회원님, 식사가 합쳐졌습니다! 😊`, 3000);

            } catch (error) {
                console.error('병합 실패:', error);
                showErrorToast('병합에 실패했습니다.');
            }
        }

        // 새 식사로 저장
        async function createNewMeal() {
            try {
                if (!pendingMealData) {
                    console.error('저장할 데이터가 없습니다.');
                    return;
                }

                // 새 문서로 저장
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').add(pendingMealData);

                // Bottom Sheet 닫기
                document.getElementById('mergeBottomSheet').classList.add('hidden');

                // 전역 변수 초기화
                pendingMealData = null;
                recentMealDocId = null;

                // UI 새로고침
                await loadAlbumTab();

                // ========== Phase 1: 실시간 영양 추적 ==========
                if (pendingMealData.nutrition) {
                    addMeal('식단', pendingMealData.nutrition.foodName, pendingMealData.nutrition);
                }
                // ===============================================

                await refreshDashboardNutrition();

                showSuccessToast('새 식사로 저장되었습니다!');

            } catch (error) {
                console.error('저장 실패:', error);
                showErrorToast('저장에 실패했습니다.');
            }
        }

        // ==================== 텍스트 카드 입력 ====================

        // 텍스트 카드 추가
        async function addTextCard() {
            try {
                const category = prompt('카테고리를 선택하세요:\n1. 눈바디 (body)\n2. 식단 (food)\n3. 운동 (exercise)');
                let categoryValue = 'body';
                if (category === '2' || category.includes('식단')) categoryValue = 'food';
                else if (category === '3' || category.includes('운동')) categoryValue = 'exercise';

                const text = prompt('내용을 입력하세요:');
                if (!text || !text.trim()) {
                    return;
                }

                // 텍스트 카드 데이터 생성
                const cardData = {
                    url: null,
                    category: categoryValue,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    text: text.trim()
                };

                // 식단인 경우 AI 영양 분석
                let nutritionData = null;
                if (categoryValue === 'food') {
                    try {
                        nutritionData = await analyzeNutritionFromText(text);
                        if (nutritionData) {
                            cardData.nutrition = nutritionData;
                        }
                    } catch (error) {
                        console.error('텍스트 영양 분석 실패:', error);
                    }
                }

                // 식단인 경우 스마트 병합 체크
                if (categoryValue === 'food' && nutritionData) {
                    const recentMeal = await checkForRecentMeal(new Date());

                    if (recentMeal) {
                        // 최근 식사 발견 - 병합 Bottom Sheet 표시
                        showMergeBottomSheet(cardData, recentMeal);
                        return; // confirmMerge()나 createNewMeal()에서 처리
                    }
                }

                // 스마트 병합 대상이 아니거나 식단이 아닌 경우 바로 저장
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').add(cardData);

                // 앨범 새로고침
                await loadAlbumTab();

                // 식단인 경우 대시보드도 새로고침 및 AI 토스트 표시
                if (categoryValue === 'food' && nutritionData) {
                    // ========== Phase 1: 실시간 영양 추적 ==========
                    addMeal('식단', nutritionData.foodName, nutritionData);
                    // ===============================================

                    await refreshDashboardNutrition();

                    // 플랜과 비교 (선택적)
                    let toastMessage = nutritionData.aiAdvice || '식사가 기록되었어요!';
                    try {
                        const comparisonResult = await comparePlanWithMeal(new Date(), nutritionData);
                        if (comparisonResult) {
                            toastMessage = comparisonResult;
                        }
                    } catch (error) {
                        console.error('플랜 비교 실패:', error);
                    }

                    showAIToast(toastMessage, 6000);
                } else {
                    showSuccessToast('텍스트 카드가 추가되었습니다!');
                }

            } catch (error) {
                console.error('텍스트 카드 추가 실패:', error);
                showErrorToast('텍스트 카드 추가에 실패했습니다.');
            }
        }

        // ==================== 인증 관련 함수 ====================
        function showAuth() {
            document.getElementById('landing').classList.add('hidden');
            document.getElementById('auth').classList.remove('hidden');
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            document.getElementById('authTitle').textContent = isSignUp ? '회원가입' : '로그인';
            document.getElementById('authButtonText').textContent = isSignUp ? '가입하기' : '로그인';
            document.getElementById('authToggleText').textContent = isSignUp ? '이미 계정이 있으신가요? 로그인' : '계정이 없으신가요? 회원가입';
            document.getElementById('signupFields').style.display = isSignUp ? 'block' : 'none';
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                if (isSignUp) {
                    const displayName = document.getElementById('displayName').value;
                    const goalWeight = parseFloat(document.getElementById('goalWeight').value);
                    const startWeight = parseFloat(document.getElementById('startWeight').value);

                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName });

                    await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(userCredential.user.uid).set({
                        name: displayName,
                        email: email,
                        goalWeight: goalWeight,
                        age: age,
                        height: height,
                        gender: gender,
                        targetDate: targetDate,
                        activityLevel: activityLevel,
                        goal: goal,
                        startWeight: startWeight,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showSuccessMessage('회원가입 성공! 로그인 중...');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                showErrorMessage(getErrorMessage(error.code));
            }
        });

        function showErrorMessage(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        function showSuccessMessage(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.classList.add('show');
            setTimeout(() => successDiv.classList.remove('show'), 3000);
        }

        function getErrorMessage(code) {
            const messages = {
                'auth/email-already-in-use': '이미 사용 중인 이메일입니다.',
                'auth/invalid-email': '잘못된 이메일 형식입니다.',
                'auth/weak-password': '비밀번호는 6자 이상이어야 합니다.',
                'auth/user-not-found': '존재하지 않는 계정입니다.',
                'auth/wrong-password': '비밀번호가 올바르지 않습니다.'
            };
            return messages[code] || '오류가 발생했습니다. 다시 시도해주세요.';
        }

        // ==================== Firebase Auth State Listener ====================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("로그인 성공:", user.email);
                currentUser = user;

                try {
                    // 1. 옛날 데이터 위치 확인 (profile/main)
                    const oldDoc = await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(user.uid)
                        .collection('profile').doc('main').get();

                    // 2. 새 데이터 위치 확인 (users/uid)
                    const newDoc = await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(user.uid).get();

                    let profileData = {
                        name: user.displayName || '회원',
                        goalWeight: 0,
                        startWeight: 0,
                        createdAt: firebase.firestore.Timestamp.now()
                    };

                    // 3. 데이터 합치기 (옛날 데이터가 있으면 우선 적용)
                    if (oldDoc.exists) {
                        const old = oldDoc.data();
                        profileData.name = old.name || old.displayName || profileData.name;
                        profileData.goalWeight = old.targetWeight || old.goalWeight || 0;
                        profileData.startWeight = old.startWeight || old.startweight || 0;
                    }

                    if (newDoc.exists) {
                        const curr = newDoc.data();
                        if (curr.name) profileData.name = curr.name;
                        if (curr.goalWeight) profileData.goalWeight = curr.goalWeight;
                        if (curr.startWeight) profileData.startWeight = curr.startWeight;
                        // 새 필드 로드 (나이, 키, 성별, 목표일, 활동량)
                        if (curr.age) profileData.age = curr.age;
                        if (curr.height) profileData.height = curr.height;
                        if (curr.gender) profileData.gender = curr.gender;
                        if (curr.targetDate) profileData.targetDate = curr.targetDate;
                        if (curr.activityLevel) profileData.activityLevel = curr.activityLevel;
                        if (curr.goal) profileData.goal = curr.goal;
                    }

                    // ========== 🔥 자동 복구 및 마이그레이션 ==========
                    let needsUpdate = false;
                    let updateData = {};

                    // 시작 체중 복구 (logs에서)
                    if (!profileData.startWeight || profileData.startWeight === 0) {
                        console.log("⚠️ 시작 체중이 없음. logs에서 복구 시도...");

                        const firstLog = await db.collection('artifacts')
                            .doc('diet-mate-v2')
                            .collection('users').doc(user.uid)
                            .collection('logs')
                            .orderBy('date', 'asc')
                            .limit(1).get();

                        if (!firstLog.empty) {
                            profileData.startWeight = firstLog.docs[0].data().weight;
                            updateData.startWeight = profileData.startWeight;
                            needsUpdate = true;
                            console.log("✅ 시작 체중 복구:", profileData.startWeight, "kg");
                        }
                    }

                    // 목표 체중 복구 (profile/main 또는 targetWeight에서)
                    if (!profileData.goalWeight || profileData.goalWeight === 0) {
                        console.log("⚠️ 목표 체중이 없음. 복구 시도...");

                        // oldDoc에서 이미 확인했으니 재사용
                        if (oldDoc.exists) {
                            const old = oldDoc.data();
                            profileData.goalWeight = old.targetWeight || old.goalWeight || 0;

                            if (profileData.goalWeight > 0) {
                                updateData.goalWeight = profileData.goalWeight;
                                needsUpdate = true;
                                console.log("✅ 목표 체중 복구 (profile/main):", profileData.goalWeight, "kg");
                            }
                        }

                        // 현재 문서의 targetWeight 확인
                        if (profileData.goalWeight === 0 && newDoc.exists) {
                            const curr = newDoc.data();
                            profileData.goalWeight = curr.targetWeight || 0;

                            if (profileData.goalWeight > 0) {
                                updateData.goalWeight = profileData.goalWeight;
                                needsUpdate = true;
                                console.log("✅ 목표 체중 복구 (targetWeight):", profileData.goalWeight, "kg");
                            }
                        }
                    }

                    // 기본 정보 확보
                    if (!updateData.name && profileData.name) {
                        updateData.name = profileData.name;
                    }
                    if (!updateData.email && user.email) {
                        updateData.email = user.email;
                    }

                    // Firebase에 저장 (복구된 데이터가 있으면)
                    if (needsUpdate && Object.keys(updateData).length > 0) {
                        console.log("💾 복구된 데이터를 Firebase에 저장:", updateData);

                        await db.collection('artifacts')
                            .doc('diet-mate-v2')
                            .collection('users')
                            .doc(user.uid)
                            .set(updateData, { merge: true });

                        console.log("✅ 프로필 자동 복구 완료!");
                    }
                    // ========== 자동 복구 끝 ==========

                    currentProfile = profileData;

                    // ========== 🔥 프로필 검증 추가 ==========
                    if (!currentProfile.startWeight || !currentProfile.goalWeight ||
                        currentProfile.startWeight === 0 || currentProfile.goalWeight === 0 ||
                        !currentProfile.name || currentProfile.name === '회원') {

                        console.warn('⚠️ 프로필이 불완전합니다. 초기 설정 모달 표시:', currentProfile);

                        // 대시보드 숨기고 초기 설정 모달만 표시
                        document.getElementById('landing').classList.add('hidden');
                        document.getElementById('auth').classList.add('hidden');
                        document.getElementById('dashboard').classList.add('hidden');

                        showInitialProfileSetup();
                        return; // 앱 초기화 중단
                    }
                    // ========================================

                    // 대시보드 초기화
                    document.getElementById('landing').classList.add('hidden');
                    document.getElementById('auth').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    await initializeDashboard();

                } catch (error) {
                    console.error('프로필 로드 실패:', error);
                    showErrorMessage('프로필 로드에 실패했습니다.');
                }
            } else {
                // 로그아웃 상태
                currentUser = null;
                currentProfile = null;
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('auth').classList.add('hidden');
                document.getElementById('landing').classList.remove('hidden');
            }
        });


        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                auth.signOut();
                location.reload();
            }
        }

        // ==================== 초기 프로필 설정 ====================
        function showInitialProfileSetup() {
            const modal = document.getElementById('initialProfileSetupModal');
            if (!modal) {
                console.error('❌ 초기 설정 모달을 찾을 수 없습니다.');
                return;
            }

            modal.style.display = 'flex';

            // 뒤 배경 스크롤 막기 (모바일 최적화)
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';

            // 기존 데이터가 있으면 미리 채우기 (복구 시도)
            if (currentProfile) {
                if (currentProfile.name && currentProfile.name !== '회원') {
                    document.getElementById('initialSetupName').value = currentProfile.name;
                }
                if (currentProfile.startWeight && currentProfile.startWeight > 0) {
                    document.getElementById('initialSetupStartWeight').value = currentProfile.startWeight;
                }
                if (currentProfile.goalWeight && currentProfile.goalWeight > 0) {
                    document.getElementById('initialSetupGoalWeight').value = currentProfile.goalWeight;
                }
            }
        }

        async function completeInitialSetup() {
            const name = document.getElementById('initialSetupName').value.trim();
            const startWeight = parseFloat(document.getElementById('initialSetupStartWeight').value);
            const goalWeight = parseFloat(document.getElementById('initialSetupGoalWeight').value);
            const age = parseInt(document.getElementById('initialSetupAge').value) || null;
            const height = parseFloat(document.getElementById('initialSetupHeight').value) || null;
            const gender = document.getElementById('initialSetupGender').value || null;
            const targetDateStr = document.getElementById('initialSetupTargetDate').value;
            const targetDate = targetDateStr ? firebase.firestore.Timestamp.fromDate(new Date(targetDateStr)) : null;
            const activityLevel = document.getElementById('initialSetupActivityLevel').value || 'light';
            const goal = document.getElementById('initialSetupGoal').value || 'lose';

            // 유효성 검사
            if (!name || name.length < 2) {
                alert('닉네임을 2자 이상 입력해주세요.');
                return;
            }
            if (!startWeight || startWeight <= 0 || startWeight > 300) {
                alert('현재 체중을 올바르게 입력해주세요. (1~300kg)');
                return;
            }
            if (!goalWeight || goalWeight <= 0 || goalWeight > 300) {
                alert('목표 체중을 올바르게 입력해주세요. (1~300kg)');
                return;
            }
            // 체중 감량/증량 모두 허용하므로 이 검사 제거

            try {
                // Firestore에 저장
                await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid).set({
                        name: name,
                        startWeight: startWeight,
                        goalWeight: goalWeight,
                        age: age,
                        height: height,
                        gender: gender,
                        targetDate: targetDate,
                        activityLevel: activityLevel,
                        goal: goal,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                console.log('✅ 초기 프로필 설정 완료:', { name, startWeight, goalWeight });

                // currentProfile 업데이트
                currentProfile = {
                    name: name,
                    startWeight: startWeight,
                    goalWeight: goalWeight,
                    age: age,
                    height: height,
                    gender: gender,
                    targetDate: targetDate,
                    activityLevel: activityLevel,
                    goal: goal,
                    createdAt: firebase.firestore.Timestamp.now()
                };

                // 모달 닫기
                document.getElementById('initialProfileSetupModal').style.display = 'none';

                // 스크롤 복구
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';

                // 앱 초기화 및 대시보드 표시
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('headerSubtitle').textContent = `${currentProfile.name}님, 환영합니다!`;
                document.getElementById('profileName').textContent = currentProfile.name;
                document.getElementById('profileEmail').textContent = currentUser.email;

                // 홈 탭 로드
                await loadHomeTab();
                switchTab('home');

                alert(`🎉 환영합니다, ${name}님! Diet Mate와 함께 목표를 달성해보세요!`);
            } catch (error) {
                console.error('❌ 프로필 저장 실패:', error);
                alert('프로필 저장에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // ==================== 대시보드 초기화 ====================
        async function initializeDashboard() {
            document.getElementById('headerSubtitle').textContent = `${currentProfile.name}님, 환영합니다!`;
            document.getElementById('profileName').textContent = currentProfile.name;
            document.getElementById('profileEmail').textContent = currentUser.email;

            await loadHomeTab();
            await loadPlanTab();
            await loadAlbumTab();
            await loadCalendar();
            await loadCommunityMessages();
            await loadNotifications();
            await loadSettings();

            initializeFasting();
            initializePWA();
            startNotificationCheck();
            // 알림 권한 확인 (새로 추가)
            checkNotificationPermission();

            // AI 채팅 기록 로드
            loadAIChatHistory();

            // ========== Phase 1: 자정 초기화 타이머 설정 ==========
            setupMidnightReset();
            // ====================================================
        }

        // ==================== 탭 전환 ====================
        function switchTab(tabName) {
            // 모든 탭 비활성화
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));

            // 사이드바 네비게이션 업데이트
            document.querySelectorAll('.nav-item-sidebar').forEach(nav => nav.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item-sidebar[data-tab="${tabName}"]`);
            if (activeNav) activeNav.classList.add('active');

            // 선택된 탭 활성화
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            currentTab = tabName;

            // 모바일에서 사이드바 닫기
            if (window.innerWidth <= 768) {
                closeMobileSidebar();
            }

            // 소통 탭의 입력창 표시/숨김
            const chatInput = document.getElementById('chatInputContainer');
            if (tabName === 'community') {
                chatInput.classList.remove('hidden');
            } else {
                chatInput.classList.add('hidden');
            }

            // 탭별 새로고침
            if (tabName === 'calendar') {
                renderCalendar();
            } else if (tabName === 'plan') {
                loadPlanTab();
            } else if (tabName === 'album') {
                loadAlbumTab();
            } else if (tabName === 'community') {
                loadCommunityMessages();
            }
        }

        // ==================== 모바일 사이드바 제어 ====================
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');

            if (sidebar && overlay) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
                document.body.style.overflow = sidebar.classList.contains('mobile-open') ? 'hidden' : '';
            }
        }

        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');

            if (sidebar) {
                sidebar.classList.remove('mobile-open');
            }
            if (overlay) {
                overlay.classList.remove('active');
            }
            document.body.style.overflow = '';
        }

        // ==================== 홈 탭 ====================
        async function loadHomeTab() {
            console.log('=== loadHomeTab 시작 ===');
            console.log('currentProfile:', currentProfile);
            
            // 건강 지표 표시
            const startWeight = currentProfile.startWeight || 0;
            const goalWeight = currentProfile.goalWeight || 0;
            
            console.log('startWeight:', startWeight, 'goalWeight:', goalWeight);

            document.getElementById('startWeightDisplay').textContent = startWeight.toFixed(1);
            document.getElementById('goalWeightDisplay').textContent = goalWeight.toFixed(1);

            // 체중 데이터 로드
            console.log('체중 데이터 로드 시작...');
            const weightData = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs').orderBy('date', 'desc').get(); // 최신순으로 정렬
            
            console.log('Firebase에서 로드한 문서 개수:', weightData.docs.length);

            // 1단계: 유효한 데이터만 추출
            const allWeights = weightData.docs
                .map(doc => {
                    const data = doc.data();
                    let date;
                    
                    // date 필드를 안전하게 변환
                    if (data.date && typeof data.date.toDate === 'function') {
                        date = data.date.toDate();
                    } else if (data.date instanceof Date) {
                        date = data.date;
                    } else if (typeof data.date === 'string' || typeof data.date === 'number') {
                        date = new Date(data.date);
                    } else {
                        console.warn('알 수 없는 date 형식:', data.date);
                        date = new Date();
                    }
                    
                    return {
                        date: date,
                        weight: data.weight,
                        timestamp: date.getTime() // 정렬용 타임스탬프
                    };
                })
                .filter(w => w.weight != null && !isNaN(w.weight)); // null, undefined, NaN 제거

            // 2단계: 같은 날짜는 가장 최신 것만 남기기 (하루에 하나만)
            const weightMap = new Map();
            allWeights.forEach(w => {
                const dateKey = `${w.date.getFullYear()}-${String(w.date.getMonth() + 1).padStart(2, '0')}-${String(w.date.getDate()).padStart(2, '0')}`;
                
                // 같은 날짜가 이미 있으면 더 최신 것으로 교체
                if (!weightMap.has(dateKey) || w.timestamp > weightMap.get(dateKey).timestamp) {
                    weightMap.set(dateKey, w);
                }
            });

            // 3단계: 날짜순 정렬 (오름차순)
            const weights = Array.from(weightMap.values())
                .sort((a, b) => a.timestamp - b.timestamp);

            let currentWeight = startWeight;
            let lastWeightDate = null;
            
            console.log('유효한 체중 기록 개수:', weights.length);
            
            // 모든 체중 기록 출력 (디버깅용)
            console.log('=== 유효한 체중 기록 ===');
            weights.forEach((w, index) => {
                const dateStr = `${w.date.getFullYear()}-${String(w.date.getMonth() + 1).padStart(2, '0')}-${String(w.date.getDate()).padStart(2, '0')}`;
                console.log(`${index + 1}. ${w.weight}kg - ${dateStr}`);
            });
            console.log('========================');
            
            if (weights.length > 0) {
                const lastWeight = weights[weights.length - 1];
                currentWeight = lastWeight.weight;
                lastWeightDate = lastWeight.date;
                console.log('✅ 마지막 기록 (최신):', currentWeight, 'kg at', lastWeightDate.toLocaleDateString('ko-KR'));
            } else {
                console.log('⚠️ 기록 없음, 시작 체중 사용:', currentWeight);
            }
            
            document.getElementById('currentWeightDisplay').textContent = currentWeight.toFixed(1);
            
            // 마지막 기록 날짜 표시
            const dateDisplay = document.getElementById('currentWeightDate');
            if (lastWeightDate) {
                const year = String(lastWeightDate.getFullYear()).slice(2);
                const month = String(lastWeightDate.getMonth() + 1).padStart(2, '0');
                const day = String(lastWeightDate.getDate()).padStart(2, '0');
                dateDisplay.textContent = `${year}-${month}-${day}`;
            } else {
                dateDisplay.textContent = '기록 없음';
            }

            // 진행률 계산
            const totalToLose = startWeight - goalWeight;
            const lostSoFar = startWeight - currentWeight;
            const remaining = currentWeight - goalWeight;
            const progress = totalToLose !== 0 ? (lostSoFar / totalToLose * 100) : 0;
            
            console.log('=== 계산 결과 ===');
            console.log('totalToLose:', totalToLose);
            console.log('lostSoFar:', lostSoFar);
            console.log('remaining:', remaining);
            console.log('progress:', progress);

            document.getElementById('progressPercent').textContent = `${Math.max(0, Math.min(100, progress)).toFixed(1)}%`;
            document.getElementById('progressBar').style.width = `${Math.max(0, Math.min(100, progress))}%`;
            
            // 감량/증량 표시 (음수도 표시)
            const lostText = lostSoFar >= 0 ? `감량: ${lostSoFar.toFixed(1)}kg` : `증량: ${Math.abs(lostSoFar).toFixed(1)}kg`;
            const remainingText = remaining >= 0 ? `남은 감량: ${remaining.toFixed(1)}kg` : `목표 초과: ${Math.abs(remaining).toFixed(1)}kg`;
            
            document.getElementById('weightLost').textContent = lostText;
            document.getElementById('weightRemaining').textContent = remainingText;

            // 체중 그래프 그리기
            drawWeightChart(weights);

            // 영양 대시보드 로드
            await loadNutritionDashboard();

            // ========== Phase 1: 오늘의 영양 데이터 로드 ==========
            await loadTodayNutrition();
            // ====================================================

            // 물 마시기 트래커 초기화
            initializeWaterTracker();

            // ========== D-Day 표시 ==========
            console.log('targetDate 확인:', currentProfile.targetDate);
            if (currentProfile.targetDate) {
                const dateToUse = currentProfile.targetDate.toDate ? currentProfile.targetDate.toDate() : currentProfile.targetDate;
                console.log('D-Day 업데이트:', dateToUse);
                updateDDayDisplay(dateToUse);
            } else {
                console.log('목표 날짜가 설정되지 않음');
                // 목표 날짜가 없어도 D-day 영역 표시 (설정 필요 메시지)
                const ddayDisplay = document.getElementById('ddayDisplay');
                ddayDisplay.classList.remove('hidden');
                ddayDisplay.querySelector('.dday-main').textContent = 'D-?';
                ddayDisplay.querySelector('.dday-sub').textContent = '목표일을 설정해주세요';
            }
            
            // 현실적인 목표일 표시 (현재 체중 기준)
            updateRealisticGoalDisplay(currentWeight);
            // =================================================================
        }

        function drawWeightChart(weights) {
            const ctx = document.getElementById('weightChart').getContext('2d');

            if (weightChart) {
                weightChart.destroy();
            }

            const labels = weights.map(w => {
                const date = w.date;
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });

            const data = weights.map(w => w.weight);

            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '체중 (kg)',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        async function addWeight() {
            const weight = parseFloat(document.getElementById('weightInput').value);

            if (!weight || weight <= 0) {
                alert('올바른 체중을 입력해주세요.');
                return;
            }

            try {
                console.log('=== 체중 기록 시작 ===');
                console.log('입력된 체중:', weight);
                
                const now = new Date();
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const todayEnd = new Date(todayStart.getTime() + 86400000);

                // 오늘 날짜의 기존 체중 기록 확인
                const existingLogs = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(todayStart))
                    .where('date', '<', firebase.firestore.Timestamp.fromDate(todayEnd))
                    .get();

                // 기존 기록이 있으면 삭제 (덮어쓰기)
                const batch = db.batch();
                existingLogs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log(`🗑️ 오늘 날짜 기존 체중 기록 ${existingLogs.size}개 삭제`);

                // 새 체중 기록 저장
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs').add({
                        weight: weight,
                        date: firebase.firestore.Timestamp.now()
                    });
                
                console.log('✅ Firebase 저장 완료 (최신 체중:', weight, 'kg)');

                // ========== Phase 1: 캘린더 통합 ==========
                await saveToDailyLog(now, 'weight', {
                    weight: weight,
                    timestamp: now.toISOString()
                });
                // ========================================

                console.log('✅ 체중 기록 추가:', weight, 'kg');

                // 입력 필드 초기화
                document.getElementById('weightInput').value = '';

                // ========== Phase 1: 즉시 UI 업데이트 ==========
                // 전체 홈탭을 다시 로드하여 그래프와 진행률 모두 업데이트
                console.log('홈 탭 새로고침 시작...');
                await loadHomeTab();
                console.log('✅ 홈 탭 새로고침 완료');

                // ✅ 플랜 탭 체중 목표 자동 체크
                if (typeof checkTodayWeightRecord === 'function') {
                    await checkTodayWeightRecord();
                }

                // 성공 메시지
                showAIToast(`${currentProfile.name} 회원님, 체중이 기록되었습니다! (${weight}kg)`, 3000);
                // ==============================================

            } catch (error) {
                console.error('❌ 체중 추가 실패:', error);
                alert('체중 추가에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // AI 채팅
        function toggleAIChat() {
            const details = document.getElementById('aiChatDetails');
            details.classList.toggle('open');
        }

        function loadAIChatHistory() {
            const history = JSON.parse(localStorage.getItem(LS_KEYS.AI_CHAT) || '[]');
            const messagesDiv = document.getElementById('aiChatMessages');
            messagesDiv.innerHTML = '';

            history.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `ai-message ${msg.role}`;
                msgDiv.textContent = msg.content;
                messagesDiv.appendChild(msgDiv);
            });

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();

            if (!message) return;

            // 사용자 메시지 추가
            const history = JSON.parse(localStorage.getItem(LS_KEYS.AI_CHAT) || '[]');
            history.push({ role: 'user', content: message });

            // 최근 50개만 유지
            if (history.length > 50) {
                history.shift();
            }

            localStorage.setItem(LS_KEYS.AI_CHAT, JSON.stringify(history));
            loadAIChatHistory();
            input.value = '';

            // AI 응답 받기 (컨텍스트 포함)
            // 🔥 3. AI 코치 전용 API 사용 (오늘의 데이터 포함)
            const todayData = {
                calories: todayIntake.calories,
                carbs: todayIntake.carbs,
                protein: todayIntake.protein,
                fat: todayIntake.fat,
                meals: todayIntake.meals,
                fasting: localStorage.getItem('todayFasting') || '미기록',
                water: localStorage.getItem('todayWater') || '미기록'
            };
            const response = await callGeminiCoach(message, currentProfile, todayData);

            history.push({ role: 'assistant', content: response });
            localStorage.setItem(LS_KEYS.AI_CHAT, JSON.stringify(history));
            loadAIChatHistory();
        }

        // 스마트 물 마시기
        function initializeWaterTracker() {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"cupSize": 250, "goalLiters": 2, "filled": []}');

            // 날짜 확인 및 자동 초기화
            const today = new Date().toISOString().split('T')[0];
            if (settings.lastDate !== today) {
                // 날짜가 다르면 물 마시기 초기화
                settings.filled = [];
                settings.lastDate = today;
                localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));
                console.log('✅ 물 마시기 자동 초기화 (새로운 날):', today);
            }

            document.getElementById('cupSize').value = settings.cupSize || 250;
            document.getElementById('waterGoal').value = settings.goalLiters || 2;

            updateWaterTracker();
        }

        function updateWaterTracker() {
            const cupSize = parseInt(document.getElementById('cupSize').value) || 250;
            const goalLiters = parseFloat(document.getElementById('waterGoal').value) || 2;
            const goalMl = goalLiters * 1000;
            const cupCount = Math.ceil(goalMl / cupSize);

            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"filled": []}');
            settings.cupSize = cupSize;
            settings.goalLiters = goalLiters;
            settings.lastDate = settings.lastDate || new Date().toISOString().split('T')[0];

            const tracker = document.getElementById('waterTracker');
            tracker.innerHTML = '';

            for (let i = 0; i < cupCount; i++) {
                const cup = document.createElement('div');
                cup.className = 'water-cup';
                if (settings.filled && settings.filled.includes(i)) {
                    cup.classList.add('filled');
                }
                cup.textContent = '💧';
                cup.onclick = () => toggleWaterCup(i);
                tracker.appendChild(cup);
            }

            // ========== Phase 2: 물 섭취량 표시 업데이트 ==========
            const filledCount = settings.filled ? settings.filled.length : 0;
            const intakeMl = filledCount * cupSize;
            const percentage = Math.min(100, Math.round((intakeMl / goalMl) * 100));

            document.getElementById('waterIntake').textContent = `${intakeMl} ml`;
            document.getElementById('waterGoalDisplay').textContent = `${goalMl} ml`;
            document.getElementById('waterPercentage').textContent = `${percentage}%`;
            // ====================================================

            localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));
        }

        async function toggleWaterCup(index) {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS));
            if (!settings.filled) settings.filled = [];

            // 오늘 날짜 확인
            const today = new Date().toISOString().split('T')[0];
            if (settings.lastDate !== today) {
                // 날짜가 바뀌었으면 초기화
                settings.filled = [];
                settings.lastDate = today;
            }

            const idx = settings.filled.indexOf(index);
            if (idx > -1) {
                // 체크 해제
                settings.filled.splice(idx, 1);
            } else {
                // 체크
                settings.filled.push(index);
            }

            localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));
            updateWaterTracker();

            // ========== 단식 탭 물 섭취량 동기화 ==========
            if (document.getElementById('fastingWaterIntake')) {
                updateFastingWaterDisplay();
            }
            // ==========================================

            // ========== 캘린더 동기화 (체크/체크 해제 모두 반영) ==========
            const cupSize = settings.cupSize || 250;
            const totalIntake = settings.filled.length * cupSize;

            if (totalIntake > 0) {
                // 물 섭취량이 있으면 캘린더에 저장
                await saveToDailyLog(new Date(), 'water', {
                    amount: totalIntake
                });
            } else {
                // 0ml이면 캘린더에서 삭제
                await removeFromDailyLog(new Date(), 'water');
            }
            
            // 캘린더가 현재 열려있으면 새로고침
            if (currentTab === 'calendar' && typeof renderCalendar === 'function') {
                renderCalendar();
            }
            // ==========================================
        }

        // ==================== 플랜 탭 (시간표 형식) ====================
        let timetableData = {};  // {hour: {text: '', emoji: ''}}

        // 주간 통계 렌더링
        function renderWeeklyStats() {
            const container = document.getElementById('weeklyStats');
            if (!container) return;

            const today = new Date();
            const dayOfWeek = today.getDay(); // 0(일) ~ 6(토)
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // 이번 주 월요일

            const days = ['월', '화', '수', '목', '금', '토', '일'];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = dateStr === today.toISOString().split('T')[0];
                const isFuture = date > today;

                // 해당 날짜의 목표 데이터 가져오기
                let completed = 0;
                let total = 6; // 기본 목표 6개

                if (!isFuture) {
                    const saved = localStorage.getItem(`diet_goals_${dateStr}`);
                    if (saved) {
                        const goals = JSON.parse(saved);
                        // 체크된 기본 목표 개수
                        if (goals.water) completed++;
                        if (goals.fasting) completed++;
                        if (goals.dinner) completed++;
                        if (goals.exercise) completed++;
                        if (goals.calories) completed++;
                        if (goals.weight) completed++;
                        
                        // 커스텀 목표 개수 추가
                        if (goals.custom && goals.custom.length > 0) {
                            total += goals.custom.length;
                            goals.custom.forEach(g => {
                                if (g.completed) completed++;
                            });
                        }
                    }
                }

                // 달성률 계산
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                let circleClass = 'stat-circle';
                let bgColor = '#e9ecef';
                
                if (isToday) {
                    circleClass += ' today';
                } else if (isFuture) {
                    circleClass += ' future';
                } else if (percentage === 100) {
                    // 100% 달성 시 금색
                    bgColor = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                } else if (percentage >= 80) {
                    // 80% 이상 녹색
                    bgColor = 'linear-gradient(135deg, #00D4AA 0%, #009688 100%)';
                } else if (percentage >= 50) {
                    // 50% 이상 노란색
                    bgColor = 'linear-gradient(135deg, #FFC107 0%, #FF9800 100%)';
                } else if (percentage > 0) {
                    // 50% 미만 빨간색
                    bgColor = 'linear-gradient(135deg, #FF5252 0%, #F44336 100%)';
                }

                html += `
                    <div class="stat-item">
                        <div class="stat-day">${days[i]}</div>
                        <div class="${circleClass}" style="${!isToday && !isFuture && completed > 0 ? `background: ${bgColor}; color: white;` : ''}">
                            ${isFuture ? '-' : `${completed}/${total}`}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        async function loadPlanTab() {
            // 목표 로드
            loadGoals();

            // 일기 로드
            loadDiary();

            // 목표 상태 업데이트 (실시간 데이터 연동)
            updateGoalStatus();

            // 주간 통계 렌더링
            renderWeeklyStats();
        }

        async function initializeTimetable() {
            const container = document.getElementById('timetableContainer');
            container.innerHTML = '';

            // 오늘 저장된 시간표 불러오기
            const today = new Date().toISOString().split('T')[0];
            const savedTimetable = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('timetables').doc(today).get();

            if (savedTimetable.exists) {
                timetableData = savedTimetable.data().schedule || {};
            } else {
                timetableData = {};
            }

            // 06:00 ~ 23:00까지 시간표 생성
            for (let hour = 6; hour <= 23; hour++) {
                const timeStr = `${String(hour).padStart(2, '0')}:00`;
                const row = createTimetableRow(hour, timetableData[hour] || {});
                container.appendChild(row);
            }
        }

        function createTimetableRow(hour, data) {
            const row = document.createElement('div');
            row.className = 'timetable-row';

            const timeStr = `${String(hour).padStart(2, '0')}:00`;

            row.innerHTML = `
                <div class="timetable-time">${timeStr}</div>
                <div class="timetable-input-wrapper">
                    <button class="timetable-emoji-btn" onclick="showEmojiPicker(${hour}, event)">
                        ${data.emoji || '➕'}
                    </button>
                    <input
                        type="text"
                        class="timetable-input"
                        id="timetable-${hour}"
                        placeholder="일정을 입력하세요..."
                        value="${data.text || ''}"
                        oninput="saveTimetableDebounced(${hour})"
                    />
                    ${data.text ? `<button class="timetable-clear-btn" onclick="clearTimetableRow(${hour})">✕</button>` : ''}
                </div>
            `;

            return row;
        }

        // 디바운스로 자동 저장
        let timetableSaveTimeout = null;

        function saveTimetableDebounced(hour) {
            clearTimeout(timetableSaveTimeout);
            timetableSaveTimeout = setTimeout(() => {
                saveTimetable(hour);
            }, 500);
        }

        async function saveTimetable(hour) {
            const input = document.getElementById(`timetable-${hour}`);
            const text = input.value.trim();

            // 시간표 데이터 업데이트
            if (!timetableData[hour]) {
                timetableData[hour] = {};
            }
            timetableData[hour].text = text;

            // Firebase에 저장
            const today = new Date().toISOString().split('T')[0];
            await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('timetables').doc(today).set({
                    date: today,
                    schedule: timetableData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

            // UI 업데이트 (삭제 버튼 표시/숨김)
            await initializeTimetable();
        }

        function showEmojiPicker(hour, event) {
            event.stopPropagation();

            // 기존 피커 제거
            const existingPicker = document.querySelector('.timetable-emoji-picker');
            if (existingPicker) {
                existingPicker.remove();
            }

            const picker = document.createElement('div');
            picker.className = 'timetable-emoji-picker show';

            const emojis = ['🏃', '🍽️', '💧', '📚', '💼', '🛌', '🎯', '🎮', '📱', '🚶', '🧘', '💪', '☕', '🎵'];

            emojis.forEach(emoji => {
                const option = document.createElement('span');
                option.className = 'timetable-emoji-option';
                option.textContent = emoji;
                option.onclick = () => selectEmoji(hour, emoji);
                picker.appendChild(option);
            });

            event.target.parentElement.appendChild(picker);

            // 외부 클릭 시 닫기
            setTimeout(() => {
                document.addEventListener('click', closeEmojiPicker, { once: true });
            }, 0);
        }

        function closeEmojiPicker() {
            const picker = document.querySelector('.timetable-emoji-picker');
            if (picker) {
                picker.remove();
            }
        }

        async function selectEmoji(hour, emoji) {
            if (!timetableData[hour]) {
                timetableData[hour] = {};
            }
            timetableData[hour].emoji = emoji;

            // Firebase에 저장
            const today = new Date().toISOString().split('T')[0];
            await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('timetables').doc(today).set({
                    date: today,
                    schedule: timetableData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

            closeEmojiPicker();
            await initializeTimetable();
        }

        async function clearTimetableRow(hour) {
            timetableData[hour] = { text: '', emoji: '' };

            // Firebase에 저장
            const today = new Date().toISOString().split('T')[0];
            await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('timetables').doc(today).set({
                    date: today,
                    schedule: timetableData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

            await initializeTimetable();
        }

        // ========== Phase 2: 시간표 & 일기 함수 ==========

        let dailySchedules = [];  // 오늘의 일정 배열

        // 일정 항목 추가
        function addScheduleItem() {
            const time = prompt('시간을 입력하세요 (예: 07:00)', '07:00');
            if (!time) return;

            const activity = prompt('일정 내용을 입력하세요', '');
            if (!activity) return;

            const scheduleId = Date.now();
            dailySchedules.push({
                id: scheduleId,
                time: time,
                activity: activity
            });

            renderScheduleList();
            saveDailyPlan();
        }

        // 일정 항목 삭제
        function removeScheduleItem(scheduleId) {
            dailySchedules = dailySchedules.filter(s => s.id !== scheduleId);
            renderScheduleList();
            saveDailyPlan();
        }

        // 일정 목록 렌더링
        function renderScheduleList() {
            const scheduleList = document.getElementById('scheduleList');
            if (!scheduleList) return;

            if (dailySchedules.length === 0) {
                scheduleList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">일정이 없습니다.</p>';
                return;
            }

            scheduleList.innerHTML = dailySchedules.map(schedule => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <input type="time" value="${schedule.time}"
                           onchange="updateScheduleTime(${schedule.id}, this.value)"
                           style="padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
                    <input type="text" value="${schedule.activity}"
                           onchange="updateScheduleActivity(${schedule.id}, this.value)"
                           style="flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
                    <button onclick="removeScheduleItem(${schedule.id})"
                            style="padding: 5px 10px; background: #ff5252; color: white; border: none; border-radius: 5px; cursor: pointer;">×</button>
                </div>
            `).join('');
        }

        // 일정 시간 업데이트
        function updateScheduleTime(scheduleId, newTime) {
            const schedule = dailySchedules.find(s => s.id === scheduleId);
            if (schedule) {
                schedule.time = newTime;
                saveDailyPlan();
            }
        }

        // 일정 내용 업데이트
        function updateScheduleActivity(scheduleId, newActivity) {
            const schedule = dailySchedules.find(s => s.id === scheduleId);
            if (schedule) {
                schedule.activity = newActivity;
                saveDailyPlan();
            }
        }

        // 일정 & 일기 저장
        // ==================== 플랜 탭 - 목표 관리 ====================
        let todayGoals = [];
        let customGoals = [];

        // 목표 상태 업데이트 (실시간 데이터 연동)
        function updateGoalStatus() {
            // 1. 물 마시기
            const waterSettings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"goalLiters": 2, "filled": []}');
            const cupSize = waterSettings.cupSize || 250;
            const goalLiters = waterSettings.goalLiters || 2;
            const filledCount = waterSettings.filled?.length || 0;
            const currentLiters = (filledCount * cupSize / 1000).toFixed(1);
            
            document.getElementById('goal-water-text').textContent = `물 ${goalLiters}L 마시기`;
            document.getElementById('goal-water-status').textContent = `${currentLiters}L / ${goalLiters}L`;
            
            const waterPercent = (currentLiters / goalLiters) * 100;
            const waterStatus = document.getElementById('goal-water-status');
            if (waterPercent >= 100) {
                waterStatus.className = 'goal-status success';
                document.getElementById('goal-water').checked = true;
            } else if (waterPercent >= 70) {
                waterStatus.className = 'goal-status warning';
            } else {
                waterStatus.className = 'goal-status';
            }

            // 2. 간헐적 단식
            const fastingState = JSON.parse(localStorage.getItem(LS_KEYS.FASTING) || '{"active": false}');
            if (fastingState.active && fastingState.targetHours) {
                const elapsed = Date.now() - fastingState.startTime;
                const hours = Math.floor(elapsed / 3600000);
                const targetHours = fastingState.targetHours;
                
                document.getElementById('goal-fasting-text').textContent = `간헐적 단식 ${targetHours}시간`;
                document.getElementById('goal-fasting-status').textContent = `${hours}h / ${targetHours}h`;
                
                if (hours >= targetHours) {
                    document.getElementById('goal-fasting-status').className = 'goal-status success';
                    document.getElementById('goal-fasting').checked = true;
                } else {
                    document.getElementById('goal-fasting-status').className = 'goal-status';
                }
            } else {
                document.getElementById('goal-fasting-status').textContent = '미진행';
                document.getElementById('goal-fasting-status').className = 'goal-status';
            }

            // 3. 저녁 8시 이후 금식
            if (todayIntake.meals && todayIntake.meals.length > 0) {
                const lastMeal = todayIntake.meals[todayIntake.meals.length - 1];
                const lastMealTime = new Date(lastMeal.timestamp);
                const lastMealHour = lastMealTime.getHours();
                
                if (lastMealHour < 20) {
                    document.getElementById('goal-dinner-status').textContent = `마지막 식사 ${lastMealHour}시`;
                    document.getElementById('goal-dinner-status').className = 'goal-status success';
                    document.getElementById('goal-dinner').checked = true;
                } else {
                    document.getElementById('goal-dinner-status').textContent = `마지막 식사 ${lastMealHour}시`;
                    document.getElementById('goal-dinner-status').className = 'goal-status danger';
                }
            } else {
                document.getElementById('goal-dinner-status').textContent = '식사 기록 없음';
            }

            // 4. 목표 칼로리 (사용자 설정 우선, 없으면 프로필 계산값)
            const userTargetCal = parseInt(localStorage.getItem('goal_calories_target'));
            const targetCal = userTargetCal || dailyNutrition.totalCalories || 1620;
            const currentCal = todayIntake.calories || 0;
            
            document.getElementById('goal-calories-text').textContent = `목표 칼로리 지키기`;
            document.getElementById('goal-calories-status').textContent = `${Math.round(currentCal)} / ${targetCal}kcal`;
            
            const calStatus = document.getElementById('goal-calories-status');
            if (currentCal <= targetCal && currentCal > 0) {
                calStatus.className = 'goal-status success';
                document.getElementById('goal-calories').checked = true;
            } else if (currentCal > targetCal) {
                calStatus.className = 'goal-status danger';
                document.getElementById('goal-calories').checked = false;
            } else {
                calStatus.className = 'goal-status';
            }

            // 5. 체중 기록
            checkTodayWeightRecord();
        }

        // 목표 저장
        function saveGoals() {
            const goals = {
                'goal-water': document.getElementById('goal-water')?.checked || false,
                'goal-fasting': document.getElementById('goal-fasting')?.checked || false,
                'goal-dinner': document.getElementById('goal-dinner')?.checked || false,
                'goal-exercise': document.getElementById('goal-exercise')?.checked || false,
                'goal-calories': document.getElementById('goal-calories')?.checked || false,
                'goal-weight': document.getElementById('goal-weight')?.checked || false,
                customGoals: customGoals
            };

            // 로컬 스토리지에 저장
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem(`diet_goals_${today}`, JSON.stringify(goals));

            // Firebase dailyPlans에 목표 저장 (캘린더 동기화용)
            if (currentUser) {
                db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyPlans').doc(today)
                    .set({ goals: goals }, { merge: true })
                    .catch(error => console.error('목표 저장 실패:', error));
            }

            // 진행률 업데이트
            updateGoalProgress();
            
            // 주간 통계 업데이트
            renderWeeklyStats();
        }

        // 목표 불러오기
        function loadGoals() {
            const today = new Date().toISOString().split('T')[0];
            const saved = localStorage.getItem(`diet_goals_${today}`);

            if (saved) {
                const goals = JSON.parse(saved);
                document.getElementById('goal-water').checked = goals['goal-water'] || false;
                document.getElementById('goal-fasting').checked = goals['goal-fasting'] || false;
                document.getElementById('goal-dinner').checked = goals['goal-dinner'] || false;
                document.getElementById('goal-exercise').checked = goals['goal-exercise'] || false;
                document.getElementById('goal-calories').checked = goals['goal-calories'] || false;
                document.getElementById('goal-weight').checked = goals['goal-weight'] || false;
                customGoals = goals.customGoals || [];
                renderCustomGoals();
            }

            // ✅ 체중 기록 자동 체크
            checkTodayWeightRecord();

            updateGoalProgress();
        }

        // 오늘 체중 기록 확인 및 자동 체크
        async function checkTodayWeightRecord() {
            if (!currentUser) return;

            try {
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const todayEnd = new Date(todayStart.getTime() + 86400000);

                const weightSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(todayStart))
                    .where('date', '<', firebase.firestore.Timestamp.fromDate(todayEnd))
                    .limit(1)
                    .get();

                const weightCheckbox = document.getElementById('goal-weight');
                const weightStatus = document.getElementById('goal-weight-status');

                if (!weightSnapshot.empty) {
                    // 오늘 체중 기록 있음
                    weightCheckbox.checked = true;
                    const weight = weightSnapshot.docs[0].data().weight;
                    // 소수점 1자리까지 표시
                    weightStatus.textContent = `${parseFloat(weight).toFixed(1)}kg 기록됨`;
                    weightStatus.style.color = '#4caf50';
                    console.log('✅ 체중 자동 체크:', weight, 'kg');
                } else {
                    // 오늘 체중 기록 없음
                    weightCheckbox.checked = false;
                    weightStatus.textContent = '미기록';
                    weightStatus.style.color = '#999';
                }

                // 목표 저장 (자동 체크 반영)
                saveGoals();
            } catch (error) {
                console.error('체중 기록 확인 실패:', error);
            }
        }

        // 진행률 업데이트
        function updateGoalProgress() {
            const checkboxes = document.querySelectorAll('.goal-checklist input[type="checkbox"]');
            const customChecks = document.querySelectorAll('.custom-goal-item input[type="checkbox"]');
            
            const totalGoals = checkboxes.length + customChecks.length;
            let completedGoals = 0;

            checkboxes.forEach(cb => {
                if (cb.checked) completedGoals++;
            });

            customChecks.forEach(cb => {
                if (cb.checked) completedGoals++;
            });

            const percentage = totalGoals > 0 ? Math.round((completedGoals / totalGoals) * 100) : 0;

            document.getElementById('goalProgressBar').style.width = percentage + '%';
            document.getElementById('goalProgressText').textContent = 
                `${completedGoals} / ${totalGoals} 완료 (${percentage}%)`;

            // 전부 완료 시 축하 메시지
            if (completedGoals === totalGoals && totalGoals > 0) {
                showAIToast('🎉 오늘의 모든 목표를 달성했습니다! 정말 대단해요!', 5000);
            }
        }

        // 커스텀 목표 추가
        function addCustomGoal() {
            const input = document.getElementById('customGoalInput');
            const goalText = input.value.trim();

            if (!goalText) {
                alert('목표를 입력해주세요.');
                return;
            }

            if (customGoals.length >= 5) {
                alert('커스텀 목표는 최대 5개까지 추가할 수 있습니다.');
                return;
            }

            customGoals.push({
                text: goalText,
                completed: false,
                id: Date.now()
            });

            input.value = '';
            renderCustomGoals();
            saveGoals();
        }

        // ==================== 목표 편집 기능 (인라인 편집) ====================
        // 목표 칼로리 초기화 함수
        function resetCalorieGoal() {
            if (confirm('목표 칼로리를 프로필 기반 계산값으로 재설정하시겠습니까?\n(키, 몸무게, 성별, 활동량 기반)')) {
                localStorage.removeItem('goal_calories_target');
                showToast('✅ 목표 칼로리가 기본값으로 재설정되었습니다!');
                loadPlanTab(); // 플랜 탭 새로고침
            }
        }

        function editGoalText(goalType, promptText) {
            // calories는 status 요소를 편집
            const textEl = goalType === 'calories' 
                ? document.getElementById(`goal-${goalType}-status`)
                : document.getElementById(`goal-${goalType}-text`);
            
            if (!textEl) return;

            // 현재 값 추출
            let currentValue;
            if (goalType === 'water') {
                currentValue = parseFloat(localStorage.getItem('goal_water_target') || '2');
            } else if (goalType === 'fasting') {
                currentValue = parseInt(localStorage.getItem('goal_fasting_hours') || '16');
            } else if (goalType === 'dinner') {
                currentValue = parseInt(localStorage.getItem('goal_dinner_hour') || '20');
            } else if (goalType === 'exercise') {
                currentValue = parseInt(localStorage.getItem('goal_exercise_minutes') || '30');
            } else if (goalType === 'calories') {
                currentValue = parseInt(localStorage.getItem('goal_calories_target') || '1620');
            }

            // 원래 텍스트 백업
            const originalText = textEl.textContent;

            // 인라인 입력 필드 생성
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.style.cssText = 'width: 80px; padding: 5px; border: 2px solid #667eea; border-radius: 8px; font-size: 0.95rem; text-align: center; font-weight: 600;';
            
            if (goalType === 'water') {
                input.step = '0.1';
                input.min = '0.5';
                input.max = '10';
            } else if (goalType === 'fasting') {
                input.min = '1';
                input.max = '48';
            } else if (goalType === 'dinner') {
                input.min = '0';
                input.max = '23';
            } else if (goalType === 'exercise') {
                input.min = '5';
                input.max = '300';
            } else if (goalType === 'calories') {
                input.min = '500';
                input.max = '5000';
                input.step = '50';
                input.style.width = '100px';
            }

            // 저장/취소 함수
            const save = () => {
                const newValue = goalType === 'water' ? parseFloat(input.value) : parseInt(input.value);

                // 유효성 검사
                if (isNaN(newValue) || newValue <= 0) {
                    showToast('❌ 올바른 숫자를 입력해주세요.');
                    textEl.textContent = originalText;
                    return;
                }

                // 값 저장
                if (goalType === 'water') {
                    localStorage.setItem('goal_water_target', newValue);
                    textEl.textContent = `물 ${newValue}L 마시기`;
                } else if (goalType === 'fasting') {
                    localStorage.setItem('goal_fasting_hours', newValue);
                    textEl.textContent = `간헐적 단식 ${newValue}시간`;
                } else if (goalType === 'dinner') {
                    localStorage.setItem('goal_dinner_hour', newValue);
                    textEl.textContent = `저녁 ${newValue}시 이후 금식`;
                } else if (goalType === 'exercise') {
                    localStorage.setItem('goal_exercise_minutes', newValue);
                    textEl.textContent = `운동 ${newValue}분 이상`;
                } else if (goalType === 'calories') {
                    localStorage.setItem('goal_calories_target', newValue);
                    // goal-calories-status 업데이트 필요
                    loadPlanTab(); // 플랜 탭 새로고침
                }

                showToast(`✅ 목표가 변경되었습니다!`);
            };

            const cancel = () => {
                textEl.textContent = originalText;
            };

            // 텍스트를 입력 필드로 교체
            textEl.textContent = '';
            textEl.appendChild(input);
            input.focus();
            input.select();

            // Enter: 저장
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    save();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancel();
                }
            });

            // 포커스 잃으면 저장
            input.addEventListener('blur', () => {
                setTimeout(save, 100);
            });
        }

        // 커스텀 목표 렌더링
        function renderCustomGoals() {
            const container = document.getElementById('customGoalsList');
            if (!container) return;

            container.innerHTML = customGoals.map(goal => `
                <div class="custom-goal-item">
                    <input type="checkbox" 
                           id="custom-goal-${goal.id}" 
                           ${goal.completed ? 'checked' : ''}
                           onchange="toggleCustomGoal(${goal.id})">
                    <span class="goal-icon">⭐</span>
                    <span class="goal-text">${goal.text}</span>
                    <button class="delete-btn" onclick="deleteCustomGoal(${goal.id})">🗑️</button>
                </div>
            `).join('');
        }

        // 커스텀 목표 토글
        function toggleCustomGoal(id) {
            const goal = customGoals.find(g => g.id === id);
            if (goal) {
                goal.completed = !goal.completed;
                saveGoals();
            }
        }

        // 커스텀 목표 삭제
        function deleteCustomGoal(id) {
            if (confirm('이 목표를 삭제하시겠습니까?')) {
                customGoals = customGoals.filter(g => g.id !== id);
                renderCustomGoals();
                saveGoals();
            }
        }

        // 일기 저장 (기존 함수 대체)
        function saveDiary() {
            const diary = document.getElementById('dailyDiary')?.value || '';
            const today = new Date().toISOString().split('T')[0];

            localStorage.setItem(`diet_diary_${today}`, diary);

            if (currentUser) {
                db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('diaries').doc(today)
                    .set({
                        content: diary.substring(0, 500),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true })
                    .catch(error => console.error('일기 저장 실패:', error));
            }
        }

        // 일기 불러오기
        function loadDiary() {
            const today = new Date().toISOString().split('T')[0];
            const saved = localStorage.getItem(`diet_diary_${today}`);

            if (saved) {
                const diaryEl = document.getElementById('dailyDiary');
                if (diaryEl) {
                    diaryEl.value = saved;
                    updateCharCount();
                }
            }
        }

        // 글자 수 업데이트
        function updateCharCount() {
            const diary = document.getElementById('dailyDiary')?.value || '';
            const charCount = Math.min(diary.length, 500);
            document.getElementById('diaryCharCount').textContent = charCount;
        }

        async function saveDailyPlan() {
            // 기존 함수 유지 (호환성)
            saveDiary();
        }

        // 일정 & 일기 불러오기
        async function loadDailyPlan() {
            if (!currentUser) return;

            try {
                const today = new Date().toISOString().split('T')[0];
                const doc = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyPlans').doc(today)
                    .get();

                if (doc.exists) {
                    const data = doc.data();
                    dailySchedules = data.schedules || [];

                    const diaryEl = document.getElementById('dailyDiary');
                    if (diaryEl) {
                        diaryEl.value = data.diary || '';
                        // 글자 수 업데이트
                        const charCount = diaryEl.value.length;
                        document.getElementById('diaryCharCount').textContent = charCount;
                    }

                    renderScheduleList();
                    console.log('📥 일정 & 일기 로드 완료');
                }
            } catch (error) {
                console.error('❌ 일정 & 일기 로드 실패:', error);
            }
        }

        // ============================================

        async function suggestPlanWithAI() {
            // AI가 어제 데이터를 분석하여 플랜 추천
            const prompt = `사용자의 다이어트 앱을 위한 오늘의 플랜을 3-5가지 추천해주세요.
            형식: 시간|카테고리|활동명|예상수치
            예시:
            07:00|운동|아침 조깅|30분
            12:00|식사|점심 (저염식)|500kcal

            간단명료하게 각 줄마다 하나씩만 작성해주세요.`;

            const response = await callGeminiAPI(prompt);

            if (confirm(`AI 추천 플랜:\n\n${response}\n\n이 플랜들을 추가하시겠습니까?`)) {
                const lines = response.trim().split('\n');
                for (const line of lines) {
                    const parts = line.split('|');
                    if (parts.length >= 3) {
                        await addPlan(parts[0].trim(), parts[1].trim(), parts[2].trim(), parts[3]?.trim() || '');
                    }
                }
                await loadPlanTab();
            }
        }

        // ==================== 단식 탭 ====================
        async function initializeFasting() {
            const saved = localStorage.getItem(LS_KEYS.FASTING);
            if (saved) {
                fastingState = JSON.parse(saved);
                if (fastingState.active) {
                    // UI 전환
                    document.getElementById('fastingPresetSection').style.display = 'none';
                    document.getElementById('fastingActiveControls').style.display = 'flex';
                    
                    // 일시정지 상태 복원
                    if (fastingState.paused) {
                        document.getElementById('fastingPauseBtn').style.display = 'none';
                        document.getElementById('fastingResumeBtn').style.display = 'inline-block';
                        document.getElementById('fastingTimeSub').textContent = '일시정지 중';
                    } else {
                        document.getElementById('fastingPauseBtn').style.display = 'inline-block';
                        document.getElementById('fastingResumeBtn').style.display = 'none';
                        startFastingTimer();
                    }
                }
            }

            // 누적 시간 로드
            await loadTodayFastingStats();
            
            // 새로운 통계 로드
            const stats = await calculateFastingStreak();
            await loadWeeklyFastingStatus();
            
            // 배지 업데이트
            updateBadges(stats);
            
            // 월간 달력 & 리포트
            currentReportMonth = new Date();
            document.getElementById('reportMonth').textContent = 
                `${currentReportMonth.getFullYear()}년 ${currentReportMonth.getMonth() + 1}월`;
            await loadMonthlyCalendar();
            await loadMonthlyReport();
            await loadWeeklyReport();
            
            // 체중 연동 차트
            await loadFastingWeightChart();
            
            // 물 섭취 표시
            await updateFastingWaterDisplay();
            
            // 마지막 식사 시간 표시
            updateLastMealDisplay();
            
            // 마지막 식사 시간 자동 업데이트 (1분마다)
            setInterval(updateLastMealDisplay, 60000);
            
            // 알림 권한 요청 (사용자가 단식 탭에 들어왔을 때)
            requestNotificationPermission();
        }

        // ========== Phase 2: 단식 프리셋 & 단계 함수 ==========

        // 단식 단계 정의
        const fastingStages = [
            { startHour: 0, endHour: 4, title: "소화 단계", emoji: "🍽️", desc: "음식을 소화하고 있습니다" },
            { startHour: 4, endHour: 8, title: "당 소모 단계", emoji: "⚡", desc: "체내 당이 소모되기 시작합니다" },
            { startHour: 8, endHour: 12, title: "지방 연소 시작", emoji: "🔥", desc: "지방이 에너지로 전환되기 시작합니다" },
            { startHour: 12, endHour: 16, title: "자가포식 활성화", emoji: "♻️", desc: "손상된 세포가 재생되고 있습니다" },
            { startHour: 16, endHour: 72, title: "심화 자가포식", emoji: "✨", desc: "깊은 세포 재생이 일어나고 있습니다" }
        ];

        // 프리셋 설정 함수
        function setFastingPreset(hours) {
            document.getElementById('fastingHours').value = hours;
            console.log(`✅ 단식 프리셋 설정: ${hours}시간`);
        }

        // 현재 단식 단계 가져오기
        function getCurrentFastingStage(elapsedHours) {
            for (const stage of fastingStages) {
                if (elapsedHours >= stage.startHour && elapsedHours < stage.endHour) {
                    return stage;
                }
            }
            return fastingStages[fastingStages.length - 1];  // 마지막 단계 반환
        }

        // 단식 단계 표시 업데이트
        function updateFastingStageDisplay(elapsedHours) {
            const stage = getCurrentFastingStage(elapsedHours);
            const stageDisplay = document.getElementById('fastingStageDisplay');

            if (stageDisplay) {
                stageDisplay.style.display = 'block';
                document.getElementById('fastingStageEmoji').textContent = stage.emoji;
                document.getElementById('fastingStageTitle').textContent = stage.title;
                document.getElementById('fastingStageDesc').textContent = stage.desc;
            }
        }

        // ===============================================

        // ========== 새로운 빠른 시작 함수 ==========
        function startFastingQuick(hours) {
            if (fastingState && fastingState.active) {
                alert('이미 단식이 진행 중입니다. 먼저 중단해주세요.');
                return;
            }

            if (hours > 24) {
                if (!confirm(`${hours}시간 단식은 건강에 위험할 수 있습니다. 계속하시겠습니까?`)) {
                    return;
                }
            }

            const now = Date.now();
            fastingState = {
                active: true,
                paused: false,
                startTime: now,
                duration: hours * 60 * 60 * 1000,
                endTime: now + (hours * 60 * 60 * 1000),
                pausedAt: null,
                totalPausedDuration: 0
            };

            localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));
            startFastingTimer();

            // UI 전환
            document.getElementById('fastingPresetSection').style.display = 'none';
            document.getElementById('fastingActiveControls').style.display = 'flex';
            document.getElementById('fastingStatusText').textContent = `${hours}시간 단식 진행 중`;
            
            // 푸시 알림 예약
            scheduleFastingNotification(hours);
            
            console.log(`✅ ${hours}시간 단식 시작!`);
            
            // 통계 업데이트
            setTimeout(async () => {
                const stats = await calculateFastingStreak();
                await loadWeeklyFastingStatus();
                await loadWeeklyReport();
                await loadMonthlyReport();
                await loadMonthlyCalendar();
                await loadFastingWeightChart();
                updateBadges(stats);
            }, 1000);
        }

        // ========== 커스텀 단식 시간 입력 모달 ==========
        function openCustomFastingModal() {
            const hours = prompt('단식 시간을 입력하세요 (시간 단위)', '16');
            if (hours && !isNaN(hours) && parseInt(hours) > 0) {
                startFastingQuick(parseInt(hours));
            }
        }

        // ========== 일시정지 기능 ==========
        function pauseFasting() {
            if (!fastingState || !fastingState.active || fastingState.paused) return;

            fastingState.paused = true;
            fastingState.pausedAt = Date.now();
            localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));

            if (fastingInterval) {
                clearInterval(fastingInterval);
            }

            document.getElementById('fastingPauseBtn').style.display = 'none';
            document.getElementById('fastingResumeBtn').style.display = 'inline-block';
            document.getElementById('fastingTimeSub').textContent = '일시정지 중';
            console.log('⏸️ 단식 일시정지');
        }

        // ========== 재개 기능 ==========
        function resumeFasting() {
            if (!fastingState || !fastingState.active || !fastingState.paused) return;

            const now = Date.now();
            const pausedDuration = now - fastingState.pausedAt;
            fastingState.totalPausedDuration += pausedDuration;
            fastingState.endTime += pausedDuration;  // 일시정지한 만큼 종료 시간 연장
            fastingState.paused = false;
            fastingState.pausedAt = null;
            localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));

            startFastingTimer();

            document.getElementById('fastingPauseBtn').style.display = 'inline-block';
            document.getElementById('fastingResumeBtn').style.display = 'none';
            console.log('▶️ 단식 재개');
        }

        // ===============================================

        function startFasting() {
            const hours = parseInt(document.getElementById('fastingHours').value) || 16;

            if (hours > 24) {
                if (!confirm('24시간 이상의 단식은 건강에 위험할 수 있습니다. 계속하시겠습니까?')) {
                    return;
                }
            }

            const now = Date.now();
            fastingState = {
                active: true,
                startTime: now,
                duration: hours * 60 * 60 * 1000,
                endTime: now + (hours * 60 * 60 * 1000)
            };

            localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));
            startFastingTimer();

            document.getElementById('fastingStartBtn').style.display = 'none';
            document.getElementById('fastingStopBtn').style.display = 'inline-block';
            document.getElementById('fastingDurationInput').style.display = 'none';
        }

        async function stopFasting() {
            if (!confirm('단식을 중단하시겠습니까?')) return;

            // Firestore에 기록 저장
            if (fastingState && fastingState.active) {
                try {
                    const now = Date.now();
                    const duration = now - fastingState.startTime - (fastingState.totalPausedDuration || 0);
                    const today = new Date().toISOString().split('T')[0];

                    await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                        .collection('fastingRecords').add({
                            startTime: firebase.firestore.Timestamp.fromMillis(fastingState.startTime),
                            endTime: firebase.firestore.Timestamp.fromMillis(now),
                            duration: duration,
                            date: today,
                            completed: false
                        });

                    // 누적 시간 새로고침
                    await loadTodayFastingStats();
                    
                    // 통계 업데이트
                    const stats = await calculateFastingStreak();
                    await loadWeeklyFastingStatus();
                    await loadWeeklyReport();
                    await loadMonthlyReport();
                    await loadMonthlyCalendar();
                    await loadFastingWeightChart();
                    updateBadges(stats);
                } catch (error) {
                    console.error('단식 기록 저장 실패:', error);
                }
            }

            fastingState = null;
            localStorage.removeItem(LS_KEYS.FASTING);

            if (fastingInterval) {
                clearInterval(fastingInterval);
            }

            // UI 리셋
            document.getElementById('fastingPresetSection').style.display = 'block';
            document.getElementById('fastingActiveControls').style.display = 'none';
            document.getElementById('fastingTimeMain').textContent = '00:00:00';
            document.getElementById('fastingStatusText').textContent = '단식 시간을 선택해주세요';
            document.getElementById('fastingProgress').style.strokeDashoffset = 691;
            document.getElementById('fastingStageDisplay').style.display = 'none';
            
            // 알림 취소
            cancelFastingNotification();
        }

        function startFastingTimer() {
            updateFastingDisplay();
            fastingInterval = setInterval(updateFastingDisplay, 1000);
        }

        async function updateFastingDisplay() {
            if (!fastingState || !fastingState.active) return;
            
            // 일시정지 상태면 업데이트 중단
            if (fastingState.paused) return;

            const now = Date.now();
            const elapsed = now - fastingState.startTime - (fastingState.totalPausedDuration || 0);
            const remaining = fastingState.endTime - now;

            if (remaining <= 0) {
                // 단식 완료 - Firestore에 기록 저장
                try {
                    await saveFastingRecord(true);  // completed: true
                } catch (error) {
                    console.error('단식 완료 기록 저장 실패:', error);
                }
                
                // 푸시 알림 전송
                sendFastingCompletionNotification();
                
                await stopFasting();
                alert('축하합니다! 단식 목표를 달성했습니다! 🎉');
                return;
            }

            const elapsedHours = Math.floor(elapsed / (1000 * 60 * 60));
            const elapsedMinutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const elapsedSeconds = Math.floor((elapsed % (1000 * 60)) / 1000);

            // ========== Phase 2: 단계 표시 업데이트 ==========
            updateFastingStageDisplay(elapsedHours);
            // ===============================================

            const remainingHours = Math.floor(remaining / (1000 * 60 * 60));
            const remainingMinutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const remainingSeconds = Math.floor((remaining % (1000 * 60)) / 1000);

            document.getElementById('fastingTimeMain').textContent =
                `${String(elapsedHours).padStart(2, '0')}:${String(elapsedMinutes).padStart(2, '0')}:${String(elapsedSeconds).padStart(2, '0')}`;

            document.getElementById('fastingTimeSub').textContent =
                `남은 시간: ${remainingHours}시간 ${remainingMinutes}분`;

            // 진행률 계산
            const progress = elapsed / fastingState.duration;
            const circumference = 691; // 2 * π * r (r=110)
            const offset = circumference - (progress * circumference);
            document.getElementById('fastingProgress').style.strokeDashoffset = offset;
        }

        // 단식 기록 저장
        async function saveFastingRecord(completed = false) {
            if (!fastingState || !fastingState.active) return;

            const now = Date.now();
            const duration = now - fastingState.startTime;
            const today = new Date().toISOString().split('T')[0];

            await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('fastingRecords').add({
                    startTime: firebase.firestore.Timestamp.fromMillis(fastingState.startTime),
                    endTime: firebase.firestore.Timestamp.fromMillis(now),
                    duration: duration,
                    date: today,
                    completed: completed
                });
        }

        // 오늘의 누적 시간 로드
        async function loadTodayFastingStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('fastingRecords')
                    .where('date', '==', today)
                    .get();

                let totalDuration = 0;
                const sessions = [];

                records.forEach(doc => {
                    const data = doc.data();
                    totalDuration += data.duration;
                    sessions.push({
                        startTime: data.startTime.toDate(),
                        endTime: data.endTime.toDate(),
                        duration: data.duration,
                        completed: data.completed
                    });
                });

                // 현재 진행 중인 단식도 포함
                if (fastingState && fastingState.active && !fastingState.paused) {
                    const currentDuration = Date.now() - fastingState.startTime - (fastingState.totalPausedDuration || 0);
                    totalDuration += currentDuration;
                }

                const hours = Math.floor(totalDuration / (1000 * 60 * 60));
                const minutes = Math.floor((totalDuration % (1000 * 60 * 60)) / (1000 * 60));

                const accumulatedEl = document.getElementById('accumulatedTime');
                if (accumulatedEl) {
                    if (hours === 0 && minutes === 0) {
                        accumulatedEl.textContent = '아직 단식 기록이 없습니다';
                        accumulatedEl.style.fontSize = '1.5rem';
                    } else {
                        accumulatedEl.textContent = `${hours}시간 ${minutes}분`;
                        accumulatedEl.style.fontSize = '2.5rem';
                    }
                }

                displayFastingSessions(sessions);
            } catch (error) {
                console.error('단식 통계 로드 실패:', error);
            }
        }

        // 세션 목록 표시
        function displayFastingSessions(sessions) {
            const container = document.getElementById('fastingSessions');
            if (!container) return;

            container.innerHTML = '';

            if (sessions.length === 0) {
                return;
            }

            sessions.forEach((session, index) => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'fasting-session-item';

                const duration = Math.floor(session.duration / (1000 * 60));
                const hours = Math.floor(duration / 60);
                const minutes = duration % 60;

                const statusIcon = session.completed ? '✅' : '⏸️';
                const startTime = session.startTime.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
                const endTime = session.endTime.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});

                sessionDiv.innerHTML = `
                    <span>${statusIcon} 세션 ${index + 1}</span>
                    <span>${startTime} - ${endTime}</span>
                    <span>${hours}시간 ${minutes}분</span>
                `;

                container.appendChild(sessionDiv);
            });
        }

        // ========== 새로운 단식 통계 함수들 ==========
        
        // 단식 스트릭 계산 (연속 일수)
        async function calculateFastingStreak() {
            try {
                const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('fastingRecords')
                    .orderBy('date', 'desc')
                    .limit(30)
                    .get();

                let streak = 0;
                let totalDays = 0;
                let totalHours = 0;
                const dates = new Set();
                
                records.forEach(doc => {
                    const data = doc.data();
                    dates.add(data.date);
                    totalHours += data.duration / (1000 * 60 * 60);
                });

                totalDays = dates.size;

                // 연속 일수 계산
                const sortedDates = Array.from(dates).sort().reverse();
                const today = new Date().toISOString().split('T')[0];
                
                if (sortedDates.length > 0) {
                    // 오늘부터 연속으로 단식한 날 계산
                    let currentDate = new Date(today);
                    
                    for (let date of sortedDates) {
                        const checkDate = currentDate.toISOString().split('T')[0];
                        if (date === checkDate) {
                            streak++;
                            currentDate.setDate(currentDate.getDate() - 1);
                        } else {
                            break;
                        }
                    }
                }

                const avgHours = totalDays > 0 ? Math.round(totalHours / totalDays) : 0;

                // UI 업데이트
                document.getElementById('fastingStreak').textContent = streak;
                document.getElementById('totalFastingDays').textContent = totalDays;
                document.getElementById('avgFastingHours').textContent = avgHours + 'h';

                return { streak, totalDays, avgHours };
            } catch (error) {
                console.error('단식 스트릭 계산 실패:', error);
                return { streak: 0, totalDays: 0, avgHours: 0 };
            }
        }

        // 이번 주 단식 현황 표시
        async function loadWeeklyFastingStatus() {
            try {
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0(일) ~ 6(토)
                const monday = new Date(today);
                monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                monday.setHours(0, 0, 0, 0);

                const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('fastingRecords')
                    .where('date', '>=', monday.toISOString().split('T')[0])
                    .get();

                const weekData = {};
                records.forEach(doc => {
                    const data = doc.data();
                    if (!weekData[data.date]) {
                        weekData[data.date] = { totalHours: 0, completed: false };
                    }
                    weekData[data.date].totalHours += data.duration / (1000 * 60 * 60);
                    if (data.completed) {
                        weekData[data.date].completed = true;
                    }
                });

                const container = document.getElementById('weeklyFastingGrid');
                container.innerHTML = '';

                const weekDays = ['월', '화', '수', '목', '금', '토', '일'];
                let completedCount = 0;

                for (let i = 0; i < 7; i++) {
                    const date = new Date(monday);
                    date.setDate(monday.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    const todayStr = new Date().toISOString().split('T')[0];
                    
                    const dayData = weekData[dateStr] || { totalHours: 0, completed: false };
                    const hours = Math.round(dayData.totalHours);
                    
                    if (hours >= 12) completedCount++; // 12시간 이상이면 완료로 간주

                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'weekly-day-item';
                    if (hours >= 12) dayDiv.classList.add('completed');
                    if (dateStr === todayStr) dayDiv.classList.add('today');

                    dayDiv.innerHTML = `
                        <div class="weekly-day-label">${weekDays[i]}</div>
                        <div class="weekly-day-hours">${hours > 0 ? hours + 'h' : '-'}</div>
                    `;

                    container.appendChild(dayDiv);
                }

                document.getElementById('weeklyGoalStatus').textContent = 
                    `주간 목표: 5회 단식 / 현재: ${completedCount}회 완료`;

            } catch (error) {
                console.error('주간 단식 현황 로드 실패:', error);
            }
        }

        // 마지막 식사 시간 기록
        function recordLastMealTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            
            localStorage.setItem('lastMealTime', now.toISOString());
            
            document.getElementById('lastMealTime').textContent = `마지막 식사: ${timeStr}`;
            
            // 토스트 메시지
            showToast(`✅ 마지막 식사 시간이 ${timeStr}로 기록되었습니다.`);
        }

        // 단식 시간 연장 (+1시간)
        function extendFasting() {
            if (!fastingState || !fastingState.active) return;

            const oneHour = 60 * 60 * 1000;
            fastingState.endTime += oneHour;
            fastingState.duration += oneHour;
            
            localStorage.setItem(LS_KEYS.FASTING, JSON.stringify(fastingState));
            
            showToast('⏰ 단식 시간이 1시간 연장되었습니다!');
            console.log('단식 1시간 연장');
        }

        // 마지막 식사 시간 표시 업데이트
        function updateLastMealDisplay() {
            const lastMeal = localStorage.getItem('lastMealTime');
            if (lastMeal) {
                const mealTime = new Date(lastMeal);
                const now = new Date();
                const elapsed = now - mealTime;
                const hours = Math.floor(elapsed / (1000 * 60 * 60));
                const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                
                const timeStr = mealTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('lastMealTime').textContent = 
                    `마지막 식사: ${timeStr} (${hours}시간 ${minutes}분 전)`;
            }
        }

        // ========== 배지 시스템 ==========
        const badges = [
            { id: 'first', emoji: '🌟', name: '첫 단식', condition: (stats) => stats.totalDays >= 1 },
            { id: 'week1', emoji: '🔥', name: '7일 연속', condition: (stats) => stats.streak >= 7 },
            { id: 'week2', emoji: '💪', name: '14일 연속', condition: (stats) => stats.streak >= 14 },
            { id: 'month', emoji: '🏆', name: '30일 달성', condition: (stats) => stats.totalDays >= 30 },
            { id: 'master', emoji: '👑', name: '마스터', condition: (stats) => stats.streak >= 30 },
            { id: 'pro', emoji: '⭐', name: '프로', condition: (stats) => stats.totalDays >= 100 }
        ];

        function updateBadges(stats) {
            const container = document.getElementById('badgesGrid');
            container.innerHTML = '';

            badges.forEach(badge => {
                const unlocked = badge.condition(stats);
                const badgeDiv = document.createElement('div');
                badgeDiv.className = 'badge-item' + (unlocked ? ' unlocked' : '');
                badgeDiv.innerHTML = `
                    <div class="badge-emoji">${badge.emoji}</div>
                    <div class="badge-name">${badge.name}</div>
                `;
                container.appendChild(badgeDiv);
            });
        }

        // ========== 월간 달력 생성 ==========
        let currentReportMonth = new Date();

        async function loadMonthlyCalendar() {
            const year = currentReportMonth.getFullYear();
            const month = currentReportMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // 해당 월의 단식 기록 조회
            const startDate = firstDay.toISOString().split('T')[0];
            const endDate = lastDay.toISOString().split('T')[0];
            
            const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('fastingRecords')
                .where('date', '>=', startDate)
                .where('date', '<=', endDate)
                .get();

            const monthData = {};
            records.forEach(doc => {
                const data = doc.data();
                if (!monthData[data.date]) {
                    monthData[data.date] = 0;
                }
                monthData[data.date] += data.duration / (1000 * 60 * 60);
            });

            const container = document.getElementById('fastingCalendar');
            container.innerHTML = '';

            // 요일 헤더
            const weekDays = ['일', '월', '화', '수', '목', '금', '토'];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.textAlign = 'center';
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.fontSize = '0.85rem';
                dayHeader.style.padding = '5px';
                dayHeader.style.color = '#666';
                dayHeader.textContent = day;
                container.appendChild(dayHeader);
            });

            // 빈 칸 추가 (월의 첫날 앞)
            const firstDayOfWeek = firstDay.getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDiv = document.createElement('div');
                container.appendChild(emptyDiv);
            }

            // 날짜 생성
            const today = new Date().toISOString().split('T')[0];
            for (let date = 1; date <= lastDay.getDate(); date++) {
                const dateStr = new Date(year, month, date).toISOString().split('T')[0];
                const hours = Math.round(monthData[dateStr] || 0);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                if (hours >= 12) dayDiv.classList.add('fasted');
                if (dateStr === today) dayDiv.classList.add('today');

                dayDiv.innerHTML = `
                    <div class="calendar-day-number">${date}</div>
                    ${hours > 0 ? `<div class="calendar-day-hours">${hours}h</div>` : ''}
                `;
                container.appendChild(dayDiv);
            }
        }

        function changeReportMonth(direction) {
            currentReportMonth.setMonth(currentReportMonth.getMonth() + direction);
            document.getElementById('reportMonth').textContent = 
                `${currentReportMonth.getFullYear()}년 ${currentReportMonth.getMonth() + 1}월`;
            loadMonthlyCalendar();
            loadMonthlyReport();
        }

        // ========== 월간 리포트 ==========
        async function loadMonthlyReport() {
            // 🔥 프로필 시작일 가져오기
            const profileDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid).get();
            const profile = profileDoc.data();
            let profileStartDate = null;

            if (profile && profile.createdAt) {
                profileStartDate = profile.createdAt.toDate().toISOString().split('T')[0];
                console.log('📅 프로필 시작일:', profileStartDate);
            }

            const year = currentReportMonth.getFullYear();
            const month = currentReportMonth.getMonth();
            const monthStartDate = new Date(year, month, 1).toISOString().split('T')[0];
            const monthEndDate = new Date(year, month + 1, 0).toISOString().split('T')[0];

            // 🔥 조회 시작일 = max(월 시작일, 프로필 시작일)
            const queryStartDate = profileStartDate && profileStartDate > monthStartDate 
                ? profileStartDate 
                : monthStartDate;

            console.log(`📊 월간 리포트 조회: ${queryStartDate} ~ ${monthEndDate}`);

            const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('fastingRecords')
                .where('date', '>=', queryStartDate)
                .where('date', '<=', monthEndDate)
                .get();

            let totalHours = 0;
            let longestHours = 0;
            const dates = new Set();

            records.forEach(doc => {
                const data = doc.data();
                const hours = data.duration / (1000 * 60 * 60);
                totalHours += hours;
                if (hours > longestHours) longestHours = hours;
                dates.add(data.date);
            });

            const totalDays = dates.size;
            const avgHours = totalDays > 0 ? Math.round(totalHours / totalDays) : 0;

            // 🔥 체중 변화도 profile.createdAt 이후만 조회
            const weightQueryStartDate = profileStartDate && profileStartDate > monthStartDate
                ? new Date(profileStartDate)
                : new Date(monthStartDate);

            const weights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs')
                .where('date', '>=', firebase.firestore.Timestamp.fromDate(weightQueryStartDate))
                .where('date', '<=', firebase.firestore.Timestamp.fromDate(new Date(monthEndDate)))
                .orderBy('date', 'asc')
                .get();

            console.log('월간 체중 기록 개수:', weights.docs.length);

            let weightChange = 0;
            if (weights.docs.length >= 2) {
                const firstWeight = weights.docs[0].data().weight;
                const lastWeight = weights.docs[weights.docs.length - 1].data().weight;
                weightChange = (lastWeight - firstWeight).toFixed(1);
                console.log(`체중 변화: ${firstWeight}kg -> ${lastWeight}kg = ${weightChange}kg`);
            } else if (weights.docs.length === 1) {
                // 기록이 1개만 있으면 0
                weightChange = 0;
                console.log('체중 기록 1개 → 체중 변화 0kg');
            } else {
                console.log('체중 기록 없음 → 체중 변화 0kg');
            }

            // UI 업데이트
            document.getElementById('monthlyTotalDays').textContent = totalDays;
            document.getElementById('monthlyAvgHours').textContent = avgHours + 'h';
            document.getElementById('monthlyLongest').textContent = Math.round(longestHours) + 'h';
            document.getElementById('monthlyWeightChange').textContent = 
                (weightChange > 0 ? '+' : '') + weightChange + 'kg';
            document.getElementById('monthlyWeightChange').style.color = 
                weightChange < 0 ? '#56ab2f' : weightChange > 0 ? '#ff5252' : '#666';

            // 월간 요약 텍스트
            const monthName = `${year}년 ${month + 1}월`;
            let reportText = `📊 <strong>${monthName} 단식 요약</strong><br><br>`;
            reportText += `✅ 총 <strong>${totalDays}일</strong> 단식을 실천했습니다.<br>`;
            reportText += `⏱️ 평균 <strong>${avgHours}시간</strong> 단식했습니다.<br>`;
            reportText += `🔥 최장 <strong>${Math.round(longestHours)}시간</strong> 기록을 달성했습니다.<br>`;
            if (Math.abs(weightChange) > 0) {
                reportText += `⚖️ 체중이 <strong>${Math.abs(weightChange)}kg ${weightChange < 0 ? '감소' : '증가'}</strong>했습니다.<br>`;
            }
            reportText += `<br>💪 ${totalDays >= 20 ? '정말 훌륭합니다!' : totalDays >= 10 ? '잘하고 있어요!' : '조금 더 힘내세요!'}`;

            document.getElementById('monthlyReportText').innerHTML = reportText;
        }

        // ========== 주간 리포트 ==========
        async function loadWeeklyReport() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            monday.setHours(0, 0, 0, 0);

            const records = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('fastingRecords')
                .where('date', '>=', monday.toISOString().split('T')[0])
                .get();

            let totalHours = 0;
            const dates = new Set();
            records.forEach(doc => {
                const data = doc.data();
                totalHours += data.duration / (1000 * 60 * 60);
                dates.add(data.date);
            });

            const completedDays = dates.size;
            const avgHours = completedDays > 0 ? Math.round(totalHours / completedDays) : 0;

            let reportText = `📊 <strong>이번 주 단식 요약</strong><br><br>`;
            reportText += `✅ 이번 주 <strong>${completedDays}일</strong> 단식했습니다.<br>`;
            reportText += `⏱️ 평균 <strong>${avgHours}시간</strong> 단식했습니다.<br>`;
            reportText += `🎯 주간 목표 5회 중 <strong>${completedDays}회</strong> 달성!<br>`;
            reportText += `<br>💪 ${completedDays >= 5 ? '목표 달성! 멋져요! 🎉' : completedDays >= 3 ? '잘하고 있어요! 조금만 더!' : '이번 주 파이팅!'}`;

            document.getElementById('weeklyReportText').innerHTML = reportText;
        }

        // ========== 체중 연동 차트 ==========
        let fastingWeightChart = null;

        async function loadFastingWeightChart() {
            try {
                // 프로필에서 시작일 가져오기
                const profileDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid).get();
                const profile = profileDoc.data();
                
                let startDate;
                if (profile && profile.createdAt) {
                    startDate = profile.createdAt.toDate();
                } else {
                    // createdAt이 없으면 30일 전부터
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - 30);
                }

                const today = new Date();
                console.log(`차트 기간: ${startDate.toISOString().split('T')[0]} ~ ${today.toISOString().split('T')[0]}`);

                // 단식 기록
                const fastingRecords = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('fastingRecords')
                    .where('date', '>=', startDate.toISOString().split('T')[0])
                    .orderBy('date', 'asc')
                    .get();

                const fastingData = {};
                fastingRecords.forEach(doc => {
                    const data = doc.data();
                    if (!fastingData[data.date]) {
                        fastingData[data.date] = 0;
                    }
                    fastingData[data.date] += data.duration / (1000 * 60 * 60);
                });

                // 체중 기록 (logs 컬렉션 사용)
                const weightRecords = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs')  // weights -> logs로 수정
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(startDate))
                    .orderBy('date', 'asc')
                    .get();

                console.log('체중 기록 개수:', weightRecords.size);

                const weightData = {};
                weightRecords.forEach(doc => {
                    const data = doc.data();
                    const dateStr = data.date.toDate().toISOString().split('T')[0];
                    weightData[dateStr] = data.weight;
                    console.log('체중 데이터:', dateStr, data.weight + 'kg');
                });

                // 날짜 레이블 생성 (시작일부터 오늘까지)
                const labels = [];
                const fastingHours = [];
                const weights = [];
                
                const daysDiff = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));
                console.log(`총 ${daysDiff}일`);
                
                for (let i = 0; i <= daysDiff; i++) {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    labels.push(`${date.getMonth() + 1}/${date.getDate()}`);
                    fastingHours.push(Math.round(fastingData[dateStr] || 0));
                    weights.push(weightData[dateStr] || null);
                }

                console.log('차트 데이터:', { labels, fastingHours, weights });

                // Chart.js로 그래프 생성
                const ctx = document.getElementById('fastingWeightChart');
                if (!ctx) {
                    console.error('차트 캔버스를 찾을 수 없습니다.');
                    return;
                }

                if (fastingWeightChart) fastingWeightChart.destroy();

                fastingWeightChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '단식 시간 (h)',
                                data: fastingHours,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                yAxisID: 'y',
                                tension: 0.4,
                                borderWidth: 2
                            },
                            {
                                label: '체중 (kg)',
                                data: weights,
                                borderColor: '#56ab2f',
                                backgroundColor: 'rgba(86, 171, 47, 0.1)',
                                yAxisID: 'y1',
                                tension: 0.4,
                                spanGaps: true,
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: '단식 시간 (h)', color: '#667eea' },
                                ticks: { color: '#667eea' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: '체중 (kg)', color: '#56ab2f' },
                                grid: { drawOnChartArea: false },
                                ticks: { color: '#56ab2f' }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                enabled: true
                            }
                        }
                    }
                });

                console.log('✅ 체중 차트 로드 완료');
            } catch (error) {
                console.error('체중 차트 로드 실패:', error);
            }
        }

        // ========== 물 섭취 연동 (홈 탭과 완전 동기화) ==========
        
        // 홈 탭 "스마트 물마시기"에서 컵 크기 가져오기
        function getWaterCupSize() {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"cupSize": 250}');
            return settings.cupSize || 250;
        }

        // 단식 탭에서 물 추가 (홈 탭 컵 크기 사용)
        async function quickAddWaterCup() {
            const cupSize = getWaterCupSize();
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"cupSize": 250, "goalLiters": 2, "filled": []}');
            
            // 오늘 날짜 확인
            const today = new Date().toISOString().split('T')[0];
            if (settings.lastDate !== today) {
                settings.filled = [];
                settings.lastDate = today;
            }

            if (!settings.filled) settings.filled = [];

            // 다음 빈 컵 찾기
            const goalMl = (settings.goalLiters || 2) * 1000;
            const cupCount = Math.ceil(goalMl / cupSize);
            
            // 빈 컵 인덱스 찾기
            let nextEmptyIndex = -1;
            for (let i = 0; i < cupCount; i++) {
                if (!settings.filled.includes(i)) {
                    nextEmptyIndex = i;
                    break;
                }
            }

            if (nextEmptyIndex !== -1) {
                // 빈 컵이 있으면 추가
                settings.filled.push(nextEmptyIndex);
                localStorage.setItem(LS_KEYS.WATER_SETTINGS, JSON.stringify(settings));

                // ========== 캘린더 동기화 추가 ==========
                const totalIntake = settings.filled.length * cupSize;
                await saveToDailyLog(new Date(), 'water', {
                    amount: totalIntake
                });
                
                // 캘린더가 현재 열려있으면 새로고침
                if (currentTab === 'calendar' && typeof renderCalendar === 'function') {
                    renderCalendar();
                }
                // ==========================================

                // 홈 탭 UI 업데이트 (함수가 있으면)
                if (typeof updateWaterTracker === 'function') {
                    updateWaterTracker();
                }

                // 단식 탭 UI 업데이트
                updateFastingWaterDisplay();

                showToast(`💧 물 ${cupSize}ml 추가! (홈 탭에도 반영됨)`);
            } else {
                showToast('🎉 오늘의 물 마시기 목표를 달성했습니다!');
            }
        }

        // 단식 탭 물 섭취량 표시 업데이트
        async function updateFastingWaterDisplay() {
            const settings = JSON.parse(localStorage.getItem(LS_KEYS.WATER_SETTINGS) || '{"cupSize": 250, "filled": []}');
            const cupSize = settings.cupSize || 250;
            const filledCount = settings.filled ? settings.filled.length : 0;
            const totalMl = filledCount * cupSize;

            document.getElementById('fastingWaterIntake').textContent = totalMl + 'ml';
            
            // 버튼 텍스트도 컵 크기에 맞춰 업데이트
            const btn = document.getElementById('quickAddWaterBtn');
            if (btn) {
                btn.innerHTML = `+${cupSize}ml 💧`;
            }
        }

        // 홈 탭의 물마시기 함수 확장 (단식 탭 동기화)
        const originalToggleWaterCup = window.toggleWaterCup;
        if (originalToggleWaterCup) {
            window.toggleWaterCup = function(index) {
                originalToggleWaterCup(index);
                // 단식 탭이 초기화되어 있으면 업데이트
                if (document.getElementById('fastingWaterIntake')) {
                    updateFastingWaterDisplay();
                }
            };
        }

        // ========== 단식 타이머 푸시 알림 기능 ==========
        let fastingNotificationTimeout = null;

        // 푸시 알림 권한 요청
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('이 브라우저는 알림을 지원하지 않습니다.');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            }

            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }

            return false;
        }

        // 단식 완료 알림 예약
        async function scheduleFastingNotification(hours) {
            const hasPermission = await requestNotificationPermission();
            if (!hasPermission) {
                console.log('알림 권한이 없습니다.');
                return;
            }

            // 기존 알림 취소
            if (fastingNotificationTimeout) {
                clearTimeout(fastingNotificationTimeout);
            }

            // 단식 완료 시간 계산 (밀리초)
            const duration = hours * 60 * 60 * 1000;

            // 단식 완료 시 알림 예약
            fastingNotificationTimeout = setTimeout(() => {
                sendFastingCompletionNotification();
            }, duration);

            console.log(`✅ ${hours}시간 후 단식 완료 알림 예약됨`);
        }

        // 단식 완료 알림 전송
        function sendFastingCompletionNotification() {
            if (Notification.permission === 'granted') {
                const notification = new Notification('🎉 단식 완료!', {
                    body: '축하합니다! 단식 목표를 달성했습니다. 이제 건강한 식사를 시작하세요!',
                    icon: '/icon-192.png',
                    badge: '/icon-192.png',
                    vibrate: [200, 100, 200],
                    tag: 'fasting-complete',
                    requireInteraction: true
                });

                notification.onclick = function() {
                    window.focus();
                    this.close();
                };

                // 알림음 재생 (선택사항)
                playNotificationSound();
            }
        }

        // 알림 취소
        function cancelFastingNotification() {
            if (fastingNotificationTimeout) {
                clearTimeout(fastingNotificationTimeout);
                fastingNotificationTimeout = null;
                console.log('단식 알림이 취소되었습니다.');
            }
        }

        // 알림음 재생 (선택사항)
        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjCH0fPTgjMGHm7A7+OZUQ0OVqzn77BeFwxInOLyt3EdCDSP1PLEcyYGKn/L79uKOwoVYbfq7qVUFQpEn+HxtGwhBjCH0fPTgjMGHm7A7+OZUQ0OVqzn77BeFwxInOLyt3EdCDSP1PLEcyYGKn/L79uKOwoVYbfq7qVUFQpEn+HxtGwhBjCH0fPTgjMGHm7A7+OZUQ0OVqzn77BeFwxInOLyt3EdCDSP1PLEcyYGKn/L79uKOwoVYbfq7qVUFQo=');
                audio.play().catch(e => console.log('알림음 재생 실패:', e));
            } catch (error) {
                console.log('알림음 재생 중 오류:', error);
            }
        }

        // 페이지 로드 시 알림 권한 요청 (선택사항)
        // window.addEventListener('load', () => {
        //     requestNotificationPermission();
        // });

        // ==================== 앨범 탭 ====================
        async function loadAlbumTab() {
            const photos = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('photos')
                .orderBy('uploadedAt', 'desc')
                .get();

            const grid = document.getElementById('photoGrid');
            // '전체' 탭에서는 + 버튼 제거
            if (currentAlbumTab === 'all') {
                grid.innerHTML = '';
            } else {
                grid.innerHTML = '<div class="photo-item add-photo" onclick="addPhoto()">+</div>';
            }

            // Phase 4: 배치 작업을 위해 현재 표시된 항목 저장
            allPhotoItems = [];

            photos.forEach(doc => {
                const photo = doc.data();
                if (currentAlbumTab === 'all' || photo.category === currentAlbumTab) {
                    const photoDiv = document.createElement('div');
                    const docId = doc.id;

                    // Phase 4: 항목 저장 (이미지만, 텍스트 카드는 다운로드/공유 대상 아님)
                    if (photo.url) {
                        allPhotoItems.push({ docId, url: photo.url, photo });
                    }

                    // 텍스트 카드인 경우 (url이 null이고 text가 있음)
                    if (!photo.url && photo.text) {
                        photoDiv.className = `photo-item text-card category-${photo.category}`;
                        photoDiv.dataset.docId = docId;

                        let nutritionHtml = '';
                        if (photo.nutrition && photo.category === 'food') {
                            nutritionHtml = `
                                <div class="text-card-nutrition">
                                    ${Math.round(photo.nutrition.calories)}kcal
                                </div>
                            `;
                        }

                        photoDiv.innerHTML = `
                            <div class="text-card-emoji">${getCategoryEmoji(photo.category)}</div>
                            <div class="text-card-content">${photo.text}</div>
                            ${nutritionHtml}
                            <div class="photo-date-label" style="position: relative; bottom: auto; left: auto; right: auto; margin-top: 10px; font-size: 0.8rem;">
                                ${photo.uploadedAt ? formatDetailedTimestamp(photo.uploadedAt.toDate()) : ''}
                            </div>
                        `;
                    }
                    // 일반 이미지 카드
                    else if (photo.url) {
                        photoDiv.className = 'photo-item';
                        photoDiv.dataset.docId = docId;

                        // Phase 4: 선택 모드일 때 체크박스 추가
                        let checkboxHtml = '';
                        if (isSelectMode) {
                            const isChecked = selectedItems.has(docId);
                            checkboxHtml = `<div class="select-checkbox ${isChecked ? 'checked' : ''}" onclick="event.stopPropagation(); toggleItemSelection('${docId}')"></div>`;
                            if (isChecked) {
                                photoDiv.classList.add('selected');
                            }
                        }

                        photoDiv.innerHTML = `
                            ${checkboxHtml}
                            <img src="${photo.url}" alt="사진">
                            <div class="photo-date-label">${formatDetailedTimestamp(photo.uploadedAt.toDate())}</div>
                        `;
                    }

                    // Phase 4: 선택 모드일 때는 선택 토글, 아니면 모달 열기
                    photoDiv.onclick = () => {
                        if (isSelectMode && photo.url) {
                            toggleItemSelection(docId);
                        } else {
                            openPhotoModal(photo.url || photo.text, docId);
                        }
                    };

                    grid.appendChild(photoDiv);
                }
            });
        }

        // 카테고리별 이모지 매핑
        function getCategoryEmoji(category) {
            const emojiMap = {
                'body': '💪',
                'food': '🍽️',
                'exercise': '🏃‍♂️'
            };
            return emojiMap[category] || '📝';
        }
        
        // 🔥 새 기능: 날짜+요일+시간 상세 표시
        function formatDetailedTimestamp(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
            const weekday = weekdays[date.getDay()];
            
            const hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? '오후' : '오전';
            const displayHours = hours % 12 || 12; // 0시는 12시로 표시
            
            return `${year}년 ${month}월 ${day}일 (${weekday}) ${ampm} ${displayHours}:${minutes}`;
        }

        function changeAlbumTab(tab) {
            currentAlbumTab = tab;
            document.querySelectorAll('.album-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            loadAlbumTab();
        }

        // ==================== Phase 4: 배치 작업 함수들 ====================

        // 선택 모드 토글
        function toggleSelectMode() {
            isSelectMode = !isSelectMode;

            const selectModeBtn = document.getElementById('selectModeBtn');
            const selectActionBar = document.getElementById('selectActionBar');

            if (isSelectMode) {
                selectModeBtn.classList.add('active');
                selectModeBtn.textContent = '취소';
                selectActionBar.classList.remove('hidden');
            } else {
                selectModeBtn.classList.remove('active');
                selectModeBtn.textContent = '선택';
                selectActionBar.classList.add('hidden');
                selectedItems.clear();
            }

            // 앨범 재렌더링 (체크박스 표시/숨김)
            loadAlbumTab();
            updateSelectedCount();
        }

        // 개별 항목 선택/해제
        function toggleItemSelection(docId) {
            if (selectedItems.has(docId)) {
                selectedItems.delete(docId);
            } else {
                selectedItems.add(docId);
            }

            // UI 업데이트
            const photoDiv = document.querySelector(`.photo-item[data-doc-id="${docId}"]`);
            if (photoDiv) {
                const checkbox = photoDiv.querySelector('.select-checkbox');
                if (selectedItems.has(docId)) {
                    photoDiv.classList.add('selected');
                    if (checkbox) checkbox.classList.add('checked');
                } else {
                    photoDiv.classList.remove('selected');
                    if (checkbox) checkbox.classList.remove('checked');
                }
            }

            updateSelectedCount();
        }

        // 선택된 개수 업데이트
        function updateSelectedCount() {
            const count = selectedItems.size;
            document.getElementById('selectedCount').textContent = `${count}개 선택됨`;
        }

        // 선택된 항목 다운로드
        async function downloadSelectedItems() {
            if (selectedItems.size === 0) {
                alert('다운로드할 항목을 선택해주세요.');
                return;
            }

            try {
                // 선택된 항목들의 URL 가져오기
                const selectedUrls = allPhotoItems
                    .filter(item => selectedItems.has(item.docId))
                    .map(item => item.url);

                if (selectedUrls.length === 0) {
                    alert('다운로드할 이미지가 없습니다.');
                    return;
                }

                // 각 이미지 다운로드
                for (let i = 0; i < selectedUrls.length; i++) {
                    const url = selectedUrls[i];
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `diet-mate-photo-${i + 1}.jpg`;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // 브라우저가 다운로드를 처리할 시간 주기
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                alert(`${selectedUrls.length}개 이미지 다운로드를 시작했습니다.`);
                cancelSelectMode();
            } catch (error) {
                console.error('다운로드 오류:', error);
                alert('다운로드 중 오류가 발생했습니다.');
            }
        }

        // 선택된 항목 공유 (Web Share API)
        async function shareSelectedItems() {
            if (selectedItems.size === 0) {
                alert('공유할 항목을 선택해주세요.');
                return;
            }

            // Web Share API 지원 여부 확인
            if (!navigator.share) {
                alert('이 브라우저는 공유 기능을 지원하지 않습니다.');
                return;
            }

            try {
                // 선택된 항목들의 URL 가져오기
                const selectedUrls = allPhotoItems
                    .filter(item => selectedItems.has(item.docId))
                    .map(item => item.url);

                if (selectedUrls.length === 0) {
                    alert('공유할 이미지가 없습니다.');
                    return;
                }

                // URL들을 텍스트로 공유 (이미지 파일은 fetch 필요)
                const shareText = `Diet Mate 사진 ${selectedUrls.length}개\n\n${selectedUrls.join('\n')}`;

                await navigator.share({
                    title: 'Diet Mate 사진',
                    text: shareText
                });

                console.log('공유 성공');
                cancelSelectMode();
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('공유 오류:', error);
                    alert('공유 중 오류가 발생했습니다.');
                }
            }
        }

        // 선택 모드 취소
        function cancelSelectMode() {
            isSelectMode = false;
            selectedItems.clear();

            const selectModeBtn = document.getElementById('selectModeBtn');
            const selectActionBar = document.getElementById('selectActionBar');

            selectModeBtn.classList.remove('active');
            selectModeBtn.textContent = '선택';
            selectActionBar.classList.add('hidden');

            // 앨범 재렌더링
            loadAlbumTab();
            updateSelectedCount();
        }

        async function addPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // 파일 크기 검증 (10MB 제한)
                const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
                if (file.size > MAX_FILE_SIZE) {
                    showErrorToast('파일 크기는 10MB 이하여야 합니다.');
                    return;
                }

                const category = prompt('카테고리를 선택하세요:\n1. 눈바디 (body)\n2. 식단 (food)\n3. 운동 (exercise)');
                let categoryValue = 'body';
                if (category === '2' || category.includes('식단')) categoryValue = 'food';
                else if (category === '3' || category.includes('운동')) categoryValue = 'exercise';

                try {
                    const timestamp = Date.now();
                    const fileName = `${currentUser.uid}/${timestamp}_${file.name}`;
                    const storageRef = storage.ref().child(fileName);

                    // 파일 업로드
                    const snapshot = await storageRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();

                    // 식단인 경우 AI 영양 분석
                    let nutritionData = null;
                    if (categoryValue === 'food') {
                        try {
                            nutritionData = await analyzeNutritionFromImage(file, downloadURL);
                        } catch (error) {
                            console.error('영양 분석 실패:', error);
                            // 영양 분석 실패해도 사진은 저장
                        }
                    }

                    // Firestore에 메타데이터 저장
                    const photoData = {
                        url: downloadURL,
                        category: categoryValue,
                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        text: null
                    };

                    if (nutritionData) {
                        photoData.nutrition = nutritionData;
                    }

                    // 식단인 경우 스마트 병합 체크
                    if (categoryValue === 'food' && nutritionData) {
                        const recentMeal = await checkForRecentMeal(new Date());

                        if (recentMeal) {
                            // 최근 식사 발견 - 병합 Bottom Sheet 표시
                            showMergeBottomSheet(photoData, recentMeal);
                            return; // confirmMerge()나 createNewMeal()에서 처리
                        }
                    }

                    // 스마트 병합 대상이 아니거나 식단이 아닌 경우 바로 저장
                    await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                        .collection('photos').add(photoData);

                    // 앨범 새로고침
                    await loadAlbumTab();

                    // 식단인 경우 대시보드도 새로고침 및 AI 토스트 표시
                    if (categoryValue === 'food' && nutritionData) {
                        // ========== Phase 1: 실시간 영양 추적 ==========
                        addMeal('식단', nutritionData.foodName, nutritionData);
                        // ===============================================

                        await refreshDashboardNutrition();

                        // 플랜과 비교 (선택적)
                        let toastMessage = nutritionData.aiAdvice || '식사가 기록되었어요!';
                        try {
                            const comparisonResult = await comparePlanWithMeal(new Date(), nutritionData);
                            if (comparisonResult) {
                                toastMessage = comparisonResult;
                            }
                        } catch (error) {
                            console.error('플랜 비교 실패:', error);
                        }

                        showAIToast(toastMessage, 6000);
                    } else {
                        showSuccessToast('사진이 추가되었습니다!');
                    }

                } catch (error) {
                    console.error('사진 업로드 실패:', error);

                    // Firebase Storage 에러 처리
                    if (error.code === 'storage/unauthorized') {
                        showErrorToast('업로드 권한이 없습니다.');
                    } else if (error.code === 'storage/canceled') {
                        showErrorToast('업로드가 취소되었습니다.');
                    } else {
                        showErrorToast('사진 업로드에 실패했습니다. 다시 시도해주세요.');
                    }
                }
            };
            input.click();
        }

        // 성공 토스트 메시지 (임시)
        function showSuccessToast(message) {
            console.log('✓ ' + message);
            // Phase 2에서 실제 토스트 UI 구현 예정
        }

        // 에러 토스트 메시지 (임시)
        function showErrorToast(message) {
            console.error('✗ ' + message);
            alert(message); // Phase 2에서 토스트 UI로 교체 예정
        }

        async function openPhotoModal(url, photoId) {
            // Phase 4: 현재 사진 데이터 가져오기 (카테고리 정보 필요)
            const photoDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('photos').doc(photoId).get();
            const photoData = photoDoc.data();
            const currentCategory = photoData ? photoData.category : null;

            // Phase 4: 식단 카테고리인 경우 "이전 식사와 합치기" 버튼 추가
            let mergeButtonHtml = '';
            if (currentCategory === 'food') {
                mergeButtonHtml = `<button class="photo-modal-btn" style="background: #9c27b0; color: white;" onclick="showManualMergeList('${photoId}')">이전 식사와 합치기</button>`;
            }

            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.innerHTML = `
                <div class="photo-modal-header">
                    <h3>사진 보기</h3>
                    <button style="background: none; border: none; color: white; font-size: 2rem; cursor: pointer;" onclick="this.closest('.photo-modal').remove()">×</button>
                </div>
                <div class="photo-modal-content">
                    <img src="${url}" class="photo-modal-image">
                </div>
                <div class="photo-modal-actions">
                    <button class="photo-modal-btn" style="background: #667eea; color: white;" onclick="downloadPhoto('${url}')">다운로드</button>
                    <button class="photo-modal-btn" style="background: #4caf50; color: white;" onclick="sharePhoto('${url}')">공유</button>
                    ${mergeButtonHtml}
                    <button class="photo-modal-btn" style="background: #ff9800; color: white;" onclick="showCategoryChangeModal('${photoId}', '${currentCategory}')">카테고리 변경</button>
                    <button class="photo-modal-btn" style="background: #f44336; color: white;" onclick="deletePhoto('${photoId}')">삭제</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function downloadPhoto(url) {
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diet_mate_photo.jpg';
            a.click();
        }

        async function sharePhoto(url) {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Diet Mate 사진',
                        text: '나의 다이어트 변화',
                        url: url
                    });
                } catch (error) {
                    console.error('공유 실패:', error);
                }
            } else {
                alert('이 브라우저는 공유 기능을 지원하지 않습니다.');
            }
        }

        async function deletePhoto(photoId) {
            if (!confirm('이 사진을 삭제하시겠습니까?')) return;

            try {
                // 1. 사진 데이터 가져오기
                const photoDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(photoId).get();
                const photoData = photoDoc.data();

                // 2. 사진 삭제
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(photoId).delete();

                // 3. 식단 사진이었고 영양 정보가 있다면 dailyLogs에서도 제거
                if (photoData && photoData.category === 'food' && photoData.nutrition) {
                    const uploadDate = photoData.uploadedAt.toDate();
                    const dateStr = `${uploadDate.getFullYear()}-${String(uploadDate.getMonth() + 1).padStart(2, '0')}-${String(uploadDate.getDate()).padStart(2, '0')}`;
                    
                    const dailyLogRef = db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(currentUser.uid)
                        .collection('dailyLogs').doc(dateStr);
                    
                    const dailyLogDoc = await dailyLogRef.get();
                    if (dailyLogDoc.exists) {
                        const logData = dailyLogDoc.data();
                        if (logData.nutrition && logData.nutrition.meals) {
                            // 해당 식사 제거
                            const updatedMeals = logData.nutrition.meals.filter(meal => {
                                // uploadedAt 시간으로 식별 (밀리초 단위 비교)
                                const mealTime = meal.timestamp?.seconds * 1000 || 0;
                                const photoTime = photoData.uploadedAt.seconds * 1000;
                                return Math.abs(mealTime - photoTime) > 1000; // 1초 이상 차이나면 다른 식사
                            });

                            // 총 칼로리 및 영양소 재계산
                            let totalCal = 0, totalCarbs = 0, totalProtein = 0, totalFat = 0;
                            updatedMeals.forEach(meal => {
                                totalCal += meal.calories || 0;
                                totalCarbs += meal.carbs || 0;
                                totalProtein += meal.protein || 0;
                                totalFat += meal.fat || 0;
                            });

                            // dailyLogs 업데이트
                            await dailyLogRef.update({
                                'nutrition.calories': totalCal,
                                'nutrition.carbs': totalCarbs,
                                'nutrition.protein': totalProtein,
                                'nutrition.fat': totalFat,
                                'nutrition.meals': updatedMeals
                            });

                            console.log(`✅ dailyLogs 동기화 완료: ${dateStr}, 남은 식사: ${updatedMeals.length}개`);
                        }
                    }
                }

                document.querySelector('.photo-modal').remove();
                await loadAlbumTab();
                
                // 홈 탭 새로고침 (영양 대시보드 업데이트)
                if (photoData && photoData.category === 'food') {
                    await loadHomeTab();
                }
                
                alert('삭제되었습니다.');
            } catch (error) {
                console.error('사진 삭제 오류:', error);
                alert('삭제 중 오류가 발생했습니다.');
            }
        }

        // ==================== Phase 4: 카테고리 변경 함수들 ====================

        // 카테고리 변경 모달 표시
        function showCategoryChangeModal(photoId, currentCategory) {
            changingPhotoId = photoId;
            changingPhotoCurrentCategory = currentCategory;

            const overlay = document.getElementById('categoryChangeOverlay');
            const options = document.querySelectorAll('.category-option');

            // 현재 카테고리 강조
            options.forEach(option => {
                const category = option.dataset.category;
                if (category === currentCategory) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });

            // 모달 표시
            overlay.classList.remove('hidden');
        }

        // 카테고리 변경 확인
        async function changeCategoryConfirm(newCategory) {
            if (!changingPhotoId) {
                alert('오류: 변경할 항목을 찾을 수 없습니다.');
                closeCategoryModal();
                return;
            }

            // 같은 카테고리로 변경하려는 경우
            if (newCategory === changingPhotoCurrentCategory) {
                alert('이미 해당 카테고리입니다.');
                return;
            }

            try {
                // Firestore에서 현재 사진 데이터 가져오기
                const photoDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(changingPhotoId).get();
                const photoData = photoDoc.data();

                // 식단 → 다른 카테고리: 영양 데이터 손실 경고
                if (changingPhotoCurrentCategory === 'food' && photoData.nutrition) {
                    if (!confirm('식단 카테고리에서 이동하면 영양 정보가 대시보드에서 제외됩니다. 계속하시겠습니까?')) {
                        return;
                    }
                }

                // 다른 카테고리 → 식단: AI 재분석 필요 여부 확인
                if (newCategory === 'food' && changingPhotoCurrentCategory !== 'food') {
                    if (photoData.url && !photoData.nutrition) {
                        // 이미지가 있지만 영양 정보가 없는 경우 - AI 재분석 제안
                        const reanalyze = confirm('식단 카테고리로 이동합니다. AI 영양 분석을 실행하시겠습니까?');
                        if (reanalyze) {
                            // AI 영양 분석 실행 (기존 analyzeNutritionFromImage 사용)
                            alert('영양 분석은 앨범에서 사진을 다시 업로드해주세요.');
                        }
                    }
                }

                // 카테고리 변경 실행
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(changingPhotoId).update({
                        category: newCategory
                    });

                alert('카테고리가 변경되었습니다.');

                // 모달들 닫기
                closeCategoryModal();
                const photoModal = document.querySelector('.photo-modal');
                if (photoModal) photoModal.remove();

                // 앨범 새로고침
                await loadAlbumTab();

                // 대시보드 새로고침 (영양 정보 변경 시)
                if (changingPhotoCurrentCategory === 'food' || newCategory === 'food') {
                    if (typeof loadNutritionDashboard === 'function') {
                        await loadNutritionDashboard();
                    }
                }
            } catch (error) {
                console.error('카테고리 변경 오류:', error);
                alert('카테고리 변경 중 오류가 발생했습니다.');
            }
        }

        // 카테고리 변경 모달 닫기
        function closeCategoryModal() {
            const overlay = document.getElementById('categoryChangeOverlay');
            overlay.classList.add('hidden');
            changingPhotoId = null;
            changingPhotoCurrentCategory = null;
        }

        // ==================== Phase 4: 수동 병합 함수들 ====================

        // 수동 병합 모달 표시 및 식사 목록 로드
        async function showManualMergeList(currentPhotoId) {
            mergingSourceId = currentPhotoId;

            const overlay = document.getElementById('manualMergeOverlay');
            overlay.classList.remove('hidden');

            // 식사 목록 로드
            await loadRecentMeals(30, currentPhotoId);
        }

        // 최근 식사 목록 로드 (최근 30일)
        async function loadRecentMeals(limit = 30, excludeId = null) {
            const mealListDiv = document.getElementById('mealList');
            mealListDiv.innerHTML = '<div class="meal-list-loading">불러오는 중...</div>';

            try {
                // 30일 전 날짜 계산
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                // Firestore에서 최근 30일 식단 조회
                const mealsSnapshot = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('category', '==', 'food')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
                    .orderBy('uploadedAt', 'desc')
                    .limit(50) // 최대 50개까지 로드
                    .get();

                if (mealsSnapshot.empty) {
                    mealListDiv.innerHTML = '<div class="meal-list-empty">최근 30일 내 식사 기록이 없습니다.</div>';
                    return;
                }

                // 식사 목록 렌더링
                mealListDiv.innerHTML = '';
                let count = 0;

                mealsSnapshot.forEach(doc => {
                    // 현재 항목은 제외
                    if (doc.id === excludeId) return;

                    const meal = doc.data();
                    const mealId = doc.id;

                    // 영양 정보가 없으면 스킵
                    if (!meal.nutrition) return;

                    // 날짜 포맷팅
                    const uploadDate = meal.uploadedAt.toDate();
                    const dateStr = uploadDate.toLocaleDateString('ko-KR');
                    const timeStr = uploadDate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                    const mealItem = document.createElement('div');
                    mealItem.className = 'meal-list-item';
                    mealItem.onclick = () => confirmManualMerge(mergingSourceId, mealId);

                    mealItem.innerHTML = `
                        <div class="meal-item-header">
                            <span class="meal-item-date">${dateStr}</span>
                            <span class="meal-item-time">${timeStr}</span>
                        </div>
                        <div class="meal-item-name">${meal.nutrition.foodName || '식사'}</div>
                        <div class="meal-item-calories">${Math.round(meal.nutrition.calories)}kcal</div>
                    `;

                    mealListDiv.appendChild(mealItem);
                    count++;

                    if (count >= limit) return;
                });

                // 항목이 하나도 렌더링되지 않은 경우
                if (count === 0) {
                    mealListDiv.innerHTML = '<div class="meal-list-empty">병합 가능한 식사가 없습니다.<br/>(영양 정보가 있는 식사만 병합 가능합니다)</div>';
                }
            } catch (error) {
                console.error('식사 목록 로드 오류:', error);
                mealListDiv.innerHTML = '<div class="meal-list-empty">식사 목록을 불러오는 중 오류가 발생했습니다.</div>';
            }
        }

        // 수동 병합 확인 및 실행
        async function confirmManualMerge(sourceId, targetId) {
            if (!sourceId || !targetId) {
                alert('오류: 병합할 항목을 찾을 수 없습니다.');
                return;
            }

            // 확인 메시지
            if (!confirm('선택한 식사와 병합하시겠습니까?\n\n현재 식사의 영양 정보가 선택한 식사에 합산되고, 현재 식사는 삭제됩니다.')) {
                return;
            }

            try {
                // 두 식사 데이터 가져오기
                const sourceDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(sourceId).get();
                const targetDoc = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(targetId).get();

                const sourceData = sourceDoc.data();
                const targetData = targetDoc.data();

                // 영양 정보가 없으면 병합 불가
                if (!sourceData.nutrition || !targetData.nutrition) {
                    alert('영양 정보가 없는 항목은 병합할 수 없습니다.');
                    return;
                }

                // 영양 정보 합산
                const mergedNutrition = {
                    calories: (targetData.nutrition.calories || 0) + (sourceData.nutrition.calories || 0),
                    carbs: (targetData.nutrition.carbs || 0) + (sourceData.nutrition.carbs || 0),
                    protein: (targetData.nutrition.protein || 0) + (sourceData.nutrition.protein || 0),
                    fat: (targetData.nutrition.fat || 0) + (sourceData.nutrition.fat || 0),
                    foodName: `${targetData.nutrition.foodName} + ${sourceData.nutrition.foodName}`,
                    analyzedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    aiAdvice: `병합된 식사 (${Math.round((targetData.nutrition.calories || 0) + (sourceData.nutrition.calories || 0))}kcal)`
                };

                // 텍스트도 연결
                let mergedText = targetData.text || '';
                if (sourceData.text) {
                    mergedText = mergedText ? `${mergedText} + ${sourceData.text}` : sourceData.text;
                }

                // target 업데이트
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(targetId).update({
                        nutrition: mergedNutrition,
                        text: mergedText || null
                    });

                // source 삭제
                await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('photos').doc(sourceId).delete();

                alert('식사가 성공적으로 병합되었습니다.');

                // 모달들 닫기
                closeManualMergeModal();
                const photoModal = document.querySelector('.photo-modal');
                if (photoModal) photoModal.remove();

                // 앨범 새로고침
                await loadAlbumTab();

                // 대시보드 새로고침
                if (typeof loadNutritionDashboard === 'function') {
                    await loadNutritionDashboard();
                }
            } catch (error) {
                console.error('병합 오류:', error);
                alert('식사 병합 중 오류가 발생했습니다.');
            }
        }

        // 수동 병합 모달 닫기
        function closeManualMergeModal() {
            const overlay = document.getElementById('manualMergeOverlay');
            overlay.classList.add('hidden');
            mergingSourceId = null;
        }

        // ==================== 캘린더 탭 ====================
        async function loadCalendar() {
            await loadWeeklySummary();
            renderCalendar();
        }

        // 주간 요약 로드
        async function loadWeeklySummary() {
            const container = document.getElementById('weeklySummaryContent');
            container.innerHTML = '<div class="summary-loading">로딩 중...</div>';

            try {
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 86400000);

                // 주간 체중 데이터
                const weekWeights = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(weekAgo))
                    .orderBy('date', 'desc')
                    .get();

                // 주간 dailyLogs 데이터
                const weekStart = `${weekAgo.getFullYear()}-${String(weekAgo.getMonth() + 1).padStart(2, '0')}-${String(weekAgo.getDate()).padStart(2, '0')}`;
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                
                const weekLogs = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs')
                    .where(firebase.firestore.FieldPath.documentId(), '>=', weekStart)
                    .where(firebase.firestore.FieldPath.documentId(), '<=', todayStr)
                    .get();

                // 계산
                let avgWeight = 0;
                let weightChange = 0;
                if (!weekWeights.empty) {
                    const weights = [];
                    weekWeights.forEach(doc => weights.push(parseFloat(doc.data().weight)));
                    avgWeight = (weights.reduce((a, b) => a + b, 0) / weights.length).toFixed(1);
                    if (weights.length >= 2) {
                        weightChange = (weights[0] - weights[weights.length - 1]).toFixed(1);
                    }
                }

                let totalCal = 0, calCount = 0;
                let totalWater = 0, waterDays = 0;
                let totalFastingHours = 0, fastingDays = 0;

                weekLogs.forEach(doc => {
                    const data = doc.data();
                    if (data.nutrition && data.nutrition.calories) {
                        totalCal += data.nutrition.calories;
                        calCount++;
                    }
                    if (data.water && data.water > 0) {
                        totalWater += data.water;
                        waterDays++;
                    }
                    if (data.fasting && data.fasting.duration) {
                        totalFastingHours += data.fasting.duration / 60;
                        fastingDays++;
                    }
                });

                const avgCal = calCount > 0 ? Math.round(totalCal / calCount) : 0;
                const avgWater = waterDays > 0 ? (totalWater / waterDays / 1000).toFixed(1) : 0;
                const avgFasting = fastingDays > 0 ? (totalFastingHours / fastingDays / 60).toFixed(1) : 0;

                // UI 렌더링
                container.innerHTML = `
                    <div class="summary-stat">
                        <div class="summary-stat-label">평균 체중</div>
                        <div class="summary-stat-value">${avgWeight}kg</div>
                        <div class="summary-stat-change">${weightChange > 0 ? '+' : ''}${weightChange}kg</div>
                    </div>
                    <div class="summary-stat green">
                        <div class="summary-stat-label">평균 칼로리</div>
                        <div class="summary-stat-value">${avgCal}kcal</div>
                        <div class="summary-stat-change">${calCount}일 기록</div>
                    </div>
                    <div class="summary-stat blue">
                        <div class="summary-stat-label">평균 물 섭취</div>
                        <div class="summary-stat-value">${avgWater}L</div>
                        <div class="summary-stat-change">${waterDays}/7일 달성</div>
                    </div>
                    <div class="summary-stat orange">
                        <div class="summary-stat-label">평균 단식 시간</div>
                        <div class="summary-stat-value">${avgFasting}h</div>
                        <div class="summary-stat-change">${fastingDays}/7일 성공</div>
                    </div>
                `;

                // AI 코칭 메시지 업데이트
                updateAICoachingMessage({avgWeight, weightChange, avgCal, avgWater, avgFasting, calCount, waterDays, fastingDays});

            } catch (error) {
                console.error('주간 요약 로드 오류:', error);
                container.innerHTML = '<div class="summary-loading">데이터를 불러올 수 없습니다.</div>';
            }
        }

        // AI 코칭 메시지 업데이트
        function updateAICoachingMessage(stats) {
            const messageEl = document.getElementById('aiCoachMessage');
            
            // TODO: 실제 AI API 연동 시 여기서 호출
            // const aiMessage = await fetch('/api/ai-coaching', { method: 'POST', body: JSON.stringify(stats) });
            
            // 임시 로직 (AI API 구현 전)
            let message = "";
            
            if (stats.weightChange < -0.5) {
                message = `이번 주 ${Math.abs(stats.weightChange)}kg 감량! 정말 잘하고 계세요! 🎉`;
            } else if (stats.weightChange > 0.5) {
                message = `이번 주 체중이 조금 늘었지만, 포기하지 마세요. 장기적인 목표에 집중하세요! 💪`;
            } else {
                message = `체중이 안정적이네요. 꾸준히 유지하면서 건강한 습관을 만들어가세요! ✨`;
            }

            if (stats.calCount >= 6) {
                message += ` 칼로리 기록을 ${stats.calCount}일이나 하셨어요!`;
            }

            if (stats.fastingDays >= 5) {
                message += ` 단식도 ${stats.fastingDays}일 성공! 👏`;
            }

            messageEl.textContent = message || "주간 요약을 확인하고 계속 힘내세요! 💪";
        }

        // 주간 요약 토글
        function toggleWeeklySummary() {
            const content = document.getElementById('weeklySummaryContent');
            const btn = event.target;
            
            if (content.style.display === 'none') {
                content.style.display = 'grid';
                btn.textContent = '접기';
            } else {
                content.style.display = 'none';
                btn.textContent = '펼치기';
            }
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            document.getElementById('calendarMonth').textContent = `${year}년 ${month + 1}월`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            // 빈 칸
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                calendarDays.appendChild(emptyDay);
            }

            // 날짜들
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                const currentDate = new Date(year, month, day);
                // 타임존 문제 해결: 로컬 날짜를 직접 문자열로 변환
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // 날짜 번호
                const dateNumber = document.createElement('div');
                dateNumber.className = 'calendar-day-number';
                dateNumber.textContent = day;
                dayDiv.appendChild(dateNumber);

                // 미리보기 정보 컨테이너
                const previewDiv = document.createElement('div');
                previewDiv.className = 'calendar-day-preview';
                dayDiv.appendChild(previewDiv);

                if (currentDate.toDateString() === today.toDateString()) {
                    dayDiv.classList.add('today');
                }

                if (currentDate > today) {
                    dayDiv.classList.add('future');
                } else {
                    dayDiv.onclick = () => showDayReport(dateStr);
                    // 미리보기 데이터 로드
                    loadDayPreview(dateStr, previewDiv);
                }

                calendarDays.appendChild(dayDiv);
            }
        }

        // 날짜별 미리보기 정보 로드
        async function loadDayPreview(dateStr, container) {
            try {
                const date = new Date(dateStr);
                const nextDay = new Date(date.getTime() + 86400000);

                // 체중 조회
                const weights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(date))
                    .where('date', '<', firebase.firestore.Timestamp.fromDate(nextDay))
                    .limit(1)
                    .get();

                // dailyLogs 조회 (칼로리, 물)
                const dailyLog = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').doc(dateStr)
                    .get();

                let previewHTML = '';

                // 체중
                if (!weights.empty) {
                    const weight = parseFloat(weights.docs[0].data().weight).toFixed(1);
                    previewHTML += `<div class="preview-item">⚖️ ${weight}kg</div>`;
                    container.parentElement.classList.add('has-data');
                }

                // 칼로리
                if (dailyLog.exists && dailyLog.data().nutrition) {
                    const calories = Math.round(dailyLog.data().nutrition.calories || 0);
                    if (calories > 0) {
                        previewHTML += `<div class="preview-item">🍽️ ${calories}kcal</div>`;
                    }
                }

                // 물
                if (dailyLog.exists && dailyLog.data().water) {
                    const waterLiters = (dailyLog.data().water / 1000).toFixed(1);
                    previewHTML += `<div class="preview-item">💧 ${waterLiters}L</div>`;
                }

                // 목표 달성 (dailyPlans에서)
                const dailyPlan = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyPlans').doc(dateStr)
                    .get();

                if (dailyPlan.exists && dailyPlan.data().goals) {
                    const goals = dailyPlan.data().goals;
                    const completed = Object.values(goals).filter(g => g.completed).length;
                    const total = Object.keys(goals).length;
                    const percentage = Math.round((completed / total) * 100);
                    
                    if (percentage >= 70) {
                        previewHTML += `<div class="preview-item">✅</div>`;
                    } else if (percentage >= 50) {
                        previewHTML += `<div class="preview-item">⚠️</div>`;
                    }
                }

                container.innerHTML = previewHTML;
            } catch (error) {
                console.error('미리보기 로드 오류:', error);
            }
        }

        async function checkDayData(dateStr) {
            const weights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs')
                .where('date', '>=', firebase.firestore.Timestamp.fromDate(new Date(dateStr)))
                .where('date', '<', firebase.firestore.Timestamp.fromDate(new Date(new Date(dateStr).getTime() + 86400000)))
                .limit(1)
                .get();

            return !weights.empty;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        // 새로운 showDayReport 함수 (v3.0 - 완전 종합 리포트)
        async function showDayReport(dateStr) {
            const date = new Date(dateStr);
            const yesterday = new Date(date);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            // ========== 오늘 데이터 수집 ==========
            const weights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs')
                .where('date', '>=', firebase.firestore.Timestamp.fromDate(date))
                .where('date', '<', firebase.firestore.Timestamp.fromDate(new Date(date.getTime() + 86400000)))
                .get();

            // 어제 체중
            const yesterdayWeights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs')
                .where('date', '>=', firebase.firestore.Timestamp.fromDate(yesterday))
                .where('date', '<', firebase.firestore.Timestamp.fromDate(date))
                .get();

            // dailyLogs (오늘)
            const dailyLog = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('dailyLogs').doc(dateStr)
                .get();
            const logData = dailyLog.exists ? dailyLog.data() : null;

            // dailyLogs (어제)
            const yesterdayLog = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('dailyLogs').doc(yesterdayStr)
                .get();
            const yesterdayLogData = yesterdayLog.exists ? yesterdayLog.data() : null;

            // 단식 기록
            const fastingRecords = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('fastingRecords')
                .where('date', '==', dateStr)
                .get();

            // 사진/앨범
            const photos = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('photos')
                .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(date))
                .where('uploadedAt', '<', firebase.firestore.Timestamp.fromDate(new Date(date.getTime() + 86400000)))
                .get();

            // 일기
            const dailyPlan = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('dailyPlans').doc(dateStr)
                .get();
            const diaryData = dailyPlan.exists ? dailyPlan.data() : null;

            // 목표 (Firestore dailyPlans에서 불러오기)
            let goals = null;
            if (diaryData && diaryData.goals) {
                goals = diaryData.goals;
            } else {
                // localStorage fallback (오늘 날짜만)
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                if (dateStr === todayStr) {
                    const goalsData = localStorage.getItem(`diet_goals_${dateStr}`);
                    goals = goalsData ? JSON.parse(goalsData) : null;
                }
            }

            // ========== 모달 생성 ==========
            const modal = document.createElement('div');
            modal.className = 'day-report-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px; overflow-y: auto;';

            let content = `
                <div class="day-report-content" style="background: white; border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative;">
                    <button onclick="this.closest('.day-report-modal').remove()" style="position: absolute; top: 20px; right: 20px; font-size: 28px; border: none; background: none; cursor: pointer; color: #999;">×</button>
                    
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="font-size: 1.5rem; color: #333; margin: 0;">${date.getMonth() + 1}월 ${date.getDate()}일</h2>
                        <p style="color: #999; font-size: 0.9rem; margin-top: 5px;">${['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'][date.getDay()]}</p>
                    </div>
            `;

            // ========== 1. 체중 ==========
            if (!weights.empty) {
                const todayWeight = parseFloat(weights.docs[0].data().weight).toFixed(1);
                const yesterdayWeight = yesterdayWeights.empty ? null : parseFloat(yesterdayWeights.docs[0].data().weight).toFixed(1);
                const weightDiff = yesterdayWeight ? (parseFloat(todayWeight) - parseFloat(yesterdayWeight)).toFixed(1) : null;

                content += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 20px; margin-bottom: 20px; color: white;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 1.5rem;">⚖️</span>
                            <h3 style="margin: 0; font-size: 1.1rem;">체중</h3>
                        </div>
                        <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 5px;">${todayWeight}kg</div>
                        ${weightDiff ? `
                            <div style="font-size: 1rem; opacity: 0.9;">
                                어제 대비 ${weightDiff > 0 ? '+' : ''}${weightDiff}kg 
                                <span style="font-size: 1.2rem;">${weightDiff > 0 ? '📈' : weightDiff < 0 ? '📉' : '➡️'}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // ========== 2. 식사 & 영양 (항상 표시) ==========
            const todayCal = (logData && logData.nutrition) ? Math.round(logData.nutrition.calories || 0) : 0;
            const yesterdayCal = yesterdayLogData && yesterdayLogData.nutrition ? Math.round(yesterdayLogData.nutrition.calories) : null;
            const calDiff = yesterdayCal !== null ? (todayCal - yesterdayCal) : null;
            
            // 목표 칼로리 (localStorage 또는 프로필 기반)
            const targetCal = parseInt(localStorage.getItem('goal_calories_target')) || 1620;
            const calVsTarget = todayCal - targetCal;

            // 주간 평균 (최근 7일)
            const weekStart = new Date(date);
            weekStart.setDate(weekStart.getDate() - 6);
            const weekLogs = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('dailyLogs')
                .where(firebase.firestore.FieldPath.documentId(), '>=', `${weekStart.getFullYear()}-${String(weekStart.getMonth() + 1).padStart(2, '0')}-${String(weekStart.getDate()).padStart(2, '0')}`)
                .where(firebase.firestore.FieldPath.documentId(), '<=', dateStr)
                .get();
            
            let weekTotalCal = 0;
            let weekDays = 0;
            weekLogs.forEach(doc => {
                const data = doc.data();
                if (data.nutrition && data.nutrition.calories) {
                    weekTotalCal += data.nutrition.calories;
                    weekDays++;
                }
            });
            const weekAvgCal = weekDays > 0 ? Math.round(weekTotalCal / weekDays) : null;
            const weekDiff = weekAvgCal !== null ? (todayCal - weekAvgCal) : null;

            // 월간 평균 (이번 달 1일부터 오늘까지)
            const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
            const monthStartStr = `${monthStart.getFullYear()}-${String(monthStart.getMonth() + 1).padStart(2, '0')}-01`;
            const monthLogs = await db.collection('artifacts').doc('diet-mate-v2')
                .collection('users').doc(currentUser.uid)
                .collection('dailyLogs')
                .where(firebase.firestore.FieldPath.documentId(), '>=', monthStartStr)
                .where(firebase.firestore.FieldPath.documentId(), '<=', dateStr)
                .get();
            
            let monthTotalCal = 0;
            let monthDays = 0;
            monthLogs.forEach(doc => {
                const data = doc.data();
                if (data.nutrition && data.nutrition.calories) {
                    monthTotalCal += data.nutrition.calories;
                    monthDays++;
                }
            });
            const monthAvgCal = monthDays > 0 ? Math.round(monthTotalCal / monthDays) : null;
            const monthDiff = monthAvgCal !== null ? (todayCal - monthAvgCal) : null;

            const meals = (logData && logData.nutrition && logData.nutrition.meals) ? logData.nutrition.meals : [];
            const carbs = (logData && logData.nutrition) ? Math.round(logData.nutrition.carbs || 0) : 0;
            const protein = (logData && logData.nutrition) ? Math.round(logData.nutrition.protein || 0) : 0;
            const fat = (logData && logData.nutrition) ? Math.round(logData.nutrition.fat || 0) : 0;

            content += `
                <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <span style="font-size: 1.5rem;">🍽️</span>
                        <h3 style="margin: 0; font-size: 1.1rem; color: #333;">식사 & 영양</h3>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 1.8rem; font-weight: bold; color: ${todayCal > 0 ? '#ff6b6b' : '#999'};">${todayCal} kcal</div>
                            <div style="font-size: 0.9rem; color: #999; margin-top: 5px;">
                                목표 ${targetCal}kcal 대비 ${calVsTarget > 0 ? '+' : ''}${calVsTarget}kcal ${calVsTarget > 0 ? '초과 ⚠️' : calVsTarget < 0 ? '남음 ✅' : ''}
                            </div>
                            ${calDiff !== null ? `
                                <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                    어제: ${calDiff > 0 ? '+' : ''}${calDiff}kcal
                                </div>
                            ` : ''}
                            ${weekDiff !== null ? `
                                <div style="font-size: 0.85rem; color: #666; margin-top: 2px;">
                                    주간 평균: ${weekDiff > 0 ? '+' : ''}${weekDiff}kcal
                                </div>
                            ` : ''}
                            ${monthDiff !== null ? `
                                <div style="font-size: 0.85rem; color: #666; margin-top: 2px;">
                                    월간 평균: ${monthDiff > 0 ? '+' : ''}${monthDiff}kcal
                                </div>
                            ` : ''}
                        </div>
                        <div style="text-align: right; font-size: 0.85rem; color: #666;">
                            탄수화물: ${carbs}g<br>
                            단백질: ${protein}g<br>
                            지방: ${fat}g
                        </div>
                    </div>
                    ${meals.length > 0 ? `
                        <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                            <strong style="font-size: 0.95rem; color: #555;">식사 내역</strong>
                            ${meals.map(m => `
                                <div style="padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem;">
                                    <span style="color: #333;">• ${m.foodName}</span>
                                    <span style="float: right; color: #ff6b6b; font-weight: 600;">${Math.round(m.calories)}kcal</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="text-align: center; color: #999; padding: 20px 0; font-size: 0.9rem;">
                            식사 기록이 없습니다
                        </div>
                    `}
                </div>
            `;

            // ========== 3. 물 섭취 (항상 표시) ==========
            const waterMl = (logData && logData.water) ? logData.water : 0;
            const waterLiters = (waterMl / 1000).toFixed(1);
            const goalLiters = parseFloat(localStorage.getItem('goal_water_target') || '2');
            const waterPercent = Math.round((waterMl / (goalLiters * 1000)) * 100);

            content += `
                <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 15px; padding: 20px; margin-bottom: 20px; color: white;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 1.5rem;">💧</span>
                        <h3 style="margin: 0; font-size: 1.1rem;">물 섭취</h3>
                    </div>
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${waterLiters}L / ${goalLiters}L</div>
                    <div style="font-size: 1rem; opacity: 0.9;">
                        목표 달성률: ${waterPercent}% ${waterPercent >= 100 ? '🎉' : waterPercent >= 75 ? '💪' : waterPercent > 0 ? '😅' : ''}
                    </div>
                </div>
            `;

            // ========== 4. 단식 기록 ==========
            if (!fastingRecords.empty) {
                let totalFastingMinutes = 0;
                fastingRecords.forEach(doc => {
                    const data = doc.data();
                    totalFastingMinutes += data.duration / (1000 * 60);
                });
                const fastingHours = Math.floor(totalFastingMinutes / 60);
                const fastingMins = Math.round(totalFastingMinutes % 60);

                content += `
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 15px; padding: 20px; margin-bottom: 20px; color: white;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 1.5rem;">⏱️</span>
                            <h3 style="margin: 0; font-size: 1.1rem;">간헐적 단식</h3>
                        </div>
                        <div style="font-size: 2rem; font-weight: bold;">${fastingHours}시간 ${fastingMins}분</div>
                        <div style="font-size: 0.95rem; opacity: 0.9; margin-top: 5px;">
                            ${fastingHours >= 16 ? '✨ 목표 달성!' : fastingHours >= 12 ? '💪 거의 다 왔어요!' : '🔥 좋은 시작!'}
                        </div>
                    </div>
                `;
            }

            // ========== 5. 운동 ==========
            if (logData && logData.exercises && logData.exercises.length > 0) {
                const totalMinutes = logData.exercises.reduce((sum, ex) => sum + (ex.duration || 0), 0);

                content += `
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 1.5rem;">🏃</span>
                            <h3 style="margin: 0; font-size: 1.1rem; color: #333;">운동</h3>
                        </div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #4caf50; margin-bottom: 10px;">총 ${totalMinutes}분</div>
                        ${logData.exercises.map(ex => `
                            <div style="padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem;">
                                <span style="color: #333;">• ${ex.name}</span>
                                <span style="float: right; color: #4caf50; font-weight: 600;">${ex.duration}분</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // ========== 6. 오늘의 목표 ==========
            if (goals) {
                const totalGoals = 6 + (goals.customGoals || []).length;
                let completed = 0;
                if (goals['goal-water']) completed++;
                if (goals['goal-fasting']) completed++;
                if (goals['goal-dinner']) completed++;
                if (goals['goal-exercise']) completed++;
                if (goals['goal-calories']) completed++;
                if (goals['goal-weight']) completed++;
                (goals.customGoals || []).forEach(g => { if (g.completed) completed++; });

                const achievementRate = Math.round((completed / totalGoals) * 100);

                content += `
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 1.5rem;">🎯</span>
                            <h3 style="margin: 0; font-size: 1.1rem; color: #333;">오늘의 목표</h3>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 1.3rem; font-weight: bold; color: #667eea;">${completed} / ${totalGoals} 완료 (${achievementRate}%)</div>
                            <div style="height: 8px; background: #e0e0e0; border-radius: 10px; margin-top: 10px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: ${achievementRate}%;"></div>
                            </div>
                        </div>
                        ${achievementRate === 100 ? '<div style="text-align: center; font-size: 1rem; color: #4caf50;">🎉 모든 목표 달성! 대단해요!</div>' : ''}
                    </div>
                `;
            }

            // ========== 7. 오늘의 다짐 (항상 표시) ==========
            const diaryContent = (diaryData && diaryData.content) ? diaryData.content : null;
            
            content += `
                <div style="background: #fff8e1; border-left: 4px solid #ffd54f; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 1.5rem;">📝</span>
                        <h3 style="margin: 0; font-size: 1.1rem; color: #333;">오늘의 다짐</h3>
                    </div>
                    ${diaryContent ? `
                        <p style="white-space: pre-wrap; line-height: 1.7; color: #555; margin: 0; font-size: 0.95rem;">${diaryContent}</p>
                    ` : `
                        <p style="color: #999; margin: 0; font-size: 0.9rem; text-align: center;">작성된 다짐이 없습니다</p>
                    `}
                </div>
            `;

            // ========== 8. 앨범 (사진) ==========
            if (!photos.empty) {
                const bodyPhotos = [];
                const foodPhotos = [];
                const exercisePhotos = [];

                photos.forEach(doc => {
                    const photo = doc.data();
                    if (photo.category === 'body') bodyPhotos.push(photo);
                    else if (photo.category === 'food') foodPhotos.push(photo);
                    else if (photo.category === 'exercise') exercisePhotos.push(photo);
                });

                content += `
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 1.5rem;">📸</span>
                            <h3 style="margin: 0; font-size: 1.1rem; color: #333;">앨범</h3>
                        </div>
                        ${bodyPhotos.length > 0 ? `
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">👤 눈바디 (${bodyPhotos.length}장)</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${bodyPhotos.map(p => `<img src="${p.url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px; cursor: pointer;" onclick="window.open('${p.url}', '_blank')">`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${foodPhotos.length > 0 ? `
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">🍽️ 식단 (${foodPhotos.length}장)</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${foodPhotos.map(p => `<img src="${p.url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px; cursor: pointer;" onclick="window.open('${p.url}', '_blank')">`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        ${exercisePhotos.length > 0 ? `
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">🏃 운동 (${exercisePhotos.length}장)</div>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    ${exercisePhotos.map(p => `<img src="${p.url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 10px; cursor: pointer;" onclick="window.open('${p.url}', '_blank')">`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // ========== 데이터 없음 표시 ==========
            const hasAnyData = !weights.empty || (logData && (logData.nutrition || logData.water || (logData.exercises && logData.exercises.length > 0))) || !fastingRecords.empty || (diaryData && diaryData.content) || !photos.empty || goals;

            if (!hasAnyData) {
                content += `
                    <div style="text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">📭</div>
                        <div style="font-size: 1.1rem;">이 날의 기록이 없습니다</div>
                        <div style="font-size: 0.9rem; margin-top: 10px; color: #bbb;">기록을 시작해보세요!</div>
                    </div>
                `;
            }

            content += `
                    <button onclick="this.closest('.day-report-modal').remove()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;">
                        닫기
                    </button>
                </div>
            `;

            modal.innerHTML = content;
            document.body.appendChild(modal);
        }

        // 특정 날짜의 데이터 동기화 (photos 기준으로 dailyLogs 재구성)
        async function syncDailyData(dateStr) {
            const modal = document.querySelector('.day-report-modal');
            const syncBtn = Array.from(modal.querySelectorAll('button')).find(btn => btn.textContent.includes('동기화'));
            if (!syncBtn) return;
            
            const originalText = syncBtn.innerHTML;
            syncBtn.innerHTML = '🔄 동기화 중...';
            syncBtn.disabled = true;

            try {
                const date = new Date(dateStr);
                const nextDay = new Date(date);
                nextDay.setDate(nextDay.getDate() + 1);

                // 1. 해당 날짜의 모든 사진 가져오기 (인덱스 없이 단순 쿼리)
                const photosSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('photos')
                    .where('uploadedAt', '>=', firebase.firestore.Timestamp.fromDate(date))
                    .where('uploadedAt', '<', firebase.firestore.Timestamp.fromDate(nextDay))
                    .get();

                // 2. 식단 사진만 필터링하고 영양 데이터 수집
                let totalCal = 0, totalCarbs = 0, totalProtein = 0, totalFat = 0;
                const meals = [];

                photosSnapshot.forEach(doc => {
                    const photo = doc.data();
                    if (photo.category === 'food' && photo.nutrition) {
                        totalCal += photo.nutrition.calories || 0;
                        totalCarbs += photo.nutrition.carbs || 0;
                        totalProtein += photo.nutrition.protein || 0;
                        totalFat += photo.nutrition.fat || 0;

                        meals.push({
                            foodName: photo.nutrition.foodName || '음식',
                            calories: photo.nutrition.calories || 0,
                            carbs: photo.nutrition.carbs || 0,
                            protein: photo.nutrition.protein || 0,
                            fat: photo.nutrition.fat || 0,
                            timestamp: photo.uploadedAt
                        });
                    }
                });

                // 3. dailyLogs 업데이트
                const dailyLogRef = db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').doc(dateStr);

                const dailyLogDoc = await dailyLogRef.get();
                
                if (meals.length > 0) {
                    // 영양 데이터가 있으면 업데이트
                    if (dailyLogDoc.exists) {
                        await dailyLogRef.update({
                            'nutrition.calories': totalCal,
                            'nutrition.carbs': totalCarbs,
                            'nutrition.protein': totalProtein,
                            'nutrition.fat': totalFat,
                            'nutrition.meals': meals
                        });
                    } else {
                        await dailyLogRef.set({
                            nutrition: {
                                calories: totalCal,
                                carbs: totalCarbs,
                                protein: totalProtein,
                                fat: totalFat,
                                meals: meals
                            }
                        });
                    }
                    showToast(`✅ 동기화 완료! 총 ${meals.length}개 식사, ${Math.round(totalCal)}kcal`);
                } else {
                    // 영양 데이터가 없으면 nutrition 필드 삭제
                    if (dailyLogDoc.exists && dailyLogDoc.data().nutrition) {
                        await dailyLogRef.update({
                            nutrition: firebase.firestore.FieldValue.delete()
                        });
                    }
                    showToast('✅ 동기화 완료! 식단 사진이 없어 영양 데이터가 제거되었습니다.');
                }

                // 4. 모달 닫고 새로고침
                document.querySelector('.day-report-modal').remove();
                await showDayReport(dateStr);

            } catch (error) {
                console.error('데이터 동기화 오류:', error);
                showToast('❌ 동기화 중 오류가 발생했습니다.');
                syncBtn.innerHTML = originalText;
                syncBtn.disabled = false;
            }
        }

        // ==================== 소통 탭 ====================
        // [수정 2] 소통방 불러오기 (옛날 주소 + 안전장치)
        async function loadCommunityMessages() {
            try {
                // 경로: public -> data -> posts (옛날 경로)
                db.collection('artifacts').doc('diet-mate-v2').collection('public')
                    .doc('data').collection('posts')
                    .orderBy('at', 'asc') // 옛날 시간 필드 'at' 사용
                    .limit(50)
                    .onSnapshot(snapshot => {
                        const container = document.getElementById('chatContainer');
                        if (!container) return;
                        
                        container.innerHTML = '';
                        snapshot.forEach(doc => {
                            const msg = doc.data();
                            const msgDiv = document.createElement('div');
                            msgDiv.className = 'chat-message';
                            if (msg.userId === currentUser.uid) msgDiv.classList.add('mine');

                            // 날짜 안전하게 변환
                            let timeStr = "";
                            try {
                                const d = msg.at ? msg.at.toDate() : new Date();
                                timeStr = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
                            } catch(e) { timeStr = "날짜 오류"; }

                            // 내용 표시 (옛날 필드 호환)
                            const name = msg.name || msg.userName || '익명';
                            const text = msg.text || msg.message || '';

                            msgDiv.innerHTML = `
                                <div class=\"message-header\">
                                    <span class=\"message-author\">${name}</span>
                                    <span class=\"message-time\">${timeStr}</span>
                                </div>
                                <div class=\"message-bubble\">${text}</div>
                            `;
                            container.appendChild(msgDiv);
                        });
                        container.scrollTop = container.scrollHeight;
                    });
            } catch (e) {
                console.error("채팅 로드 실패:", e);
            }
        }

        // [수정 3] 채팅 보내기 (옛날 주소로 전송)
        async function sendCommunityMessage() {
            const input = document.getElementById('communityInput');
            const message = input.value.trim();
            
            if (!message) return;
            if (!currentProfile) {
                alert("프로필 로딩 중입니다. 잠시만 기다려주세요.");
                return;
            }

            try {
                await db.collection('artifacts').doc('diet-mate-v2').collection('public')
                    .doc('data').collection('posts').add({
                    userId: currentUser.uid,
                    name: currentProfile.name, // 내 이름
                    text: message,             // 메시지 내용
                    at: firebase.firestore.FieldValue.serverTimestamp()
                });
                input.value = '';
            } catch (e) {
                alert("메시지 전송 실패: " + e.message);
            }
        }

        // ==================== 알림 탭 ====================
        function loadNotifications() {
            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            const list = document.getElementById('notificationList');
            list.innerHTML = '';

            if (notifications.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">설정된 알림이 없습니다.</p>';
                return;
            }

            notifications.forEach((notif, index) => {
                const notifDiv = document.createElement('div');
                notifDiv.className = 'notification-item';
                notifDiv.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-title">${notif.title}</div>
                        <div class="notification-details">${notif.time} - ${notif.repeat}</div>
                    </div>
                    <div class="notification-actions">
                        <div class="notification-edit" onclick="editNotification(${index})">✏️</div>
                        <div class="notification-delete" onclick="deleteNotification(${index})">🗑️</div>
                    </div>
                `;
                list.appendChild(notifDiv);
            });
        }

        function openAddNotificationModal() {
            const title = prompt('알림 내용을 입력하세요 (예: 물 마시기)');
            if (!title) return;

            const time = prompt('알림 시간을 입력하세요 (예: 09:00)');
            if (!time) return;

            const repeat = prompt('반복 간격을 선택하세요\n1. 매일\n2. 매주\n3. 한 번만');
            let repeatValue = '매일';
            if (repeat === '2') repeatValue = '매주';
            else if (repeat === '3') repeatValue = '한 번만';

            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            notifications.push({
                title: title,
                time: time,
                repeat: repeatValue,
                lastTriggered: null
            });

            localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
            loadNotifications();
        }

        function addWaterNotificationPreset() {
            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');

            // 중복 체크
            const hasWaterAlerts = notifications.some(n => n.title.includes('물 마시기'));
            if (hasWaterAlerts) {
                if (!confirm('이미 물 마시기 알림이 있습니다. 추가하시겠습니까?')) return;
            }

            // 물 마시기 알림 5회 추가 (9시, 12시, 15시, 18시, 21시)
            const waterTimes = ['09:00', '12:00', '15:00', '18:00', '21:00'];
            waterTimes.forEach(time => {
                notifications.push({
                    title: '💧 물 마시기',
                    time: time,
                    repeat: '매일',
                    lastTriggered: null
                });
            });

            localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
            loadNotifications();
            alert('물 마시기 알림 5개가 추가되었습니다!\n(9시, 12시, 15시, 18시, 21시)');
        }

        function deleteNotification(index) {
            if (!confirm('이 알림을 삭제하시겠습니까?')) return;

            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            notifications.splice(index, 1);
            localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
            loadNotifications();
        }

        let editingNotificationIndex = null;

        function editNotification(index) {
            editingNotificationIndex = index;
            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            const notif = notifications[index];

            // 모달에 현재 값 채우기
            document.getElementById('editNotifTitle').value = notif.title;
            document.getElementById('editNotifTime').value = notif.time;
            document.getElementById('editNotifRepeat').value = notif.repeat;

            // 모달 열기
            document.getElementById('editNotificationModalOverlay').classList.add('show');
        }

        function closeEditNotificationModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('editNotificationModalOverlay');
            modal.classList.remove('show');
            editingNotificationIndex = null;
        }

        function saveEditedNotification() {
            if (editingNotificationIndex === null) return;

            const title = document.getElementById('editNotifTitle').value.trim();
            const time = document.getElementById('editNotifTime').value;
            const repeat = document.getElementById('editNotifRepeat').value;

            if (!title || !time) {
                alert('알림 내용과 시간을 모두 입력해주세요.');
                return;
            }

            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            notifications[editingNotificationIndex] = {
                title: title,
                time: time,
                repeat: repeat,
                lastTriggered: notifications[editingNotificationIndex].lastTriggered
            };

            localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
            loadNotifications();
            closeEditNotificationModal();
            showSuccessToast('알림이 수정되었습니다!');
        }

        function startNotificationCheck() {
            // 알림 권한 요청
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            // 1분마다 알림 체크
            notificationCheckInterval = setInterval(() => {
                checkAndTriggerNotifications();
            }, 60000);

            checkAndTriggerNotifications();
        }

        function checkAndTriggerNotifications() {
            const notifications = JSON.parse(localStorage.getItem(LS_KEYS.NOTIFICATIONS) || '[]');
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            notifications.forEach((notif, index) => {
                if (notif.time === currentTime) {
                    const lastTriggered = notif.lastTriggered ? new Date(notif.lastTriggered) : null;

                    let shouldTrigger = false;
                    if (!lastTriggered) {
                        shouldTrigger = true;
                    } else if (notif.repeat === '매일') {
                        const daysDiff = Math.floor((now - lastTriggered) / (1000 * 60 * 60 * 24));
                        if (daysDiff >= 1) shouldTrigger = true;
                    } else if (notif.repeat === '매주') {
                        const daysDiff = Math.floor((now - lastTriggered) / (1000 * 60 * 60 * 24));
                        if (daysDiff >= 7) shouldTrigger = true;
                    }

                    if (shouldTrigger) {
                        // 브라우저 알림
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification('Diet Mate', {
                                body: notif.title,
                                icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ctext x="50" y="70" font-size="60" text-anchor="middle"%3E💪%3C/text%3E%3C/svg%3E'
                            });
                        }

                        // 인앱 알림 (간단한 alert - 실제로는 커스텀 UI 사용 권장)
                        if (currentTab === 'notification') {
                            alert(`⏰ ${notif.title}`);
                        }

                        // 마지막 트리거 시간 업데이트
                        notifications[index].lastTriggered = now.toISOString();
                        localStorage.setItem(LS_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
                    }
                }
            });
        }

        // ==================== 설정 탭 ====================
        async function loadSettings() {
            // 함께한 날 계산
            const createdAt = currentProfile.createdAt ? currentProfile.createdAt.toDate() : new Date();
            const daysSince = Math.floor((new Date() - createdAt) / (1000 * 60 * 60 * 24));
            document.getElementById('totalDays').textContent = daysSince;

            // 총 운동 시간 (플랜에서 운동 카테고리 합산)
            try {
                const plansSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('plans').get();

                let totalExerciseMinutes = 0;
                plansSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.category === '운동' && data.value) {
                        // value에서 숫자 추출 (예: "30분", "1시간" 등)
                        const match = data.value.match(/(\d+)/);
                        if (match) {
                            const num = parseInt(match[1]);
                            if (data.value.includes('시간')) {
                                totalExerciseMinutes += num * 60;
                            } else {
                                totalExerciseMinutes += num;
                            }
                        }
                    }
                });

                // 단식 기록에서도 운동 시간 추가 (단식 중 운동한 경우)
                const fastingRecords = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('fastingRecords').get();

                // 운동 시간 표시
                document.getElementById('totalExercise').textContent = totalExerciseMinutes;
            } catch (error) {
                console.error('운동 시간 계산 실패:', error);
                document.getElementById('totalExercise').textContent = '0';
            }

            // 절약 칼로리 (간단 계산)
            const startWeight = currentProfile.startWeight || 0;
            const weightData = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                .collection('logs').orderBy('date', 'desc').limit(1).get();

            const currentWeight = weightData.empty ? startWeight : weightData.docs[0].data().weight;
            const weightLost = startWeight - currentWeight;
            const caloriesSaved = Math.floor(weightLost * 7700); // 1kg = 약 7700kcal
            document.getElementById('totalCalories').textContent = caloriesSaved > 0 ? caloriesSaved : 0;

            // AI 예측 달성일 (최근 30일 데이터 기반)
            const goalWeight = currentProfile.goalWeight || 0;
            const remaining = currentWeight - goalWeight;

            if (remaining > 0) {
                try {
                    // 최근 30일 체중 데이터 가져오기
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                    const recentWeights = await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(currentUser.uid)
                        .collection('logs')
                        .where('date', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
                        .orderBy('date', 'asc')
                        .get();

                    if (!recentWeights.empty && recentWeights.docs.length >= 2) {
                        const firstWeight = recentWeights.docs[0].data().weight;
                        const lastWeight = recentWeights.docs[recentWeights.docs.length - 1].data().weight;
                        const daysInPeriod = recentWeights.docs.length;

                        const recentWeightLoss = firstWeight - lastWeight;

                        if (recentWeightLoss > 0) {
                            // 주간 감량 속도 계산
                            const avgWeeklyLoss = (recentWeightLoss / daysInPeriod) * 7;
                            const weeksNeeded = Math.ceil(remaining / avgWeeklyLoss);
                            const daysNeeded = weeksNeeded * 7;

                            const predictedDate = new Date();
                            predictedDate.setDate(predictedDate.getDate() + daysNeeded);
                            document.getElementById('predictedDate').textContent = `${predictedDate.getMonth() + 1}/${predictedDate.getDate()}`;
                        } else {
                            // 체중 증가 중
                            document.getElementById('predictedDate').textContent = '체중 관리 필요';
                        }
                    } else if (weightLost > 0 && daysSince > 0) {
                        // 데이터가 부족하면 전체 기간 평균 사용
                        const avgLossPerDay = weightLost / daysSince;
                        const daysNeeded = Math.ceil(remaining / avgLossPerDay);
                        const predictedDate = new Date();
                        predictedDate.setDate(predictedDate.getDate() + daysNeeded);
                        document.getElementById('predictedDate').textContent = `${predictedDate.getMonth() + 1}/${predictedDate.getDate()}`;
                    } else {
                        document.getElementById('predictedDate').textContent = '-';
                    }
                } catch (error) {
                    console.error('예상 달성일 계산 실패:', error);
                    document.getElementById('predictedDate').textContent = '-';
                }
            } else {
                document.getElementById('predictedDate').textContent = '목표 달성!';
            }
        }

        async function exportData() {
            try {
                const data = {
                    profile: currentProfile,
                    weights: [],
                    plans: [],
                    photos: []
                };

                const weights = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid).collection('logs').get();
                weights.forEach(doc => data.weights.push({ id: doc.id, ...doc.data() }));

                const plans = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid).collection('plans').get();
                plans.forEach(doc => data.plans.push({ id: doc.id, ...doc.data() }));

                const photos = await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid).collection('photos').get();
                photos.forEach(doc => data.photos.push({ id: doc.id, ...doc.data() }));

                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `diet_mate_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();

                URL.revokeObjectURL(url);
                alert('데이터 내보내기 완료!');
            } catch (error) {
                console.error('내보내기 실패:', error);
                alert('데이터 내보내기에 실패했습니다.');
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    if (!confirm('기존 데이터를 덮어쓰시겠습니까? (취소하면 병합됩니다)')) {
                        // 병합 모드
                        alert('병합 기능은 현재 구현 중입니다. 데이터를 덮어씁니다.');
                    }

                    // 체중 데이터 복원
                    for (const weight of data.weights) {
                        const { id, ...weightData } = weight;
                        await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                            .collection('logs').add(weightData);
                    }

                    // 플랜 데이터 복원
                    for (const plan of data.plans) {
                        const { id, ...planData } = plan;
                        await db.collection('artifacts').doc('diet-mate-v2').collection('users').doc(currentUser.uid)
                            .collection('plans').add(planData);
                    }

                    alert('데이터 가져오기 완료! 페이지를 새로고침합니다.');
                    location.reload();
                } catch (error) {
                    console.error('가져오기 실패:', error);
                    alert('데이터 가져오기에 실패했습니다.');
                }
            };
            input.click();
        }

        // ==================== 식사 직접 입력 기능 ====================
        let analyzedNutrition = null;

        // 식사 타입 선택
        function selectMeal(mealType) {
            currentMealType = mealType;
            const methodDiv = document.getElementById('mealInputMethod');
            
            // 토글 기능: 이미 열려있고 같은 식사 타입이면 닫기
            if (methodDiv.style.display === 'block' && document.getElementById('selectedMealType').textContent === mealType) {
                methodDiv.style.display = 'none';
                console.log('식사 입력 닫기');
            } else {
                // 열기
                document.getElementById('selectedMealType').textContent = mealType;
                methodDiv.style.display = 'block';
                console.log('식사 입력 열기:', mealType);
            }
        }

        // 사진으로 음식 분석 (Gemini Vision API)
        async function uploadFoodPhoto(isEditMode = false) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'camera'; // 모바일에서 카메라 직접 열기

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                showLoading('AI가 음식을 분석 중...');

                try {
                    // 1. Firebase Storage에 업로드
                    const timestamp = Date.now();
                    const storageRef = storage.ref(`meals/${currentUser.uid}/${timestamp}.jpg`);
                    await storageRef.put(file);
                    const photoURL = await storageRef.getDownloadURL();

                    // 2. 이미지를 Base64로 변환
                    const base64Image = await fileToBase64(file);

                    // 3. Gemini Flash 1.5로 음식 분석
                    const analysis = await analyzeImageWithGemini(base64Image);

                    hideLoading();

                    if (analysis) {
                        // 🔥 수정 모드 확인
                        if (isEditMode && window.editingMealData) {
                            const editData = window.editingMealData;
                            const meal = todayIntake.meals[editData.index];
                            
                            if (meal) {
                                // 기존 영양소 차감
                                todayIntake.calories -= (meal.calories || 0);
                                todayIntake.carbs -= (meal.carbs || 0);
                                todayIntake.protein -= (meal.protein || 0);
                                todayIntake.fat -= (meal.fat || 0);
                                
                                // 새 영양 정보로 업데이트 (시간은 유지, 사진은 변경)
                                meal.food = analysis.foodName;
                                meal.foodName = analysis.foodName;
                                meal.name = analysis.foodName;
                                meal.calories = analysis.calories;
                                meal.carbs = analysis.carbs;
                                meal.protein = analysis.protein;
                                meal.fat = analysis.fat;
                                meal.photo = photoURL;
                                meal.photoURL = photoURL;
                                // meal.timestamp는 그대로 유지
                                
                                // 새 영양소 추가
                                todayIntake.calories += analysis.calories;
                                todayIntake.carbs += analysis.carbs;
                                todayIntake.protein += analysis.protein;
                                todayIntake.fat += analysis.fat;
                                
                                // Firebase 저장
                                await saveTodayNutritionToFirestore();
                                
                                // 🔥 앨범 탭 동기화: 기존 사진 삭제 + 새 사진 추가
                                if (editData.originalPhoto) {
                                    // 기존 사진 삭제
                                    const oldPhotosSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                                        .collection('users').doc(currentUser.uid)
                                        .collection('photos')
                                        .where('url', '==', editData.originalPhoto)
                                        .get();
                                    
                                    oldPhotosSnapshot.forEach(async (doc) => {
                                        await doc.ref.delete();
                                        console.log('🗑️ 앨범 기존 사진 삭제:', doc.id);
                                    });
                                }
                                
                                // 새 사진 추가
                                await db.collection('artifacts').doc('diet-mate-v2')
                                    .collection('users').doc(currentUser.uid)
                                    .collection('photos').add({
                                        category: 'food',
                                        url: photoURL,
                                        meal: currentMealType,
                                        food: analysis.foodName,
                                        nutrition: {
                                            calories: analysis.calories,
                                            carbs: analysis.carbs,
                                            protein: analysis.protein,
                                            fat: analysis.fat
                                        },
                                        uploadedAt: editData.originalTimestamp || firebase.firestore.FieldValue.serverTimestamp(),
                                        mealType: currentMealType
                                    });
                                
                                // UI 업데이트
                                updateNutritionUI();
                                
                                // 수정 데이터 초기화
                                window.editingMealData = null;
                                
                                showAIToast(`✅ ${analysis.foodName} 수정 완료! (시간 유지)\n칼로리: ${analysis.calories}kcal`, 5000);
                            }
                        } else {
                            // 🔥 신규 등록 모드
                            // 4. 영양 섭취에 추가
                            addMeal(currentMealType, analysis.foodName, {
                                calories: analysis.calories,
                                carbs: analysis.carbs,
                                protein: analysis.protein,
                                fat: analysis.fat,
                                timestamp: new Date(),
                                photo: photoURL
                            });

                            // 5. 앨범에 저장
                            await db.collection('artifacts').doc('diet-mate-v2')
                                .collection('users').doc(currentUser.uid)
                                .collection('photos').add({
                                    category: 'food',
                                    url: photoURL,
                                    meal: currentMealType,
                                    food: analysis.foodName,
                                    nutrition: {
                                        calories: analysis.calories,
                                        carbs: analysis.carbs,
                                        protein: analysis.protein,
                                        fat: analysis.fat
                                    },
                                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    mealType: currentMealType
                                });

                            // 6. UI 업데이트
                            updateNutritionUI();

                            // 7. 입력 방법 선택 영역 숨기기
                            document.getElementById('mealInputMethod').style.display = 'none';

                            showAIToast(`📸 ${analysis.foodName} 추가 완료!\n칼로리: ${analysis.calories}kcal`, 5000);
                        }
                    } else {
                        alert('음식 분석에 실패했습니다. 다시 시도해주세요.');
                    }

                } catch (error) {
                    console.error('음식 사진 분석 오류:', error);
                    hideLoading();
                    alert('음식 분석 중 오류가 발생했습니다: ' + error.message);
                }
            };

            input.click();
        }

        // 파일을 Base64로 변환
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // data:image/jpeg;base64,... 형식에서 base64 부분만 추출
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Gemini Flash 1.5로 이미지 분석
        async function analyzeImageWithGemini(base64Image) {
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${GEMINI_API_KEY}`;

                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: "이 음식 사진을 분석하여 다음 정보를 JSON 형식으로 정확하게 제공해주세요:\n1. foodName: 음식 이름 (한국어)\n2. calories: 예상 칼로리 (숫자만)\n3. carbs: 탄수화물 (g, 숫자만)\n4. protein: 단백질 (g, 숫자만)\n5. fat: 지방 (g, 숫자만)\n6. per100g: 100g당 영양정보 객체 {calories, carbs, protein, fat}\n\n응답 형식:\n{\"foodName\": \"닭가슴살 샐러드\", \"calories\": 250, \"carbs\": 15, \"protein\": 30, \"fat\": 8, \"per100g\": {\"calories\": 120, \"carbs\": 7, \"protein\": 14, \"fat\": 4}}\n\n참고: 음식의 양과 종류를 고려하여 실제에 가까운 영양 정보를 제공해주세요."
                            },
                            {
                                inline_data: {
                                    mime_type: "image/jpeg",
                                    data: base64Image
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.4,
                        maxOutputTokens: 200,
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API 오류: ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;

                // JSON 추출 (```json으로 감싸져 있을 수 있음)
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const nutritionData = JSON.parse(jsonMatch[0]);
                    return nutritionData;
                } else {
                    throw new Error('JSON 형식을 찾을 수 없습니다');
                }

            } catch (error) {
                console.error('Gemini API 분석 실패:', error);
                return null;
            }
        }

        function openMealInputModal(mealType) {
            if (mealType) {
                currentMealType = mealType;
            }
            
            // currentMealType이 없으면 기본값 사용
            if (!currentMealType) {
                currentMealType = '점심';
            }
            
            const modal = document.getElementById('mealInputModalOverlay');
            const title = document.getElementById('mealInputTitle');

            // 이모지 매핑
            const emojiMap = {
                '아침': '🌅',
                '점심': '☀️',
                '저녁': '🌙',
                '간식': '🍪'
            };

            title.textContent = `${emojiMap[currentMealType] || '🍽️'} ${currentMealType} 입력`;
            modal.classList.add('show');

            // 입력 필드 초기화
            document.getElementById('mealFoodName').value = '';
            document.getElementById('mealGrams').value = '';
            document.getElementById('nutritionResult').classList.remove('show');
            document.getElementById('manualInputFields').classList.remove('show');
            document.getElementById('foodSearchResults').style.display = 'none'; // 🔥 검색 결과 초기화
            analyzedNutrition = null;
        }

        function closeMealInputModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('mealInputModalOverlay');
            modal.classList.remove('show');
        }

        async function analyzeMealWithAI() {
            const foodName = document.getElementById('mealFoodName').value.trim();
            const grams = document.getElementById('mealGrams').value.trim();

            if (!foodName) {
                alert('음식명을 입력해주세요.');
                return;
            }

            const btn = document.getElementById('aiAnalyzeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>⏳</span><span>분석 중...</span>';

            try {
                // 🔥 영양 분석 전용 API 사용
                const response = await callGeminiNutritionAnalysis(foodName, grams, currentProfile);
                const nutrition = parseNutritionResponse(response);

                if (nutrition) {
                    analyzedNutrition = nutrition;

                    // 결과 표시
                    document.getElementById('resultCalories').textContent = Math.round(nutrition.calories);
                    document.getElementById('resultCarbs').textContent = Math.round(nutrition.carbs);
                    document.getElementById('resultProtein').textContent = Math.round(nutrition.protein);
                    document.getElementById('resultFat').textContent = Math.round(nutrition.fat);

                    document.getElementById('nutritionResult').classList.add('show');

                    showAIToast(nutrition.advice || '영양 분석 완료!', 3000);
                } else {
                    throw new Error('영양 분석 실패');
                }

            } catch (error) {
                console.error('AI 분석 오류:', error);
                alert('영양 분석에 실패했습니다. 수동으로 입력해주세요.');
                document.getElementById('nutritionResult').classList.add('show');
                document.getElementById('manualInputFields').classList.add('show');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>🤖</span><span>AI로 영양 분석</span>';
            }
        }
        
        // 🔥 새 기능: 음식 검색 (브랜드별 영양 정보 제공)
        // 🔥 기본 음식 데이터베이스 (API 없이도 작동)
        const BASIC_FOOD_DB = {
            '라면': [
                {foodName: '신라면 1인분', calories: 500, carbs: 80, protein: 10, fat: 16},
                {foodName: '진라면 1인분', calories: 480, carbs: 78, protein: 9, fat: 15},
                {foodName: '너구리 1인분', calories: 520, carbs: 82, protein: 11, fat: 17}
            ],
            '김치찌개': [
                {foodName: '김치찌개 1인분', calories: 250, carbs: 15, protein: 18, fat: 12},
                {foodName: '참치김치찌개 1인분', calories: 280, carbs: 16, protein: 22, fat: 14}
            ],
            '된장찌개': [
                {foodName: '된장찌개 1인분', calories: 180, carbs: 12, protein: 15, fat: 8}
            ],
            '삼겹살': [
                {foodName: '삼겹살 100g', calories: 518, carbs: 0, protein: 17, fat: 50},
                {foodName: '삼겹살 1인분(200g)', calories: 1036, carbs: 0, protein: 34, fat: 100}
            ],
            '치킨': [
                {foodName: '후라이드치킨 1조각', calories: 250, carbs: 12, protein: 20, fat: 15},
                {foodName: '양념치킨 1조각', calories: 280, carbs: 18, protein: 19, fat: 16}
            ],
            '피자': [
                {foodName: '피자 1조각', calories: 280, carbs: 35, protein: 12, fat: 10}
            ],
            '햄버거': [
                {foodName: '불고기버거', calories: 450, carbs: 50, protein: 22, fat: 18},
                {foodName: '치즈버거', calories: 380, carbs: 40, protein: 18, fat: 15}
            ],
            '밥': [
                {foodName: '백미밥 1공기', calories: 300, carbs: 65, protein: 6, fat: 1},
                {foodName: '잡곡밥 1공기', calories: 280, carbs: 60, protein: 7, fat: 2}
            ],
            '빵': [
                {foodName: '식빵 1조각', calories: 80, carbs: 15, protein: 3, fat: 1},
                {foodName: '크로와상 1개', calories: 230, carbs: 26, protein: 5, fat: 12}
            ]
        };
        
        async function searchFoodDatabase() {
            const foodName = document.getElementById('mealFoodName').value.trim();
            
            if (!foodName) {
                alert('검색할 음식 이름을 입력해주세요.');
                return;
            }
            
            const searchBtn = document.querySelector('.search-food-btn');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '⏳ 검색 중...';
            
            try {
                // 🔥 1단계: 기본 DB에서 검색
                let foodOptions = searchBasicDB(foodName);
                
                // 🔥 2단계: 기본 DB에 없으면 AI 검색 시도
                if (!foodOptions || foodOptions.length === 0) {
                    try {
                        const response = await callGeminiFoodSearch(foodName);
                        foodOptions = parseFoodSearchResponse(response);
                    } catch (apiError) {
                        console.warn('AI 검색 실패, 기본값 제공:', apiError);
                        // AI 실패 시 추정값 제공
                        foodOptions = [{
                            foodName: `${foodName} 1인분 (추정)`,
                            calories: 300,
                            carbs: 40,
                            protein: 15,
                            fat: 10
                        }];
                    }
                }
                
                if (foodOptions && foodOptions.length > 0) {
                    displayFoodOptions(foodOptions);
                } else {
                    throw new Error('검색 결과가 없습니다');
                }
                
            } catch (error) {
                console.error('음식 검색 오류:', error);
                alert('음식 검색에 실패했습니다. 수동으로 영양 정보를 입력해주세요.');
                // 수동 입력 필드 표시
                document.getElementById('manualInputFields').classList.add('show');
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '🔍 검색';
            }
        }
        
        // 기본 DB 검색 함수
        function searchBasicDB(query) {
            const results = [];
            query = query.toLowerCase().trim();
            
            for (const [key, items] of Object.entries(BASIC_FOOD_DB)) {
                if (key.includes(query) || query.includes(key)) {
                    results.push(...items);
                }
            }
            
            return results;
        }
        
        function parseFoodSearchResponse(response) {
            try {
                // JSON 배열 추출
                const jsonMatch = response.match(/\[[\s\S]*\]/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                throw new Error('JSON 형식 오류');
            } catch (error) {
                console.error('검색 결과 파싱 실패:', error);
                return null;
            }
        }
        
        function displayFoodOptions(options) {
            const container = document.getElementById('foodOptionsContainer');
            const resultsDiv = document.getElementById('foodSearchResults');
            
            container.innerHTML = options.map((option, index) => `
                <div onclick="selectFoodOption(${index})" 
                     style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                     onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateX(5px)';"
                     onmouseout="this.style.borderColor='transparent'; this.style.transform='translateX(0)';">
                    <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                        ${option.name}
                    </div>
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                        ${option.serving}
                    </div>
                    <div style="display: flex; gap: 15px; font-size: 0.85rem; color: #999;">
                        <span>🔥 ${option.calories}kcal</span>
                        <span>🍚 탄${option.carbs}g</span>
                        <span>💪 단${option.protein}g</span>
                        <span>🧈 지${option.fat}g</span>
                    </div>
                </div>
            `).join('');
            
            resultsDiv.style.display = 'block';
            
            // 검색 결과 저장
            window.currentFoodOptions = options;
        }
        
        function selectFoodOption(index) {
            const option = window.currentFoodOptions[index];
            if (!option) return;
            
            // 음식명 업데이트
            document.getElementById('mealFoodName').value = option.name;
            
            // 영양 정보 자동 채우기 (100g당 정보 포함)
            analyzedNutrition = {
                calories: option.calories,
                carbs: option.carbs,
                protein: option.protein,
                fat: option.fat,
                foodName: option.name,
                per100g: option.per100g || null, // 🔥 100g당 정보 저장
                advice: `${option.name} 선택 완료!`
            };
            
            // 결과 표시
            document.getElementById('resultCalories').textContent = Math.round(option.calories);
            document.getElementById('resultCarbs').textContent = Math.round(option.carbs);
            document.getElementById('resultProtein').textContent = Math.round(option.protein);
            document.getElementById('resultFat').textContent = Math.round(option.fat);
            
            document.getElementById('nutritionResult').classList.add('show');
            document.getElementById('foodSearchResults').style.display = 'none';
            
            showAIToast(`✅ ${option.name} 선택 완료!`, 3000);
        }
        
        // 🔥 수정 모달용 검색 함수
        async function searchFoodForEdit() {
            const foodName = document.getElementById('editFoodName').value.trim();
            
            if (!foodName) {
                alert('검색할 음식 이름을 입력해주세요.');
                return;
            }
            
            const searchBtn = document.querySelector('.search-food-btn-edit');
            searchBtn.disabled = true;
            searchBtn.innerHTML = '⏳ 검색 중...';
            
            try {
                const prompt = `당신은 전문 영양 데이터베이스 AI입니다.
사용자가 검색한 음식: "${foodName}"

이 음식에 대한 브랜드별, 종류별 영양 정보를 **최대 5가지**로 제공해주세요.
각 항목은 다음 정보를 포함해야 합니다:
- name: 브랜드/종류 포함 음식명 (예: "농심 신라면 1개(120g)")
- serving: 1회 제공량 (예: "1개(120g)", "1그릇(500g)", "100g")
- calories: 칼로리 (kcal)
- carbs: 탄수화물 (g)
- protein: 단백질 (g)
- fat: 지방 (g)
- per100g: 100g당 영양 정보 {calories, carbs, protein, fat}

**반드시 JSON 배열 형식으로만** 응답하세요:
[
  {
    "name": "브랜드/종류 포함 음식명",
    "serving": "1회 제공량",
    "calories": 숫자,
    "carbs": 숫자,
    "protein": 숫자,
    "fat": 숫자,
    "per100g": {
      "calories": 숫자,
      "carbs": 숫자,
      "protein": 숫자,
      "fat": 숫자
    }
  }
]

주의:
1. JSON 외 다른 텍스트는 절대 포함하지 마세요
2. 실제 영양 정보를 기반으로 정확하게 제공하세요
3. 브랜드명이나 상세 종류를 반드시 포함하세요
4. per100g 정보를 반드시 포함하세요`;

                const response = await callGeminiAPI(prompt);
                const foodOptions = parseFoodSearchResponse(response);
                
                if (foodOptions && foodOptions.length > 0) {
                    displayEditFoodOptions(foodOptions);
                } else {
                    throw new Error('검색 결과가 없습니다');
                }
                
            } catch (error) {
                console.error('음식 검색 오류:', error);
                alert('음식 검색에 실패했습니다. 직접 입력해주세요.');
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '🔍 검색';
            }
        }
        
        function displayEditFoodOptions(options) {
            const container = document.getElementById('editFoodOptionsContainer');
            const resultsDiv = document.getElementById('editFoodSearchResults');
            
            container.innerHTML = options.map((option, index) => `
                <div onclick="selectEditFoodOption(${index})" 
                     style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                     onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateX(5px)';"
                     onmouseout="this.style.borderColor='transparent'; this.style.transform='translateX(0)';">
                    <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                        ${option.name}
                    </div>
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">
                        ${option.serving}
                    </div>
                    <div style="display: flex; gap: 15px; font-size: 0.85rem; color: #999;">
                        <span>🔥 ${option.calories}kcal</span>
                        <span>🍚 탄${option.carbs}g</span>
                        <span>💪 단${option.protein}g</span>
                        <span>🧈 지${option.fat}g</span>
                    </div>
                </div>
            `).join('');
            
            resultsDiv.style.display = 'block';
            
            // 검색 결과 저장
            window.currentEditFoodOptions = options;
        }
        
        function selectEditFoodOption(index) {
            const option = window.currentEditFoodOptions[index];
            if (!option) return;
            
            // 입력 필드에 자동 채우기
            document.getElementById('editFoodName').value = option.name;
            document.getElementById('editCalories').value = Math.round(option.calories);
            document.getElementById('editCarbs').value = Math.round(option.carbs);
            document.getElementById('editProtein').value = Math.round(option.protein);
            document.getElementById('editFat').value = Math.round(option.fat);
            
            // 검색 결과 숨기기
            document.getElementById('editFoodSearchResults').style.display = 'none';
            
            showAIToast(`✅ ${option.name} 선택 완료!`, 3000);
        }

        function toggleManualInput() {
            const manualFields = document.getElementById('manualInputFields');
            manualFields.classList.toggle('show');

            if (manualFields.classList.contains('show')) {
                // AI 분석 결과를 수동 입력 필드에 채우기
                if (analyzedNutrition) {
                    document.getElementById('manualCalories').value = Math.round(analyzedNutrition.calories);
                    document.getElementById('manualCarbs').value = Math.round(analyzedNutrition.carbs);
                    document.getElementById('manualProtein').value = Math.round(analyzedNutrition.protein);
                    document.getElementById('manualFat').value = Math.round(analyzedNutrition.fat);
                }
            }
        }

        async function saveMealInput() {
            const foodName = document.getElementById('mealFoodName').value.trim();

            if (!foodName) {
                alert('음식명을 입력해주세요.');
                return;
            }

            // 수동 입력 값 확인
            const manualFields = document.getElementById('manualInputFields');
            let nutrition;

            if (manualFields.classList.contains('show')) {
                // 수동 입력 모드
                const calories = parseFloat(document.getElementById('manualCalories').value) || 0;
                const carbs = parseFloat(document.getElementById('manualCarbs').value) || 0;
                const protein = parseFloat(document.getElementById('manualProtein').value) || 0;
                const fat = parseFloat(document.getElementById('manualFat').value) || 0;
                
                nutrition = {
                    calories: calories,
                    carbs: carbs,
                    protein: protein,
                    fat: fat,
                    foodName: foodName,
                    advice: `${currentMealType} 식사 기록 완료!`,
                    // 🔥 수동 입력의 경우 대략적인 100g당 값 추정
                    per100g: {
                        calories: Math.round(calories * 0.5),
                        carbs: Math.round(carbs * 0.5),
                        protein: Math.round(protein * 0.5),
                        fat: Math.round(fat * 0.5)
                    }
                };
            } else if (analyzedNutrition) {
                // AI 분석 결과 사용
                nutrition = analyzedNutrition;
            } else {
                alert('영양 분석을 먼저 진행하거나 수동으로 입력해주세요.');
                return;
            }

            if (nutrition.calories === 0) {
                if (!confirm('칼로리가 0입니다. 그래도 저장하시겠습니까?')) {
                    return;
                }
            }

            try {
                // 🔥 수정 모드 확인
                const isEditMode = window.editingMealData && window.editingMealData.index !== undefined;
                
                if (isEditMode) {
                    // 🔥 수정 모드: 기존 데이터 업데이트 (시간 유지)
                    const editData = window.editingMealData;
                    const meal = todayIntake.meals[editData.index];
                    
                    if (meal) {
                        // 기존 영양소 차감
                        todayIntake.calories -= (meal.calories || 0);
                        todayIntake.carbs -= (meal.carbs || 0);
                        todayIntake.protein -= (meal.protein || 0);
                        todayIntake.fat -= (meal.fat || 0);
                        
                        // 새 영양 정보로 업데이트 (시간은 유지)
                        meal.food = foodName;
                        meal.foodName = foodName;
                        meal.name = foodName;
                        meal.calories = nutrition.calories;
                        meal.carbs = nutrition.carbs;
                        meal.protein = nutrition.protein;
                        meal.fat = nutrition.fat;
                        meal.per100g = nutrition.per100g || null; // 🔥 100g당 정보 저장
                        // meal.timestamp는 그대로 유지 (수정하지 않음)
                        
                        // 새 영양소 추가
                        todayIntake.calories += nutrition.calories;
                        todayIntake.carbs += nutrition.carbs;
                        todayIntake.protein += nutrition.protein;
                        todayIntake.fat += nutrition.fat;
                        
                        // Firebase 저장
                        await saveTodayNutritionToFirestore();
                        
                        // 🔥 앨범 탭 동기화: photos 컬렉션 업데이트
                        if (editData.originalPhoto) {
                            const photosSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                                .collection('users').doc(currentUser.uid)
                                .collection('photos')
                                .where('url', '==', editData.originalPhoto)
                                .get();
                            
                            photosSnapshot.forEach(async (doc) => {
                                await doc.ref.update({
                                    text: `${currentMealType}: ${foodName}`,
                                    nutrition: nutrition,
                                    food: foodName,
                                    mealType: currentMealType
                                });
                                console.log('✅ 앨범 사진 정보 업데이트 완료:', doc.id);
                            });
                        }
                        
                        // UI 업데이트
                        updateNutritionUI();
                        
                        // 수정 데이터 초기화
                        window.editingMealData = null;
                        
                        closeMealInputModal();
                        showAIToast(`✅ ${currentMealType} 식사가 수정되었습니다! (시간 유지)`, 3000);
                    }
                } else {
                    // 🔥 신규 등록 모드
                    const today = new Date();
                    const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                    // photos 컬렉션에 텍스트 식사 기록 저장
                    await db.collection('artifacts').doc('diet-mate-v2')
                        .collection('users').doc(currentUser.uid)
                        .collection('photos').add({
                            category: 'food',
                            text: `${currentMealType}: ${foodName}`,
                            nutrition: nutrition,
                            uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            mealType: currentMealType,
                            food: foodName
                        });

                    // Phase 1: 실시간 영양 추적에 반영
                    addMeal(currentMealType, foodName, nutrition);

                    // 오늘의 영양 데이터 새로고침
                    await refreshDashboardNutrition();

                    // 모달 닫기
                    closeMealInputModal();

                    showSuccessToast(`${currentMealType} 식사가 기록되었습니다!`);
                }

            } catch (error) {
                console.error('식사 저장 실패:', error);
                alert('식사 기록 저장에 실패했습니다.');
            }
        }

        // ==================== PWA 기능 ====================
        function initializePWA() {
            // PWA 설치 프롬프트 감지
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;

                const installed = localStorage.getItem(LS_KEYS.PWA_INSTALLED);
                if (!installed) {
                    document.getElementById('pwaInstallBanner').classList.remove('hidden');
                }
            });

            // 설치 완료 감지
            window.addEventListener('appinstalled', () => {
                localStorage.setItem(LS_KEYS.PWA_INSTALLED, 'true');
                document.getElementById('pwaInstallBanner').classList.add('hidden');
                deferredPrompt = null;
            });
        }

        async function installPWA() {
            if (!deferredPrompt) {
                alert('이 브라우저는 PWA 설치를 지원하지 않습니다.');
                return;
            }

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                localStorage.setItem(LS_KEYS.PWA_INSTALLED, 'true');
                document.getElementById('pwaInstallBanner').classList.add('hidden');
            }

            deferredPrompt = null;
        }

        // ==================== 프로필 통계 상세 모달 ====================
        function showDaysActiveDetail() {
            if (!currentProfile.createdAt) {
                alert('프로필 정보를 먼저 설정해주세요.');
                return;
            }

            const startDate = currentProfile.createdAt.toDate();
            const today = new Date();
            const diffDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));

            const badges = [];
            if (diffDays >= 30) badges.push('🏆 30일 달성!');
            if (diffDays >= 100) badges.push('🏆 100일 달성!');
            if (diffDays >= 365) badges.push('🏆 365일 달성!');

            const modal = document.createElement('div');
            modal.className = 'day-report-modal';
            modal.innerHTML = `
                <div class="day-report-content" style="max-width: 400px;">
                    <div class="day-report-header">🗓️ 함께한 날</div>
                    <div style="text-align: center; margin: 30px 0;">
                        <div style="font-size: 3rem; font-weight: bold; color: #667eea;">${diffDays}일</div>
                        <p style="margin-top: 10px; color: #666;">시작일: ${startDate.toLocaleDateString('ko-KR')}</p>
                        <p style="margin-top: 20px; line-height: 1.6; color: #555;">
                            ${diffDays}일 동안 열심히 노력하셨어요! 👏
                        </p>
                        ${badges.length > 0 ? `
                            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px;">
                                ${badges.map(b => `<div style="margin: 5px 0; font-weight: bold;">${b}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <button class="modal-btn modal-btn-primary" onclick="this.closest('.day-report-modal').remove()">닫기</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function showExerciseTimeDetail() {
            try {
                // dailyLogs에서 모든 운동 데이터 수집
                const logsSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').get();

                const exerciseBreakdown = {};
                let totalMinutes = 0;

                logsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.exercises && data.exercises.length > 0) {
                        data.exercises.forEach(ex => {
                            if (!exerciseBreakdown[ex.name]) {
                                exerciseBreakdown[ex.name] = 0;
                            }
                            exerciseBreakdown[ex.name] += ex.duration || 0;
                            totalMinutes += ex.duration || 0;
                        });
                    }
                });

                const totalHours = Math.floor(totalMinutes / 60);
                const remainingMinutes = totalMinutes % 60;

                const sortedExercises = Object.entries(exerciseBreakdown)
                    .sort((a, b) => b[1] - a[1]);

                const modal = document.createElement('div');
                modal.className = 'day-report-modal';
                modal.innerHTML = `
                    <div class="day-report-content" style="max-width: 400px;">
                        <div class="day-report-header">💪 총 운동 시간</div>
                        <div style="text-align: center; margin: 30px 0;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: #667eea;">
                                ${totalHours}시간 ${remainingMinutes}분
                            </div>
                            <p style="margin-top: 5px; color: #999; font-size: 0.9rem;">총 ${totalMinutes}분</p>
                        </div>
                        ${sortedExercises.length > 0 ? `
                            <div style="margin-top: 20px;">
                                <h4 style="margin-bottom: 15px; color: #333;">운동별 누적 시간:</h4>
                                ${sortedExercises.map(([name, minutes]) => `
                                    <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                                        <span style="font-weight: 600;">${name}</span>
                                        <span style="color: #667eea;">${Math.floor(minutes / 60)}시간 ${minutes % 60}분</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="text-align: center; color: #999;">아직 운동 기록이 없습니다.</p>'}
                        ${totalMinutes >= 360 ? '<div style="margin-top: 20px; padding: 12px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; text-align: center; font-weight: bold; color: #2e7d32;">🏆 6시간 이상 운동 달성!</div>' : ''}
                        <button class="modal-btn modal-btn-primary" onclick="this.closest('.day-report-modal').remove()">닫기</button>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('운동 시간 조회 실패:', error);
                alert('운동 시간 조회에 실패했습니다.');
            }
        }

        async function showCalorieSavingsDetail() {
            try {
                // dailyLogs에서 영양 데이터 수집
                const logsSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('dailyLogs').get();

                const dailyTarget = currentProfile.recommendedCalories || 2400;
                let totalSaved = 0;
                let totalOverage = 0;
                let daysCount = 0;

                logsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.nutrition && data.nutrition.calories) {
                        daysCount++;
                        const diff = dailyTarget - data.nutrition.calories;
                        if (diff > 0) {
                            totalSaved += diff;
                        } else {
                            totalOverage += Math.abs(diff);
                        }
                    }
                });

                const netSavings = totalSaved - totalOverage;
                const avgDailySavings = daysCount > 0 ? Math.round(netSavings / daysCount) : 0;

                const modal = document.createElement('div');
                modal.className = 'day-report-modal';
                modal.innerHTML = `
                    <div class="day-report-content" style="max-width: 400px;">
                        <div class="day-report-header">🔥 절약 칼로리</div>
                        <div style="text-align: center; margin: 30px 0;">
                            <div style="font-size: 2.5rem; font-weight: bold; color: ${netSavings >= 0 ? '#4caf50' : '#ff5252'};">
                                ${netSavings >= 0 ? '' : '+'}${Math.abs(netSavings).toLocaleString()}kcal
                            </div>
                        </div>
                        ${netSavings >= 0 ? `
                            <div style="padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; margin-bottom: 20px;">
                                <p style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">✅ 목표보다 ${netSavings.toLocaleString()}kcal 덜 섭취했어요!</p>
                                <p style="font-size: 0.9rem; color: #555;">이대로만 계속하면 목표 달성이 가까워요! 💪</p>
                            </div>
                        ` : `
                            <div style="padding: 15px; background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-radius: 12px; margin-bottom: 20px;">
                                <p style="font-weight: bold; color: #c62828; margin-bottom: 5px;">⚠️ 목표보다 ${Math.abs(netSavings).toLocaleString()}kcal 더 섭취했어요</p>
                                <p style="font-size: 0.9rem; color: #555;">조금만 더 절제하면 좋은 결과를 얻을 수 있어요!</p>
                            </div>
                        `}
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>총 절약:</span>
                                <span style="color: #4caf50; font-weight: bold;">${totalSaved.toLocaleString()}kcal</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>총 초과:</span>
                                <span style="color: #ff5252; font-weight: bold;">+${totalOverage.toLocaleString()}kcal</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold; padding-top: 10px; border-top: 2px solid #e0e0e0;">
                                <span>순 절약:</span>
                                <span style="color: ${netSavings >= 0 ? '#4caf50' : '#ff5252'};">${netSavings.toLocaleString()}kcal</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9rem; color: #666;">
                                <span>일평균:</span>
                                <span>${avgDailySavings.toLocaleString()}kcal</span>
                            </div>
                        </div>
                        <button class="modal-btn modal-btn-primary" style="margin-top: 20px;" onclick="this.closest('.day-report-modal').remove()">닫기</button>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('칼로리 조회 실패:', error);
                alert('칼로리 절약량 조회에 실패했습니다.');
            }
        }

        async function showExpectedCompletionDetail() {
            if (!currentProfile.goalWeight) {
                alert('목표 체중을 먼저 설정해주세요.');
                return;
            }

            try {
                // 최근 30일 체중 데이터 가져오기
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const weightsSnapshot = await db.collection('artifacts').doc('diet-mate-v2')
                    .collection('users').doc(currentUser.uid)
                    .collection('logs')
                    .where('date', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
                    .orderBy('date', 'desc')
                    .get();

                if (weightsSnapshot.empty) {
                    alert('체중 기록이 부족합니다. 최소 2개 이상의 체중 기록이 필요합니다.');
                    return;
                }

                const weights = [];
                weightsSnapshot.forEach(doc => {
                    const data = doc.data();
                    weights.push({
                        date: data.date.toDate(),
                        weight: data.weight
                    });
                });

                weights.reverse(); // 오래된 순으로 정렬

                if (weights.length < 2) {
                    alert('체중 기록이 부족합니다. 최소 2개 이상의 체중 기록이 필요합니다.');
                    return;
                }

                // 평균 주간 감량 속도 계산
                const firstWeight = weights[0].weight;
                const lastWeight = weights[weights.length - 1].weight;
                const daysDiff = (weights[weights.length - 1].date - weights[0].date) / (1000 * 60 * 60 * 24);
                const totalLoss = firstWeight - lastWeight;
                const weeklyLoss = (totalLoss / daysDiff) * 7;

                const currentWeight = lastWeight;
                const goalWeight = currentProfile.goalWeight;
                const remainingWeight = currentWeight - goalWeight;

                if (weeklyLoss <= 0) {
                    const modal = document.createElement('div');
                    modal.className = 'day-report-modal';
                    modal.innerHTML = `
                        <div class="day-report-content" style="max-width: 400px;">
                            <div class="day-report-header">📅 예상 달성일</div>
                            <div style="text-align: center; margin: 30px 0;">
                                <p style="font-size: 1.2rem; color: #ff5252; font-weight: bold;">⚠️ 현재 체중이 증가 중이거나 변화가 없습니다</p>
                                <p style="margin-top: 20px; color: #666; line-height: 1.6;">
                                    체중 감량을 위해 식단 조절과 운동을 시작해보세요!
                                </p>
                            </div>
                            <button class="modal-btn modal-btn-primary" onclick="this.closest('.day-report-modal').remove()">닫기</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    return;
                }

                const weeksNeeded = Math.ceil(remainingWeight / weeklyLoss);
                const daysNeeded = weeksNeeded * 7;

                const expectedDate = new Date();
                expectedDate.setDate(expectedDate.getDate() + daysNeeded);

                const originalGoalDate = currentProfile.targetDate ? currentProfile.targetDate.toDate() : null;
                let daysDifference = 0;
                if (originalGoalDate) {
                    daysDifference = Math.ceil((expectedDate - originalGoalDate) / (1000 * 60 * 60 * 24));
                }

                const modal = document.createElement('div');
                modal.className = 'day-report-modal';
                modal.innerHTML = `
                    <div class="day-report-content" style="max-width: 400px;">
                        <div class="day-report-header">📅 예상 달성일</div>
                        <div style="text-align: center; margin: 30px 0;">
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea;">${expectedDate.toLocaleDateString('ko-KR')}</div>
                            <p style="margin-top: 10px; color: #999; font-size: 0.9rem;">약 ${daysNeeded}일 후</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                            <p style="margin-bottom: 10px;"><strong>최근 감량 속도:</strong> 주당 ${weeklyLoss.toFixed(2)}kg</p>
                            ${originalGoalDate ? `<p><strong>원래 목표일:</strong> ${originalGoalDate.toLocaleDateString('ko-KR')}</p>` : ''}
                        </div>
                        ${originalGoalDate ? (daysDifference < 0 ? `
                            <div style="padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px;">
                                <p style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">🎉 목표일보다 ${Math.abs(daysDifference)}일 빨라요!</p>
                                <p style="font-size: 0.9rem; color: #555;">현재 페이스가 완벽해요! 이대로만 가면 목표를 달성할 수 있어요!</p>
                            </div>
                        ` : daysDifference > 0 ? `
                            <div style="padding: 15px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 12px;">
                                <p style="font-weight: bold; color: #e65100; margin-bottom: 5px;">⚠️ 목표일보다 ${daysDifference}일 늦을 것 같아요</p>
                                <p style="font-size: 0.9rem; color: #555;">조금 더 노력하면 목표일에 맞출 수 있어요!</p>
                            </div>
                        ` : `
                            <div style="padding: 15px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px;">
                                <p style="font-weight: bold; color: #2e7d32;">✅ 목표일에 정확히 맞춰가고 있어요!</p>
                            </div>
                        `) : ''}
                        <button class="modal-btn modal-btn-primary" style="margin-top: 20px;" onclick="this.closest('.day-report-modal').remove()">닫기</button>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('예상 달성일 계산 실패:', error);
                alert('예상 달성일 계산에 실패했습니다.');
            }
        }

        // ==================== 프로필 재설정 ====================
        function openProfileSettings() {
            const modal = document.getElementById('profileSettingsModal');

            // 모든 입력 필드를 공백으로 초기화
            document.getElementById('editName').value = '';
            document.getElementById('editStartWeight').value = '';
            document.getElementById('editGoalWeight').value = '';
            document.getElementById('editAge').value = '';
            document.getElementById('editHeight').value = '';
            document.getElementById('editGender').value = '';
            document.getElementById('editTargetDate').value = '';
            document.getElementById('editActivityLevel').value = 'sedentary';
            document.getElementById('editGoal').value = 'lose';

            modal.classList.remove('hidden');
        }

        function closeProfileSettings() {
            document.getElementById('profileSettingsModal').classList.add('hidden');
        }

        async function saveProfileSettings() {
            const name = document.getElementById('editName').value.trim();
            const startWeight = parseFloat(document.getElementById('editStartWeight').value);
            const goalWeight = parseFloat(document.getElementById('editGoalWeight').value);
            const age = parseInt(document.getElementById('editAge').value) || currentProfile.age || null;
            const height = parseFloat(document.getElementById('editHeight').value) || currentProfile.height || null;
            const gender = document.getElementById('editGender').value || currentProfile.gender || null;
            const targetDateStr = document.getElementById('editTargetDate').value;
            const targetDate = targetDateStr ? firebase.firestore.Timestamp.fromDate(new Date(targetDateStr)) : currentProfile.targetDate;
            const activityLevel = document.getElementById('editActivityLevel').value || currentProfile.activityLevel || 'light';
            const goal = document.getElementById('editGoal').value || currentProfile.goal || 'lose';
            
            console.log('=== 프로필 저장 시작 (기록 유지) ===');
            console.log('name:', name);
            console.log('startWeight:', startWeight);
            console.log('goalWeight:', goalWeight);
            console.log('targetDate:', targetDate);
            
            // 유효성 검사
            if (!name) {
                alert('닉네임을 입력해주세요.');
                return;
            }
            
            if (!startWeight || startWeight <= 0) {
                alert('시작 체중을 올바르게 입력해주세요.');
                return;
            }
            
            if (!goalWeight || goalWeight <= 0) {
                alert('목표 체중을 올바르게 입력해주세요.');
                return;
            }
            
            try {
                // ✅ 프로필 정보만 업데이트 (기록은 유지)
                await db.collection('artifacts')
                    .doc('diet-mate-v2')
                    .collection('users')
                    .doc(currentUser.uid)
                    .set({
                        name: name,
                        startWeight: startWeight,
                        goalWeight: goalWeight,
                        age: age,
                        height: height,
                        gender: gender,
                        targetDate: targetDate,
                        activityLevel: activityLevel,
                        goal: goal,
                        email: currentUser.email,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                
                console.log('✅ Firebase 저장 완료 (기록 유지)');
                
                // 로컬 프로필 완전히 업데이트
                currentProfile.name = name;
                currentProfile.startWeight = startWeight;
                currentProfile.goalWeight = goalWeight;
                currentProfile.age = age;
                currentProfile.height = height;
                currentProfile.gender = gender;
                currentProfile.targetDate = targetDate;
                currentProfile.activityLevel = activityLevel;
                currentProfile.goal = goal;
                
                console.log('✅ 로컬 프로필 업데이트 완료:', currentProfile);
                
                // UI 업데이트
                document.getElementById('headerSubtitle').textContent = `${name}님, 환영합니다!`;
                document.getElementById('profileName').textContent = name;
                
                // 모달 닫기
                closeProfileSettings();
                
                alert('✅ 프로필이 업데이트되었습니다!\n기존 기록은 모두 유지됩니다.');
                
                // 홈 탭 강제 새로고침
                await loadHomeTab();
                
                // 설정 탭도 새로고침 (현재 설정 탭이면)
                if (currentTab === 'settings') {
                    await loadSettings();
                }
                
            } catch (error) {
                console.error('프로필 업데이트 실패:', error);
                alert('❌ 프로필 업데이트에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // ==================== 전체 초기화 ====================
        function openFullReset() {
            if (!confirm('⚠️ 경고: 전체 초기화는 되돌릴 수 없습니다!\n\n다음 데이터가 영구 삭제됩니다:\n- 모든 체중 기록\n- 모든 단식 기록\n- 모든 식사/앨범 기록\n- 프로필 정보\n\n정말 초기화하시겠습니까?')) {
                return;
            }

            if (!confirm('🔥 최종 확인: 정말로 모든 데이터를 삭제하고 처음부터 다시 시작하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다!')) {
                return;
            }

            performFullReset();
        }

        async function performFullReset() {
            try {
                const userRef = db.collection('artifacts')
                    .doc('diet-mate-v2')
                    .collection('users')
                    .doc(currentUser.uid);

                console.log('🗑️ 전체 초기화 시작...');

                // 1. logs 컬렉션 삭제
                const logsSnapshot = await userRef.collection('logs').get();
                const logsBatch = db.batch();
                logsSnapshot.docs.forEach(doc => logsBatch.delete(doc.ref));
                await logsBatch.commit();
                console.log(`✅ logs 삭제: ${logsSnapshot.size}건`);

                // 2. fastingRecords 컬렉션 삭제
                const fastingSnapshot = await userRef.collection('fastingRecords').get();
                const fastingBatch = db.batch();
                fastingSnapshot.docs.forEach(doc => fastingBatch.delete(doc.ref));
                await fastingBatch.commit();
                console.log(`✅ fastingRecords 삭제: ${fastingSnapshot.size}건`);

                // 3. albums 컬렉션 삭제
                const albumsSnapshot = await userRef.collection('albums').get();
                const albumsBatch = db.batch();
                albumsSnapshot.docs.forEach(doc => albumsBatch.delete(doc.ref));
                await albumsBatch.commit();
                console.log(`✅ albums 삭제: ${albumsSnapshot.size}건`);

                // 4. photos 컬렉션 삭제
                const photosSnapshot = await userRef.collection('photos').get();
                const photosBatch = db.batch();
                photosSnapshot.docs.forEach(doc => photosBatch.delete(doc.ref));
                await photosBatch.commit();
                console.log(`✅ photos 삭제: ${photosSnapshot.size}건`);

                // 5. dailyLogs 컬렉션 삭제
                const dailyLogsSnapshot = await userRef.collection('dailyLogs').get();
                const dailyLogsBatch = db.batch();
                dailyLogsSnapshot.docs.forEach(doc => dailyLogsBatch.delete(doc.ref));
                await dailyLogsBatch.commit();
                console.log(`✅ dailyLogs 삭제: ${dailyLogsSnapshot.size}건`);

                // 6. dailyPlans 컬렉션 삭제
                const dailyPlansSnapshot = await userRef.collection('dailyPlans').get();
                const dailyPlansBatch = db.batch();
                dailyPlansSnapshot.docs.forEach(doc => dailyPlansBatch.delete(doc.ref));
                await dailyPlansBatch.commit();
                console.log(`✅ dailyPlans 삭제: ${dailyPlansSnapshot.size}건`);

                // 7. 프로필 문서 삭제
                await userRef.delete();
                console.log('✅ 프로필 삭제 완료');

                // 8. 로컬 스토리지 초기화
                localStorage.clear();
                console.log('✅ 로컬 스토리지 초기화');

                alert('✅ 전체 초기화가 완료되었습니다!\n페이지를 새로고침합니다.');

                // 페이지 새로고침
                window.location.reload();

            } catch (error) {
                console.error('전체 초기화 실패:', error);
                alert('❌ 전체 초기화에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // ==================== 초기 실행 ====================
        // Firebase Auth State Listener가 자동으로 초기화 시작

        // ==================== 테마 시스템 ====================

        // 테마 설정 함수
        function setTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            localStorage.setItem('diet-mate-theme', themeName);

            // 모든 테마 옵션의 스타일 초기화
            document.querySelectorAll('.theme-option').forEach(option => {
                option.style.borderColor = 'var(--border)';
                option.style.backgroundColor = 'transparent';
            });

            // 선택된 테마 강조
            const selectedOption = document.querySelector(`.theme-option[data-theme="${themeName}"]`);
            if (selectedOption) {
                selectedOption.style.borderColor = 'var(--primary)';
                selectedOption.style.backgroundColor = 'var(--bg-tertiary)';
            }

            console.log('✅ 테마 변경:', themeName);
        }

        // 테마 로드 함수
        function loadTheme() {
            const savedTheme = localStorage.getItem('diet-mate-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            // 페이지 로드 후 선택된 테마 강조
            setTimeout(() => {
                const selectedOption = document.querySelector(`.theme-option[data-theme="${savedTheme}"]`);
                if (selectedOption) {
                    selectedOption.style.borderColor = 'var(--primary)';
                    selectedOption.style.backgroundColor = 'var(--bg-tertiary)';
                }
            }, 100);

            console.log('✅ 테마 로드:', savedTheme);
        }

        // 앱 시작 시 테마 로드
        loadTheme();
    </script>

    <!-- AI 토스트 팝업 -->
    <div id="aiToast" class="ai-toast hidden">
        <div class="ai-toast-content">
            <div class="ai-toast-icon">🤖</div>
            <div class="ai-toast-message" id="aiToastMessage">AI 코치가 분석 중이에요...</div>
        </div>
        <button class="ai-toast-button" onclick="openAIChatFromToast()">
            코치에게 질문하기
        </button>
    </div>

    <!-- 스마트 병합 Bottom Sheet -->
    <div id="mergeBottomSheet" class="merge-overlay hidden">
        <div class="merge-sheet">
            <div class="merge-header">
                <h3>🤔 이전 식사와 합칠까요?</h3>
                <p class="merge-subtitle">3시간 이내에 비슷한 식사가 있어요</p>
            </div>
            <div class="merge-content">
                <div class="merge-preview">
                    <div class="merge-meal previous-meal">
                        <div class="meal-label">이전 식사</div>
                        <div class="meal-name" id="previousMealName">-</div>
                        <div class="meal-calories" id="previousMealCal">0kcal</div>
                    </div>
                    <div class="merge-plus">+</div>
                    <div class="merge-meal current-meal">
                        <div class="meal-label">방금 추가한 식사</div>
                        <div class="meal-name" id="currentMealName">-</div>
                        <div class="meal-calories" id="currentMealCal">0kcal</div>
                    </div>
                </div>
                <div class="merge-total">
                    <span>합계:</span>
                    <span id="mergeTotal" class="total-calories">0kcal</span>
                </div>
            </div>
            <div class="merge-actions">
                <button class="merge-btn merge-confirm" onclick="confirmMerge()">
                    합치기
                </button>
                <button class="merge-btn merge-cancel" onclick="createNewMeal()">
                    따로 저장
                </button>
            </div>
        </div>
    </div>

    <!-- Phase 4: 카테고리 변경 모달 -->
    <div class="category-change-overlay hidden" id="categoryChangeOverlay" onclick="closeCategoryModal()">
        <div class="category-change-modal" onclick="event.stopPropagation()">
            <div class="category-modal-header">
                <h3>카테고리 변경</h3>
                <button class="modal-close-btn" onclick="closeCategoryModal()">×</button>
            </div>
            <div class="category-modal-content">
                <p class="category-modal-description">이 항목을 어느 카테고리로 이동하시겠습니까?</p>
                <div class="category-options" id="categoryOptions">
                    <button class="category-option" data-category="body" onclick="changeCategoryConfirm('body')">
                        <span class="category-emoji">💪</span>
                        <span class="category-name">눈바디</span>
                    </button>
                    <button class="category-option" data-category="food" onclick="changeCategoryConfirm('food')">
                        <span class="category-emoji">🍽️</span>
                        <span class="category-name">식단</span>
                    </button>
                    <button class="category-option" data-category="exercise" onclick="changeCategoryConfirm('exercise')">
                        <span class="category-emoji">🏃‍♂️</span>
                        <span class="category-name">운동</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 4: 수동 병합 - 식사 선택 모달 -->
    <div class="manual-merge-overlay hidden" id="manualMergeOverlay" onclick="closeManualMergeModal()">
        <div class="manual-merge-sheet" onclick="event.stopPropagation()">
            <div class="manual-merge-header">
                <h3>이전 식사 선택</h3>
                <button class="modal-close-btn" onclick="closeManualMergeModal()">×</button>
            </div>
            <p class="manual-merge-description">병합할 이전 식사를 선택하세요 (최근 30일)</p>
            <div class="meal-list" id="mealList">
                <!-- 식사 목록이 여기에 동적으로 생성됨 -->
                <div class="meal-list-loading">불러오는 중...</div>
            </div>
        </div>
    </div>

    <!-- 식사 직접 입력 모달 -->
    <div class="meal-input-modal-overlay" id="mealInputModalOverlay" onclick="closeMealInputModal(event)">
        <div class="meal-input-modal" onclick="event.stopPropagation()">
            <div class="meal-input-header">
                <h2 class="meal-input-title" id="mealInputTitle">🍽️ 식사 입력</h2>
                <button class="modal-close" onclick="closeMealInputModal()">&times;</button>
            </div>

            <div class="meal-input-form">
                <div class="form-group-meal">
                    <label class="form-label-meal">음식명</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="mealFoodName" class="form-input-meal" placeholder="예: 페페로, 감자탕, 라면" 
                               style="flex: 1;" onkeypress="if(event.key==='Enter') searchFoodDatabase();">
                        <button class="search-food-btn" onclick="searchFoodDatabase()" style="padding: 10px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap;">
                            🔍 검색
                        </button>
                    </div>
                </div>
                
                <!-- 음식 검색 결과 (브랜드별) -->
                <div id="foodSearchResults" style="display: none; margin-top: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 300px; overflow-y: auto;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #333; font-size: 0.95rem;">
                            📋 검색 결과 (클릭하여 선택)
                        </div>
                        <div id="foodOptionsContainer"></div>
                    </div>
                </div>

                <div class="form-group-meal">
                    <label class="form-label-meal">양 (그람)</label>
                    <input type="number" id="mealGrams" class="form-input-meal" placeholder="예: 150">
                </div>
                
                <!-- 🔥 직접 입력 / AI 분석 선택 -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="ai-analyze-btn" id="aiAnalyzeBtn" onclick="analyzeMealWithAI()" style="flex: 1;">
                        <span>🤖</span>
                        <span>AI로 영양 분석</span>
                    </button>
                    <button class="ai-analyze-btn" onclick="toggleManualInput(); document.getElementById('nutritionResult').classList.add('show');" style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <span>✍️</span>
                        <span>직접 입력</span>
                    </button>
                </div>

                <div class="nutrition-result show" id="nutritionResult">
                    <div class="nutrition-result-title">📊 분석 결과</div>
                    <div class="nutrition-result-grid">
                        <div class="nutrition-result-item">
                            <div class="nutrition-result-label">칼로리</div>
                            <div class="nutrition-result-value" id="resultCalories">0</div>
                            <div class="nutrition-result-label">kcal</div>
                        </div>
                        <div class="nutrition-result-item">
                            <div class="nutrition-result-label">탄수화물</div>
                            <div class="nutrition-result-value" id="resultCarbs">0</div>
                            <div class="nutrition-result-label">g</div>
                        </div>
                        <div class="nutrition-result-item">
                            <div class="nutrition-result-label">단백질</div>
                            <div class="nutrition-result-value" id="resultProtein">0</div>
                            <div class="nutrition-result-label">g</div>
                        </div>
                        <div class="nutrition-result-item">
                            <div class="nutrition-result-label">지방</div>
                            <div class="nutrition-result-value" id="resultFat">0</div>
                            <div class="nutrition-result-label">g</div>
                        </div>
                    </div>

                    <div class="manual-input-toggle" onclick="toggleManualInput()">
                        💡 수동으로 직접 입력하기
                    </div>

                    <div class="manual-input-fields show" id="manualInputFields">
                        <div class="form-group-meal" style="flex: 1; min-width: 0;">
                            <label class="form-label-meal" style="white-space: nowrap;">칼로리 (kcal)</label>
                            <input type="number" id="manualCalories" class="form-input-meal" placeholder="0" style="width: 100%;">
                        </div>
                        <div class="form-group-meal" style="flex: 1; min-width: 0;">
                            <label class="form-label-meal" style="white-space: nowrap;">탄수화물 (g)</label>
                            <input type="number" id="manualCarbs" class="form-input-meal" placeholder="0" style="width: 100%;">
                        </div>
                        <div class="form-group-meal" style="flex: 1; min-width: 0;">
                            <label class="form-label-meal" style="white-space: nowrap;">단백질 (g)</label>
                            <input type="number" id="manualProtein" class="form-input-meal" placeholder="0" style="width: 100%;">
                        </div>
                        <div class="form-group-meal" style="flex: 1; min-width: 0;">
                            <label class="form-label-meal" style="white-space: nowrap;">지방 (g)</label>
                            <input type="number" id="manualFat" class="form-input-meal" placeholder="0" style="width: 100%;">
                        </div>
                    </div>

                    <button class="save-meal-btn" onclick="saveMealInput()">저장하기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 알림 수정 모달 -->
    <div class="meal-input-modal-overlay" id="editNotificationModalOverlay" onclick="closeEditNotificationModal(event)">
        <div class="meal-input-modal" onclick="event.stopPropagation()">
            <div class="meal-input-header">
                <h2 class="meal-input-title">✏️ 알림 수정</h2>
                <button class="modal-close" onclick="closeEditNotificationModal()">&times;</button>
            </div>

            <div class="meal-input-form">
                <div class="form-group-meal">
                    <label class="form-label-meal">알림 내용</label>
                    <input type="text" id="editNotifTitle" class="form-input-meal" placeholder="예: 물 마시기">
                </div>

                <div class="form-group-meal">
                    <label class="form-label-meal">알림 시간</label>
                    <input type="time" id="editNotifTime" class="form-input-meal">
                </div>

                <div class="form-group-meal">
                    <label class="form-label-meal">반복 주기</label>
                    <select id="editNotifRepeat" class="form-input-meal">
                        <option value="매일">매일</option>
                        <option value="매주">매주</option>
                        <option value="한 번만">한 번만</option>
                    </select>
                </div>

                <button class="save-meal-btn" onclick="saveEditedNotification()">저장하기</button>
            </div>
        </div>
    </div>
</body>
</html>
